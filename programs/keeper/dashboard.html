<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="icon"
        href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDkgOCI+PHN0eWxlPi5ve2ZpbGw6I2ZjMH0ucntmaWxsOnJlZH08L3N0eWxlPjxwYXRoIGQ9Ik0wLDcgaDEgdjEgaC0xIHoiIGNsYXNzPSJyIi8+PHBhdGggZD0iTTAsMCBoMSB2NyBoLTEgeiIgY2xhc3M9Im8iLz48cGF0aCBkPSJNMiwwIGgxIHY4IGgtMSB6IiBjbGFzcz0ibyIvPjxwYXRoIGQ9Ik00LDAgaDEgdjggaC0xIHoiIGNsYXNzPSJvIi8+PHBhdGggZD0iTTYsMCBoMSB2OCBoLTEgeiIgY2xhc3M9Im8iLz48cGF0aCBkPSJNOCwzLjI1IGgxIHYxLjUgaC0xIHoiIGNsYXNzPSJvIi8+PC9zdmc+">
    <title>ClickHouse Keeper</title>

    <!-- Code Style:

    Do not use any JavaScript or CSS frameworks or preprocessors.
    This HTML page should not require any build systems (node.js, npm, gulp, etc.)
    This HTML page should not be minified, instead it should be reasonably minimalistic by itself.
    This HTML page should not load any external resources on load.
    (CSS and JavaScript must be embedded directly to the page. No external fonts or images should be loaded).
    This UI should look as lightweight, clean and fast as possible.
    All UI elements must be aligned in pixel-perfect way.
    There should not be any animations.
    No unexpected changes in positions of elements while the page is loading.
    Navigation by keyboard should work.
    64-bit numbers must display correctly.

    -->

    <style>
        :root {
            --background-color: #DDF8FF;
            --element-background-color: #FFF;
            --input-background-color: #BDD;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --text-color: #080808;
            --header-text-color: #000;
            --misc-text-color: #888;
            --error-color: #FEE;
            --logo-color: #CEE;
            --logo-color-active: #BDD;
            --tab-switch-background-color: #FFF;
            --tab-switch-hover-color: #F1F1F1;
            --tab-switch-selected-border-color: #000;
            --storage-path-hover-color: #FFF;
            --storage-path-selected-border-color: #000;
            --storage-ui-button-hover-color: #F1F1F1;
            --storage-ui-button-border-color: #000;
        }

        [data-theme="dark"] {
            --background-color: #414141;
            --element-background-color: #252521;
            --input-background-color: #111;
            --shadow-color: rgba(255, 255, 255, 0.1);
            --text-color: #B4B4B4;
            --header-text-color: #F9F9F9;
            --button-text-color: #000;
            --misc-text-color: #888;
            --error-color: #400;
            --logo-color: #222;
            --logo-color-active: #333;
            --tab-switch-background-color: #252521;
            --tab-switch-hover-color: #151515;
            --tab-switch-selected-border-color: #faff68;
            --storage-path-hover-color: #151515;
            --storage-path-selected-border-color: #faff68;
            --storage-ui-button-hover-color: #151515;
            --storage-ui-button-border-color: #faff68;
        }

        * {
            box-sizing: border-box;
            /* For iPad */
            margin: 0;
            border-radius: 0;
            tab-size: 4;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            overflow: auto;
        }

        html {
            /* The fonts that have full support for hinting. */
            font-family: Liberation Sans, DejaVu Sans, sans-serif, Noto Color Emoji, Apple Color Emoji, Segoe UI Emoji;
            background: var(--background-color);
            color: var(--text-color);
        }

        body {
            /* This element will show scroll-bar on overflow, and the scroll-bar will be outside of the padding. */
            padding: 0.5rem;
        }

        #controls {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 100;
        }

        /* Otherwise Webkit based browsers will display ugly border on focus. */
        textarea,
        input {
            outline: none;
            border: none;
            color: var(--text-color);
        }

        .storage-ui-button {
            display: inline-block;
            background-color: transparent;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            font-size: 1.0rem;
            color: var(--header-text-color);
            text-align: center;
            text-decoration: none;
            cursor: pointer;
            border: 1px solid var(--storage-ui-button-border-color);
        }

        .storage-ui-button:hover {
            background-color: var(--storage-ui-button-hover-color);
        }

        .storage-ui-button:disabled {
            display: inline-block;
            background-color: transparent;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            font-size: 1.0rem;
            border: none;
            color: var(--text-color);
            text-align: center;
            text-decoration: none;
        }

        .monospace {
            /* Prefer fonts that have full hinting info. This is important for non-retina displays.
               Also I personally dislike "Ubuntu" font due to the similarity of "r" and "Ð³" (it looks very ignorant). */
            font-family: Liberation Mono, DejaVu Sans Mono, MonoLisa, Consolas, monospace;
        }

        .monospace-table {
            /* Liberation is worse than DejaVu for block drawing characters. */
            font-family: DejaVu Sans Mono, Liberation Mono, MonoLisa, Consolas, monospace;
        }

        .shadow {
            box-shadow: 0 0 1rem var(--shadow-color);
        }

        #displayStorageData,
        #command-scrolling-container,
        #command,
        #command-output {
            min-width: 100%;
            font-size: 11pt;
            padding-left: 0.25rem;
            padding-right: 0.25rem;
            background-color: var(--input-background-color);
            resize: none;
            /* height: 11pt; */
        }

        #toggle-light,
        #toggle-dark {
            float: right;
            padding-right: 0.5rem;
            cursor: pointer;
        }

        #error {
            background: var(--error-color);
            white-space: pre-wrap;
            padding: 0.5rem 1rem;
        }

        a {
            text-decoration: none;
        }

        #graph {
            display: none;
        }

        /* This is for graph in svg */
        text {
            font-size: 14px;
            fill: var(--text-color);
        }

        .node rect {
            fill: var(--element-background-color);
            filter: drop-shadow(.2rem .2rem .2rem var(--shadow-color));
        }

        .edgePath path {
            stroke: var(--text-color);
        }

        marker {
            fill: var(--text-color);
        }

        #logo {
            fill: var(--logo-color);
        }

        #cloud-logo {
            color: var(--background-color);
            text-shadow: 0rem 0rem 2rem var(--logo-color);
            font-size: 10vw;
            display: block;
        }

        #logo:hover {
            fill: var(--logo-color-active);
            color: var(--logo-color-active);
        }

        #cloud-logo:hover {
            filter: brightness(150%);
        }

        #logo-container {
            text-align: center;
            margin-top: 5em;
            line-height: 0.75;
        }

        #chart {
            background-color: var(--element-background-color);
            filter: drop-shadow(.2rem .2rem .2rem var(--shadow-color));
            display: none;
            height: 70vh;
        }

        .tab-wrap {
            /* transition: 0.3s box-shadow ease; */
            /* border-radius: 6px; */
            max-width: 100%;
            display: flex;
            flex-wrap: wrap;
            position: relative;
            list-style: none;
            background-color: var(--element-background-color);
            /* margin: 40px 0; */
            /* box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24); */
        }

        .tab {
            display: none;
        }

        .tab+label {
            /* box-shadow: 0 -1px 0 #eee inset; */
            /* border-radius: 6px 6px 0 0; */
            cursor: pointer;
            display: block;
            text-decoration: none;
            color: var(--text-color);
            /* flex-grow: 1; */
            text-align: center;
            background-color: var(--tab-switch-background-color);
            user-select: none;
            text-align: center;
            /* transition: 0.3s background-color ease, 0.3s box-shadow ease; */
            height: 3.1rem;
            box-sizing: border-box;
            padding: 1rem;
        }

        .tab+label:hover {
            background-color: var(--tab-switch-hover-color);
            /* box-shadow: 0 1px 0 #f4f4f4 inset; */
        }

        .tab:checked+label {
            background-color: var(--tab-switch-background-color);
            cursor: default;
            border-bottom: 3px solid var(--tab-switch-selected-border-color);
        }

        .tab:checked+label:hover {
            background-color: var(--tab-switch-background-color);
            cursor: default;
            border-bottom: 3px solid var(--tab-switch-selected-border-color);
        }

        h1 {
            color: var(--header-text-color);
            font-weight: bold;
            font-size: 1.4rem;
            margin-bottom: 1rem;
        }

        h2 {
            color: var(--header-text-color);
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }

        h3 {
            color: var(--header-text-color);
            font-size: 1.0rem;
            margin-bottom: 1rem;
        }

        h4 {
            color: var(--header-text-color);
            font-size: 1.0rem;
        }

        p {
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .tab__content {
            padding: 1rem 1.5rem 1.5rem;
            background-color: transparent;
            position: absolute;
            width: 100%;
            z-index: -1;
            opacity: 0;
            left: 0;
        }

        .tab:checked:nth-of-type(1)~.tab__content:nth-of-type(1) {
            opacity: 1;
            /* transition: 0.5s opacity ease-in, 0.8s transform ease; */
            position: relative;
            top: 0;
            z-index: 100;
            transform: translateY(0px);
            text-shadow: 0 0 0;
        }

        .tab:checked:nth-of-type(2)~.tab__content:nth-of-type(2) {
            opacity: 1;
            /* transition: 0.5s opacity ease-in, 0.8s transform ease; */
            position: relative;
            top: 0;
            z-index: 100;
            transform: translateY(0px);
            text-shadow: 0 0 0;
        }

        #sidebar-version-display {
            position: absolute;
            bottom: -1rem;
            right: 0.5rem;
            color: var(--misc-text-color);
        }

        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 10;
            width: 16rem;
            height: 100%;
            padding: 1.2rem;
            overflow: auto;
            background-color: var(--element-background-color);
        }

        #main {
            margin-left: 16rem;
        }

        .storage_viewer_container * {
            position: relative;
            box-sizing: border-box;
        }

        .storage_viewer_container ul {
            padding-left: 1em;
            list-style-type: none;
        }

        .storage_viewer_container>ul:first-of-type {
            padding: 0;
        }

        .storage_viewer_container li span.storage_node_description {
            cursor: pointer;
            padding-left: 5px;
            padding-bottom: 4px;
            display: block;
            text-align: left;
        }

        .storage_viewer_container li span.storage_node_description:hover {
            background-color: var(--storage-path-hover-color);
        }

        .storage_viewer_container li span.storage_node_description.storage_leaf {
            margin-left: 1.5em;
            margin-top: 0.2em;
        }

        .storage_viewer_container span.storage_node_description.selected {
            color: var(--header-color);
            border-left: 4px solid var(--storage-path-selected-border-color);
        }

        .storage_viewer_container li span.storage_ui_icon,
        .storage_viewer_container li span.storage_ui_icon * {
            display: inline-block;
            width: 1em;
            font-size: 1.5rem;
        }

        .storage_viewer_container input.storage_node_name_input {
            height: 2rem;
            width: 100%;
            padding-left: 5px;
            padding-bottom: 4px;
            background-color: var(--input-background-color);
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <div id="sidebar-header">
            <a href="https://clickhouse.com/clickhouse/keeper">
                <h1>ClickHouse Keeper</h1>
            </a>
        </div>
        <!-- TODO: add any desired info here-->
        <div id="hostInfo">
            <h3>Host:</h3>
            <p id="displayHost" class="monospace">localhost:9182</p>
        </div>
        <div id="roleInfo">
            <h3>Role:</h3>
            <p id="displayRole" class="monospace">--</p>
        </div>
        <div id="avgLatency">
            <h3>Latency avg:</h3>
            <p id="displayLatencyAvg" class="monospace">--</p>
        </div>
        <div id="connections">
            <h3>Connections:</h3>
            <p id="displayConnections" class="monospace">--</p>
        </div>
        <div id="nodeCount">
            <h3>Node count:</h3>
            <p id="displayNodeCount" class="monospace">--</p>
        </div>
        <div id="sidebarVersion">
            <p id="displayCHVersion" class="monospace">v00.0.0.0</p>
        </div>
    </div>

    <div id="main">
        <div id="controls">
            <div id="theme_div">
                <span id="toggle-dark">ð</span><span id="toggle-light">ð</span>
            </div>
        </div>

        <div class="tab-wrap">
            <!-- active tab on page load gets checked attribute -->
            <input type="radio" id="tab_storage" name="tabGroup1" class="tab" checked>
            <label for="tab_storage">Storage</label>

            <input type="radio" id="tab_keeper_client" name="tabGroup1" class="tab">
            <label for="tab_keeper_client">Keeper Client</label>

            <div class="tab__content">
                <div style="display: flex; width: 100%;">
                    <!-- Tree view side -->
                    <div style="flex-basis: 40%; box-sizing: border-box; margin-right: 0.5rem;">
                        <div id="storage-viewer-container"></div>
                    </div>

                    <div style="flex: 1; box-sizing: border-box; margin-left: 0.5rem">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1; overflow-wrap: break-word;">
                                <p id="displayStoragePath" class="monospace">--</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="storage-ui-button monospace" id="addChildButton"
                                    onclick="storage_viewer.addNodeToSelectedNode()">
                                    Add Child
                                </button>
                                <button class="storage-ui-button monospace" id="deleteButton"
                                    onclick="storage_viewer.deleteSelectedNode()">
                                    Delete
                                </button>
                            </div>
                        </div>

                        <div style="display: flex;">
                            <div style="flex-basis: 50%; box-sizing: border-box; margin-right: 0.1rem;">
                                <h4>numChildren:</h4>
                                <p id="displayStorageNumChildren" class="monospace">--</p>
                                <h4>dataLength:</h4>
                                <p id="displayStorageDataLength" class="monospace">--</p>
                                <h4>version:</h4>
                                <p id="displayStorageVersion" class="monospace">--</p>
                                <h4>aversion:</h4>
                                <p id="displayStorageAVersion" class="monospace">--</p>
                                <h4>cversion:</h4>
                                <p id="displayStorageCVersion" class="monospace">--</p>
                                <h4>ctime:</h4>
                                <p id="displayStorageCtime" class="monospace">--</p>
                            </div>

                            <div style="flex: 1; box-sizing: border-box; margin-left: 0.1rem">
                                <h4>ephemeralOwner:</h4>
                                <p id="displayStorageEphemeralOwner" class="monospace">--</p>
                                <h4>cZxid:</h4>
                                <p id="displayStorageCZxid" class="monospace">--</p>
                                <h4>pZxid:</h4>
                                <p id="displayStoragePZxid" class="monospace">--</p>
                                <h4>mZxid:</h4>
                                <p id="displayStorageMZxid" class="monospace">--</p>
                                <h4>mtime:</h4>
                                <p id="displayStorageMtime" class="monospace">--</p>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="display: flex; flex-direction: column; justify-content: flex-end;">
                                <h1>Node Data:</h1>
                            </div>
                            <div style="display: flex; align-items: flex-start;">
                                <button class="storage-ui-button monospace"
                                    onclick="storage_viewer.saveSelectedNodeData()">Save</button>
                            </div>
                        </div>
                        <textarea id="displayStorageData" spellcheck="false" data-gramm="false" class="monospace"
                            style="height: 20em"></textarea>
                    </div>
                </div>
            </div>

            <div class="tab__content">
                <a href="https://clickhouse.com/docs/operations/utilities/clickhouse-keeper-client">
                    <h3>Keeper Client</h3>
                </a>
                <a href="https://clickhouse.com/docs/en/guides/sre/keeper/clickhouse-keeper#four-letter-word-commands">
                    <h3>4LW Commands</h3>
                </a>
                <p>Check "conf" for four_letter_word_allow_list.</p>

                <div>
                    <h3 class="monospace" style="display: inline;">ruok: </h3>
                    <p style="display: inline;">Tests if the server is running in a non-error state.</p>
                </div>
                <div>
                    <h3 class="monospace" style="display: inline;">mntr: </h3>
                    <p style="display: inline;">Outputs a list of variables that could be used for monitoring the health
                        of the cluster.</p>
                </div>
                <div>
                    <h3 class="monospace" style="display: inline;">stat: </h3>
                    <p style="display: inline;">Lists brief details for the server and connected clients.</p>
                </div>
                <div>
                    <h3 class="monospace" style="display: inline;">conf: </h3>
                    <p style="display: inline;">Prints details about serving configuration.</p>
                </div>
                <div style="margin-top: 1rem"> </div>
                <div id="command-scrolling-container"
                    style="display: flex; flex-direction: column; width: 100%; height: 40vh; overflow: auto;">
                    <pre id="command-output" class="monospace" style="width: 100%;"></pre>
                    <div name="command-div" style="display: flex; align-items: center;">
                        <span class="monospace" style="padding-left: 0.25rem;">â</span>
                        <textarea autofocus spellcheck="false" data-gramm="false" class="monospace" id="command"
                            style="height: 15pt"></textarea>
                    </div>
                </div>

            </div>

            <div id="error" style="display: none; width: 100%;"></div>
        </div>

        <p id="logo-container">
            <a href="https://clickhouse.com/">
                <svg id="logo" width="50%" viewBox="0 0 180 28" version="1.1" xmlns="http://www.w3.org/2000/svg"
                    xmlns:xlink="http://www.w3.org/1999/xlink">
                    <title>Powered by ClickHouse</title>
                    <g transform="translate(21, 0)">
                        <path
                            d="M9.76370444,20.9560972 C8.43447886,20.9735251 7.11430823,20.7384252 5.875478,20.2636703 C4.72047444,19.8054437 3.67723122,19.1113387 2.81453379,18.2271205 C1.90927726,17.3283139 1.2048111,16.2531042 0.746328237,15.0704684 C-0.248776079,12.2964995 -0.248776079,9.27056268 0.746328237,6.4965938 C1.67159165,4.07354026 3.61800681,2.16434552 6.08229856,1.26266086 C7.35832383,0.792264319 8.71148185,0.557532775 10.0739353,0.570233938 C11.1612577,0.548839362 12.2465336,0.672146838 13.3003359,0.936812899 C14.1575307,1.16603291 14.9890302,1.47989577 15.7821826,1.8736258 L15.0376286,4.17492705 C14.334754,3.70811103 13.5779913,3.32526638 12.7832845,3.03445917 C11.8308864,2.71897047 10.8304102,2.56740693 9.82575061,2.58641822 C7.96245266,2.56886976 6.1853824,3.35817309 4.96546756,4.74516099 C4.30442786,5.50472232 3.79877758,6.38298172 3.47635956,7.33157921 C3.08814385,8.46618422 2.89929764,9.65767851 2.91794407,10.8548103 C2.90195973,12.0219322 3.07653544,13.184001 3.43499545,14.2965795 C3.73382292,15.2302331 4.21899806,16.0957206 4.86205728,16.8422667 C5.46077204,17.5238868 6.21094713,18.0604846 7.05435517,18.41041 C7.95798877,18.7824827 8.9290709,18.969569 9.90847883,18.9602785 C10.8005951,18.9648543 11.68759,18.827308 12.5350999,18.5529685 C13.3447055,18.2769814 14.1214074,17.9150606 14.8514901,17.4735971 L15.575362,19.2046644 C14.8756447,19.7279796 14.0929921,20.1339593 13.2589718,20.4062288 C12.1346344,20.7859604 10.952228,20.9719742 9.76370444,20.9560972 L9.76370444,20.9560972 Z"
                            id="Path"></path>
                        <polygon id="Path"
                            points="21.2008811 0 21.2008811 20.6709803 18.7397165 20.6709803 18.7397165 0 21.2008811 0">
                        </polygon>
                        <path
                            d="M26.5161694,4.15456155 C26.0981094,4.18404053 25.6871808,4.03620327 25.3868859,3.74828616 C25.0865909,3.46036905 24.9255529,3.05981554 24.9443332,2.64751471 C24.9293499,2.23543398 25.0776822,1.83376364 25.3579743,1.52741233 C25.9917593,0.922143971 26.9992154,0.922143971 27.6330004,1.52741233 C27.9227354,1.82938962 28.0789406,2.23223687 28.0673236,2.64751471 C28.0795295,3.0508229 27.9224226,3.44126169 27.6330004,3.7268861 C27.3352303,4.0129939 26.9320049,4.16740365 26.5161694,4.15456155 L26.5161694,4.15456155 Z M27.7570927,6.31330432 L27.7570927,20.5691528 L25.3166102,20.5691528 L25.3166102,6.31330432 L27.7777748,6.31330432 L27.7570927,6.31330432 Z"
                            id="Shape"></path>
                        <path
                            d="M38.2015308,20.9561849 C37.2331788,20.9606473 36.2723959,20.7880054 35.3680892,20.4469598 C34.5040176,20.1277138 33.7207114,19.6274001 33.072381,18.9806439 C32.4086321,18.3083453 31.8882536,17.5120269 31.5419089,16.6386117 C30.789066,14.6134632 30.789066,12.3911868 31.5419089,10.3660384 C31.8953146,9.48650873 32.4305899,8.68894988 33.1137451,8.02400613 C33.8006138,7.36063917 34.6265105,6.85322326 35.5335456,6.53732479 C36.4665869,6.19626518 37.4544707,6.0237894 38.4497154,6.02818735 C39.2367736,6.02254268 40.0215928,6.11144966 40.7867877,6.29293882 C41.402916,6.43127907 41.9904819,6.67235105 42.5240804,7.00573124 L41.7381623,9.14410851 C41.2326995,8.76428196 40.6844527,8.44310218 40.1042799,8.18693012 C39.4990142,7.95244732 38.8516533,7.84158602 38.2015308,7.86108215 C37.5775701,7.85677667 36.958946,7.97445444 36.3815099,8.20729561 C35.8033669,8.44328317 35.2871426,8.80537627 34.8717198,9.2663015 C34.4220004,9.77237252 34.0776687,10.3605404 33.8582991,10.9973688 C33.5836299,11.7832018 33.4506403,12.6102801 33.4653401,13.4412285 C33.3646964,14.9221144 33.8543791,16.3832889 34.8303557,17.5143281 C35.8193073,18.4542588 37.1597853,18.9483223 38.5324437,18.8788165 C39.7296588,18.8515966 40.8932941,18.483801 41.8829366,17.8198106 L42.4413521,19.6119744 C41.8863529,20.0201826 41.2635134,20.3302813 40.6006492,20.5284218 C39.8277327,20.7904738 39.0186907,20.9346965 38.2015308,20.9561849 L38.2015308,20.9561849 Z"
                            id="Path"></path>
                        <path
                            d="M47.9427789,0 L47.9427789,20.6709803 L45.4402502,20.6709803 L45.4402502,0 L47.9427789,0 Z M54.3542161,20.6709803 L48.2736918,13.0135531 L54.2714879,6.33366982 L56.8360628,6.33366982 L50.9003129,12.7284361 L57.2497039,20.6709803 L54.3542161,20.6709803 L54.3542161,20.6709803 Z"
                            id="Shape"></path>
                        <polygon id="Path"
                            points="73.1128405 11.8730852 62.7718127 11.8730852 62.7718127 20.6506148 60.1038276 20.6506148 60.1038276 0.855350908 62.7718127 0.855350908 62.7718127 9.89763193 73.1128405 9.89763193 73.1128405 0.855350908 75.7808256 0.855350908 75.7808256 20.6709803 73.1128405 20.6709803">
                        </polygon>
                        <path
                            d="M86.3079919,20.9560972 C85.38699,20.956828 84.4743522,20.7840259 83.6193247,20.4469598 C82.7801539,20.1243214 82.0191689,19.6317014 81.3856627,19.0010094 C80.7288968,18.3272298 80.2155719,17.5309446 79.8758726,16.6589772 C79.1241518,14.6056391 79.1241518,12.35828 79.8758726,10.3049419 C80.2139667,9.43820628 80.7276537,8.64828849 81.3856627,7.98327514 C82.0210949,7.3549028 82.7815529,6.86262399 83.6193247,6.53732479 C84.4743522,6.20025867 85.38699,6.0274377 86.3079919,6.02818492 C87.235663,6.02783377 88.154999,6.20059422 89.0173412,6.53732479 C89.8608646,6.86326706 90.6279639,7.35528929 91.2716852,7.98327514 C91.9432058,8.64563226 92.4709473,9.43552137 92.8228394,10.3049419 C93.5941835,12.3548594 93.5941835,14.6090597 92.8228394,16.6589772 C92.5001582,17.5252355 92.0083217,18.3208853 91.3750955,19.0010094 C90.7336187,19.6317283 89.9659063,20.1241438 89.1207514,20.4469598 C88.2261198,20.7965781 87.270406,20.9695718 86.3079919,20.9560972 Z M86.3079919,19.1028369 C86.8871906,19.1004754 87.4613802,18.9970483 88.0039204,18.7973545 C88.5665616,18.5933999 89.0704796,18.2579374 89.4723464,17.8198106 C89.93364,17.3107661 90.2854168,16.714971 90.5064492,16.0683778 C90.7858877,15.2345245 90.9187812,14.3598326 90.8994082,13.4819595 C90.921252,12.6039337 90.7882958,11.7288286 90.5064492,10.8955413 C90.2829062,10.2561715 89.9312542,9.66751308 89.4723464,9.16447401 C89.0704796,8.72634722 88.5665616,8.39088465 88.0039204,8.18693012 C87.4613802,7.98723626 86.8871906,7.88380922 86.3079919,7.88144765 C85.7421967,7.88338153 85.1815027,7.98690253 84.6534274,8.18693012 C84.1067964,8.39867016 83.6180769,8.73344525 83.2263656,9.16447401 C82.771108,9.66662382 82.426093,10.2559587 82.2129449,10.8955413 C81.9432303,11.7312023 81.817401,12.6054092 81.8406679,13.4819595 C81.8197008,14.3583785 81.9454766,15.2322137 82.2129449,16.0683778 C82.4234966,16.7151843 82.7686424,17.3116787 83.2263656,17.8198106 C83.6175627,18.2514112 84.1064306,18.586288 84.6534274,18.7973545 C85.1815027,18.9973821 85.7421967,19.1009031 86.3079919,19.1028369 L86.3079919,19.1028369 Z"
                            id="Shape"></path>
                        <path
                            d="M104.218652,20.1211118 C103.261113,20.713834 102.142858,21.0051032 101.012933,20.9560972 C99.7999523,21.0051122 98.6193584,20.5636475 97.7451686,19.7341674 C96.8353108,18.7009502 96.3878256,17.3496664 96.5042453,15.9869158 L96.5042453,6.31330432 L98.9860919,6.31330432 L98.9860919,15.9869158 C98.9742754,16.4701161 99.0441695,16.9518863 99.1929125,17.4125006 C99.3056456,17.7606047 99.5046708,18.0755709 99.77201,18.328948 C100.016574,18.5594167 100.314849,18.7272509 100.640656,18.81772 C100.990271,18.9161408 101.352523,18.9641592 101.716123,18.9602785 C102.655549,19.0038445 103.582007,18.7308795 104.342744,18.1863895 C105.051689,17.6370184 105.630443,16.9420231 106.038673,16.1498398 L106.038673,6.31330432 L108.499837,6.31330432 L108.499837,20.5691528 L106.328222,20.5691528 L106.100719,18.0031001 L106.100719,18.0031001 C105.687922,18.8692089 105.035644,19.6032598 104.218652,20.1211118 L104.218652,20.1211118 Z"
                            id="Path"></path>
                        <path
                            d="M116.421065,20.9560972 C115.801233,20.9950241 115.179512,20.9950241 114.55968,20.9560972 C114.092617,20.8964402 113.62981,20.8080164 113.173982,20.6913458 C112.813228,20.605003 112.460411,20.4891975 112.119197,20.3451323 C111.834495,20.2200141 111.558175,20.0771664 111.291915,19.9174568 L112.098515,17.8809071 C112.279343,18.026767 112.473161,18.156273 112.677613,18.2678515 C112.976636,18.4329534 113.287727,18.5759069 113.608305,18.695527 C114.017173,18.8537321 114.439319,18.9763932 114.869911,19.0621059 C115.380772,19.1609067 115.900459,19.2086684 116.421065,19.2046644 C117.260254,19.2611102 118.095255,19.0466179 118.799501,18.5936995 C119.330358,18.1920161 119.630919,17.5621502 119.606101,16.9033632 C119.629117,16.3456326 119.383876,15.8098319 118.944275,15.4574128 C118.248621,14.9827695 117.47054,14.6376468 116.648567,14.4391379 L114.869911,13.8485385 C114.332933,13.6600961 113.82489,13.3996834 113.36012,13.0746496 C112.918371,12.7629353 112.551287,12.3597625 112.284654,11.8934507 C111.990937,11.3416153 111.84837,10.7239217 111.871013,10.1012869 C111.7928,8.92823263 112.331666,7.79778562 113.298074,7.10755873 C114.467654,6.39295223 115.832855,6.05154147 117.206983,6.13001484 C118.07528,6.11663174 118.942387,6.19859987 119.79224,6.37440081 C120.389496,6.49652839 120.971868,6.68085438 121.529532,6.92426925 L120.950435,8.96081903 C120.479952,8.73041885 119.996597,8.52643737 119.502691,8.3498541 C118.797193,8.1146398 118.054965,8.00432014 117.310393,8.02400613 C116.535101,7.9880419 115.762277,8.13465573 115.056049,8.45168159 C114.47936,8.75940804 114.145458,9.37689414 114.208085,10.0198249 C114.202,10.3323024 114.296078,10.6387208 114.476951,10.8955413 C114.663996,11.1520366 114.903538,11.3670997 115.180141,11.5268718 C115.506126,11.720303 115.852962,11.8774057 116.214244,11.9952782 L117.455167,12.3618572 L119.130414,12.9117256 C119.664383,13.1015363 120.166356,13.3692768 120.619522,13.70598 C121.602378,14.4140087 122.154912,15.5634667 122.087948,16.7608047 C122.121004,17.4696719 121.956505,18.1739382 121.612261,18.7973545 C121.300726,19.3338382 120.869299,19.7934828 120.350655,20.1414773 C119.804193,20.5059941 119.194247,20.7683295 118.551316,20.9153662 C117.845409,21.0123699 117.130265,21.0260437 116.421065,20.9560972 Z"
                            id="Path"></path>
                        <path
                            d="M136.379248,19.4286849 C135.765636,19.9144267 135.063746,20.2807344 134.311043,20.5080563 C133.397586,20.8060079 132.439751,20.9505822 131.477601,20.9357317 C129.484022,21.0457076 127.539179,20.3034303 126.141631,18.899182 C124.819952,17.3656124 124.152831,15.3875844 124.280246,13.3801321 C124.263071,12.3194805 124.438164,11.2643153 124.797297,10.2642109 C125.111353,9.39844373 125.596363,8.60246478 126.224359,7.92217864 C126.799559,7.29363386 127.504769,6.79365416 128.292565,6.4558628 C129.13245,6.11650376 130.03203,5.94349361 130.939868,5.94672536 C131.84844,5.93569173 132.749586,6.10900306 133.587171,6.4558628 C134.355957,6.77570775 135.026242,7.28828126 135.531284,7.94254414 C136.069381,8.66407624 136.423989,9.5021104 136.565387,10.3864039 C136.756685,11.5054228 136.756685,12.6480576 136.565387,13.7670765 L126.720728,13.7670765 C126.831033,17.1749031 128.464915,18.8788165 131.622376,18.8788165 C132.38185,18.8941966 133.138087,18.7769813 133.856038,18.532603 C134.495821,18.304128 135.106567,18.0034291 135.676058,17.6365211 L136.379248,19.4286849 Z M131.022596,7.73888916 C130.017668,7.7293132 129.052936,8.12697327 128.354611,8.83862604 C127.526752,9.75405949 127.031943,10.9148261 126.948231,12.1378367 L134.331725,12.1378367 C134.534684,10.9751452 134.259342,9.78072052 133.566489,8.81826055 C132.931983,8.09270485 131.993938,7.6946933 131.022596,7.73888916 Z"
                            id="Shape"></path>
                    </g>
                </svg>
            </a>
            <a id="cloud-logo" href="https://clickhouse.cloud/">â</a>
        </p>
    </div>
</body>

<script type="text/javascript">
    function renderError(message) {
        document.getElementById("error").innerText = message;
        document.getElementById("error").style.display = "block";
        document.getElementById("logo-container").style.display = "none";
    }

    class StorageViewer {
        constructor(container) {
            this.container = container;
            this.root = undefined;
            this.selected_node = undefined;
        }

        async init() {
            this.root = await this.loadRoot();
            if (this.root.hasData()) {
                await this.root.loadData();
            }
            this.root.select(); // select root
            this.reload();
        }

        async loadRoot() {
            const server_url = new URL(window.location);
            server_url.pathname = "/api/v1/storage/list/";

            const res = await fetch(server_url.toString());
            const data = res.ok ? await res.json() : undefined;

            return data ? new StorageNode("/", undefined, data.stat, data.child_node_names) : undefined;
        }

        reload() {
            if (this.container == null) {
                console.warn("No container specified");
                return;
            }

            if (this.root == null) {
                console.warn("Root is not loaded");
                return;
            }

            this.container.classList.add("storage_viewer_container");

            let cnt = document.createElement("ul");

            cnt.appendChild(this.root.render());

            this.container.innerHTML = "";
            this.container.appendChild(cnt);

            this.renderSelectedNodeData();
        }

        updateSelectedNode(node) {
            if (this.selected_node !== undefined) {
                this.selected_node.selected = false;
            }
            this.selected_node = node;
            this.selected_node.selected = true;
        }

        renderSelectedNodeData() {
            // path
            document.getElementById("displayStoragePath").innerText = this.selected_node?.path ?? "--";
            // stat
            document.getElementById("displayStorageAVersion").innerText = this.selected_node?.stat?.aversion ?? "--";
            document.getElementById("displayStorageCZxid").innerText = this.selected_node?.stat?.czxid ?? "--";
            document.getElementById("displayStorageCVersion").innerText = this.selected_node?.stat?.cversion ?? "--";
            document.getElementById("displayStorageDataLength").innerText = this.selected_node?.stat?.dataLength ?? "--";
            document.getElementById("displayStorageEphemeralOwner").innerText = this.selected_node?.stat?.ephemeralOwner ?? "--";
            document.getElementById("displayStorageMZxid").innerText = this.selected_node?.stat?.mzxid ?? "--";
            document.getElementById("displayStorageNumChildren").innerText = this.selected_node?.stat?.numChildren ?? "--";
            document.getElementById("displayStoragePZxid").innerText = this.selected_node?.stat?.pzxid ?? "--";
            document.getElementById("displayStorageVersion").innerText = this.selected_node?.stat?.version ?? "--";
            if (this.selected_node?.stat?.mtime !== undefined) {
                document.getElementById("displayStorageMtime").innerText = new Date(this.selected_node?.stat?.mtime).toLocaleString("en-US", { hour12: false });
            } else {
                document.getElementById("displayStorageMtime").innerText = "--";
            }
            if (this.selected_node?.stat?.mtime !== undefined) {
                document.getElementById("displayStorageCtime").innerText = new Date(this.selected_node?.stat?.mtime).toLocaleString("en-US", { hour12: false });
            } else {
                document.getElementById("displayStorageCtime").innerText = "--";
            }
            // data
            if (this.selected_node && this.selected_node.data) {
                document.getElementById("displayStorageData").value = new TextDecoder("utf-8").decode(this.selected_node.data);
            } else {
                document.getElementById("displayStorageData").value = "";
            }
            // buttons
            let delete_button = document.getElementById("deleteButton");
            if (!this.selected_node || !this.selected_node.isLeaf() || this.selected_node.isRoot()) {
                delete_button.disabled = true;
                delete_button.setAttribute("title", "Only nodes with no children can be deleted.");
            } else {
                delete_button.disabled = false;
                delete_button.removeAttribute("title");
            }
        }

        async saveSelectedNodeData() {
            if (!this.selected_node) {
                return;
            }

            let data_to_save = document.getElementById("displayStorageData").value;
            let encoder = new TextEncoder();

            let server_url = new URL(window.location);
            server_url.pathname = `/api/v1/storage/set${this.selected_node.path}`;

            let request_url = server_url.toString();
            request_url += "?" + new URLSearchParams({ version: this.selected_node.version })

            const res = await fetch(request_url,
                {
                    method: "POST",
                    body: encoder.encode(data_to_save)
                });
            if (res.ok) {
                await this.selected_node.reloadContent();
            } else {
                renderError(`Failed to save the node's data: ${res.statusText}`)
            }

            this.reload();
        }

        async deleteSelectedNode() {
            if (!this.selected_node) {
                return;
            }

            if (!this.selected_node.isLeaf()) {
                return; // the button should be disabled
            }

            if (this.selected_node.isRoot()) {
                return; // the button should be disabled
            }
            this.selected_node.parent.removeChild(this.selected_node.name());

            let server_url = new URL(window.location);
            server_url.pathname = `/api/v1/storage/remove${this.selected_node.path}`;

            let request_url = server_url.toString();
            request_url += "?" + new URLSearchParams({ version: this.selected_node.version })

            const res = await fetch(request_url,
                {
                    method: "POST",
                });
            if (res.ok) {
                await this.selected_node.parent.reloadContent();
                await this.selected_node.parent.select();
            } else {
                renderError(`Failed to remove the node: ${res.statusText}`)
            }

            this.reload();
        }

        async addNodeToSelectedNode() {
            if (!this.selected_node) {
                return;
            }
            this.selected_node.makeChildStub();
            // expand the node if not expanded
            if (!this.selected_node.expanded) {
                await this.selected_node.toggleExpanded();
            }
            this.reload();

            // focus on the input after everything is rendered
            let stub_name_input = document.getElementsByClassName("storage_node_name_input")[0];
            stub_name_input.focus();
        }
    }

    class StorageNodeStub {
        constructor(parent) {
            this.parent = parent
        }

        render() {
            let result = document.createElement("li");
            let input_field = document.createElement("input");
            input_field.className = "storage_node_name_input"; // setting a class to your input field
            input_field.storage_node = this;

            input_field.onblur = function () {
                // need to destroy the stub as user discarded the input
                this.storage_node.destroy();
                storage_viewer.reload();
            }

            // trigger event if user press Enter
            input_field.addEventListener("keydown", async function (event) {
                if (event.code === "Enter") {
                    event.preventDefault();
                    if (input_field.value === "") {
                        // need to destroy the stub as user discarded the input
                        this.storage_node.destroy();
                        storage_viewer.reload();
                        return;
                    }

                    await this.storage_node.parent.createChild(input_field.value);
                    this.storage_node.destroy(); // we replaced the stub with a real node
                    storage_viewer.reload();
                }
            });

            result.appendChild(input_field);

            return result;
        }

        destroy() {
            this.parent.stub_child = undefined;
        }

    }

    class StorageNode {
        constructor(path, parent, stat, children_names = []) {
            this.path = path;
            this.stat = stat;
            this.data = undefined;
            this.version = stat?.version ?? undefined;
            this.children_names = children_names;
            this.children = []; // nodes themselves are lazy loaded
            this.expanded = false;
            this.selected = false;
            this.parent = parent
            this.stub_child = undefined; // StorageNodeStub reference if a child node is in creation
        }

        isLeaf() {
            return (this.children_names.length === 0 && this.stub_child === undefined);
        }

        isRoot() {
            return this.path === "/";
        }

        async reloadContent() {
            let server_url = new URL(window.location);

            let promises = [];
            server_url.pathname = `/api/v1/storage/list${this.path}`;
            promises.push(fetch(server_url.toString())
                .then(res => res.ok ? res.json() : undefined)
                .then(data => {
                    if (data) {
                        this.stat = data.stat;
                        this.version = data.stat?.version ?? undefined;
                        this.children_names = data.child_node_names;
                    }
                }));
            promises.push(this.loadData());

            await Promise.all(promises);
        }

        async expand() {
            if (this.isLeaf()) {
                console.warn("This node has no children.");
                return;
            }

            let server_url = new URL(window.location);
            server_url.pathname = `/api/v1/storage/list`;
            let list_url = server_url.toString();

            const childNodeRequests = this.children_names.map(child_name =>
                fetch(list_url + this.getPathOfChild(child_name))
                    .then(res => res.ok ? res.json() : undefined)
                    .then(data => data ? new StorageNode(this.getPathOfChild(child_name), this, data.stat, data.child_node_names) : undefined)
            );

            this.children = await Promise.all(childNodeRequests);
            this.expanded = true;
        }

        async collapse() {
            if (storage_viewer.selected_node.isChildOf(this)) {
                this.select();
            }
            this.children.forEach(function (child) {
                child.collapse();
            });
            this.expanded = false;
        }

        render() {
            let result = document.createElement("li");
            let span_desc = document.createElement("span");
            span_desc.className = "storage_node_description";
            span_desc.storage_node = this;

            span_desc.addEventListener("click", async function (e) {
                let cur_el = e.target;

                while (typeof cur_el.storage_node === "undefined" || cur_el.classList.contains("storage_viewer_container")) {
                    cur_el = cur_el.parentElement;
                }

                let node_cur = cur_el.storage_node;

                if (typeof node_cur === "undefined") {
                    return;
                }

                if (node_cur.hasData()) {
                    await node_cur.loadData();
                }

                node_cur.select();
                storage_viewer.reload();
            });

            if (this.selected) {
                span_desc.classList.add("selected");
            }

            if (this.isLeaf()) {
                span_desc.innerHTML = this.name() + "</span>";
                span_desc.classList.add("storage_leaf");

                result.appendChild(span_desc);
            } else {
                let span_icon = document.createElement("span");
                span_icon.className = "storage_ui_icon";
                span_icon.style.fontFamily = "monospace";
                span_icon.innerHTML = this.expanded ? "<span>&#x25BE;</span>" : "<span>&#x25B8;</span>";

                span_icon.addEventListener("click", async function (e) {
                    e.stopPropagation();
                    let cur_el = e.target;

                    while (typeof cur_el.storage_node === "undefined" || cur_el.classList.contains("storage_viewer_container")) {
                        cur_el = cur_el.parentElement;
                    }

                    let node_cur = cur_el.storage_node;

                    if (typeof node_cur === "undefined") {
                        return;
                    }

                    if (!node_cur.isLeaf()) {
                        await node_cur.toggleExpanded();
                    }
                    storage_viewer.reload();
                });

                span_desc.appendChild(span_icon);
                span_desc.appendChild(document.createTextNode(this.name()));
                result.appendChild(span_desc);

                if (this.expanded) {
                    let ul_container = document.createElement("ul");

                    if (this.stub_child) {
                        ul_container.appendChild(this.stub_child.render());
                    }

                    this.children.forEach(function (child) {
                        ul_container.appendChild(child.render());
                    });

                    result.appendChild(ul_container)
                }
            }

            return result;
        }

        async toggleExpanded() {
            if (this.isLeaf()) {
                return;
            }
            if (this.expanded) {
                await this.collapse();
            } else {
                await this.expand();
            }
        };

        select() {
            storage_viewer.updateSelectedNode(this);
        };

        name() {
            if (this.path === "/") {
                return "/";
            }
            const split_path = this.path.split("/");
            if (!split_path[split_path.length - 1]) {
                split_path.pop();
            }
            return split_path.length > 0 ? split_path[split_path.length - 1] : "unknown";
        }

        getPathOfChild(child_name) {
            return (this.path === "/" ? "" : this.path) + `/${child_name}`;
        }

        hasData() {
            return (this.stat?.dataLength ?? 0) !== 0;
        }

        async loadData() {
            let server_url = new URL(window.location);
            server_url.pathname = `/api/v1/storage/get`;

            const res = await fetch(server_url.toString() + this.path);
            if (res.ok) {
                const buffer = await res.arrayBuffer();
                this.data = new Uint8Array(buffer);
            } else {
                this.data = undefined;
            }
        }

        removeChild(child_name) {
            this.children_names = this.children_names.filter(name => name !== child_name);
            this.children = this.children.filter(child => child.name() !== child_name);
        }

        makeChildStub() {
            this.stub_child = new StorageNodeStub(this);
        }

        async createChild(child_name) {
            let server_url = new URL(window.location);
            server_url.pathname = `/api/v1/storage/create`;
            let create_url = server_url.toString();

            const res = await fetch(create_url + this.getPathOfChild(child_name),
                {
                    method: "POST"
                });

            if (res.ok) {
                this.children_names.push(child_name);
                let new_child_node = new StorageNode(this.getPathOfChild(child_name), this, undefined, []);
                // load necessary data for a new node
                await new_child_node.reloadContent();
                await this.reloadContent()
                this.children.push(new_child_node);
                new_child_node.select();
            } else {
                renderError(`Failed to create the node: ${res.statusText}`)
            }
        }

        isChildOf(node) {
            return this.path.startsWith(node.path);
        }
    }

    const current_url = new URL(window.location);
    const opened_locally = location.protocol === "file:";

    const server_host = window.location.hostname;
    if (server_host) {
        document.getElementById("displayHost").innerText = server_host;
    } else if (!opened_locally) {
        /// Substitute the address of the server where the page is served.
        document.getElementById("displayHost").innerText = location.origin;
    }

    function fetchContentImpl() {
        const server_url = new URL(window.location);
        server_url.pathname = "/dashboard/content";

        const xhr = new XMLHttpRequest;
        xhr.open("GET", server_url.toString(), false);
        xhr.onreadystatechange = function () {
            if (this.readyState === XMLHttpRequest.DONE) {
                renderContentResponse(this.status, this.response);
            } else {
                /// console.log(this);
            }
        }
        xhr.send();
    }

    function renderContentResponse(status, response) {
        if (status === 200) {
            const json = JSON.parse(response);

            if (json !== undefined) {
                if (json.ch_version !== undefined) {
                    document.getElementById("displayCHVersion").innerText = json.ch_version;
                }
                document.getElementById("displayRole").innerText = json?.keeper_details?.role ?? "--";
                document.getElementById("displayLatencyAvg").innerText = json?.keeper_details?.latency_avg ?? "--";
                document.getElementById("displayConnections").innerText = json?.keeper_details?.alive_connections ?? "--";
                document.getElementById("displayNodeCount").innerText = json?.keeper_details?.node_count ?? "--";
            }
        } else {
            renderError(`HTTP Error: ${status}`)
        }
    }

    /// First we check if theme is set via the "theme" GET parameter, if not, we check localStorage, otherwise we check OS preference.
    let theme = current_url.searchParams.get("theme");
    if (["dark", "light"].indexOf(theme) === -1) {
        theme = window.localStorage.getItem("theme");
    }
    if (!theme) {
        theme = "dark";
    }

    function setColorTheme(new_theme, update_preference) {
        theme = new_theme;
        if (update_preference) {
            window.localStorage.setItem("theme", theme);
        }
        document.documentElement.setAttribute("data-theme", theme);
    }

    if (theme) {
        document.documentElement.setAttribute("data-theme", theme);
    } else {
        /// Obtain system-level user preference
        const media_query_list = window.matchMedia("(prefers-color-scheme: dark)");
        if (media_query_list.matches) {
            setColorTheme("dark");
        }

        /// There is a rumor that on some computers, the theme is changing automatically on day/night.
        media_query_list.addEventListener("change", function (e) {
            setColorTheme(e.matches ? "dark" : "light");
        });
    }

    document.getElementById("toggle-light").onclick = function () {
        setColorTheme("light", true);
    }

    document.getElementById("toggle-dark").onclick = function () {
        setColorTheme("dark", true);
    }

    function setupCommandLine() {
        let command_input = document.querySelector("#command");
        let command_output = document.querySelector("#command-output");
        let command_container = document.getElementById("command-scrolling-container");

        /// focus on command_input, but prevent losing the selection in command_output.
        command_container.addEventListener("mouseup", function (e) {
            if (e.target.id !== "command-output") {
                command_input.focus();
            }
            else if (window.getSelection().toString().length === 0) {
                command_input.focus();
            }
        });

        command_input.addEventListener("keydown", function (event) {
            if (event.code === "Enter") {
                event.preventDefault(); // Prevents the normal form submission for Enter key

                // Add command to history and clear input
                let command = command_input.value;
                command_input.value = "";
                command_output.append(`â ${command}\n`);
                command_container.scrollTop = command_container.scrollHeight;
                command_input.disabled = true;

                const server_url = new URL(window.location);
                server_url.pathname = "/api/v1/commands";
                let url = server_url.toString();
                fetch(url + "?" + new URLSearchParams({
                    command: command,
                }).toString())
                    .then(response => response.json())
                    .then(data => {
                        if (data.result !== undefined) {
                            command_output.append(`${data.result}`);
                        } else if (data.message !== undefined) {
                            command_output.append(`${data.message}`);
                        } else {
                            command_output.append("Unexpected error\n");
                        }
                        if (command_output.textContent.charAt(command_output.textContent.length - 1) !== "\n") {
                            command_output.append("\n");
                        }
                        command_input.disabled = false;
                        command_input.focus();
                    })
                    .catch(err => {
                        command_output.append(`Unexpected error: ${err}\n`);
                        command_input.disabled = false;
                        command_input.focus();
                    });
                command_container.scrollTop = command_container.scrollHeight;
            }
        });
    }

    function loadContent() {
        fetchContentImpl();
    }

    async function start() {
        try {
            setupCommandLine();
            loadContent();
        } catch (e) {
            renderError(`Failed to start: ${e}`)
        }
    }

    let storage_viewer = new StorageViewer(document.getElementById("storage-viewer-container"));
    storage_viewer.init();

    start();

</script>

</html>