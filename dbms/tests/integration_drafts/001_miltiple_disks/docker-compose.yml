version: '3'

services:
  zookeeper:
    image: zookeeper
    networks:
      - 001_miltiple_disks      

  ch1:
    image: yandex/clickhouse-server
    hostname: ch1
    depends_on:
      - "zookeeper"
    networks:
      - 001_miltiple_disks 
    tmpfs:
      - /jbod1:size=40M
      - /jbod2:size=40M
      - /external:size=200M
    volumes:
      - ./config/conf.d:/etc/clickhouse-server/conf.d    
      - ./config/ch1.metrika.xml:/etc/metrika.xml    
      # TODO: hacky, but "cheap" - don't need to rebuild docker image.
      # for CI & tests automation should be done another way, not relying on build path 
      - ../../../../build/dbms/programs/clickhouse:/usr/bin/clickhouse
      - ./test_setup:/test_setup
    entrypoint: ['/test_setup/entrypoint.sh']


  ch2:
    image: yandex/clickhouse-server
    hostname: ch2
    depends_on:
      - "zookeeper"
    networks:
      - 001_miltiple_disks 
    tmpfs:
      - /jbod1:size=40M
      - /jbod2:size=40M
      - /external:size=200M
    volumes:
      - ./config/conf.d:/etc/clickhouse-server/conf.d    
      - ./config/ch2.metrika.xml:/etc/metrika.xml    
      # TODO: hacky, but "cheap" - don't need to rebuild docker image.
      # for CI & tests automation should be done another way, not relying on build path 
      - ../../../../build/dbms/programs/clickhouse:/usr/bin/clickhouse
      - ./test_setup:/test_setup
    entrypoint: ['/test_setup/entrypoint.sh']
    

networks:
  001_miltiple_disks:      
