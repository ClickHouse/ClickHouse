docs/en/whats-new/changelog/2017.md---
toc_priority: 79
toc_title: '2017'
---

### ClickHouse Release 1.1.54327, 2017-12-21 {#clickhouse-release-1-1-54327-2017-12-21}

此版本包含`1.1.54318`版本的错误修复:

- 修复了复制中可能导致数据丢失的争用情况错误。此问题影响版本`1.1.54310`和`1.1.54318`。如果对复制表使用这些版本之一，强烈建议进行更新。此问题显示在日志中的警告消息中，如`Part ... from own log doesn't exist.`即使您在日志中没有看到这些消息，问题仍然是存在的。

### ClickHouse Release 1.1.54318, 2017-11-30 {#clickhouse-release-1-1-54318-2017-11-30}

此版本包含`1.1.54310`版本的错误修复:

-   修复了SummingMergeTree引擎中合并期间不正确的行删除
-   修复了未复制的MergeTree引擎中的内存泄漏
-   修复了MergeTree引擎中频繁插入的性能下降问题
-   修复了复制导致队列停止运行的问题
-   修复了服务器日志的归档问题

### ClickHouse Release 1.1.54310, 2017-11-01 {#clickhouse-release-1-1-54310-2017-11-01}

#### New Feature: {#new-features}

-   MergeTree表引擎自定义分区
-   [Kafka](https://clickhouse.tech/docs/en/operations/table_engines/kafka/)表引擎
-   增加了对[CatBoost](https://catboost.yandex/)模型的支持并将其应用于ClickHouse中存储的数据
-   增加了对UTC非整数偏移时区的支持
-   增加了对时间间隔算术运算的支持
-   Date和DateTime类型的值范围扩展到2105年
-   添加`CREATE MATERIALIZED VIEW x TO y`查询(指定用于存储物化视图数据的现有表)
-   添加了不带参数的`ATTACH TABLE`查询
-   SummingMergeTree表引擎中名称以-Map结尾的嵌套列的处理逻辑被提取到sumMap aggregate函数中。现在可以显式指定这些列
-   IP trie字典的最大大小增加到128M
-   添加getSizeOfEnumType函数
-   添加sumWithOverflow聚合函数
-   增加对Cap'n Proto输入格式的支持
-   支持使用zstd算法时自定义压缩级别

#### Backward Incompatible Changes: {#backward-incompatible-changes}

-   不允许使用内存以外的引擎创建临时表
-   不允许使用视图或MaterializedView引擎显式创建表
-   在表创建过程中，检查验证采样表达式是否包含在主键中

#### Bug Fixes: {#bug-fixes}

-   修正了同步插入分布式表时的挂起问题
-   修复了复制表中部件的非原子添加和删除问题
-   插入到物化视图中的数据不会受到不必要的重复数据消除的影响
-   对本地副本滞后且远程副本不可用的分布式表执行查询不会再导致错误
-   用户不再需要对`default`数据库的访问权限来创建临时表
-   修复了指定不带参数的数组类型时的崩溃问题
-   修复了包含服务器日志的磁盘卷已满时的挂起问题
-   修复了Unix epoch第一周的toRelativeWeekNum函数中的溢出问题

#### Build Improvements: {#build-improvements}

-   一些第三方库(尤其是Poco)被更新并转换为git子模块

### ClickHouse Release 1.1.54304, 2017-10-19 {#clickhouse-release-1-1-54304-2017-10-19}

#### New Features: {#new-features-1}

-   本地支持TLS协议(要启用，请在`config.xml`设置`tcp_ssl_port`)

#### Bug Fixes: {#bug-fixes-1}

-   复制表的`ALTER`操作现在尝试尽快开始运行
-   修复了读取数据设置`preferred_block_size_bytes=0`时的崩溃问题
-   修复了按下`Page Down`时`clickhouse-client`崩溃的问题
-   正确解析`GLOBAL IN`和`UNION ALL`的复杂查询
-   `FREEZE PARTITION`总是以原子方式工作
-   空POST请求现在返回一个带有代码411的响应
-   修复了如`CAST(1 AS Nullable(UInt8))`之类的表达式的解析错误
-   修复了从`MergeTree`表中读取`Array(Nullable(String))`列时的错误
-   修复了在解析如`SELECT dummy AS dummy, dummy AS b`之类的查询时崩溃的问
-   更新用户使用无效的`users.xml`
-   处理可执行字典返回非零的响应代码

### ClickHouse Release 1.1.54292, 2017-09-20 {#clickhouse-release-1-1-54292-2017-09-20}

#### New Features: {#new-features-2}

-   添加用于处理坐标平面上的坐标的`pointInPolygon`函数
-   添加用于计算数组总和的`sumMap`聚合函数，类似于`SummingMergeTree`
-   添加`trunc`功能，改进了舍入函数（`round`、`floor`、`ceil`、`roundToExp2`）的性能并更正了它们工作方式的逻辑。更改了分数和负数的`roundToExp2`函数的逻辑
-   ClickHouse 可执行文件现在较少依赖于libc版本。同一个ClickHouse可执行文件可以在各种Linux系统上运行。使用编译查询时仍然存在依赖性（使用设置`compile = 1`，默认情况下不使用）
-   减少了动态编译查询所需的时间

#### Bug Fixes: {#bug-fixes-2}

-   修复了有时会产生`part ... intersects previous part`消息和削弱副本一致性的错误
-   修复了在关闭ZooKeeper期间不可用时导致服务器锁定的错误
-   删除恢复副本时过多的日志记录
-   修复了UNION ALL实现中的错误
-   修复了如果块中的第一列具有Array类型时在concat函数中发生的错误
-   进度信息保存在system.merges表

### ClickHouse Release 1.1.54289, 2017-09-13 {#clickhouse-release-1-1-54289-2017-09-13}

#### New Features: {#new-features-3}

-   `SYSTEM`服务管理查询: `SYSTEM RELOAD DICTIONARY`, `SYSTEM RELOAD DICTIONARIES`, `SYSTEM DROP DNS CACHE`, `SYSTEM SHUTDOWN`, `SYSTEM KILL`.
-   添加了处理数组的函数： `concat`, `arraySlice`, `arrayPushBack`, `arrayPushFront`, `arrayPopBack`, `arrayPopFront`
-   为ZooKeeper配置添加了`root`和`identity`参数。 这允许您隔离同一ZooKeeper集群上的各个用户
-   添加聚合函数`groupBitAnd`, `groupBitOr`, and `groupBitXor` (为了兼容性，它们也可以使用名称`BIT_AND`, `BIT_OR`, `BIT_XOR`).
-   通过在文件系统中指定配置，可以从MySQL加载外部字典
-   外部字典可以通过SSL从MySQL加载(`ssl_cert`, `ssl_key`, `ssl_ca`参数).
-   添加了`max_network_bandwidth_for_user`设置以限制每个用户查询的整体带宽使用
-   支持临时表的`DROP TABLE`
-   支持从`CSV`和`JSONEachRow`格式读取Unix时间戳格式的`DateTime`值
-   默认排除分布式查询中的滞后副本（默认阈值为5分钟）
-   在ALTER期间使用FIFO锁定：对于连续运行的查询，ALTER查询不会无限期地阻塞
-   在配置文件中设置`umask`
-   提高`DISTINCT`查询的性能

#### Bug Fixes: {#bug-fixes-3}

-   改进了在ZooKeeper中删除旧节点的过程。以前，如果插入非常频繁，旧节点有时不会被删除，这会导致服务器关闭缓慢等
-   修复了ZooKeeper连接选择主机时的随机化问题
-   如果副本是本地主机，修复了在分布式查询中排除滞后副本的问题
-   修复了在`Nested`结构中的元素上运行`ALTER MODIFY`后，`ReplicatedMergeTree`表中的数据部分可能被破坏的错误
-   修复了可能导致SELECT查询hang的错误
-   优化改进分布式查询DDL
-   修复`CREATE TABLE ... AS <materialized view>`
-   解决了对`Buffer`表的`ALTER ... CLEAR COLUMN IN PARTITION`查询中的死锁
-   修复了使用`JSONEachRow`和`TSKV`格式时`Enum`的无效默认值（0不是最小值）
-   解决了使用带有`executable`源的字典时出现僵尸进程的问题
-   修复了HEAD查询错误

#### Improved Workflow for Developing and Assembling ClickHouse: {#improved-workflow-for-developing-and-assembling-clickhouse}

-   您可以使用`pbuilder`构建 ClickHouse.
-   您可以使用`libc++`代替`libstdc++`在Linux上进行构建
-   新增静态代码分析工具使用说明: `Coverage`, `clang-tidy`, `cppcheck`.

#### Please Note When Upgrading: {#please-note-when-upgrading}

-   MergeTree设置`max_bytes_to_merge_at_max_space_in_pool`（要合并的数据部分的最大总大小，以字节为单位）现在有更高的默认值：它已从100 GiB增加到150 GiB。这可能会导致在服务器升级后运行大型合并，从而导致磁盘子系统负载增加。如果服务器上的可用空间小于正在运行的合并总量的两倍，这将导致所有其他合并停止运行，包括小数据部分的合并。因此，INSERT查询将失败并显示消息Merges are processing significantly slower than inserts,使用`SELECT * FROM system.merges`查询来监控情况。您还可以在`system.metrics`表或Graphite中检查`DiskSpaceReservedForMerge`指标。您不需要做任何事情来解决这个问题，因为一旦大型合并完成，问题就会自行解决。如果您发现这不可接受，您可以恢复`max_bytes_to_merge_at_max_space_in_pool`设置的先前值。为此，请转到config.xml中的 `<merge_tree>` 部分，设置 ```<merge_tree>``<max_bytes_to_merge_at_max_space_in_pool>107374182400</max_bytes_to_merge_at_max_space_in_pool>``` 并重新启动服务器。

### ClickHouse Release 1.1.54284, 2017-08-29 {#clickhouse-release-1-1-54284-2017-08-29}

-   这是先前1.1.54282版本的错误修复版本。修复了ZooKeeper中部件目录中的泄漏

### ClickHouse Release 1.1.54282, 2017-08-23 {#clickhouse-release-1-1-54282-2017-08-23}

此版本包含先前版本 1.1.54276 的错误修复:

-   修复了插入Distributed表时的`DB::Exception: Assertion violation: !_path.empty()`错误
-   修复当输入数据以`;`开头时插入RowBinary格式时的解析
-   修复某些聚合函数（例如`groupArray()`）的运行时编译期间出错

### ClickHouse Release 1.1.54276, 2017-08-16 {#clickhouse-release-1-1-54276-2017-08-16}

#### New Features: {#new-features-4}

-   为SELECT查询添加了一个可选的WITH部分。示例查询：`WITH 1+1 AS a SELECT a, a*a`
-   INSERT可以在Distributed表中同步执行：只有在所有数据都保存在所有分片上后才返回OK。通过设置`insert_distributed_sync=1`激活
-   添加了用于处理16字节标识符的UUID数据类型
-   添加了CHAR、FLOAT和其他类型的别名以与Tableau兼容
-   增加了`toYYYYMM`、`toYYYYMMDD`、`toYYYYMMDDhhmmss`的时间转换功能
-   您可以使用 IP 地址（与主机名一起）来识别集群DDL查询的服务器
-   在函数`substring(str, pos, len)`中添加了对非常量参数和负偏移量的支持
-   `groupArray(max_size)(column)`聚合函数增加了max_size参数，并优化了其性能

#### Main Changes: {#main-changes}

-   安全改进：所有服务器文件都使用0640权限创建（可以通过`<umask>`配置参数进行更改）
-   改进了语法无效查询的错误消息
-   合并大段MergeTree数据时显着减少内存消耗并提高性能
-   提高了ReplacingMergeTree引擎的数据合并性能
-   通过组合多个源插入，提高了从分布式表进行异步插入的性能。要启用此功能，请使用设置`distributed_directory_monitor_batch_inserts=1`

#### Backward Incompatible Changes: {#backward-incompatible-changes-1}

-   更改了数组的`groupArray(array_column)`函数聚合状态的二进制格式

#### Complete List of Changes: {#complete-list-of-changes}

-   添加了`output_format_json_quote_denormals`设置，允许以JSON格式输出nan和inf值
-   从Distributed表读取时优化流分配
-   如果值不变，则可以在只读模式下配置设置
-   添加了检索MergeTree引擎的非整数粒度的功能，以满足对`preferred_block_size_bytes`设置中指定的块大小的限制。目的是在处理来自具有大列的表的查询时减少RAM的消耗并增加缓存局部性
-   使用包含如`toStartOfHour(x)`之类的表达式的索引来处理如`toStartOfHour(x) op сonstexpr`之类的条件
-   添加了MergeTree引擎的新设置（config.xml中的merge_tree部分):
    -   `replicated_deduplication_window_seconds` 设置允许对Replicated表中的插入进行重复数据删除的秒数
    -   `cleanup_delay_period`设置启动清理以删除过时数据的频率
    -   `replicated_can_become_leader`可以防止副本成为leader（并分配合并）
-   加速清理ZooKeeper中删除过时的数据
-   集群DDL查询的多项改进和修复。新增加`distributed_ddl_task_timeout`设置，它限制了等待集群中服务器响应的时间。如果ddl请求尚未在所有主机上执行，则响应将包含超时错误，并且请求将以异步模式执行
-   改进了服务器日志中堆栈跟踪的显示
-   压缩方法添加了`none`值
-   支持在config.xml中使用多个dictionaries_config
-   可以通过文件系统中的套接字连接到MySQL
-   system.parts表添加新列，其中包含有关标记大小的信息（以字节为单位）

#### Bug Fixes: {#bug-fixes-4}

-   支持使用Merge表的分布式可以带有`_table`字段条件的SELECT查询
-   修复了检查数据部分时ReplicatedMergeTree中罕见的竞争条件
-   修复了启动服务器时`leader election`可能会冻结的问题
-   修复使用数据源的本地副本时，忽略了`max_replica_delay_for_distributed_queries`设置
-   修复了尝试清理不存在的列时`ALTER TABLE CLEAR COLUMN IN PARTITION`的错误行为
-   修复了使用空数组或字符串时multiIf函数异常问题
-   修复了反序列化本地格式时内存分配过多的问题
-   修复了Trie字典的不正确自动更新
-   修复了在使用SAMPLE时从Merge表中使用GROUP BY子句运行查询时异常问题
-   修复了使用 GROUP BY 时崩溃问题
-   修复了使用distributed_aggregation_memory_efficient=1时GROUP BY崩溃问题
-   支持在IN和JOIN的指定database.table
-   解决了并行聚合的线程太多问题
-   修复了`if`函数处理FixedString参数
-   修复SELECT在权重为0的分片的分布式表中工作问题
-   支持运行`CREATE VIEW IF EXISTS no longer causes crashes.`
-   修复了当输入input_format_skip_unknown_fields=1有负数时的错误行为
-   修复了`dictGetHierarchy()`函数中的无限循环（如果字典中存在无效数据）
-   修复使用IN或JOIN子句和合并表中的子查询运行分布式查询时出现`Syntax error: unexpected (...)`错误
-   修复了字典表中SELECT查询的错误描述
-   修复了在包含超过20亿个元素的IN和JOIN子句中使用数组时出现的“Cannot mremap”错误
-   修复了以MySQL为源的字典的故障转移

#### Improved Workflow for Developing and Assembling ClickHouse: {#improved-workflow-for-developing-and-assembling-clickhouse-1}

-   支持在Arcadia上构建
-   可以使用gcc7编译ClickHouse
-   使用ccache+distcc的并行构建更快了

### ClickHouse Release 1.1.54245, 2017-07-04 {#clickhouse-release-1-1-54245-2017-07-04}

#### New Features: {#new-features-5}

-   分布式DDL（例如，`CREATE TABLE ON CLUSTER`）
-   Replicated表支持`ALTER TABLE CLEAR COLUMN IN PARTITION`查询
-   字典表的引擎（以表的形式访问字典数据）
-   字典数据库引擎（这种类型的数据库自动为所有连接的外部字典提供字典表）
-   可以通过向源发送请求来检查字典的更新状态
-   限定列名
-   使用双引号引用标识符
-   HTTP Session 会话接口
-   对于复制表的OPTIMIZE查询不仅可以在leader上运行,还可在其它节点运行

#### Backward Incompatible Changes: {#backward-incompatible-changes-2}

-   移除SET GLOBAL

#### Minor Changes: {#minor-changes}

-   触发警报之后，日志将打印完整的堆栈跟踪
-   在启动时放宽了对损坏/额外数据部分数量的验证（误报太多）

#### Bug Fixes: {#bug-fixes-5}

-   修复了插入分布式表时出现的连接“sticking”问题
-   GLOBAL IN现在适用于查看分布式表的合并表查询
-   在Google计算引擎虚拟机上检测到不正确的内核数。这个问题已经解决了
-   改变缓存的外部字典的可执行源的工作方式
-   修复了包含空字符的字符串的比较问题
-   修复了Float32主键字段与常量的比较问题
-   对字段大小的错误估计可能会导致过大的分配
-   修复了使用ALTER查询添加到表中的可为null的列时发生的崩溃
-   修复了为空的列排序时，如果行数小于限制，出现的崩溃问题
-   修复了仅由常量值组成的ORDER BY子查询
-   删除表失败后，复制表可能会保持无效状态问题
-   带有空结果的标量子查询的别名不再丢失
-   如果.so文件被损坏，使用编译的查询不会因错误而失败
