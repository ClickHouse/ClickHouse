



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="./assets/images/favicon.ico">
      <meta name="generator" content="mkdocs-0.17.3, mkdocs-material-2.2.1">
    
    
      
        <title>ClickHouse Documentation</title>
      
    
    
      <link rel="stylesheet" href="./assets/stylesheets/application.ac64251e.css">
      
        <link rel="stylesheet" href="./assets/stylesheets/application-palette.792431c1.css">
      
    
    
      <script src="./assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="./assets/stylesheets/custom.css">
    
    
  </head>
  
    
    
    
      <body data-md-color-primary="white" data-md-color-accent="white">
    
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">

  <!-- Yandex.Metrika counter -->
  <script type="text/javascript">
      (function (d, w, c) {
          (w[c] = w[c] || []).push(function() {
              try {
                  w.yaCounter18343495 = new Ya.Metrika2({
                      id:18343495,
                      clickmap:true,
                      trackLinks:true,
                      accurateTrackBounce:true,
                      webvisor: true
                  });
              } catch(e) { }
          });
          var n = d.getElementsByTagName("script")[0],
              s = d.createElement("script"),
              f = function () { n.parentNode.insertBefore(s, n); };
          s.type = "text/javascript";
          s.async = true;
          s.src = "https://mc.yandex.ru/metrika/tag.js";
          if (w.opera == "[object Opera]") {
              d.addEventListener("DOMContentLoaded", f, false);
          } else { f(); }
      })(document, window, "yandex_metrika_callbacks2");
  </script>
  <noscript>
      <div><img src="https://mc.yandex.ru/watch/18343495" style="position:absolute; left:-9999px;" alt=""/></div>
  </noscript>
  <!-- /Yandex.Metrika counter -->

  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="/" title="ClickHouse Documentation" class="md-header-nav__button md-logo">
          
            <img src="./images/logo.svg" width="40" height="40">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                ClickHouse Documentation
              </span>
              <span class="md-header-nav__topic">
                Documentation
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <script type="text/javascript">
                if (window.location.pathname.indexOf('/ru/') >= 0) {
                  url = window.location.pathname.replace('/ru/', '/en/');
                  text = "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"50\" height=\"30\" viewBox=\"0,0 25,15\" style=\"border:1px solid #eee;margin: .8rem 0 0 -1.25rem;\">\n" +
                      "<rect width=\"25\" height=\"15\" fill=\"#00247d\"></rect>\n" +
                      "<path d=\"M 0,0 L 25,15 M 25,0 L 0,15\" stroke=\"#fff\" stroke-width=\"3\"></path>\n" +
                      "<path d=\"M 12.5,0 V 15 M 0,7.5 H 25\" stroke=\"#fff\" stroke-width=\"5\"></path>\n" +
                      "<path d=\"M 12.5,0 V 15 M 0,7.5 H 25\" stroke=\"#cf142b\" stroke-width=\"3\"></path>\n" +
                      "</svg>";
                  title = "Switch to English"
                }else{
                  url = window.location.pathname.replace('/en/', '/ru/');
                  text = "<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 10 6\" width=\"50\" height=\"30\" style=\"border: 1px solid #eee;margin: .8rem 0 0 -1.25rem\">\n" +
                      "<rect fill=\"#fff\" width=\"10\" height=\"3\"></rect>\n" +
                      "<rect fill=\"#d52b1e\" y=\"3\" width=\"10\" height=\"3\"></rect>\n" +
                      "<rect fill=\"#0039a6\" y=\"2\" width=\"10\" height=\"2\"></rect>\n" +
                      "</svg>";
                  title = "Переключить на русский язык"
               }
               document.write('<a href="' + url + '" title="' + title + '" class="md-flex__ellipsis md-header-nav__title">' + text + '</a>')
             </script>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    ClickHouse Documentation
  </label>

  <ul class="md-nav__list" data-md-scrollfix>
    <li class="md-nav__item md-nav__item--active">
      <script type="text/javascript">
        if (window.location.pathname.indexOf('/ru/') >= 0) {
          if (window.location.pathname.indexOf('/single/') >= 0) {
            document.write("<a href=\"./../\" class=\"md-nav__link md-nav__link--active\">Многостраничная версия</a>")
          } else {
            document.write("<a href=\"./single/\" class=\"md-nav__link md-nav__link--active\">Одностраничная версия</a>")
          }
        }else{
          if (window.location.pathname.indexOf('/single/') >= 0) {
            document.write("<a href=\"./../\" class=\"md-nav__link md-nav__link--active\">Multi page version</a>")
          }else{
            document.write("<a href=\"./single/\" class=\"md-nav__link md-nav__link--active\">Single page version</a>")
          }
        }
     </script>
    </li>
    <li class="md-nav__item md-nav__item--active">
      <a href="https://github.com/yandex/ClickHouse/" rel="external nofollow" target="_blank" class="md-nav__link">
        <script type="text/javascript">
        if (window.location.pathname.indexOf('/ru/') >= 0) {
          document.write('Исходники ClickHouse');
        } else {
          document.write('ClickHouse sources');
        }
     </script>
      </a>
    </li>
  </ul>

  
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" title="Introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#distinctive-features-of-clickhouse" title="Distinctive features of ClickHouse" class="md-nav__link">
    Distinctive features of ClickHouse
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#true-column-oriented-dbms" title="True column-oriented DBMS" class="md-nav__link">
    True column-oriented DBMS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-compression" title="Data compression" class="md-nav__link">
    Data compression
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disk-storage-of-data" title="Disk storage of data" class="md-nav__link">
    Disk storage of data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parallel-processing-on-multiple-cores" title="Parallel processing on multiple cores" class="md-nav__link">
    Parallel processing on multiple cores
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#distributed-processing-on-multiple-servers" title="Distributed processing on multiple servers" class="md-nav__link">
    Distributed processing on multiple servers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sql-support" title="SQL support" class="md-nav__link">
    SQL support
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vector-engine" title="Vector engine" class="md-nav__link">
    Vector engine
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#real-time-data-updates" title="Real-time data updates" class="md-nav__link">
    Real-time data updates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#indexes" title="Indexes" class="md-nav__link">
    Indexes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#suitable-for-online-queries" title="Suitable for online queries" class="md-nav__link">
    Suitable for online queries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#support-for-approximated-calculations" title="Support for approximated calculations" class="md-nav__link">
    Support for approximated calculations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-replication-and-support-for-data-integrity-on-replicas" title="Data replication and support for data integrity on replicas" class="md-nav__link">
    Data replication and support for data integrity on replicas
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clickhouse-features-that-can-be-considered-disadvantages" title="ClickHouse features that can be considered disadvantages" class="md-nav__link">
    ClickHouse features that can be considered disadvantages
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#yandexmetrica-use-case" title="Yandex.Metrica use case" class="md-nav__link">
    Yandex.Metrica use case
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#usage-in-yandexmetrica-and-other-yandex-services" title="Usage in Yandex.Metrica and other Yandex services" class="md-nav__link">
    Usage in Yandex.Metrica and other Yandex services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregated-and-non-aggregated-data" title="Aggregated and non-aggregated data" class="md-nav__link">
    Aggregated and non-aggregated data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#questions-you-were-afraid-to-ask" title="Questions you were afraid to ask" class="md-nav__link">
    Questions you were afraid to ask
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-not-use-something-like-mapreduce" title="Why not use something like MapReduce?" class="md-nav__link">
    Why not use something like MapReduce?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance" title="Performance" class="md-nav__link">
    Performance
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#throughput-for-a-single-large-query" title="Throughput for a single large query" class="md-nav__link">
    Throughput for a single large query
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#latency-when-processing-short-queries" title="Latency when processing short queries" class="md-nav__link">
    Latency when processing short queries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#throughput-when-processing-a-large-quantity-of-short-queries" title="Throughput when processing a large quantity of short queries" class="md-nav__link">
    Throughput when processing a large quantity of short queries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-when-inserting-data" title="Performance when inserting data" class="md-nav__link">
    Performance when inserting data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" title="Getting started" class="md-nav__link">
    Getting started
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#system-requirements" title="System requirements" class="md-nav__link">
    System requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installation" title="Installation" class="md-nav__link">
    Installation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing-from-packages-for-debianubuntu" title="Installing from packages for Debian/Ubuntu" class="md-nav__link">
    Installing from packages for Debian/Ubuntu
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-from-sources" title="Installing from sources" class="md-nav__link">
    Installing from sources
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-installation-methods" title="Other installation methods" class="md-nav__link">
    Other installation methods
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#launch" title="Launch" class="md-nav__link">
    Launch
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ontime" title="OnTime" class="md-nav__link">
    OnTime
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#new-york-taxi-data" title="New York Taxi data" class="md-nav__link">
    New York Taxi data
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-to-import-the-raw-data" title="How to import the raw data" class="md-nav__link">
    How to import the raw data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#results-on-single-server" title="Results on single server" class="md-nav__link">
    Results on single server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary" title="Summary" class="md-nav__link">
    Summary
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#amplab-big-data-benchmark" title="AMPLab Big Data Benchmark" class="md-nav__link">
    AMPLab Big Data Benchmark
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wikistat" title="WikiStat" class="md-nav__link">
    WikiStat
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terabyte-of-click-logs-from-criteo" title="Terabyte of click logs from Criteo" class="md-nav__link">
    Terabyte of click logs from Criteo
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#star-schema-benchmark" title="Star Schema Benchmark" class="md-nav__link">
    Star Schema Benchmark
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interfaces" title="Interfaces" class="md-nav__link">
    Interfaces
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#command-line-client" title="Command-line client" class="md-nav__link">
    Command-line client
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#usage" title="Usage" class="md-nav__link">
    Usage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuring" title="Configuring" class="md-nav__link">
    Configuring
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#command-line-options" title="Command line options" class="md-nav__link">
    Command line options
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-files" title="Configuration files" class="md-nav__link">
    Configuration files
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#http-interface" title="HTTP interface" class="md-nav__link">
    HTTP interface
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#response-buffering" title="Response buffering" class="md-nav__link">
    Response buffering
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jdbc-driver" title="JDBC driver" class="md-nav__link">
    JDBC driver
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#native-interface-tcp" title="Native interface (TCP)" class="md-nav__link">
    Native interface (TCP)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#libraries-from-third-party-developers" title="Libraries from third-party developers" class="md-nav__link">
    Libraries from third-party developers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#visual-interfaces-from-third-party-developers" title="Visual interfaces from third-party developers" class="md-nav__link">
    Visual interfaces from third-party developers
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tabix" title="Tabix" class="md-nav__link">
    Tabix
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#features" title="Features:" class="md-nav__link">
    Features:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#houseops" title="HouseOps" class="md-nav__link">
    HouseOps
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#features_1" title="Features:" class="md-nav__link">
    Features:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#query-language" title="Query language" class="md-nav__link">
    Query language
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#queries" title="Queries" class="md-nav__link">
    Queries
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-database" title="CREATE DATABASE" class="md-nav__link">
    CREATE DATABASE
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-table" title="CREATE TABLE" class="md-nav__link">
    CREATE TABLE
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#default-values" title="Default values" class="md-nav__link">
    Default values
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#temporary-tables" title="Temporary tables" class="md-nav__link">
    Temporary tables
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#distributed-ddl-queries-on-cluster-clause" title="Distributed DDL queries (ON CLUSTER clause)" class="md-nav__link">
    Distributed DDL queries (ON CLUSTER clause)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-view" title="CREATE VIEW" class="md-nav__link">
    CREATE VIEW
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attach" title="ATTACH" class="md-nav__link">
    ATTACH
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#drop" title="DROP" class="md-nav__link">
    DROP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detach" title="DETACH" class="md-nav__link">
    DETACH
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rename" title="RENAME" class="md-nav__link">
    RENAME
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alter" title="ALTER" class="md-nav__link">
    ALTER
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#column-manipulations" title="Column manipulations" class="md-nav__link">
    Column manipulations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manipulations-with-partitions-and-parts" title="Manipulations with partitions and parts" class="md-nav__link">
    Manipulations with partitions and parts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backups-and-replication" title="Backups and replication" class="md-nav__link">
    Backups and replication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#synchronicity-of-alter-queries" title="Synchronicity of ALTER queries" class="md-nav__link">
    Synchronicity of ALTER queries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#show-databases" title="SHOW DATABASES" class="md-nav__link">
    SHOW DATABASES
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#show-tables" title="SHOW TABLES" class="md-nav__link">
    SHOW TABLES
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#show-processlist" title="SHOW PROCESSLIST" class="md-nav__link">
    SHOW PROCESSLIST
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#show-create-table" title="SHOW CREATE TABLE" class="md-nav__link">
    SHOW CREATE TABLE
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#describe-table" title="DESCRIBE TABLE" class="md-nav__link">
    DESCRIBE TABLE
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exists" title="EXISTS" class="md-nav__link">
    EXISTS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use" title="USE" class="md-nav__link">
    USE
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set" title="SET" class="md-nav__link">
    SET
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimize" title="OPTIMIZE" class="md-nav__link">
    OPTIMIZE
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insert" title="INSERT" class="md-nav__link">
    INSERT
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#inserting-the-results-of-select" title="Inserting the results of SELECT" class="md-nav__link">
    Inserting the results of SELECT
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-considerations" title="Performance considerations" class="md-nav__link">
    Performance considerations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#select" title="SELECT" class="md-nav__link">
    SELECT
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#from-clause" title="FROM clause" class="md-nav__link">
    FROM clause
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sample-clause" title="SAMPLE clause" class="md-nav__link">
    SAMPLE clause
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#array-join-clause" title="ARRAY JOIN clause" class="md-nav__link">
    ARRAY JOIN clause
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#join-clause" title="JOIN clause" class="md-nav__link">
    JOIN clause
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#where-clause" title="WHERE clause" class="md-nav__link">
    WHERE clause
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prewhere-clause" title="PREWHERE clause" class="md-nav__link">
    PREWHERE clause
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#group-by-clause" title="GROUP BY clause" class="md-nav__link">
    GROUP BY clause
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#with-totals-modifier" title="WITH TOTALS modifier" class="md-nav__link">
    WITH TOTALS modifier
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#group-by-in-external-memory" title="GROUP BY in external memory" class="md-nav__link">
    GROUP BY in external memory
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limit-n-by-clause" title="LIMIT N BY clause" class="md-nav__link">
    LIMIT N BY clause
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#having-clause" title="HAVING clause" class="md-nav__link">
    HAVING clause
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#order-by-clause" title="ORDER BY clause" class="md-nav__link">
    ORDER BY clause
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#select-clause" title="SELECT clause" class="md-nav__link">
    SELECT clause
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#distinct-clause" title="DISTINCT clause" class="md-nav__link">
    DISTINCT clause
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limit-clause" title="LIMIT clause" class="md-nav__link">
    LIMIT clause
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#union-all-clause" title="UNION ALL clause" class="md-nav__link">
    UNION ALL clause
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#into-outfile-clause" title="INTO OUTFILE clause" class="md-nav__link">
    INTO OUTFILE clause
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#format-clause" title="FORMAT clause" class="md-nav__link">
    FORMAT clause
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#in-operators" title="IN operators" class="md-nav__link">
    IN operators
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#distributed-subqueries" title="Distributed subqueries" class="md-nav__link">
    Distributed subqueries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extreme-values" title="Extreme values" class="md-nav__link">
    Extreme values
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notes" title="Notes" class="md-nav__link">
    Notes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kill-query" title="KILL QUERY" class="md-nav__link">
    KILL QUERY
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#syntax" title="Syntax" class="md-nav__link">
    Syntax
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spaces" title="Spaces" class="md-nav__link">
    Spaces
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comments" title="Comments" class="md-nav__link">
    Comments
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#keywords" title="Keywords" class="md-nav__link">
    Keywords
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#identifiers" title="Identifiers" class="md-nav__link">
    Identifiers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#literals" title="Literals" class="md-nav__link">
    Literals
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#numeric-literals" title="Numeric literals" class="md-nav__link">
    Numeric literals
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#string-literals" title="String literals" class="md-nav__link">
    String literals
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compound-literals" title="Compound literals" class="md-nav__link">
    Compound literals
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions" title="Functions" class="md-nav__link">
    Functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operators" title="Operators" class="md-nav__link">
    Operators
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-types-and-database-table-engines" title="Data types and database table engines" class="md-nav__link">
    Data types and database table engines
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#synonyms" title="Synonyms" class="md-nav__link">
    Synonyms
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asterisk" title="Asterisk" class="md-nav__link">
    Asterisk
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expressions" title="Expressions" class="md-nav__link">
    Expressions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#table-engines" title="Table engines" class="md-nav__link">
    Table engines
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tinylog" title="TinyLog" class="md-nav__link">
    TinyLog
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#log" title="Log" class="md-nav__link">
    Log
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory" title="Memory" class="md-nav__link">
    Memory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mergetree" title="MergeTree" class="md-nav__link">
    MergeTree
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#custom-partitioning-key" title="Custom partitioning key" class="md-nav__link">
    Custom partitioning key
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#replacingmergetree" title="ReplacingMergeTree" class="md-nav__link">
    ReplacingMergeTree
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summingmergetree" title="SummingMergeTree" class="md-nav__link">
    SummingMergeTree
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregatingmergetree" title="AggregatingMergeTree" class="md-nav__link">
    AggregatingMergeTree
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#collapsingmergetree" title="CollapsingMergeTree" class="md-nav__link">
    CollapsingMergeTree
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#graphitemergetree" title="GraphiteMergeTree" class="md-nav__link">
    GraphiteMergeTree
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-the-engine" title="Using the engine" class="md-nav__link">
    Using the engine
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-replication" title="Data replication" class="md-nav__link">
    Data replication
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-replicated-tables" title="Creating replicated tables" class="md-nav__link">
    Creating replicated tables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recovery-after-failures" title="Recovery after failures" class="md-nav__link">
    Recovery after failures
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recovery-after-complete-data-loss" title="Recovery after complete data loss" class="md-nav__link">
    Recovery after complete data loss
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#converting-from-mergetree-to-replicatedmergetree" title="Converting from MergeTree to ReplicatedMergeTree" class="md-nav__link">
    Converting from MergeTree to ReplicatedMergeTree
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#converting-from-replicatedmergetree-to-mergetree" title="Converting from ReplicatedMergeTree to MergeTree" class="md-nav__link">
    Converting from ReplicatedMergeTree to MergeTree
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recovery-when-metadata-in-the-zookeeper-cluster-is-lost-or-damaged" title="Recovery when metadata in the ZooKeeper cluster is lost or damaged" class="md-nav__link">
    Recovery when metadata in the ZooKeeper cluster is lost or damaged
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#distributed" title="Distributed" class="md-nav__link">
    Distributed
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dictionary" title="Dictionary" class="md-nav__link">
    Dictionary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#merge" title="Merge" class="md-nav__link">
    Merge
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#virtual-columns" title="Virtual columns" class="md-nav__link">
    Virtual columns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#buffer" title="Buffer" class="md-nav__link">
    Buffer
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fileinputformat" title="File(InputFormat)" class="md-nav__link">
    File(InputFormat)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#null" title="Null" class="md-nav__link">
    Null
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set_1" title="Set" class="md-nav__link">
    Set
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#join" title="Join" class="md-nav__link">
    Join
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#view" title="View" class="md-nav__link">
    View
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#materializedview" title="MaterializedView" class="md-nav__link">
    MaterializedView
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kafka" title="Kafka" class="md-nav__link">
    Kafka
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuration" title="Configuration" class="md-nav__link">
    Configuration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mysql" title="MySQL" class="md-nav__link">
    MySQL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#external-data-for-query-processing" title="External data for query processing" class="md-nav__link">
    External data for query processing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#system-tables" title="System tables" class="md-nav__link">
    System tables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemone" title="system.one" class="md-nav__link">
    system.one
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemnumbers" title="system.numbers" class="md-nav__link">
    system.numbers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemnumbers_mt" title="system.numbers_mt" class="md-nav__link">
    system.numbers_mt
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemdatabases" title="system.databases" class="md-nav__link">
    system.databases
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemtables" title="system.tables" class="md-nav__link">
    system.tables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemcolumns" title="system.columns" class="md-nav__link">
    system.columns
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemparts" title="system.parts" class="md-nav__link">
    system.parts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemprocesses" title="system.processes" class="md-nav__link">
    system.processes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemmerges" title="system.merges" class="md-nav__link">
    system.merges
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemevents" title="system.events" class="md-nav__link">
    system.events
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemmetrics" title="system.metrics" class="md-nav__link">
    system.metrics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemasynchronous_metrics" title="system.asynchronous_metrics" class="md-nav__link">
    system.asynchronous_metrics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemreplicas" title="system.replicas" class="md-nav__link">
    system.replicas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemdictionaries" title="system.dictionaries" class="md-nav__link">
    system.dictionaries
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemclusters" title="system.clusters" class="md-nav__link">
    system.clusters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemfunctions" title="system.functions" class="md-nav__link">
    system.functions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemsettings" title="system.settings" class="md-nav__link">
    system.settings
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemzookeeper" title="system.zookeeper" class="md-nav__link">
    system.zookeeper
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#table-functions" title="Table functions" class="md-nav__link">
    Table functions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remote" title="remote" class="md-nav__link">
    remote
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#merge_1" title="merge" class="md-nav__link">
    merge
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#numbers" title="numbers" class="md-nav__link">
    numbers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#formats" title="Formats" class="md-nav__link">
    Formats
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tabseparated" title="TabSeparated" class="md-nav__link">
    TabSeparated
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tabseparatedraw" title="TabSeparatedRaw" class="md-nav__link">
    TabSeparatedRaw
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tabseparatedwithnames" title="TabSeparatedWithNames" class="md-nav__link">
    TabSeparatedWithNames
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tabseparatedwithnamesandtypes" title="TabSeparatedWithNamesAndTypes" class="md-nav__link">
    TabSeparatedWithNamesAndTypes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#csv" title="CSV" class="md-nav__link">
    CSV
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#csvwithnames" title="CSVWithNames" class="md-nav__link">
    CSVWithNames
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#values" title="Values" class="md-nav__link">
    Values
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vertical" title="Vertical" class="md-nav__link">
    Vertical
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verticalraw" title="VerticalRaw" class="md-nav__link">
    VerticalRaw
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#json" title="JSON" class="md-nav__link">
    JSON
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jsoncompact" title="JSONCompact" class="md-nav__link">
    JSONCompact
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jsoneachrow" title="JSONEachRow" class="md-nav__link">
    JSONEachRow
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tskv" title="TSKV" class="md-nav__link">
    TSKV
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pretty" title="Pretty" class="md-nav__link">
    Pretty
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prettycompact" title="PrettyCompact" class="md-nav__link">
    PrettyCompact
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prettycompactmonoblock" title="PrettyCompactMonoBlock" class="md-nav__link">
    PrettyCompactMonoBlock
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prettynoescapes" title="PrettyNoEscapes" class="md-nav__link">
    PrettyNoEscapes
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prettycompactnoescapes" title="PrettyCompactNoEscapes" class="md-nav__link">
    PrettyCompactNoEscapes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prettyspacenoescapes" title="PrettySpaceNoEscapes" class="md-nav__link">
    PrettySpaceNoEscapes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prettyspace" title="PrettySpace" class="md-nav__link">
    PrettySpace
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rowbinary" title="RowBinary" class="md-nav__link">
    RowBinary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#native" title="Native" class="md-nav__link">
    Native
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#null_1" title="Null" class="md-nav__link">
    Null
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#xml" title="XML" class="md-nav__link">
    XML
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capnproto" title="CapnProto" class="md-nav__link">
    CapnProto
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-types" title="Data types" class="md-nav__link">
    Data types
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uint8-uint16-uint32-uint64-int8-int16-int32-int64" title="UInt8, UInt16, UInt32, UInt64, Int8, Int16, Int32, Int64" class="md-nav__link">
    UInt8, UInt16, UInt32, UInt64, Int8, Int16, Int32, Int64
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#int-ranges" title="Int ranges" class="md-nav__link">
    Int ranges
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uint-ranges" title="Uint ranges" class="md-nav__link">
    Uint ranges
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#float32-float64" title="Float32, Float64" class="md-nav__link">
    Float32, Float64
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-floating-point-numbers" title="Using floating-point numbers" class="md-nav__link">
    Using floating-point numbers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nan-and-inf" title="NaN and Inf" class="md-nav__link">
    NaN and Inf
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#boolean-values" title="Boolean values" class="md-nav__link">
    Boolean values
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#string" title="String" class="md-nav__link">
    String
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#encodings" title="Encodings" class="md-nav__link">
    Encodings
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fixedstringn" title="FixedString(N)" class="md-nav__link">
    FixedString(N)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#date" title="Date" class="md-nav__link">
    Date
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datetime" title="DateTime" class="md-nav__link">
    DateTime
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#time-zones" title="Time zones" class="md-nav__link">
    Time zones
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enum" title="Enum" class="md-nav__link">
    Enum
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arrayt" title="Array(T)" class="md-nav__link">
    Array(T)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregatefunctionname-types_of_arguments" title="AggregateFunction(name, types_of_arguments...)" class="md-nav__link">
    AggregateFunction(name, types_of_arguments...)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tuplet1-t2" title="Tuple(T1, T2, ...)" class="md-nav__link">
    Tuple(T1, T2, ...)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nested-data-structures" title="Nested data structures" class="md-nav__link">
    Nested data structures
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nestedname1-type1-name2-type2" title="Nested(Name1 Type1, Name2 Type2, ...)" class="md-nav__link">
    Nested(Name1 Type1, Name2 Type2, ...)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#special-data-types" title="Special data types" class="md-nav__link">
    Special data types
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#expression" title="Expression" class="md-nav__link">
    Expression
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set_2" title="Set" class="md-nav__link">
    Set
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operators_1" title="Operators" class="md-nav__link">
    Operators
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#access-operators" title="Access operators" class="md-nav__link">
    Access operators
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#numeric-negation-operator" title="Numeric negation operator" class="md-nav__link">
    Numeric negation operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiplication-and-division-operators" title="Multiplication and division operators" class="md-nav__link">
    Multiplication and division operators
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#addition-and-subtraction-operators" title="Addition and subtraction operators" class="md-nav__link">
    Addition and subtraction operators
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comparison-operators" title="Comparison operators" class="md-nav__link">
    Comparison operators
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operators-for-working-with-data-sets" title="Operators for working with data sets" class="md-nav__link">
    Operators for working with data sets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logical-negation-operator" title="Logical negation operator" class="md-nav__link">
    Logical negation operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logical-and-operator" title="Logical AND operator" class="md-nav__link">
    Logical AND operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logical-or-operator" title="Logical OR operator" class="md-nav__link">
    Logical OR operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conditional-operator" title="Conditional operator" class="md-nav__link">
    Conditional operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conditional-expression" title="Conditional expression" class="md-nav__link">
    Conditional expression
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#concatenation-operator" title="Concatenation operator" class="md-nav__link">
    Concatenation operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lambda-creation-operator" title="Lambda creation operator" class="md-nav__link">
    Lambda creation operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#array-creation-operator" title="Array creation operator" class="md-nav__link">
    Array creation operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tuple-creation-operator" title="Tuple creation operator" class="md-nav__link">
    Tuple creation operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#associativity" title="Associativity" class="md-nav__link">
    Associativity
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions_1" title="Functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#strong-typing" title="Strong typing" class="md-nav__link">
    Strong typing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-subexpression-elimination" title="Common subexpression elimination" class="md-nav__link">
    Common subexpression elimination
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#types-of-results" title="Types of results" class="md-nav__link">
    Types of results
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constants" title="Constants" class="md-nav__link">
    Constants
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constancy" title="Constancy" class="md-nav__link">
    Constancy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling" title="Error handling" class="md-nav__link">
    Error handling
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation-of-argument-expressions" title="Evaluation of argument expressions" class="md-nav__link">
    Evaluation of argument expressions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performing-functions-for-distributed-query-processing" title="Performing functions for distributed query processing" class="md-nav__link">
    Performing functions for distributed query processing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arithmetic-functions" title="Arithmetic functions" class="md-nav__link">
    Arithmetic functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plusa-b-a-b-operator" title="plus(a, b), a + b operator" class="md-nav__link">
    plus(a, b), a + b operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minusa-b-a-b-operator" title="minus(a, b), a - b operator" class="md-nav__link">
    minus(a, b), a - b operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiplya-b-a-42-b-operator" title="multiply(a, b), a * b operator" class="md-nav__link">
    multiply(a, b), a * b operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dividea-b-a-b-operator" title="divide(a, b), a / b operator" class="md-nav__link">
    divide(a, b), a / b operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#intdiva-b" title="intDiv(a, b)" class="md-nav__link">
    intDiv(a, b)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#intdivorzeroa-b" title="intDivOrZero(a, b)" class="md-nav__link">
    intDivOrZero(a, b)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#moduloa-b-a-b-operator" title="modulo(a, b), a % b operator" class="md-nav__link">
    modulo(a, b), a % b operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#negatea-a-operator" title="negate(a), -a operator" class="md-nav__link">
    negate(a), -a operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#absa" title="abs(a)" class="md-nav__link">
    abs(a)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gcda-b" title="gcd(a, b)" class="md-nav__link">
    gcd(a, b)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lcma-b" title="lcm(a, b)" class="md-nav__link">
    lcm(a, b)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#comparison-functions" title="Comparison functions" class="md-nav__link">
    Comparison functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#equals-a-b-and-a-b-operator" title="equals, a = b and a == b operator" class="md-nav__link">
    equals, a = b and a == b operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notequals-a-operator-b-and-a-b" title="notEquals, a ! operator= b and a &lt;&gt; b" class="md-nav__link">
    notEquals, a ! operator= b and a &lt;&gt; b
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#less-operator" title="less, &lt; operator" class="md-nav__link">
    less, &lt; operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#greater-operator" title="greater, &gt; operator" class="md-nav__link">
    greater, &gt; operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lessorequals-operator" title="lessOrEquals, &lt;= operator" class="md-nav__link">
    lessOrEquals, &lt;= operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#greaterorequals-operator" title="greaterOrEquals, &gt;= operator" class="md-nav__link">
    greaterOrEquals, &gt;= operator
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logical-functions" title="Logical functions" class="md-nav__link">
    Logical functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#and-and-operator" title="and, AND operator" class="md-nav__link">
    and, AND operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#or-or-operator" title="or, OR operator" class="md-nav__link">
    or, OR operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#not-not-operator" title="not, NOT operator" class="md-nav__link">
    not, NOT operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xor" title="xor" class="md-nav__link">
    xor
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#type-conversion-functions" title="Type conversion functions" class="md-nav__link">
    Type conversion functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#touint8-touint16-touint32-touint64" title="toUInt8, toUInt16, toUInt32, toUInt64" class="md-nav__link">
    toUInt8, toUInt16, toUInt32, toUInt64
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toint8-toint16-toint32-toint64" title="toInt8, toInt16, toInt32, toInt64" class="md-nav__link">
    toInt8, toInt16, toInt32, toInt64
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tofloat32-tofloat64" title="toFloat32, toFloat64" class="md-nav__link">
    toFloat32, toFloat64
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#touint8orzero-touint16orzero-touint32orzero-touint64orzero-toint8orzero-toint16orzero-toint32orzero-toint64orzero-tofloat32orzero-tofloat64orzero" title="toUInt8OrZero, toUInt16OrZero, toUInt32OrZero, toUInt64OrZero, toInt8OrZero, toInt16OrZero, toInt32OrZero, toInt64OrZero, toFloat32OrZero, toFloat64OrZero" class="md-nav__link">
    toUInt8OrZero, toUInt16OrZero, toUInt32OrZero, toUInt64OrZero, toInt8OrZero, toInt16OrZero, toInt32OrZero, toInt64OrZero, toFloat32OrZero, toFloat64OrZero
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#todate-todatetime" title="toDate, toDateTime" class="md-nav__link">
    toDate, toDateTime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tostring" title="toString" class="md-nav__link">
    toString
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tofixedstrings-n" title="toFixedString(s, N)" class="md-nav__link">
    toFixedString(s, N)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tostringcuttozeros" title="toStringCutToZero(s)" class="md-nav__link">
    toStringCutToZero(s)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reinterpretasuint8-reinterpretasuint16-reinterpretasuint32-reinterpretasuint64" title="reinterpretAsUInt8, reinterpretAsUInt16, reinterpretAsUInt32, reinterpretAsUInt64" class="md-nav__link">
    reinterpretAsUInt8, reinterpretAsUInt16, reinterpretAsUInt32, reinterpretAsUInt64
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reinterpretasint8-reinterpretasint16-reinterpretasint32-reinterpretasint64" title="reinterpretAsInt8, reinterpretAsInt16, reinterpretAsInt32, reinterpretAsInt64" class="md-nav__link">
    reinterpretAsInt8, reinterpretAsInt16, reinterpretAsInt32, reinterpretAsInt64
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reinterpretasfloat32-reinterpretasfloat64" title="reinterpretAsFloat32, reinterpretAsFloat64" class="md-nav__link">
    reinterpretAsFloat32, reinterpretAsFloat64
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reinterpretasdate-reinterpretasdatetime" title="reinterpretAsDate, reinterpretAsDateTime" class="md-nav__link">
    reinterpretAsDate, reinterpretAsDateTime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reinterpretasstring" title="reinterpretAsString" class="md-nav__link">
    reinterpretAsString
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#castx-t" title="CAST(x, t)" class="md-nav__link">
    CAST(x, t)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions-for-working-with-dates-and-times" title="Functions for working with dates and times" class="md-nav__link">
    Functions for working with dates and times
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toyear" title="toYear" class="md-nav__link">
    toYear
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tomonth" title="toMonth" class="md-nav__link">
    toMonth
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#todayofmonth" title="toDayOfMonth" class="md-nav__link">
    toDayOfMonth
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#todayofweek" title="toDayOfWeek" class="md-nav__link">
    toDayOfWeek
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tohour" title="toHour" class="md-nav__link">
    toHour
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tominute" title="toMinute" class="md-nav__link">
    toMinute
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tosecond" title="toSecond" class="md-nav__link">
    toSecond
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tomonday" title="toMonday" class="md-nav__link">
    toMonday
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tostartofmonth" title="toStartOfMonth" class="md-nav__link">
    toStartOfMonth
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tostartofquarter" title="toStartOfQuarter" class="md-nav__link">
    toStartOfQuarter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tostartofyear" title="toStartOfYear" class="md-nav__link">
    toStartOfYear
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tostartofminute" title="toStartOfMinute" class="md-nav__link">
    toStartOfMinute
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tostartoffiveminute" title="toStartOfFiveMinute" class="md-nav__link">
    toStartOfFiveMinute
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tostartoffifteenminutes" title="toStartOfFifteenMinutes" class="md-nav__link">
    toStartOfFifteenMinutes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tostartofhour" title="toStartOfHour" class="md-nav__link">
    toStartOfHour
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tostartofday" title="toStartOfDay" class="md-nav__link">
    toStartOfDay
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#totime" title="toTime" class="md-nav__link">
    toTime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torelativeyearnum" title="toRelativeYearNum" class="md-nav__link">
    toRelativeYearNum
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torelativemonthnum" title="toRelativeMonthNum" class="md-nav__link">
    toRelativeMonthNum
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torelativeweeknum" title="toRelativeWeekNum" class="md-nav__link">
    toRelativeWeekNum
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torelativedaynum" title="toRelativeDayNum" class="md-nav__link">
    toRelativeDayNum
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torelativehournum" title="toRelativeHourNum" class="md-nav__link">
    toRelativeHourNum
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torelativeminutenum" title="toRelativeMinuteNum" class="md-nav__link">
    toRelativeMinuteNum
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torelativesecondnum" title="toRelativeSecondNum" class="md-nav__link">
    toRelativeSecondNum
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#now" title="now" class="md-nav__link">
    now
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#today" title="today" class="md-nav__link">
    today
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#yesterday" title="yesterday" class="md-nav__link">
    yesterday
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timeslot" title="timeSlot" class="md-nav__link">
    timeSlot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timeslotsstarttime-duration" title="timeSlots(StartTime, Duration)" class="md-nav__link">
    timeSlots(StartTime, Duration)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions-for-working-with-strings" title="Functions for working with strings" class="md-nav__link">
    Functions for working with strings
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#empty" title="empty" class="md-nav__link">
    empty
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notempty" title="notEmpty" class="md-nav__link">
    notEmpty
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#length" title="length" class="md-nav__link">
    length
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lengthutf8" title="lengthUTF8" class="md-nav__link">
    lengthUTF8
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lower" title="lower" class="md-nav__link">
    lower
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upper" title="upper" class="md-nav__link">
    upper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lowerutf8" title="lowerUTF8" class="md-nav__link">
    lowerUTF8
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upperutf8" title="upperUTF8" class="md-nav__link">
    upperUTF8
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reverse" title="reverse" class="md-nav__link">
    reverse
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reverseutf8" title="reverseUTF8" class="md-nav__link">
    reverseUTF8
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#concats1-s2" title="concat(s1, s2, ...)" class="md-nav__link">
    concat(s1, s2, ...)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#substrings-offset-length" title="substring(s, offset, length)" class="md-nav__link">
    substring(s, offset, length)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#substringutf8s-offset-length" title="substringUTF8(s, offset, length)" class="md-nav__link">
    substringUTF8(s, offset, length)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#appendtrailingcharifabsents-c" title="appendTrailingCharIfAbsent(s, c)" class="md-nav__link">
    appendTrailingCharIfAbsent(s, c)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#convertcharsets-from-to" title="convertCharset(s, from, to)" class="md-nav__link">
    convertCharset(s, from, to)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions-for-searching-strings" title="Functions for searching strings" class="md-nav__link">
    Functions for searching strings
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#positionhaystack-needle" title="position(haystack, needle)" class="md-nav__link">
    position(haystack, needle)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#positionutf8haystack-needle" title="positionUTF8(haystack, needle)" class="md-nav__link">
    positionUTF8(haystack, needle)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matchhaystack-pattern" title="match(haystack, pattern)" class="md-nav__link">
    match(haystack, pattern)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extracthaystack-pattern" title="extract(haystack, pattern)" class="md-nav__link">
    extract(haystack, pattern)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extractallhaystack-pattern" title="extractAll(haystack, pattern)" class="md-nav__link">
    extractAll(haystack, pattern)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#likehaystack-pattern-haystack-like-pattern-operator" title="like(haystack, pattern), haystack LIKE pattern operator" class="md-nav__link">
    like(haystack, pattern), haystack LIKE pattern operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notlikehaystack-pattern-haystack-not-like-pattern-operator" title="notLike(haystack, pattern), haystack NOT LIKE pattern operator" class="md-nav__link">
    notLike(haystack, pattern), haystack NOT LIKE pattern operator
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions-for-searching-and-replacing-in-strings" title="Functions for searching and replacing in strings" class="md-nav__link">
    Functions for searching and replacing in strings
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#replaceonehaystack-pattern-replacement" title="replaceOne(haystack, pattern, replacement)" class="md-nav__link">
    replaceOne(haystack, pattern, replacement)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replaceallhaystack-pattern-replacement" title="replaceAll(haystack, pattern, replacement)" class="md-nav__link">
    replaceAll(haystack, pattern, replacement)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replaceregexponehaystack-pattern-replacement" title="replaceRegexpOne(haystack, pattern, replacement)" class="md-nav__link">
    replaceRegexpOne(haystack, pattern, replacement)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replaceregexpallhaystack-pattern-replacement" title="replaceRegexpAll(haystack, pattern, replacement)" class="md-nav__link">
    replaceRegexpAll(haystack, pattern, replacement)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conditional-functions" title="Conditional functions" class="md-nav__link">
    Conditional functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ifcond-then-else-cond-operator-then-else" title="if(cond, then, else), cond ? operator then : else" class="md-nav__link">
    if(cond, then, else), cond ? operator then : else
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mathematical-functions" title="Mathematical functions" class="md-nav__link">
    Mathematical functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#e" title="e()" class="md-nav__link">
    e()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pi" title="pi()" class="md-nav__link">
    pi()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expx" title="exp(x)" class="md-nav__link">
    exp(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logx" title="log(x)" class="md-nav__link">
    log(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exp2x" title="exp2(x)" class="md-nav__link">
    exp2(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#log2x" title="log2(x)" class="md-nav__link">
    log2(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exp10x" title="exp10(x)" class="md-nav__link">
    exp10(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#log10x" title="log10(x)" class="md-nav__link">
    log10(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sqrtx" title="sqrt(x)" class="md-nav__link">
    sqrt(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cbrtx" title="cbrt(x)" class="md-nav__link">
    cbrt(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#erfx" title="erf(x)" class="md-nav__link">
    erf(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#erfcx" title="erfc(x)" class="md-nav__link">
    erfc(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lgammax" title="lgamma(x)" class="md-nav__link">
    lgamma(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tgammax" title="tgamma(x)" class="md-nav__link">
    tgamma(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sinx" title="sin(x)" class="md-nav__link">
    sin(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cosx" title="cos(x)" class="md-nav__link">
    cos(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tanx" title="tan(x)" class="md-nav__link">
    tan(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asinx" title="asin(x)" class="md-nav__link">
    asin(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acosx" title="acos(x)" class="md-nav__link">
    acos(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#atanx" title="atan(x)" class="md-nav__link">
    atan(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powx-y" title="pow(x, y)" class="md-nav__link">
    pow(x, y)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rounding-functions" title="Rounding functions" class="md-nav__link">
    Rounding functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#floorx91-n93" title="floor(x[, N])" class="md-nav__link">
    floor(x[, N])
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ceilx91-n93" title="ceil(x[, N])" class="md-nav__link">
    ceil(x[, N])
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#roundx91-n93" title="round(x[, N])" class="md-nav__link">
    round(x[, N])
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#roundtoexp2num" title="roundToExp2(num)" class="md-nav__link">
    roundToExp2(num)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rounddurationnum" title="roundDuration(num)" class="md-nav__link">
    roundDuration(num)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#roundagenum" title="roundAge(num)" class="md-nav__link">
    roundAge(num)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions-for-working-with-arrays" title="Functions for working with arrays" class="md-nav__link">
    Functions for working with arrays
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#empty_1" title="empty" class="md-nav__link">
    empty
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notempty_1" title="notEmpty" class="md-nav__link">
    notEmpty
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#length_1" title="length" class="md-nav__link">
    length
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emptyarrayuint8-emptyarrayuint16-emptyarrayuint32-emptyarrayuint64" title="emptyArrayUInt8, emptyArrayUInt16, emptyArrayUInt32, emptyArrayUInt64" class="md-nav__link">
    emptyArrayUInt8, emptyArrayUInt16, emptyArrayUInt32, emptyArrayUInt64
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emptyarrayint8-emptyarrayint16-emptyarrayint32-emptyarrayint64" title="emptyArrayInt8, emptyArrayInt16, emptyArrayInt32, emptyArrayInt64" class="md-nav__link">
    emptyArrayInt8, emptyArrayInt16, emptyArrayInt32, emptyArrayInt64
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emptyarrayfloat32-emptyarrayfloat64" title="emptyArrayFloat32, emptyArrayFloat64" class="md-nav__link">
    emptyArrayFloat32, emptyArrayFloat64
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emptyarraydate-emptyarraydatetime" title="emptyArrayDate, emptyArrayDateTime" class="md-nav__link">
    emptyArrayDate, emptyArrayDateTime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emptyarraystring" title="emptyArrayString" class="md-nav__link">
    emptyArrayString
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emptyarraytosingle" title="emptyArrayToSingle" class="md-nav__link">
    emptyArrayToSingle
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rangen" title="range(N)" class="md-nav__link">
    range(N)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arrayx1-operator-91x1-93" title="array(x1, ...), operator [x1, ...]" class="md-nav__link">
    array(x1, ...), operator [x1, ...]
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arrayconcat" title="arrayConcat" class="md-nav__link">
    arrayConcat
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arrayelementarr-n-operator-arrn" title="arrayElement(arr, n), operator arr[n]" class="md-nav__link">
    arrayElement(arr, n), operator arr[n]
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hasarr-elem" title="has(arr, elem)" class="md-nav__link">
    has(arr, elem)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#indexofarr-x" title="indexOf(arr, x)" class="md-nav__link">
    indexOf(arr, x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#countequalarr-x" title="countEqual(arr, x)" class="md-nav__link">
    countEqual(arr, x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arrayenumeratearr" title="arrayEnumerate(arr)" class="md-nav__link">
    arrayEnumerate(arr)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arrayenumerateuniqarr" title="arrayEnumerateUniq(arr, ...)" class="md-nav__link">
    arrayEnumerateUniq(arr, ...)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arraypopback" title="arrayPopBack" class="md-nav__link">
    arrayPopBack
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arraypopfront" title="arrayPopFront" class="md-nav__link">
    arrayPopFront
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arraypushback" title="arrayPushBack" class="md-nav__link">
    arrayPushBack
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arraypushfront" title="arrayPushFront" class="md-nav__link">
    arrayPushFront
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arrayslice" title="arraySlice" class="md-nav__link">
    arraySlice
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arrayuniqarr" title="arrayUniq(arr, ...)" class="md-nav__link">
    arrayUniq(arr, ...)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arrayjoinarr" title="arrayJoin(arr)" class="md-nav__link">
    arrayJoin(arr)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions-for-splitting-and-merging-strings-and-arrays" title="Functions for splitting and merging strings and arrays" class="md-nav__link">
    Functions for splitting and merging strings and arrays
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#splitbycharseparator-s" title="splitByChar(separator, s)" class="md-nav__link">
    splitByChar(separator, s)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#splitbystringseparator-s" title="splitByString(separator, s)" class="md-nav__link">
    splitByString(separator, s)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arraystringconcatarr91-separator93" title="arrayStringConcat(arr[, separator])" class="md-nav__link">
    arrayStringConcat(arr[, separator])
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alphatokenss" title="alphaTokens(s)" class="md-nav__link">
    alphaTokens(s)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bit-functions" title="Bit functions" class="md-nav__link">
    Bit functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bitanda-b" title="bitAnd(a, b)" class="md-nav__link">
    bitAnd(a, b)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bitora-b" title="bitOr(a, b)" class="md-nav__link">
    bitOr(a, b)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bitxora-b" title="bitXor(a, b)" class="md-nav__link">
    bitXor(a, b)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bitnota" title="bitNot(a)" class="md-nav__link">
    bitNot(a)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bitshiftlefta-b" title="bitShiftLeft(a, b)" class="md-nav__link">
    bitShiftLeft(a, b)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bitshiftrighta-b" title="bitShiftRight(a, b)" class="md-nav__link">
    bitShiftRight(a, b)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hash-functions" title="Hash functions" class="md-nav__link">
    Hash functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#halfmd5" title="halfMD5" class="md-nav__link">
    halfMD5
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#md5" title="MD5" class="md-nav__link">
    MD5
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#siphash64" title="sipHash64" class="md-nav__link">
    sipHash64
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#siphash128" title="sipHash128" class="md-nav__link">
    sipHash128
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cityhash64" title="cityHash64" class="md-nav__link">
    cityHash64
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inthash32" title="intHash32" class="md-nav__link">
    intHash32
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inthash64" title="intHash64" class="md-nav__link">
    intHash64
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sha1" title="SHA1" class="md-nav__link">
    SHA1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sha224" title="SHA224" class="md-nav__link">
    SHA224
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sha256" title="SHA256" class="md-nav__link">
    SHA256
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#urlhashurl91-n93" title="URLHash(url[, N])" class="md-nav__link">
    URLHash(url[, N])
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions-for-generating-pseudo-random-numbers" title="Functions for generating pseudo-random numbers" class="md-nav__link">
    Functions for generating pseudo-random numbers
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rand" title="rand" class="md-nav__link">
    rand
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rand64" title="rand64" class="md-nav__link">
    rand64
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#encoding-functions" title="Encoding functions" class="md-nav__link">
    Encoding functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hex" title="hex" class="md-nav__link">
    hex
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unhexstr" title="unhex(str)" class="md-nav__link">
    unhex(str)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uuidstringtonumstr" title="UUIDStringToNum(str)" class="md-nav__link">
    UUIDStringToNum(str)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uuidnumtostringstr" title="UUIDNumToString(str)" class="md-nav__link">
    UUIDNumToString(str)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bitmasktolistnum" title="bitmaskToList(num)" class="md-nav__link">
    bitmaskToList(num)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bitmasktoarraynum" title="bitmaskToArray(num)" class="md-nav__link">
    bitmaskToArray(num)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions-for-working-with-urls" title="Functions for working with URLs" class="md-nav__link">
    Functions for working with URLs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#functions-that-extract-part-of-a-url" title="Functions that extract part of a URL" class="md-nav__link">
    Functions that extract part of a URL
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protocol" title="protocol" class="md-nav__link">
    protocol
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#domain" title="domain" class="md-nav__link">
    domain
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#domainwithoutwww" title="domainWithoutWWW" class="md-nav__link">
    domainWithoutWWW
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#topleveldomain" title="topLevelDomain" class="md-nav__link">
    topLevelDomain
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#firstsignificantsubdomain" title="firstSignificantSubdomain" class="md-nav__link">
    firstSignificantSubdomain
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cuttofirstsignificantsubdomain" title="cutToFirstSignificantSubdomain" class="md-nav__link">
    cutToFirstSignificantSubdomain
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#path" title="path" class="md-nav__link">
    path
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pathfull" title="pathFull" class="md-nav__link">
    pathFull
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#querystring" title="queryString" class="md-nav__link">
    queryString
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fragment" title="fragment" class="md-nav__link">
    fragment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#querystringandfragment" title="queryStringAndFragment" class="md-nav__link">
    queryStringAndFragment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extracturlparameterurl-name" title="extractURLParameter(URL, name)" class="md-nav__link">
    extractURLParameter(URL, name)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extracturlparametersurl" title="extractURLParameters(URL)" class="md-nav__link">
    extractURLParameters(URL)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extracturlparameternamesurl" title="extractURLParameterNames(URL)" class="md-nav__link">
    extractURLParameterNames(URL)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#urlhierarchyurl" title="URLHierarchy(URL)" class="md-nav__link">
    URLHierarchy(URL)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#urlpathhierarchyurl" title="URLPathHierarchy(URL)" class="md-nav__link">
    URLPathHierarchy(URL)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decodeurlcomponenturl" title="decodeURLComponent(URL)" class="md-nav__link">
    decodeURLComponent(URL)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions-that-remove-part-of-a-url" title="Functions that remove part of a URL." class="md-nav__link">
    Functions that remove part of a URL.
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cutwww" title="cutWWW" class="md-nav__link">
    cutWWW
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cutquerystring" title="cutQueryString" class="md-nav__link">
    cutQueryString
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cutfragment" title="cutFragment" class="md-nav__link">
    cutFragment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cutquerystringandfragment" title="cutQueryStringAndFragment" class="md-nav__link">
    cutQueryStringAndFragment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cuturlparameterurl-name" title="cutURLParameter(URL, name)" class="md-nav__link">
    cutURLParameter(URL, name)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions-for-working-with-ip-addresses" title="Functions for working with IP addresses" class="md-nav__link">
    Functions for working with IP addresses
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ipv4numtostringnum" title="IPv4NumToString(num)" class="md-nav__link">
    IPv4NumToString(num)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ipv4stringtonums" title="IPv4StringToNum(s)" class="md-nav__link">
    IPv4StringToNum(s)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ipv4numtostringclasscnum" title="IPv4NumToStringClassC(num)" class="md-nav__link">
    IPv4NumToStringClassC(num)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ipv6numtostringx" title="IPv6NumToString(x)" class="md-nav__link">
    IPv6NumToString(x)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ipv6stringtonums" title="IPv6StringToNum(s)" class="md-nav__link">
    IPv6StringToNum(s)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions-for-working-with-json" title="Functions for working with JSON" class="md-nav__link">
    Functions for working with JSON
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#visitparamhasparams-name" title="visitParamHas(params, name)" class="md-nav__link">
    visitParamHas(params, name)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#visitparamextractuintparams-name" title="visitParamExtractUInt(params, name)" class="md-nav__link">
    visitParamExtractUInt(params, name)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#visitparamextractintparams-name" title="visitParamExtractInt(params, name)" class="md-nav__link">
    visitParamExtractInt(params, name)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#visitparamextractfloatparams-name" title="visitParamExtractFloat(params, name)" class="md-nav__link">
    visitParamExtractFloat(params, name)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#visitparamextractboolparams-name" title="visitParamExtractBool(params, name)" class="md-nav__link">
    visitParamExtractBool(params, name)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#visitparamextractrawparams-name" title="visitParamExtractRaw(params, name)" class="md-nav__link">
    visitParamExtractRaw(params, name)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#visitparamextractstringparams-name" title="visitParamExtractString(params, name)" class="md-nav__link">
    visitParamExtractString(params, name)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#higher-order-functions" title="Higher-order functions" class="md-nav__link">
    Higher-order functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#-operator-lambdaparams-expr-function" title="-&gt; operator, lambda(params, expr) function" class="md-nav__link">
    -&gt; operator, lambda(params, expr) function
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#arraymapfunc-arr1" title="arrayMap(func, arr1, ...)" class="md-nav__link">
    arrayMap(func, arr1, ...)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arrayfilterfunc-arr1" title="arrayFilter(func, arr1, ...)" class="md-nav__link">
    arrayFilter(func, arr1, ...)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arraycount91func93-arr1" title="arrayCount([func,] arr1, ...)" class="md-nav__link">
    arrayCount([func,] arr1, ...)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arrayexists91func93-arr1" title="arrayExists([func,] arr1, ...)" class="md-nav__link">
    arrayExists([func,] arr1, ...)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arrayall91func93-arr1" title="arrayAll([func,] arr1, ...)" class="md-nav__link">
    arrayAll([func,] arr1, ...)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arraysum91func93-arr1" title="arraySum([func,] arr1, ...)" class="md-nav__link">
    arraySum([func,] arr1, ...)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arrayfirstfunc-arr1" title="arrayFirst(func, arr1, ...)" class="md-nav__link">
    arrayFirst(func, arr1, ...)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arrayfirstindexfunc-arr1" title="arrayFirstIndex(func, arr1, ...)" class="md-nav__link">
    arrayFirstIndex(func, arr1, ...)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arraycumsum91func93-arr1" title="arrayCumSum([func,] arr1, ...)" class="md-nav__link">
    arrayCumSum([func,] arr1, ...)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arraysort91func93-arr1" title="arraySort([func,] arr1, ...)" class="md-nav__link">
    arraySort([func,] arr1, ...)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arrayreversesort91func93-arr1" title="arrayReverseSort([func,] arr1, ...)" class="md-nav__link">
    arrayReverseSort([func,] arr1, ...)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#other-functions" title="Other functions" class="md-nav__link">
    Other functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hostname" title="hostName()" class="md-nav__link">
    hostName()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#visiblewidthx" title="visibleWidth(x)" class="md-nav__link">
    visibleWidth(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#totypenamex" title="toTypeName(x)" class="md-nav__link">
    toTypeName(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blocksize" title="blockSize()" class="md-nav__link">
    blockSize()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#materializex" title="materialize(x)" class="md-nav__link">
    materialize(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ignore" title="ignore(...)" class="md-nav__link">
    ignore(...)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sleepseconds" title="sleep(seconds)" class="md-nav__link">
    sleep(seconds)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#currentdatabase" title="currentDatabase()" class="md-nav__link">
    currentDatabase()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#isfinitex" title="isFinite(x)" class="md-nav__link">
    isFinite(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#isinfinitex" title="isInfinite(x)" class="md-nav__link">
    isInfinite(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#isnanx" title="isNaN(x)" class="md-nav__link">
    isNaN(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hascolumnintable91hostname91-username91-password939393-database-table-column" title="hasColumnInTable(['hostname'[, 'username'[, 'password']],] 'database', 'table', 'column')" class="md-nav__link">
    hasColumnInTable(['hostname'[, 'username'[, 'password']],] 'database', 'table', 'column')
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bar" title="bar" class="md-nav__link">
    bar
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transform" title="transform" class="md-nav__link">
    transform
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#formatreadablesizex" title="formatReadableSize(x)" class="md-nav__link">
    formatReadableSize(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leasta-b" title="least(a, b)" class="md-nav__link">
    least(a, b)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#greatesta-b" title="greatest(a, b)" class="md-nav__link">
    greatest(a, b)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uptime" title="uptime()" class="md-nav__link">
    uptime()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#version" title="version()" class="md-nav__link">
    version()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rownumberinallblocks" title="rowNumberInAllBlocks()" class="md-nav__link">
    rowNumberInAllBlocks()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#runningdifferencex" title="runningDifference(x)" class="md-nav__link">
    runningDifference(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macnumtostringnum" title="MACNumToString(num)" class="md-nav__link">
    MACNumToString(num)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macstringtonums" title="MACStringToNum(s)" class="md-nav__link">
    MACStringToNum(s)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macstringtoouis" title="MACStringToOUI(s)" class="md-nav__link">
    MACStringToOUI(s)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions-for-working-with-external-dictionaries" title="Functions for working with external dictionaries" class="md-nav__link">
    Functions for working with external dictionaries
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dictgetuint8-dictgetuint16-dictgetuint32-dictgetuint64" title="dictGetUInt8, dictGetUInt16, dictGetUInt32, dictGetUInt64" class="md-nav__link">
    dictGetUInt8, dictGetUInt16, dictGetUInt32, dictGetUInt64
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dictgetint8-dictgetint16-dictgetint32-dictgetint64" title="dictGetInt8, dictGetInt16, dictGetInt32, dictGetInt64" class="md-nav__link">
    dictGetInt8, dictGetInt16, dictGetInt32, dictGetInt64
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dictgetfloat32-dictgetfloat64" title="dictGetFloat32, dictGetFloat64" class="md-nav__link">
    dictGetFloat32, dictGetFloat64
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dictgetdate-dictgetdatetime" title="dictGetDate, dictGetDateTime" class="md-nav__link">
    dictGetDate, dictGetDateTime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dictgetuuid" title="dictGetUUID" class="md-nav__link">
    dictGetUUID
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dictgetstring" title="dictGetString" class="md-nav__link">
    dictGetString
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dictgettordefault" title="dictGetTOrDefault" class="md-nav__link">
    dictGetTOrDefault
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dictisin" title="dictIsIn" class="md-nav__link">
    dictIsIn
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dictgethierarchy" title="dictGetHierarchy" class="md-nav__link">
    dictGetHierarchy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dicthas" title="dictHas" class="md-nav__link">
    dictHas
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions-for-working-with-yandexmetrica-dictionaries" title="Functions for working with Yandex.Metrica dictionaries" class="md-nav__link">
    Functions for working with Yandex.Metrica dictionaries
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multiple-geobases" title="Multiple geobases" class="md-nav__link">
    Multiple geobases
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#regiontocityid-geobase" title="regionToCity(id[, geobase])" class="md-nav__link">
    regionToCity(id[, geobase])
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regiontoareaid91-geobase93" title="regionToArea(id[, geobase])" class="md-nav__link">
    regionToArea(id[, geobase])
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regiontodistrictid-geobase" title="regionToDistrict(id[, geobase])" class="md-nav__link">
    regionToDistrict(id[, geobase])
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regiontocountryid-geobase" title="regionToCountry(id[, geobase])" class="md-nav__link">
    regionToCountry(id[, geobase])
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regiontocontinentid-geobase" title="regionToContinent(id[, geobase])" class="md-nav__link">
    regionToContinent(id[, geobase])
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regiontopopulationid-geobase" title="regionToPopulation(id[, geobase])" class="md-nav__link">
    regionToPopulation(id[, geobase])
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regioninlhs-rhs-geobase" title="regionIn(lhs, rhs[, geobase])" class="md-nav__link">
    regionIn(lhs, rhs[, geobase])
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regionhierarchyid91-geobase93" title="regionHierarchy(id[, geobase])" class="md-nav__link">
    regionHierarchy(id[, geobase])
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regiontonameid91-lang93" title="regionToName(id[, lang])" class="md-nav__link">
    regionToName(id[, lang])
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions-for-implementing-the-in-operator" title="Functions for implementing the IN operator" class="md-nav__link">
    Functions for implementing the IN operator
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#in-notin-globalin-globalnotin" title="in, notIn, globalIn, globalNotIn" class="md-nav__link">
    in, notIn, globalIn, globalNotIn
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tuplex-y-operator-x-y" title="tuple(x, y, ...), operator (x, y, ...)" class="md-nav__link">
    tuple(x, y, ...), operator (x, y, ...)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tupleelementtuple-n-operator-xn" title="tupleElement(tuple, n), operator x.N" class="md-nav__link">
    tupleElement(tuple, n), operator x.N
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arrayjoin-function" title="arrayJoin function" class="md-nav__link">
    arrayJoin function
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregate-functions" title="Aggregate functions" class="md-nav__link">
    Aggregate functions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#function-reference" title="Function reference" class="md-nav__link">
    Function reference
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#count" title="count()" class="md-nav__link">
    count()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#anyx" title="any(x)" class="md-nav__link">
    any(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#anyheavyx" title="anyHeavy(x)" class="md-nav__link">
    anyHeavy(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#anylastx" title="anyLast(x)" class="md-nav__link">
    anyLast(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minx" title="min(x)" class="md-nav__link">
    min(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maxx" title="max(x)" class="md-nav__link">
    max(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#argminarg-val" title="argMin(arg, val)" class="md-nav__link">
    argMin(arg, val)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#argmaxarg-val" title="argMax(arg, val)" class="md-nav__link">
    argMax(arg, val)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sumx" title="sum(x)" class="md-nav__link">
    sum(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sumwithoverflowx" title="sumWithOverflow(x)" class="md-nav__link">
    sumWithOverflow(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summapkey-value" title="sumMap(key, value)" class="md-nav__link">
    sumMap(key, value)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#avgx" title="avg(x)" class="md-nav__link">
    avg(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uniqx" title="uniq(x)" class="md-nav__link">
    uniq(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uniqcombinedx" title="uniqCombined(x)" class="md-nav__link">
    uniqCombined(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uniqhll12x" title="uniqHLL12(x)" class="md-nav__link">
    uniqHLL12(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uniqexactx" title="uniqExact(x)" class="md-nav__link">
    uniqExact(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grouparrayx-grouparraymax_sizex" title="groupArray(x), groupArray(max_size)(x)" class="md-nav__link">
    groupArray(x), groupArray(max_size)(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grouparrayinsertatx" title="groupArrayInsertAt(x)" class="md-nav__link">
    groupArrayInsertAt(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#groupuniqarrayx" title="groupUniqArray(x)" class="md-nav__link">
    groupUniqArray(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quantilelevelx" title="quantile(level)(x)" class="md-nav__link">
    quantile(level)(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quantiledeterministiclevelx-determinator" title="quantileDeterministic(level)(x, determinator)" class="md-nav__link">
    quantileDeterministic(level)(x, determinator)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quantiletiminglevelx" title="quantileTiming(level)(x)" class="md-nav__link">
    quantileTiming(level)(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quantiletimingweightedlevelx-weight" title="quantileTimingWeighted(level)(x, weight)" class="md-nav__link">
    quantileTimingWeighted(level)(x, weight)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quantileexactlevelx" title="quantileExact(level)(x)" class="md-nav__link">
    quantileExact(level)(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quantileexactweightedlevelx-weight" title="quantileExactWeighted(level)(x, weight)" class="md-nav__link">
    quantileExactWeighted(level)(x, weight)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quantiletdigestlevelx" title="quantileTDigest(level)(x)" class="md-nav__link">
    quantileTDigest(level)(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#medianx" title="median(x)" class="md-nav__link">
    median(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quantileslevel1-level2-x" title="quantiles(level1, level2, ...)(x)" class="md-nav__link">
    quantiles(level1, level2, ...)(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#varsampx" title="varSamp(x)" class="md-nav__link">
    varSamp(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#varpopx" title="varPop(x)" class="md-nav__link">
    varPop(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stddevsampx" title="stddevSamp(x)" class="md-nav__link">
    stddevSamp(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stddevpopx" title="stddevPop(x)" class="md-nav__link">
    stddevPop(x)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#topkncolumn" title="topK(N)(column)" class="md-nav__link">
    topK(N)(column)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#covarsampx-y" title="covarSamp(x, y)" class="md-nav__link">
    covarSamp(x, y)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#covarpopx-y" title="covarPop(x, y)" class="md-nav__link">
    covarPop(x, y)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#corrx-y" title="corr(x, y)" class="md-nav__link">
    corr(x, y)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregate-function-combinators" title="Aggregate function combinators" class="md-nav__link">
    Aggregate function combinators
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#-if" title="-If" class="md-nav__link">
    -If
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-array" title="-Array" class="md-nav__link">
    -Array
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-state" title="-State" class="md-nav__link">
    -State
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-merge" title="-Merge" class="md-nav__link">
    -Merge
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-mergestate" title="-MergeState." class="md-nav__link">
    -MergeState.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-foreach" title="-ForEach" class="md-nav__link">
    -ForEach
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parametric-aggregate-functions" title="Parametric aggregate functions" class="md-nav__link">
    Parametric aggregate functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sequencematchpatterntime-cond1-cond2" title="sequenceMatch(pattern)(time, cond1, cond2, ...)" class="md-nav__link">
    sequenceMatch(pattern)(time, cond1, cond2, ...)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sequencecountpatterntime-cond1-cond2" title="sequenceCount(pattern)(time, cond1, cond2, ...)" class="md-nav__link">
    sequenceCount(pattern)(time, cond1, cond2, ...)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windowfunnelwindowtimestamp-cond1-cond2-cond3" title="windowFunnel(window)(timestamp, cond1, cond2, cond3, ....)" class="md-nav__link">
    windowFunnel(window)(timestamp, cond1, cond2, cond3, ....)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uniquptonx" title="uniqUpTo(N)(x)" class="md-nav__link">
    uniqUpTo(N)(x)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dictionaries" title="Dictionaries" class="md-nav__link">
    Dictionaries
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#external-dictionaries" title="External dictionaries" class="md-nav__link">
    External dictionaries
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuring-an-external-dictionary" title="Configuring an external dictionary" class="md-nav__link">
    Configuring an external dictionary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storing-dictionaries-in-memory" title="Storing dictionaries in memory" class="md-nav__link">
    Storing dictionaries in memory
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ways-to-store-dictionaries-in-memory" title="Ways to store dictionaries in memory" class="md-nav__link">
    Ways to store dictionaries in memory
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#flat" title="flat" class="md-nav__link">
    flat
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hashed" title="hashed" class="md-nav__link">
    hashed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#complex_key_hashed" title="complex_key_hashed" class="md-nav__link">
    complex_key_hashed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#range_hashed" title="range_hashed" class="md-nav__link">
    range_hashed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cache" title="cache" class="md-nav__link">
    cache
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#complex_key_cache" title="complex_key_cache" class="md-nav__link">
    complex_key_cache
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ip_trie" title="ip_trie" class="md-nav__link">
    ip_trie
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dictionary-updates" title="Dictionary updates" class="md-nav__link">
    Dictionary updates
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sources-of-external-dictionaries" title="Sources of external dictionaries" class="md-nav__link">
    Sources of external dictionaries
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#local-file" title="Local file" class="md-nav__link">
    Local file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executable-file" title="Executable file" class="md-nav__link">
    Executable file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#https" title="HTTP(s)" class="md-nav__link">
    HTTP(s)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#odbc" title="ODBC" class="md-nav__link">
    ODBC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-of-connecting-postgresql" title="Example of connecting PostgreSQL" class="md-nav__link">
    Example of connecting PostgreSQL
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-of-connecting-ms-sql-server" title="Example of connecting MS SQL Server" class="md-nav__link">
    Example of connecting MS SQL Server
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dbms" title="DBMS" class="md-nav__link">
    DBMS
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mysql_1" title="MySQL" class="md-nav__link">
    MySQL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clickhouse" title="ClickHouse" class="md-nav__link">
    ClickHouse
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongodb" title="MongoDB" class="md-nav__link">
    MongoDB
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dictionary-key-and-fields" title="Dictionary key and fields" class="md-nav__link">
    Dictionary key and fields
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key" title="Key" class="md-nav__link">
    Key
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#numeric-key" title="Numeric key" class="md-nav__link">
    Numeric key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#composite-key" title="Composite key" class="md-nav__link">
    Composite key
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attributes" title="Attributes" class="md-nav__link">
    Attributes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#internal-dictionaries" title="Internal dictionaries" class="md-nav__link">
    Internal dictionaries
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage_1" title="Usage" class="md-nav__link">
    Usage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-rights" title="Access rights" class="md-nav__link">
    Access rights
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration-files_1" title="Configuration files" class="md-nav__link">
    Configuration files
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quotas" title="Quotas" class="md-nav__link">
    Quotas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage-recommendations" title="Usage recommendations" class="md-nav__link">
    Usage recommendations
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cpu" title="CPU" class="md-nav__link">
    CPU
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hyper-threading" title="Hyper-threading" class="md-nav__link">
    Hyper-threading
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#turbo-boost" title="Turbo Boost" class="md-nav__link">
    Turbo Boost
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cpu-scaling-governor" title="CPU scaling governor" class="md-nav__link">
    CPU scaling governor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cpu-limitations" title="CPU limitations" class="md-nav__link">
    CPU limitations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ram" title="RAM" class="md-nav__link">
    RAM
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swap-file" title="Swap file" class="md-nav__link">
    Swap file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#huge-pages" title="Huge pages" class="md-nav__link">
    Huge pages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#storage-subsystem" title="Storage subsystem" class="md-nav__link">
    Storage subsystem
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#raid" title="RAID" class="md-nav__link">
    RAID
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-system" title="File system" class="md-nav__link">
    File system
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linux-kernel" title="Linux kernel" class="md-nav__link">
    Linux kernel
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network" title="Network" class="md-nav__link">
    Network
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zookeeper" title="ZooKeeper" class="md-nav__link">
    ZooKeeper
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server-configuration-parameters" title="Server configuration parameters" class="md-nav__link">
    Server configuration parameters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server-settings" title="Server settings" class="md-nav__link">
    Server settings
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#builtin_dictionaries_reload_interval" title="builtin_dictionaries_reload_interval" class="md-nav__link">
    builtin_dictionaries_reload_interval
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compression" title="compression" class="md-nav__link">
    compression
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#default_database" title="default_database" class="md-nav__link">
    default_database
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#default_profile" title="default_profile" class="md-nav__link">
    default_profile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dictionaries_config" title="dictionaries_config" class="md-nav__link">
    dictionaries_config
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dictionaries_lazy_load" title="dictionaries_lazy_load" class="md-nav__link">
    dictionaries_lazy_load
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#format_schema_path" title="format_schema_path" class="md-nav__link">
    format_schema_path
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graphite" title="graphite" class="md-nav__link">
    graphite
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graphite_rollup" title="graphite_rollup" class="md-nav__link">
    graphite_rollup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http_porthttps_port" title="http_port/https_port" class="md-nav__link">
    http_port/https_port
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http_server_default_response" title="http_server_default_response" class="md-nav__link">
    http_server_default_response
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#include_from" title="include_from" class="md-nav__link">
    include_from
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interserver_http_port" title="interserver_http_port" class="md-nav__link">
    interserver_http_port
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interserver_http_host" title="interserver_http_host" class="md-nav__link">
    interserver_http_host
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#keep_alive_timeout" title="keep_alive_timeout" class="md-nav__link">
    keep_alive_timeout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#listen_host" title="listen_host" class="md-nav__link">
    listen_host
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logger" title="logger" class="md-nav__link">
    logger
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macros" title="macros" class="md-nav__link">
    macros
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mark_cache_size" title="mark_cache_size" class="md-nav__link">
    mark_cache_size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_concurrent_queries" title="max_concurrent_queries" class="md-nav__link">
    max_concurrent_queries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_connections" title="max_connections" class="md-nav__link">
    max_connections
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_open_files" title="max_open_files" class="md-nav__link">
    max_open_files
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_table_size_to_drop" title="max_table_size_to_drop" class="md-nav__link">
    max_table_size_to_drop
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#merge_tree" title="merge_tree" class="md-nav__link">
    merge_tree
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openssl" title="openSSL" class="md-nav__link">
    openSSL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part_log" title="part_log" class="md-nav__link">
    part_log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#path_1" title="path" class="md-nav__link">
    path
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#query_log" title="query_log" class="md-nav__link">
    query_log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remote_servers" title="remote_servers" class="md-nav__link">
    remote_servers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timezone" title="timezone" class="md-nav__link">
    timezone
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcp_port" title="tcp_port" class="md-nav__link">
    tcp_port
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tmp_path" title="tmp_path" class="md-nav__link">
    tmp_path
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uncompressed_cache_size" title="uncompressed_cache_size" class="md-nav__link">
    uncompressed_cache_size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#users_config" title="users_config" class="md-nav__link">
    users_config
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zookeeper_1" title="zookeeper" class="md-nav__link">
    zookeeper
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#settings" title="Settings" class="md-nav__link">
    Settings
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#restrictions-on-query-complexity" title="Restrictions on query complexity" class="md-nav__link">
    Restrictions on query complexity
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#readonly" title="readonly" class="md-nav__link">
    readonly
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_memory_usage" title="max_memory_usage" class="md-nav__link">
    max_memory_usage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_memory_usage_for_user" title="max_memory_usage_for_user" class="md-nav__link">
    max_memory_usage_for_user
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_memory_usage_for_all_queries" title="max_memory_usage_for_all_queries" class="md-nav__link">
    max_memory_usage_for_all_queries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_rows_to_read" title="max_rows_to_read" class="md-nav__link">
    max_rows_to_read
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_bytes_to_read" title="max_bytes_to_read" class="md-nav__link">
    max_bytes_to_read
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#read_overflow_mode" title="read_overflow_mode" class="md-nav__link">
    read_overflow_mode
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_rows_to_group_by" title="max_rows_to_group_by" class="md-nav__link">
    max_rows_to_group_by
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#group_by_overflow_mode" title="group_by_overflow_mode" class="md-nav__link">
    group_by_overflow_mode
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_rows_to_sort" title="max_rows_to_sort" class="md-nav__link">
    max_rows_to_sort
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_bytes_to_sort" title="max_bytes_to_sort" class="md-nav__link">
    max_bytes_to_sort
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sort_overflow_mode" title="sort_overflow_mode" class="md-nav__link">
    sort_overflow_mode
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_result_rows" title="max_result_rows" class="md-nav__link">
    max_result_rows
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_result_bytes" title="max_result_bytes" class="md-nav__link">
    max_result_bytes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#result_overflow_mode" title="result_overflow_mode" class="md-nav__link">
    result_overflow_mode
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_execution_time" title="max_execution_time" class="md-nav__link">
    max_execution_time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timeout_overflow_mode" title="timeout_overflow_mode" class="md-nav__link">
    timeout_overflow_mode
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#min_execution_speed" title="min_execution_speed" class="md-nav__link">
    min_execution_speed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timeout_before_checking_execution_speed" title="timeout_before_checking_execution_speed" class="md-nav__link">
    timeout_before_checking_execution_speed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_columns_to_read" title="max_columns_to_read" class="md-nav__link">
    max_columns_to_read
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_temporary_columns" title="max_temporary_columns" class="md-nav__link">
    max_temporary_columns
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_temporary_non_const_columns" title="max_temporary_non_const_columns" class="md-nav__link">
    max_temporary_non_const_columns
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_subquery_depth" title="max_subquery_depth" class="md-nav__link">
    max_subquery_depth
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_pipeline_depth" title="max_pipeline_depth" class="md-nav__link">
    max_pipeline_depth
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_ast_depth" title="max_ast_depth" class="md-nav__link">
    max_ast_depth
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_ast_elements" title="max_ast_elements" class="md-nav__link">
    max_ast_elements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_rows_in_set" title="max_rows_in_set" class="md-nav__link">
    max_rows_in_set
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_bytes_in_set" title="max_bytes_in_set" class="md-nav__link">
    max_bytes_in_set
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_overflow_mode" title="set_overflow_mode" class="md-nav__link">
    set_overflow_mode
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_rows_in_distinct" title="max_rows_in_distinct" class="md-nav__link">
    max_rows_in_distinct
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_bytes_in_distinct" title="max_bytes_in_distinct" class="md-nav__link">
    max_bytes_in_distinct
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#distinct_overflow_mode" title="distinct_overflow_mode" class="md-nav__link">
    distinct_overflow_mode
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_rows_to_transfer" title="max_rows_to_transfer" class="md-nav__link">
    max_rows_to_transfer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_bytes_to_transfer" title="max_bytes_to_transfer" class="md-nav__link">
    max_bytes_to_transfer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transfer_overflow_mode" title="transfer_overflow_mode" class="md-nav__link">
    transfer_overflow_mode
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#settings_1" title="Settings" class="md-nav__link">
    Settings
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#distributed_product_mode" title="distributed_product_mode" class="md-nav__link">
    distributed_product_mode
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fallback_to_stale_replicas_for_distributed_queries" title="fallback_to_stale_replicas_for_distributed_queries" class="md-nav__link">
    fallback_to_stale_replicas_for_distributed_queries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#force_index_by_date" title="force_index_by_date" class="md-nav__link">
    force_index_by_date
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#force_primary_key" title="force_primary_key" class="md-nav__link">
    force_primary_key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsync_metadata" title="fsync_metadata" class="md-nav__link">
    fsync_metadata
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#input_format_allow_errors_num" title="input_format_allow_errors_num" class="md-nav__link">
    input_format_allow_errors_num
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#input_format_allow_errors_ratio" title="input_format_allow_errors_ratio" class="md-nav__link">
    input_format_allow_errors_ratio
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_block_size" title="max_block_size" class="md-nav__link">
    max_block_size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preferred_block_size_bytes" title="preferred_block_size_bytes" class="md-nav__link">
    preferred_block_size_bytes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#log_queries" title="log_queries" class="md-nav__link">
    log_queries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_insert_block_size" title="max_insert_block_size" class="md-nav__link">
    max_insert_block_size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_replica_delay_for_distributed_queries" title="max_replica_delay_for_distributed_queries" class="md-nav__link">
    max_replica_delay_for_distributed_queries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_threads" title="max_threads" class="md-nav__link">
    max_threads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_compress_block_size" title="max_compress_block_size" class="md-nav__link">
    max_compress_block_size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#min_compress_block_size" title="min_compress_block_size" class="md-nav__link">
    min_compress_block_size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_query_size" title="max_query_size" class="md-nav__link">
    max_query_size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interactive_delay" title="interactive_delay" class="md-nav__link">
    interactive_delay
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connect_timeout" title="connect_timeout" class="md-nav__link">
    connect_timeout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#receive_timeout" title="receive_timeout" class="md-nav__link">
    receive_timeout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#send_timeout" title="send_timeout" class="md-nav__link">
    send_timeout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poll_interval" title="poll_interval" class="md-nav__link">
    poll_interval
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_distributed_connections" title="max_distributed_connections" class="md-nav__link">
    max_distributed_connections
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#distributed_connections_pool_size" title="distributed_connections_pool_size" class="md-nav__link">
    distributed_connections_pool_size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connect_timeout_with_failover_ms" title="connect_timeout_with_failover_ms" class="md-nav__link">
    connect_timeout_with_failover_ms
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connections_with_failover_max_tries" title="connections_with_failover_max_tries" class="md-nav__link">
    connections_with_failover_max_tries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extremes" title="extremes" class="md-nav__link">
    extremes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use_uncompressed_cache" title="use_uncompressed_cache" class="md-nav__link">
    use_uncompressed_cache
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replace_running_query" title="replace_running_query" class="md-nav__link">
    replace_running_query
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schema" title="schema" class="md-nav__link">
    schema
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stream_flush_interval_ms" title="stream_flush_interval_ms" class="md-nav__link">
    stream_flush_interval_ms
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#load_balancing" title="load_balancing" class="md-nav__link">
    load_balancing
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#random-default" title="random (default)" class="md-nav__link">
    random (default)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nearest_hostname" title="nearest_hostname" class="md-nav__link">
    nearest_hostname
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#in_order" title="in_order" class="md-nav__link">
    in_order
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#totals_mode" title="totals_mode" class="md-nav__link">
    totals_mode
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#totals_auto_threshold" title="totals_auto_threshold" class="md-nav__link">
    totals_auto_threshold
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#default_sample" title="default_sample" class="md-nav__link">
    default_sample
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max_parallel_replicas" title="max_parallel_replicas" class="md-nav__link">
    max_parallel_replicas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compile" title="compile" class="md-nav__link">
    compile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#min_count_to_compile" title="min_count_to_compile" class="md-nav__link">
    min_count_to_compile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#input_format_skip_unknown_fields" title="input_format_skip_unknown_fields" class="md-nav__link">
    input_format_skip_unknown_fields
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#output_format_json_quote_64bit_integers" title="output_format_json_quote_64bit_integers" class="md-nav__link">
    output_format_json_quote_64bit_integers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#format_csv_delimiter" title="format_csv_delimiter" class="md-nav__link">
    format_csv_delimiter
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#settings-profiles" title="Settings profiles" class="md-nav__link">
    Settings profiles
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clickhouse-utility" title="ClickHouse utility" class="md-nav__link">
    ClickHouse utility
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clickhouse-copier" title="clickhouse-copier" class="md-nav__link">
    clickhouse-copier
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-clickhouse-copier" title="Running clickhouse-copier" class="md-nav__link">
    Running clickhouse-copier
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#format-of-zookeeperxml" title="Format of zookeeper.xml" class="md-nav__link">
    Format of zookeeper.xml
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-of-copying-tasks" title="Configuration of copying tasks" class="md-nav__link">
    Configuration of copying tasks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clickhouse-local" title="clickhouse-local" class="md-nav__link">
    clickhouse-local
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clickhouse-development" title="ClickHouse Development" class="md-nav__link">
    ClickHouse Development
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#overview-of-clickhouse-architecture" title="Overview of ClickHouse architecture" class="md-nav__link">
    Overview of ClickHouse architecture
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#columns" title="Columns" class="md-nav__link">
    Columns
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#field" title="Field" class="md-nav__link">
    Field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leaky-abstractions" title="Leaky abstractions" class="md-nav__link">
    Leaky abstractions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-types_1" title="Data types" class="md-nav__link">
    Data types
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#block" title="Block" class="md-nav__link">
    Block
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#block-streams" title="Block Streams" class="md-nav__link">
    Block Streams
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#formats_1" title="Formats" class="md-nav__link">
    Formats
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io" title="I/O" class="md-nav__link">
    I/O
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tables" title="Tables" class="md-nav__link">
    Tables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parsers" title="Parsers" class="md-nav__link">
    Parsers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interpreters" title="Interpreters" class="md-nav__link">
    Interpreters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions_2" title="Functions" class="md-nav__link">
    Functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregate-functions_1" title="Aggregate Functions" class="md-nav__link">
    Aggregate Functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server" title="Server" class="md-nav__link">
    Server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#distributed-query-execution" title="Distributed query execution" class="md-nav__link">
    Distributed query execution
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#merge-tree" title="Merge Tree" class="md-nav__link">
    Merge Tree
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replication" title="Replication" class="md-nav__link">
    Replication
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-build-clickhouse-on-linux" title="How to build ClickHouse on Linux" class="md-nav__link">
    How to build ClickHouse on Linux
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-git-and-cmake" title="Install Git and CMake" class="md-nav__link">
    Install Git and CMake
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-the-number-of-threads" title="Detect the number of threads" class="md-nav__link">
    Detect the number of threads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-gcc-7" title="Install GCC 7" class="md-nav__link">
    Install GCC 7
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-from-a-ppa-package" title="Install from a PPA package" class="md-nav__link">
    Install from a PPA package
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-from-sources" title="Install from sources" class="md-nav__link">
    Install from sources
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-gcc-7-for-builds" title="Use GCC 7 for builds" class="md-nav__link">
    Use GCC 7 for builds
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-required-libraries-from-packages" title="Install required libraries from packages" class="md-nav__link">
    Install required libraries from packages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checkout-clickhouse-sources" title="Checkout ClickHouse sources" class="md-nav__link">
    Checkout ClickHouse sources
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build-clickhouse" title="Build ClickHouse" class="md-nav__link">
    Build ClickHouse
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#build-release-package" title="Build release package" class="md-nav__link">
    Build release package
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build-to-work-with-code" title="Build to work with code" class="md-nav__link">
    Build to work with code
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-build-clickhouse-on-mac-os-x" title="How to build ClickHouse on Mac OS X" class="md-nav__link">
    How to build ClickHouse on Mac OS X
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-homebrew" title="Install Homebrew" class="md-nav__link">
    Install Homebrew
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-required-compilers-tools-and-libraries" title="Install required compilers, tools, and libraries" class="md-nav__link">
    Install required compilers, tools, and libraries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checkout-clickhouse-sources_1" title="Checkout ClickHouse sources" class="md-nav__link">
    Checkout ClickHouse sources
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build-clickhouse_1" title="Build ClickHouse" class="md-nav__link">
    Build ClickHouse
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caveats" title="Caveats" class="md-nav__link">
    Caveats
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-write-c-code" title="How to write C++ code" class="md-nav__link">
    How to write C++ code
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#general-recommendations" title="General recommendations" class="md-nav__link">
    General recommendations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#formatting" title="Formatting" class="md-nav__link">
    Formatting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comments_1" title="Comments" class="md-nav__link">
    Comments
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#names" title="Names" class="md-nav__link">
    Names
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-write-code" title="How to write code" class="md-nav__link">
    How to write code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unused-features-of-c" title="Unused features of C++" class="md-nav__link">
    Unused features of C++
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#platform" title="Platform" class="md-nav__link">
    Platform
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tools" title="Tools" class="md-nav__link">
    Tools
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libraries" title="Libraries" class="md-nav__link">
    Libraries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#general-recommendations_1" title="General recommendations" class="md-nav__link">
    General recommendations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-recommendations" title="Additional recommendations" class="md-nav__link">
    Additional recommendations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-run-clickhouse-tests" title="How to run ClickHouse tests" class="md-nav__link">
    How to run ClickHouse tests
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-usage" title="Example usage" class="md-nav__link">
    Example usage
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#roadmap" title="Roadmap" class="md-nav__link">
    Roadmap
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#q1-2018" title="Q1 2018" class="md-nav__link">
    Q1 2018
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#new-fuctionality" title="New fuctionality" class="md-nav__link">
    New fuctionality
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#improvements" title="Improvements" class="md-nav__link">
    Improvements
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q2-2018" title="Q2 2018" class="md-nav__link">
    Q2 2018
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#new-functionality" title="New functionality" class="md-nav__link">
    New functionality
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#improvements_1" title="Improvements" class="md-nav__link">
    Improvements
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q3-q4-2018" title="Q3-Q4 2018" class="md-nav__link">
    Q3-Q4 2018
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                    <a href="https://github.com/yandex/ClickHouse/tree/master/docs" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="what-is-clickhouse">What is ClickHouse?</h1>
<p>ClickHouse is a columnar DBMS for OLAP.</p>
<p>In a "normal" row-oriented DBMS, data is stored in this order:</p>
<div class="codehilite"><pre><span></span>5123456789123456789     1       Eurobasket - Greece - Bosnia and Herzegovina - example.com      1       2011-09-01 01:03:02     6274717   1294101174      11409   612345678912345678      0       33      6       http://www.example.com/basketball/team/123/match/456789.html http://www.example.com/basketball/team/123/match/987654.html       0       1366    768     32      10      3183      0       0       13      0\0     1       1       0       0                       2011142 -1      0               0       01321     613     660     2011-09-01 08:01:17     0       0       0       0       utf-8   1466    0       0       0       5678901234567890123               277789954       0       0       0       0       0
5234985259563631958     0       Consulting, Tax assessment, Accounting, Law       1       2011-09-01 01:03:02     6320881   2111222333      213     6458937489576391093     0       3       2       http://www.example.ru/         0       800     600       16      10      2       153.1   0       0       10      63      1       1       0       0                       2111678 000       0       588     368     240     2011-09-01 01:03:17     4       0       60310   0       windows-1251    1466    0       000               778899001       0       0       0       0       0
...
</pre></div>


<p>In order words, all the values related to a row are stored next to each other.
Examples of a row-oriented DBMS are MySQL, Postgres, MS SQL Server, and others.</p>
<p>In a column-oriented DBMS, data is stored like this:</p>
<div class="codehilite"><pre><span></span>WatchID:    5385521489354350662     5385521490329509958     5385521489953706054     5385521490476781638     5385521490583269446     5385521490218868806     5385521491437850694   5385521491090174022      5385521490792669254     5385521490420695110     5385521491532181574     5385521491559694406     5385521491459625030     5385521492275175494   5385521492781318214      5385521492710027334     5385521492955615302     5385521493708759110     5385521494506434630     5385521493104611398
JavaEnable: 1       0       1       0       0       0       1       0       1       1       1       1       1       1       0       1       0       0       1       1
Title:      Yandex  Announcements - Investor Relations - Yandex     Yandex — Contact us — Moscow    Yandex — Mission        Ru      Yandex — History — History of Yandex    Yandex Financial Releases - Investor Relations - Yandex Yandex — Locations      Yandex Board of Directors - Corporate Governance - Yandex       Yandex — Technologies
GoodEvent:  1       1       1       1       1       1       1       1       1       1       1       1       1       1       1       1       1       1       1       1
EventTime:  2016-05-18 05:19:20     2016-05-18 08:10:20     2016-05-18 07:38:00     2016-05-18 01:13:08     2016-05-18 00:04:06     2016-05-18 04:21:30     2016-05-18 00:34:16     2016-05-18 07:35:49     2016-05-18 11:41:59     2016-05-18 01:13:32
</pre></div>


<p>These examples only show the order that data is arranged in.
The values from different columns are stored separately, and data from the same column is stored together.</p>
<p>Examples of column-oriented DBMSs: <code>Vertica</code>, <code>Paraccel (Actian Matrix) (Amazon Redshift)</code>, <code>Sybase IQ</code>, <code>Exasol</code>, <code>Infobright</code>, <code>InfiniDB</code>, <code>MonetDB (VectorWise) (Actian Vector)</code>, <code>LucidDB</code>, <code>SAP HANA</code>, <code>Google Dremel</code>, <code>Google PowerDrill</code>, <code>Druid</code>, <code>kdb+</code>, and so on.</p>
<p>Different orders for storing data are better suited to different scenarios.
The data access scenario refers to what queries are made, how often, and in what proportion; how much data is read for each type of query – rows, columns, and bytes; the relationship between reading and updating data; the working size of the data and how locally it is used; whether transactions are used, and how isolated they are; requirements for data replication and logical integrity; requirements for latency and throughput for each type of query, and so on.</p>
<p>The higher the load on the system, the more important it is to customize the system to the scenario, and the more specific this customization becomes. There is no system that is equally well-suited to significantly different scenarios. If a system is adaptable to a wide set of scenarios, under a high load, the system will handle all the scenarios equally poorly, or will work well for just one of the scenarios.</p>
<p>We'll say that the following is true for the OLAP (online analytical processing) scenario:</p>
<ul>
<li>The vast majority of requests are for read access.</li>
<li>Data is updated in fairly large batches (&gt; 1000 rows), not by single rows; or it is not updated at all.</li>
<li>Data is added to the DB but is not modified.</li>
<li>For reads, quite a large number of rows are extracted from the DB, but only a small subset of columns.</li>
<li>Tables are "wide," meaning they contain a large number of columns.</li>
<li>Queries are relatively rare (usually hundreds of queries per server or less per second).</li>
<li>For simple queries, latencies around 50 ms are allowed.</li>
<li>Column values are fairly small: numbers and short strings (for example, 60 bytes per URL).</li>
<li>Requires high throughput when processing a single query (up to billions of rows per second per server).</li>
<li>There are no transactions.</li>
<li>Low requirements for data consistency.</li>
<li>There is one large table per query. All tables are small, except for one.</li>
<li>A query result is significantly smaller than the source data. In other words, data is filtered or aggregated. The result fits in a single server's RAM.</li>
</ul>
<p>It is easy to see that the OLAP scenario is very different from other popular scenarios (such as OLTP or Key-Value access). So it doesn't make sense to try to use OLTP or a Key-Value DB for processing analytical queries if you want to get decent performance. For example, if you try to use MongoDB or Elliptics for analytics, you will get very poor performance compared to OLAP databases.</p>
<p>Columnar-oriented databases are better suited to OLAP scenarios (at least 100 times better in processing speed for most queries), for the following reasons:</p>
<ol>
<li>For I/O.</li>
<li>For an analytical query, only a small number of table columns need to be read. In a column-oriented database, you can read just the data you need. For example, if you need 5 columns out of 100, you can expect a 20-fold reduction in I/O.</li>
<li>Since data is read in packets, it is easier to compress. Data in columns is also easier to compress. This further reduces the I/O volume.</li>
<li>Due to the reduced I/O, more data fits in the system cache.</li>
</ol>
<p>For example, the query "count the number of records for each advertising platform" requires reading one "advertising platform ID" column, which takes up 1 byte uncompressed. If most of the traffic was not from advertising platforms, you can expect at least 10-fold compression of this column. When using a quick compression algorithm, data decompression is possible at a speed of at least several gigabytes of uncompressed data per second. In other words, this query can be processed at a speed of approximately several billion rows per second on a single server. This speed is actually achieved in practice.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span>milovidov@hostname:~$ clickhouse-client
ClickHouse client version <span class="m">0</span>.0.52053.
Connecting to localhost:9000.
Connected to ClickHouse server version <span class="m">0</span>.0.52053.

:<span class="o">)</span> SELECT CounterID, count<span class="o">()</span> FROM hits GROUP BY CounterID ORDER BY count<span class="o">()</span> DESC LIMIT <span class="m">20</span>

SELECT
    CounterID,
    count<span class="o">()</span>
FROM hits
GROUP BY CounterID
ORDER BY count<span class="o">()</span> DESC
LIMIT <span class="m">20</span>

┌─CounterID─┬──count<span class="o">()</span>─┐
│    <span class="m">114208</span> │ <span class="m">56057344</span> │
│    <span class="m">115080</span> │ <span class="m">51619590</span> │
│      <span class="m">3228</span> │ <span class="m">44658301</span> │
│     <span class="m">38230</span> │ <span class="m">42045932</span> │
│    <span class="m">145263</span> │ <span class="m">42042158</span> │
│     <span class="m">91244</span> │ <span class="m">38297270</span> │
│    <span class="m">154139</span> │ <span class="m">26647572</span> │
│    <span class="m">150748</span> │ <span class="m">24112755</span> │
│    <span class="m">242232</span> │ <span class="m">21302571</span> │
│    <span class="m">338158</span> │ <span class="m">13507087</span> │
│     <span class="m">62180</span> │ <span class="m">12229491</span> │
│     <span class="m">82264</span> │ <span class="m">12187441</span> │
│    <span class="m">232261</span> │ <span class="m">12148031</span> │
│    <span class="m">146272</span> │ <span class="m">11438516</span> │
│    <span class="m">168777</span> │ <span class="m">11403636</span> │
│   <span class="m">4120072</span> │ <span class="m">11227824</span> │
│  <span class="m">10938808</span> │ <span class="m">10519739</span> │
│     <span class="m">74088</span> │  <span class="m">9047015</span> │
│    <span class="m">115079</span> │  <span class="m">8837972</span> │
│    <span class="m">337234</span> │  <span class="m">8205961</span> │
└───────────┴──────────┘

<span class="m">20</span> rows in set. Elapsed: <span class="m">0</span>.153 sec. Processed <span class="m">1</span>.00 billion rows, <span class="m">4</span>.00 GB <span class="o">(</span><span class="m">6</span>.53 billion rows/s., <span class="m">26</span>.10 GB/s.<span class="o">)</span>

:<span class="o">)</span>
</pre></div>


<ol>
<li>For CPU.</li>
</ol>
<p>Since executing a query requires processing a large number of rows, it helps to dispatch all operations for entire vectors instead of for separate rows, or to implement the query engine so that there is almost no dispatching cost. If you don't do this, with any half-decent disk subsystem, the query interpreter inevitably stalls the CPU.
It makes sense to both store data in columns and process it, when possible, by columns.</p>
<p>There are two ways to do this:</p>
<ol>
<li>
<p>A vector engine. All operations are written for vectors, instead of for separate values. This means you don't need to call operations very often, and dispatching costs are negligible. Operation code contains an optimized internal cycle.</p>
</li>
<li>
<p>Code generation. The code generated for the query has all the indirect calls in it.</p>
</li>
</ol>
<p>This is not done in "normal" databases, because it doesn't make sense when running simple queries. However, there are exceptions. For example, MemSQL uses code generation to reduce latency when processing SQL queries. (For comparison, analytical DBMSs require optimization of throughput, not latency.)</p>
<p>Note that for CPU efficiency, the query language must be declarative (SQL or MDX), or at least a vector (J, K). The query should only contain implicit loops, allowing for optimization.</p>
<h2 id="introduction">Introduction</h2>
<h2 id="distinctive-features-of-clickhouse">Distinctive features of ClickHouse</h2>
<h3 id="true-column-oriented-dbms">True column-oriented DBMS</h3>
<p>In a true column-oriented DBMS, there isn't any "garbage" stored with the values. Among other things, this means that constant-length values must be supported, to avoid storing their length "number" next to the values. As an example, a billion UInt8-type values should actually consume around 1 GB uncompressed, or this will strongly affect the CPU use. It is very important to store data compactly (without any "garbage") even when uncompressed, since the speed of decompression (CPU usage) depends mainly on the volume of uncompressed data.</p>
<p>This is worth noting because there are systems that can store values of separate columns separately, but that can't effectively process analytical queries due to their optimization for other scenarios. Examples are HBase, BigTable, Cassandra, and HyperTable. In these systems, you will get throughput around a hundred thousand rows per second, but not hundreds of millions of rows per second.</p>
<p>Also note that ClickHouse is a DBMS, not a single database. ClickHouse allows creating tables and databases in runtime, loading data, and running queries without reconfiguring and restarting the server.</p>
<h3 id="data-compression">Data compression</h3>
<p>Some column-oriented DBMSs (InfiniDB CE and MonetDB) do not use data compression. However, data compression really improves performance.</p>
<h3 id="disk-storage-of-data">Disk storage of data</h3>
<p>Many column-oriented DBMSs (such as SAP HANA and Google PowerDrill) can only work in RAM. But even on thousands of servers, the RAM is too small for storing all the pageviews and sessions in Yandex.Metrica.</p>
<h3 id="parallel-processing-on-multiple-cores">Parallel processing on multiple cores</h3>
<p>Large queries are parallelized in a natural way.</p>
<h3 id="distributed-processing-on-multiple-servers">Distributed processing on multiple servers</h3>
<p>Almost none of the columnar DBMSs listed above have support for distributed processing.
In ClickHouse, data can reside on different shards. Each shard can be a group of replicas that are used for fault tolerance. The query is processed on all the shards in parallel. This is transparent for the user.</p>
<h3 id="sql-support">SQL support</h3>
<p>If you are familiar with standard SQL, we can't really talk about SQL support.
All the functions have different names.
However, this is a declarative query language based on SQL that can't be differentiated from SQL in many instances.
JOINs are supported. Subqueries are supported in FROM, IN, and JOIN clauses, as well as scalar subqueries.
Dependent subqueries are not supported.</p>
<h3 id="vector-engine">Vector engine</h3>
<p>Data is not only stored by columns, but is processed by vectors (parts of columns). This allows us to achieve high CPU performance.</p>
<h3 id="real-time-data-updates">Real-time data updates</h3>
<p>ClickHouse supports primary key tables. In order to quickly perform queries on the range of the primary key, the data is sorted incrementally using the merge tree. Due to this, data can continually be added to the table. There is no locking when adding data.</p>
<h3 id="indexes">Indexes</h3>
<p>Having a primary key makes it possible to extract data for specific clients (for instance, Yandex.Metrica tracking tags) for a specific time range, with low latency less than several dozen milliseconds.</p>
<h3 id="suitable-for-online-queries">Suitable for online queries</h3>
<p>This lets us use the system as the back-end for a web interface. Low latency means queries can be processed without delay, while the Yandex.Metrica interface page is loading. In other words, in online mode.</p>
<h3 id="support-for-approximated-calculations">Support for approximated calculations</h3>
<ol>
<li>The system contains aggregate functions for approximated calculation of the number of various values, medians, and quantiles.</li>
<li>Supports running a query based on a part (sample) of data and getting an approximated result. In this case, proportionally less data is retrieved from the disk.</li>
<li>Supports running an aggregation for a limited number of random keys, instead of for all keys. Under certain conditions for key distribution in the data, this provides a reasonably accurate result while using fewer resources.</li>
</ol>
<h3 id="data-replication-and-support-for-data-integrity-on-replicas">Data replication and support for data integrity on replicas</h3>
<p>Uses asynchronous multimaster replication. After being written to any available replica, data is distributed to all the remaining replicas. The system maintains identical data on different replicas. Data is restored automatically after a failure, or using a "button" for complex cases.
For more information, see the section <a href="#table_engines-replication">Data replication</a>.</p>
<h2 id="clickhouse-features-that-can-be-considered-disadvantages">ClickHouse features that can be considered disadvantages</h2>
<ol>
<li>No transactions.</li>
<li>For aggregation, query results must fit in the RAM on a single server. However, the volume of source data for a query may be indefinitely large.</li>
<li>Lack of full-fledged UPDATE/DELETE implementation.</li>
</ol>
<h2 id="yandexmetrica-use-case">Yandex.Metrica use case</h2>
<p>ClickHouse currently powers <a href="https://metrica.yandex.com/">Yandex.Metrica</a>, <a href="http://w3techs.com/technologies/overview/traffic_analysis/all">the second largest web analytics platform in the world</a>. With more than 13 trillion records in the database and more than 20 billion events daily, ClickHouse allows you generating custom reports on the fly directly from non-aggregated data.</p>
<p>We need to get custom reports based on hits and sessions, with custom segments set by the user. Data for the reports is updated in real-time. Queries must be run immediately (in online mode). We must be able to build reports for any time period. Complex aggregates must be calculated, such as the number of unique visitors.
At this time (April 2014), Yandex.Metrica receives approximately 12 billion events (pageviews and mouse clicks) daily. All these events must be stored in order to build custom reports. A single query may require scanning hundreds of millions of rows over a few seconds, or millions of rows in no more than a few hundred milliseconds.</p>
<h3 id="usage-in-yandexmetrica-and-other-yandex-services">Usage in Yandex.Metrica and other Yandex services</h3>
<p>ClickHouse is used for multiple purposes in Yandex.Metrica.
Its main task is to build reports in online mode using non-aggregated data. It uses a cluster of 374 servers, which store over 20.3 trillion rows in the database. The volume of compressed data, without counting duplication and replication, is about 2 PB. The volume of uncompressed data (in TSV format) would be approximately 17 PB.</p>
<p>ClickHouse is also used for:</p>
<ul>
<li>Storing data for Session Replay from Yandex.Metrica.</li>
<li>Processing intermediate data.</li>
<li>Building global reports with Analytics.</li>
<li>Running queries for debugging the Yandex.Metrica engine.</li>
<li>Analyzing logs from the API and the user interface.</li>
</ul>
<p>ClickHouse has at least a dozen installations in other Yandex services: in search verticals, Market, Direct, business analytics, mobile development, AdFox, personal services, and others.</p>
<h3 id="aggregated-and-non-aggregated-data">Aggregated and non-aggregated data</h3>
<p>There is a popular opinion that in order to effectively calculate statistics, you must aggregate data, since this reduces the volume of data.</p>
<p>But data aggregation is a very limited solution, for the following reasons:</p>
<ul>
<li>You must have a pre-defined list of reports the user will need.</li>
<li>The user can't make custom reports.</li>
<li>When aggregating a large quantity of keys, the volume of data is not reduced, and aggregation is useless.</li>
<li>For a large number of reports, there are too many aggregation variations (combinatorial explosion).</li>
<li>When aggregating keys with high cardinality (such as URLs), the volume of data is not reduced by much (less than twofold).</li>
<li>For this reason, the volume of data with aggregation might grow instead of shrink.</li>
<li>Users do not view all the reports we generate for them. A large portion of calculations are useless.</li>
<li>The logical integrity of data may be violated for various aggregations.</li>
</ul>
<p>If we do not aggregate anything and work with non-aggregated data, this might actually reduce the volume of calculations.</p>
<p>However, with aggregation, a significant part of the work is taken offline and completed relatively calmly. In contrast, online calculations require calculating as fast as possible, since the user is waiting for the result.</p>
<p>Yandex.Metrica has a specialized system for aggregating data called Metrage, which is used for the majority of reports.
Starting in 2009, Yandex.Metrica also used a specialized OLAP database for non-aggregated data called OLAPServer, which was previously used for the report builder.
OLAPServer worked well for non-aggregated data, but it had many restrictions that did not allow it to be used for all reports as desired. These included the lack of support for data types (only numbers), and the inability to incrementally update data in real-time (it could only be done by rewriting data daily). OLAPServer is not a DBMS, but a specialized DB.</p>
<p>To remove the limitations of OLAPServer and solve the problem of working with non-aggregated data for all reports, we developed the ClickHouse DBMS.</p>
<h2 id="questions-you-were-afraid-to-ask">Questions you were afraid to ask</h2>
<h3 id="why-not-use-something-like-mapreduce">Why not use something like MapReduce?</h3>
<p>We can refer to systems like map-reduce as distributed computing systems in which the reduce operation is based on distributed sorting. In this sense, they include Hadoop, and YT (YT is developed at Yandex for internal use).</p>
<p>These systems aren't appropriate for online queries due to their high latency. In other words, they can't be used as the back-end for a web interface.
These types of systems aren't useful for real-time data updates.
Distributed sorting isn't the best way to perform reduce operations if the result of the operation and all the intermediate results (if there are any) are located in the RAM of a single server, which is usually the case for online queries. In such a case, a hash table is the optimal way to perform reduce operations. A common approach to optimizing map-reduce tasks is pre-aggregation (partial reduce) using a hash table in RAM. The user performs this optimization manually.
Distributed sorting is one of the main causes of reduced performance when running simple map-reduce tasks.</p>
<p>Systems like map-reduce allow executing any code on the cluster. But a declarative query language is better suited to OLAP in order to run experiments quickly. For example, Hadoop has Hive and Pig. Also consider Cloudera Impala, Shark (outdated) for Spark, and Spark SQL, Presto, and Apache Drill. Performance when running such tasks is highly sub-optimal compared to specialized systems, but relatively high latency makes it unrealistic to use these systems as the backend for a web interface.</p>
<p>YT allows storing groups of columns separately. But YT can't be considered a true column-based system because it doesn't have fixed-length data types (for efficiently storing numbers without extra "garbage"), and also due to its lack of a vector engine. Tasks are performed  in YT using custom code in streaming mode, so they cannot be optimized enough (up to hundreds of millions of rows per second per server). "Dynamic table sorting" is under development in YT using MergeTree, strict value typing, and a query language similar to SQL. Dynamically sorted tables are not appropriate for OLAP tasks because the data is stored by row. The YT query language is still under development, so we can't yet rely on this functionality. YT developers are considering using dynamically sorted tables in OLTP and Key-Value scenarios.</p>
<h2 id="performance">Performance</h2>
<p>According to internal testing results, ClickHouse shows the best performance for comparable operating scenarios among systems of its class that were available for testing. This includes the highest throughput for long queries, and the lowest latency on short queries. Testing results are shown on a separate page.</p>
<h3 id="throughput-for-a-single-large-query">Throughput for a single large query</h3>
<p>Throughput can be measured in rows per second or in megabytes per second. If the data is placed in the page cache, a query that is not too complex is processed on modern hardware at a speed of approximately 2-10 GB/s of uncompressed data on a single server (for the simplest cases, the speed may reach 30 GB/s). If data is not placed in the page cache, the speed depends on the disk subsystem and the data compression rate. For example, if the disk subsystem allows reading data at 400 MB/s, and the data compression rate is 3, the speed will be around 1.2 GB/s. To get the speed in rows per second, divide the speed in bytes per second by the total size of the columns used in the query. For example, if 10 bytes of columns are extracted, the speed will be around 100-200 million rows per second.</p>
<p>The processing speed increases almost linearly for distributed processing, but only if the number of rows resulting from aggregation or sorting is not too large.</p>
<h3 id="latency-when-processing-short-queries">Latency when processing short queries</h3>
<p>If a query uses a primary key and does not select too many rows to process (hundreds of thousands), and does not use too many columns, we can expect less than 50 milliseconds of latency (single digits of milliseconds in the best case) if data is placed in the page cache. Otherwise, latency is calculated from the number of seeks. If you use rotating drives, for a system that is not overloaded, the latency is calculated by this formula: seek time (10 ms) * number of columns queried * number of data parts.</p>
<h3 id="throughput-when-processing-a-large-quantity-of-short-queries">Throughput when processing a large quantity of short queries</h3>
<p>Under the same conditions, ClickHouse can handle several hundred queries per second on a single server (up to several thousand in the best case). Since this scenario is not typical for analytical DBMSs, we recommend expecting a maximum of 100 queries per second.</p>
<h3 id="performance-when-inserting-data">Performance when inserting data</h3>
<p>We recommend inserting data in packets of at least 1000 rows, or no more than a single request per second. When inserting to a MergeTree table from a tab-separated dump, the insertion speed will be from 50 to 200 MB/s. If the inserted rows are around 1 Kb in size, the speed will be from 50,000 to 200,000 rows per second. If the rows are small, the performance will be higher in rows per second (on Banner System data -<code>&gt;</code> 500,000 rows per second; on Graphite data -<code>&gt;</code> 1,000,000 rows per second). To improve performance, you can make multiple INSERT queries in parallel, and performance will increase linearly.</p>
<h2 id="getting-started">Getting started</h2>
<h3 id="system-requirements">System requirements</h3>
<p>This is not a cross-platform system. It requires Linux Ubuntu Precise (12.04) or newer, with x86_64 architecture and support for the SSE 4.2 instruction set.
To check for SSE 4.2:</p>
<div class="codehilite"><pre><span></span>grep -q sse4_2 /proc/cpuinfo <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;SSE 4.2 supported&quot;</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">&quot;SSE 4.2 not supported&quot;</span>
</pre></div>


<p>We recommend using Ubuntu Trusty, Ubuntu Xenial, or Ubuntu Precise.
The terminal must use UTF-8 encoding (the default in Ubuntu).</p>
<h3 id="installation">Installation</h3>
<p>For testing and development, the system can be installed on a single server or on a desktop computer.</p>
<h4 id="installing-from-packages-for-debianubuntu">Installing from packages for Debian/Ubuntu</h4>
<p>In <code>/etc/apt/sources.list</code> (or in a separate <code>/etc/apt/sources.list.d/clickhouse.list</code> file), add the repository:</p>
<div class="codehilite"><pre><span></span>deb http://repo.yandex.ru/clickhouse/deb/stable/ main/
</pre></div>


<p>If you want to use the most recent test version, replace 'stable' with 'testing'.</p>
<p>Then run:</p>
<div class="codehilite"><pre><span></span>sudo apt-key adv --keyserver keyserver.ubuntu.com --recv E0C56BD4    <span class="c1"># optional</span>
sudo apt-get update
sudo apt-get install clickhouse-client clickhouse-server
</pre></div>


<p>You can also download and install packages manually from here: <a href="https://repo.yandex.ru/clickhouse/deb/stable/main/">https://repo.yandex.ru/clickhouse/deb/stable/main/</a>.</p>
<p>ClickHouse contains access restriction settings. They are located in the 'users.xml' file (next to 'config.xml').
By default, access is allowed from anywhere for the 'default' user, without a password. See 'user/default/networks'.
For more information, see the section "Configuration files".</p>
<h4 id="installing-from-sources">Installing from sources</h4>
<p>To compile, follow the instructions: build.md</p>
<p>You can compile packages and install them.
You can also use programs without installing packages.</p>
<div class="codehilite"><pre><span></span>Client: dbms/src/Client/
Server: dbms/src/Server/
</pre></div>


<p>For the server, create a catalog with data, such as:</p>
<div class="codehilite"><pre><span></span>/opt/clickhouse/data/default/
/opt/clickhouse/metadata/default/
</pre></div>


<p>(Configurable in the server config.)
Run 'chown' for the desired user.</p>
<p>Note the path to logs in the server config (src/dbms/src/Server/config.xml).</p>
<h4 id="other-installation-methods">Other installation methods</h4>
<p>Docker image: <a href="https://hub.docker.com/r/yandex/clickhouse-server/">https://hub.docker.com/r/yandex/clickhouse-server/</a></p>
<p>RPM packages for CentOS or RHEL: <a href="https://github.com/Altinity/clickhouse-rpm-install">https://github.com/Altinity/clickhouse-rpm-install</a></p>
<p>Gentoo overlay: <a href="https://github.com/kmeaw/clickhouse-overlay">https://github.com/kmeaw/clickhouse-overlay</a></p>
<h3 id="launch">Launch</h3>
<p>To start the server (as a daemon), run:</p>
<div class="codehilite"><pre><span></span>sudo service clickhouse-server start
</pre></div>


<p>See the logs in the <code>/var/log/clickhouse-server/ directory.</code></p>
<p>If the server doesn't start, check the configurations in the file <code>/etc/clickhouse-server/config.xml.</code></p>
<p>You can also launch the server from the console:</p>
<div class="codehilite"><pre><span></span>clickhouse-server --config-file<span class="o">=</span>/etc/clickhouse-server/config.xml
</pre></div>


<p>In this case, the log will be printed to the console, which is convenient during development.
If the configuration file is in the current directory, you don't need to specify the '--config-file' parameter. By default, it uses './config.xml'.</p>
<p>You can use the command-line client to connect to the server:</p>
<div class="codehilite"><pre><span></span>clickhouse-client
</pre></div>


<p>The default parameters indicate connecting with localhost:9000 on behalf of the user 'default' without a password.
The client can be used for connecting to a remote server. Example:</p>
<div class="codehilite"><pre><span></span>clickhouse-client --host<span class="o">=</span>example.com
</pre></div>


<p>For more information, see the section "Command-line client".</p>
<p>Checking the system:</p>
<div class="codehilite"><pre><span></span>milovidov@hostname:~/work/metrica/src/dbms/src/Client$ ./clickhouse-client
ClickHouse client version <span class="m">0</span>.0.18749.
Connecting to localhost:9000.
Connected to ClickHouse server version <span class="m">0</span>.0.18749.

:<span class="o">)</span> SELECT <span class="m">1</span>

SELECT <span class="m">1</span>

┌─1─┐
│ <span class="m">1</span> │
└───┘

<span class="m">1</span> rows in set. Elapsed: <span class="m">0</span>.003 sec.

:<span class="o">)</span>
</pre></div>


<p><strong>Congratulations, the system works!</strong></p>
<p>To continue experimenting, you can try to download from the test data sets.</p>
<p><a name="example_datasets-ontime"></a></p>
<h2 id="ontime">OnTime</h2>
<p>This performance test was created by Vadim Tkachenko. See:</p>
<ul>
<li><a href="https://www.percona.com/blog/2009/10/02/analyzing-air-traffic-performance-with-infobright-and-monetdb/">https://www.percona.com/blog/2009/10/02/analyzing-air-traffic-performance-with-infobright-and-monetdb/</a></li>
<li><a href="https://www.percona.com/blog/2009/10/26/air-traffic-queries-in-luciddb/">https://www.percona.com/blog/2009/10/26/air-traffic-queries-in-luciddb/</a></li>
<li><a href="https://www.percona.com/blog/2009/11/02/air-traffic-queries-in-infinidb-early-alpha/">https://www.percona.com/blog/2009/11/02/air-traffic-queries-in-infinidb-early-alpha/</a></li>
<li><a href="https://www.percona.com/blog/2014/04/21/using-apache-hadoop-and-impala-together-with-mysql-for-data-analysis/">https://www.percona.com/blog/2014/04/21/using-apache-hadoop-and-impala-together-with-mysql-for-data-analysis/</a></li>
<li><a href="https://www.percona.com/blog/2016/01/07/apache-spark-with-air-ontime-performance-data/">https://www.percona.com/blog/2016/01/07/apache-spark-with-air-ontime-performance-data/</a></li>
<li><a href="http://nickmakos.blogspot.ru/2012/08/analyzing-air-traffic-performance-with.html">http://nickmakos.blogspot.ru/2012/08/analyzing-air-traffic-performance-with.html</a></li>
</ul>
<p>Downloading data:</p>
<div class="codehilite"><pre><span></span><span class="k">for</span> s in <span class="sb">`</span>seq <span class="m">1987</span> <span class="m">2017</span><span class="sb">`</span>
<span class="k">do</span>
<span class="k">for</span> m in <span class="sb">`</span>seq <span class="m">1</span> <span class="m">12</span><span class="sb">`</span>
<span class="k">do</span>
wget http://transtats.bts.gov/PREZIP/On_Time_On_Time_Performance_<span class="si">${</span><span class="nv">s</span><span class="si">}</span>_<span class="si">${</span><span class="nv">m</span><span class="si">}</span>.zip
<span class="k">done</span>
<span class="k">done</span>
</pre></div>


<p>(from <a href="https://github.com/Percona-Lab/ontime-airline-performance/blob/master/download.sh">https://github.com/Percona-Lab/ontime-airline-performance/blob/master/download.sh</a> )</p>
<p>Creating a table:</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">ontime</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="k">Year</span><span class="o">`</span> <span class="n">UInt16</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Quarter</span><span class="o">`</span> <span class="n">UInt8</span><span class="p">,</span>
  <span class="o">`</span><span class="k">Month</span><span class="o">`</span> <span class="n">UInt8</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DayofMonth</span><span class="o">`</span> <span class="n">UInt8</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DayOfWeek</span><span class="o">`</span> <span class="n">UInt8</span><span class="p">,</span>
  <span class="o">`</span><span class="n">FlightDate</span><span class="o">`</span> <span class="nb">Date</span><span class="p">,</span>
  <span class="o">`</span><span class="n">UniqueCarrier</span><span class="o">`</span> <span class="n">FixedString</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
  <span class="o">`</span><span class="n">AirlineID</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Carrier</span><span class="o">`</span> <span class="n">FixedString</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
  <span class="o">`</span><span class="n">TailNum</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">FlightNum</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">OriginAirportID</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">OriginAirportSeqID</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">OriginCityMarketID</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Origin</span><span class="o">`</span> <span class="n">FixedString</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
  <span class="o">`</span><span class="n">OriginCityName</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">OriginState</span><span class="o">`</span> <span class="n">FixedString</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
  <span class="o">`</span><span class="n">OriginStateFips</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">OriginStateName</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">OriginWac</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DestAirportID</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DestAirportSeqID</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DestCityMarketID</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Dest</span><span class="o">`</span> <span class="n">FixedString</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
  <span class="o">`</span><span class="n">DestCityName</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DestState</span><span class="o">`</span> <span class="n">FixedString</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
  <span class="o">`</span><span class="n">DestStateFips</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DestStateName</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DestWac</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">CRSDepTime</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DepTime</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DepDelay</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DepDelayMinutes</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DepDel15</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DepartureDelayGroups</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DepTimeBlk</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">TaxiOut</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">WheelsOff</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">WheelsOn</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">TaxiIn</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">CRSArrTime</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">ArrTime</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">ArrDelay</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">ArrDelayMinutes</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">ArrDel15</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">ArrivalDelayGroups</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">ArrTimeBlk</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Cancelled</span><span class="o">`</span> <span class="n">UInt8</span><span class="p">,</span>
  <span class="o">`</span><span class="n">CancellationCode</span><span class="o">`</span> <span class="n">FixedString</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
  <span class="o">`</span><span class="n">Diverted</span><span class="o">`</span> <span class="n">UInt8</span><span class="p">,</span>
  <span class="o">`</span><span class="n">CRSElapsedTime</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">ActualElapsedTime</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">AirTime</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Flights</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Distance</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DistanceGroup</span><span class="o">`</span> <span class="n">UInt8</span><span class="p">,</span>
  <span class="o">`</span><span class="n">CarrierDelay</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">WeatherDelay</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">NASDelay</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">SecurityDelay</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">LateAircraftDelay</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">FirstDepTime</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">TotalAddGTime</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">LongestAddGTime</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DivAirportLandings</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DivReachedDest</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DivActualElapsedTime</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DivArrDelay</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">DivDistance</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div1Airport</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div1AirportID</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div1AirportSeqID</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div1WheelsOn</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div1TotalGTime</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div1LongestGTime</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div1WheelsOff</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div1TailNum</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div2Airport</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div2AirportID</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div2AirportSeqID</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div2WheelsOn</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div2TotalGTime</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div2LongestGTime</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div2WheelsOff</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div2TailNum</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div3Airport</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div3AirportID</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div3AirportSeqID</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div3WheelsOn</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div3TotalGTime</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div3LongestGTime</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div3WheelsOff</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div3TailNum</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div4Airport</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div4AirportID</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div4AirportSeqID</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div4WheelsOn</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div4TotalGTime</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div4LongestGTime</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div4WheelsOff</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div4TailNum</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div5Airport</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div5AirportID</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div5AirportSeqID</span><span class="o">`</span> <span class="n">Int32</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div5WheelsOn</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div5TotalGTime</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div5LongestGTime</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div5WheelsOff</span><span class="o">`</span> <span class="n">String</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Div5TailNum</span><span class="o">`</span> <span class="n">String</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">MergeTree</span><span class="p">(</span><span class="n">FlightDate</span><span class="p">,</span> <span class="p">(</span><span class="k">Year</span><span class="p">,</span> <span class="n">FlightDate</span><span class="p">),</span> <span class="mi">8192</span><span class="p">)</span>
</pre></div>


<p>Loading data:</p>
<div class="codehilite"><pre><span></span><span class="k">for</span> i in *.zip<span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="nv">$i</span><span class="p">;</span> unzip -cq <span class="nv">$i</span> <span class="s1">&#39;*.csv&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/\.00//g&#39;</span> <span class="p">|</span> clickhouse-client --host<span class="o">=</span>example-perftest01j --query<span class="o">=</span><span class="s2">&quot;INSERT INTO ontime FORMAT CSVWithNames&quot;</span><span class="p">;</span> <span class="k">done</span>
</pre></div>


<p>Queries:</p>
<p>Q0.</p>
<div class="codehilite"><pre><span></span><span class="k">select</span> <span class="k">avg</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span> <span class="k">from</span> <span class="p">(</span><span class="k">select</span> <span class="k">Year</span><span class="p">,</span> <span class="k">Month</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">c1</span> <span class="k">from</span> <span class="n">ontime</span> <span class="k">group</span> <span class="k">by</span> <span class="k">Year</span><span class="p">,</span> <span class="k">Month</span><span class="p">);</span>
</pre></div>


<p>Q1. The number of flights per day from the year 2000 to 2008</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">DayOfWeek</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="k">c</span> <span class="k">FROM</span> <span class="n">ontime</span> <span class="k">WHERE</span> <span class="k">Year</span> <span class="o">&gt;=</span> <span class="mi">2000</span> <span class="k">AND</span> <span class="k">Year</span> <span class="o">&lt;=</span> <span class="mi">2008</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">DayOfWeek</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">c</span> <span class="k">DESC</span><span class="p">;</span>
</pre></div>


<p>Q2. The number of flights delayed by more than 10 minutes, grouped by the day of the week, for 2000-2008</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">DayOfWeek</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="k">c</span> <span class="k">FROM</span> <span class="n">ontime</span> <span class="k">WHERE</span> <span class="n">DepDelay</span><span class="o">&gt;</span><span class="mi">10</span> <span class="k">AND</span> <span class="k">Year</span> <span class="o">&gt;=</span> <span class="mi">2000</span> <span class="k">AND</span> <span class="k">Year</span> <span class="o">&lt;=</span> <span class="mi">2008</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">DayOfWeek</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">c</span> <span class="k">DESC</span>
</pre></div>


<p>Q3. The number of delays by airport for 2000-2008</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">Origin</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="k">c</span> <span class="k">FROM</span> <span class="n">ontime</span> <span class="k">WHERE</span> <span class="n">DepDelay</span><span class="o">&gt;</span><span class="mi">10</span> <span class="k">AND</span> <span class="k">Year</span> <span class="o">&gt;=</span> <span class="mi">2000</span> <span class="k">AND</span> <span class="k">Year</span> <span class="o">&lt;=</span> <span class="mi">2008</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">Origin</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">c</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">10</span>
</pre></div>


<p>Q4. The number of delays by carrier for 2007</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">Carrier</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">ontime</span> <span class="k">WHERE</span> <span class="n">DepDelay</span><span class="o">&gt;</span><span class="mi">10</span>  <span class="k">AND</span> <span class="k">Year</span> <span class="o">=</span> <span class="mi">2007</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">Carrier</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">DESC</span>
</pre></div>


<p>Q5. The percentage of delays by carrier for 2007</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">Carrier</span><span class="p">,</span> <span class="k">c</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="k">c</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span><span class="n">c2</span> <span class="k">as</span> <span class="n">c3</span>
<span class="k">FROM</span>
<span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">Carrier</span><span class="p">,</span>
        <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="k">c</span>
    <span class="k">FROM</span> <span class="n">ontime</span>
    <span class="k">WHERE</span> <span class="n">DepDelay</span><span class="o">&gt;</span><span class="mi">10</span>
        <span class="k">AND</span> <span class="k">Year</span><span class="o">=</span><span class="mi">2007</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">Carrier</span>
<span class="p">)</span>
<span class="k">ANY</span> <span class="k">INNER</span> <span class="k">JOIN</span>
<span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">Carrier</span><span class="p">,</span>
        <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">c2</span>
    <span class="k">FROM</span> <span class="n">ontime</span>
    <span class="k">WHERE</span> <span class="k">Year</span><span class="o">=</span><span class="mi">2007</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">Carrier</span>
<span class="p">)</span> <span class="k">USING</span> <span class="n">Carrier</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">c3</span> <span class="k">DESC</span><span class="p">;</span>
</pre></div>


<p>Better version of the same query:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">Carrier</span><span class="p">,</span> <span class="k">avg</span><span class="p">(</span><span class="n">DepDelay</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="k">AS</span> <span class="n">c3</span> <span class="k">FROM</span> <span class="n">ontime</span> <span class="k">WHERE</span> <span class="k">Year</span> <span class="o">=</span> <span class="mi">2007</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">Carrier</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">Carrier</span>
</pre></div>


<p>Q6. The previous request for a broader range of years, 2000-2008</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">Carrier</span><span class="p">,</span> <span class="k">c</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="k">c</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span><span class="n">c2</span> <span class="k">as</span> <span class="n">c3</span>
<span class="k">FROM</span>
<span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">Carrier</span><span class="p">,</span>
        <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="k">c</span>
    <span class="k">FROM</span> <span class="n">ontime</span>
    <span class="k">WHERE</span> <span class="n">DepDelay</span><span class="o">&gt;</span><span class="mi">10</span>
        <span class="k">AND</span> <span class="k">Year</span> <span class="o">&gt;=</span> <span class="mi">2000</span> <span class="k">AND</span> <span class="k">Year</span> <span class="o">&lt;=</span> <span class="mi">2008</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">Carrier</span>
<span class="p">)</span>
<span class="k">ANY</span> <span class="k">INNER</span> <span class="k">JOIN</span>
<span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">Carrier</span><span class="p">,</span>
        <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">c2</span>
    <span class="k">FROM</span> <span class="n">ontime</span>
    <span class="k">WHERE</span> <span class="k">Year</span> <span class="o">&gt;=</span> <span class="mi">2000</span> <span class="k">AND</span> <span class="k">Year</span> <span class="o">&lt;=</span> <span class="mi">2008</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">Carrier</span>
<span class="p">)</span> <span class="k">USING</span> <span class="n">Carrier</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">c3</span> <span class="k">DESC</span><span class="p">;</span>
</pre></div>


<p>Better version of the same query:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">Carrier</span><span class="p">,</span> <span class="k">avg</span><span class="p">(</span><span class="n">DepDelay</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="k">AS</span> <span class="n">c3</span> <span class="k">FROM</span> <span class="n">ontime</span> <span class="k">WHERE</span> <span class="k">Year</span> <span class="o">&gt;=</span> <span class="mi">2000</span> <span class="k">AND</span> <span class="k">Year</span> <span class="o">&lt;=</span> <span class="mi">2008</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">Carrier</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">Carrier</span>
</pre></div>


<p>Q7. Percentage of flights delayed for more than 10 minutes, by year</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="k">Year</span><span class="p">,</span> <span class="n">c1</span><span class="o">/</span><span class="n">c2</span>
<span class="k">FROM</span>
<span class="p">(</span>
    <span class="k">select</span>
        <span class="k">Year</span><span class="p">,</span>
        <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span> <span class="k">as</span> <span class="n">c1</span>
    <span class="k">from</span> <span class="n">ontime</span>
    <span class="k">WHERE</span> <span class="n">DepDelay</span><span class="o">&gt;</span><span class="mi">10</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="k">Year</span>
<span class="p">)</span>
<span class="k">ANY</span> <span class="k">INNER</span> <span class="k">JOIN</span>
<span class="p">(</span>
    <span class="k">select</span>
        <span class="k">Year</span><span class="p">,</span>
        <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">c2</span>
    <span class="k">from</span> <span class="n">ontime</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="k">Year</span>
<span class="p">)</span> <span class="k">USING</span> <span class="p">(</span><span class="k">Year</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">Year</span>
</pre></div>


<p>Better version of the same query:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="k">Year</span><span class="p">,</span> <span class="k">avg</span><span class="p">(</span><span class="n">DepDelay</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">ontime</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="k">Year</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">Year</span>
</pre></div>


<p>Q8. The most popular destinations by the number of directly connected cities for various year ranges</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">DestCityName</span><span class="p">,</span> <span class="n">uniqExact</span><span class="p">(</span><span class="n">OriginCityName</span><span class="p">)</span> <span class="k">AS</span> <span class="n">u</span> <span class="k">FROM</span> <span class="n">ontime</span> <span class="k">WHERE</span> <span class="k">Year</span> <span class="o">&gt;=</span> <span class="mi">2000</span> <span class="k">and</span> <span class="k">Year</span> <span class="o">&lt;=</span> <span class="mi">2010</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">DestCityName</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">u</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>


<p>Q9.</p>
<div class="codehilite"><pre><span></span><span class="k">select</span> <span class="k">Year</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">c1</span> <span class="k">from</span> <span class="n">ontime</span> <span class="k">group</span> <span class="k">by</span> <span class="k">Year</span><span class="p">;</span>
</pre></div>


<p>Q10.</p>
<div class="codehilite"><pre><span></span><span class="k">select</span>
   <span class="k">min</span><span class="p">(</span><span class="k">Year</span><span class="p">),</span> <span class="k">max</span><span class="p">(</span><span class="k">Year</span><span class="p">),</span> <span class="n">Carrier</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">cnt</span><span class="p">,</span>
   <span class="k">sum</span><span class="p">(</span><span class="n">ArrDelayMinutes</span><span class="o">&gt;</span><span class="mi">30</span><span class="p">)</span> <span class="k">as</span> <span class="n">flights_delayed</span><span class="p">,</span>
   <span class="n">round</span><span class="p">(</span><span class="k">sum</span><span class="p">(</span><span class="n">ArrDelayMinutes</span><span class="o">&gt;</span><span class="mi">30</span><span class="p">)</span><span class="o">/</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="n">rate</span>
<span class="k">FROM</span> <span class="n">ontime</span>
<span class="k">WHERE</span>
   <span class="n">DayOfWeek</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="k">and</span> <span class="n">OriginState</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">&#39;AK&#39;</span><span class="p">,</span> <span class="s1">&#39;HI&#39;</span><span class="p">,</span> <span class="s1">&#39;PR&#39;</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">)</span>
   <span class="k">and</span> <span class="n">DestState</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">&#39;AK&#39;</span><span class="p">,</span> <span class="s1">&#39;HI&#39;</span><span class="p">,</span> <span class="s1">&#39;PR&#39;</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">)</span>
   <span class="k">and</span> <span class="n">FlightDate</span> <span class="o">&lt;</span> <span class="s1">&#39;2010-01-01&#39;</span>
<span class="k">GROUP</span> <span class="k">by</span> <span class="n">Carrier</span>
<span class="k">HAVING</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">100000</span> <span class="k">and</span> <span class="k">max</span><span class="p">(</span><span class="k">Year</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1990</span>
<span class="k">ORDER</span> <span class="k">by</span> <span class="n">rate</span> <span class="k">DESC</span>
<span class="k">LIMIT</span> <span class="mi">1000</span><span class="p">;</span>
</pre></div>


<p>Bonus:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="k">avg</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="k">FROM</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">Year</span><span class="p">,</span><span class="k">Month</span><span class="p">,</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">cnt</span> <span class="k">FROM</span> <span class="n">ontime</span> <span class="k">WHERE</span> <span class="n">DepDel15</span><span class="o">=</span><span class="mi">1</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="k">Year</span><span class="p">,</span><span class="k">Month</span><span class="p">)</span>

<span class="k">select</span> <span class="k">avg</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span> <span class="k">from</span> <span class="p">(</span><span class="k">select</span> <span class="k">Year</span><span class="p">,</span><span class="k">Month</span><span class="p">,</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">c1</span> <span class="k">from</span> <span class="n">ontime</span> <span class="k">group</span> <span class="k">by</span> <span class="k">Year</span><span class="p">,</span><span class="k">Month</span><span class="p">)</span>

<span class="k">SELECT</span> <span class="n">DestCityName</span><span class="p">,</span> <span class="n">uniqExact</span><span class="p">(</span><span class="n">OriginCityName</span><span class="p">)</span> <span class="k">AS</span> <span class="n">u</span> <span class="k">FROM</span> <span class="n">ontime</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">DestCityName</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">u</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>

<span class="k">SELECT</span> <span class="n">OriginCityName</span><span class="p">,</span> <span class="n">DestCityName</span><span class="p">,</span> <span class="k">count</span><span class="p">()</span> <span class="k">AS</span> <span class="k">c</span> <span class="k">FROM</span> <span class="n">ontime</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">OriginCityName</span><span class="p">,</span> <span class="n">DestCityName</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">c</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>

<span class="k">SELECT</span> <span class="n">OriginCityName</span><span class="p">,</span> <span class="k">count</span><span class="p">()</span> <span class="k">AS</span> <span class="k">c</span> <span class="k">FROM</span> <span class="n">ontime</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">OriginCityName</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">c</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>


<h2 id="new-york-taxi-data">New York Taxi data</h2>
<h3 id="how-to-import-the-raw-data">How to import the raw data</h3>
<p>See <a href="https://github.com/toddwschneider/nyc-taxi-data">https://github.com/toddwschneider/nyc-taxi-data</a> and <a href="http://tech.marksblogg.com/billion-nyc-taxi-rides-redshift.html">http://tech.marksblogg.com/billion-nyc-taxi-rides-redshift.html</a> for the description of the dataset and instructions for downloading.</p>
<p>Downloading will result in about 227 GB of uncompressed data in CSV files. The download takes about an hour over a 1 Gbit connection (parallel downloading from s3.amazonaws.com recovers at least half of a 1 Gbit channel).
Some of the files might not download fully. Check the file sizes and re-download any that seem doubtful.</p>
<p>Some of the files might contain invalid rows. You can fix them as follows:</p>
<div class="codehilite"><pre><span></span>sed -E <span class="s1">&#39;/(.*,){18,}/d&#39;</span> data/yellow_tripdata_2010-02.csv &gt; data/yellow_tripdata_2010-02.csv_
sed -E <span class="s1">&#39;/(.*,){18,}/d&#39;</span> data/yellow_tripdata_2010-03.csv &gt; data/yellow_tripdata_2010-03.csv_
mv data/yellow_tripdata_2010-02.csv_ data/yellow_tripdata_2010-02.csv
mv data/yellow_tripdata_2010-03.csv_ data/yellow_tripdata_2010-03.csv
</pre></div>


<p>Then the data must be pre-processed in PostgreSQL. This will create selections of points in the polygons (to match points on the map with the boroughs of New York City) and combine all the data into a single denormalized flat table by using a JOIN. To do this, you will need to install PostgreSQL with PostGIS support.</p>
<p>Be careful when running <code>initialize_database.sh</code> and manually re-check that all the tables were created correctly.</p>
<p>It takes about 20-30 minutes to process each month's worth of data in PostgreSQL, for a total of about 48 hours.</p>
<p>You can check the number of downloaded rows as follows:</p>
<div class="codehilite"><pre><span></span>time psql nyc-taxi-data -c &quot;SELECT count(*) FROM trips;&quot;
###    count
 1298979494
(1 row)

real    7m9.164s
</pre></div>


<p>(This is slightly more than 1.1 billion rows reported by Mark Litwintschik in a series of blog posts.)</p>
<p>The data in PostgreSQL uses 370 GB of space.</p>
<p>Exporting the data from PostgreSQL:</p>
<div class="codehilite"><pre><span></span><span class="k">COPY</span>
<span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">trips</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">vendor_id</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">pickup_datetime</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">dropoff_datetime</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">store_and_fwd_flag</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">rate_code_id</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">pickup_longitude</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">pickup_latitude</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">dropoff_longitude</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">dropoff_latitude</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">passenger_count</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">trip_distance</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">fare_amount</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">extra</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">mta_tax</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">tip_amount</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">tolls_amount</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">ehail_fee</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">improvement_surcharge</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">total_amount</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">payment_type</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">trip_type</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">pickup</span><span class="p">,</span>
           <span class="n">trips</span><span class="p">.</span><span class="n">dropoff</span><span class="p">,</span>

           <span class="n">cab_types</span><span class="p">.</span><span class="k">type</span> <span class="n">cab_type</span><span class="p">,</span>

           <span class="n">weather</span><span class="p">.</span><span class="n">precipitation_tenths_of_mm</span> <span class="n">rain</span><span class="p">,</span>
           <span class="n">weather</span><span class="p">.</span><span class="n">snow_depth_mm</span><span class="p">,</span>
           <span class="n">weather</span><span class="p">.</span><span class="n">snowfall_mm</span><span class="p">,</span>
           <span class="n">weather</span><span class="p">.</span><span class="n">max_temperature_tenths_degrees_celsius</span> <span class="n">max_temp</span><span class="p">,</span>
           <span class="n">weather</span><span class="p">.</span><span class="n">min_temperature_tenths_degrees_celsius</span> <span class="n">min_temp</span><span class="p">,</span>
           <span class="n">weather</span><span class="p">.</span><span class="n">average_wind_speed_tenths_of_meters_per_second</span> <span class="n">wind</span><span class="p">,</span>

           <span class="n">pick_up</span><span class="p">.</span><span class="n">gid</span> <span class="n">pickup_nyct2010_gid</span><span class="p">,</span>
           <span class="n">pick_up</span><span class="p">.</span><span class="n">ctlabel</span> <span class="n">pickup_ctlabel</span><span class="p">,</span>
           <span class="n">pick_up</span><span class="p">.</span><span class="n">borocode</span> <span class="n">pickup_borocode</span><span class="p">,</span>
           <span class="n">pick_up</span><span class="p">.</span><span class="n">boroname</span> <span class="n">pickup_boroname</span><span class="p">,</span>
           <span class="n">pick_up</span><span class="p">.</span><span class="n">ct2010</span> <span class="n">pickup_ct2010</span><span class="p">,</span>
           <span class="n">pick_up</span><span class="p">.</span><span class="n">boroct2010</span> <span class="n">pickup_boroct2010</span><span class="p">,</span>
           <span class="n">pick_up</span><span class="p">.</span><span class="n">cdeligibil</span> <span class="n">pickup_cdeligibil</span><span class="p">,</span>
           <span class="n">pick_up</span><span class="p">.</span><span class="n">ntacode</span> <span class="n">pickup_ntacode</span><span class="p">,</span>
           <span class="n">pick_up</span><span class="p">.</span><span class="n">ntaname</span> <span class="n">pickup_ntaname</span><span class="p">,</span>
           <span class="n">pick_up</span><span class="p">.</span><span class="n">puma</span> <span class="n">pickup_puma</span><span class="p">,</span>

           <span class="n">drop_off</span><span class="p">.</span><span class="n">gid</span> <span class="n">dropoff_nyct2010_gid</span><span class="p">,</span>
           <span class="n">drop_off</span><span class="p">.</span><span class="n">ctlabel</span> <span class="n">dropoff_ctlabel</span><span class="p">,</span>
           <span class="n">drop_off</span><span class="p">.</span><span class="n">borocode</span> <span class="n">dropoff_borocode</span><span class="p">,</span>
           <span class="n">drop_off</span><span class="p">.</span><span class="n">boroname</span> <span class="n">dropoff_boroname</span><span class="p">,</span>
           <span class="n">drop_off</span><span class="p">.</span><span class="n">ct2010</span> <span class="n">dropoff_ct2010</span><span class="p">,</span>
           <span class="n">drop_off</span><span class="p">.</span><span class="n">boroct2010</span> <span class="n">dropoff_boroct2010</span><span class="p">,</span>
           <span class="n">drop_off</span><span class="p">.</span><span class="n">cdeligibil</span> <span class="n">dropoff_cdeligibil</span><span class="p">,</span>
           <span class="n">drop_off</span><span class="p">.</span><span class="n">ntacode</span> <span class="n">dropoff_ntacode</span><span class="p">,</span>
           <span class="n">drop_off</span><span class="p">.</span><span class="n">ntaname</span> <span class="n">dropoff_ntaname</span><span class="p">,</span>
           <span class="n">drop_off</span><span class="p">.</span><span class="n">puma</span> <span class="n">dropoff_puma</span>
    <span class="k">FROM</span> <span class="n">trips</span>
    <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">cab_types</span>
        <span class="k">ON</span> <span class="n">trips</span><span class="p">.</span><span class="n">cab_type_id</span> <span class="o">=</span> <span class="n">cab_types</span><span class="p">.</span><span class="n">id</span>
    <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">central_park_weather_observations_raw</span> <span class="n">weather</span>
        <span class="k">ON</span> <span class="n">weather</span><span class="p">.</span><span class="nb">date</span> <span class="o">=</span> <span class="n">trips</span><span class="p">.</span><span class="n">pickup_datetime</span><span class="p">::</span><span class="nb">date</span>
    <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">nyct2010</span> <span class="n">pick_up</span>
        <span class="k">ON</span> <span class="n">pick_up</span><span class="p">.</span><span class="n">gid</span> <span class="o">=</span> <span class="n">trips</span><span class="p">.</span><span class="n">pickup_nyct2010_gid</span>
    <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">nyct2010</span> <span class="n">drop_off</span>
        <span class="k">ON</span> <span class="n">drop_off</span><span class="p">.</span><span class="n">gid</span> <span class="o">=</span> <span class="n">trips</span><span class="p">.</span><span class="n">dropoff_nyct2010_gid</span>
<span class="p">)</span> <span class="k">TO</span> <span class="s1">&#39;/opt/milovidov/nyc-taxi-data/trips.tsv&#39;</span><span class="p">;</span>
</pre></div>


<p>The data snapshot is created at a speed of about 50 MB per second. While creating the snapshot, PostgreSQL reads from the disk at a speed of about 28 MB per second.
This takes about 5 hours. The resulting TSV file is 590612904969 bytes.</p>
<p>Create a temporary table in ClickHouse:</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">trips</span>
<span class="p">(</span>
<span class="n">trip_id</span>                 <span class="n">UInt32</span><span class="p">,</span>
<span class="n">vendor_id</span>               <span class="n">String</span><span class="p">,</span>
<span class="n">pickup_datetime</span>         <span class="n">DateTime</span><span class="p">,</span>
<span class="n">dropoff_datetime</span>        <span class="k">Nullable</span><span class="p">(</span><span class="n">DateTime</span><span class="p">),</span>
<span class="n">store_and_fwd_flag</span>      <span class="k">Nullable</span><span class="p">(</span><span class="n">FixedString</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
<span class="n">rate_code_id</span>            <span class="k">Nullable</span><span class="p">(</span><span class="n">UInt8</span><span class="p">),</span>
<span class="n">pickup_longitude</span>        <span class="k">Nullable</span><span class="p">(</span><span class="n">Float64</span><span class="p">),</span>
<span class="n">pickup_latitude</span>         <span class="k">Nullable</span><span class="p">(</span><span class="n">Float64</span><span class="p">),</span>
<span class="n">dropoff_longitude</span>       <span class="k">Nullable</span><span class="p">(</span><span class="n">Float64</span><span class="p">),</span>
<span class="n">dropoff_latitude</span>        <span class="k">Nullable</span><span class="p">(</span><span class="n">Float64</span><span class="p">),</span>
<span class="n">passenger_count</span>         <span class="k">Nullable</span><span class="p">(</span><span class="n">UInt8</span><span class="p">),</span>
<span class="n">trip_distance</span>           <span class="k">Nullable</span><span class="p">(</span><span class="n">Float64</span><span class="p">),</span>
<span class="n">fare_amount</span>             <span class="k">Nullable</span><span class="p">(</span><span class="n">Float32</span><span class="p">),</span>
<span class="n">extra</span>                   <span class="k">Nullable</span><span class="p">(</span><span class="n">Float32</span><span class="p">),</span>
<span class="n">mta_tax</span>                 <span class="k">Nullable</span><span class="p">(</span><span class="n">Float32</span><span class="p">),</span>
<span class="n">tip_amount</span>              <span class="k">Nullable</span><span class="p">(</span><span class="n">Float32</span><span class="p">),</span>
<span class="n">tolls_amount</span>            <span class="k">Nullable</span><span class="p">(</span><span class="n">Float32</span><span class="p">),</span>
<span class="n">ehail_fee</span>               <span class="k">Nullable</span><span class="p">(</span><span class="n">Float32</span><span class="p">),</span>
<span class="n">improvement_surcharge</span>   <span class="k">Nullable</span><span class="p">(</span><span class="n">Float32</span><span class="p">),</span>
<span class="n">total_amount</span>            <span class="k">Nullable</span><span class="p">(</span><span class="n">Float32</span><span class="p">),</span>
<span class="n">payment_type</span>            <span class="k">Nullable</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
<span class="n">trip_type</span>               <span class="k">Nullable</span><span class="p">(</span><span class="n">UInt8</span><span class="p">),</span>
<span class="n">pickup</span>                  <span class="k">Nullable</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
<span class="n">dropoff</span>                 <span class="k">Nullable</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
<span class="n">cab_type</span>                <span class="k">Nullable</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
<span class="n">precipitation</span>           <span class="k">Nullable</span><span class="p">(</span><span class="n">UInt8</span><span class="p">),</span>
<span class="n">snow_depth</span>              <span class="k">Nullable</span><span class="p">(</span><span class="n">UInt8</span><span class="p">),</span>
<span class="n">snowfall</span>                <span class="k">Nullable</span><span class="p">(</span><span class="n">UInt8</span><span class="p">),</span>
<span class="n">max_temperature</span>         <span class="k">Nullable</span><span class="p">(</span><span class="n">UInt8</span><span class="p">),</span>
<span class="n">min_temperature</span>         <span class="k">Nullable</span><span class="p">(</span><span class="n">UInt8</span><span class="p">),</span>
<span class="n">average_wind_speed</span>      <span class="k">Nullable</span><span class="p">(</span><span class="n">UInt8</span><span class="p">),</span>
<span class="n">pickup_nyct2010_gid</span>     <span class="k">Nullable</span><span class="p">(</span><span class="n">UInt8</span><span class="p">),</span>
<span class="n">pickup_ctlabel</span>          <span class="k">Nullable</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
<span class="n">pickup_borocode</span>         <span class="k">Nullable</span><span class="p">(</span><span class="n">UInt8</span><span class="p">),</span>
<span class="n">pickup_boroname</span>         <span class="k">Nullable</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
<span class="n">pickup_ct2010</span>           <span class="k">Nullable</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
<span class="n">pickup_boroct2010</span>       <span class="k">Nullable</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
<span class="n">pickup_cdeligibil</span>       <span class="k">Nullable</span><span class="p">(</span><span class="n">FixedString</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
<span class="n">pickup_ntacode</span>          <span class="k">Nullable</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
<span class="n">pickup_ntaname</span>          <span class="k">Nullable</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
<span class="n">pickup_puma</span>             <span class="k">Nullable</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
<span class="n">dropoff_nyct2010_gid</span>    <span class="k">Nullable</span><span class="p">(</span><span class="n">UInt8</span><span class="p">),</span>
<span class="n">dropoff_ctlabel</span>         <span class="k">Nullable</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
<span class="n">dropoff_borocode</span>        <span class="k">Nullable</span><span class="p">(</span><span class="n">UInt8</span><span class="p">),</span>
<span class="n">dropoff_boroname</span>        <span class="k">Nullable</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
<span class="n">dropoff_ct2010</span>          <span class="k">Nullable</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
<span class="n">dropoff_boroct2010</span>      <span class="k">Nullable</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
<span class="n">dropoff_cdeligibil</span>      <span class="k">Nullable</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
<span class="n">dropoff_ntacode</span>         <span class="k">Nullable</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
<span class="n">dropoff_ntaname</span>         <span class="k">Nullable</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
<span class="n">dropoff_puma</span>            <span class="k">Nullable</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">Log</span><span class="p">;</span>
</pre></div>


<p>It is needed for converting fields to more correct data types and, if possible, to eliminate NULLs.</p>
<div class="codehilite"><pre><span></span>time clickhouse-client --query=&quot;INSERT INTO trips FORMAT TabSeparated&quot; &lt; trips.tsv

real    75m56.214s
</pre></div>


<p>Data is read at a speed of 112-140 Mb/second.
Loading data into a Log type table in one stream took 76 minutes.
The data in this table uses 142 GB.</p>
<p>(Importing data directly from Postgres is also possible using <code>COPY ... TO PROGRAM</code>.)</p>
<p>Unfortunately, all the fields associated with the weather (precipitation...average_wind_speed) were filled with NULL. Because of this, we will remove them from the final data set.</p>
<p>To start, we'll create a table on a single server. Later we will make the table distributed.</p>
<p>Create and populate a summary table:</p>
<div class="codehilite"><pre><span></span>CREATE TABLE trips_mergetree
ENGINE = MergeTree(pickup_date, pickup_datetime, 8192)
AS SELECT

trip_id,
CAST(vendor_id AS Enum8(&#39;1&#39; = 1, &#39;2&#39; = 2, &#39;CMT&#39; = 3, &#39;VTS&#39; = 4, &#39;DDS&#39; = 5, &#39;B02512&#39; = 10, &#39;B02598&#39; = 11, &#39;B02617&#39; = 12, &#39;B02682&#39; = 13, &#39;B02764&#39; = 14)) AS vendor_id,
toDate(pickup_datetime) AS pickup_date,
ifNull(pickup_datetime, toDateTime(0)) AS pickup_datetime,
toDate(dropoff_datetime) AS dropoff_date,
ifNull(dropoff_datetime, toDateTime(0)) AS dropoff_datetime,
assumeNotNull(store_and_fwd_flag) IN (&#39;Y&#39;, &#39;1&#39;, &#39;2&#39;) AS store_and_fwd_flag,
assumeNotNull(rate_code_id) AS rate_code_id,
assumeNotNull(pickup_longitude) AS pickup_longitude,
assumeNotNull(pickup_latitude) AS pickup_latitude,
assumeNotNull(dropoff_longitude) AS dropoff_longitude,
assumeNotNull(dropoff_latitude) AS dropoff_latitude,
assumeNotNull(passenger_count) AS passenger_count,
assumeNotNull(trip_distance) AS trip_distance,
assumeNotNull(fare_amount) AS fare_amount,
assumeNotNull(extra) AS extra,
assumeNotNull(mta_tax) AS mta_tax,
assumeNotNull(tip_amount) AS tip_amount,
assumeNotNull(tolls_amount) AS tolls_amount,
assumeNotNull(ehail_fee) AS ehail_fee,
assumeNotNull(improvement_surcharge) AS improvement_surcharge,
assumeNotNull(total_amount) AS total_amount,
CAST((assumeNotNull(payment_type) AS pt) IN (&#39;CSH&#39;, &#39;CASH&#39;, &#39;Cash&#39;, &#39;CAS&#39;, &#39;Cas&#39;, &#39;1&#39;) ? &#39;CSH&#39; : (pt IN (&#39;CRD&#39;, &#39;Credit&#39;, &#39;Cre&#39;, &#39;CRE&#39;, &#39;CREDIT&#39;, &#39;2&#39;) ? &#39;CRE&#39; : (pt IN (&#39;NOC&#39;, &#39;No Charge&#39;, &#39;No&#39;, &#39;3&#39;) ? &#39;NOC&#39; : (pt IN (&#39;DIS&#39;, &#39;Dispute&#39;, &#39;Dis&#39;, &#39;4&#39;) ? &#39;DIS&#39; : &#39;UNK&#39;))) AS Enum8(&#39;CSH&#39; = 1, &#39;CRE&#39; = 2, &#39;UNK&#39; = 0, &#39;NOC&#39; = 3, &#39;DIS&#39; = 4)) AS payment_type_,
assumeNotNull(trip_type) AS trip_type,
ifNull(toFixedString(unhex(pickup), 25), toFixedString(&#39;&#39;, 25)) AS pickup,
ifNull(toFixedString(unhex(dropoff), 25), toFixedString(&#39;&#39;, 25)) AS dropoff,
CAST(assumeNotNull(cab_type) AS Enum8(&#39;yellow&#39; = 1, &#39;green&#39; = 2, &#39;uber&#39; = 3)) AS cab_type,

assumeNotNull(pickup_nyct2010_gid) AS pickup_nyct2010_gid,
toFloat32(ifNull(pickup_ctlabel, &#39;0&#39;)) AS pickup_ctlabel,
assumeNotNull(pickup_borocode) AS pickup_borocode,
CAST(assumeNotNull(pickup_boroname) AS Enum8(&#39;Manhattan&#39; = 1, &#39;Queens&#39; = 4, &#39;Brooklyn&#39; = 3, &#39;&#39; = 0, &#39;Bronx&#39; = 2, &#39;Staten Island&#39; = 5)) AS pickup_boroname,
toFixedString(ifNull(pickup_ct2010, &#39;000000&#39;), 6) AS pickup_ct2010,
toFixedString(ifNull(pickup_boroct2010, &#39;0000000&#39;), 7) AS pickup_boroct2010,
CAST(assumeNotNull(ifNull(pickup_cdeligibil, &#39; &#39;)) AS Enum8(&#39; &#39; = 0, &#39;E&#39; = 1, &#39;I&#39; = 2)) AS pickup_cdeligibil,
toFixedString(ifNull(pickup_ntacode, &#39;0000&#39;), 4) AS pickup_ntacode,

CAST(assumeNotNull(pickup_ntaname) AS Enum16(&#39;&#39; = 0, &#39;Airport&#39; = 1, &#39;Allerton-Pelham Gardens&#39; = 2, &#39;Annadale-Huguenot-Prince\&#39;s Bay-Eltingville&#39; = 3, &#39;Arden Heights&#39; = 4, &#39;Astoria&#39; = 5, &#39;Auburndale&#39; = 6, &#39;Baisley Park&#39; = 7, &#39;Bath Beach&#39; = 8, &#39;Battery Park City-Lower Manhattan&#39; = 9, &#39;Bay Ridge&#39; = 10, &#39;Bayside-Bayside Hills&#39; = 11, &#39;Bedford&#39; = 12, &#39;Bedford Park-Fordham North&#39; = 13, &#39;Bellerose&#39; = 14, &#39;Belmont&#39; = 15, &#39;Bensonhurst East&#39; = 16, &#39;Bensonhurst West&#39; = 17, &#39;Borough Park&#39; = 18, &#39;Breezy Point-Belle Harbor-Rockaway Park-Broad Channel&#39; = 19, &#39;Briarwood-Jamaica Hills&#39; = 20, &#39;Brighton Beach&#39; = 21, &#39;Bronxdale&#39; = 22, &#39;Brooklyn Heights-Cobble Hill&#39; = 23, &#39;Brownsville&#39; = 24, &#39;Bushwick North&#39; = 25, &#39;Bushwick South&#39; = 26, &#39;Cambria Heights&#39; = 27, &#39;Canarsie&#39; = 28, &#39;Carroll Gardens-Columbia Street-Red Hook&#39; = 29, &#39;Central Harlem North-Polo Grounds&#39; = 30, &#39;Central Harlem South&#39; = 31, &#39;Charleston-Richmond Valley-Tottenville&#39; = 32, &#39;Chinatown&#39; = 33, &#39;Claremont-Bathgate&#39; = 34, &#39;Clinton&#39; = 35, &#39;Clinton Hill&#39; = 36, &#39;Co-op City&#39; = 37, &#39;College Point&#39; = 38, &#39;Corona&#39; = 39, &#39;Crotona Park East&#39; = 40, &#39;Crown Heights North&#39; = 41, &#39;Crown Heights South&#39; = 42, &#39;Cypress Hills-City Line&#39; = 43, &#39;DUMBO-Vinegar Hill-Downtown Brooklyn-Boerum Hill&#39; = 44, &#39;Douglas Manor-Douglaston-Little Neck&#39; = 45, &#39;Dyker Heights&#39; = 46, &#39;East Concourse-Concourse Village&#39; = 47, &#39;East Elmhurst&#39; = 48, &#39;East Flatbush-Farragut&#39; = 49, &#39;East Flushing&#39; = 50, &#39;East Harlem North&#39; = 51, &#39;East Harlem South&#39; = 52, &#39;East New York&#39; = 53, &#39;East New York (Pennsylvania Ave)&#39; = 54, &#39;East Tremont&#39; = 55, &#39;East Village&#39; = 56, &#39;East Williamsburg&#39; = 57, &#39;Eastchester-Edenwald-Baychester&#39; = 58, &#39;Elmhurst&#39; = 59, &#39;Elmhurst-Maspeth&#39; = 60, &#39;Erasmus&#39; = 61, &#39;Far Rockaway-Bayswater&#39; = 62, &#39;Flatbush&#39; = 63, &#39;Flatlands&#39; = 64, &#39;Flushing&#39; = 65, &#39;Fordham South&#39; = 66, &#39;Forest Hills&#39; = 67, &#39;Fort Greene&#39; = 68, &#39;Fresh Meadows-Utopia&#39; = 69, &#39;Ft. Totten-Bay Terrace-Clearview&#39; = 70, &#39;Georgetown-Marine Park-Bergen Beach-Mill Basin&#39; = 71, &#39;Glen Oaks-Floral Park-New Hyde Park&#39; = 72, &#39;Glendale&#39; = 73, &#39;Gramercy&#39; = 74, &#39;Grasmere-Arrochar-Ft. Wadsworth&#39; = 75, &#39;Gravesend&#39; = 76, &#39;Great Kills&#39; = 77, &#39;Greenpoint&#39; = 78, &#39;Grymes Hill-Clifton-Fox Hills&#39; = 79, &#39;Hamilton Heights&#39; = 80, &#39;Hammels-Arverne-Edgemere&#39; = 81, &#39;Highbridge&#39; = 82, &#39;Hollis&#39; = 83, &#39;Homecrest&#39; = 84, &#39;Hudson Yards-Chelsea-Flatiron-Union Square&#39; = 85, &#39;Hunters Point-Sunnyside-West Maspeth&#39; = 86, &#39;Hunts Point&#39; = 87, &#39;Jackson Heights&#39; = 88, &#39;Jamaica&#39; = 89, &#39;Jamaica Estates-Holliswood&#39; = 90, &#39;Kensington-Ocean Parkway&#39; = 91, &#39;Kew Gardens&#39; = 92, &#39;Kew Gardens Hills&#39; = 93, &#39;Kingsbridge Heights&#39; = 94, &#39;Laurelton&#39; = 95, &#39;Lenox Hill-Roosevelt Island&#39; = 96, &#39;Lincoln Square&#39; = 97, &#39;Lindenwood-Howard Beach&#39; = 98, &#39;Longwood&#39; = 99, &#39;Lower East Side&#39; = 100, &#39;Madison&#39; = 101, &#39;Manhattanville&#39; = 102, &#39;Marble Hill-Inwood&#39; = 103, &#39;Mariner\&#39;s Harbor-Arlington-Port Ivory-Graniteville&#39; = 104, &#39;Maspeth&#39; = 105, &#39;Melrose South-Mott Haven North&#39; = 106, &#39;Middle Village&#39; = 107, &#39;Midtown-Midtown South&#39; = 108, &#39;Midwood&#39; = 109, &#39;Morningside Heights&#39; = 110, &#39;Morrisania-Melrose&#39; = 111, &#39;Mott Haven-Port Morris&#39; = 112, &#39;Mount Hope&#39; = 113, &#39;Murray Hill&#39; = 114, &#39;Murray Hill-Kips Bay&#39; = 115, &#39;New Brighton-Silver Lake&#39; = 116, &#39;New Dorp-Midland Beach&#39; = 117, &#39;New Springville-Bloomfield-Travis&#39; = 118, &#39;North Corona&#39; = 119, &#39;North Riverdale-Fieldston-Riverdale&#39; = 120, &#39;North Side-South Side&#39; = 121, &#39;Norwood&#39; = 122, &#39;Oakland Gardens&#39; = 123, &#39;Oakwood-Oakwood Beach&#39; = 124, &#39;Ocean Hill&#39; = 125, &#39;Ocean Parkway South&#39; = 126, &#39;Old Astoria&#39; = 127, &#39;Old Town-Dongan Hills-South Beach&#39; = 128, &#39;Ozone Park&#39; = 129, &#39;Park Slope-Gowanus&#39; = 130, &#39;Parkchester&#39; = 131, &#39;Pelham Bay-Country Club-City Island&#39; = 132, &#39;Pelham Parkway&#39; = 133, &#39;Pomonok-Flushing Heights-Hillcrest&#39; = 134, &#39;Port Richmond&#39; = 135, &#39;Prospect Heights&#39; = 136, &#39;Prospect Lefferts Gardens-Wingate&#39; = 137, &#39;Queens Village&#39; = 138, &#39;Queensboro Hill&#39; = 139, &#39;Queensbridge-Ravenswood-Long Island City&#39; = 140, &#39;Rego Park&#39; = 141, &#39;Richmond Hill&#39; = 142, &#39;Ridgewood&#39; = 143, &#39;Rikers Island&#39; = 144, &#39;Rosedale&#39; = 145, &#39;Rossville-Woodrow&#39; = 146, &#39;Rugby-Remsen Village&#39; = 147, &#39;Schuylerville-Throgs Neck-Edgewater Park&#39; = 148, &#39;Seagate-Coney Island&#39; = 149, &#39;Sheepshead Bay-Gerritsen Beach-Manhattan Beach&#39; = 150, &#39;SoHo-TriBeCa-Civic Center-Little Italy&#39; = 151, &#39;Soundview-Bruckner&#39; = 152, &#39;Soundview-Castle Hill-Clason Point-Harding Park&#39; = 153, &#39;South Jamaica&#39; = 154, &#39;South Ozone Park&#39; = 155, &#39;Springfield Gardens North&#39; = 156, &#39;Springfield Gardens South-Brookville&#39; = 157, &#39;Spuyten Duyvil-Kingsbridge&#39; = 158, &#39;St. Albans&#39; = 159, &#39;Stapleton-Rosebank&#39; = 160, &#39;Starrett City&#39; = 161, &#39;Steinway&#39; = 162, &#39;Stuyvesant Heights&#39; = 163, &#39;Stuyvesant Town-Cooper Village&#39; = 164, &#39;Sunset Park East&#39; = 165, &#39;Sunset Park West&#39; = 166, &#39;Todt Hill-Emerson Hill-Heartland Village-Lighthouse Hill&#39; = 167, &#39;Turtle Bay-East Midtown&#39; = 168, &#39;University Heights-Morris Heights&#39; = 169, &#39;Upper East Side-Carnegie Hill&#39; = 170, &#39;Upper West Side&#39; = 171, &#39;Van Cortlandt Village&#39; = 172, &#39;Van Nest-Morris Park-Westchester Square&#39; = 173, &#39;Washington Heights North&#39; = 174, &#39;Washington Heights South&#39; = 175, &#39;West Brighton&#39; = 176, &#39;West Concourse&#39; = 177, &#39;West Farms-Bronx River&#39; = 178, &#39;West New Brighton-New Brighton-St. George&#39; = 179, &#39;West Village&#39; = 180, &#39;Westchester-Unionport&#39; = 181, &#39;Westerleigh&#39; = 182, &#39;Whitestone&#39; = 183, &#39;Williamsbridge-Olinville&#39; = 184, &#39;Williamsburg&#39; = 185, &#39;Windsor Terrace&#39; = 186, &#39;Woodhaven&#39; = 187, &#39;Woodlawn-Wakefield&#39; = 188, &#39;Woodside&#39; = 189, &#39;Yorkville&#39; = 190, &#39;park-cemetery-etc-Bronx&#39; = 191, &#39;park-cemetery-etc-Brooklyn&#39; = 192, &#39;park-cemetery-etc-Manhattan&#39; = 193, &#39;park-cemetery-etc-Queens&#39; = 194, &#39;park-cemetery-etc-Staten Island&#39; = 195)) AS pickup_ntaname,

toUInt16(ifNull(pickup_puma, &#39;0&#39;)) AS pickup_puma,

assumeNotNull(dropoff_nyct2010_gid) AS dropoff_nyct2010_gid,
toFloat32(ifNull(dropoff_ctlabel, &#39;0&#39;)) AS dropoff_ctlabel,
assumeNotNull(dropoff_borocode) AS dropoff_borocode,
CAST(assumeNotNull(dropoff_boroname) AS Enum8(&#39;Manhattan&#39; = 1, &#39;Queens&#39; = 4, &#39;Brooklyn&#39; = 3, &#39;&#39; = 0, &#39;Bronx&#39; = 2, &#39;Staten Island&#39; = 5)) AS dropoff_boroname,
toFixedString(ifNull(dropoff_ct2010, &#39;000000&#39;), 6) AS dropoff_ct2010,
toFixedString(ifNull(dropoff_boroct2010, &#39;0000000&#39;), 7) AS dropoff_boroct2010,
CAST(assumeNotNull(ifNull(dropoff_cdeligibil, &#39; &#39;)) AS Enum8(&#39; &#39; = 0, &#39;E&#39; = 1, &#39;I&#39; = 2)) AS dropoff_cdeligibil,
toFixedString(ifNull(dropoff_ntacode, &#39;0000&#39;), 4) AS dropoff_ntacode,

CAST(assumeNotNull(dropoff_ntaname) AS Enum16(&#39;&#39; = 0, &#39;Airport&#39; = 1, &#39;Allerton-Pelham Gardens&#39; = 2, &#39;Annadale-Huguenot-Prince\&#39;s Bay-Eltingville&#39; = 3, &#39;Arden Heights&#39; = 4, &#39;Astoria&#39; = 5, &#39;Auburndale&#39; = 6, &#39;Baisley Park&#39; = 7, &#39;Bath Beach&#39; = 8, &#39;Battery Park City-Lower Manhattan&#39; = 9, &#39;Bay Ridge&#39; = 10, &#39;Bayside-Bayside Hills&#39; = 11, &#39;Bedford&#39; = 12, &#39;Bedford Park-Fordham North&#39; = 13, &#39;Bellerose&#39; = 14, &#39;Belmont&#39; = 15, &#39;Bensonhurst East&#39; = 16, &#39;Bensonhurst West&#39; = 17, &#39;Borough Park&#39; = 18, &#39;Breezy Point-Belle Harbor-Rockaway Park-Broad Channel&#39; = 19, &#39;Briarwood-Jamaica Hills&#39; = 20, &#39;Brighton Beach&#39; = 21, &#39;Bronxdale&#39; = 22, &#39;Brooklyn Heights-Cobble Hill&#39; = 23, &#39;Brownsville&#39; = 24, &#39;Bushwick North&#39; = 25, &#39;Bushwick South&#39; = 26, &#39;Cambria Heights&#39; = 27, &#39;Canarsie&#39; = 28, &#39;Carroll Gardens-Columbia Street-Red Hook&#39; = 29, &#39;Central Harlem North-Polo Grounds&#39; = 30, &#39;Central Harlem South&#39; = 31, &#39;Charleston-Richmond Valley-Tottenville&#39; = 32, &#39;Chinatown&#39; = 33, &#39;Claremont-Bathgate&#39; = 34, &#39;Clinton&#39; = 35, &#39;Clinton Hill&#39; = 36, &#39;Co-op City&#39; = 37, &#39;College Point&#39; = 38, &#39;Corona&#39; = 39, &#39;Crotona Park East&#39; = 40, &#39;Crown Heights North&#39; = 41, &#39;Crown Heights South&#39; = 42, &#39;Cypress Hills-City Line&#39; = 43, &#39;DUMBO-Vinegar Hill-Downtown Brooklyn-Boerum Hill&#39; = 44, &#39;Douglas Manor-Douglaston-Little Neck&#39; = 45, &#39;Dyker Heights&#39; = 46, &#39;East Concourse-Concourse Village&#39; = 47, &#39;East Elmhurst&#39; = 48, &#39;East Flatbush-Farragut&#39; = 49, &#39;East Flushing&#39; = 50, &#39;East Harlem North&#39; = 51, &#39;East Harlem South&#39; = 52, &#39;East New York&#39; = 53, &#39;East New York (Pennsylvania Ave)&#39; = 54, &#39;East Tremont&#39; = 55, &#39;East Village&#39; = 56, &#39;East Williamsburg&#39; = 57, &#39;Eastchester-Edenwald-Baychester&#39; = 58, &#39;Elmhurst&#39; = 59, &#39;Elmhurst-Maspeth&#39; = 60, &#39;Erasmus&#39; = 61, &#39;Far Rockaway-Bayswater&#39; = 62, &#39;Flatbush&#39; = 63, &#39;Flatlands&#39; = 64, &#39;Flushing&#39; = 65, &#39;Fordham South&#39; = 66, &#39;Forest Hills&#39; = 67, &#39;Fort Greene&#39; = 68, &#39;Fresh Meadows-Utopia&#39; = 69, &#39;Ft. Totten-Bay Terrace-Clearview&#39; = 70, &#39;Georgetown-Marine Park-Bergen Beach-Mill Basin&#39; = 71, &#39;Glen Oaks-Floral Park-New Hyde Park&#39; = 72, &#39;Glendale&#39; = 73, &#39;Gramercy&#39; = 74, &#39;Grasmere-Arrochar-Ft. Wadsworth&#39; = 75, &#39;Gravesend&#39; = 76, &#39;Great Kills&#39; = 77, &#39;Greenpoint&#39; = 78, &#39;Grymes Hill-Clifton-Fox Hills&#39; = 79, &#39;Hamilton Heights&#39; = 80, &#39;Hammels-Arverne-Edgemere&#39; = 81, &#39;Highbridge&#39; = 82, &#39;Hollis&#39; = 83, &#39;Homecrest&#39; = 84, &#39;Hudson Yards-Chelsea-Flatiron-Union Square&#39; = 85, &#39;Hunters Point-Sunnyside-West Maspeth&#39; = 86, &#39;Hunts Point&#39; = 87, &#39;Jackson Heights&#39; = 88, &#39;Jamaica&#39; = 89, &#39;Jamaica Estates-Holliswood&#39; = 90, &#39;Kensington-Ocean Parkway&#39; = 91, &#39;Kew Gardens&#39; = 92, &#39;Kew Gardens Hills&#39; = 93, &#39;Kingsbridge Heights&#39; = 94, &#39;Laurelton&#39; = 95, &#39;Lenox Hill-Roosevelt Island&#39; = 96, &#39;Lincoln Square&#39; = 97, &#39;Lindenwood-Howard Beach&#39; = 98, &#39;Longwood&#39; = 99, &#39;Lower East Side&#39; = 100, &#39;Madison&#39; = 101, &#39;Manhattanville&#39; = 102, &#39;Marble Hill-Inwood&#39; = 103, &#39;Mariner\&#39;s Harbor-Arlington-Port Ivory-Graniteville&#39; = 104, &#39;Maspeth&#39; = 105, &#39;Melrose South-Mott Haven North&#39; = 106, &#39;Middle Village&#39; = 107, &#39;Midtown-Midtown South&#39; = 108, &#39;Midwood&#39; = 109, &#39;Morningside Heights&#39; = 110, &#39;Morrisania-Melrose&#39; = 111, &#39;Mott Haven-Port Morris&#39; = 112, &#39;Mount Hope&#39; = 113, &#39;Murray Hill&#39; = 114, &#39;Murray Hill-Kips Bay&#39; = 115, &#39;New Brighton-Silver Lake&#39; = 116, &#39;New Dorp-Midland Beach&#39; = 117, &#39;New Springville-Bloomfield-Travis&#39; = 118, &#39;North Corona&#39; = 119, &#39;North Riverdale-Fieldston-Riverdale&#39; = 120, &#39;North Side-South Side&#39; = 121, &#39;Norwood&#39; = 122, &#39;Oakland Gardens&#39; = 123, &#39;Oakwood-Oakwood Beach&#39; = 124, &#39;Ocean Hill&#39; = 125, &#39;Ocean Parkway South&#39; = 126, &#39;Old Astoria&#39; = 127, &#39;Old Town-Dongan Hills-South Beach&#39; = 128, &#39;Ozone Park&#39; = 129, &#39;Park Slope-Gowanus&#39; = 130, &#39;Parkchester&#39; = 131, &#39;Pelham Bay-Country Club-City Island&#39; = 132, &#39;Pelham Parkway&#39; = 133, &#39;Pomonok-Flushing Heights-Hillcrest&#39; = 134, &#39;Port Richmond&#39; = 135, &#39;Prospect Heights&#39; = 136, &#39;Prospect Lefferts Gardens-Wingate&#39; = 137, &#39;Queens Village&#39; = 138, &#39;Queensboro Hill&#39; = 139, &#39;Queensbridge-Ravenswood-Long Island City&#39; = 140, &#39;Rego Park&#39; = 141, &#39;Richmond Hill&#39; = 142, &#39;Ridgewood&#39; = 143, &#39;Rikers Island&#39; = 144, &#39;Rosedale&#39; = 145, &#39;Rossville-Woodrow&#39; = 146, &#39;Rugby-Remsen Village&#39; = 147, &#39;Schuylerville-Throgs Neck-Edgewater Park&#39; = 148, &#39;Seagate-Coney Island&#39; = 149, &#39;Sheepshead Bay-Gerritsen Beach-Manhattan Beach&#39; = 150, &#39;SoHo-TriBeCa-Civic Center-Little Italy&#39; = 151, &#39;Soundview-Bruckner&#39; = 152, &#39;Soundview-Castle Hill-Clason Point-Harding Park&#39; = 153, &#39;South Jamaica&#39; = 154, &#39;South Ozone Park&#39; = 155, &#39;Springfield Gardens North&#39; = 156, &#39;Springfield Gardens South-Brookville&#39; = 157, &#39;Spuyten Duyvil-Kingsbridge&#39; = 158, &#39;St. Albans&#39; = 159, &#39;Stapleton-Rosebank&#39; = 160, &#39;Starrett City&#39; = 161, &#39;Steinway&#39; = 162, &#39;Stuyvesant Heights&#39; = 163, &#39;Stuyvesant Town-Cooper Village&#39; = 164, &#39;Sunset Park East&#39; = 165, &#39;Sunset Park West&#39; = 166, &#39;Todt Hill-Emerson Hill-Heartland Village-Lighthouse Hill&#39; = 167, &#39;Turtle Bay-East Midtown&#39; = 168, &#39;University Heights-Morris Heights&#39; = 169, &#39;Upper East Side-Carnegie Hill&#39; = 170, &#39;Upper West Side&#39; = 171, &#39;Van Cortlandt Village&#39; = 172, &#39;Van Nest-Morris Park-Westchester Square&#39; = 173, &#39;Washington Heights North&#39; = 174, &#39;Washington Heights South&#39; = 175, &#39;West Brighton&#39; = 176, &#39;West Concourse&#39; = 177, &#39;West Farms-Bronx River&#39; = 178, &#39;West New Brighton-New Brighton-St. George&#39; = 179, &#39;West Village&#39; = 180, &#39;Westchester-Unionport&#39; = 181, &#39;Westerleigh&#39; = 182, &#39;Whitestone&#39; = 183, &#39;Williamsbridge-Olinville&#39; = 184, &#39;Williamsburg&#39; = 185, &#39;Windsor Terrace&#39; = 186, &#39;Woodhaven&#39; = 187, &#39;Woodlawn-Wakefield&#39; = 188, &#39;Woodside&#39; = 189, &#39;Yorkville&#39; = 190, &#39;park-cemetery-etc-Bronx&#39; = 191, &#39;park-cemetery-etc-Brooklyn&#39; = 192, &#39;park-cemetery-etc-Manhattan&#39; = 193, &#39;park-cemetery-etc-Queens&#39; = 194, &#39;park-cemetery-etc-Staten Island&#39; = 195)) AS dropoff_ntaname,

toUInt16(ifNull(dropoff_puma, &#39;0&#39;)) AS dropoff_puma

FROM trips
</pre></div>


<p>This takes 3030 seconds at a speed of about 428,000 rows per second.
To load it faster, you can create the table with the <code>Log</code> engine instead of <code>MergeTree</code>. In this case, the download works faster than 200 seconds.</p>
<p>The table uses 126 GB of disk space.</p>
<div class="codehilite"><pre><span></span>:) SELECT formatReadableSize(sum(bytes)) FROM system.parts WHERE table = &#39;trips_mergetree&#39; AND active

SELECT formatReadableSize(sum(bytes))
FROM system.parts
WHERE (table = &#39;trips_mergetree&#39;) AND active

┌─formatReadableSize(sum(bytes))─┐
│ 126.18 GiB                     │
└────────────────────────────────┘
</pre></div>


<p>Among other things, you can run the OPTIMIZE query on MergeTree. But it's not required, since everything will be fine without it.</p>
<h3 id="results-on-single-server">Results on single server</h3>
<p>Q1:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">cab_type</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">trips_mergetree</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">cab_type</span>
</pre></div>


<p>0.490 seconds.</p>
<p>Q2:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">passenger_count</span><span class="p">,</span> <span class="k">avg</span><span class="p">(</span><span class="n">total_amount</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">trips_mergetree</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">passenger_count</span>
</pre></div>


<p>1.224 seconds.</p>
<p>Q3:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">passenger_count</span><span class="p">,</span> <span class="n">toYear</span><span class="p">(</span><span class="n">pickup_date</span><span class="p">)</span> <span class="k">AS</span> <span class="k">year</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">trips_mergetree</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">passenger_count</span><span class="p">,</span> <span class="k">year</span>
</pre></div>


<p>2.104 seconds.</p>
<p>Q4:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">passenger_count</span><span class="p">,</span> <span class="n">toYear</span><span class="p">(</span><span class="n">pickup_date</span><span class="p">)</span> <span class="k">AS</span> <span class="k">year</span><span class="p">,</span> <span class="n">round</span><span class="p">(</span><span class="n">trip_distance</span><span class="p">)</span> <span class="k">AS</span> <span class="n">distance</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">trips_mergetree</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">passenger_count</span><span class="p">,</span> <span class="k">year</span><span class="p">,</span> <span class="n">distance</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">year</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">DESC</span>
</pre></div>


<p>3.593 seconds.</p>
<p>The following server was used:</p>
<p>Two Intel(R) Xeon(R) CPU E5-2650 v2 @ 2.60GHz, 16 physical kernels total,
128 GiB RAM,
8x6 TB HD on hardware RAID-5</p>
<p>Execution time is the best of three runsBut starting from the second run, queries read data from the file system cache. No further caching occurs: the data is read out and processed in each run.</p>
<p>Creating a table on three servers:</p>
<p>On each server:</p>
<div class="codehilite"><pre><span></span>CREATE TABLE default.trips_mergetree_third ( trip_id UInt32,  vendor_id Enum8(&#39;1&#39; = 1, &#39;2&#39; = 2, &#39;CMT&#39; = 3, &#39;VTS&#39; = 4, &#39;DDS&#39; = 5, &#39;B02512&#39; = 10, &#39;B02598&#39; = 11, &#39;B02617&#39; = 12, &#39;B02682&#39; = 13, &#39;B02764&#39; = 14),  pickup_date Date,  pickup_datetime DateTime,  dropoff_date Date,  dropoff_datetime DateTime,  store_and_fwd_flag UInt8,  rate_code_id UInt8,  pickup_longitude Float64,  pickup_latitude Float64,  dropoff_longitude Float64,  dropoff_latitude Float64,  passenger_count UInt8,  trip_distance Float64,  fare_amount Float32,  extra Float32,  mta_tax Float32,  tip_amount Float32,  tolls_amount Float32,  ehail_fee Float32,  improvement_surcharge Float32,  total_amount Float32,  payment_type_ Enum8(&#39;UNK&#39; = 0, &#39;CSH&#39; = 1, &#39;CRE&#39; = 2, &#39;NOC&#39; = 3, &#39;DIS&#39; = 4),  trip_type UInt8,  pickup FixedString(25),  dropoff FixedString(25),  cab_type Enum8(&#39;yellow&#39; = 1, &#39;green&#39; = 2, &#39;uber&#39; = 3),  pickup_nyct2010_gid UInt8,  pickup_ctlabel Float32,  pickup_borocode UInt8,  pickup_boroname Enum8(&#39;&#39; = 0, &#39;Manhattan&#39; = 1, &#39;Bronx&#39; = 2, &#39;Brooklyn&#39; = 3, &#39;Queens&#39; = 4, &#39;Staten Island&#39; = 5),  pickup_ct2010 FixedString(6),  pickup_boroct2010 FixedString(7),  pickup_cdeligibil Enum8(&#39; &#39; = 0, &#39;E&#39; = 1, &#39;I&#39; = 2),  pickup_ntacode FixedString(4),  pickup_ntaname Enum16(&#39;&#39; = 0, &#39;Airport&#39; = 1, &#39;Allerton-Pelham Gardens&#39; = 2, &#39;Annadale-Huguenot-Prince\&#39;s Bay-Eltingville&#39; = 3, &#39;Arden Heights&#39; = 4, &#39;Astoria&#39; = 5, &#39;Auburndale&#39; = 6, &#39;Baisley Park&#39; = 7, &#39;Bath Beach&#39; = 8, &#39;Battery Park City-Lower Manhattan&#39; = 9, &#39;Bay Ridge&#39; = 10, &#39;Bayside-Bayside Hills&#39; = 11, &#39;Bedford&#39; = 12, &#39;Bedford Park-Fordham North&#39; = 13, &#39;Bellerose&#39; = 14, &#39;Belmont&#39; = 15, &#39;Bensonhurst East&#39; = 16, &#39;Bensonhurst West&#39; = 17, &#39;Borough Park&#39; = 18, &#39;Breezy Point-Belle Harbor-Rockaway Park-Broad Channel&#39; = 19, &#39;Briarwood-Jamaica Hills&#39; = 20, &#39;Brighton Beach&#39; = 21, &#39;Bronxdale&#39; = 22, &#39;Brooklyn Heights-Cobble Hill&#39; = 23, &#39;Brownsville&#39; = 24, &#39;Bushwick North&#39; = 25, &#39;Bushwick South&#39; = 26, &#39;Cambria Heights&#39; = 27, &#39;Canarsie&#39; = 28, &#39;Carroll Gardens-Columbia Street-Red Hook&#39; = 29, &#39;Central Harlem North-Polo Grounds&#39; = 30, &#39;Central Harlem South&#39; = 31, &#39;Charleston-Richmond Valley-Tottenville&#39; = 32, &#39;Chinatown&#39; = 33, &#39;Claremont-Bathgate&#39; = 34, &#39;Clinton&#39; = 35, &#39;Clinton Hill&#39; = 36, &#39;Co-op City&#39; = 37, &#39;College Point&#39; = 38, &#39;Corona&#39; = 39, &#39;Crotona Park East&#39; = 40, &#39;Crown Heights North&#39; = 41, &#39;Crown Heights South&#39; = 42, &#39;Cypress Hills-City Line&#39; = 43, &#39;DUMBO-Vinegar Hill-Downtown Brooklyn-Boerum Hill&#39; = 44, &#39;Douglas Manor-Douglaston-Little Neck&#39; = 45, &#39;Dyker Heights&#39; = 46, &#39;East Concourse-Concourse Village&#39; = 47, &#39;East Elmhurst&#39; = 48, &#39;East Flatbush-Farragut&#39; = 49, &#39;East Flushing&#39; = 50, &#39;East Harlem North&#39; = 51, &#39;East Harlem South&#39; = 52, &#39;East New York&#39; = 53, &#39;East New York (Pennsylvania Ave)&#39; = 54, &#39;East Tremont&#39; = 55, &#39;East Village&#39; = 56, &#39;East Williamsburg&#39; = 57, &#39;Eastchester-Edenwald-Baychester&#39; = 58, &#39;Elmhurst&#39; = 59, &#39;Elmhurst-Maspeth&#39; = 60, &#39;Erasmus&#39; = 61, &#39;Far Rockaway-Bayswater&#39; = 62, &#39;Flatbush&#39; = 63, &#39;Flatlands&#39; = 64, &#39;Flushing&#39; = 65, &#39;Fordham South&#39; = 66, &#39;Forest Hills&#39; = 67, &#39;Fort Greene&#39; = 68, &#39;Fresh Meadows-Utopia&#39; = 69, &#39;Ft. Totten-Bay Terrace-Clearview&#39; = 70, &#39;Georgetown-Marine Park-Bergen Beach-Mill Basin&#39; = 71, &#39;Glen Oaks-Floral Park-New Hyde Park&#39; = 72, &#39;Glendale&#39; = 73, &#39;Gramercy&#39; = 74, &#39;Grasmere-Arrochar-Ft. Wadsworth&#39; = 75, &#39;Gravesend&#39; = 76, &#39;Great Kills&#39; = 77, &#39;Greenpoint&#39; = 78, &#39;Grymes Hill-Clifton-Fox Hills&#39; = 79, &#39;Hamilton Heights&#39; = 80, &#39;Hammels-Arverne-Edgemere&#39; = 81, &#39;Highbridge&#39; = 82, &#39;Hollis&#39; = 83, &#39;Homecrest&#39; = 84, &#39;Hudson Yards-Chelsea-Flatiron-Union Square&#39; = 85, &#39;Hunters Point-Sunnyside-West Maspeth&#39; = 86, &#39;Hunts Point&#39; = 87, &#39;Jackson Heights&#39; = 88, &#39;Jamaica&#39; = 89, &#39;Jamaica Estates-Holliswood&#39; = 90, &#39;Kensington-Ocean Parkway&#39; = 91, &#39;Kew Gardens&#39; = 92, &#39;Kew Gardens Hills&#39; = 93, &#39;Kingsbridge Heights&#39; = 94, &#39;Laurelton&#39; = 95, &#39;Lenox Hill-Roosevelt Island&#39; = 96, &#39;Lincoln Square&#39; = 97, &#39;Lindenwood-Howard Beach&#39; = 98, &#39;Longwood&#39; = 99, &#39;Lower East Side&#39; = 100, &#39;Madison&#39; = 101, &#39;Manhattanville&#39; = 102, &#39;Marble Hill-Inwood&#39; = 103, &#39;Mariner\&#39;s Harbor-Arlington-Port Ivory-Graniteville&#39; = 104, &#39;Maspeth&#39; = 105, &#39;Melrose South-Mott Haven North&#39; = 106, &#39;Middle Village&#39; = 107, &#39;Midtown-Midtown South&#39; = 108, &#39;Midwood&#39; = 109, &#39;Morningside Heights&#39; = 110, &#39;Morrisania-Melrose&#39; = 111, &#39;Mott Haven-Port Morris&#39; = 112, &#39;Mount Hope&#39; = 113, &#39;Murray Hill&#39; = 114, &#39;Murray Hill-Kips Bay&#39; = 115, &#39;New Brighton-Silver Lake&#39; = 116, &#39;New Dorp-Midland Beach&#39; = 117, &#39;New Springville-Bloomfield-Travis&#39; = 118, &#39;North Corona&#39; = 119, &#39;North Riverdale-Fieldston-Riverdale&#39; = 120, &#39;North Side-South Side&#39; = 121, &#39;Norwood&#39; = 122, &#39;Oakland Gardens&#39; = 123, &#39;Oakwood-Oakwood Beach&#39; = 124, &#39;Ocean Hill&#39; = 125, &#39;Ocean Parkway South&#39; = 126, &#39;Old Astoria&#39; = 127, &#39;Old Town-Dongan Hills-South Beach&#39; = 128, &#39;Ozone Park&#39; = 129, &#39;Park Slope-Gowanus&#39; = 130, &#39;Parkchester&#39; = 131, &#39;Pelham Bay-Country Club-City Island&#39; = 132, &#39;Pelham Parkway&#39; = 133, &#39;Pomonok-Flushing Heights-Hillcrest&#39; = 134, &#39;Port Richmond&#39; = 135, &#39;Prospect Heights&#39; = 136, &#39;Prospect Lefferts Gardens-Wingate&#39; = 137, &#39;Queens Village&#39; = 138, &#39;Queensboro Hill&#39; = 139, &#39;Queensbridge-Ravenswood-Long Island City&#39; = 140, &#39;Rego Park&#39; = 141, &#39;Richmond Hill&#39; = 142, &#39;Ridgewood&#39; = 143, &#39;Rikers Island&#39; = 144, &#39;Rosedale&#39; = 145, &#39;Rossville-Woodrow&#39; = 146, &#39;Rugby-Remsen Village&#39; = 147, &#39;Schuylerville-Throgs Neck-Edgewater Park&#39; = 148, &#39;Seagate-Coney Island&#39; = 149, &#39;Sheepshead Bay-Gerritsen Beach-Manhattan Beach&#39; = 150, &#39;SoHo-TriBeCa-Civic Center-Little Italy&#39; = 151, &#39;Soundview-Bruckner&#39; = 152, &#39;Soundview-Castle Hill-Clason Point-Harding Park&#39; = 153, &#39;South Jamaica&#39; = 154, &#39;South Ozone Park&#39; = 155, &#39;Springfield Gardens North&#39; = 156, &#39;Springfield Gardens South-Brookville&#39; = 157, &#39;Spuyten Duyvil-Kingsbridge&#39; = 158, &#39;St. Albans&#39; = 159, &#39;Stapleton-Rosebank&#39; = 160, &#39;Starrett City&#39; = 161, &#39;Steinway&#39; = 162, &#39;Stuyvesant Heights&#39; = 163, &#39;Stuyvesant Town-Cooper Village&#39; = 164, &#39;Sunset Park East&#39; = 165, &#39;Sunset Park West&#39; = 166, &#39;Todt Hill-Emerson Hill-Heartland Village-Lighthouse Hill&#39; = 167, &#39;Turtle Bay-East Midtown&#39; = 168, &#39;University Heights-Morris Heights&#39; = 169, &#39;Upper East Side-Carnegie Hill&#39; = 170, &#39;Upper West Side&#39; = 171, &#39;Van Cortlandt Village&#39; = 172, &#39;Van Nest-Morris Park-Westchester Square&#39; = 173, &#39;Washington Heights North&#39; = 174, &#39;Washington Heights South&#39; = 175, &#39;West Brighton&#39; = 176, &#39;West Concourse&#39; = 177, &#39;West Farms-Bronx River&#39; = 178, &#39;West New Brighton-New Brighton-St. George&#39; = 179, &#39;West Village&#39; = 180, &#39;Westchester-Unionport&#39; = 181, &#39;Westerleigh&#39; = 182, &#39;Whitestone&#39; = 183, &#39;Williamsbridge-Olinville&#39; = 184, &#39;Williamsburg&#39; = 185, &#39;Windsor Terrace&#39; = 186, &#39;Woodhaven&#39; = 187, &#39;Woodlawn-Wakefield&#39; = 188, &#39;Woodside&#39; = 189, &#39;Yorkville&#39; = 190, &#39;park-cemetery-etc-Bronx&#39; = 191, &#39;park-cemetery-etc-Brooklyn&#39; = 192, &#39;park-cemetery-etc-Manhattan&#39; = 193, &#39;park-cemetery-etc-Queens&#39; = 194, &#39;park-cemetery-etc-Staten Island&#39; = 195),  pickup_puma UInt16,  dropoff_nyct2010_gid UInt8,  dropoff_ctlabel Float32,  dropoff_borocode UInt8,  dropoff_boroname Enum8(&#39;&#39; = 0, &#39;Manhattan&#39; = 1, &#39;Bronx&#39; = 2, &#39;Brooklyn&#39; = 3, &#39;Queens&#39; = 4, &#39;Staten Island&#39; = 5),  dropoff_ct2010 FixedString(6),  dropoff_boroct2010 FixedString(7),  dropoff_cdeligibil Enum8(&#39; &#39; = 0, &#39;E&#39; = 1, &#39;I&#39; = 2),  dropoff_ntacode FixedString(4),  dropoff_ntaname Enum16(&#39;&#39; = 0, &#39;Airport&#39; = 1, &#39;Allerton-Pelham Gardens&#39; = 2, &#39;Annadale-Huguenot-Prince\&#39;s Bay-Eltingville&#39; = 3, &#39;Arden Heights&#39; = 4, &#39;Astoria&#39; = 5, &#39;Auburndale&#39; = 6, &#39;Baisley Park&#39; = 7, &#39;Bath Beach&#39; = 8, &#39;Battery Park City-Lower Manhattan&#39; = 9, &#39;Bay Ridge&#39; = 10, &#39;Bayside-Bayside Hills&#39; = 11, &#39;Bedford&#39; = 12, &#39;Bedford Park-Fordham North&#39; = 13, &#39;Bellerose&#39; = 14, &#39;Belmont&#39; = 15, &#39;Bensonhurst East&#39; = 16, &#39;Bensonhurst West&#39; = 17, &#39;Borough Park&#39; = 18, &#39;Breezy Point-Belle Harbor-Rockaway Park-Broad Channel&#39; = 19, &#39;Briarwood-Jamaica Hills&#39; = 20, &#39;Brighton Beach&#39; = 21, &#39;Bronxdale&#39; = 22, &#39;Brooklyn Heights-Cobble Hill&#39; = 23, &#39;Brownsville&#39; = 24, &#39;Bushwick North&#39; = 25, &#39;Bushwick South&#39; = 26, &#39;Cambria Heights&#39; = 27, &#39;Canarsie&#39; = 28, &#39;Carroll Gardens-Columbia Street-Red Hook&#39; = 29, &#39;Central Harlem North-Polo Grounds&#39; = 30, &#39;Central Harlem South&#39; = 31, &#39;Charleston-Richmond Valley-Tottenville&#39; = 32, &#39;Chinatown&#39; = 33, &#39;Claremont-Bathgate&#39; = 34, &#39;Clinton&#39; = 35, &#39;Clinton Hill&#39; = 36, &#39;Co-op City&#39; = 37, &#39;College Point&#39; = 38, &#39;Corona&#39; = 39, &#39;Crotona Park East&#39; = 40, &#39;Crown Heights North&#39; = 41, &#39;Crown Heights South&#39; = 42, &#39;Cypress Hills-City Line&#39; = 43, &#39;DUMBO-Vinegar Hill-Downtown Brooklyn-Boerum Hill&#39; = 44, &#39;Douglas Manor-Douglaston-Little Neck&#39; = 45, &#39;Dyker Heights&#39; = 46, &#39;East Concourse-Concourse Village&#39; = 47, &#39;East Elmhurst&#39; = 48, &#39;East Flatbush-Farragut&#39; = 49, &#39;East Flushing&#39; = 50, &#39;East Harlem North&#39; = 51, &#39;East Harlem South&#39; = 52, &#39;East New York&#39; = 53, &#39;East New York (Pennsylvania Ave)&#39; = 54, &#39;East Tremont&#39; = 55, &#39;East Village&#39; = 56, &#39;East Williamsburg&#39; = 57, &#39;Eastchester-Edenwald-Baychester&#39; = 58, &#39;Elmhurst&#39; = 59, &#39;Elmhurst-Maspeth&#39; = 60, &#39;Erasmus&#39; = 61, &#39;Far Rockaway-Bayswater&#39; = 62, &#39;Flatbush&#39; = 63, &#39;Flatlands&#39; = 64, &#39;Flushing&#39; = 65, &#39;Fordham South&#39; = 66, &#39;Forest Hills&#39; = 67, &#39;Fort Greene&#39; = 68, &#39;Fresh Meadows-Utopia&#39; = 69, &#39;Ft. Totten-Bay Terrace-Clearview&#39; = 70, &#39;Georgetown-Marine Park-Bergen Beach-Mill Basin&#39; = 71, &#39;Glen Oaks-Floral Park-New Hyde Park&#39; = 72, &#39;Glendale&#39; = 73, &#39;Gramercy&#39; = 74, &#39;Grasmere-Arrochar-Ft. Wadsworth&#39; = 75, &#39;Gravesend&#39; = 76, &#39;Great Kills&#39; = 77, &#39;Greenpoint&#39; = 78, &#39;Grymes Hill-Clifton-Fox Hills&#39; = 79, &#39;Hamilton Heights&#39; = 80, &#39;Hammels-Arverne-Edgemere&#39; = 81, &#39;Highbridge&#39; = 82, &#39;Hollis&#39; = 83, &#39;Homecrest&#39; = 84, &#39;Hudson Yards-Chelsea-Flatiron-Union Square&#39; = 85, &#39;Hunters Point-Sunnyside-West Maspeth&#39; = 86, &#39;Hunts Point&#39; = 87, &#39;Jackson Heights&#39; = 88, &#39;Jamaica&#39; = 89, &#39;Jamaica Estates-Holliswood&#39; = 90, &#39;Kensington-Ocean Parkway&#39; = 91, &#39;Kew Gardens&#39; = 92, &#39;Kew Gardens Hills&#39; = 93, &#39;Kingsbridge Heights&#39; = 94, &#39;Laurelton&#39; = 95, &#39;Lenox Hill-Roosevelt Island&#39; = 96, &#39;Lincoln Square&#39; = 97, &#39;Lindenwood-Howard Beach&#39; = 98, &#39;Longwood&#39; = 99, &#39;Lower East Side&#39; = 100, &#39;Madison&#39; = 101, &#39;Manhattanville&#39; = 102, &#39;Marble Hill-Inwood&#39; = 103, &#39;Mariner\&#39;s Harbor-Arlington-Port Ivory-Graniteville&#39; = 104, &#39;Maspeth&#39; = 105, &#39;Melrose South-Mott Haven North&#39; = 106, &#39;Middle Village&#39; = 107, &#39;Midtown-Midtown South&#39; = 108, &#39;Midwood&#39; = 109, &#39;Morningside Heights&#39; = 110, &#39;Morrisania-Melrose&#39; = 111, &#39;Mott Haven-Port Morris&#39; = 112, &#39;Mount Hope&#39; = 113, &#39;Murray Hill&#39; = 114, &#39;Murray Hill-Kips Bay&#39; = 115, &#39;New Brighton-Silver Lake&#39; = 116, &#39;New Dorp-Midland Beach&#39; = 117, &#39;New Springville-Bloomfield-Travis&#39; = 118, &#39;North Corona&#39; = 119, &#39;North Riverdale-Fieldston-Riverdale&#39; = 120, &#39;North Side-South Side&#39; = 121, &#39;Norwood&#39; = 122, &#39;Oakland Gardens&#39; = 123, &#39;Oakwood-Oakwood Beach&#39; = 124, &#39;Ocean Hill&#39; = 125, &#39;Ocean Parkway South&#39; = 126, &#39;Old Astoria&#39; = 127, &#39;Old Town-Dongan Hills-South Beach&#39; = 128, &#39;Ozone Park&#39; = 129, &#39;Park Slope-Gowanus&#39; = 130, &#39;Parkchester&#39; = 131, &#39;Pelham Bay-Country Club-City Island&#39; = 132, &#39;Pelham Parkway&#39; = 133, &#39;Pomonok-Flushing Heights-Hillcrest&#39; = 134, &#39;Port Richmond&#39; = 135, &#39;Prospect Heights&#39; = 136, &#39;Prospect Lefferts Gardens-Wingate&#39; = 137, &#39;Queens Village&#39; = 138, &#39;Queensboro Hill&#39; = 139, &#39;Queensbridge-Ravenswood-Long Island City&#39; = 140, &#39;Rego Park&#39; = 141, &#39;Richmond Hill&#39; = 142, &#39;Ridgewood&#39; = 143, &#39;Rikers Island&#39; = 144, &#39;Rosedale&#39; = 145, &#39;Rossville-Woodrow&#39; = 146, &#39;Rugby-Remsen Village&#39; = 147, &#39;Schuylerville-Throgs Neck-Edgewater Park&#39; = 148, &#39;Seagate-Coney Island&#39; = 149, &#39;Sheepshead Bay-Gerritsen Beach-Manhattan Beach&#39; = 150, &#39;SoHo-TriBeCa-Civic Center-Little Italy&#39; = 151, &#39;Soundview-Bruckner&#39; = 152, &#39;Soundview-Castle Hill-Clason Point-Harding Park&#39; = 153, &#39;South Jamaica&#39; = 154, &#39;South Ozone Park&#39; = 155, &#39;Springfield Gardens North&#39; = 156, &#39;Springfield Gardens South-Brookville&#39; = 157, &#39;Spuyten Duyvil-Kingsbridge&#39; = 158, &#39;St. Albans&#39; = 159, &#39;Stapleton-Rosebank&#39; = 160, &#39;Starrett City&#39; = 161, &#39;Steinway&#39; = 162, &#39;Stuyvesant Heights&#39; = 163, &#39;Stuyvesant Town-Cooper Village&#39; = 164, &#39;Sunset Park East&#39; = 165, &#39;Sunset Park West&#39; = 166, &#39;Todt Hill-Emerson Hill-Heartland Village-Lighthouse Hill&#39; = 167, &#39;Turtle Bay-East Midtown&#39; = 168, &#39;University Heights-Morris Heights&#39; = 169, &#39;Upper East Side-Carnegie Hill&#39; = 170, &#39;Upper West Side&#39; = 171, &#39;Van Cortlandt Village&#39; = 172, &#39;Van Nest-Morris Park-Westchester Square&#39; = 173, &#39;Washington Heights North&#39; = 174, &#39;Washington Heights South&#39; = 175, &#39;West Brighton&#39; = 176, &#39;West Concourse&#39; = 177, &#39;West Farms-Bronx River&#39; = 178, &#39;West New Brighton-New Brighton-St. George&#39; = 179, &#39;West Village&#39; = 180, &#39;Westchester-Unionport&#39; = 181, &#39;Westerleigh&#39; = 182, &#39;Whitestone&#39; = 183, &#39;Williamsbridge-Olinville&#39; = 184, &#39;Williamsburg&#39; = 185, &#39;Windsor Terrace&#39; = 186, &#39;Woodhaven&#39; = 187, &#39;Woodlawn-Wakefield&#39; = 188, &#39;Woodside&#39; = 189, &#39;Yorkville&#39; = 190, &#39;park-cemetery-etc-Bronx&#39; = 191, &#39;park-cemetery-etc-Brooklyn&#39; = 192, &#39;park-cemetery-etc-Manhattan&#39; = 193, &#39;park-cemetery-etc-Queens&#39; = 194, &#39;park-cemetery-etc-Staten Island&#39; = 195),  dropoff_puma UInt16) ENGINE = MergeTree(pickup_date, pickup_datetime, 8192)
</pre></div>


<p>On the source server:</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">trips_mergetree_x3</span> <span class="k">AS</span> <span class="n">trips_mergetree_third</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">Distributed</span><span class="p">(</span><span class="n">perftest</span><span class="p">,</span> <span class="k">default</span><span class="p">,</span> <span class="n">trips_mergetree_third</span><span class="p">,</span> <span class="n">rand</span><span class="p">())</span>
</pre></div>


<p>The following query redistributes data:</p>
<div class="codehilite"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">trips_mergetree_x3</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">trips_mergetree</span>
</pre></div>


<p>This takes 2454 seconds.</p>
<p>On three servers:</p>
<p>Q1: 0.212 seconds.
Q2: 0.438 seconds.
Q3: 0.733 seconds.
Q4: 1.241 seconds.</p>
<p>No surprises here, since the queries are scaled linearly.</p>
<p>We also have results from a cluster of 140 servers:</p>
<p>Q1: 0.028 sec.
Q2: 0.043 sec.
Q3: 0.051 sec.
Q4: 0.072 sec.</p>
<p>In this case, the query processing time is determined above all by network latency.
We ran queries using a client located in a Yandex datacenter in Finland on a cluster in Russia, which added about 20 ms of latency.</p>
<h3 id="summary">Summary</h3>
<div class="codehilite"><pre><span></span>nodes   Q1     Q2     Q3     Q4
  1  0.490  1.224  2.104  3.593
  3  0.212  0.438  0.733  1.241
140  0.028  0.043  0.051  0.072
</pre></div>


<h2 id="amplab-big-data-benchmark">AMPLab Big Data Benchmark</h2>
<p>See <a href="https://amplab.cs.berkeley.edu/benchmark/">https://amplab.cs.berkeley.edu/benchmark/</a></p>
<p>Sign up for a free account at <a href="https://aws.amazon.com">https://aws.amazon.com</a>. You will need a credit card, email and phone number.Get a new access key at <a href="https://console.aws.amazon.com/iam/home?nc2=h_m_sc#security_credential">https://console.aws.amazon.com/iam/home?nc2=h_m_sc#security_credential</a></p>
<p>Run the following in the console:</p>
<div class="codehilite"><pre><span></span>sudo apt-get install s3cmd
mkdir tiny<span class="p">;</span> <span class="nb">cd</span> tiny<span class="p">;</span>
s3cmd sync s3://big-data-benchmark/pavlo/text-deflate/tiny/ .
<span class="nb">cd</span> ..
mkdir 1node<span class="p">;</span> <span class="nb">cd</span> 1node<span class="p">;</span>
s3cmd sync s3://big-data-benchmark/pavlo/text-deflate/1node/ .
<span class="nb">cd</span> ..
mkdir 5nodes<span class="p">;</span> <span class="nb">cd</span> 5nodes<span class="p">;</span>
s3cmd sync s3://big-data-benchmark/pavlo/text-deflate/5nodes/ .
<span class="nb">cd</span> ..
</pre></div>


<p>Run the following ClickHouse queries:</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">rankings_tiny</span>
<span class="p">(</span>
    <span class="n">pageURL</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">pageRank</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">avgDuration</span> <span class="n">UInt32</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">Log</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">uservisits_tiny</span>
<span class="p">(</span>
    <span class="n">sourceIP</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">destinationURL</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">visitDate</span> <span class="nb">Date</span><span class="p">,</span>
    <span class="n">adRevenue</span> <span class="n">Float32</span><span class="p">,</span>
    <span class="n">UserAgent</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">cCode</span> <span class="n">FixedString</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">lCode</span> <span class="n">FixedString</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
    <span class="n">searchWord</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">duration</span> <span class="n">UInt32</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">MergeTree</span><span class="p">(</span><span class="n">visitDate</span><span class="p">,</span> <span class="n">visitDate</span><span class="p">,</span> <span class="mi">8192</span><span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">rankings_1node</span>
<span class="p">(</span>
    <span class="n">pageURL</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">pageRank</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">avgDuration</span> <span class="n">UInt32</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">Log</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">uservisits_1node</span>
<span class="p">(</span>
    <span class="n">sourceIP</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">destinationURL</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">visitDate</span> <span class="nb">Date</span><span class="p">,</span>
    <span class="n">adRevenue</span> <span class="n">Float32</span><span class="p">,</span>
    <span class="n">UserAgent</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">cCode</span> <span class="n">FixedString</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">lCode</span> <span class="n">FixedString</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
    <span class="n">searchWord</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">duration</span> <span class="n">UInt32</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">MergeTree</span><span class="p">(</span><span class="n">visitDate</span><span class="p">,</span> <span class="n">visitDate</span><span class="p">,</span> <span class="mi">8192</span><span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">rankings_5nodes_on_single</span>
<span class="p">(</span>
    <span class="n">pageURL</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">pageRank</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">avgDuration</span> <span class="n">UInt32</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">Log</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">uservisits_5nodes_on_single</span>
<span class="p">(</span>
    <span class="n">sourceIP</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">destinationURL</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">visitDate</span> <span class="nb">Date</span><span class="p">,</span>
    <span class="n">adRevenue</span> <span class="n">Float32</span><span class="p">,</span>
    <span class="n">UserAgent</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">cCode</span> <span class="n">FixedString</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">lCode</span> <span class="n">FixedString</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
    <span class="n">searchWord</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">duration</span> <span class="n">UInt32</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">MergeTree</span><span class="p">(</span><span class="n">visitDate</span><span class="p">,</span> <span class="n">visitDate</span><span class="p">,</span> <span class="mi">8192</span><span class="p">);</span>
</pre></div>


<p>Go back to the console:</p>
<div class="codehilite"><pre><span></span><span class="k">for</span> i in tiny/rankings/*.deflate<span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="nv">$i</span><span class="p">;</span> zlib-flate -uncompress &lt; <span class="nv">$i</span> <span class="p">|</span> clickhouse-client --host<span class="o">=</span>example-perftest01j --query<span class="o">=</span><span class="s2">&quot;INSERT INTO rankings_tiny FORMAT CSV&quot;</span><span class="p">;</span> <span class="k">done</span>
<span class="k">for</span> i in tiny/uservisits/*.deflate<span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="nv">$i</span><span class="p">;</span> zlib-flate -uncompress &lt; <span class="nv">$i</span> <span class="p">|</span> clickhouse-client --host<span class="o">=</span>example-perftest01j --query<span class="o">=</span><span class="s2">&quot;INSERT INTO uservisits_tiny FORMAT CSV&quot;</span><span class="p">;</span> <span class="k">done</span>
<span class="k">for</span> i in 1node/rankings/*.deflate<span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="nv">$i</span><span class="p">;</span> zlib-flate -uncompress &lt; <span class="nv">$i</span> <span class="p">|</span> clickhouse-client --host<span class="o">=</span>example-perftest01j --query<span class="o">=</span><span class="s2">&quot;INSERT INTO rankings_1node FORMAT CSV&quot;</span><span class="p">;</span> <span class="k">done</span>
<span class="k">for</span> i in 1node/uservisits/*.deflate<span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="nv">$i</span><span class="p">;</span> zlib-flate -uncompress &lt; <span class="nv">$i</span> <span class="p">|</span> clickhouse-client --host<span class="o">=</span>example-perftest01j --query<span class="o">=</span><span class="s2">&quot;INSERT INTO uservisits_1node FORMAT CSV&quot;</span><span class="p">;</span> <span class="k">done</span>
<span class="k">for</span> i in 5nodes/rankings/*.deflate<span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="nv">$i</span><span class="p">;</span> zlib-flate -uncompress &lt; <span class="nv">$i</span> <span class="p">|</span> clickhouse-client --host<span class="o">=</span>example-perftest01j --query<span class="o">=</span><span class="s2">&quot;INSERT INTO rankings_5nodes_on_single FORMAT CSV&quot;</span><span class="p">;</span> <span class="k">done</span>
<span class="k">for</span> i in 5nodes/uservisits/*.deflate<span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="nv">$i</span><span class="p">;</span> zlib-flate -uncompress &lt; <span class="nv">$i</span> <span class="p">|</span> clickhouse-client --host<span class="o">=</span>example-perftest01j --query<span class="o">=</span><span class="s2">&quot;INSERT INTO uservisits_5nodes_on_single FORMAT CSV&quot;</span><span class="p">;</span> <span class="k">done</span>
</pre></div>


<p>Queries for obtaining data samples:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">pageURL</span><span class="p">,</span> <span class="n">pageRank</span> <span class="k">FROM</span> <span class="n">rankings_1node</span> <span class="k">WHERE</span> <span class="n">pageRank</span> <span class="o">&gt;</span> <span class="mi">1000</span>

<span class="k">SELECT</span> <span class="k">substring</span><span class="p">(</span><span class="n">sourceIP</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="k">sum</span><span class="p">(</span><span class="n">adRevenue</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">uservisits_1node</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="k">substring</span><span class="p">(</span><span class="n">sourceIP</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

<span class="k">SELECT</span>
    <span class="n">sourceIP</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">adRevenue</span><span class="p">)</span> <span class="k">AS</span> <span class="n">totalRevenue</span><span class="p">,</span>
    <span class="k">avg</span><span class="p">(</span><span class="n">pageRank</span><span class="p">)</span> <span class="k">AS</span> <span class="n">pageRank</span>
<span class="k">FROM</span> <span class="n">rankings_1node</span> <span class="k">ALL</span> <span class="k">INNER</span> <span class="k">JOIN</span>
<span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">sourceIP</span><span class="p">,</span>
        <span class="n">destinationURL</span> <span class="k">AS</span> <span class="n">pageURL</span><span class="p">,</span>
        <span class="n">adRevenue</span>
    <span class="k">FROM</span> <span class="n">uservisits_1node</span>
    <span class="k">WHERE</span> <span class="p">(</span><span class="n">visitDate</span> <span class="o">&gt;</span> <span class="s1">&#39;1980-01-01&#39;</span><span class="p">)</span> <span class="k">AND</span> <span class="p">(</span><span class="n">visitDate</span> <span class="o">&lt;</span> <span class="s1">&#39;1980-04-01&#39;</span><span class="p">)</span>
<span class="p">)</span> <span class="k">USING</span> <span class="n">pageURL</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">sourceIP</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">totalRevenue</span> <span class="k">DESC</span>
<span class="k">LIMIT</span> <span class="mi">1</span>
</pre></div>


<h2 id="wikistat">WikiStat</h2>
<p>See: <a href="http://dumps.wikimedia.org/other/pagecounts-raw/">http://dumps.wikimedia.org/other/pagecounts-raw/</a></p>
<p>Creating a table:</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">wikistat</span>
<span class="p">(</span>
    <span class="nb">date</span> <span class="nb">Date</span><span class="p">,</span>
    <span class="n">time</span> <span class="n">DateTime</span><span class="p">,</span>
    <span class="n">project</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">subproject</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">path</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">hits</span> <span class="n">UInt64</span><span class="p">,</span>
    <span class="k">size</span> <span class="n">UInt64</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">MergeTree</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">time</span><span class="p">),</span> <span class="mi">8192</span><span class="p">);</span>
</pre></div>


<p>Loading data:</p>
<div class="codehilite"><pre><span></span><span class="k">for</span> i in <span class="o">{</span><span class="m">2007</span>..2016<span class="o">}</span><span class="p">;</span> <span class="k">do</span> <span class="k">for</span> j in <span class="o">{</span><span class="m">01</span>..12<span class="o">}</span><span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="nv">$i</span>-<span class="nv">$j</span> &gt;<span class="p">&amp;</span><span class="m">2</span><span class="p">;</span> curl -sSL <span class="s2">&quot;http://dumps.wikimedia.org/other/pagecounts-raw/</span><span class="nv">$i</span><span class="s2">/</span><span class="nv">$i</span><span class="s2">-</span><span class="nv">$j</span><span class="s2">/&quot;</span> <span class="p">|</span> grep -oE <span class="s1">&#39;pagecounts-[0-9]+-[0-9]+\.gz&#39;</span><span class="p">;</span> <span class="k">done</span><span class="p">;</span> <span class="k">done</span> <span class="p">|</span> sort <span class="p">|</span> uniq <span class="p">|</span> tee links.txt
cat links.txt <span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> link<span class="p">;</span> <span class="k">do</span> wget http://dumps.wikimedia.org/other/pagecounts-raw/<span class="k">$(</span><span class="nb">echo</span> <span class="nv">$link</span> <span class="p">|</span> sed -r <span class="s1">&#39;s/pagecounts-([0-9]{4})([0-9]{2})[0-9]{2}-[0-9]+\.gz/\1/&#39;</span><span class="k">)</span>/<span class="k">$(</span><span class="nb">echo</span> <span class="nv">$link</span> <span class="p">|</span> sed -r <span class="s1">&#39;s/pagecounts-([0-9]{4})([0-9]{2})[0-9]{2}-[0-9]+\.gz/\1-\2/&#39;</span><span class="k">)</span>/<span class="nv">$link</span><span class="p">;</span> <span class="k">done</span>
ls -1 /opt/wikistat/ <span class="p">|</span> grep gz <span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> i<span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="nv">$i</span><span class="p">;</span> gzip -cd /opt/wikistat/<span class="nv">$i</span> <span class="p">|</span> ./wikistat-loader --time<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">echo</span> -n <span class="nv">$i</span> <span class="p">|</span> sed -r <span class="s1">&#39;s/pagecounts-([0-9]{4})([0-9]{2})([0-9]{2})-([0-9]{2})([0-9]{2})([0-9]{2})\.gz/\1-\2-\3 \4-00-00/&#39;</span><span class="k">)</span><span class="s2">&quot;</span> <span class="p">|</span> clickhouse-client --query<span class="o">=</span><span class="s2">&quot;INSERT INTO wikistat FORMAT TabSeparated&quot;</span><span class="p">;</span> <span class="k">done</span>
</pre></div>


<h2 id="terabyte-of-click-logs-from-criteo">Terabyte of click logs from Criteo</h2>
<p>Download the data from <a href="http://labs.criteo.com/downloads/download-terabyte-click-logs/">http://labs.criteo.com/downloads/download-terabyte-click-logs/</a></p>
<p>Create a table to import the log to:</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">criteo_log</span> <span class="p">(</span><span class="nb">date</span> <span class="nb">Date</span><span class="p">,</span> <span class="n">clicked</span> <span class="n">UInt8</span><span class="p">,</span> <span class="n">int1</span> <span class="n">Int32</span><span class="p">,</span> <span class="n">int2</span> <span class="n">Int32</span><span class="p">,</span> <span class="n">int3</span> <span class="n">Int32</span><span class="p">,</span> <span class="n">int4</span> <span class="n">Int32</span><span class="p">,</span> <span class="n">int5</span> <span class="n">Int32</span><span class="p">,</span> <span class="n">int6</span> <span class="n">Int32</span><span class="p">,</span> <span class="n">int7</span> <span class="n">Int32</span><span class="p">,</span> <span class="nb">int8</span> <span class="n">Int32</span><span class="p">,</span> <span class="n">int9</span> <span class="n">Int32</span><span class="p">,</span> <span class="n">int10</span> <span class="n">Int32</span><span class="p">,</span> <span class="n">int11</span> <span class="n">Int32</span><span class="p">,</span> <span class="n">int12</span> <span class="n">Int32</span><span class="p">,</span> <span class="n">int13</span> <span class="n">Int32</span><span class="p">,</span> <span class="n">cat1</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat2</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat3</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat4</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat5</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat6</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat7</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat8</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat9</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat10</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat11</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat12</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat13</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat14</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat15</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat16</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat17</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat18</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat19</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat20</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat21</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat22</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat23</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat24</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat25</span> <span class="n">String</span><span class="p">,</span> <span class="n">cat26</span> <span class="n">String</span><span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">Log</span>
</pre></div>


<p>Download the data:</p>
<div class="codehilite"><pre><span></span><span class="k">for</span> i in <span class="o">{</span><span class="m">00</span>..23<span class="o">}</span><span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="nv">$i</span><span class="p">;</span> zcat datasets/criteo/day_<span class="si">${</span><span class="nv">i</span><span class="p">#0</span><span class="si">}</span>.gz <span class="p">|</span> sed -r <span class="s1">&#39;s/^/2000-01-&#39;</span><span class="si">${</span><span class="nv">i</span><span class="p">/00/24</span><span class="si">}</span><span class="s1">&#39;\t/&#39;</span> <span class="p">|</span> clickhouse-client --host<span class="o">=</span>example-perftest01j --query<span class="o">=</span><span class="s2">&quot;INSERT INTO criteo_log FORMAT TabSeparated&quot;</span><span class="p">;</span> <span class="k">done</span>
</pre></div>


<p>Create a table for the converted data:</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">criteo</span>
<span class="p">(</span>
    <span class="nb">date</span> <span class="nb">Date</span><span class="p">,</span>
    <span class="n">clicked</span> <span class="n">UInt8</span><span class="p">,</span>
    <span class="n">int1</span> <span class="n">Int32</span><span class="p">,</span>
    <span class="n">int2</span> <span class="n">Int32</span><span class="p">,</span>
    <span class="n">int3</span> <span class="n">Int32</span><span class="p">,</span>
    <span class="n">int4</span> <span class="n">Int32</span><span class="p">,</span>
    <span class="n">int5</span> <span class="n">Int32</span><span class="p">,</span>
    <span class="n">int6</span> <span class="n">Int32</span><span class="p">,</span>
    <span class="n">int7</span> <span class="n">Int32</span><span class="p">,</span>
    <span class="nb">int8</span> <span class="n">Int32</span><span class="p">,</span>
    <span class="n">int9</span> <span class="n">Int32</span><span class="p">,</span>
    <span class="n">int10</span> <span class="n">Int32</span><span class="p">,</span>
    <span class="n">int11</span> <span class="n">Int32</span><span class="p">,</span>
    <span class="n">int12</span> <span class="n">Int32</span><span class="p">,</span>
    <span class="n">int13</span> <span class="n">Int32</span><span class="p">,</span>
    <span class="n">icat1</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat2</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat3</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat4</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat5</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat6</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat7</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat8</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat9</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat10</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat11</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat12</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat13</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat14</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat15</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat16</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat17</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat18</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat19</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat20</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat21</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat22</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat23</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat24</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat25</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">icat26</span> <span class="n">UInt32</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">MergeTree</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span> <span class="n">intHash32</span><span class="p">(</span><span class="n">icat1</span><span class="p">),</span> <span class="p">(</span><span class="nb">date</span><span class="p">,</span> <span class="n">intHash32</span><span class="p">(</span><span class="n">icat1</span><span class="p">)),</span> <span class="mi">8192</span><span class="p">)</span>
</pre></div>


<p>Transform data from the raw log and put it in the second table:</p>
<div class="codehilite"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">criteo</span> <span class="k">SELECT</span> <span class="nb">date</span><span class="p">,</span> <span class="n">clicked</span><span class="p">,</span> <span class="n">int1</span><span class="p">,</span> <span class="n">int2</span><span class="p">,</span> <span class="n">int3</span><span class="p">,</span> <span class="n">int4</span><span class="p">,</span> <span class="n">int5</span><span class="p">,</span> <span class="n">int6</span><span class="p">,</span> <span class="n">int7</span><span class="p">,</span> <span class="nb">int8</span><span class="p">,</span> <span class="n">int9</span><span class="p">,</span> <span class="n">int10</span><span class="p">,</span> <span class="n">int11</span><span class="p">,</span> <span class="n">int12</span><span class="p">,</span> <span class="n">int13</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat1</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat1</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat2</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat2</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat3</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat3</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat4</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat4</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat5</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat5</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat6</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat6</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat7</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat7</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat8</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat8</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat9</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat9</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat10</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat10</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat11</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat11</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat12</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat12</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat13</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat13</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat14</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat14</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat15</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat15</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat16</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat16</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat17</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat17</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat18</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat18</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat19</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat19</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat20</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat20</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat21</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat21</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat22</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat22</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat23</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat23</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat24</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat24</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat25</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat25</span><span class="p">,</span> <span class="n">reinterpretAsUInt32</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="n">cat26</span><span class="p">))</span> <span class="k">AS</span> <span class="n">icat26</span> <span class="k">FROM</span> <span class="n">criteo_log</span><span class="p">;</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">criteo_log</span><span class="p">;</span>
</pre></div>


<h2 id="star-schema-benchmark">Star Schema Benchmark</h2>
<p>Compiling dbgen: <a href="https://github.com/vadimtk/ssb-dbgen">https://github.com/vadimtk/ssb-dbgen</a></p>
<div class="codehilite"><pre><span></span>git clone git@github.com:vadimtk/ssb-dbgen.git
<span class="nb">cd</span> ssb-dbgen
make
</pre></div>


<p>There will be some warnings during the process, but this is normal.</p>
<p>Place <code>dbgen</code>  and <code>dists.dss</code>  in any location with 800 GB of free disk space.</p>
<p>Generating data:</p>
<div class="codehilite"><pre><span></span>./dbgen -s <span class="m">1000</span> -T c
./dbgen -s <span class="m">1000</span> -T l
</pre></div>


<p>Creating tables in ClickHouse:</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">lineorder</span> <span class="p">(</span>
        <span class="n">LO_ORDERKEY</span>             <span class="n">UInt32</span><span class="p">,</span>
        <span class="n">LO_LINENUMBER</span>           <span class="n">UInt8</span><span class="p">,</span>
        <span class="n">LO_CUSTKEY</span>              <span class="n">UInt32</span><span class="p">,</span>
        <span class="n">LO_PARTKEY</span>              <span class="n">UInt32</span><span class="p">,</span>
        <span class="n">LO_SUPPKEY</span>              <span class="n">UInt32</span><span class="p">,</span>
        <span class="n">LO_ORDERDATE</span>            <span class="nb">Date</span><span class="p">,</span>
        <span class="n">LO_ORDERPRIORITY</span>        <span class="n">String</span><span class="p">,</span>
        <span class="n">LO_SHIPPRIORITY</span>         <span class="n">UInt8</span><span class="p">,</span>
        <span class="n">LO_QUANTITY</span>             <span class="n">UInt8</span><span class="p">,</span>
        <span class="n">LO_EXTENDEDPRICE</span>        <span class="n">UInt32</span><span class="p">,</span>
        <span class="n">LO_ORDTOTALPRICE</span>        <span class="n">UInt32</span><span class="p">,</span>
        <span class="n">LO_DISCOUNT</span>             <span class="n">UInt8</span><span class="p">,</span>
        <span class="n">LO_REVENUE</span>              <span class="n">UInt32</span><span class="p">,</span>
        <span class="n">LO_SUPPLYCOST</span>           <span class="n">UInt32</span><span class="p">,</span>
        <span class="n">LO_TAX</span>                  <span class="n">UInt8</span><span class="p">,</span>
        <span class="n">LO_COMMITDATE</span>           <span class="nb">Date</span><span class="p">,</span>
        <span class="n">LO_SHIPMODE</span>             <span class="n">String</span>
<span class="p">)</span><span class="n">Engine</span><span class="o">=</span><span class="n">MergeTree</span><span class="p">(</span><span class="n">LO_ORDERDATE</span><span class="p">,(</span><span class="n">LO_ORDERKEY</span><span class="p">,</span><span class="n">LO_LINENUMBER</span><span class="p">,</span><span class="n">LO_ORDERDATE</span><span class="p">),</span><span class="mi">8192</span><span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">customer</span> <span class="p">(</span>
        <span class="n">C_CUSTKEY</span>       <span class="n">UInt32</span><span class="p">,</span>
        <span class="n">C_NAME</span>          <span class="n">String</span><span class="p">,</span>
        <span class="n">C_ADDRESS</span>       <span class="n">String</span><span class="p">,</span>
        <span class="n">C_CITY</span>          <span class="n">String</span><span class="p">,</span>
        <span class="n">C_NATION</span>        <span class="n">String</span><span class="p">,</span>
        <span class="n">C_REGION</span>        <span class="n">String</span><span class="p">,</span>
        <span class="n">C_PHONE</span>         <span class="n">String</span><span class="p">,</span>
        <span class="n">C_MKTSEGMENT</span>    <span class="n">String</span><span class="p">,</span>
        <span class="n">C_FAKEDATE</span>      <span class="nb">Date</span>
<span class="p">)</span><span class="n">Engine</span><span class="o">=</span><span class="n">MergeTree</span><span class="p">(</span><span class="n">C_FAKEDATE</span><span class="p">,(</span><span class="n">C_CUSTKEY</span><span class="p">,</span><span class="n">C_FAKEDATE</span><span class="p">),</span><span class="mi">8192</span><span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">part</span> <span class="p">(</span>
        <span class="n">P_PARTKEY</span>       <span class="n">UInt32</span><span class="p">,</span>
        <span class="n">P_NAME</span>          <span class="n">String</span><span class="p">,</span>
        <span class="n">P_MFGR</span>          <span class="n">String</span><span class="p">,</span>
        <span class="n">P_CATEGORY</span>      <span class="n">String</span><span class="p">,</span>
        <span class="n">P_BRAND</span>         <span class="n">String</span><span class="p">,</span>
        <span class="n">P_COLOR</span>         <span class="n">String</span><span class="p">,</span>
        <span class="n">P_TYPE</span>          <span class="n">String</span><span class="p">,</span>
        <span class="n">P_SIZE</span>          <span class="n">UInt8</span><span class="p">,</span>
        <span class="n">P_CONTAINER</span>     <span class="n">String</span><span class="p">,</span>
        <span class="n">P_FAKEDATE</span>      <span class="nb">Date</span>
<span class="p">)</span><span class="n">Engine</span><span class="o">=</span><span class="n">MergeTree</span><span class="p">(</span><span class="n">P_FAKEDATE</span><span class="p">,(</span><span class="n">P_PARTKEY</span><span class="p">,</span><span class="n">P_FAKEDATE</span><span class="p">),</span><span class="mi">8192</span><span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">lineorderd</span> <span class="k">AS</span> <span class="n">lineorder</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">Distributed</span><span class="p">(</span><span class="n">perftest_3shards_1replicas</span><span class="p">,</span> <span class="k">default</span><span class="p">,</span> <span class="n">lineorder</span><span class="p">,</span> <span class="n">rand</span><span class="p">());</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">customerd</span> <span class="k">AS</span> <span class="n">customer</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">Distributed</span><span class="p">(</span><span class="n">perftest_3shards_1replicas</span><span class="p">,</span> <span class="k">default</span><span class="p">,</span> <span class="n">customer</span><span class="p">,</span> <span class="n">rand</span><span class="p">());</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">partd</span> <span class="k">AS</span> <span class="n">part</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">Distributed</span><span class="p">(</span><span class="n">perftest_3shards_1replicas</span><span class="p">,</span> <span class="k">default</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">rand</span><span class="p">());</span>
</pre></div>


<p>For testing on a single server, just use MergeTree tables.
For distributed testing, you need to configure the <code>perftest_3shards_1replicas</code>  cluster in the config file.
Next, create MergeTree tables on each server and a Distributed above them.</p>
<p>Downloading data (change 'customer' to 'customerd' in the distributed version):</p>
<div class="codehilite"><pre><span></span>cat customer.tbl <span class="p">|</span> sed <span class="s1">&#39;s/$/2000-01-01/&#39;</span> <span class="p">|</span> clickhouse-client --query <span class="s2">&quot;INSERT INTO customer FORMAT CSV&quot;</span>
cat lineorder.tbl <span class="p">|</span> clickhouse-client --query <span class="s2">&quot;INSERT INTO lineorder FORMAT CSV&quot;</span>
</pre></div>


<p><a name="interfaces"></a></p>
<h2 id="interfaces">Interfaces</h2>
<p>To explore the system's capabilities, download data to tables, or make manual queries, use the clickhouse-client program.</p>
<h2 id="command-line-client">Command-line client</h2>
<p>To work from the command line, you can use <code>clickhouse-client</code>:</p>
<div class="codehilite"><pre><span></span>$ clickhouse-client
ClickHouse client version <span class="m">0</span>.0.26176.
Connecting to localhost:9000.
Connected to ClickHouse server version <span class="m">0</span>.0.26176.

:<span class="o">)</span>
</pre></div>


<p>The client supports command-line options and configuration files. For more information, see "<a href="#interfaces_cli_configuration">Configuring</a>".</p>
<h3 id="usage">Usage</h3>
<p>The client can be used in interactive and non-interactive (batch) mode.
To use batch mode, specify the 'query' parameter, or send data to 'stdin' (it verifies that 'stdin' is not a terminal), or both.
Similar to the HTTP interface, when using the 'query' parameter and sending data to 'stdin', the request is a concatenation of the 'query' parameter, a line feed, and the data in 'stdin'. This is convenient for large INSERT queries.</p>
<p>Example of using the client to insert data:</p>
<div class="codehilite"><pre><span></span><span class="nb">echo</span> -ne <span class="s2">&quot;1, &#39;some text&#39;, &#39;2016-08-14 00:00:00&#39;\n2, &#39;some more text&#39;, &#39;2016-08-14 00:00:01&#39;&quot;</span> <span class="p">|</span> clickhouse-client --database<span class="o">=</span><span class="nb">test</span> --query<span class="o">=</span><span class="s2">&quot;INSERT INTO test FORMAT CSV&quot;</span><span class="p">;</span>

cat <span class="s">&lt;&lt;_EOF | clickhouse-client --database=test --query=&quot;INSERT INTO test FORMAT CSV&quot;;</span>
<span class="s">3, &#39;some text&#39;, &#39;2016-08-14 00:00:00&#39;</span>
<span class="s">4, &#39;some more text&#39;, &#39;2016-08-14 00:00:01&#39;</span>
<span class="s">_EOF</span>

cat file.csv <span class="p">|</span> clickhouse-client --database<span class="o">=</span><span class="nb">test</span> --query<span class="o">=</span><span class="s2">&quot;INSERT INTO test FORMAT CSV&quot;</span><span class="p">;</span>
</pre></div>


<p>In batch mode, the default data format is TabSeparated. You can set the format in the FORMAT clause of the query.</p>
<p>By default, you can only process a single query in batch mode. To make multiple queries from a "script," use the --multiquery parameter. This works for all queries except INSERT. Query results are output consecutively without additional separators.
Similarly, to process a large number of queries, you can run 'clickhouse-client' for each query. Note that it may take tens of milliseconds to launch the 'clickhouse-client' program.</p>
<p>In interactive mode, you get a command line where you can enter queries.</p>
<p>If 'multiline' is not specified (the default):To run the query, press Enter. The semicolon is not necessary at the end of the query. To enter a multiline query, enter a backslash <code>\</code> before the line feed. After you press Enter, you will be asked to enter the next line of the query.</p>
<p>If multiline is specified:To run a query, end it with a semicolon and press Enter. If the semicolon was omitted at the end of the entered line, you will be asked to enter the next line of the query.</p>
<p>Only a single query is run, so everything after the semicolon is ignored.</p>
<p>You can specify <code>\G</code> instead of or after the semicolon. This indicates Vertical format. In this format, each value is printed on a separate line, which is convenient for wide tables. This unusual feature was added for compatibility with the MySQL CLI.</p>
<p>The command line is based on 'readline' (and 'history' or 'libedit', or without a library, depending on the build). In other words, it uses the familiar keyboard shortcuts and keeps a history.
The history is written to <code>~/.clickhouse-client-history</code>.</p>
<p>By default, the format used is PrettyCompact. You can change the format in the FORMAT clause of the query, or by specifying <code>\G</code> at the end of the query, using the <code>--format</code> or <code>--vertical</code> argument in the command line, or using the client configuration file.</p>
<p>To exit the client, press Ctrl+D (or Ctrl+C), or enter one of the following instead of a query:"exit", "quit", "logout", "учше", "йгше", "дщпщге", "exit;", "quit;", "logout;", "учшеж", "йгшеж", "дщпщгеж", "q", "й", "q", "Q", ":q", "й", "Й", "Жй"</p>
<p>When processing a query, the client shows:</p>
<ol>
<li>Progress, which is updated no more than 10 times per second (by default). For quick queries, the progress might not have time to be displayed.</li>
<li>The formatted query after parsing, for debugging.</li>
<li>The result in the specified format.</li>
<li>The number of lines in the result, the time passed, and the average speed of query processing.</li>
</ol>
<p>You can cancel a long query by pressing Ctrl+C. However, you will still need to wait a little for the server to abort the request. It is not possible to cancel a query at certain stages. If you don't wait and press Ctrl+C a second time, the client will exit.</p>
<p>The command-line client allows passing external data (external temporary tables) for querying. For more information, see the section "External data for query processing".</p>
<p><a name="interfaces_cli_configuration"></a></p>
<h3 id="configuring">Configuring</h3>
<p>You can pass parameters to <code>clickhouse-client</code> (all parameters have a default value) using:</p>
<ul>
<li>From the Command Line</li>
</ul>
<p>Command-line options override the default values and settings in configuration files.</p>
<ul>
<li>Configuration files.</li>
</ul>
<p>Settings in the configuration files override the default values.</p>
<h4 id="command-line-options">Command line options</h4>
<ul>
<li><code>--host, -h</code> -– The server name, 'localhost' by default.  You can use either the name or the IPv4 or IPv6 address.</li>
<li><code>--port</code> – The port to connect to. Default value: 9000. Note that the HTTP interface and the native interface use different ports.</li>
<li><code>--user, -u</code> – The username. Default value: default.</li>
<li><code>--password</code> – The password. Default value: empty string.</li>
<li><code>--query, -q</code> – The query to process when using non-interactive mode.</li>
<li><code>--database, -d</code> – Select the current default database. Default value: the current database from the server settings ('default' by default).</li>
<li><code>--multiline, -m</code> – If specified, allow multiline queries (do not send the query on Enter).</li>
<li><code>--multiquery, -n</code> – If specified, allow processing multiple queries separated by commas. Only works in non-interactive mode.</li>
<li><code>--format, -f</code> – Use the specified default format to output the result.</li>
<li><code>--vertical, -E</code> – If specified, use the Vertical format by default to output the result. This is the same as '--format=Vertical'. In this format, each value is printed on a separate line, which is helpful when displaying wide tables.</li>
<li><code>--time, -t</code> – If specified, print the query execution time to 'stderr' in non-interactive mode.</li>
<li><code>--stacktrace</code> – If specified, also print the stack trace if an exception occurs.</li>
<li><code>-config-file</code> – The name of the configuration file.</li>
</ul>
<h4 id="configuration-files">Configuration files</h4>
<p><code>clickhouse-client</code>  uses the first existing file of the following:</p>
<ul>
<li>Defined in the <code>-config-file</code> parameter.</li>
<li><code>./clickhouse-client.xml</code></li>
<li><code>\~/.clickhouse-client/config.xml</code></li>
<li><code>/etc/clickhouse-client/config.xml</code></li>
</ul>
<p>Example of a config file:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;config&gt;</span>
    <span class="nt">&lt;user&gt;</span>username<span class="nt">&lt;/user&gt;</span>
    <span class="nt">&lt;password&gt;</span>password<span class="nt">&lt;/password&gt;</span>
<span class="nt">&lt;/config&gt;</span>
</pre></div>


<h2 id="http-interface">HTTP interface</h2>
<p>The HTTP interface lets you use ClickHouse on any platform from any programming language. We use it for working from Java and Perl, as well as shell scripts. In other departments, the HTTP interface is used from Perl, Python, and Go. The HTTP interface is more limited than the native interface, but it has better compatibility.</p>
<p>By default, clickhouse-server listens for HTTP on port 8123 (this can be changed in the config).
If you make a GET / request without parameters, it returns the string "Ok" (with a line feed at the end). You can use this in health-check scripts.</p>
<div class="codehilite"><pre><span></span>$ curl <span class="s1">&#39;http://localhost:8123/&#39;</span>
Ok.
</pre></div>


<p>Send the request as a URL 'query' parameter, or as a POST. Or send the beginning of the query in the 'query' parameter, and the rest in the POST (we'll explain later why this is necessary). The size of the URL is limited to 16 KB, so keep this in mind when sending large queries.</p>
<p>If successful, you receive the 200 response code and the result in the response body.
If an error occurs, you receive the 500 response code and an error description text in the response body.</p>
<p>When using the GET method, 'readonly' is set. In other words, for queries that modify data, you can only use the POST method. You can send the query itself either in the POST body, or in the URL parameter.</p>
<p>Examples:</p>
<div class="codehilite"><pre><span></span>$ curl <span class="s1">&#39;http://localhost:8123/?query=SELECT%201&#39;</span>
<span class="m">1</span>

$ wget -O- -q <span class="s1">&#39;http://localhost:8123/?query=SELECT 1&#39;</span>
<span class="m">1</span>

$ GET <span class="s1">&#39;http://localhost:8123/?query=SELECT 1&#39;</span>
<span class="m">1</span>

$ <span class="nb">echo</span> -ne <span class="s1">&#39;GET /?query=SELECT%201 HTTP/1.0\r\n\r\n&#39;</span> <span class="p">|</span> nc localhost <span class="m">8123</span>
HTTP/1.0 <span class="m">200</span> OK
Connection: Close
Date: Fri, <span class="m">16</span> Nov <span class="m">2012</span> <span class="m">19</span>:21:50 GMT

<span class="m">1</span>
</pre></div>


<p>As you can see, curl is somewhat inconvenient in that spaces must be URL escaped.Although wget escapes everything itself, we don't recommend using it because it doesn't work well over HTTP 1.1 when using keep-alive and Transfer-Encoding: chunked.</p>
<div class="codehilite"><pre><span></span>$ <span class="nb">echo</span> <span class="s1">&#39;SELECT 1&#39;</span> <span class="p">|</span> curl <span class="s1">&#39;http://localhost:8123/&#39;</span> --data-binary @-
<span class="m">1</span>

$ <span class="nb">echo</span> <span class="s1">&#39;SELECT 1&#39;</span> <span class="p">|</span> curl <span class="s1">&#39;http://localhost:8123/?query=&#39;</span> --data-binary @-
<span class="m">1</span>

$ <span class="nb">echo</span> <span class="s1">&#39;1&#39;</span> <span class="p">|</span> curl <span class="s1">&#39;http://localhost:8123/?query=SELECT&#39;</span> --data-binary @-
<span class="m">1</span>
</pre></div>


<p>If part of the query is sent in the parameter, and part in the POST, a line feed is inserted between these two data parts.
Example (this won't work):</p>
<div class="codehilite"><pre><span></span>$ <span class="nb">echo</span> <span class="s1">&#39;ECT 1&#39;</span> <span class="p">|</span> curl <span class="s1">&#39;http://localhost:8123/?query=SEL&#39;</span> --data-binary @-
Code: <span class="m">59</span>, e.displayText<span class="o">()</span> <span class="o">=</span> DB::Exception: Syntax error: failed at position <span class="m">0</span>: SEL
ECT <span class="m">1</span>
, expected One of: SHOW TABLES, SHOW DATABASES, SELECT, INSERT, CREATE, ATTACH, RENAME, DROP, DETACH, USE, SET, OPTIMIZE., e.what<span class="o">()</span> <span class="o">=</span> DB::Exception
</pre></div>


<p>By default, data is returned in TabSeparated format (for more information, see the "Formats" section).
You use the FORMAT clause of the query to request any other format.</p>
<div class="codehilite"><pre><span></span>$ <span class="nb">echo</span> <span class="s1">&#39;SELECT 1 FORMAT Pretty&#39;</span> <span class="p">|</span> curl <span class="s1">&#39;http://localhost:8123/?&#39;</span> --data-binary @-
┏━━━┓
┃ <span class="m">1</span> ┃
┡━━━┩
│ <span class="m">1</span> │
└───┘
</pre></div>


<p>The POST method of transmitting data is necessary for INSERT queries. In this case, you can write the beginning of the query in the URL parameter, and use POST to pass the data to insert. The data to insert could be, for example, a tab-separated dump from MySQL. In this way, the INSERT query replaces LOAD DATA LOCAL INFILE from MySQL.</p>
<p>Examples: Creating a table:</p>
<div class="codehilite"><pre><span></span><span class="nb">echo</span> <span class="s1">&#39;CREATE TABLE t (a UInt8) ENGINE = Memory&#39;</span> <span class="p">|</span> POST <span class="s1">&#39;http://localhost:8123/&#39;</span>
</pre></div>


<p>Using the familiar INSERT query for data insertion:</p>
<div class="codehilite"><pre><span></span><span class="nb">echo</span> <span class="s1">&#39;INSERT INTO t VALUES (1),(2),(3)&#39;</span> <span class="p">|</span> POST <span class="s1">&#39;http://localhost:8123/&#39;</span>
</pre></div>


<p>Data can be sent separately from the query:</p>
<div class="codehilite"><pre><span></span><span class="nb">echo</span> <span class="s1">&#39;(4),(5),(6)&#39;</span> <span class="p">|</span> POST <span class="s1">&#39;http://localhost:8123/?query=INSERT INTO t VALUES&#39;</span>
</pre></div>


<p>You can specify any data format. The 'Values' format is the same as what is used when writing INSERT INTO t VALUES:</p>
<div class="codehilite"><pre><span></span><span class="nb">echo</span> <span class="s1">&#39;(7),(8),(9)&#39;</span> <span class="p">|</span> POST <span class="s1">&#39;http://localhost:8123/?query=INSERT INTO t FORMAT Values&#39;</span>
</pre></div>


<p>To insert data from a tab-separated dump, specify the corresponding format:</p>
<div class="codehilite"><pre><span></span><span class="nb">echo</span> -ne <span class="s1">&#39;10\n11\n12\n&#39;</span> <span class="p">|</span> POST <span class="s1">&#39;http://localhost:8123/?query=INSERT INTO t FORMAT TabSeparated&#39;</span>
</pre></div>


<p>Reading the table contents. Data is output in random order due to parallel query processing:</p>
<div class="codehilite"><pre><span></span>$ GET <span class="s1">&#39;http://localhost:8123/?query=SELECT a FROM t&#39;</span>
<span class="m">7</span>
<span class="m">8</span>
<span class="m">9</span>
<span class="m">10</span>
<span class="m">11</span>
<span class="m">12</span>
<span class="m">1</span>
<span class="m">2</span>
<span class="m">3</span>
<span class="m">4</span>
<span class="m">5</span>
<span class="m">6</span>
</pre></div>


<p>Deleting the table.</p>
<div class="codehilite"><pre><span></span>POST <span class="s1">&#39;http://localhost:8123/?query=DROP TABLE t&#39;</span>
</pre></div>


<p>For successful requests that don't return a data table, an empty response body is returned.</p>
<p>You can use the internal ClickHouse compression format when transmitting data. The compressed data has a non-standard format, and you will need to use the special clickhouse-compressor program to work with it (it is installed with the clickhouse-client package).</p>
<p>If you specified 'compress=1' in the URL, the server will compress the data it sends you.
If you specified 'decompress=1' in the URL, the server will decompress the same data that you pass in the POST method.</p>
<p>It is also possible to use the standard gzip-based HTTP compression. To send a POST request compressed using gzip, append the request header <code>Content-Encoding: gzip</code>.
In order for ClickHouse to compress the response using gzip, you must append <code>Accept-Encoding: gzip</code> to the request headers, and enable the ClickHouse setting <code>enable_http_compression</code>.</p>
<p>You can use this to reduce network traffic when transmitting a large amount of data, or for creating dumps that are immediately compressed.</p>
<p>You can use the 'database' URL parameter to specify the default database.</p>
<div class="codehilite"><pre><span></span>$ <span class="nb">echo</span> <span class="s1">&#39;SELECT number FROM numbers LIMIT 10&#39;</span> <span class="p">|</span> curl <span class="s1">&#39;http://localhost:8123/?database=system&#39;</span> --data-binary @-
<span class="m">0</span>
<span class="m">1</span>
<span class="m">2</span>
<span class="m">3</span>
<span class="m">4</span>
<span class="m">5</span>
<span class="m">6</span>
<span class="m">7</span>
<span class="m">8</span>
<span class="m">9</span>
</pre></div>


<p>By default, the database that is registered in the server settings is used as the default database. By default, this is the database called 'default'. Alternatively, you can always specify the database using a dot before the table name.</p>
<p>The username and password can be indicated in one of two ways:</p>
<ol>
<li>Using HTTP Basic Authentication. Example:</li>
</ol>
<div class="codehilite"><pre><span></span><span class="nb">echo</span> <span class="s1">&#39;SELECT 1&#39;</span> <span class="p">|</span> curl <span class="s1">&#39;http://user:password@localhost:8123/&#39;</span> -d @-
</pre></div>


<ol>
<li>In the 'user' and 'password' URL parameters. Example:</li>
</ol>
<div class="codehilite"><pre><span></span><span class="nb">echo</span> <span class="s1">&#39;SELECT 1&#39;</span> <span class="p">|</span> curl <span class="s1">&#39;http://localhost:8123/?user=user&amp;password=password&#39;</span> -d @-
</pre></div>


<p>If the user name is not indicated, the username 'default' is used. If the password is not indicated, an empty password is used.
You can also use the URL parameters to specify any settings for processing a single query, or entire profiles of settings. Example:
http://localhost:8123/?profile=web&amp;max_rows_to_read=1000000000&amp;query=SELECT+1</p>
<p>For more information, see the section "Settings".</p>
<div class="codehilite"><pre><span></span>$ <span class="nb">echo</span> <span class="s1">&#39;SELECT number FROM system.numbers LIMIT 10&#39;</span> <span class="p">|</span> curl <span class="s1">&#39;http://localhost:8123/?&#39;</span> --data-binary @-
<span class="m">0</span>
<span class="m">1</span>
<span class="m">2</span>
<span class="m">3</span>
<span class="m">4</span>
<span class="m">5</span>
<span class="m">6</span>
<span class="m">7</span>
<span class="m">8</span>
<span class="m">9</span>
</pre></div>


<p>For information about other parameters, see the section "SET".</p>
<p>Similarly, you can use ClickHouse sessions in the HTTP protocol. To do this, you need to add the <code>session_id</code> GET parameter to the request. You can use any string as the session ID. By default, the session is terminated after 60 seconds of inactivity. To change this timeout, modify the <code>default_session_timeout</code> setting in the server configuration, or add the <code>session_timeout</code> GET parameter to the request. To check the session status, use the <code>session_check=1</code> parameter. Only one query at a time can be executed within a single session.</p>
<p>You have the option to receive information about the progress of query execution in X-ClickHouse-Progress headers. To do this, enable the setting send_progress_in_http_headers.</p>
<p>Running requests don't stop automatically if the HTTP connection is lost. Parsing and data formatting are performed on the server side, and using the network might be ineffective.
The optional 'query_id' parameter can be passed as the query ID (any string). For more information, see the section "Settings, replace_running_query".</p>
<p>The optional 'quota_key' parameter can be passed as the quota key (any string). For more information, see the section "Quotas".</p>
<p>The HTTP interface allows passing external data (external temporary tables) for querying. For more information, see the section "External data for query processing".</p>
<h3 id="response-buffering">Response buffering</h3>
<p>You can enable response buffering on the server side. The <code>buffer_size</code> and <code>wait_end_of_query</code> URL parameters are provided for this purpose.</p>
<p><code>buffer_size</code> determines the number of bytes in the result to buffer in the server memory. If the result body is larger than this threshold, the buffer is written to the HTTP channel, and the remaining data is sent directly to the HTTP channel.</p>
<p>To ensure that the entire response is buffered, set <code>wait_end_of_query=1</code>. In this case, the data that is not stored in memory will be buffered in a temporary server file.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span>curl -sS <span class="s1">&#39;http://localhost:8123/?max_result_bytes=4000000&amp;buffer_size=3000000&amp;wait_end_of_query=1&#39;</span> -d <span class="s1">&#39;SELECT toUInt8(number) FROM system.numbers LIMIT 9000000 FORMAT RowBinary&#39;</span>
</pre></div>


<p>Use buffering to avoid situations where a query processing error occurred after the response code and HTTP headers were sent to the client. In this situation, an error message is written at the end of the response body, and on the client side, the error can only be detected at the parsing stage.</p>
<h2 id="jdbc-driver">JDBC driver</h2>
<p>There is an official JDBC driver for ClickHouse. See <a href="https://github.com/yandex/clickhouse-jdbc">here</a> .</p>
<h2 id="native-interface-tcp">Native interface (TCP)</h2>
<p>The native interface is used in the "clickhouse-client" command-line client for interaction between servers with distributed query processing, and also in C++ programs. We will only cover the command-line client.</p>
<h2 id="libraries-from-third-party-developers">Libraries from third-party developers</h2>
<p>There are libraries for working with ClickHouse for:</p>
<ul>
<li>Python<ul>
<li><a href="https://github.com/Infinidat/infi.clickhouse_orm">infi.clickhouse_orm</a></li>
<li><a href="https://github.com/cloudflare/sqlalchemy-clickhouse">sqlalchemy-clickhouse</a></li>
<li><a href="https://github.com/mymarilyn/clickhouse-driver">clickhouse-driver</a></li>
<li><a href="https://github.com/yurial/clickhouse-client">clickhouse-client</a></li>
</ul>
</li>
<li>PHP<ul>
<li><a href="https://github.com/8bitov/clickhouse-php-client">clickhouse-php-client</a></li>
<li><a href="https://github.com/SevaCode/PhpClickHouseClient">PhpClickHouseClient</a></li>
<li><a href="https://github.com/smi2/phpClickHouse">phpClickHouse</a></li>
<li><a href="https://github.com/bozerkins/clickhouse-client">clickhouse-client</a></li>
</ul>
</li>
<li>Go<ul>
<li><a href="https://github.com/kshvakov/clickhouse/">clickhouse</a></li>
<li><a href="https://github.com/roistat/go-clickhouse">go-clickhouse</a></li>
<li><a href="https://github.com/mailru/go-clickhouse">mailrugo-clickhouse</a></li>
<li><a href="https://github.com/leprosus/golang-clickhouse">golang-clickhouse</a></li>
</ul>
</li>
<li>NodeJs<ul>
<li><a href="https://github.com/TimonKK/clickhouse">clickhouse (NodeJs)</a></li>
<li><a href="https://github.com/apla/node-clickhouse">node-clickhouse</a></li>
</ul>
</li>
<li>Perl<ul>
<li><a href="https://github.com/elcamlost/perl-DBD-ClickHouse">perl-DBD-ClickHouse</a></li>
<li><a href="https://metacpan.org/release/HTTP-ClickHouse">HTTP-ClickHouse</a></li>
<li><a href="https://metacpan.org/release/AnyEvent-ClickHouse">AnyEvent-ClickHouse</a></li>
</ul>
</li>
<li>Ruby<ul>
<li><a href="https://github.com/archan937/clickhouse">clickhouse (Ruby)</a></li>
</ul>
</li>
<li>R<ul>
<li><a href="https://github.com/hannesmuehleisen/clickhouse-r">clickhouse-r</a></li>
<li><a href="https://github.com/IMSMWU/RClickhouse">RClickhouse</a></li>
</ul>
</li>
<li>.NET<ul>
<li><a href="https://github.com/killwort/ClickHouse-Net">ClickHouse-Net</a></li>
</ul>
</li>
<li>C++<ul>
<li><a href="https://github.com/artpaul/clickhouse-cpp/">clickhouse-cpp</a></li>
</ul>
</li>
<li>Elixir<ul>
<li><a href="https://github.com/appodeal/clickhousex/">clickhousex</a></li>
<li><a href="https://github.com/appodeal/clickhouse_ecto">clickhouse_ecto</a></li>
</ul>
</li>
<li>Java<ul>
<li><a href="https://github.com/VirtusAI/clickhouse-client-java">clickhouse-client-java</a></li>
</ul>
</li>
</ul>
<p>We have not tested these libraries. They are listed in random order.</p>
<h2 id="visual-interfaces-from-third-party-developers">Visual interfaces from third-party developers</h2>
<h3 id="tabix">Tabix</h3>
<p>Web interface for ClickHouse in the <a href="https://github.com/tabixio/tabix">Tabix</a> project.</p>
<h4 id="features">Features:</h4>
<ul>
<li>Works with ClickHouse directly from the browser, without the need to install additional software.</li>
<li>Query editor with syntax highlighting.</li>
<li>Auto-completion of commands.</li>
<li>Tools for graphical analysis of query execution.</li>
<li>Color scheme options.</li>
</ul>
<p><a href="https://tabix.io/doc/">Tabix documentation</a>.</p>
<h3 id="houseops">HouseOps</h3>
<p><a href="https://github.com/HouseOps/HouseOps">HouseOps</a> is a unique Desktop ClickHouse Ops UI / IDE for OSX, Linux and Windows.</p>
<h4 id="features_1">Features:</h4>
<ul>
<li>Query builder;</li>
<li>Database manangement (soon);</li>
<li>Users manangement (soon);</li>
<li>Real-Time Data Analytics (soon);</li>
<li>Cluster/Infra monitoring (soon);</li>
<li>Cluster manangement (soon);</li>
<li>Kafka and Replicated tables monitoring (soon);</li>
<li>And a lot of others features (soon) for you take a beautiful implementation of ClickHouse.</li>
</ul>
<h2 id="query-language">Query language</h2>
<h2 id="queries">Queries</h2>
<h3 id="create-database">CREATE DATABASE</h3>
<p>Creating db_name databases</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="p">[</span><span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span><span class="p">]</span> <span class="n">db_name</span>
</pre></div>


<p><code>A database</code> is just a directory for tables.
If <code>IF NOT EXISTS</code> is included, the query won't return an error if the database already exists.</p>
<p><a name="query_language-queries-create_table"></a></p>
<h3 id="create-table">CREATE TABLE</h3>
<p>The <code>CREATE TABLE</code> query can have several forms.</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="p">[</span><span class="k">TEMPORARY</span><span class="p">]</span> <span class="k">TABLE</span> <span class="p">[</span><span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span><span class="p">]</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="n">name</span> <span class="p">[</span><span class="k">ON</span> <span class="k">CLUSTER</span> <span class="k">cluster</span><span class="p">]</span>
<span class="p">(</span>
    <span class="n">name1</span> <span class="p">[</span><span class="n">type1</span><span class="p">]</span> <span class="p">[</span><span class="k">DEFAULT</span><span class="o">|</span><span class="n">MATERIALIZED</span><span class="o">|</span><span class="k">ALIAS</span> <span class="n">expr1</span><span class="p">],</span>
    <span class="n">name2</span> <span class="p">[</span><span class="n">type2</span><span class="p">]</span> <span class="p">[</span><span class="k">DEFAULT</span><span class="o">|</span><span class="n">MATERIALIZED</span><span class="o">|</span><span class="k">ALIAS</span> <span class="n">expr2</span><span class="p">],</span>
    <span class="p">...</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">engine</span>
</pre></div>


<p>Creates a table named 'name' in the 'db' database or the current database if 'db' is not set, with the structure specified in brackets and the 'engine' engine.
The structure of the table is a list of column descriptions. If indexes are supported by the engine, they are indicated as parameters for the table engine.</p>
<p>A column description is <code>name type</code> in the simplest case. Example: <code>RegionID UInt32</code>.
Expressions can also be defined for default values (see below).</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="p">[</span><span class="k">TEMPORARY</span><span class="p">]</span> <span class="k">TABLE</span> <span class="p">[</span><span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span><span class="p">]</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="n">name</span> <span class="k">AS</span> <span class="p">[</span><span class="n">db2</span><span class="p">.]</span><span class="n">name2</span> <span class="p">[</span><span class="n">ENGINE</span> <span class="o">=</span> <span class="n">engine</span><span class="p">]</span>
</pre></div>


<p>Creates a table with the same structure as another table. You can specify a different engine for the table. If the engine is not specified, the same engine will be used as for the <code>db2.name2</code> table.</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="p">[</span><span class="k">TEMPORARY</span><span class="p">]</span> <span class="k">TABLE</span> <span class="p">[</span><span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span><span class="p">]</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="n">name</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">engine</span> <span class="k">AS</span> <span class="k">SELECT</span> <span class="p">...</span>
</pre></div>


<p>Creates a table with a structure like the result of the <code>SELECT</code> query, with the 'engine' engine, and fills it with data from SELECT.</p>
<p>In all cases, if <code>IF NOT EXISTS</code> is specified, the query won't return an error if the table already exists. In this case, the query won't do anything.</p>
<h4 id="default-values">Default values</h4>
<p>The column description can specify an expression for a default value, in one of the following ways:<code>DEFAULT expr</code>, <code>MATERIALIZED expr</code>, <code>ALIAS expr</code>.
Example: <code>URLDomain String DEFAULT domain(URL)</code>.</p>
<p>If an expression for the default value is not defined, the default values will be set to zeros for numbers, empty strings for strings, empty arrays for arrays, and <code>0000-00-00</code> for dates or <code>0000-00-00 00:00:00</code> for dates with time. NULLs are not supported.</p>
<p>If the default expression is defined, the column type is optional. If there isn't an explicitly defined type, the default expression type is used. Example: <code>EventDate DEFAULT toDate(EventTime)</code> – the 'Date' type will be used for the 'EventDate' column.</p>
<p>If the data type and default expression are defined explicitly, this expression will be cast to the specified type using type casting functions. Example: <code>Hits UInt32 DEFAULT 0</code> means the same thing as <code>Hits UInt32 DEFAULT toUInt32(0)</code>.</p>
<p>Default expressions may be defined as an arbitrary expression from table constants and columns. When creating and changing the table structure, it checks that expressions don't contain loops. For INSERT, it checks that expressions are resolvable – that all columns they can be calculated from have been passed.</p>
<p><code>DEFAULT expr</code></p>
<p>Normal default value. If the INSERT query doesn't specify the corresponding column, it will be filled in by computing the corresponding expression.</p>
<p><code>MATERIALIZED expr</code></p>
<p>Materialized expression. Such a column can't be specified for INSERT, because it is always calculated.
For an INSERT without a list of columns, these columns are not considered.
In addition, this column is not substituted when using an asterisk in a SELECT query. This is to preserve the invariant that the dump obtained using <code>SELECT *</code> can be inserted back into the table using INSERT without specifying the list of columns.</p>
<p><code>ALIAS expr</code></p>
<p>Synonym. Such a column isn't stored in the table at all.
Its values can't be inserted in a table, and it is not substituted when using an asterisk in a SELECT query.
It can be used in SELECTs if the alias is expanded during query parsing.</p>
<p>When using the ALTER query to add new columns, old data for these columns is not written. Instead, when reading old data that does not have values for the new columns, expressions are computed on the fly by default. However, if running the expressions requires different columns that are not indicated in the query, these columns will additionally be read, but only for the blocks of data that need it.</p>
<p>If you add a new column to a table but later change its default expression, the values used for old data will change (for data where values were not stored on the disk). Note that when running background merges, data for columns that are missing in one of the merging parts is written to the merged part.</p>
<p>It is not possible to set default values for elements in nested data structures.</p>
<h4 id="temporary-tables">Temporary tables</h4>
<p>In all cases, if <code>TEMPORARY</code> is specified, a temporary table will be created. Temporary tables have the following characteristics:</p>
<ul>
<li>Temporary tables disappear when the session ends, including if the connection is lost.</li>
<li>A temporary table is created with the Memory engine. The other table engines are not supported.</li>
<li>The DB can't be specified for a temporary table. It is created outside of databases.</li>
<li>If a temporary table has the same name as another one and a query specifies the table name without specifying the DB, the temporary table will be used.</li>
<li>For distributed query processing, temporary tables used in a query are passed to remote servers.</li>
</ul>
<p>In most cases, temporary tables are not created manually, but when using external data for a query, or for distributed <code>(GLOBAL) IN</code>. For more information, see the appropriate sections</p>
<h2 id="distributed-ddl-queries-on-cluster-clause">Distributed DDL queries (ON CLUSTER clause)</h2>
<p>The <code>CREATE</code>, <code>DROP</code>, <code>ALTER</code>, and <code>RENAME</code> queries support distributed execution on a cluster.
For example, the following query creates the <code>all_hits</code> <code>Distributed</code> table on each host in <code>cluster</code>:</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">all_hits</span> <span class="k">ON</span> <span class="k">CLUSTER</span> <span class="k">cluster</span> <span class="p">(</span><span class="n">p</span> <span class="nb">Date</span><span class="p">,</span> <span class="n">i</span> <span class="n">Int32</span><span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">Distributed</span><span class="p">(</span><span class="k">cluster</span><span class="p">,</span> <span class="k">default</span><span class="p">,</span> <span class="n">hits</span><span class="p">)</span>
</pre></div>


<p>In order to run these queries correctly, each host must have the same cluster definition (to simplify syncing configs, you can use substitutions from ZooKeeper). They must also connect to the ZooKeeper servers.
The local version of the query will eventually be implemented on each host in the cluster, even if some hosts are currently not available. The order for executing queries within a single host is guaranteed.
<code>ALTER</code> queries are not yet supported for replicated tables.</p>
<h3 id="create-view">CREATE VIEW</h3>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="p">[</span><span class="n">MATERIALIZED</span><span class="p">]</span> <span class="k">VIEW</span> <span class="p">[</span><span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span><span class="p">]</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="n">name</span> <span class="p">[</span><span class="k">TO</span><span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="n">name</span><span class="p">]</span> <span class="p">[</span><span class="n">ENGINE</span> <span class="o">=</span> <span class="n">engine</span><span class="p">]</span> <span class="p">[</span><span class="n">POPULATE</span><span class="p">]</span> <span class="k">AS</span> <span class="k">SELECT</span> <span class="p">...</span>
</pre></div>


<p>Creates a view. There are two types of views: normal and MATERIALIZED.</p>
<p>When creating a materialized view, you must specify ENGINE – the table engine for storing data.</p>
<p>A materialized view works as follows: when inserting data to the table specified in SELECT, part of the inserted data is converted by this SELECT query, and the result is inserted in the view.</p>
<p>Normal views don't store any data, but just perform a read from another table. In other words, a normal view is nothing more than a saved query. When reading from a view, this saved query is used as a subquery in the FROM clause.</p>
<p>As an example, assume you've created a view:</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">VIEW</span> <span class="k">view</span> <span class="k">AS</span> <span class="k">SELECT</span> <span class="p">...</span>
</pre></div>


<p>and written a query:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="k">c</span> <span class="k">FROM</span> <span class="k">view</span>
</pre></div>


<p>This query is fully equivalent to using the subquery:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="k">c</span> <span class="k">FROM</span> <span class="p">(</span><span class="k">SELECT</span> <span class="p">...)</span>
</pre></div>


<p>Materialized views store data transformed by the corresponding SELECT query.</p>
<p>When creating a materialized view, you must specify ENGINE – the table engine for storing data.</p>
<p>A materialized view is arranged as follows: when inserting data to the table specified in SELECT, part of the inserted data is converted by this SELECT query, and the result is inserted in the view.</p>
<p>If you specify POPULATE, the existing table data is inserted in the view when creating it, as if making a <code>CREATE TABLE ... AS SELECT ...</code> . Otherwise, the query contains only the data inserted in the table after creating the view. We don't recommend using POPULATE, since data inserted in the table during the view creation will not be inserted in it.</p>
<p>A <code>SELECT</code> query can contain <code>DISTINCT</code>, <code>GROUP BY</code>, <code>ORDER BY</code>, <code>LIMIT</code>... Note that the corresponding conversions are performed independently on each block of inserted data. For example, if <code>GROUP BY</code> is set, data is aggregated during insertion, but only within a single packet of inserted data. The data won't be further aggregated. The exception is when using an ENGINE that independently performs data aggregation, such as <code>SummingMergeTree</code>.</p>
<p>The execution of <code>ALTER</code> queries on materialized views has not been fully developed, so they might be inconvenient. If the materialized view uses the construction <code>TO [db.]name</code>, you can <code>DETACH</code> the view, run <code>ALTER</code> for the target table, and then <code>ATTACH</code> the previously detached (<code>DETACH</code>) view.</p>
<p>Views look the same as normal tables. For example, they are listed in the result of the <code>SHOW TABLES</code> query.</p>
<p>There isn't a separate query for deleting views. To delete a view, use <code>DROP TABLE</code>.</p>
<h3 id="attach">ATTACH</h3>
<p>This query is exactly the same as <code>CREATE</code>, but</p>
<ul>
<li>instead of the word <code>CREATE</code> it uses the word <code>ATTACH</code>.</li>
<li>The query doesn't create data on the disk, but assumes that data is already in the appropriate places, and just adds information about the table to the server.
After executing an ATTACH query, the server will know about the existence of the table.</li>
</ul>
<p>If the table was previously detached (<code>DETACH</code>), meaning that its structure is known, you can use shorthand without defining the structure.</p>
<div class="codehilite"><pre><span></span><span class="n">ATTACH</span> <span class="k">TABLE</span> <span class="p">[</span><span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span><span class="p">]</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="n">name</span>
</pre></div>


<p>This query is used when starting the server. The server stores table metadata as files with <code>ATTACH</code> queries, which it simply runs at launch (with the exception of system tables, which are explicitly created on the server).</p>
<h3 id="drop">DROP</h3>
<p>This query has two types: <code>DROP DATABASE</code>  and <code>DROP TABLE</code>.</p>
<div class="codehilite"><pre><span></span><span class="k">DROP</span> <span class="k">DATABASE</span> <span class="p">[</span><span class="k">IF</span> <span class="k">EXISTS</span><span class="p">]</span> <span class="n">db</span> <span class="p">[</span><span class="k">ON</span> <span class="k">CLUSTER</span> <span class="k">cluster</span><span class="p">]</span>
</pre></div>


<p>Deletes all tables inside the 'db' database, then deletes the 'db' database itself.
If <code>IF EXISTS</code> is specified, it doesn't return an error if the database doesn't exist.</p>
<div class="codehilite"><pre><span></span><span class="k">DROP</span> <span class="p">[</span><span class="k">TEMPORARY</span><span class="p">]</span> <span class="k">TABLE</span> <span class="p">[</span><span class="k">IF</span> <span class="k">EXISTS</span><span class="p">]</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="n">name</span> <span class="p">[</span><span class="k">ON</span> <span class="k">CLUSTER</span> <span class="k">cluster</span><span class="p">]</span>
</pre></div>


<p>Deletes the table.
If <code>IF EXISTS</code> is specified, it doesn't return an error if the table doesn't exist or the database doesn't exist.</p>
<h3 id="detach">DETACH</h3>
<p>Deletes information about the 'name' table from the server. The server stops knowing about the table's existence.</p>
<div class="codehilite"><pre><span></span><span class="n">DETACH</span> <span class="k">TABLE</span> <span class="p">[</span><span class="k">IF</span> <span class="k">EXISTS</span><span class="p">]</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="n">name</span>
</pre></div>


<p>This does not delete the table's data or metadata. On the next server launch, the server will read the metadata and find out about the table again.
Similarly, a "detached" table can be re-attached using the <code>ATTACH</code> query (with the exception of system tables, which do not have metadata stored for them).</p>
<p>There is no <code>DETACH DATABASE</code> query.</p>
<h3 id="rename">RENAME</h3>
<p>Renames one or more tables.</p>
<div class="codehilite"><pre><span></span><span class="k">RENAME</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">db11</span><span class="p">.]</span><span class="n">name11</span> <span class="k">TO</span> <span class="p">[</span><span class="n">db12</span><span class="p">.]</span><span class="n">name12</span><span class="p">,</span> <span class="p">[</span><span class="n">db21</span><span class="p">.]</span><span class="n">name21</span> <span class="k">TO</span> <span class="p">[</span><span class="n">db22</span><span class="p">.]</span><span class="n">name22</span><span class="p">,</span> <span class="p">...</span> <span class="p">[</span><span class="k">ON</span> <span class="k">CLUSTER</span> <span class="k">cluster</span><span class="p">]</span>
</pre></div>


<p>All tables are renamed under global locking. Renaming tables is a light operation. If you indicated another database after TO, the table will be moved to this database. However, the directories with databases must reside in the same file system (otherwise, an error is returned).</p>
<p><a name="query_language_queries_alter"></a></p>
<h3 id="alter">ALTER</h3>
<p>The <code>ALTER</code> query is only supported for <code>*MergeTree</code> tables, as well as <code>Merge</code>and<code>Distributed</code>. The query has several variations.</p>
<h4 id="column-manipulations">Column manipulations</h4>
<p>Changing the table structure.</p>
<div class="codehilite"><pre><span></span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">db</span><span class="p">].</span><span class="n">name</span> <span class="p">[</span><span class="k">ON</span> <span class="k">CLUSTER</span> <span class="k">cluster</span><span class="p">]</span> <span class="k">ADD</span><span class="o">|</span><span class="k">DROP</span><span class="o">|</span><span class="k">MODIFY</span> <span class="k">COLUMN</span> <span class="p">...</span>
</pre></div>


<p>In the query, specify a list of one or more comma-separated actions.
Each action is an operation on a column.</p>
<p>The following actions are supported:</p>
<div class="codehilite"><pre><span></span><span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">name</span> <span class="p">[</span><span class="k">type</span><span class="p">]</span> <span class="p">[</span><span class="n">default_expr</span><span class="p">]</span> <span class="p">[</span><span class="k">AFTER</span> <span class="n">name_after</span><span class="p">]</span>
</pre></div>


<p>Adds a new column to the table with the specified name, type, and <code>default_expr</code> (see the section "Default expressions"). If you specify <code>AFTER name_after</code> (the name of another column), the column is added after the specified one in the list of table columns. Otherwise, the column is added to the end of the table. Note that there is no way to add a column to the beginning of a table. For a chain of actions, 'name_after' can be the name of a column that is added in one of the previous actions.</p>
<p>Adding a column just changes the table structure, without performing any actions with data. The data doesn't appear on the disk after ALTER. If the data is missing for a column when reading from the table, it is filled in with default values (by performing the default expression if there is one, or using zeros or empty strings). If the data is missing for a column when reading from the table, it is filled in with default values (by performing the default expression if there is one, or using zeros or empty strings). The column appears on the disk after merging data parts (see MergeTree).</p>
<p>This approach allows us to complete the ALTER query instantly, without increasing the volume of old data.</p>
<div class="codehilite"><pre><span></span><span class="k">DROP</span> <span class="k">COLUMN</span> <span class="n">name</span>
</pre></div>


<p>Deletes the column with the name 'name'.
Deletes data from the file system. Since this deletes entire files, the query is completed almost instantly.</p>
<div class="codehilite"><pre><span></span><span class="k">MODIFY</span> <span class="k">COLUMN</span> <span class="n">name</span> <span class="p">[</span><span class="k">type</span><span class="p">]</span> <span class="p">[</span><span class="n">default_expr</span><span class="p">]</span>
</pre></div>


<p>Changes the 'name' column's type to 'type' and/or the default expression to 'default_expr'. When changing the type, values are converted as if the 'toType' function were applied to them.</p>
<p>If only the default expression is changed, the query doesn't do anything complex, and is completed almost instantly.</p>
<p>Changing the column type is the only complex action – it changes the contents of files with data. For large tables, this may take a long time.</p>
<p>There are several processing stages:</p>
<ul>
<li>Preparing temporary (new) files with modified data.</li>
<li>Renaming old files.</li>
<li>Renaming the temporary (new) files to the old names.</li>
<li>Deleting the old files.</li>
</ul>
<p>Only the first stage takes time. If there is a failure at this stage, the data is not changed.
If there is a failure during one of the successive stages, data can be restored manually. The exception is if the old files were deleted from the file system but the data for the new files did not get written to the disk and was lost.</p>
<p>There is no support for changing the column type in arrays and nested data structures.</p>
<p>The <code>ALTER</code> query lets you create and delete separate elements (columns) in nested data structures, but not whole nested data structures. To add a nested data structure, you can add columns with a name like <code>name.nested_name</code> and the type <code>Array(T)</code>. A nested data structure is equivalent to multiple array columns with a name that has the same prefix before the dot.</p>
<p>There is no support for deleting columns in the primary key or the sampling key (columns that are in the <code>ENGINE</code> expression). Changing the type for columns that are included in the primary key is only possible if this change does not cause the data to be modified (for example, it is allowed to add values to an Enum or change a type with <code>DateTime</code>  to <code>UInt32</code>).</p>
<p>If the <code>ALTER</code> query is not sufficient for making the table changes you need, you can create a new table, copy the data to it using the <code>INSERT SELECT</code> query, then switch the tables using the <code>RENAME</code> query and delete the old table.</p>
<p>The <code>ALTER</code> query blocks all reads and writes for the table. In other words, if a long <code>SELECT</code> is running at the time of the <code>ALTER</code> query, the <code>ALTER</code> query will wait for it to complete. At the same time, all new queries to the same table will wait while this <code>ALTER</code> is running.</p>
<p>For tables that don't store data themselves (such as <code>Merge</code> and <code>Distributed</code>), <code>ALTER</code> just changes the table structure, and does not change the structure of subordinate tables. For example, when running ALTER for a <code>Distributed</code> table, you will also need to run <code>ALTER</code> for the tables on all remote servers.</p>
<p>The <code>ALTER</code> query for changing columns is replicated. The instructions are saved in ZooKeeper, then each replica applies them. All <code>ALTER</code> queries are run in the same order. The query waits for the appropriate actions to be completed on the other replicas. However, a query to change columns in a replicated table can be interrupted, and all actions will be performed asynchronously.</p>
<h4 id="manipulations-with-partitions-and-parts">Manipulations with partitions and parts</h4>
<p>It only works for tables in the <code>MergeTree</code> family. The following operations are available:</p>
<ul>
<li><code>DETACH PARTITION</code> – Move a partition to the 'detached' directory and forget it.</li>
<li><code>DROP PARTITION</code> – Delete a partition.</li>
<li><code>ATTACH PART|PARTITION</code> – Add a new part or partition from the <code>detached</code> directory to the table.</li>
<li><code>FREEZE PARTITION</code> – Create a backup of a partition.</li>
<li><code>FETCH PARTITION</code> – Download a partition from another server.</li>
</ul>
<p>Each type of query is covered separately below.</p>
<p>A partition in a table is data for a single calendar month. This is determined by the values of the date key specified in the table engine parameters. Each month's data is stored separately in order to simplify manipulations with this data.</p>
<p>A "part" in the table is part of the data from a single partition, sorted by the primary key.</p>
<p>You can use the <code>system.parts</code> table to view the set of table parts and partitions:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="k">system</span><span class="p">.</span><span class="n">parts</span> <span class="k">WHERE</span> <span class="n">active</span>
</pre></div>


<p><code>active</code> – Only count active parts. Inactive parts are, for example, source parts remaining after merging to a larger part – these parts are deleted approximately 10 minutes after merging.</p>
<p>Another way to view a set of parts and partitions is to go into the directory with table data.
Data directory: <code>/var/lib/clickhouse/data/database/table/</code>,where <code>/var/lib/clickhouse/</code> is the path to the ClickHouse data, 'database' is the database name, and 'table' is the table name. Example:</p>
<div class="codehilite"><pre><span></span>$ ls -l /var/lib/clickhouse/data/test/visits/
total <span class="m">48</span>
drwxrwxrwx <span class="m">2</span> clickhouse clickhouse <span class="m">20480</span> May  <span class="m">5</span> <span class="m">02</span>:58 20140317_20140323_2_2_0
drwxrwxrwx <span class="m">2</span> clickhouse clickhouse <span class="m">20480</span> May  <span class="m">5</span> <span class="m">02</span>:58 20140317_20140323_4_4_0
drwxrwxrwx <span class="m">2</span> clickhouse clickhouse  <span class="m">4096</span> May  <span class="m">5</span> <span class="m">02</span>:55 detached
-rw-rw-rw- <span class="m">1</span> clickhouse clickhouse     <span class="m">2</span> May  <span class="m">5</span> <span class="m">02</span>:58 increment.txt
</pre></div>


<p>Here, <code>20140317_20140323_2_2_0</code> and <code>20140317_20140323_4_4_0</code> are the directories of data parts.</p>
<p>Let's break down the name of the first part: <code>20140317_20140323_2_2_0</code>.</p>
<ul>
<li><code>20140317</code> is the minimum date of the data in the chunk.</li>
<li><code>20140323</code> is the maximum date of the data in the chunk.</li>
<li><code>2</code> is the minimum number of the data block.</li>
<li><code>2</code> is the maximum number of the data block.</li>
<li><code>0</code> is the chunk level (the depth of the merge tree it is formed from).</li>
</ul>
<p>Each piece relates to a single partition and contains data for just one month.
<code>201403</code> is the name of the partition. A partition is a set of parts for a single month.</p>
<p>On an operating server, you can't manually change the set of parts or their data on the file system, since the server won't know about it.
For non-replicated tables, you can do this when the server is stopped, but we don't recommended it.
For replicated tables, the set of parts can't be changed in any case.</p>
<p>The <code>detached</code> directory contains parts that are not used by the server - detached from the table using the <code>ALTER ... DETACH</code> query. Parts that are damaged are also moved to this directory, instead of deleting them. You can add, delete, or modify the data in the 'detached' directory at any time – the server won't know about this until you make the <code>ALTER TABLE ... ATTACH</code> query.</p>
<div class="codehilite"><pre><span></span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="k">table</span> <span class="n">DETACH</span> <span class="n">PARTITION</span> <span class="s1">&#39;name&#39;</span>
</pre></div>


<p>Move all data for partitions named 'name' to the 'detached' directory and forget about them.
The partition name is specified in YYYYMM format. It can be indicated in single quotes or without them.</p>
<p>After the query is executed, you can do whatever you want with the data in the 'detached' directory — delete it from the file system, or just leave it.</p>
<p>The query is replicated – data will be moved to the 'detached' directory and forgotten on all replicas. The query can only be sent to a leader replica. To find out if a replica is a leader, perform SELECT to the 'system.replicas' system table. Alternatively, it is easier to make a query on all replicas, and all except one will throw an exception.</p>
<div class="codehilite"><pre><span></span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="k">table</span> <span class="k">DROP</span> <span class="n">PARTITION</span> <span class="s1">&#39;name&#39;</span>
</pre></div>


<p>The same as the <code>DETACH</code> operation. Deletes data from the table. Data parts will be tagged as inactive and will be completely deleted in approximately 10 minutes. The query is replicated – data will be deleted on all replicas.</p>
<div class="codehilite"><pre><span></span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="k">table</span> <span class="n">ATTACH</span> <span class="n">PARTITION</span><span class="o">|</span><span class="n">PART</span> <span class="s1">&#39;name&#39;</span>
</pre></div>


<p>Adds data to the table from the 'detached' directory.</p>
<p>It is possible to add data for an entire partition or a separate part. For a part, specify the full name of the part in single quotes.</p>
<p>The query is replicated. Each replica checks whether there is data in the 'detached' directory. If there is data, it checks the integrity, verifies that it matches the data on the server that initiated the query, and then adds it if everything is correct. If not, it downloads data from the query requestor replica, or from another replica where the data has already been added.</p>
<p>So you can put data in the 'detached' directory on one replica, and use the ALTER ... ATTACH query to add it to the table on all replicas.</p>
<div class="codehilite"><pre><span></span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="k">table</span> <span class="k">FREEZE</span> <span class="n">PARTITION</span> <span class="s1">&#39;name&#39;</span>
</pre></div>


<p>Creates a local backup of one or multiple partitions. The name can be the full name of the partition (for example, 201403), or its prefix (for example, 2014): then the backup will be created for all the corresponding partitions.</p>
<p>The query does the following: for a data snapshot at the time of execution, it creates hardlinks to table data in the directory <code>/var/lib/clickhouse/shadow/N/...</code></p>
<p><code>/var/lib/clickhouse/</code> is the working ClickHouse directory from the config.
<code>N</code> is the incremental number of the backup.</p>
<p>The same structure of directories is created inside the backup as inside <code>/var/lib/clickhouse/</code>.
It also performs 'chmod' for all files, forbidding writes to them.</p>
<p>The backup is created almost instantly (but first it waits for current queries to the corresponding table to finish running). At first, the backup doesn't take any space on the disk. As the system works, the backup can take disk space, as data is modified. If the backup is made for old enough data, it won't take space on the disk.</p>
<p>After creating the backup, data from <code>/var/lib/clickhouse/shadow/</code> can be copied to the remote server and then deleted on the local server.
The entire backup process is performed without stopping the server.</p>
<p>The <code>ALTER ... FREEZE PARTITION</code> query is not replicated. A local backup is only created on the local server.</p>
<p>As an alternative, you can manually copy data from the <code>/var/lib/clickhouse/data/database/table</code> directory.
But if you do this while the server is running, race conditions are possible when copying directories with files being added or changed, and the backup may be inconsistent. You can do this if the server isn't running – then the resulting data will be the same as after the <code>ALTER TABLE t FREEZE PARTITION</code> query.</p>
<p><code>ALTER TABLE ... FREEZE PARTITION</code> only copies data, not table metadata. To make a backup of table metadata, copy the file  <code>/var/lib/clickhouse/metadata/database/table.sql</code></p>
<p>To restore from a backup:</p>
<blockquote>
<ul>
<li>Use the CREATE query to create the table if it doesn't exist. The query can be taken from an .sql file (replace <code>ATTACH</code> in it with <code>CREATE</code>).</li>
<li>Copy the data from the data/database/table/ directory inside the backup to the <code>/var/lib/clickhouse/data/database/table/detached/ directory.</code></li>
<li>Run <code>ALTER TABLE ... ATTACH PARTITION YYYYMM</code> queries, where <code>YYYYMM</code> is the month, for every month.</li>
</ul>
</blockquote>
<p>In this way, data from the backup will be added to the table.
Restoring from a backup doesn't require stopping the server.</p>
<h4 id="backups-and-replication">Backups and replication</h4>
<p>Replication provides protection from device failures. If all data disappeared on one of your replicas, follow the instructions in the "Restoration after failure" section to restore it.</p>
<p>For protection from device failures, you must use replication. For more information about replication, see the section "Data replication".</p>
<p>Backups protect against human error (accidentally deleting data, deleting the wrong data or in the wrong cluster, or corrupting data).
For high-volume databases, it can be difficult to copy backups to remote servers. In such cases, to protect from human error, you can keep a backup on the same server (it will reside in <code>/var/lib/clickhouse/shadow/</code>).</p>
<div class="codehilite"><pre><span></span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="k">table</span> <span class="k">FETCH</span> <span class="n">PARTITION</span> <span class="s1">&#39;name&#39;</span> <span class="k">FROM</span> <span class="s1">&#39;path-in-zookeeper&#39;</span>
</pre></div>


<p>This query only works for replicatable tables.</p>
<p>It downloads the specified partition from the shard that has its <code>ZooKeeper path</code> specified in the <code>FROM</code> clause, then puts it in the <code>detached</code> directory for the specified table.</p>
<p>Although the query is called <code>ALTER TABLE</code>, it does not change the table structure, and does not immediately change the data available in the table.</p>
<p>Data is placed in the <code>detached</code> directory. You can use the <code>ALTER TABLE ... ATTACH</code> query to attach the data.</p>
<p>The <code>FROM</code>  clause specifies the path in <code>ZooKeeper</code>. For example, <code>/clickhouse/tables/01-01/visits</code>.
Before downloading, the system checks that the partition exists and the table structure matches. The most appropriate replica is selected automatically from the healthy replicas.</p>
<p>The <code>ALTER ... FETCH PARTITION</code> query is not replicated. The partition will be downloaded to the 'detached' directory only on the local server. Note that if after this you use the <code>ALTER TABLE ... ATTACH</code> query to add data to the table, the data will be added on all replicas (on one of the replicas it will be added from the 'detached' directory, and on the rest it will be loaded from neighboring replicas).</p>
<h4 id="synchronicity-of-alter-queries">Synchronicity of ALTER queries</h4>
<p>For non-replicatable tables, all <code>ALTER</code> queries are performed synchronously. For replicatable tables, the query just adds instructions for the appropriate actions to <code>ZooKeeper</code>, and the actions themselves are performed as soon as possible. However, the query can wait for these actions to be completed on all the replicas.</p>
<p>For <code>ALTER ... ATTACH|DETACH|DROP</code> queries, you can use the <code>replication_alter_partitions_sync</code> setting to set up waiting.
Possible values: <code>0</code> – do not wait; <code>1</code> – only wait for own execution (default); <code>2</code> – wait for all.</p>
<p><a name="query_language_queries_show_databases"></a></p>
<h3 id="show-databases">SHOW DATABASES</h3>
<div class="codehilite"><pre><span></span><span class="k">SHOW</span> <span class="n">DATABASES</span> <span class="p">[</span><span class="k">INTO</span> <span class="n">OUTFILE</span> <span class="n">filename</span><span class="p">]</span> <span class="p">[</span><span class="n">FORMAT</span> <span class="n">format</span><span class="p">]</span>
</pre></div>


<p>Prints a list of all databases.
This query is identical to <code>SELECT name FROM system.databases [INTO OUTFILE filename] [FORMAT format]</code>.</p>
<p>See also the section "Formats".</p>
<h3 id="show-tables">SHOW TABLES</h3>
<div class="codehilite"><pre><span></span><span class="k">SHOW</span> <span class="p">[</span><span class="k">TEMPORARY</span><span class="p">]</span> <span class="n">TABLES</span> <span class="p">[</span><span class="k">FROM</span> <span class="n">db</span><span class="p">]</span> <span class="p">[</span><span class="k">LIKE</span> <span class="s1">&#39;pattern&#39;</span><span class="p">]</span> <span class="p">[</span><span class="k">INTO</span> <span class="n">OUTFILE</span> <span class="n">filename</span><span class="p">]</span> <span class="p">[</span><span class="n">FORMAT</span> <span class="n">format</span><span class="p">]</span>
</pre></div>


<p>Displays a list of tables</p>
<ul>
<li>tables from the current database, or from the 'db' database if "FROM db" is specified.</li>
<li>all tables, or tables whose name matches the pattern, if "LIKE 'pattern'" is specified.</li>
</ul>
<p>This query is identical to: <code>SELECT name FROM system.tables WHERE database = 'db' [AND name LIKE 'pattern'] [INTO OUTFILE filename] [FORMAT format]</code>.</p>
<p>See also the section "LIKE operator".</p>
<h3 id="show-processlist">SHOW PROCESSLIST</h3>
<div class="codehilite"><pre><span></span><span class="k">SHOW</span> <span class="n">PROCESSLIST</span> <span class="p">[</span><span class="k">INTO</span> <span class="n">OUTFILE</span> <span class="n">filename</span><span class="p">]</span> <span class="p">[</span><span class="n">FORMAT</span> <span class="n">format</span><span class="p">]</span>
</pre></div>


<p>Outputs a list of queries currently being processed, other than <code>SHOW PROCESSLIST</code> queries.</p>
<p>Prints a table containing the columns:</p>
<p><strong>user</strong> – The user who made the query. Keep in mind that for distributed processing, queries are sent to remote servers under the 'default' user. SHOW PROCESSLIST shows the username for a specific query, not for a query that this query initiated.</p>
<p><strong>address</strong> – The name of the host that the query was sent from. For distributed processing, on remote servers, this is the name of the query requestor host. To track where a distributed query was originally made from, look at SHOW PROCESSLIST on the query requestor server.</p>
<p><strong>elapsed</strong> – The execution time, in seconds. Queries are output in order of decreasing execution time.</p>
<p><strong>rows_read</strong>, <strong>bytes_read</strong> – How many rows and bytes of uncompressed data were read when processing the query. For distributed processing, data is totaled from all the remote servers. This is the data used for restrictions and quotas.</p>
<p><strong>memory_usage</strong> – Current RAM usage in bytes. See the setting 'max_memory_usage'.</p>
<p><strong>query</strong> – The query itself. In INSERT queries, the data for insertion is not output.</p>
<p><strong>query_id</strong> – The query identifier. Non-empty only if it was explicitly defined by the user. For distributed processing, the query ID is not passed to remote servers.</p>
<p>This query is identical to: <code>SELECT * FROM system.processes [INTO OUTFILE filename] [FORMAT format]</code>.</p>
<p>Tip (execute in the console):</p>
<div class="codehilite"><pre><span></span>watch -n1 <span class="s2">&quot;clickhouse-client --query=&#39;SHOW PROCESSLIST&#39;&quot;</span>
</pre></div>


<h3 id="show-create-table">SHOW CREATE TABLE</h3>
<div class="codehilite"><pre><span></span><span class="k">SHOW</span> <span class="k">CREATE</span> <span class="p">[</span><span class="k">TEMPORARY</span><span class="p">]</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="k">table</span> <span class="p">[</span><span class="k">INTO</span> <span class="n">OUTFILE</span> <span class="n">filename</span><span class="p">]</span> <span class="p">[</span><span class="n">FORMAT</span> <span class="n">format</span><span class="p">]</span>
</pre></div>


<p>Returns a single <code>String</code>-type 'statement' column, which contains a single value – the <code>CREATE</code> query used for creating the specified table.</p>
<h3 id="describe-table">DESCRIBE TABLE</h3>
<div class="codehilite"><pre><span></span><span class="k">DESC</span><span class="o">|</span><span class="k">DESCRIBE</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="k">table</span> <span class="p">[</span><span class="k">INTO</span> <span class="n">OUTFILE</span> <span class="n">filename</span><span class="p">]</span> <span class="p">[</span><span class="n">FORMAT</span> <span class="n">format</span><span class="p">]</span>
</pre></div>


<p>Returns two <code>String</code>-type columns: <code>name</code> and <code>type</code>, which indicate the names and types of columns in the specified table.</p>
<p>Nested data structures are output in "expanded" format. Each column is shown separately, with the name after a dot.</p>
<h3 id="exists">EXISTS</h3>
<div class="codehilite"><pre><span></span><span class="k">EXISTS</span> <span class="p">[</span><span class="k">TEMPORARY</span><span class="p">]</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="n">name</span> <span class="p">[</span><span class="k">INTO</span> <span class="n">OUTFILE</span> <span class="n">filename</span><span class="p">]</span> <span class="p">[</span><span class="n">FORMAT</span> <span class="n">format</span><span class="p">]</span>
</pre></div>


<p>Returns a single <code>UInt8</code>-type column, which contains the single value <code>0</code> if the table or database doesn't exist, or <code>1</code> if the table exists in the specified database.</p>
<h3 id="use">USE</h3>
<div class="codehilite"><pre><span></span><span class="n">USE</span> <span class="n">db</span>
</pre></div>


<p>Lets you set the current database for the session.
The current database is used for searching for tables if the database is not explicitly defined in the query with a dot before the table name.
This query can't be made when using the HTTP protocol, since there is no concept of a session.</p>
<h3 id="set">SET</h3>
<div class="codehilite"><pre><span></span><span class="k">SET</span> <span class="n">param</span> <span class="o">=</span> <span class="n">value</span>
</pre></div>


<p>Allows you to set <code>param</code> to <code>value</code>. You can also make all the settings from the specified settings profile in a single query. To do this, specify 'profile' as the setting name. For more information, see the section "Settings".
The setting is made for the session, or for the server (globally) if <code>GLOBAL</code> is specified.
When making a global setting, the setting is not applied to sessions already running, including the current session. It will only be used for new sessions.</p>
<p>When the server is restarted, global settings made using <code>SET</code> are lost.
To make settings that persist after a server restart, you can only use the server's config file.</p>
<h3 id="optimize">OPTIMIZE</h3>
<div class="codehilite"><pre><span></span><span class="n">OPTIMIZE</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="n">name</span> <span class="p">[</span><span class="n">PARTITION</span> <span class="n">partition</span><span class="p">]</span> <span class="p">[</span><span class="k">FINAL</span><span class="p">]</span>
</pre></div>


<p>Asks the table engine to do something for optimization.
Supported only by <code>*MergeTree</code> engines, in which this query initializes a non-scheduled merge of data parts.
If you specify a <code>PARTITION</code>, only the specified partition will be optimized.
If you specify <code>FINAL</code>, optimization will be performed even when all the data is already in one part.</p>
<p><a name="queries-insert"></a></p>
<h3 id="insert">INSERT</h3>
<p>Adding data.</p>
<p>Basic query format:</p>
<div class="codehilite"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="k">table</span> <span class="p">[(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">)]</span> <span class="k">VALUES</span> <span class="p">(</span><span class="n">v11</span><span class="p">,</span> <span class="n">v12</span><span class="p">,</span> <span class="n">v13</span><span class="p">),</span> <span class="p">(</span><span class="n">v21</span><span class="p">,</span> <span class="n">v22</span><span class="p">,</span> <span class="n">v23</span><span class="p">),</span> <span class="p">...</span>
</pre></div>


<p>The query can specify a list of columns to insert <code>[(c1, c2, c3)]</code>. In this case, the rest of the columns are filled with:</p>
<ul>
<li>The values calculated from the <code>DEFAULT</code>  expressions specified in the table definition.</li>
<li>Zeros and empty strings, if <code>DEFAULT</code> expressions are not defined.</li>
</ul>
<p>If <a href="#settings-strict_insert_defaults">strict_insert_defaults=1</a>, columns that do not have <code>DEFAULT</code> defined must be listed in the query.</p>
<p>Data can be passed to the INSERT in any <a href="#formats">format</a> supported by ClickHouse. The format must be specified explicitly in the query:</p>
<div class="codehilite"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="k">table</span> <span class="p">[(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">)]</span> <span class="n">FORMAT</span> <span class="n">format_name</span> <span class="n">data_set</span>
</pre></div>


<p>For example, the following query format is identical to the basic version of INSERT ... VALUES:</p>
<div class="codehilite"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="k">table</span> <span class="p">[(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">)]</span> <span class="n">FORMAT</span> <span class="k">Values</span> <span class="p">(</span><span class="n">v11</span><span class="p">,</span> <span class="n">v12</span><span class="p">,</span> <span class="n">v13</span><span class="p">),</span> <span class="p">(</span><span class="n">v21</span><span class="p">,</span> <span class="n">v22</span><span class="p">,</span> <span class="n">v23</span><span class="p">),</span> <span class="p">...</span>
</pre></div>


<p>ClickHouse removes all spaces and one line feed (if there is one) before the data. When forming a query, we recommend putting the data on a new line after the query operators (this is important if the data begins with spaces).</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">t</span> <span class="n">FORMAT</span> <span class="n">TabSeparated</span>
<span class="mi">11</span>  <span class="n">Hello</span><span class="p">,</span> <span class="n">world</span><span class="o">!</span>
<span class="mi">22</span>  <span class="n">Qwerty</span>
</pre></div>


<p>You can insert data separately from the query by using the command-line client or the HTTP interface. For more information, see the section "<a href="#interfaces">Interfaces</a>".</p>
<h4 id="inserting-the-results-of-select">Inserting the results of <code>SELECT</code></h4>
<div class="codehilite"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="k">table</span> <span class="p">[(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">)]</span> <span class="k">SELECT</span> <span class="p">...</span>
</pre></div>


<p>Columns are mapped according to their position in the SELECT clause. However, their names in the SELECT expression and the table for INSERT may differ. If necessary, type casting is performed.</p>
<p>None of the data formats except Values allow setting values to expressions such as <code>now()</code>, <code>1 + 2</code>,  and so on. The Values format allows limited use of expressions, but this is not recommended, because in this case inefficient code is used for their execution.</p>
<p>Other queries for modifying data parts are not supported: <code>UPDATE</code>, <code>DELETE</code>, <code>REPLACE</code>, <code>MERGE</code>, <code>UPSERT</code>, <code>INSERT UPDATE</code>.
However, you can delete old data using <code>ALTER TABLE ... DROP PARTITION</code>.</p>
<h4 id="performance-considerations">Performance considerations</h4>
<p><code>INSERT</code> sorts the input data by primary key and splits them into partitions by month. If you insert data for mixed months, it can significantly reduce the performance of the <code>INSERT</code> query. To avoid this:</p>
<ul>
<li>Add data in fairly large batches, such as 100,000 rows at a time.</li>
<li>Group data by month before uploading it to ClickHouse.</li>
</ul>
<p>Performance will not decrease if:</p>
<ul>
<li>Data is added in real time.</li>
<li>You upload data that is usually sorted by time.</li>
</ul>
<h3 id="select">SELECT</h3>
<p>Data sampling.</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="p">[</span><span class="k">DISTINCT</span><span class="p">]</span> <span class="n">expr_list</span>
    <span class="p">[</span><span class="k">FROM</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="k">table</span> <span class="o">|</span> <span class="p">(</span><span class="n">subquery</span><span class="p">)</span> <span class="o">|</span> <span class="n">table_function</span><span class="p">]</span> <span class="p">[</span><span class="k">FINAL</span><span class="p">]</span>
    <span class="p">[</span><span class="n">SAMPLE</span> <span class="n">sample_coeff</span><span class="p">]</span>
    <span class="p">[</span><span class="nb">ARRAY</span> <span class="k">JOIN</span> <span class="p">...]</span>
    <span class="p">[</span><span class="k">GLOBAL</span><span class="p">]</span> <span class="k">ANY</span><span class="o">|</span><span class="k">ALL</span> <span class="k">INNER</span><span class="o">|</span><span class="k">LEFT</span> <span class="k">JOIN</span> <span class="p">(</span><span class="n">subquery</span><span class="p">)</span><span class="o">|</span><span class="k">table</span> <span class="k">USING</span> <span class="n">columns_list</span>
    <span class="p">[</span><span class="n">PREWHERE</span> <span class="n">expr</span><span class="p">]</span>
    <span class="p">[</span><span class="k">WHERE</span> <span class="n">expr</span><span class="p">]</span>
    <span class="p">[</span><span class="k">GROUP</span> <span class="k">BY</span> <span class="n">expr_list</span><span class="p">]</span> <span class="p">[</span><span class="k">WITH</span> <span class="n">TOTALS</span><span class="p">]</span>
    <span class="p">[</span><span class="k">HAVING</span> <span class="n">expr</span><span class="p">]</span>
    <span class="p">[</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">expr_list</span><span class="p">]</span>
    <span class="p">[</span><span class="k">LIMIT</span> <span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">]</span><span class="n">m</span><span class="p">]</span>
    <span class="p">[</span><span class="k">UNION</span> <span class="k">ALL</span> <span class="p">...]</span>
    <span class="p">[</span><span class="k">INTO</span> <span class="n">OUTFILE</span> <span class="n">filename</span><span class="p">]</span>
    <span class="p">[</span><span class="n">FORMAT</span> <span class="n">format</span><span class="p">]</span>
    <span class="p">[</span><span class="k">LIMIT</span> <span class="n">n</span> <span class="k">BY</span> <span class="n">columns</span><span class="p">]</span>
</pre></div>


<p>All the clauses are optional, except for the required list of expressions immediately after SELECT.
The clauses below are described in almost the same order as in the query execution conveyor.</p>
<p>If the query omits the <code>DISTINCT</code>, <code>GROUP BY</code> and <code>ORDER BY</code> clauses and the <code>IN</code> and <code>JOIN</code> subqueries, the query will be completely stream processed, using O(1) amount of RAM.
Otherwise, the query might consume a lot of RAM if the appropriate restrictions are not specified: <code>max_memory_usage</code>, <code>max_rows_to_group_by</code>, <code>max_rows_to_sort</code>, <code>max_rows_in_distinct</code>, <code>max_bytes_in_distinct</code>, <code>max_rows_in_set</code>, <code>max_bytes_in_set</code>, <code>max_rows_in_join</code>, <code>max_bytes_in_join</code>, <code>max_bytes_before_external_sort</code>, <code>max_bytes_before_external_group_by</code>. For more information, see the section "Settings". It is possible to use external sorting (saving temporary tables to a disk) and external aggregation. <code>The system does not have "merge join"</code>.</p>
<h4 id="from-clause">FROM clause</h4>
<p>If the FROM clause is omitted, data will be read from the <code>system.one</code> table.
The 'system.one' table contains exactly one row (this table fulfills the same purpose as the DUAL table found in other DBMSs).</p>
<p>The FROM clause specifies the table to read data from, or a subquery, or a table function; ARRAY JOIN and the regular JOIN may also be included (see below).</p>
<p>Instead of a table, the SELECT subquery may be specified in brackets.
In this case, the subquery processing pipeline will be built into the processing pipeline of an external query.
In contrast to standard SQL, a synonym does not need to be specified after a subquery. For compatibility, it is possible to write 'AS name' after a subquery, but the specified name isn't used anywhere.</p>
<p>A table function may be specified instead of a table. For more information, see the section "Table functions".</p>
<p>To execute a query, all the columns listed in the query are extracted from the appropriate table. Any columns not needed for the external query are thrown out of the subqueries.
If a query does not list any columns (for example, SELECT count() FROM t), some column is extracted from the table anyway (the smallest one is preferred), in order to calculate the number of rows.</p>
<p>The FINAL modifier can be used only for a SELECT from a CollapsingMergeTree table. When you specify FINAL, data is selected fully "collapsed". Keep in mind that using FINAL leads to a selection that includes columns related to the primary key, in addition to the columns specified in the SELECT. Additionally, the query will be executed in a single stream, and data will be merged during query execution. This means that when using FINAL, the query is processed more slowly. In most cases, you should avoid using FINAL. For more information, see the section "CollapsingMergeTree engine".</p>
<h4 id="sample-clause">SAMPLE clause</h4>
<p>The SAMPLE clause allows for approximated query processing. Approximated query processing is only supported by MergeTree* type tables, and only if the sampling expression was specified during table creation (see the section "MergeTree engine").</p>
<p><code>SAMPLE</code> has the <code>format SAMPLE k</code>, where <code>k</code> is a decimal number from 0 to 1, or <code>SAMPLE n</code>, where 'n' is a sufficiently large integer.</p>
<p>In the first case, the query will be executed on 'k' percent of data. For example, <code>SAMPLE 0.1</code> runs the query on 10% of data.
In the second case, the query will be executed on a sample of no more than 'n' rows. For example, <code>SAMPLE 10000000</code> runs the query on a maximum of 10,000,000 rows.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="n">Title</span><span class="p">,</span>
    <span class="k">count</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10</span> <span class="k">AS</span> <span class="n">PageViews</span>
<span class="k">FROM</span> <span class="n">hits_distributed</span>
<span class="n">SAMPLE</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span>
<span class="k">WHERE</span>
    <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">34</span>
    <span class="k">AND</span> <span class="n">toDate</span><span class="p">(</span><span class="n">EventDate</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">toDate</span><span class="p">(</span><span class="s1">&#39;2013-01-29&#39;</span><span class="p">)</span>
    <span class="k">AND</span> <span class="n">toDate</span><span class="p">(</span><span class="n">EventDate</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">toDate</span><span class="p">(</span><span class="s1">&#39;2013-02-04&#39;</span><span class="p">)</span>
    <span class="k">AND</span> <span class="k">NOT</span> <span class="n">DontCountHits</span>
    <span class="k">AND</span> <span class="k">NOT</span> <span class="n">Refresh</span>
    <span class="k">AND</span> <span class="n">Title</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">Title</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">PageViews</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">1000</span>
</pre></div>


<p>In this example, the query is executed on a sample from 0.1 (10%) of data. Values of aggregate functions are not corrected automatically, so to get an approximate result, the value 'count()' is manually multiplied by 10.</p>
<p>When using something like <code>SAMPLE 10000000</code>, there isn't any information about which relative percent of data was processed or what the aggregate functions should be multiplied by, so this method of writing is not always appropriate to the situation.</p>
<p>A sample with a relative coefficient is "consistent": if we look at all possible data that could be in the table, a sample (when using a single sampling expression specified during table creation) with the same coefficient always selects the same subset of possible data. In other words, a sample from different tables on different servers at different times is made the same way.</p>
<p>For example, a sample of user IDs takes rows with the same subset of all the possible user IDs from different tables. This allows using the sample in subqueries in the IN clause, as well as for manually correlating results of different queries with samples.</p>
<h4 id="array-join-clause">ARRAY JOIN clause</h4>
<p>Allows executing JOIN with an array or nested data structure. The intent is similar to the 'arrayJoin' function, but its functionality is broader.</p>
<p><code>ARRAY JOIN</code> is essentially <code>INNER JOIN</code> with an array. Example:</p>
<div class="codehilite"><pre><span></span>:) CREATE TABLE arrays_test (s String, arr Array(UInt8)) ENGINE = Memory

CREATE TABLE arrays_test
(
    s String,
    arr Array(UInt8)
) ENGINE = Memory

Ok.

0 rows in set. Elapsed: 0.001 sec.

:) INSERT INTO arrays_test VALUES (&#39;Hello&#39;, [1,2]), (&#39;World&#39;, [3,4,5]), (&#39;Goodbye&#39;, [])

INSERT INTO arrays_test VALUES

Ok.

3 rows in set. Elapsed: 0.001 sec.

:) SELECT * FROM arrays_test

SELECT *
FROM arrays_test

┌─s───────┬─arr─────┐
│ Hello   │ [1,2]   │
│ World   │ [3,4,5] │
│ Goodbye │ []      │
└─────────┴─────────┘

3 rows in set. Elapsed: 0.001 sec.

:) SELECT s, arr FROM arrays_test ARRAY JOIN arr

SELECT s, arr
FROM arrays_test
ARRAY JOIN arr

┌─s─────┬─arr─┐
│ Hello │   1 │
│ Hello │   2 │
│ World │   3 │
│ World │   4 │
│ World │   5 │
└───────┴─────┘

5 rows in set. Elapsed: 0.001 sec.
</pre></div>


<p>An alias can be specified for an array in the ARRAY JOIN clause. In this case, an array item can be accessed by this alias, but the array itself by the original name. Example:</p>
<div class="codehilite"><pre><span></span>:) SELECT s, arr, a FROM arrays_test ARRAY JOIN arr AS a

SELECT s, arr, a
FROM arrays_test
ARRAY JOIN arr AS a

┌─s─────┬─arr─────┬─a─┐
│ Hello │ [1,2]   │ 1 │
│ Hello │ [1,2]   │ 2 │
│ World │ [3,4,5] │ 3 │
│ World │ [3,4,5] │ 4 │
│ World │ [3,4,5] │ 5 │
└───────┴─────────┴───┘

5 rows in set. Elapsed: 0.001 sec.
</pre></div>


<p>Multiple arrays of the same size can be comma-separated in the ARRAY JOIN clause. In this case, JOIN is performed with them simultaneously (the direct sum, not the direct product). Example:</p>
<div class="codehilite"><pre><span></span>:) SELECT s, arr, a, num, mapped FROM arrays_test ARRAY JOIN arr AS a, arrayEnumerate(arr) AS num, arrayMap(x -&gt; x + 1, arr) AS mapped

SELECT s, arr, a, num, mapped
FROM arrays_test
ARRAY JOIN arr AS a, arrayEnumerate(arr) AS num, arrayMap(lambda(tuple(x), plus(x, 1)), arr) AS mapped

┌─s─────┬─arr─────┬─a─┬─num─┬─mapped─┐
│ Hello │ [1,2]   │ 1 │   1 │      2 │
│ Hello │ [1,2]   │ 2 │   2 │      3 │
│ World │ [3,4,5] │ 3 │   1 │      4 │
│ World │ [3,4,5] │ 4 │   2 │      5 │
│ World │ [3,4,5] │ 5 │   3 │      6 │
└───────┴─────────┴───┴─────┴────────┘

5 rows in set. Elapsed: 0.002 sec.

:) SELECT s, arr, a, num, arrayEnumerate(arr) FROM arrays_test ARRAY JOIN arr AS a, arrayEnumerate(arr) AS num

SELECT s, arr, a, num, arrayEnumerate(arr)
FROM arrays_test
ARRAY JOIN arr AS a, arrayEnumerate(arr) AS num

┌─s─────┬─arr─────┬─a─┬─num─┬─arrayEnumerate(arr)─┐
│ Hello │ [1,2]   │ 1 │   1 │ [1,2]               │
│ Hello │ [1,2]   │ 2 │   2 │ [1,2]               │
│ World │ [3,4,5] │ 3 │   1 │ [1,2,3]             │
│ World │ [3,4,5] │ 4 │   2 │ [1,2,3]             │
│ World │ [3,4,5] │ 5 │   3 │ [1,2,3]             │
└───────┴─────────┴───┴─────┴─────────────────────┘

5 rows in set. Elapsed: 0.002 sec.
</pre></div>


<p>ARRAY JOIN also works with nested data structures. Example:</p>
<div class="codehilite"><pre><span></span>:) CREATE TABLE nested_test (s String, nest Nested(x UInt8, y UInt32)) ENGINE = Memory

CREATE TABLE nested_test
(
    s String,
    nest Nested(
    x UInt8,
    y UInt32)
) ENGINE = Memory

Ok.

0 rows in set. Elapsed: 0.006 sec.

:) INSERT INTO nested_test VALUES (&#39;Hello&#39;, [1,2], [10,20]), (&#39;World&#39;, [3,4,5], [30,40,50]), (&#39;Goodbye&#39;, [], [])

INSERT INTO nested_test VALUES

Ok.

3 rows in set. Elapsed: 0.001 sec.

:) SELECT * FROM nested_test

SELECT *
FROM nested_test

┌─s───────┬─nest.x──┬─nest.y─────┐
│ Hello   │ [1,2]   │ [10,20]    │
│ World   │ [3,4,5] │ [30,40,50] │
│ Goodbye │ []      │ []         │
└─────────┴─────────┴────────────┘

3 rows in set. Elapsed: 0.001 sec.

:) SELECT s, nest.x, nest.y FROM nested_test ARRAY JOIN nest

SELECT s, `nest.x`, `nest.y`
FROM nested_test
ARRAY JOIN nest

┌─s─────┬─nest.x─┬─nest.y─┐
│ Hello │      1 │     10 │
│ Hello │      2 │     20 │
│ World │      3 │     30 │
│ World │      4 │     40 │
│ World │      5 │     50 │
└───────┴────────┴────────┘

5 rows in set. Elapsed: 0.001 sec.
</pre></div>


<p>When specifying names of nested data structures in ARRAY JOIN, the meaning is the same as ARRAY JOIN with all the array elements that it consists of. Example:</p>
<div class="codehilite"><pre><span></span>:) SELECT s, nest.x, nest.y FROM nested_test ARRAY JOIN nest.x, nest.y

SELECT s, `nest.x`, `nest.y`
FROM nested_test
ARRAY JOIN `nest.x`, `nest.y`

┌─s─────┬─nest.x─┬─nest.y─┐
│ Hello │      1 │     10 │
│ Hello │      2 │     20 │
│ World │      3 │     30 │
│ World │      4 │     40 │
│ World │      5 │     50 │
└───────┴────────┴────────┘

5 rows in set. Elapsed: 0.001 sec.
</pre></div>


<p>This variation also makes sense:</p>
<div class="codehilite"><pre><span></span>:) SELECT s, nest.x, nest.y FROM nested_test ARRAY JOIN nest.x

SELECT s, `nest.x`, `nest.y`
FROM nested_test
ARRAY JOIN `nest.x`

┌─s─────┬─nest.x─┬─nest.y─────┐
│ Hello │      1 │ [10,20]    │
│ Hello │      2 │ [10,20]    │
│ World │      3 │ [30,40,50] │
│ World │      4 │ [30,40,50] │
│ World │      5 │ [30,40,50] │
└───────┴────────┴────────────┘

5 rows in set. Elapsed: 0.001 sec.
</pre></div>


<p>An alias may be used for a nested data structure, in order to select either the JOIN result or the source array. Example:</p>
<div class="codehilite"><pre><span></span>:) SELECT s, n.x, n.y, nest.x, nest.y FROM nested_test ARRAY JOIN nest AS n

SELECT s, `n.x`, `n.y`, `nest.x`, `nest.y`
FROM nested_test
ARRAY JOIN nest AS n

┌─s─────┬─n.x─┬─n.y─┬─nest.x──┬─nest.y─────┐
│ Hello │   1 │  10 │ [1,2]   │ [10,20]    │
│ Hello │   2 │  20 │ [1,2]   │ [10,20]    │
│ World │   3 │  30 │ [3,4,5] │ [30,40,50] │
│ World │   4 │  40 │ [3,4,5] │ [30,40,50] │
│ World │   5 │  50 │ [3,4,5] │ [30,40,50] │
└───────┴─────┴─────┴─────────┴────────────┘

5 rows in set. Elapsed: 0.001 sec.
</pre></div>


<p>Example of using the arrayEnumerate function:</p>
<div class="codehilite"><pre><span></span>:) SELECT s, n.x, n.y, nest.x, nest.y, num FROM nested_test ARRAY JOIN nest AS n, arrayEnumerate(nest.x) AS num

SELECT s, `n.x`, `n.y`, `nest.x`, `nest.y`, num
FROM nested_test
ARRAY JOIN nest AS n, arrayEnumerate(`nest.x`) AS num

┌─s─────┬─n.x─┬─n.y─┬─nest.x──┬─nest.y─────┬─num─┐
│ Hello │   1 │  10 │ [1,2]   │ [10,20]    │   1 │
│ Hello │   2 │  20 │ [1,2]   │ [10,20]    │   2 │
│ World │   3 │  30 │ [3,4,5] │ [30,40,50] │   1 │
│ World │   4 │  40 │ [3,4,5] │ [30,40,50] │   2 │
│ World │   5 │  50 │ [3,4,5] │ [30,40,50] │   3 │
└───────┴─────┴─────┴─────────┴────────────┴─────┘

5 rows in set. Elapsed: 0.002 sec.
</pre></div>


<p>The query can only specify a single ARRAY JOIN clause.</p>
<p>The corresponding conversion can be performed before the WHERE/PREWHERE clause (if its result is needed in this clause), or after completing WHERE/PREWHERE (to reduce the volume of calculations).</p>
<h4 id="join-clause">JOIN clause</h4>
<p>The normal JOIN, which is not related to ARRAY JOIN described above.</p>
<div class="codehilite"><pre><span></span><span class="p">[</span><span class="k">GLOBAL</span><span class="p">]</span> <span class="k">ANY</span><span class="o">|</span><span class="k">ALL</span> <span class="k">INNER</span><span class="o">|</span><span class="k">LEFT</span> <span class="p">[</span><span class="k">OUTER</span><span class="p">]</span> <span class="k">JOIN</span> <span class="p">(</span><span class="n">subquery</span><span class="p">)</span><span class="o">|</span><span class="k">table</span> <span class="k">USING</span> <span class="n">columns_list</span>
</pre></div>


<p>Performs joins with data from the subquery. At the beginning of query processing, the subquery specified after JOIN is run, and its result is saved in memory. Then it is read from the "left" table specified in the FROM clause, and while it is being read, for each of the read rows from the "left" table, rows are selected from the subquery results table (the "right" table) that meet the condition for matching the values of the columns specified in USING.</p>
<p>The table name can be specified instead of a subquery. This is equivalent to the <code>SELECT * FROM table</code> subquery, except in a special case when the table has the Join engine – an array prepared for joining.</p>
<p>All columns that are not needed for the JOIN are deleted from the subquery.</p>
<p>There are several types of JOINs:</p>
<p><code>INNER</code> or <code>LEFT</code> type:If INNER is specified, the result will contain only those rows that have a matching row in the right table.
If LEFT is specified, any rows in the left table that don't have matching rows in the right table will be assigned the default value - zeros or empty rows. LEFT OUTER may be written instead of LEFT; the word OUTER does not affect anything.</p>
<p><code>ANY</code> or <code>ALL</code> stringency:If <code>ANY</code> is specified and the right table has several matching rows, only the first one found is joined.
If <code>ALL</code> is specified and the right table has several matching rows, the data will be multiplied by the number of these rows.</p>
<p>Using ALL corresponds to the normal JOIN semantic from standard SQL.
Using ANY is optimal. If the right table has only one matching row, the results of ANY and ALL are the same. You must specify either ANY or ALL (neither of them is selected by default).</p>
<p><code>GLOBAL</code> distribution:</p>
<p>When using a normal JOIN, the query is sent to remote servers. Subqueries are run on each of them in order to make the right table, and the join is performed with this table. In other words, the right table is formed on each server separately.</p>
<p>When using <code>GLOBAL ... JOIN</code>, first the requestor server runs a subquery to calculate the right table. This temporary table is passed to each remote server, and queries are run on them using the temporary data that was transmitted.</p>
<p>Be careful when using GLOBAL JOINs. For more information, see the section "Distributed subqueries".</p>
<p>Any combination of JOINs is possible. For example, <code>GLOBAL ANY LEFT OUTER JOIN</code>.</p>
<p>When running a JOIN, there is no optimization of the order of execution in relation to other stages of the query. The join (a search in the right table) is run before filtering in WHERE and before aggregation. In order to explicitly set the processing order, we recommend running a JOIN subquery with a subquery.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="n">CounterID</span><span class="p">,</span>
    <span class="n">hits</span><span class="p">,</span>
    <span class="n">visits</span>
<span class="k">FROM</span>
<span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">CounterID</span><span class="p">,</span>
        <span class="k">count</span><span class="p">()</span> <span class="k">AS</span> <span class="n">hits</span>
    <span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">hits</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">CounterID</span>
<span class="p">)</span> <span class="k">ANY</span> <span class="k">LEFT</span> <span class="k">JOIN</span>
<span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">CounterID</span><span class="p">,</span>
        <span class="k">sum</span><span class="p">(</span><span class="n">Sign</span><span class="p">)</span> <span class="k">AS</span> <span class="n">visits</span>
    <span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">visits</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">CounterID</span>
<span class="p">)</span> <span class="k">USING</span> <span class="n">CounterID</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">hits</span> <span class="k">DESC</span>
<span class="k">LIMIT</span> <span class="mi">10</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─CounterID─┬───hits─┬─visits─┐
│   1143050 │ 523264 │  13665 │
│    731962 │ 475698 │ 102716 │
│    722545 │ 337212 │ 108187 │
│    722889 │ 252197 │  10547 │
│   2237260 │ 196036 │   9522 │
│  23057320 │ 147211 │   7689 │
│    722818 │  90109 │  17847 │
│     48221 │  85379 │   4652 │
│  19762435 │  77807 │   7026 │
│    722884 │  77492 │  11056 │
└───────────┴────────┴────────┘
</pre></div>


<p>Subqueries don't allow you to set names or use them for referencing a column from a specific subquery.
The columns specified in USING must have the same names in both subqueries, and the other columns must be named differently. You can use aliases to change the names of columns in subqueries (the example uses the aliases 'hits' and 'visits').</p>
<p>The USING clause specifies one or more columns to join, which establishes the equality of these columns. The list of columns is set without brackets. More complex join conditions are not supported.</p>
<p>The right table (the subquery result) resides in RAM. If there isn't enough memory, you can't run a JOIN.</p>
<p>Only one JOIN can be specified in a query (on a single level). To run multiple JOINs, you can put them in subqueries.</p>
<p>Each time a query is run with the same JOIN, the subquery is run again – the result is not cached. To avoid this, use the special 'Join' table engine, which is a prepared array for joining that is always in RAM. For more information, see the section "Table engines, Join".</p>
<p>In some cases, it is more efficient to use IN instead of JOIN.
Among the various types of JOINs, the most efficient is ANY LEFT JOIN, then ANY INNER JOIN. The least efficient are ALL LEFT JOIN and ALL INNER JOIN.</p>
<p>If you need a JOIN for joining with dimension tables (these are relatively small tables that contain dimension properties, such as names for advertising campaigns), a JOIN might not be very convenient due to the bulky syntax and the fact that the right table is re-accessed for every query. For such cases, there is an "external dictionaries" feature that you should use instead of JOIN. For more information, see the section "External dictionaries".</p>
<h4 id="where-clause">WHERE clause</h4>
<p>If there is a WHERE clause, it must contain an expression with the UInt8 type. This is usually an expression with comparison and logical operators.
This expression will be used for filtering data before all other transformations.</p>
<p>If indexes are supported by the database table engine, the expression is evaluated on the ability to use indexes.</p>
<h4 id="prewhere-clause">PREWHERE clause</h4>
<p>This clause has the same meaning as the WHERE clause. The difference is in which data is read from the table.
When using PREWHERE, first only the columns necessary for executing PREWHERE are read. Then the other columns are read that are needed for running the query, but only those blocks where the PREWHERE expression is true.</p>
<p>It makes sense to use PREWHERE if there are filtration conditions that are not suitable for indexes that are used by a minority of the columns in the query, but that provide strong data filtration. This reduces the volume of data to read.</p>
<p>For example, it is useful to write PREWHERE for queries that extract a large number of columns, but that only have filtration for a few columns.</p>
<p>PREWHERE is only supported by tables from the <code>*MergeTree</code> family.</p>
<p>A query may simultaneously specify PREWHERE and WHERE. In this case, PREWHERE precedes WHERE.</p>
<p>Keep in mind that it does not make much sense for PREWHERE to only specify those columns that have an index, because when using an index, only the data blocks that match the index are read.</p>
<p>If the 'optimize_move_to_prewhere' setting is set to 1 and PREWHERE is omitted, the system uses heuristics to automatically move parts of expressions from WHERE to PREWHERE.</p>
<h4 id="group-by-clause">GROUP BY clause</h4>
<p>This is one of the most important parts of a column-oriented DBMS.</p>
<p>If there is a GROUP BY clause, it must contain a list of expressions. Each expression will be referred to here as a "key".
All the expressions in the SELECT, HAVING, and ORDER BY clauses must be calculated from keys or from aggregate functions. In other words, each column selected from the table must be used either in keys or inside aggregate functions.</p>
<p>If a query contains only table columns inside aggregate functions, the GROUP BY clause can be omitted, and aggregation by an empty set of keys is assumed.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="k">count</span><span class="p">(),</span>
    <span class="n">median</span><span class="p">(</span><span class="n">FetchTiming</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="o">?</span> <span class="mi">60</span> <span class="p">:</span> <span class="n">FetchTiming</span><span class="p">),</span>
    <span class="k">count</span><span class="p">()</span> <span class="o">-</span> <span class="k">sum</span><span class="p">(</span><span class="n">Refresh</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">hits</span>
</pre></div>


<p>However, in contrast to standard SQL, if the table doesn't have any rows (either there aren't any at all, or there aren't any after using WHERE to filter), an empty result is returned, and not the result from one of the rows containing the initial values of aggregate functions.</p>
<p>As opposed to MySQL (and conforming to standard SQL), you can't get some value of some column that is not in a key or aggregate function (except constant expressions). To work around this, you can use the 'any' aggregate function (get the first encountered value) or 'min/max'.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="n">domainWithoutWWW</span><span class="p">(</span><span class="n">URL</span><span class="p">)</span> <span class="k">AS</span> <span class="k">domain</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(),</span>
    <span class="k">any</span><span class="p">(</span><span class="n">Title</span><span class="p">)</span> <span class="k">AS</span> <span class="n">title</span> <span class="c1">-- getting the first occurred page header for each domain.</span>
<span class="k">FROM</span> <span class="n">hits</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">domain</span>
</pre></div>


<p>For every different key value encountered, GROUP BY calculates a set of aggregate function values.</p>
<p>GROUP BY is not supported for array columns.</p>
<p>A constant can't be specified as arguments for aggregate functions. Example: sum(1). Instead of this, you can get rid of the constant. Example: <code>count()</code>.</p>
<h5 id="with-totals-modifier">WITH TOTALS modifier</h5>
<p>If the WITH TOTALS modifier is specified, another row will be calculated. This row will have key columns containing default values (zeros or empty lines), and columns of aggregate functions with the values calculated across all the rows (the "total" values).</p>
<p>This extra row is output in JSON*, TabSeparated*, and Pretty* formats, separately from the other rows. In the other formats, this row is not output.</p>
<p>In JSON* formats, this row is output as a separate 'totals' field. In TabSeparated* formats, the row comes after the main result, preceded by an empty row (after the other data). In Pretty* formats, the row is output as a separate table after the main result.</p>
<p><code>WITH TOTALS</code> can be run in different ways when HAVING is present. The behavior depends on the 'totals_mode' setting.
By default, <code>totals_mode = 'before_having'</code>. In this case, 'totals' is calculated across all rows, including the ones that don't pass through HAVING and 'max_rows_to_group_by'.</p>
<p>The other alternatives include only the rows that pass through HAVING in 'totals', and behave differently with the setting <code>max_rows_to_group_by</code> and <code>group_by_overflow_mode = 'any'</code>.</p>
<p><code>after_having_exclusive</code> – Don't include rows that didn't pass through <code>max_rows_to_group_by</code>. In other words, 'totals' will have less than or the same number of rows as it would if <code>max_rows_to_group_by</code> were omitted.</p>
<p><code>after_having_inclusive</code> – Include all the rows that didn't pass through 'max_rows_to_group_by' in 'totals'. In other words, 'totals' will have more than or the same number of rows as it would if <code>max_rows_to_group_by</code> were omitted.</p>
<p><code>after_having_auto</code> – Count the number of rows that passed through HAVING. If it is more than a certain amount (by default, 50%), include all the rows that didn't pass through 'max_rows_to_group_by' in 'totals'. Otherwise, do not include them.</p>
<p><code>totals_auto_threshold</code> – By default, 0.5. The coefficient for <code>after_having_auto</code>.</p>
<p>If <code>max_rows_to_group_by</code> and <code>group_by_overflow_mode = 'any'</code> are not used, all variations of <code>after_having</code> are the same, and you can use any of them (for example, <code>after_having_auto</code>).</p>
<p>You can use WITH TOTALS in subqueries, including subqueries in the JOIN clause (in this case, the respective total values are combined).</p>
<h5 id="group-by-in-external-memory">GROUP BY in external memory</h5>
<p>You can enable dumping temporary data to the disk to restrict memory usage during GROUP BY.
The <code>max_bytes_before_external_group_by</code> setting determines the threshold RAM consumption for dumping GROUP BY temporary data to the file system. If set to 0 (the default), it is disabled.</p>
<p>When using <code>max_bytes_before_external_group_by</code>, we recommend that you set max_memory_usage about twice as high. This is necessary because there are two stages to aggregation: reading the date and forming intermediate data (1) and merging the intermediate data (2). Dumping data to the file system can only occur during stage 1. If the temporary data wasn't dumped, then stage 2 might require up to the same amount of memory as in stage 1.</p>
<p>For example, if <code>max_memory_usage</code> was set to 10000000000 and you want to use external aggregation, it makes sense to set <code>max_bytes_before_external_group_by</code> to 10000000000, and max_memory_usage to 20000000000. When external aggregation is triggered (if there was at least one dump of temporary data), maximum consumption of RAM is only slightly more than <code>max_bytes_before_external_group_by</code>.</p>
<p>With distributed query processing, external aggregation is performed on remote servers. In order for the requestor server to use only a small amount of RAM, set <code>distributed_aggregation_memory_efficient</code>  to 1.</p>
<p>When merging data flushed to the disk, as well as when merging results from remote servers when the <code>distributed_aggregation_memory_efficient</code> setting is enabled, consumes up to 1/256 * the number of threads from the total amount of RAM.</p>
<p>When external aggregation is enabled, if there was less than <code>max_bytes_before_external_group_by</code>  of data (i.e. data was not flushed), the query runs just as fast as without external aggregation. If any temporary data was flushed, the run time will be several times longer (approximately three times).</p>
<p>If you have an ORDER BY with a small LIMIT after GROUP BY, then the ORDER BY CLAUSE will not use significant amounts of RAM.
But if the ORDER BY doesn't have LIMIT, don't forget to enable external sorting (<code>max_bytes_before_external_sort</code>).</p>
<h4 id="limit-n-by-clause">LIMIT N BY clause</h4>
<p>LIMIT N BY COLUMNS selects the top N rows for each group of COLUMNS. LIMIT N BY is not related to LIMIT; they can both be used in the same query. The key for LIMIT N BY can contain any number of columns or expressions.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="n">domainWithoutWWW</span><span class="p">(</span><span class="n">URL</span><span class="p">)</span> <span class="k">AS</span> <span class="k">domain</span><span class="p">,</span>
    <span class="n">domainWithoutWWW</span><span class="p">(</span><span class="n">REFERRER_URL</span><span class="p">)</span> <span class="k">AS</span> <span class="n">referrer</span><span class="p">,</span>
    <span class="n">device_type</span><span class="p">,</span>
    <span class="k">count</span><span class="p">()</span> <span class="n">cnt</span>
<span class="k">FROM</span> <span class="n">hits</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">domain</span><span class="p">,</span> <span class="n">referrer</span><span class="p">,</span> <span class="n">device_type</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">cnt</span> <span class="k">DESC</span>
<span class="k">LIMIT</span> <span class="mi">5</span> <span class="k">BY</span> <span class="k">domain</span><span class="p">,</span> <span class="n">device_type</span>
<span class="k">LIMIT</span> <span class="mi">100</span>
</pre></div>


<p>The query will select the top 5 referrers for each <code>domain, device_type</code> pair, but not more than 100 rows (<code>LIMIT n BY + LIMIT</code>).</p>
<h4 id="having-clause">HAVING clause</h4>
<p>Allows filtering the result received after GROUP BY, similar to the WHERE clause.
WHERE and HAVING differ in that WHERE is performed before aggregation (GROUP BY), while HAVING is performed after it.
If aggregation is not performed, HAVING can't be used.</p>
<p><a name="query_language-queries-order_by"></a></p>
<h4 id="order-by-clause">ORDER BY clause</h4>
<p>The ORDER BY clause contains a list of expressions, which can each be assigned DESC or ASC (the sorting direction). If the direction is not specified, ASC is assumed. ASC is sorted in ascending order, and DESC in descending order. The sorting direction applies to a single expression, not to the entire list. Example: <code>ORDER BY Visits DESC, SearchPhrase</code></p>
<p>For sorting by String values, you can specify collation (comparison). Example: <code>ORDER BY SearchPhrase COLLATE 'tr'</code> - for sorting by keyword in ascending order, using the Turkish alphabet, case insensitive, assuming that strings are UTF-8 encoded. COLLATE can be specified or not for each expression in ORDER BY independently. If ASC or DESC is specified, COLLATE is specified after it. When using COLLATE, sorting is always case-insensitive.</p>
<p>We only recommend using COLLATE for final sorting of a small number of rows, since sorting with COLLATE is less efficient than normal sorting by bytes.</p>
<p>Rows that have identical values for the list of sorting expressions are output in an arbitrary order, which can also be nondeterministic (different each time).
If the ORDER BY clause is omitted, the order of the rows is also undefined, and may be nondeterministic as well.</p>
<p>When floating point numbers are sorted, NaNs are separate from the other values. Regardless of the sorting order, NaNs come at the end. In other words, for ascending sorting they are placed as if they are larger than all the other numbers, while for descending sorting they are placed as if they are smaller than the rest.</p>
<p>Less RAM is used if a small enough LIMIT is specified in addition to ORDER BY. Otherwise, the amount of memory spent is proportional to the volume of data for sorting. For distributed query processing, if GROUP BY is omitted, sorting is partially done on remote servers, and the results are merged on the requestor server. This means that for distributed sorting, the volume of data to sort can be greater than the amount of memory on a single server.</p>
<p>If there is not enough RAM, it is possible to perform sorting in external memory (creating temporary files on a disk). Use the setting <code>max_bytes_before_external_sort</code> for this purpose. If it is set to 0 (the default), external sorting is disabled. If it is enabled, when the volume of data to sort reaches the specified number of bytes, the collected data is sorted and dumped into a temporary file. After all data is read, all the sorted files are merged and the results are output. Files are written to the /var/lib/clickhouse/tmp/ directory in the config (by default, but you can use the 'tmp_path' parameter to change this setting).</p>
<p>Running a query may use more memory than 'max_bytes_before_external_sort'. For this reason, this setting must have a value significantly smaller than 'max_memory_usage'. As an example, if your server has 128 GB of RAM and you need to run a single query, set 'max_memory_usage' to 100 GB, and 'max_bytes_before_external_sort' to 80 GB.</p>
<p>External sorting works much less effectively than sorting in RAM.</p>
<h4 id="select-clause">SELECT clause</h4>
<p>The expressions specified in the SELECT clause are analyzed after the calculations for all the clauses listed above are completed.
More specifically, expressions are analyzed that are above the aggregate functions, if there are any aggregate functions.
The aggregate functions and everything below them are calculated during aggregation (GROUP BY).
These expressions work as if they are applied to separate rows in the result.</p>
<h4 id="distinct-clause">DISTINCT clause</h4>
<p>If DISTINCT is specified, only a single row will remain out of all the sets of fully matching rows in the result.
The result will be the same as if GROUP BY were specified across all the fields specified in SELECT without aggregate functions. But there are several differences from GROUP BY:</p>
<ul>
<li>DISTINCT can be applied together with GROUP BY.</li>
<li>When ORDER BY is omitted and LIMIT is defined, the query stops running immediately after the required number of different rows has been read.</li>
<li>Data blocks are output as they are processed, without waiting for the entire query to finish running.</li>
</ul>
<p>DISTINCT is not supported if SELECT has at least one array column.</p>
<h4 id="limit-clause">LIMIT clause</h4>
<p>LIMIT m allows you to select the first 'm' rows from the result.
LIMIT n, m allows you to select the first 'm' rows from the result after skipping the first 'n' rows.</p>
<p>'n' and 'm' must be non-negative integers.</p>
<p>If there isn't an ORDER BY clause that explicitly sorts results, the result may be arbitrary and nondeterministic.</p>
<h4 id="union-all-clause">UNION ALL clause</h4>
<p>You can use UNION ALL to combine any number of queries. Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">CounterID</span><span class="p">,</span> <span class="mi">1</span> <span class="k">AS</span> <span class="k">table</span><span class="p">,</span> <span class="n">toInt64</span><span class="p">(</span><span class="k">count</span><span class="p">())</span> <span class="k">AS</span> <span class="k">c</span>
    <span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">hits</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">CounterID</span>

<span class="k">UNION</span> <span class="k">ALL</span>

<span class="k">SELECT</span> <span class="n">CounterID</span><span class="p">,</span> <span class="mi">2</span> <span class="k">AS</span> <span class="k">table</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">Sign</span><span class="p">)</span> <span class="k">AS</span> <span class="k">c</span>
    <span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">visits</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">CounterID</span>
    <span class="k">HAVING</span> <span class="k">c</span> <span class="o">&gt;</span> <span class="mi">0</span>
</pre></div>


<p>Only UNION ALL is supported. The regular UNION (UNION DISTINCT) is not supported. If you need UNION DISTINCT, you can write SELECT DISTINCT from a subquery containing UNION ALL.</p>
<p>Queries that are parts of UNION ALL can be run simultaneously, and their results can be mixed together.</p>
<p>The structure of results (the number and type of columns) must match for the queries. But the column names can differ. In this case, the column names for the final result will be taken from the first query.</p>
<p>Queries that are parts of UNION ALL can't be enclosed in brackets. ORDER BY and LIMIT are applied to separate queries, not to the final result. If you need to apply a conversion to the final result, you can put all the queries with UNION ALL in a subquery in the FROM clause.</p>
<h4 id="into-outfile-clause">INTO OUTFILE clause</h4>
<p>Add the <code>INTO OUTFILE filename</code> clause (where filename is a string literal) to redirect query output to the specified file.
In contrast to MySQL, the file is created on the client side. The query will fail if a file with the same filename already exists.
This functionality is available in the command-line client and clickhouse-local (a query sent via HTTP interface will fail).</p>
<p>The default output format is TabSeparated (the same as in the command-line client batch mode).</p>
<h4 id="format-clause">FORMAT clause</h4>
<p>Specify 'FORMAT format' to get data in any specified format.
You can use this for convenience, or for creating dumps.
For more information, see the section "Formats".
If the FORMAT clause is omitted, the default format is used, which depends on both the settings and the interface used for accessing the DB. For the HTTP interface and the command-line client in batch mode, the default format is TabSeparated. For the command-line client in interactive mode, the default format is PrettyCompact (it has attractive and compact tables).</p>
<p>When using the command-line client, data is passed to the client in an internal efficient format. The client independently interprets the FORMAT clause of the query and formats the data itself (thus relieving the network and the server from the load).</p>
<h4 id="in-operators">IN operators</h4>
<p>The <code>IN</code>, <code>NOT IN</code>, <code>GLOBAL IN</code>, and <code>GLOBAL NOT IN</code> operators are covered separately, since their functionality is quite rich.</p>
<p>The left side of the operator is either a single column or a tuple.</p>
<p>Examples:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">UserID</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">123</span><span class="p">,</span> <span class="mi">456</span><span class="p">)</span> <span class="k">FROM</span> <span class="p">...</span>
<span class="k">SELECT</span> <span class="p">(</span><span class="n">CounterID</span><span class="p">,</span> <span class="n">UserID</span><span class="p">)</span> <span class="k">IN</span> <span class="p">((</span><span class="mi">34</span><span class="p">,</span> <span class="mi">123</span><span class="p">),</span> <span class="p">(</span><span class="mi">101500</span><span class="p">,</span> <span class="mi">456</span><span class="p">))</span> <span class="k">FROM</span> <span class="p">...</span>
</pre></div>


<p>If the left side is a single column that is in the index, and the right side is a set of constants, the system uses the index for processing the query.</p>
<p>Don't list too many values explicitly (i.e. millions). If a data set is large, put it in a temporary table (for example, see the section "External data for query processing"), then use a subquery.</p>
<p>The right side of the operator can be a set of constant expressions, a set of tuples with constant expressions (shown in the examples above), or the name of a database table or SELECT subquery in brackets.</p>
<p>If the right side of the operator is the name of a table (for example, <code>UserID IN users</code>), this is equivalent to the subquery <code>UserID IN (SELECT * FROM users)</code>. Use this when working with external data that is sent along with the query. For example, the query can be sent together with a set of user IDs loaded to the 'users' temporary table, which should be filtered.</p>
<p>If the right side of the operator is a table name that has the Set engine (a prepared data set that is always in RAM), the data set will not be created over again for each query.</p>
<p>The subquery may specify more than one column for filtering tuples.
Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="p">(</span><span class="n">CounterID</span><span class="p">,</span> <span class="n">UserID</span><span class="p">)</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">CounterID</span><span class="p">,</span> <span class="n">UserID</span> <span class="k">FROM</span> <span class="p">...)</span> <span class="k">FROM</span> <span class="p">...</span>
</pre></div>


<p>The columns to the left and right of the IN operator should have the same type.</p>
<p>The IN operator and subquery may occur in any part of the query, including in aggregate functions and lambda functions.
Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="n">EventDate</span><span class="p">,</span>
    <span class="k">avg</span><span class="p">(</span><span class="n">UserID</span> <span class="k">IN</span>
    <span class="p">(</span>
        <span class="k">SELECT</span> <span class="n">UserID</span>
        <span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">hits</span>
        <span class="k">WHERE</span> <span class="n">EventDate</span> <span class="o">=</span> <span class="n">toDate</span><span class="p">(</span><span class="s1">&#39;2014-03-17&#39;</span><span class="p">)</span>
    <span class="p">))</span> <span class="k">AS</span> <span class="n">ratio</span>
<span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">hits</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">EventDate</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">EventDate</span> <span class="k">ASC</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌──EventDate─┬────ratio─┐
│ 2014-03-17 │        1 │
│ 2014-03-18 │ 0.807696 │
│ 2014-03-19 │ 0.755406 │
│ 2014-03-20 │ 0.723218 │
│ 2014-03-21 │ 0.697021 │
│ 2014-03-22 │ 0.647851 │
│ 2014-03-23 │ 0.648416 │
└────────────┴──────────┘
</pre></div>


<p>For each day after March 17th, count the percentage of pageviews made by users who visited the site on March 17th.
A subquery in the IN clause is always run just one time on a single server. There are no dependent subqueries.</p>
<p><a name="queries-distributed-subrequests"></a></p>
<h5 id="distributed-subqueries">Distributed subqueries</h5>
<p>There are two options for IN-s with subqueries (similar to JOINs): normal <code>IN</code>  / <code>OIN</code>  and <code>IN GLOBAL</code>  / <code>GLOBAL JOIN</code>. They differ in how they are run for distributed query processing.</p>
<div class="admonition attention">

Remember that the algorithms described below may work differently depending on the [settings](#settings-distributed_product_mode) `distributed_product_mode` setting.

</div>

<p>When using the regular IN, the query is sent to remote servers, and each of them runs the subqueries in the <code>IN</code> or <code>JOIN</code> clause.</p>
<p>When using <code>GLOBAL IN</code>  / <code>GLOBAL JOINs</code>, first all the subqueries are run for <code>GLOBAL IN</code>  / <code>GLOBAL JOINs</code>, and the results are collected in temporary tables. Then the temporary tables are sent to each remote server, where the queries are run using this temporary data.</p>
<p>For a non-distributed query, use the regular <code>IN</code> / <code>JOIN</code>.</p>
<p>Be careful when using subqueries in the  <code>IN</code> / <code>JOIN</code> clauses for distributed query processing.</p>
<p>Let's look at some examples. Assume that each server in the cluster has a normal <strong>local_table</strong>. Each server also has a <strong>distributed_table</strong> table with the <strong>Distributed</strong> type, which looks at all the servers in the cluster.</p>
<p>For a query to the <strong>distributed_table</strong>, the query will be sent to all the remote servers and run on them using the <strong>local_table</strong>.</p>
<p>For example, the query</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">uniq</span><span class="p">(</span><span class="n">UserID</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">distributed_table</span>
</pre></div>


<p>will be sent to all remote servers as</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">uniq</span><span class="p">(</span><span class="n">UserID</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">local_table</span>
</pre></div>


<p>and run on each of them in parallel, until it reaches the stage where intermediate results can be combined. Then the intermediate results will be returned to the requestor server and merged on it, and the final result will be sent to the client.</p>
<p>Now let's examine a query with IN:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">uniq</span><span class="p">(</span><span class="n">UserID</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">distributed_table</span> <span class="k">WHERE</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">101500</span> <span class="k">AND</span> <span class="n">UserID</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">UserID</span> <span class="k">FROM</span> <span class="n">local_table</span> <span class="k">WHERE</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">34</span><span class="p">)</span>
</pre></div>


<ul>
<li>Calculation of the intersection of audiences of two sites.</li>
</ul>
<p>This query will be sent to all remote servers as</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">uniq</span><span class="p">(</span><span class="n">UserID</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">local_table</span> <span class="k">WHERE</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">101500</span> <span class="k">AND</span> <span class="n">UserID</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">UserID</span> <span class="k">FROM</span> <span class="n">local_table</span> <span class="k">WHERE</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">34</span><span class="p">)</span>
</pre></div>


<p>In other words, the data set in the IN clause will be collected on each server independently, only across the data that is stored locally on each of the servers.</p>
<p>This will work correctly and optimally if you are prepared for this case and have spread data across the cluster servers such that the data for a single UserID resides entirely on a single server. In this case, all the necessary data will be available locally on each server. Otherwise, the result will be inaccurate. We refer to this variation of the query as "local IN".</p>
<p>To correct how the query works when data is spread randomly across the cluster servers, you could specify <strong>distributed_table</strong> inside a subquery. The query would look like this:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">uniq</span><span class="p">(</span><span class="n">UserID</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">distributed_table</span> <span class="k">WHERE</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">101500</span> <span class="k">AND</span> <span class="n">UserID</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">UserID</span> <span class="k">FROM</span> <span class="n">distributed_table</span> <span class="k">WHERE</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">34</span><span class="p">)</span>
</pre></div>


<p>This query will be sent to all remote servers as</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">uniq</span><span class="p">(</span><span class="n">UserID</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">local_table</span> <span class="k">WHERE</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">101500</span> <span class="k">AND</span> <span class="n">UserID</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">UserID</span> <span class="k">FROM</span> <span class="n">distributed_table</span> <span class="k">WHERE</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">34</span><span class="p">)</span>
</pre></div>


<p>The subquery will begin running on each remote server. Since the subquery uses a distributed table, the subquery that is on each remote server will be resent to every remote server as</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">UserID</span> <span class="k">FROM</span> <span class="n">local_table</span> <span class="k">WHERE</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">34</span>
</pre></div>


<p>For example, if you have a cluster of 100 servers, executing the entire query will require 10,000 elementary requests, which is generally considered unacceptable.</p>
<p>In such cases, you should always use GLOBAL IN instead of IN. Let's look at how it works for the query</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">uniq</span><span class="p">(</span><span class="n">UserID</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">distributed_table</span> <span class="k">WHERE</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">101500</span> <span class="k">AND</span> <span class="n">UserID</span> <span class="k">GLOBAL</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">UserID</span> <span class="k">FROM</span> <span class="n">distributed_table</span> <span class="k">WHERE</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">34</span><span class="p">)</span>
</pre></div>


<p>The requestor server will run the subquery</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">UserID</span> <span class="k">FROM</span> <span class="n">distributed_table</span> <span class="k">WHERE</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">34</span>
</pre></div>


<p>and the result will be put in a temporary table in RAM. Then the request will be sent to each remote server as</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">uniq</span><span class="p">(</span><span class="n">UserID</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">local_table</span> <span class="k">WHERE</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">101500</span> <span class="k">AND</span> <span class="n">UserID</span> <span class="k">GLOBAL</span> <span class="k">IN</span> <span class="n">_data1</span>
</pre></div>


<p>and the temporary table <code>_data1</code> will be sent to every remote server with the query (the name of the temporary table is implementation-defined).</p>
<p>This is more optimal than using the normal IN. However, keep the following points in mind:</p>
<ol>
<li>When creating a temporary table, data is not made unique. To reduce the volume of data transmitted over the network, specify DISTINCT in the subquery. (You don't need to do this for a normal IN.)</li>
<li>The temporary table will be sent to all the remote servers. Transmission does not account for network topology. For example, if 10 remote servers reside in a datacenter that is very remote in relation to the requestor server, the data will be sent 10 times over the channel to the remote datacenter. Try to avoid large data sets when using GLOBAL IN.</li>
<li>When transmitting data to remote servers, restrictions on network bandwidth are not configurable. You might overload the network.</li>
<li>Try to distribute data across servers so that you don't need to use GLOBAL IN on a regular basis.</li>
<li>If you need to use GLOBAL IN often, plan the location of the ClickHouse cluster so that a single group of replicas resides in no more than one data center with a fast network between them, so that a query can be processed entirely within a single data center.</li>
</ol>
<p>It also makes sense to specify a local table in the <code>GLOBAL IN</code> clause, in case this local table is only available on the requestor server and you want to use data from it on remote servers.</p>
<h4 id="extreme-values">Extreme values</h4>
<p>In addition to results, you can also get minimum and maximum values for the results columns. To do this, set the <strong>extremes</strong> setting to 1. Minimums and maximums are calculated for numeric types, dates, and dates with times. For other columns, the default values are output.</p>
<p>An extra two rows are calculated – the minimums and maximums, respectively. These extra two rows are output in JSON*, TabSeparated*, and Pretty* formats, separate from the other rows. They are not output for other formats.</p>
<p>In JSON* formats, the extreme values are output in a separate 'extremes' field. In TabSeparated* formats, the row comes after the main result, and after 'totals' if present. It is preceded by an empty row (after the other data). In Pretty* formats, the row is output as a separate table after the main result, and after 'totals' if present.</p>
<p>Extreme values are calculated for rows that have passed through LIMIT. However, when using 'LIMIT offset, size', the rows before 'offset' are included in 'extremes'. In stream requests, the result may also include a small number of rows that passed through LIMIT.</p>
<h4 id="notes">Notes</h4>
<p>The <code>GROUP BY</code> and <code>ORDER BY</code> clauses do not support positional arguments. This contradicts MySQL, but conforms to standard SQL.
For example, <code>GROUP BY 1, 2</code> will be interpreted as grouping by constants (i.e. aggregation of all rows into one).</p>
<p>You can use synonyms (<code>AS</code> aliases) in any part of a query.</p>
<p>You can put an asterisk in any part of a query instead of an expression. When the query is analyzed, the asterisk is expanded to a list of all table columns (excluding the <code>MATERIALIZED</code> and <code>ALIAS</code> columns). There are only a few cases when using an asterisk is justified:</p>
<ul>
<li>When creating a table dump.</li>
<li>For tables containing just a few columns, such as system tables.</li>
<li>For getting information about what columns are in a table. In this case, set <code>LIMIT 1</code>. But it is better to use the <code>DESC TABLE</code> query.</li>
<li>When there is strong filtration on a small number of columns using <code>PREWHERE</code>.</li>
<li>In subqueries (since columns that aren't needed for the external query are excluded from subqueries).</li>
</ul>
<p>In all other cases, we don't recommend using the asterisk, since it only gives you the drawbacks of a columnar DBMS instead of the advantages. In other words using the asterisk is not recommended.</p>
<h3 id="kill-query">KILL QUERY</h3>
<div class="codehilite"><pre><span></span><span class="n">KILL</span> <span class="n">QUERY</span>
  <span class="k">WHERE</span> <span class="o">&lt;</span><span class="k">where</span> <span class="n">expression</span> <span class="k">to</span> <span class="k">SELECT</span> <span class="k">FROM</span> <span class="k">system</span><span class="p">.</span><span class="n">processes</span> <span class="n">query</span><span class="o">&gt;</span>
  <span class="p">[</span><span class="n">SYNC</span><span class="o">|</span><span class="n">ASYNC</span><span class="o">|</span><span class="n">TEST</span><span class="p">]</span>
  <span class="p">[</span><span class="n">FORMAT</span> <span class="n">format</span><span class="p">]</span>
</pre></div>


<p>Attempts to forcibly terminate the currently running queries.
The queries to terminate are selected from the system.processes table using the criteria defined in the <code>WHERE</code> clause of the <code>KILL</code> query.</p>
<p>Examples:</p>
<div class="codehilite"><pre><span></span><span class="c1">-- Forcibly terminates all queries with the specified query_id:</span>
<span class="n">KILL</span> <span class="n">QUERY</span> <span class="k">WHERE</span> <span class="n">query_id</span><span class="o">=</span><span class="s1">&#39;2-857d-4a57-9ee0-327da5d60a90&#39;</span>

<span class="c1">-- Synchronously terminates all queries run by &#39;username&#39;:</span>
<span class="n">KILL</span> <span class="n">QUERY</span> <span class="k">WHERE</span> <span class="k">user</span><span class="o">=</span><span class="s1">&#39;username&#39;</span> <span class="n">SYNC</span>
</pre></div>


<p>Read-only users can only stop their own queries.</p>
<p>By default, the asynchronous version of queries is used (<code>ASYNC</code>), which doesn't wait for confirmation that queries have stopped.</p>
<p>The synchronous version (<code>SYNC</code>) waits for all queries to stop and displays information about each process as it stops.
The response contains the <code>kill_status</code> column, which can take the following values:</p>
<ol>
<li>'finished' – The query was terminated successfully.</li>
<li>'waiting' – Waiting for the query to end after sending it a signal to terminate.</li>
<li>The other values ​​explain why the query can't be stopped.</li>
</ol>
<p>A test query (<code>TEST</code>) only checks the user's rights and displays a list of queries to stop.</p>
<h2 id="syntax">Syntax</h2>
<p>There are two types of parsers in the system: the full SQL parser (a recursive descent parser), and the data format parser (a fast stream parser).
In all cases except the INSERT query, only the full SQL parser is used.
The INSERT query uses both parsers:</p>
<div class="codehilite"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">t</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Hello, world&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;abc&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;def&#39;</span><span class="p">)</span>
</pre></div>


<p>The <code>INSERT INTO t VALUES</code> fragment is parsed by the full parser, and the data <code>(1, 'Hello, world'), (2, 'abc'), (3, 'def')</code> is parsed by the fast stream parser.
Data can have any format. When a query is received, the server calculates no more than <code>max_query_size</code> bytes of the request in RAM (by default, 1 MB), and the rest is stream parsed.
This means the system doesn't have problems with large INSERT queries, like MySQL does.</p>
<p>When using the Values format in an INSERT query, it may seem that data is parsed the same as expressions in a SELECT query, but this is not true. The Values format is much more limited.</p>
<p>Next we will cover the full parser. For more information about format parsers, see the section "Formats".</p>
<h3 id="spaces">Spaces</h3>
<p>There may be any number of space symbols between syntactical constructions (including the beginning and end of a query). Space symbols include the space, tab, line feed, CR, and form feed.</p>
<h3 id="comments">Comments</h3>
<p>SQL-style and C-style comments are supported.
SQL-style comments: from <code>--</code> to the end of the line. The space after <code>--</code> can be omitted.
Comments in C-style: from <code>/*</code>  to <code>*/</code>. These comments can be multiline. Spaces are not required here, either.</p>
<h3 id="keywords">Keywords</h3>
<p>Keywords (such as <code>SELECT</code>) are not case-sensitive. Everything else (column names, functions, and so on), in contrast to standard SQL, is case-sensitive. Keywords are not reserved (they are just parsed as keywords in the corresponding context).</p>
<h3 id="identifiers">Identifiers</h3>
<p>Identifiers (column names, functions, and data types) can be quoted or non-quoted.
Non-quoted identifiers start with a Latin letter or underscore, and continue with a Latin letter, underscore, or number. In other words, they must match the regex <code>^[a-zA-Z_][0-9a-zA-Z_]*$</code>. Examples: <code>x, _1, X_y__Z123_.</code></p>
<p>Quoted identifiers are placed in reversed quotation marks <code>`id`</code> (the same as in MySQL), and can indicate any set of bytes (non-empty). In addition, symbols (for example, the reverse quotation mark) inside this type of identifier can be backslash-escaped. Escaping rules are the same as for string literals (see below).
We recommend using identifiers that do not need to be quoted.</p>
<h3 id="literals">Literals</h3>
<p>There are numeric literals, string literals, and compound literals.</p>
<h4 id="numeric-literals">Numeric literals</h4>
<p>A numeric literal tries to be parsed:</p>
<ul>
<li>First as a 64-bit signed number, using the 'strtoull' function.</li>
<li>If unsuccessful, as a 64-bit unsigned number, using the 'strtoll' function.</li>
<li>If unsuccessful, as a floating-point number using the 'strtod' function.</li>
<li>Otherwise, an error is returned.</li>
</ul>
<p>The corresponding value will have the smallest type that the value fits in.
For example, 1 is parsed as UInt8, but 256 is parsed as UInt16. For more information, see "Data types".</p>
<p>Examples: <code>1</code>, <code>18446744073709551615</code>, <code>0xDEADBEEF</code>, <code>01</code>, <code>0.1</code>, <code>1e100</code>, <code>-1e-100</code>, <code>inf</code>, <code>nan</code>.</p>
<h4 id="string-literals">String literals</h4>
<p>Only string literals in single quotes are supported. The enclosed characters can be backslash-escaped. The following escape sequences have a corresponding special value: <code>\b</code>, <code>\f</code>, <code>\r</code>, <code>\n</code>, <code>\t</code>, <code>\0</code>, <code>\a</code>, <code>\v</code>, <code>\xHH</code>. In all other cases, escape sequences in the format <code>\c</code>, where "c" is any character, are converted to "c". This means that you can use the sequences <code>\'</code>and<code>\\</code>. The value will have the String type.</p>
<p>The minimum set of characters that you need to escape in string literals: <code>'</code> and <code>\</code>.</p>
<h4 id="compound-literals">Compound literals</h4>
<p>Constructions are supported for arrays: <code>[1, 2, 3]</code> and tuples: <code>(1, 'Hello, world!', 2)</code>..
Actually, these are not literals, but expressions with the array creation operator and the tuple creation operator, respectively.
For more information, see the section "Operators2".
An array must consist of at least one item, and a tuple must have at least two items.
Tuples have a special purpose for use in the IN clause of a SELECT query. Tuples can be obtained as the result of a query, but they can't be saved to a database (with the exception of Memory-type tables).</p>
<h3 id="functions">Functions</h3>
<p>Functions are written like an identifier with a list of arguments (possibly empty) in brackets. In contrast to standard SQL, the brackets are required, even for an empty arguments list. Example: <code>now()</code>.
There are regular and aggregate functions (see the section "Aggregate functions"). Some aggregate functions can contain two lists of arguments in brackets. Example: <code>quantile (0.9) (x)</code>. These aggregate functions are called "parametric" functions, and the arguments in the first list are called "parameters". The syntax of aggregate functions without parameters is the same as for regular functions.</p>
<h3 id="operators">Operators</h3>
<p>Operators are converted to their corresponding functions during query parsing, taking their priority and associativity into account.
For example, the expression <code>1 + 2 * 3 + 4</code> is transformed to <code>plus(plus(1, multiply(2, 3)), 4)</code>.
For more information, see the section "Operators" below.</p>
<h3 id="data-types-and-database-table-engines">Data types and database table engines</h3>
<p>Data types and table engines in the <code>CREATE</code> query are written the same way as identifiers or functions. In other words, they may or may not contain an arguments list in brackets. For more information, see the sections "Data types," "Table engines," and "CREATE".</p>
<h3 id="synonyms">Synonyms</h3>
<p>In the SELECT query, expressions can specify synonyms using the AS keyword. Any expression is placed to the left of AS. The identifier name for the synonym is placed to the right of AS. As opposed to standard SQL, synonyms are not only declared on the top level of expressions:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="p">(</span><span class="mi">1</span> <span class="k">AS</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span>
</pre></div>


<p>In contrast to standard SQL, synonyms can be used in all parts of a query, not just <code>SELECT</code>.</p>
<h3 id="asterisk">Asterisk</h3>
<p>In a <code>SELECT</code> query, an asterisk can replace the expression. For more information, see the section "SELECT".</p>
<h3 id="expressions">Expressions</h3>
<p>An expression is a function, identifier, literal, application of an operator, expression in brackets, subquery, or asterisk. It can also contain a synonym.
A list of expressions is one or more expressions separated by commas.
Functions and operators, in turn, can have expressions as arguments.</p>
<h2 id="table-engines">Table engines</h2>
<p>The table engine (type of table) determines:</p>
<ul>
<li>How and where data is stored: where to write it to, and where to read it from.</li>
<li>Which queries are supported, and how.</li>
<li>Concurrent data access.</li>
<li>Use of indexes, if present.</li>
<li>Whether multithreaded request execution is possible.</li>
<li>Data replication.</li>
</ul>
<p>When reading data, the engine is only required to extract the necessary set of columns. However, in some cases, the query may be partially processed inside the table engine.</p>
<p>Note that for most serious tasks, you should use engines from the <code>MergeTree</code> family.</p>
<h2 id="tinylog">TinyLog</h2>
<p>The simplest table engine, which stores data on a disk.
Each column is stored in a separate compressed file.
When writing, data is appended to the end of files.</p>
<p>Concurrent data access is not restricted in any way:</p>
<ul>
<li>If you are simultaneously reading from a table and writing to it in a different query, the read operation will complete with an error.</li>
<li>If you are writing to a table in multiple queries simultaneously, the data will be broken.</li>
</ul>
<p>The typical way to use this table is write-once: first just write the data one time, then read it as many times as needed.
Queries are executed in a single stream. In other words, this engine is intended for relatively small tables (recommended up to 1,000,000 rows).
It makes sense to use this table engine if you have many small tables, since it is simpler than the Log engine (fewer files need to be opened).
The situation when you have a large number of small tables guarantees poor productivity, but may already be used when working with another DBMS, and you may find it easier to switch to using TinyLog types of tables.
<strong>Indexes are not supported.</strong></p>
<p>In Yandex.Metrica, TinyLog tables are used for intermediary data that is processed in small batches.</p>
<h2 id="log">Log</h2>
<p>Log differs from TinyLog in that a small file of "marks" resides with the column files. These marks are written on every data block and contain offsets that indicate where to start reading the file in order to skip the specified number of rows. This makes it possible to read table data in multiple threads.
For concurrent data access, the read operations can be performed simultaneously, while write operations block reads and each other.
The Log engine does not support indexes. Similarly, if writing to a table failed, the table is broken, and reading from it returns an error. The Log engine is appropriate for temporary data, write-once tables, and for testing or demonstration purposes.</p>
<h2 id="memory">Memory</h2>
<p>The Memory engine stores data in RAM, in uncompressed form. Data is stored in exactly the same form as it is received when read. In other words, reading from this table is completely free.
Concurrent data access is synchronized. Locks are short: read and write operations don't block each other.
Indexes are not supported. Reading is parallelized.
Maximal productivity (over 10 GB/sec) is reached on simple queries, because there is no reading from the disk, decompressing, or deserializing data. (We should note that in many cases, the productivity of the MergeTree engine is almost as high.)
When restarting a server, data disappears from the table and the table becomes empty.
Normally, using this table engine is not justified. However, it can be used for tests, and for tasks where maximum speed is required on a relatively small number of rows (up to approximately 100,000,000).</p>
<p>The Memory engine is used by the system for temporary tables with external query data (see the section "External data for processing a query"), and for implementing GLOBAL IN (see the section "IN operators").</p>
<p><a name="table_engines-mergetree"></a></p>
<h2 id="mergetree">MergeTree</h2>
<p>The MergeTree engine supports an index by primary key and by date, and provides the possibility to update data in real time.
This is the most advanced table engine in ClickHouse. Don't confuse it with the Merge engine.</p>
<p>The engine accepts parameters: the name of a Date type column containing the date, a sampling expression (optional), a tuple that defines the table's primary key, and the index granularity.</p>
<p>Example without sampling support.</p>
<div class="codehilite"><pre><span></span>MergeTree(EventDate, (CounterID, EventDate), 8192)
</pre></div>


<p>Example with sampling support.</p>
<div class="codehilite"><pre><span></span>MergeTree(EventDate, intHash32(UserID), (CounterID, EventDate, intHash32(UserID)), 8192)
</pre></div>


<p>A MergeTree table must have a separate column containing the date. Here, it is the EventDate column. The date column must have the 'Date' type (not 'DateTime').</p>
<p>The primary key may be a tuple from any expressions (usually this is just a tuple of columns), or a single expression.</p>
<p>The sampling expression (optional) can be any expression. It must also be present in the primary key. The example uses a hash of user IDs to pseudo-randomly disperse data in the table for each CounterID and EventDate. In other words, when using the SAMPLE clause in a query, you get an evenly pseudo-random sample of data for a subset of users.</p>
<p>The table is implemented as a set of parts. Each part is sorted by the primary key. In addition, each part has the minimum and maximum date assigned. When inserting in the table, a new sorted part is created. The merge process is periodically initiated in the background. When merging, several parts are selected (usually the smallest ones) and then merged into one large sorted part.</p>
<p>In other words, incremental sorting occurs when inserting to the table. Merging is implemented so that the table always consists of a small number of sorted parts, and the merge itself doesn't do too much work.</p>
<p>During insertion, data belonging to different months is separated into different parts. The parts that correspond to different months are never combined. The purpose of this is to provide local data modification (for ease in backups).</p>
<p>Parts are combined up to a certain size threshold, so there aren't any merges that are too long.</p>
<p>For each part, an index file is also written. The index file contains the primary key value for every 'index_granularity' row in the table. In other words, this is an abbreviated index of sorted data.</p>
<p>For columns, "marks" are also written to each 'index_granularity' row so that data can be read in a specific range.</p>
<p>When reading from a table, the SELECT query is analyzed for whether indexes can be used.
An index can be used if the WHERE or PREWHERE clause has an expression (as one of the conjunction elements, or entirely) that represents an equality or inequality comparison operation, or if it has IN or LIKE with a fixed prefix on columns or expressions that are in the primary key or partitioning key, or on certain partially repetitive functions of these columns, or logical relationships of these expressions.</p>
<p>Thus, it is possible to quickly run queries on one or many ranges of the primary key. In this example, queries will be fast when run for a specific tracking tag; for a specific tag and date range; for a specific tag and date; for multiple tags with a date range, and so on.</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="k">count</span><span class="p">()</span> <span class="k">FROM</span> <span class="k">table</span> <span class="k">WHERE</span> <span class="n">EventDate</span> <span class="o">=</span> <span class="n">toDate</span><span class="p">(</span><span class="n">now</span><span class="p">())</span> <span class="k">AND</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">34</span>
<span class="k">SELECT</span> <span class="k">count</span><span class="p">()</span> <span class="k">FROM</span> <span class="k">table</span> <span class="k">WHERE</span> <span class="n">EventDate</span> <span class="o">=</span> <span class="n">toDate</span><span class="p">(</span><span class="n">now</span><span class="p">())</span> <span class="k">AND</span> <span class="p">(</span><span class="n">CounterID</span> <span class="o">=</span> <span class="mi">34</span> <span class="k">OR</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="k">count</span><span class="p">()</span> <span class="k">FROM</span> <span class="k">table</span> <span class="k">WHERE</span> <span class="p">((</span><span class="n">EventDate</span> <span class="o">&gt;=</span> <span class="n">toDate</span><span class="p">(</span><span class="s1">&#39;2014-01-01&#39;</span><span class="p">)</span> <span class="k">AND</span> <span class="n">EventDate</span> <span class="o">&lt;=</span> <span class="n">toDate</span><span class="p">(</span><span class="s1">&#39;2014-01-31&#39;</span><span class="p">))</span> <span class="k">OR</span> <span class="n">EventDate</span> <span class="o">=</span> <span class="n">toDate</span><span class="p">(</span><span class="s1">&#39;2014-05-01&#39;</span><span class="p">))</span> <span class="k">AND</span> <span class="n">CounterID</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">101500</span><span class="p">,</span> <span class="mi">731962</span><span class="p">,</span> <span class="mi">160656</span><span class="p">)</span> <span class="k">AND</span> <span class="p">(</span><span class="n">CounterID</span> <span class="o">=</span> <span class="mi">101500</span> <span class="k">OR</span> <span class="n">EventDate</span> <span class="o">!=</span> <span class="n">toDate</span><span class="p">(</span><span class="s1">&#39;2014-05-01&#39;</span><span class="p">))</span>
</pre></div>


<p>All of these cases will use the index by date and by primary key. The index is used even for complex expressions. Reading from the table is organized so that using the index can't be slower than a full scan.</p>
<p>In this example, the index can't be used.</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="k">count</span><span class="p">()</span> <span class="k">FROM</span> <span class="k">table</span> <span class="k">WHERE</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">34</span> <span class="k">OR</span> <span class="n">URL</span> <span class="k">LIKE</span> <span class="s1">&#39;%upyachka%&#39;</span>
</pre></div>


<p>To check whether ClickHouse can use the index when executing the query, use the settings  <a href="#settings-settings-force_index_by_date">force_index_by_date</a>and<a href="#settings-settings-force_primary_key">force_primary_key</a>.</p>
<p>The index by date only allows reading those parts that contain dates from the desired range. However, a data part may contain data for many dates (up to an entire month), while within a single part the data is ordered by the primary key, which might not contain the date as the first column. Because of this, using a query with only a date condition that does not specify the primary key prefix will cause more data to be read than for a single date.</p>
<p>For concurrent table access, we use multi-versioning. In other words, when a table is simultaneously read and updated, data is read from a set of parts that is current at the time of the query. There are no lengthy locks. Inserts do not get in the way of read operations.</p>
<p>Reading from a table is automatically parallelized.</p>
<p>The <code>OPTIMIZE</code> query is supported, which calls an extra merge step.</p>
<p>You can use a single large table and continually add data to it in small chunks – this is what MergeTree is intended for.</p>
<p>Data replication is possible for all types of tables in the MergeTree family (see the section "Data replication").</p>
<p><a name="table_engines-custom_partitioning_key"></a></p>
<h2 id="custom-partitioning-key">Custom partitioning key</h2>
<p>Starting with version 1.1.54310, you can create tables in the MergeTree family with any partitioning expression (not only partitioning by month).</p>
<p>The partition key can be an expression from the table columns, or a tuple of such expressions (similar to the primary key). The partition key can be omitted. When creating a table, specify the partition key in the ENGINE description with the new syntax:</p>
<div class="codehilite"><pre><span></span>ENGINE [=] Name(...) [PARTITION BY expr] [ORDER BY expr] [SAMPLE BY expr] [SETTINGS name=value, ...]
</pre></div>


<p>For MergeTree tables, the partition expression is specified after <code>PARTITION BY</code>, the primary key after <code>ORDER BY</code>, the sampling key after <code>SAMPLE BY</code>, and <code>SETTINGS</code> can specify <code>index_granularity</code> (optional; the default value is 8192), as well as other settings from <a href="https://github.com/yandex/ClickHouse/blob/master/dbms/src/Storages/MergeTree/MergeTreeSettings.h">MergeTreeSettings.h</a>. The other engine parameters are specified in parentheses after the engine name, as previously. Example:</p>
<div class="codehilite"><pre><span></span><span class="n">ENGINE</span> <span class="o">=</span> <span class="n">ReplicatedCollapsingMergeTree</span><span class="p">(</span><span class="s1">&#39;/clickhouse/tables/name&#39;</span><span class="p">,</span> <span class="s1">&#39;replica1&#39;</span><span class="p">,</span> <span class="n">Sign</span><span class="p">)</span>
    <span class="n">PARTITION</span> <span class="k">BY</span> <span class="p">(</span><span class="n">toMonday</span><span class="p">(</span><span class="n">StartDate</span><span class="p">),</span> <span class="n">EventType</span><span class="p">)</span>
    <span class="k">ORDER</span> <span class="k">BY</span> <span class="p">(</span><span class="n">CounterID</span><span class="p">,</span> <span class="n">StartDate</span><span class="p">,</span> <span class="n">intHash32</span><span class="p">(</span><span class="n">UserID</span><span class="p">))</span>
    <span class="n">SAMPLE</span> <span class="k">BY</span> <span class="n">intHash32</span><span class="p">(</span><span class="n">UserID</span><span class="p">)</span>
</pre></div>


<p>The traditional partitioning by month is expressed as <code>toYYYYMM(date_column)</code>.</p>
<p>You can't convert an old-style table to a table with custom partitions (only via INSERT SELECT).</p>
<p>After this table is created, merge will only work for data parts that have the same value for the partitioning expression. Note: This means that you shouldn't make overly granular partitions (more than about a thousand partitions), or SELECT will perform poorly.</p>
<p>To specify a partition in ALTER PARTITION commands, specify the value of the partition expression (or a tuple). Constants and constant expressions are supported. Example:</p>
<div class="codehilite"><pre><span></span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="k">table</span> <span class="k">DROP</span> <span class="n">PARTITION</span> <span class="p">(</span><span class="n">toMonday</span><span class="p">(</span><span class="n">today</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>


<p>Deletes the partition for the current week with event type 1. The same is true for the OPTIMIZE query. To specify the only partition in a non-partitioned table, specify <code>PARTITION tuple()</code>.</p>
<p>Note: For old-style tables, the partition can be specified either as a number <code>201710</code> or a string <code>'201710'</code>. The syntax for the new style of tables is stricter with types (similar to the parser for the VALUES input format). In addition, ALTER TABLE FREEZE PARTITION uses exact match for new-style tables (not prefix match).</p>
<p>In the <code>system.parts</code> table, the <code>partition</code> column specifies the value of the partition expression to use in ALTER queries (if quotas are removed). The <code>name</code> column should specify the name of the data part that has a new format.</p>
<p>Was: <code>20140317_20140323_2_2_0</code> (minimum date - maximum date - minimum block number - maximum block number - level).</p>
<p>Now: <code>201403_2_2_0</code>  (partition ID -  minimum block number - maximum block number - level).</p>
<p>The partition ID is its string identifier (human-readable, if possible) that is used for the names of data parts in the file system and in ZooKeeper. You can specify it in ALTER queries in place of the partition key. Example: Partition key <code>toYYYYMM(EventDate)</code>; ALTER can specify either <code>PARTITION 201710</code> or <code>PARTITION ID '201710'</code>.</p>
<p>For more examples, see the tests <a href="https://github.com/yandex/ClickHouse/blob/master/dbms/tests/queries/0_stateless/00502_custom_partitioning_local.sql"><code>00502_custom_partitioning_local</code></a> and <a href="https://github.com/yandex/ClickHouse/blob/master/dbms/tests/queries/0_stateless/00502_custom_partitioning_replicated_zookeeper.sql"><code>00502_custom_partitioning_replicated_zookeeper</code></a>.</p>
<h2 id="replacingmergetree">ReplacingMergeTree</h2>
<p>This engine table differs from <code>MergeTree</code> in that it removes duplicate entries with the same primary key value.</p>
<p>The last optional parameter for the table engine is the version column. When merging, it reduces all rows with the same primary key value to just one row. If the version column is specified, it leaves the row with the highest version; otherwise, it leaves the last row.</p>
<p>The version column must have a type from the <code>UInt</code> family, <code>Date</code>, or <code>DateTime</code>.</p>
<div class="codehilite"><pre><span></span><span class="n">ReplacingMergeTree</span><span class="p">(</span><span class="n">EventDate</span><span class="p">,</span> <span class="p">(</span><span class="n">OrderID</span><span class="p">,</span> <span class="n">EventDate</span><span class="p">,</span> <span class="n">BannerID</span><span class="p">,</span> <span class="p">...),</span> <span class="mi">8192</span><span class="p">,</span> <span class="n">ver</span><span class="p">)</span>
</pre></div>


<p>Note that data is only deduplicated during merges. Merging occurs in the background at an unknown time, so you can't plan for it. Some of the data may remain unprocessed. Although you can run an unscheduled merge using the OPTIMIZE query, don't count on using it, because the OPTIMIZE query will read and write a large amount of data.</p>
<p>Thus, <code>ReplacingMergeTree</code> is suitable for clearing out duplicate data  in the background in order to save space, but it doesn't guarantee the absence of duplicates.</p>
<p><em>This engine is not used in Yandex.Metrica, but it has been applied in other Yandex projects.</em></p>
<h2 id="summingmergetree">SummingMergeTree</h2>
<p>This engine differs from <code>MergeTree</code> in that it totals data while merging.</p>
<div class="codehilite"><pre><span></span><span class="n">SummingMergeTree</span><span class="p">(</span><span class="n">EventDate</span><span class="p">,</span> <span class="p">(</span><span class="n">OrderID</span><span class="p">,</span> <span class="n">EventDate</span><span class="p">,</span> <span class="n">BannerID</span><span class="p">,</span> <span class="p">...),</span> <span class="mi">8192</span><span class="p">)</span>
</pre></div>


<p>The columns to total are implicit. When merging, all rows with the same primary key value (in the example, OrderId, EventDate, BannerID, ...) have their values totaled in numeric columns that are not part of the primary key.</p>
<div class="codehilite"><pre><span></span><span class="n">SummingMergeTree</span><span class="p">(</span><span class="n">EventDate</span><span class="p">,</span> <span class="p">(</span><span class="n">OrderID</span><span class="p">,</span> <span class="n">EventDate</span><span class="p">,</span> <span class="n">BannerID</span><span class="p">,</span> <span class="p">...),</span> <span class="mi">8192</span><span class="p">,</span> <span class="p">(</span><span class="n">Shows</span><span class="p">,</span> <span class="n">Clicks</span><span class="p">,</span> <span class="n">Cost</span><span class="p">,</span> <span class="p">...))</span>
</pre></div>


<p>The columns to total are set explicitly (the last parameter – Shows, Clicks, Cost, ...). When merging, all rows with the same primary key value have their values totaled in the specified columns. The specified columns also must be numeric and must not be part of the primary key.</p>
<p>If the values were null in all of these columns, the row is deleted. (The exception is cases when the data part would not have any rows left in it.)</p>
<p>For the other rows that are not part of the primary key, the first value that occurs is selected when merging.</p>
<p>Summation is not performed for a read operation. If it is necessary, write the appropriate GROUP BY.</p>
<p>In addition, a table can have nested data structures that are processed in a special way.
If the name of a nested table ends in 'Map' and it contains at least two columns that meet the following criteria:</p>
<ul>
<li>The first table is numeric ((U)IntN, Date, DateTime), which we'll refer to as the 'key'.</li>
<li>The other columns are arithmetic ((U)IntN, Float32/64), which we'll refer to as '(values...)'. Then this nested table is interpreted as a mapping of key =<code>&gt;</code> (values...), and when merging its rows, the elements of two data sets are merged by 'key' with a summation of the corresponding (values...).</li>
</ul>
<p>Examples:</p>
<div class="codehilite"><pre><span></span>[(1, 100)] + [(2, 150)] -&gt; [(1, 100), (2, 150)]
[(1, 100)] + [(1, 150)] -&gt; [(1, 250)]
[(1, 100)] + [(1, 150), (2, 150)] -&gt; [(1, 250), (2, 150)]
[(1, 100), (2, 150)] + [(1, -100)] -&gt; [(2, 150)]
</pre></div>


<p>For aggregation of Map, use the function sumMap(key, value).</p>
<p>For nested data structures, you don't need to specify the columns as a list of columns for totaling.</p>
<p>This table engine is not particularly useful. Remember that when saving just pre-aggregated data, you lose some of the system's advantages.</p>
<h2 id="aggregatingmergetree">AggregatingMergeTree</h2>
<p>This engine differs from <code>MergeTree</code> in that the merge combines the states of aggregate functions stored in the table for rows with the same primary key value.</p>
<p>For this to work, it uses the <code>AggregateFunction</code> data type, as well as <code>-State</code> and <code>-Merge</code> modifiers for aggregate functions. Let's examine it more closely.</p>
<p>There is an <code>AggregateFunction</code> data type. It is a parametric data type. As parameters, the name of the aggregate function is passed, then the types of its arguments.</p>
<p>Examples:</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">t</span>
<span class="p">(</span>
    <span class="n">column1</span> <span class="n">AggregateFunction</span><span class="p">(</span><span class="n">uniq</span><span class="p">,</span> <span class="n">UInt64</span><span class="p">),</span>
    <span class="n">column2</span> <span class="n">AggregateFunction</span><span class="p">(</span><span class="n">anyIf</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">UInt8</span><span class="p">),</span>
    <span class="n">column3</span> <span class="n">AggregateFunction</span><span class="p">(</span><span class="n">quantiles</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">9</span><span class="p">),</span> <span class="n">UInt64</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="p">...</span>
</pre></div>


<p>This type of column stores the state of an aggregate function.</p>
<p>To get this type of value, use aggregate functions with the <code>State</code> suffix.</p>
<p>Example:
<code>uniqState(UserID), quantilesState(0.5, 0.9)(SendTiming)</code></p>
<p>In contrast to the corresponding <code>uniq</code> and <code>quantiles</code> functions, these functions return the state, rather than the prepared value. In other words, they return an <code>AggregateFunction</code> type value.</p>
<p>An <code>AggregateFunction</code> type value can't be output in Pretty formats. In other formats, these types of values are output as implementation-specific binary data. The <code>AggregateFunction</code> type values are not intended for output or saving in a dump.</p>
<p>The only useful thing you can do with <code>AggregateFunction</code> type values is combine the states and get a result, which essentially means to finish aggregation. Aggregate functions with the 'Merge' suffix are used for this purpose.
Example: <code>uniqMerge(UserIDState), where UserIDState has the AggregateFunction</code> type.</p>
<p>In other words, an aggregate function with the 'Merge' suffix takes a set of states, combines them, and returns the result.
As an example, these two queries return the same result:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">uniq</span><span class="p">(</span><span class="n">UserID</span><span class="p">)</span> <span class="k">FROM</span> <span class="k">table</span>

<span class="k">SELECT</span> <span class="n">uniqMerge</span><span class="p">(</span><span class="k">state</span><span class="p">)</span> <span class="k">FROM</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">uniqState</span><span class="p">(</span><span class="n">UserID</span><span class="p">)</span> <span class="k">AS</span> <span class="k">state</span> <span class="k">FROM</span> <span class="k">table</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">RegionID</span><span class="p">)</span>
</pre></div>


<p>There is an <code>AggregatingMergeTree</code> engine. Its job during a merge is to combine the states of aggregate functions from different table rows with the same primary key value.</p>
<p>You can't use a normal INSERT to insert a row in a table containing <code>AggregateFunction</code> columns, because you can't explicitly define the <code>AggregateFunction</code> value. Instead, use <code>INSERT SELECT</code> with <code>-State</code> aggregate functions for inserting data.</p>
<p>With SELECT from an <code>AggregatingMergeTree</code> table, use GROUP BY and aggregate functions with the '-Merge' modifier in order to complete data aggregation.</p>
<p>You can use <code>AggregatingMergeTree</code> tables for incremental data aggregation, including for aggregated materialized views.</p>
<p>Example:</p>
<p>Create an <code>AggregatingMergeTree</code> materialized view that watches the <code>test.visits</code> table:</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="n">MATERIALIZED</span> <span class="k">VIEW</span> <span class="n">test</span><span class="p">.</span><span class="n">basic</span>
<span class="n">ENGINE</span> <span class="o">=</span> <span class="n">AggregatingMergeTree</span><span class="p">(</span><span class="n">StartDate</span><span class="p">,</span> <span class="p">(</span><span class="n">CounterID</span><span class="p">,</span> <span class="n">StartDate</span><span class="p">),</span> <span class="mi">8192</span><span class="p">)</span>
<span class="k">AS</span> <span class="k">SELECT</span>
    <span class="n">CounterID</span><span class="p">,</span>
    <span class="n">StartDate</span><span class="p">,</span>
    <span class="n">sumState</span><span class="p">(</span><span class="n">Sign</span><span class="p">)</span>    <span class="k">AS</span> <span class="n">Visits</span><span class="p">,</span>
    <span class="n">uniqState</span><span class="p">(</span><span class="n">UserID</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Users</span>
<span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">visits</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">CounterID</span><span class="p">,</span> <span class="n">StartDate</span><span class="p">;</span>
</pre></div>


<p>Insert data in the <code>test.visits</code> table. Data will also be inserted in the view, where it will be aggregated:</p>
<div class="codehilite"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">test</span><span class="p">.</span><span class="n">visits</span> <span class="p">...</span>
</pre></div>


<p>Perform <code>SELECT</code> from the view using <code>GROUP BY</code> in order to complete data aggregation:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="n">StartDate</span><span class="p">,</span>
    <span class="n">sumMerge</span><span class="p">(</span><span class="n">Visits</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Visits</span><span class="p">,</span>
    <span class="n">uniqMerge</span><span class="p">(</span><span class="n">Users</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Users</span>
<span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">basic</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">StartDate</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">StartDate</span><span class="p">;</span>
</pre></div>


<p>You can create a materialized view like this and assign a normal view to it that finishes data aggregation.</p>
<p>Note that in most cases, using <code>AggregatingMergeTree</code> is not justified, since queries can be run efficiently enough on non-aggregated data.</p>
<h2 id="collapsingmergetree">CollapsingMergeTree</h2>
<p><em>This engine is used specifically for Yandex.Metrica.</em></p>
<p>It differs from <code>MergeTree</code> in that it allows automatic deletion, or "collapsing" certain pairs of rows when merging.</p>
<p>Yandex.Metrica has normal logs (such as hit logs) and change logs. Change logs are used for incrementally calculating statistics on data that is constantly changing. Examples are the log of session changes, or logs of changes to user histories. Sessions are constantly changing in Yandex.Metrica. For example, the number of hits per session increases. We refer to changes in any object as a pair (?old values, ?new values). Old values may be missing if the object was created. New values may be missing if the object was deleted. If the object was changed, but existed previously and was not deleted, both values are present. In the change log, one or two entries are made for each change. Each entry contains all the attributes that the object has, plus a special attribute for differentiating between the old and new values. When objects change, only the new entries are added to the change log, and the existing ones are not touched.</p>
<p>The change log makes it possible to incrementally calculate almost any statistics. To do this, we need to consider "new" rows with a plus sign, and "old" rows with a minus sign. In other words, incremental calculation is possible for all statistics whose algebraic structure contains an operation for taking the inverse of an element. This is true of most statistics. We can also calculate "idempotent" statistics, such as the number of unique visitors, since the unique visitors are not deleted when making changes to sessions.</p>
<p>This is the main concept that allows Yandex.Metrica to work in real time.</p>
<p>CollapsingMergeTree accepts an additional parameter - the name of an Int8-type column that contains the row's "sign". Example:</p>
<div class="codehilite"><pre><span></span><span class="n">CollapsingMergeTree</span><span class="p">(</span><span class="n">EventDate</span><span class="p">,</span> <span class="p">(</span><span class="n">CounterID</span><span class="p">,</span> <span class="n">EventDate</span><span class="p">,</span> <span class="n">intHash32</span><span class="p">(</span><span class="n">UniqID</span><span class="p">),</span> <span class="n">VisitID</span><span class="p">),</span> <span class="mi">8192</span><span class="p">,</span> <span class="n">Sign</span><span class="p">)</span>
</pre></div>


<p>Here, <code>Sign</code> is a column containing -1 for "old" values and 1 for "new" values.</p>
<p>When merging, each group of consecutive identical primary key values (columns for sorting data) is reduced to no more than one row with the column value 'sign_column = -1' (the "negative row") and no more than one row with the column value 'sign_column = 1' (the "positive row"). In other words, entries from the change log are collapsed.</p>
<p>If the number of positive and negative rows matches, the first negative row and the last positive row are written.
If there is one more positive row than negative rows, only the last positive row is written.
If there is one more negative row than positive rows, only the first negative row is written.
Otherwise, there will be a logical error and none of the rows will be written. (A logical error can occur if the same section of the log was accidentally inserted more than once. The error is just recorded in the server log, and the merge continues.)</p>
<p>Thus, collapsing should not change the results of calculating statistics.
Changes are gradually collapsed so that in the end only the last value of almost every object is left.
Compared to MergeTree, the CollapsingMergeTree engine allows a multifold reduction of data volume.</p>
<p>There are several ways to get completely "collapsed" data from a <code>CollapsingMergeTree</code> table:</p>
<ol>
<li>Write a query with GROUP BY and aggregate functions that accounts for the sign. For example, to calculate quantity, write 'sum(Sign)' instead of 'count()'. To calculate the sum of something, write 'sum(Sign * x)' instead of 'sum(x)', and so on, and also add 'HAVING sum(Sign) <code>&gt;</code> 0'. Not all amounts can be calculated this way. For example, the aggregate functions 'min' and 'max' can't be rewritten.</li>
<li>If you must extract data without aggregation (for example, to check whether rows are present whose newest values match certain conditions), you can use the FINAL modifier for the FROM clause. This approach is significantly less efficient.</li>
</ol>
<p><a name="table_engines-graphitemergetree"></a></p>
<h2 id="graphitemergetree">GraphiteMergeTree</h2>
<p>This engine is designed for rollup (thinning and aggregating/averaging) <a href="http://graphite.readthedocs.io/en/latest/index.html">Graphite</a> data. It may be helpful to developers who want to use ClickHouse as a data store for Graphite.</p>
<p>Graphite stores full data in ClickHouse, and data can be retrieved in the following ways:</p>
<ul>
<li>Without thinning.</li>
</ul>
<p>Uses the <a href="#table_engines-mergetree">MergeTree</a> engine.</p>
<ul>
<li>With thinning.</li>
</ul>
<p>Using the <code>GraphiteMergeTree</code> engine.</p>
<p>The engine inherits properties from MergeTree. The settings for thinning data are defined by the <a href="#server_settings-graphite_rollup">graphite_rollup</a> parameter in the server configuration.</p>
<h3 id="using-the-engine">Using the engine</h3>
<p>The Graphite data table must contain the following fields at minimum:</p>
<ul>
<li><code>Path</code> – The metric name (Graphite sensor).</li>
<li><code>Time</code> – The time for measuring the metric.</li>
<li><code>Value</code> – The value of the metric at the time set in Time.</li>
<li><code>Version</code> – Determines which value of the metric with the same Path and Time will remain in the database.</li>
</ul>
<p>Rollup pattern:</p>
<div class="codehilite"><pre><span></span>pattern
    regexp
    function
    age -&gt; precision
    ...
pattern
    ...
default
    function
       age -&gt; precision
    ...
</pre></div>


<p>When processing a record, ClickHouse will check the rules in the <code>pattern</code>clause. If the metric name matches the <code>regexp</code>, the rules from <code>pattern</code> are applied; otherwise, the rules from <code>default</code> are used.</p>
<p>Fields in the pattern.</p>
<ul>
<li><code>age</code> – The minimum age of the data in seconds.</li>
<li><code>function</code> – The name of the aggregating function to apply to data whose age falls within the range <code>[age, age + precision]</code>.</li>
<li><code>precision</code>– How precisely to define the age of the data in seconds.</li>
<li><code>regexp</code>– A pattern for the metric name.</li>
</ul>
<p>Example of settings:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;graphite_rollup&gt;</span>
    <span class="nt">&lt;pattern&gt;</span>
        <span class="nt">&lt;regexp&gt;</span>click_cost<span class="nt">&lt;/regexp&gt;</span>
        <span class="nt">&lt;function&gt;</span>any<span class="nt">&lt;/function&gt;</span>
        <span class="nt">&lt;retention&gt;</span>
            <span class="nt">&lt;age&gt;</span>0<span class="nt">&lt;/age&gt;</span>
            <span class="nt">&lt;precision&gt;</span>5<span class="nt">&lt;/precision&gt;</span>
        <span class="nt">&lt;/retention&gt;</span>
        <span class="nt">&lt;retention&gt;</span>
            <span class="nt">&lt;age&gt;</span>86400<span class="nt">&lt;/age&gt;</span>
            <span class="nt">&lt;precision&gt;</span>60<span class="nt">&lt;/precision&gt;</span>
        <span class="nt">&lt;/retention&gt;</span>
    <span class="nt">&lt;/pattern&gt;</span>
    <span class="nt">&lt;default&gt;</span>
        <span class="nt">&lt;function&gt;</span>max<span class="nt">&lt;/function&gt;</span>
        <span class="nt">&lt;retention&gt;</span>
            <span class="nt">&lt;age&gt;</span>0<span class="nt">&lt;/age&gt;</span>
            <span class="nt">&lt;precision&gt;</span>60<span class="nt">&lt;/precision&gt;</span>
        <span class="nt">&lt;/retention&gt;</span>
        <span class="nt">&lt;retention&gt;</span>
            <span class="nt">&lt;age&gt;</span>3600<span class="nt">&lt;/age&gt;</span>
            <span class="nt">&lt;precision&gt;</span>300<span class="nt">&lt;/precision&gt;</span>
        <span class="nt">&lt;/retention&gt;</span>
        <span class="nt">&lt;retention&gt;</span>
            <span class="nt">&lt;age&gt;</span>86400<span class="nt">&lt;/age&gt;</span>
            <span class="nt">&lt;precision&gt;</span>3600<span class="nt">&lt;/precision&gt;</span>
        <span class="nt">&lt;/retention&gt;</span>
    <span class="nt">&lt;/default&gt;</span>
<span class="nt">&lt;/graphite_rollup&gt;</span>
</pre></div>


<p><a name="table_engines-replication"></a></p>
<h2 id="data-replication">Data replication</h2>
<p>Replication is only supported for tables in the MergeTree family:</p>
<ul>
<li>ReplicatedMergeTree</li>
<li>ReplicatedSummingMergeTree</li>
<li>ReplicatedReplacingMergeTree</li>
<li>ReplicatedAggregatingMergeTree</li>
<li>ReplicatedCollapsingMergeTree</li>
<li>ReplicatedGraphiteMergeTree</li>
</ul>
<p>Replication works at the level of an individual table, not the entire server. A server can store both replicated and non-replicated tables at the same time.</p>
<p>Replication does not depend on sharding. Each shard has its own independent replication.</p>
<p>Compressed data is replicated for <code>INSERT</code> and <code>ALTER</code> queries (see the description of the <a href="#query_language_queries_alter">ALTER</a> query).</p>
<p><code>CREATE</code>, <code>DROP</code>, <code>ATTACH</code>, <code>DETACH</code> and <code>RENAME</code> queries are executed on a single server and are not replicated:</p>
<ul>
<li><code>The CREATE TABLE</code> query creates a new replicatable table on the server where the query is run. If this table already exists on other servers, it adds a new replica.</li>
<li><code>The DROP TABLE</code> query deletes the replica located on the server where the query is run.</li>
<li><code>The RENAME</code> query renames the table on one of the replicas. In other words, replicated tables can have different names on different replicas.</li>
</ul>
<p>To use replication, set the addresses of the ZooKeeper cluster in the config file. Example:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;zookeeper&gt;</span>
    <span class="nt">&lt;node</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;host&gt;</span>example1<span class="nt">&lt;/host&gt;</span>
        <span class="nt">&lt;port&gt;</span>2181<span class="nt">&lt;/port&gt;</span>
    <span class="nt">&lt;/node&gt;</span>
    <span class="nt">&lt;node</span> <span class="na">index=</span><span class="s">&quot;2&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;host&gt;</span>example2<span class="nt">&lt;/host&gt;</span>
        <span class="nt">&lt;port&gt;</span>2181<span class="nt">&lt;/port&gt;</span>
    <span class="nt">&lt;/node&gt;</span>
    <span class="nt">&lt;node</span> <span class="na">index=</span><span class="s">&quot;3&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;host&gt;</span>example3<span class="nt">&lt;/host&gt;</span>
        <span class="nt">&lt;port&gt;</span>2181<span class="nt">&lt;/port&gt;</span>
    <span class="nt">&lt;/node&gt;</span>
<span class="nt">&lt;/zookeeper&gt;</span>
</pre></div>


<p>Use ZooKeeper version 3.4.5 or later.</p>
<p>You can specify any existing ZooKeeper cluster and the system will use a directory on it for its own data (the directory is specified when creating a replicatable table).</p>
<p>If ZooKeeper isn't set in the config file, you can't create replicated tables, and any existing replicated tables will be read-only.</p>
<p>ZooKeeper is not used in <code>SELECT</code> queries because replication does not affect the performance of <code>SELECT</code> and queries run just as fast as they do for non-replicated tables. When querying distributed replicated tables, ClickHouse behavior is controlled by the settings <a href="#settings_settings_max_replica_delay_for_distributed_queries">max_replica_delay_for_distributed_queries</a> and <a href="#settings-settings-fallback_to_stale_replicas_for_distributed_queries">fallback_to_stale_replicas_for_distributed_queries</a>.</p>
<p>For each <code>INSERT</code> query, approximately ten entries are added to ZooKeeper through several transactions. (To be more precise, this is for each inserted block of data; an INSERT query contains one block or one block per <code>max_insert_block_size = 1048576</code> rows.) This leads to slightly longer latencies for <code>INSERT</code> compared to non-replicated tables. But if you follow the recommendations to insert data in batches of no more than one <code>INSERT</code> per second, it doesn't create any problems. The entire ClickHouse cluster used for coordinating one ZooKeeper cluster has a total of several hundred <code>INSERTs</code> per second. The throughput on data inserts (the number of rows per second) is just as high as for non-replicated data.</p>
<p>For very large clusters, you can use different ZooKeeper clusters for different shards. However, this hasn't proven necessary on the Yandex.Metrica cluster (approximately 300 servers).</p>
<p>Replication is asynchronous and multi-master. <code>INSERT</code> queries (as well as <code>ALTER</code>) can be sent to any available server. Data is inserted on the server where the query is run, and then it is copied to the other servers. Because it is asynchronous, recently inserted data appears on the other replicas with some latency. If part of the replicas are not available, the data is written when they become available. If a replica is available, the latency is the amount of time it takes to transfer the block of compressed data over the network.</p>
<p>By default, an INSERT query waits for confirmation of writing the data from only one replica. If the data was successfully written to only one replica and the server with this replica ceases to exist, the stored data will be lost. Tp enable getting confirmation of data writes from multiple replicas, use the <code>insert_quorum</code> option.</p>
<p>Each block of data is written atomically. The INSERT query is divided into blocks up to <code>max_insert_block_size = 1048576</code> rows. In other words, if the <code>INSERT</code> query has less than 1048576 rows, it is made atomically.</p>
<p>Data blocks are deduplicated. For multiple writes of the same data block (data blocks of the same size containing the same rows in the same order), the block is only written once. The reason for this is in case of network failures when the client application doesn't know if the data was written to the DB, so the <code>INSERT</code> query can simply be repeated. It doesn't matter which replica INSERTs were sent to with identical data. <code>INSERTs</code> are idempotent. Deduplication parameters are controlled by <a href="#server_settings-merge_tree">merge_tree</a> server settings.</p>
<p>During replication, only the source data to insert is transferred over the network. Further data transformation (merging) is coordinated and performed on all the replicas in the same way. This minimizes network usage, which means that replication works well when replicas reside in different datacenters. (Note that duplicating data in different datacenters is the main goal of replication.)</p>
<p>You can have any number of replicas of the same data. Yandex.Metrica uses double replication in production. Each server uses RAID-5 or RAID-6, and RAID-10 in some cases. This is a relatively reliable and convenient solution.</p>
<p>The system monitors data synchronicity on replicas and is able to recover after a failure. Failover is automatic (for small differences in data) or semi-automatic (when data differs too much, which may indicate a configuration error).</p>
<p><a name="table_engines-replication-creation_of_rep_tables"></a></p>
<h3 id="creating-replicated-tables">Creating replicated tables</h3>
<p>The <code>Replicated</code> prefix is added to the table engine name. For example:<code>ReplicatedMergeTree</code>.</p>
<p>Two parameters are also added in the beginning of the parameters list – the path to the table in ZooKeeper, and the replica name in ZooKeeper.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span>ReplicatedMergeTree(&#39;/clickhouse/tables/{layer}-{shard}/hits&#39;, &#39;{replica}&#39;, EventDate, intHash32(UserID), (CounterID, EventDate, intHash32(UserID), EventTime), 8192)
</pre></div>


<p>As the example shows, these parameters can contain substitutions in curly brackets. The substituted values are taken from the 'macros' section of the config file. Example:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;macros&gt;</span>
    <span class="nt">&lt;layer&gt;</span>05<span class="nt">&lt;/layer&gt;</span>
    <span class="nt">&lt;shard&gt;</span>02<span class="nt">&lt;/shard&gt;</span>
    <span class="nt">&lt;replica&gt;</span>example05-02-1.yandex.ru<span class="nt">&lt;/replica&gt;</span>
<span class="nt">&lt;/macros&gt;</span>
</pre></div>


<p>The path to the table in ZooKeeper should be unique for each replicated table. Tables on different shards should have different paths.
In this case, the path consists of the following parts:</p>
<p><code>/clickhouse/tables/</code> is the common prefix. We recommend using exactly this one.</p>
<p><code>{layer}-{shard}</code> is the shard identifier. In this example it consists of two parts, since the Yandex.Metrica cluster uses bi-level sharding. For most tasks, you can leave just the {shard} substitution, which will be expanded to the shard identifier.</p>
<p><code>hits</code> is the name of the node for the table in ZooKeeper. It is a good idea to make it the same as the table name. It is defined explicitly, because in contrast to the table name, it doesn't change after a RENAME query.</p>
<p>The replica name identifies different replicas of the same table. You can use the server name for this, as in the example. The name only needs to be unique within each shard.</p>
<p>You can define the parameters explicitly instead of using substitutions. This might be convenient for testing and for configuring small clusters. However, you can't use distributed DDL queries (<code>ON CLUSTER</code>) in this case.</p>
<p>When working with large clusters, we recommend using substitutions because they reduce the probability of error.</p>
<p>Run the <code>CREATE TABLE</code> query on each replica. This query creates a new replicated table, or adds a new replica to an existing one.</p>
<p>If you add a new replica after the table already contains some data on other replicas, the data will be copied from the other replicas to the new one after running the query. In other words, the new replica syncs itself with the others.</p>
<p>To delete a replica, run <code>DROP TABLE</code>. However, only one replica is deleted – the one that resides on the server where you run the query.</p>
<h3 id="recovery-after-failures">Recovery after failures</h3>
<p>If ZooKeeper is unavailable when a server starts, replicated tables switch to read-only mode. The system periodically attempts to connect to ZooKeeper.</p>
<p>If ZooKeeper is unavailable during an <code>INSERT</code>, or an error occurs when interacting with ZooKeeper, an exception is thrown.</p>
<p>After connecting to ZooKeeper, the system checks whether the set of data in the local file system matches the expected set of data (ZooKeeper stores this information). If there are minor inconsistencies, the system resolves them by syncing data with the replicas.</p>
<p>If the system detects broken data parts (with the wrong size of files) or unrecognized parts (parts written to the file system but not recorded in ZooKeeper), it moves them to the 'detached' subdirectory (they are not deleted). Any missing parts are copied from the replicas.</p>
<p>Note that ClickHouse does not perform any destructive actions such as automatically deleting a large amount of data.</p>
<p>When the server starts (or establishes a new session with ZooKeeper), it only checks the quantity and sizes of all files. If the file sizes match but bytes have been changed somewhere in the middle, this is not detected immediately, but only when attempting to read the data for a <code>SELECT</code> query. The query throws an exception about a non-matching checksum or size of a compressed block. In this case, data parts are added to the verification queue and copied from the replicas if necessary.</p>
<p>If the local set of data differs too much from the expected one, a safety mechanism is triggered. The server enters this in the log and refuses to launch. The reason for this is that this case may indicate a configuration error, such as if a replica on a shard was accidentally configured like a replica on a different shard. However, the thresholds for this mechanism are set fairly low, and this situation might occur during normal failure recovery. In this case, data is restored semi-automatically - by "pushing a button".</p>
<p>To start recovery, create the node <code>/path_to_table/replica_name/flags/force_restore_data</code> in ZooKeeper with any content, or run the command to restore all replicated tables:</p>
<div class="codehilite"><pre><span></span>sudo -u clickhouse touch /var/lib/clickhouse/flags/force_restore_data
</pre></div>


<p>Then restart the server. On start, the server deletes these flags and starts recovery.</p>
<h3 id="recovery-after-complete-data-loss">Recovery after complete data loss</h3>
<p>If all data and metadata disappeared from one of the servers, follow these steps for recovery:</p>
<ol>
<li>Install ClickHouse on the server. Define substitutions correctly in the config file that contains the shard identifier and replicas, if you use them.</li>
<li>If you had unreplicated tables that must be manually duplicated on the servers, copy their data from a replica (in the directory <code>/var/lib/clickhouse/data/db_name/table_name/</code>).</li>
<li>Copy table definitions located in <code>/var/lib/clickhouse/metadata/</code> from a replica. If a shard or replica identifier is defined explicitly in the table definitions, correct it so that it corresponds to this replica. (Alternatively, start the server and make all the <code>ATTACH TABLE</code> queries that should have been in the .sql files in <code>/var/lib/clickhouse/metadata/</code>.)</li>
<li>To start recovery, create the ZooKeeper node <code>/path_to_table/replica_name/flags/force_restore_data</code> with any content, or run the command to restore all replicated tables: <code>sudo -u clickhouse touch /var/lib/clickhouse/flags/force_restore_data</code></li>
</ol>
<p>Then start the server (restart, if it is already running). Data will be downloaded from replicas.</p>
<p>An alternative recovery option is to delete information about the lost replica from ZooKeeper (<code>/path_to_table/replica_name</code>), then create the replica again as described in "<a href="#table_engines-replication-creation_of_rep_tables">Creating replicatable tables</a>".</p>
<p>There is no restriction on network bandwidth during recovery. Keep this in mind if you are restoring many replicas at once.</p>
<h3 id="converting-from-mergetree-to-replicatedmergetree">Converting from MergeTree to ReplicatedMergeTree</h3>
<p>We use the term <code>MergeTree</code> to refer to all table engines in the <code>MergeTree family</code>, the same as for <code>ReplicatedMergeTree</code>.</p>
<p>If you had a <code>MergeTree</code> table that was manually replicated, you can convert it to a replicatable table. You might need to do this if you have already collected a large amount of data in a <code>MergeTree</code> table and now you want to enable replication.</p>
<p>If the data differs on various replicas, first sync it, or delete this data on all the replicas except one.</p>
<p>Rename the existing MergeTree table, then create a <code>ReplicatedMergeTree</code> table with the old name.
Move the data from the old table to the 'detached' subdirectory inside the directory with the new table data (<code>/var/lib/clickhouse/data/db_name/table_name/</code>).
Then run <code>ALTER TABLE ATTACH PARTITION</code> on one of the replicas to add these data parts to the working set.</p>
<h3 id="converting-from-replicatedmergetree-to-mergetree">Converting from ReplicatedMergeTree to MergeTree</h3>
<p>Create a MergeTree table with a different name. Move all the data from the directory with the <code>ReplicatedMergeTree</code> table data to the new table's data directory. Then delete the <code>ReplicatedMergeTree</code> table and restart the server.</p>
<p>If you want to get rid of a <code>ReplicatedMergeTree</code> table without launching the server:</p>
<ul>
<li>Delete the corresponding <code>.sql</code> file in the metadata directory (<code>/var/lib/clickhouse/metadata/</code>).</li>
<li>Delete the corresponding path in ZooKeeper (<code>/path_to_table/replica_name</code>).</li>
</ul>
<p>After this, you can launch the server, create a <code>MergeTree</code> table, move the data to its directory, and then restart the server.</p>
<h3 id="recovery-when-metadata-in-the-zookeeper-cluster-is-lost-or-damaged">Recovery when metadata in the ZooKeeper cluster is lost or damaged</h3>
<p>If the data in ZooKeeper was lost or damaged, you can save data by moving it to an unreplicated table as described above.</p>
<p>If exactly the same parts exist on the other replicas, they are added to the working set on them. If not, the parts are downloaded from the replica that has them.</p>
<p><a name="table_engines-distributed"></a></p>
<h2 id="distributed">Distributed</h2>
<p><strong>The Distributed engine does not store data itself</strong>, but allows distributed query processing on multiple servers.
Reading is automatically parallelized. During a read, the table indexes on remote servers are used, if there are any.
The Distributed engine accepts parameters: the cluster name in the server's config file, the name of a remote database, the name of a remote table, and (optionally) a sharding key.
Example:</p>
<div class="codehilite"><pre><span></span>Distributed(logs, default, hits[, sharding_key])
</pre></div>


<p>Data will be read from all servers in the 'logs' cluster, from the default.hits table located on every server in the cluster.
Data is not only read, but is partially processed on the remote servers (to the extent that this is possible).
For example, for a query with GROUP BY, data will be aggregated on remote servers, and the intermediate states of aggregate functions will be sent to the requestor server. Then data will be further aggregated.</p>
<p>Instead of the database name, you can use a constant expression that returns a string. For example: currentDatabase().</p>
<p>logs – The cluster name in the server's config file.</p>
<p>Clusters are set like this:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;remote_servers&gt;</span>
    <span class="nt">&lt;logs&gt;</span>
        <span class="nt">&lt;shard&gt;</span>
            <span class="c">&lt;!-- Optional. Shard weight when writing data. Default: 1. --&gt;</span>
            <span class="nt">&lt;weight&gt;</span>1<span class="nt">&lt;/weight&gt;</span>
            <span class="c">&lt;!-- Optional. Whether to write data to just one of the replicas. Default: false (write data to all replicas). --&gt;</span>
            <span class="nt">&lt;internal_replication&gt;</span>false<span class="nt">&lt;/internal_replication&gt;</span>
            <span class="nt">&lt;replica&gt;</span>
                <span class="nt">&lt;host&gt;</span>example01-01-1<span class="nt">&lt;/host&gt;</span>
                <span class="nt">&lt;port&gt;</span>9000<span class="nt">&lt;/port&gt;</span>
            <span class="nt">&lt;/replica&gt;</span>
            <span class="nt">&lt;replica&gt;</span>
                <span class="nt">&lt;host&gt;</span>example01-01-2<span class="nt">&lt;/host&gt;</span>
                <span class="nt">&lt;port&gt;</span>9000<span class="nt">&lt;/port&gt;</span>
            <span class="nt">&lt;/replica&gt;</span>
        <span class="nt">&lt;/shard&gt;</span>
        <span class="nt">&lt;shard&gt;</span>
            <span class="nt">&lt;weight&gt;</span>2<span class="nt">&lt;/weight&gt;</span>
            <span class="nt">&lt;internal_replication&gt;</span>false<span class="nt">&lt;/internal_replication&gt;</span>
            <span class="nt">&lt;replica&gt;</span>
                <span class="nt">&lt;host&gt;</span>example01-02-1<span class="nt">&lt;/host&gt;</span>
                <span class="nt">&lt;port&gt;</span>9000<span class="nt">&lt;/port&gt;</span>
            <span class="nt">&lt;/replica&gt;</span>
            <span class="nt">&lt;replica&gt;</span>
                <span class="nt">&lt;host&gt;</span>example01-02-2<span class="nt">&lt;/host&gt;</span>
                <span class="nt">&lt;port&gt;</span>9000<span class="nt">&lt;/port&gt;</span>
            <span class="nt">&lt;/replica&gt;</span>
        <span class="nt">&lt;/shard&gt;</span>
    <span class="nt">&lt;/logs&gt;</span>
<span class="nt">&lt;/remote_servers&gt;</span>
</pre></div>


<p>Here a cluster is defined with the name 'logs' that consists of two shards, each of which contains two replicas.
Shards refer to the servers that contain different parts of the data (in order to read all the data, you must access all the shards).
Replicas are duplicating servers (in order to read all the data, you can access the data on any one of the replicas).</p>
<p>The parameters <code>host</code>, <code>port</code>, and optionally <code>user</code> and <code>password</code> are specified for each server:</p>
<p>:   -   <code>host</code> – The address of the remote server. You can use either the domain or the IPv4 or IPv6 address. If you specify the domain, the server makes a DNS request when it starts, and the result is stored as long as the server is running. If the DNS request fails, the server doesn't start. If you change the DNS record, restart the server.
-   <code>port</code>– The TCP port for messenger activity ('tcp_port' in the config, usually set to 9000). Do not confuse it with http_port.
-   <code>user</code>– Name of the user for connecting to a remote server. Default value: default. This user must have access to connect to the specified server. Access is configured in the users.xml file. For more information, see the section "Access rights".
- <code>password</code> – The password for connecting to a remote server (not masked). Default value: empty string.</p>
<p>When specifying replicas, one of the available replicas will be selected for each of the shards when reading. You can configure the algorithm for load balancing (the preference for which replica to access) – see the 'load_balancing' setting.
If the connection with the server is not established, there will be an attempt to connect with a short timeout. If the connection failed, the next replica will be selected, and so on for all the replicas. If the connection attempt failed for all the replicas, the attempt will be repeated the same way, several times.
This works in favor of resiliency, but does not provide complete fault tolerance: a remote server might accept the connection, but might not work, or work poorly.</p>
<p>You can specify just one of the shards (in this case, query processing should be called remote, rather than distributed) or up to any number of shards. In each shard, you can specify from one to any number of replicas. You can specify a different number of replicas for each shard.</p>
<p>You can specify as many clusters as you wish in the configuration.</p>
<p>To view your clusters, use the 'system.clusters' table.</p>
<p>The Distributed engine allows working with a cluster like a local server. However, the cluster is inextensible: you must write its configuration in the server config file (even better, for all the cluster's servers).</p>
<p>There is no support for Distributed tables that look at other Distributed tables (except in cases when a Distributed table only has one shard). As an alternative, make the Distributed table look at the "final" tables.</p>
<p>The Distributed engine requires writing clusters to the config file. Clusters from the config file are updated on the fly, without restarting the server. If you need to send a query to an unknown set of shards and replicas each time, you don't need to create a Distributed table – use the 'remote' table function instead. See the section "Table functions".</p>
<p>There are two methods for writing data to a cluster:</p>
<p>First, you can define which servers to write which data to, and perform the write directly on each shard. In other words, perform INSERT in the tables that the distributed table "looks at".
This is the most flexible solution – you can use any sharding scheme, which could be non-trivial due to the requirements of the subject area.
This is also the most optimal solution, since data can be written to different shards completely independently.</p>
<p>Second, you can perform INSERT in a Distributed table. In this case, the table will distribute the inserted data across servers itself.
In order to write to a Distributed table, it must have a sharding key set (the last parameter). In addition, if there is only one shard, the write operation works without specifying the sharding key, since it doesn't have any meaning in this case.</p>
<p>Each shard can have a weight defined in the config file. By default, the weight is equal to one. Data is distributed across shards in the amount proportional to the shard weight. For example, if there are two shards and the first has a weight of 9 while the second has a weight of 10, the first will be sent 9 / 19 parts of the rows, and the second will be sent 10 / 19.</p>
<p>Each shard can have the 'internal_replication' parameter defined in the config file.</p>
<p>If this parameter is set to 'true', the write operation selects the first healthy replica and writes data to it. Use this alternative if the Distributed table "looks at" replicated tables. In other words, if the table where data will be written is going to replicate them itself.</p>
<p>If it is set to 'false' (the default), data is written to all replicas. In essence, this means that the Distributed table replicates data itself. This is worse than using replicated tables, because the consistency of replicas is not checked, and over time they will contain slightly different data.</p>
<p>To select the shard that a row of data is sent to, the sharding expression is analyzed, and its remainder is taken from dividing it by the total weight of the shards. The row is sent to the shard that corresponds to the half-interval of the remainders from 'prev_weight' to 'prev_weights + weight', where 'prev_weights' is the total weight of the shards with the smallest number, and 'weight' is the weight of this shard. For example, if there are two shards, and the first has a weight of 9 while the second has a weight of 10, the row will be sent to the first shard for the remainders from the range [0, 9), and to the second for the remainders from the range [9, 19).</p>
<p>The sharding expression can be any expression from constants and table columns that returns an integer. For example, you can use the expression 'rand()' for random distribution of data, or 'UserID' for distribution by the remainder from dividing the user's ID (then the data of a single user will reside on a single shard, which simplifies running IN and JOIN by users). If one of the columns is not distributed evenly enough, you can wrap it in a hash function: intHash64(UserID).</p>
<p>A simple remainder from division is a limited solution for sharding and isn't always appropriate. It works for medium and large volumes of data (dozens of servers), but not for very large volumes of data (hundreds of servers or more). In the latter case, use the sharding scheme required by the subject area, rather than using entries in Distributed tables.</p>
<p>SELECT queries are sent to all the shards, and work regardless of how data is distributed across the shards (they can be distributed completely randomly). When you add a new shard, you don't have to transfer the old data to it. You can write new data with a heavier weight – the data will be distributed slightly unevenly, but queries will work correctly and efficiently.</p>
<p>You should be concerned about the sharding scheme in the following cases:</p>
<ul>
<li>Queries are used that require joining data (IN or JOIN) by a specific key. If data is sharded by this key, you can use local IN or JOIN instead of GLOBAL IN or GLOBAL JOIN, which is much more efficient.</li>
<li>A large number of servers is used (hundreds or more) with a large number of small queries (queries of individual clients - websites, advertisers, or partners). In order for the small queries to not affect the entire cluster, it makes sense to locate data for a single client on a single shard. Alternatively, as we've done in Yandex.Metrica, you can set up bi-level sharding: divide the entire cluster into "layers", where a layer may consist of multiple shards. Data for a single client is located on a single layer, but shards can be added to a layer as necessary, and data is randomly distributed within them. Distributed tables are created for each layer, and a single shared distributed table is created for global queries.</li>
</ul>
<p>Data is written asynchronously. For an INSERT to a Distributed table, the data block is just written to the local file system. The data is sent to the remote servers in the background as soon as possible. You should check whether data is sent successfully by checking the list of files (data waiting to be sent) in the table directory: /var/lib/clickhouse/data/database/table/.</p>
<p>If the server ceased to exist or had a rough restart (for example, after a device failure) after an INSERT to a Distributed table, the inserted data might be lost. If a damaged data part is detected in the table directory, it is transferred to the 'broken' subdirectory and no longer used.</p>
<p>When the max_parallel_replicas option is enabled, query processing is parallelized across all replicas within a single shard. For more information, see the section "Settings, max_parallel_replicas".</p>
<p><a name="table_engines-dictionary"></a></p>
<h2 id="dictionary">Dictionary</h2>
<p>The <code>Dictionary</code> engine displays the dictionary data as a ClickHouse table.</p>
<p>As an example, consider a dictionary of <code>products</code> with the following configuration:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;dictionaries&gt;</span>
<span class="nt">&lt;dictionary&gt;</span>
        <span class="nt">&lt;name&gt;</span>products<span class="nt">&lt;/name&gt;</span>
        <span class="nt">&lt;source&gt;</span>
            <span class="nt">&lt;odbc&gt;</span>
                <span class="nt">&lt;table&gt;</span>products<span class="nt">&lt;/table&gt;</span>
                <span class="nt">&lt;connection_string&gt;</span>DSN=some-db-server<span class="nt">&lt;/connection_string&gt;</span>
            <span class="nt">&lt;/odbc&gt;</span>
        <span class="nt">&lt;/source&gt;</span>
        <span class="nt">&lt;lifetime&gt;</span>
            <span class="nt">&lt;min&gt;</span>300<span class="nt">&lt;/min&gt;</span>
            <span class="nt">&lt;max&gt;</span>360<span class="nt">&lt;/max&gt;</span>
        <span class="nt">&lt;/lifetime&gt;</span>
        <span class="nt">&lt;layout&gt;</span>
            <span class="nt">&lt;flat/&gt;</span>
        <span class="nt">&lt;/layout&gt;</span>
        <span class="nt">&lt;structure&gt;</span>
            <span class="nt">&lt;id&gt;</span>
                <span class="nt">&lt;name&gt;</span>product_id<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;attribute&gt;</span>
                <span class="nt">&lt;name&gt;</span>title<span class="nt">&lt;/name&gt;</span>
                <span class="nt">&lt;type&gt;</span>String<span class="nt">&lt;/type&gt;</span>
                <span class="nt">&lt;null_value&gt;&lt;/null_value&gt;</span>
            <span class="nt">&lt;/attribute&gt;</span>
        <span class="nt">&lt;/structure&gt;</span>
<span class="nt">&lt;/dictionary&gt;</span>
<span class="nt">&lt;/dictionaries&gt;</span>
</pre></div>


<p>Query the dictionary data:</p>
<div class="codehilite"><pre><span></span><span class="k">select</span> <span class="n">name</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span> <span class="k">key</span><span class="p">,</span> <span class="n">attribute</span><span class="p">.</span><span class="k">names</span><span class="p">,</span> <span class="n">attribute</span><span class="p">.</span><span class="n">types</span><span class="p">,</span> <span class="n">bytes_allocated</span><span class="p">,</span> <span class="n">element_count</span><span class="p">,</span><span class="k">source</span> <span class="k">from</span> <span class="k">system</span><span class="p">.</span><span class="n">dictionaries</span> <span class="k">where</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;products&#39;</span><span class="p">;</span>                     

<span class="k">SELECT</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="k">type</span><span class="p">,</span>
    <span class="k">key</span><span class="p">,</span>
    <span class="n">attribute</span><span class="p">.</span><span class="k">names</span><span class="p">,</span>
    <span class="n">attribute</span><span class="p">.</span><span class="n">types</span><span class="p">,</span>
    <span class="n">bytes_allocated</span><span class="p">,</span>
    <span class="n">element_count</span><span class="p">,</span>
    <span class="k">source</span>
<span class="k">FROM</span> <span class="k">system</span><span class="p">.</span><span class="n">dictionaries</span>
<span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;products&#39;</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─name─────┬─type─┬─key────┬─attribute.names─┬─attribute.types─┬─bytes_allocated─┬─element_count─┬─source──────────┐
│ products │ Flat │ UInt64 │ [&#39;title&#39;]       │ [&#39;String&#39;]      │        23065376 │        175032 │ ODBC: .products │
└──────────┴──────┴────────┴─────────────────┴─────────────────┴─────────────────┴───────────────┴─────────────────┘
</pre></div>


<p>You can use the <a href="#ext_dict_functions">dictGet*</a> function to get the dictionary data in this format.</p>
<p>This view isn't helpful when you need to get raw data, or when performing a <code>JOIN</code> operation. For these cases, you can use the <code>Dictionary</code> engine, which displays the dictionary data in a table.</p>
<p>Syntax:</p>
<div class="codehilite"><pre><span></span>CREATE TABLE %table_name% (%fields%) engine = Dictionary(%dictionary_name%)`
</pre></div>


<p>Usage example:</p>
<div class="codehilite"><pre><span></span><span class="k">create</span> <span class="k">table</span> <span class="n">products</span> <span class="p">(</span><span class="n">product_id</span> <span class="n">UInt64</span><span class="p">,</span> <span class="n">title</span> <span class="n">String</span><span class="p">)</span> <span class="n">Engine</span> <span class="o">=</span> <span class="k">Dictionary</span><span class="p">(</span><span class="n">products</span><span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">products</span>
<span class="p">(</span>
    <span class="n">product_id</span> <span class="n">UInt64</span><span class="p">,</span>
    <span class="n">title</span> <span class="n">String</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ENGINE</span> <span class="o">=</span> <span class="k">Dictionary</span><span class="p">(</span><span class="n">products</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span>Ok.

0 rows in set. Elapsed: 0.004 sec.
</pre></div>


<p>Take a look at what's in the table.</p>
<div class="codehilite"><pre><span></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">products</span> <span class="k">limit</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">products</span>
<span class="k">LIMIT</span> <span class="mi">1</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌────product_id─┬─title───────────┐
│        152689 │ Some item       │
└───────────────┴─────────────────┘

1 rows in set. Elapsed: 0.006 sec.
</pre></div>


<h2 id="merge">Merge</h2>
<p>The Merge engine (not to be confused with <code>MergeTree</code>) does not store data itself, but allows reading from any number of other tables simultaneously.
Reading is automatically parallelized. Writing to a table is not supported. When reading, the indexes of tables that are actually being read are used, if they exist.
The Merge engine accepts parameters: the database name and a regular expression for tables.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span>Merge(hits, &#39;^WatchLog&#39;)
</pre></div>


<p>Data will be read from the tables in the 'hits' database that have names that match the regular expression '<code>^WatchLog</code>'.</p>
<p>Instead of the database name, you can use a constant expression that returns a string. For example, <code>currentDatabase()</code>.</p>
<p>Regular expressions — <a href="https://github.com/google/re2">re2</a> (supports a subset of PCRE), case-sensitive.
See the notes about escaping symbols in regular expressions in the "match" section.</p>
<p>When selecting tables to read, the Merge table itself will not be selected, even if it matches the regex. This is to avoid loops.
It is possible to create two Merge tables that will endlessly try to read each others' data, but this is not a good idea.</p>
<p>The typical way to use the Merge engine is for working with a large number of TinyLog tables as if with a single table.</p>
<h3 id="virtual-columns">Virtual columns</h3>
<p>Virtual columns are columns that are provided by the table engine, regardless of the table definition. In other words, these columns are not specified in CREATE TABLE, but they are accessible for SELECT.</p>
<p>Virtual columns differ from normal columns in the following ways:</p>
<ul>
<li>They are not specified in table definitions.</li>
<li>Data can't be added to them with INSERT.</li>
<li>When using INSERT without specifying the list of columns, virtual columns are ignored.</li>
<li>They are not selected when using the asterisk (<code>SELECT *</code>).</li>
<li>Virtual columns are not shown in <code>SHOW CREATE TABLE</code> and <code>DESC TABLE</code> queries.</li>
</ul>
<p>A Merge type table contains a virtual _table column with the String type. (If the table already has a _table column, the virtual column is named _table1, and if it already has _table1, it is named _table2, and so on.) It contains the name of the table that data was read from.</p>
<p>If the WHERE or PREWHERE clause contains conditions for the '_table' column that do not depend on other table columns (as one of the conjunction elements, or as an entire expression), these conditions are used as an index. The conditions are performed on a data set of table names to read data from, and the read operation will be performed from only those tables that the condition was triggered on.</p>
<h2 id="buffer">Buffer</h2>
<p>Buffers the data to write in RAM, periodically flushing it to another table. During the read operation, data is read from the buffer and the other table simultaneously.</p>
<div class="codehilite"><pre><span></span>Buffer(database, table, num_layers, min_time, max_time, min_rows, max_rows, min_bytes, max_bytes)
</pre></div>


<p>Engine parameters:database, table – The table to flush data to. Instead of the database name, you can use a constant expression that returns a string.num_layers – Parallelism layer. Physically, the table will be represented as 'num_layers' of independent buffers. Recommended value: 16.min_time, max_time, min_rows, max_rows, min_bytes, and max_bytes are conditions for flushing data from the buffer.</p>
<p>Data is flushed from the buffer and written to the destination table if all the 'min' conditions or at least one 'max' condition are met.min_time, max_time – Condition for the time in seconds from the moment of the first write to the buffer.min_rows, max_rows – Condition for the number of rows in the buffer.min_bytes, max_bytes – Condition for the number of bytes in the buffer.</p>
<p>During the write operation, data is inserted to a 'num_layers' number of random buffers. Or, if the data part to insert is large enough (greater than 'max_rows' or 'max_bytes'), it is written directly to the destination table, omitting the buffer.</p>
<p>The conditions for flushing the data are calculated separately for each of the 'num_layers' buffers. For example, if num_layers = 16 and max_bytes = 100000000, the maximum RAM consumption is 1.6 GB.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">merge</span><span class="p">.</span><span class="n">hits_buffer</span> <span class="k">AS</span> <span class="n">merge</span><span class="p">.</span><span class="n">hits</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">Buffer</span><span class="p">(</span><span class="n">merge</span><span class="p">,</span> <span class="n">hits</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">,</span> <span class="mi">10000000</span><span class="p">,</span> <span class="mi">100000000</span><span class="p">)</span>
</pre></div>


<p>Creating a 'merge.hits_buffer' table with the same structure as 'merge.hits' and using the Buffer engine. When writing to this table, data is buffered in RAM and later written to the 'merge.hits' table. 16 buffers are created. The data in each of them is flushed if either 100 seconds have passed, or one million rows have been written, or 100 MB of data have been written; or if simultaneously 10 seconds have passed and 10,000 rows and 10 MB of data have been written. For example, if just one row has been written, after 100 seconds it will be flushed, no matter what. But if many rows have been written, the data will be flushed sooner.</p>
<p>When the server is stopped, with DROP TABLE or DETACH TABLE, buffer data is also flushed to the destination table.</p>
<p>You can set empty strings in single quotation marks for the database and table name. This indicates the absence of a destination table. In this case, when the data flush conditions are reached, the buffer is simply cleared. This may be useful for keeping a window of data in memory.</p>
<p>When reading from a Buffer table, data is processed both from the buffer and from the destination table (if there is one).
Note that the Buffer tables does not support an index. In other words, data in the buffer is fully scanned, which might be slow for large buffers. (For data in a subordinate table, the index that it supports will be used.)</p>
<p>If the set of columns in the Buffer table doesn't match the set of columns in a subordinate table, a subset of columns that exist in both tables is inserted.</p>
<p>If the types don't match for one of the columns in the Buffer table and a subordinate table, an error message is entered in the server log and the buffer is cleared.
The same thing happens if the subordinate table doesn't exist when the buffer is flushed.</p>
<p>If you need to run ALTER for a subordinate table and the Buffer table, we recommend first deleting the Buffer table, running ALTER for the subordinate table, then creating the Buffer table again.</p>
<p>If the server is restarted abnormally, the data in the buffer is lost.</p>
<p>PREWHERE, FINAL and SAMPLE do not work correctly for Buffer tables. These conditions are passed to the destination table, but are not used for processing data in the buffer. Because of this, we recommend only using the Buffer table for writing, while reading from the destination table.</p>
<p>When adding data to a Buffer, one of the buffers is locked. This causes delays if a read operation is simultaneously being performed from the table.</p>
<p>Data that is inserted to a Buffer table may end up in the subordinate table in a different order and in different blocks. Because of this, a Buffer table is difficult to use for writing to a CollapsingMergeTree correctly. To avoid problems, you can set 'num_layers' to 1.</p>
<p>If the destination table is replicated, some expected characteristics of replicated tables are lost when writing to a Buffer table. The random changes to the order of rows and sizes of data parts cause data deduplication to quit working, which means it is not possible to have a reliable 'exactly once' write to replicated tables.</p>
<p>Due to these disadvantages, we can only recommend using a Buffer table in rare cases.</p>
<p>A Buffer table is used when too many INSERTs are received from a large number of servers over a unit of time and data can't be buffered before insertion, which means the INSERTs can't run fast enough.</p>
<p>Note that it doesn't make sense to insert data one row at a time, even for Buffer tables. This will only produce a speed of a few thousand rows per second, while inserting larger blocks of data can produce over a million rows per second (see the section "Performance").</p>
<h2 id="fileinputformat">File(InputFormat)</h2>
<p>The data source is a file that stores data in one of the supported input formats (TabSeparated, Native, etc.).</p>
<h2 id="null">Null</h2>
<p>When writing to a Null table, data is ignored. When reading from a Null table, the response is empty.</p>
<p>However, you can create a materialized view on a Null table. So the data written to the table will end up in the view.</p>
<h2 id="set_1">Set</h2>
<p>A data set that is always in RAM. It is intended for use on the right side of the IN operator (see the section "IN operators").</p>
<p>You can use INSERT to insert data in the table. New elements will be added to the data set, while duplicates will be ignored.
But you can't perform SELECT from the table. The only way to retrieve data is by using it in the right half of the IN operator.</p>
<p>Data is always located in RAM. For INSERT, the blocks of inserted data are also written to the directory of tables on the disk. When starting the server, this data is loaded to RAM. In other words, after restarting, the data remains in place.</p>
<p>For a rough server restart, the block of data on the disk might be lost or damaged. In the latter case, you may need to manually delete the file with damaged data.</p>
<h2 id="join">Join</h2>
<p>A prepared data structure for JOIN that is always located in RAM.</p>
<div class="codehilite"><pre><span></span>Join(ANY|ALL, LEFT|INNER, k1[, k2, ...])
</pre></div>


<p>Engine parameters: <code>ANY|ALL</code> – strictness; <code>LEFT|INNER</code> – type.
These parameters are set without quotes and must match the JOIN that the table will be used for. k1, k2, ... are the key columns from the USING clause that the join will be made on.</p>
<p>The table can't be used for GLOBAL JOINs.</p>
<p>You can use INSERT to add data to the table, similar to the Set engine. For ANY, data for duplicated keys will be ignored. For ALL, it will be counted. You can't perform SELECT directly from the table. The only way to retrieve data is to use it as the "right-hand" table for JOIN.</p>
<p>Storing data on the disk is the same as for the Set engine.</p>
<h2 id="view">View</h2>
<p>Used for implementing views (for more information, see the <code>CREATE VIEW query</code>). It does not store data, but only stores the specified <code>SELECT</code> query. When reading from a table, it runs this query (and deletes all unnecessary columns from the query).</p>
<h2 id="materializedview">MaterializedView</h2>
<p>Used for implementing materialized views (for more information, see the <a href="#query_language-queries-create_table">CREATE TABLE</a>) query. For storing data, it uses a different engine that was specified when creating the view. When reading from a table, it just uses this engine.</p>
<h2 id="kafka">Kafka</h2>
<p>This engine works with <a href="http://kafka.apache.org/">Apache Kafka</a>.</p>
<p>Kafka lets you:</p>
<ul>
<li>Publish or subscribe to data flows.</li>
<li>Organize fault-tolerant storage.</li>
<li>Process streams as they become available.</li>
</ul>
<div class="codehilite"><pre><span></span>Kafka(broker_list, topic_list, group_name, format[, schema, num_consumers])
</pre></div>


<p>Parameters:</p>
<ul>
<li><code>broker_list</code> – A comma-separated list of brokers (<code>localhost:9092</code>).</li>
<li><code>topic_list</code> – A list of Kafka topics (<code>my_topic</code>).</li>
<li><code>group_name</code> – A group of Kafka consumers (<code>group1</code>). Reading margins are tracked for each group separately. If you don't want messages to be duplicated in the cluster, use the same group name everywhere.</li>
<li><code>--format</code> – Message format. Uses the same notation as the SQL <code>FORMAT</code> function, such as <code>JSONEachRow</code>. For more information, see the "Formats" section.</li>
<li><code>schema</code> – An optional parameter that must be used if the format requires a schema definition. For example, <a href="https://capnproto.org/">Cap'n Proto</a>  requires the path to the schema file and the name of the root <code>schema.capnp:Message</code> object.</li>
<li><code>num_consumers</code> – The number of consumers per table. Default: <code>1</code>. Specify more consumers if the throughput of one consumer is insufficient. The total number of consumers should not exceed the number of partitions in the topic, since only one consumer can be assigned per partition.</li>
</ul>
<p>Example:</p>
<div class="codehilite"><pre><span></span>  <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">queue</span> <span class="p">(</span>
    <span class="k">timestamp</span> <span class="n">UInt64</span><span class="p">,</span>
    <span class="k">level</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">message</span> <span class="n">String</span>
  <span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">Kafka</span><span class="p">(</span><span class="s1">&#39;localhost:9092&#39;</span><span class="p">,</span> <span class="s1">&#39;topic&#39;</span><span class="p">,</span> <span class="s1">&#39;group1&#39;</span><span class="p">,</span> <span class="s1">&#39;JSONEachRow&#39;</span><span class="p">);</span>

  <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">queue</span> <span class="k">LIMIT</span> <span class="mi">5</span><span class="p">;</span>
</pre></div>


<p>The delivered messages are tracked automatically, so each message in a group is only counted once. If you want to get the data twice, then create a copy of the table with another group name.</p>
<p>Groups are flexible and synced on the cluster. For instance, if you have 10 topics and 5 copies of a table in a cluster, then each copy gets 2 topics. If the number of copies changes, the topics are redistributed across the copies automatically. Read more about this at <a href="http://kafka.apache.org/intro">http://kafka.apache.org/intro</a>.</p>
<p><code>SELECT</code> is not particularly useful for reading messages (except for debugging), because each message can be read only once. It is more practical to create real-time threads using materialized views. To do this:</p>
<ol>
<li>Use the engine to create a Kafka consumer and consider it a data stream.</li>
<li>Create a table with the desired structure.</li>
<li>Create a materialized view that converts data from the engine and puts it into a previously created table.</li>
</ol>
<p>When the <code>MATERIALIZED VIEW</code> joins the engine, it starts collecting data in the background. This allows you to continually receive messages from Kafka and convert them to the required format using <code>SELECT</code></p>
<p>Example:</p>
<div class="codehilite"><pre><span></span>  <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">queue</span> <span class="p">(</span>
    <span class="k">timestamp</span> <span class="n">UInt64</span><span class="p">,</span>
    <span class="k">level</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">message</span> <span class="n">String</span>
  <span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">Kafka</span><span class="p">(</span><span class="s1">&#39;localhost:9092&#39;</span><span class="p">,</span> <span class="s1">&#39;topic&#39;</span><span class="p">,</span> <span class="s1">&#39;group1&#39;</span><span class="p">,</span> <span class="s1">&#39;JSONEachRow&#39;</span><span class="p">);</span>

  <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">daily</span> <span class="p">(</span>
    <span class="k">day</span> <span class="nb">Date</span><span class="p">,</span>
    <span class="k">level</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">total</span> <span class="n">UInt64</span>
  <span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">SummingMergeTree</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="k">level</span><span class="p">),</span> <span class="mi">8192</span><span class="p">);</span>

  <span class="k">CREATE</span> <span class="n">MATERIALIZED</span> <span class="k">VIEW</span> <span class="n">consumer</span> <span class="k">TO</span> <span class="n">daily</span>
    <span class="k">AS</span> <span class="k">SELECT</span> <span class="n">toDate</span><span class="p">(</span><span class="n">toDateTime</span><span class="p">(</span><span class="k">timestamp</span><span class="p">))</span> <span class="k">AS</span> <span class="k">day</span><span class="p">,</span> <span class="k">level</span><span class="p">,</span> <span class="k">count</span><span class="p">()</span> <span class="k">as</span> <span class="n">total</span>
    <span class="k">FROM</span> <span class="n">queue</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="k">day</span><span class="p">,</span> <span class="k">level</span><span class="p">;</span>

  <span class="k">SELECT</span> <span class="k">level</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">daily</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="k">level</span><span class="p">;</span>
</pre></div>


<p>To improve performance, received messages are grouped into blocks the size of <a href="#settings-settings-max_insert_block_size">max_insert_block_size</a>. If the block wasn't formed within <a href="#settings-settings_stream_flush_interval_ms">stream_flush_interval_ms</a> milliseconds, the data will be flushed to the table regardless of the completeness of the block.</p>
<p>To stop receiving topic data or to change the conversion logic, detach the materialized view:</p>
<div class="codehilite"><pre><span></span>  DETACH TABLE consumer;
  ATTACH MATERIALIZED VIEW consumer;
</pre></div>


<p>If you want to change the target table by using <code>ALTER</code>materialized view, we recommend disabling the material view to avoid discrepancies between the target table and the data from the view.</p>
<h3 id="configuration">Configuration</h3>
<p>Similar to GraphiteMergeTree, the Kafka engine supports extended configuration using the ClickHouse config file. There are two configuration keys that you can use: global (<code>kafka</code>) and topic-level (<code>kafka_topic_*</code>). The global configuration is applied first, and the topic-level configuration is second (if it exists).</p>
<div class="codehilite"><pre><span></span>  <span class="c">&lt;!--  Global configuration options for all tables of Kafka engine type --&gt;</span>
  <span class="nt">&lt;kafka&gt;</span>
    <span class="nt">&lt;debug&gt;</span>cgrp<span class="nt">&lt;/debug&gt;</span>
    <span class="nt">&lt;auto_offset_reset&gt;</span>smallest<span class="nt">&lt;/auto_offset_reset&gt;</span>
  <span class="nt">&lt;/kafka&gt;</span>

  <span class="c">&lt;!-- Configuration specific for topic &quot;logs&quot; --&gt;</span>
  <span class="nt">&lt;kafka_topic_logs&gt;</span>
    <span class="nt">&lt;retry_backoff_ms&gt;</span>250<span class="nt">&lt;/retry_backoff_ms&gt;</span>
    <span class="nt">&lt;fetch_min_bytes&gt;</span>100000<span class="nt">&lt;/fetch_min_bytes&gt;</span>
  <span class="nt">&lt;/kafka_topic_logs&gt;</span>
</pre></div>


<p>For a list of possible configuration options, see the <a href="https://github.com/edenhill/librdkafka/blob/master/CONFIGURATION.md">librdkafka configuration reference</a>. Use the underscore (<code>_</code>) instead of a dot in the ClickHouse configuration. For example, <code>check.crcs=true</code> will be <code>&lt;check_crcs&gt;true&lt;/check_crcs&gt;</code>.</p>
<p><a name="table_engines-mysql"></a></p>
<h2 id="mysql">MySQL</h2>
<p>The MySQL engine allows you to perform SELECT queries on data that is stored on a remote MySQL server.</p>
<p>The engine takes 4 parameters: the server address (host and port); the name of the database; the name of the table; the user's name; the user's password. Example:</p>
<div class="codehilite"><pre><span></span>MySQL(&#39;host:port&#39;, &#39;database&#39;, &#39;table&#39;, &#39;user&#39;, &#39;password&#39;);
</pre></div>


<p>At this time, simple WHERE clauses such as <code>=, !=, &gt;, &gt;=, &lt;, &lt;=</code> are executed on the MySQL server.</p>
<p>The rest of the conditions and the LIMIT sampling constraint are executed in ClickHouse only after the query to MySQL finishes.</p>
<h2 id="external-data-for-query-processing">External data for query processing</h2>
<p>ClickHouse allows sending a server the data that is needed for processing a query, together with a SELECT query. This data is put in a temporary table (see the section "Temporary tables") and can be used in the query (for example, in IN operators).</p>
<p>For example, if you have a text file with important user identifiers, you can upload it to the server along with a query that uses filtration by this list.</p>
<p>If you need to run more than one query with a large volume of external data, don't use this feature. It is better to upload the data to the DB ahead of time.</p>
<p>External data can be uploaded using the command-line client (in non-interactive mode), or using the HTTP interface.</p>
<p>In the command-line client, you can specify a parameters section in the format</p>
<div class="codehilite"><pre><span></span>--external --file<span class="o">=</span>... <span class="o">[</span>--name<span class="o">=</span>...<span class="o">]</span> <span class="o">[</span>--format<span class="o">=</span>...<span class="o">]</span> <span class="o">[</span>--types<span class="o">=</span>...<span class="p">|</span>--structure<span class="o">=</span>...<span class="o">]</span>
</pre></div>


<p>You may have multiple sections like this, for the number of tables being transmitted.</p>
<p><strong>--external</strong> – Marks the beginning of a clause.
<strong>--file</strong> – Path to the file with the table dump, or -, which refers to stdin.
Only a single table can be retrieved from stdin.</p>
<p>The following parameters are optional: <strong>--name</strong>– Name of the table. If omitted, _data is used.
<strong>--format</strong> – Data format in the file. If omitted, TabSeparated is used.</p>
<p>One of the following parameters is required:<strong>--types</strong> – A list of comma-separated column types. For example: <code>UInt64,String</code>. The columns will be named _1, _2, ...
<strong>--structure</strong>– The table structure in the format<code>UserID UInt64</code>, <code>URL String</code>. Defines the column names and types.</p>
<p>The files specified in 'file' will be parsed by the format specified in 'format', using the data types specified in 'types' or 'structure'. The table will be uploaded to the server and accessible there as a temporary table with the name in 'name'.</p>
<p>Examples:</p>
<div class="codehilite"><pre><span></span><span class="nb">echo</span> -ne <span class="s2">&quot;1\n2\n3\n&quot;</span> <span class="p">|</span> clickhouse-client --query<span class="o">=</span><span class="s2">&quot;SELECT count() FROM test.visits WHERE TraficSourceID IN _data&quot;</span> --external --file<span class="o">=</span>- --types<span class="o">=</span>Int8
<span class="m">849897</span>
cat /etc/passwd <span class="p">|</span> sed <span class="s1">&#39;s/:/\t/g&#39;</span> <span class="p">|</span> clickhouse-client --query<span class="o">=</span><span class="s2">&quot;SELECT shell, count() AS c FROM passwd GROUP BY shell ORDER BY c DESC&quot;</span> --external --file<span class="o">=</span>- --name<span class="o">=</span>passwd --structure<span class="o">=</span><span class="s1">&#39;login String, unused String, uid UInt16, gid UInt16, comment String, home String, shell String&#39;</span>
/bin/sh <span class="m">20</span>
/bin/false      <span class="m">5</span>
/bin/bash       <span class="m">4</span>
/usr/sbin/nologin       <span class="m">1</span>
/bin/sync       <span class="m">1</span>
</pre></div>


<p>When using the HTTP interface, external data is passed in the multipart/form-data format. Each table is transmitted as a separate file. The table name is taken from the file name. The 'query_string' is passed the parameters 'name_format', 'name_types', and 'name_structure', where 'name' is the name of the table that these parameters correspond to. The meaning of the parameters is the same as when using the command-line client.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span>cat /etc/passwd <span class="p">|</span> sed <span class="s1">&#39;s/:/\t/g&#39;</span> &gt; passwd.tsv

curl -F <span class="s1">&#39;passwd=@passwd.tsv;&#39;</span> <span class="s1">&#39;http://localhost:8123/?query=SELECT+shell,+count()+AS+c+FROM+passwd+GROUP+BY+shell+ORDER+BY+c+DESC&amp;passwd_structure=login+String,+unused+String,+uid+UInt16,+gid+UInt16,+comment+String,+home+String,+shell+String&#39;</span>
/bin/sh <span class="m">20</span>
/bin/false      <span class="m">5</span>
/bin/bash       <span class="m">4</span>
/usr/sbin/nologin       <span class="m">1</span>
/bin/sync       <span class="m">1</span>
</pre></div>


<p>For distributed query processing, the temporary tables are sent to all the remote servers.</p>
<h2 id="system-tables">System tables</h2>
<p>System tables are used for implementing part of the system's functionality, and for providing access to information about how the system is working.
You can't delete a system table (but you can perform DETACH).
System tables don't have files with data on the disk or files with metadata. The server creates all the system tables when it starts.
System tables are read-only.
They are located in the 'system' database.</p>
<h2 id="systemone">system.one</h2>
<p>This table contains a single row with a single 'dummy' UInt8 column containing the value 0.
This table is used if a SELECT query doesn't specify the FROM clause.
This is similar to the DUAL table found in other DBMSs.</p>
<h2 id="systemnumbers">system.numbers</h2>
<p>This table contains a single UInt64 column named 'number' that contains almost all the natural numbers starting from zero.
You can use this table for tests, or if you need to do a brute force search.
Reads from this table are not parallelized.</p>
<h2 id="systemnumbers_mt">system.numbers_mt</h2>
<p>The same as 'system.numbers' but reads are parallelized. The numbers can be returned in any order.
Used for tests.</p>
<h2 id="systemdatabases">system.databases</h2>
<p>This table contains a single String column called 'name' – the name of a database.
Each database that the server knows about has a corresponding entry in the table.
This system table is used for implementing the <code>SHOW DATABASES</code> query.</p>
<h2 id="systemtables">system.tables</h2>
<p>This table contains the String columns 'database', 'name', and 'engine'.
The table also contains three virtual columns: metadata_modification_time (DateTime type), create_table_query, and engine_full (String type).
Each table that the server knows about is entered in the 'system.tables' table.
This system table is used for implementing SHOW TABLES queries.</p>
<h2 id="systemcolumns">system.columns</h2>
<p>Contains information about the columns in all tables.
You can use this table to get information similar to <code>DESCRIBE TABLE</code>, but for multiple tables at once.</p>
<div class="codehilite"><pre><span></span>database String           - Name of the database the table is located in.
table String              - Table name.
name String               - Column name.
type String               - Column type.
default_type String       - Expression type (DEFAULT, MATERIALIZED, ALIAS) for the default value, or an empty string if it is not defined.
default_expression String - Expression for the default value, or an empty string if it is not defined.
</pre></div>


<h2 id="systemparts">system.parts</h2>
<p>Contains information about parts of a table in the <a href="#table_engines-mergetree">MergeTree</a> family.</p>
<p>Each row describes one part of the data.</p>
<p>Columns:</p>
<ul>
<li>partition (String) – The partition name. YYYYMM format. To learn what a partition is, see the description of the <a href="#query_language_queries_alter">ALTER</a> query.</li>
<li>name (String) – Name of the data part.</li>
<li>active (UInt8) – Indicates whether the part is active. If a part is active, it is used in a table; otherwise, it will be deleted. Inactive data parts remain after merging.</li>
<li>marks (UInt64) – The number of marks. To get the approximate number of rows in a data part, multiply <code>marks</code>  by the index granularity (usually 8192).</li>
<li>marks_size (UInt64) – The size of the file with marks.</li>
<li>rows (UInt64) – The number of rows.</li>
<li>bytes (UInt64) – The number of bytes when compressed.</li>
<li>modification_time (DateTime) – The modification time of the directory with the data part. This usually corresponds to the time of data part creation.|</li>
<li>remove_time (DateTime) – The time when the data part became inactive.</li>
<li>refcount (UInt32) – The number of places where the data part is used. A value greater than 2 indicates that the data part is used in queries or merges.</li>
<li>min_date (Date) – The minimum value of the date key in the data part.</li>
<li>max_date (Date) – The maximum value of the date key in the data part.</li>
<li>min_block_number (UInt64) – The minimum number of data parts that make up the current part after merging.</li>
<li>max_block_number (UInt64) – The maximum number of data parts that make up the current part after merging.</li>
<li>level (UInt32) – Depth of the merge tree. If a merge was not performed, <code>level=0</code>.</li>
<li>primary_key_bytes_in_memory (UInt64) – The amount of memory (in bytes) used by primary key values.</li>
<li>primary_key_bytes_in_memory_allocated (UInt64) – The amount of memory (in bytes) reserved for primary key values.</li>
<li>database (String) – Name of the database.</li>
<li>table (String) – Name of the table.</li>
<li>engine (String) – Name of the table engine without parameters.</li>
</ul>
<h2 id="systemprocesses">system.processes</h2>
<p>This system table is used for implementing the <code>SHOW PROCESSLIST</code> query.
Columns:</p>
<div class="codehilite"><pre><span></span>user String              – Name of the user who made the request. For distributed query processing, this is the user who helped the requestor server send the query to this server, not the user who made the distributed request on the requestor server.

address String           – The IP address that the query was made from. The same is true for distributed query processing.

elapsed Float64          –  The time in seconds since request execution started.

rows_read UInt64         – The number of rows read from the table. For distributed processing, on the requestor server, this is the total for all remote servers.

bytes_read UInt64        – The number of uncompressed bytes read from the table. For distributed processing, on the requestor server, this is the total for all remote servers.

UInt64 total_rows_approx – The approximate total number of rows that must be read. For distributed processing, on the requestor server, this is the total for all remote servers. It can be updated during request processing, when new sources to process become known.

memory_usage UInt64 – Memory consumption by the query. It might not include some types of dedicated memory.

query String – The query text. For INSERT, it doesn&#39;t include the data to insert.

query_id – Query ID, if defined.
</pre></div>


<h2 id="systemmerges">system.merges</h2>
<p>Contains information about merges currently in process for tables in the MergeTree family.</p>
<p>Columns:</p>
<ul>
<li><code>database String</code> — Name of the database the table is located in.</li>
<li><code>table String</code> — Name of the table.</li>
<li><code>elapsed Float64</code> — Time in seconds since the merge started.</li>
<li><code>progress Float64</code> — Percent of progress made, from 0 to 1.</li>
<li><code>num_parts UInt64</code> — Number of parts to merge.</li>
<li><code>result_part_name String</code> — Name of the part that will be formed as the result of the merge.</li>
<li><code>total_size_bytes_compressed UInt64</code> — Total size of compressed data in the parts being merged.</li>
<li><code>total_size_marks UInt64</code> — Total number of marks in the parts being merged.</li>
<li><code>bytes_read_uncompressed UInt64</code> — Amount of bytes read, decompressed.</li>
<li><code>rows_read UInt64</code> — Number of rows read.</li>
<li><code>bytes_written_uncompressed UInt64</code> — Amount of bytes written, uncompressed.</li>
<li><code>rows_written UInt64</code> — Number of rows written.</li>
</ul>
<p><a name="system_tables-system.events"></a></p>
<h2 id="systemevents">system.events</h2>
<p>Contains information about the number of events that have occurred in the system. This is used for profiling and monitoring purposes.
Example: The number of processed SELECT queries.
Columns: 'event String' – the event name, and 'value UInt64' – the quantity.</p>
<p><a name="system_tables-system.metrics"></a></p>
<h2 id="systemmetrics">system.metrics</h2>
<p><a name="system_tables-system.asynchronous_metrics"></a></p>
<h2 id="systemasynchronous_metrics">system.asynchronous_metrics</h2>
<p>Contain metrics used for profiling and monitoring.
They usually reflect the number of events currently in the system, or the total resources consumed by the system.
Example: The number of SELECT queries currently running; the amount of memory in use.<code>system.asynchronous_metrics</code>and<code>system.metrics</code> differ in their sets of metrics and how they are calculated.</p>
<h2 id="systemreplicas">system.replicas</h2>
<p>Contains information and status for replicated tables residing on the local server.
This table can be used for monitoring. The table contains a row for every Replicated* table.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="k">system</span><span class="p">.</span><span class="n">replicas</span>
<span class="k">WHERE</span> <span class="k">table</span> <span class="o">=</span> <span class="s1">&#39;visits&#39;</span>
<span class="n">FORMAT</span> <span class="n">Vertical</span>
</pre></div>


<div class="codehilite"><pre><span></span>Row 1:
──────
database:           merge
table:              visits
engine:             ReplicatedCollapsingMergeTree
is_leader:          1
is_readonly:        0
is_session_expired: 0
future_parts:       1
parts_to_check:     0
zookeeper_path:     /clickhouse/tables/01-06/visits
replica_name:       example01-06-1.yandex.ru
replica_path:       /clickhouse/tables/01-06/visits/replicas/example01-06-1.yandex.ru
columns_version:    9
queue_size:         1
inserts_in_queue:   0
merges_in_queue:    1
log_max_index:      596273
log_pointer:        596274
total_replicas:     2
active_replicas:    2
</pre></div>


<p>Columns:</p>
<div class="codehilite"><pre><span></span>database:           database name
table:              table name
engine:             table engine name

is_leader:          whether the replica is the leader

Only one replica at a time can be the leader. The leader is responsible for selecting background merges to perform.
Note that writes can be performed to any replica that is available and has a session in ZK, regardless of whether it is a leader.

is_readonly:        Whether the replica is in read-only mode.
This mode is turned on if the config doesn&#39;t have sections with ZK, if an unknown error occurred when reinitializing sessions in ZK, and during session reinitialization in ZK.

is_session_expired: Whether the ZK session expired.
Basically, the same thing as is_readonly.

future_parts: The number of data parts that will appear as the result of INSERTs or merges that haven&#39;t been done yet. 

parts_to_check: The number of data parts in the queue for verification.
A part is put in the verification queue if there is suspicion that it might be damaged.

zookeeper_path: The path to the table data in ZK. 
replica_name: Name of the replica in ZK. Different replicas of the same table have different names. 
replica_path: The path to the replica data in ZK. The same as concatenating zookeeper_path/replicas/replica_path.

columns_version: Version number of the table structure.
Indicates how many times ALTER was performed. If replicas have different versions, it means some replicas haven&#39;t made all of the ALTERs yet.

queue_size:         Size of the queue for operations waiting to be performed.
Operations include inserting blocks of data, merges, and certain other actions.
Normally coincides with future_parts.

inserts_in_queue: Number of inserts of blocks of data that need to be made.
Insertions are usually replicated fairly quickly. If the number is high, something is wrong.

merges_in_queue: The number of merges waiting to be made. 
Sometimes merges are lengthy, so this value may be greater than zero for a long time.

The next 4 columns have a non-null value only if the ZK session is active.

log_max_index:     Maximum entry number in the log of general activity.
log_pointer:        Maximum entry number in the log of general activity that the replica copied to its execution queue, plus one.
If log_pointer is much smaller than log_max_index, something is wrong.

total_replicas:     Total number of known replicas of this table.
active_replicas:    Number of replicas of this table that have a ZK session (the number of active replicas).
</pre></div>


<p>If you request all the columns, the table may work a bit slowly, since several reads from ZK are made for each row.
If you don't request the last 4 columns (log_max_index, log_pointer, total_replicas, active_replicas), the table works quickly.</p>
<p>For example, you can check that everything is working correctly like this:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="k">database</span><span class="p">,</span>
    <span class="k">table</span><span class="p">,</span>
    <span class="n">is_leader</span><span class="p">,</span>
    <span class="n">is_readonly</span><span class="p">,</span>
    <span class="n">is_session_expired</span><span class="p">,</span>
    <span class="n">future_parts</span><span class="p">,</span>
    <span class="n">parts_to_check</span><span class="p">,</span>
    <span class="n">columns_version</span><span class="p">,</span>
    <span class="n">queue_size</span><span class="p">,</span>
    <span class="n">inserts_in_queue</span><span class="p">,</span>
    <span class="n">merges_in_queue</span><span class="p">,</span>
    <span class="n">log_max_index</span><span class="p">,</span>
    <span class="n">log_pointer</span><span class="p">,</span>
    <span class="n">total_replicas</span><span class="p">,</span>
    <span class="n">active_replicas</span>
<span class="k">FROM</span> <span class="k">system</span><span class="p">.</span><span class="n">replicas</span>
<span class="k">WHERE</span>
       <span class="n">is_readonly</span>
    <span class="k">OR</span> <span class="n">is_session_expired</span>
    <span class="k">OR</span> <span class="n">future_parts</span> <span class="o">&gt;</span> <span class="mi">20</span>
    <span class="k">OR</span> <span class="n">parts_to_check</span> <span class="o">&gt;</span> <span class="mi">10</span>
    <span class="k">OR</span> <span class="n">queue_size</span> <span class="o">&gt;</span> <span class="mi">20</span>
    <span class="k">OR</span> <span class="n">inserts_in_queue</span> <span class="o">&gt;</span> <span class="mi">10</span>
    <span class="k">OR</span> <span class="n">log_max_index</span> <span class="o">-</span> <span class="n">log_pointer</span> <span class="o">&gt;</span> <span class="mi">10</span>
    <span class="k">OR</span> <span class="n">total_replicas</span> <span class="o">&lt;</span> <span class="mi">2</span>
    <span class="k">OR</span> <span class="n">active_replicas</span> <span class="o">&lt;</span> <span class="n">total_replicas</span>
</pre></div>


<p>If this query doesn't return anything, it means that everything is fine.</p>
<h2 id="systemdictionaries">system.dictionaries</h2>
<p>Contains information about external dictionaries.</p>
<p>Columns:</p>
<ul>
<li><code>name String</code> – Dictionary name.</li>
<li><code>type String</code> – Dictionary type: Flat, Hashed, Cache.</li>
<li><code>origin String</code> – Path to the config file where the dictionary is described.</li>
<li><code>attribute.names Array(String)</code> – Array of attribute names provided by the dictionary.</li>
<li><code>attribute.types Array(String)</code> – Corresponding array of attribute types provided by the dictionary.</li>
<li><code>has_hierarchy UInt8</code> – Whether the dictionary is hierarchical.</li>
<li><code>bytes_allocated UInt64</code> – The amount of RAM used by the dictionary.</li>
<li><code>hit_rate Float64</code> – For cache dictionaries, the percent of usage for which the value  was in the cache.</li>
<li><code>element_count UInt64</code> – The number of items stored in the dictionary.</li>
<li><code>load_factor Float64</code> – The filled percentage of the dictionary (for a hashed dictionary, it is the filled percentage of the hash table).</li>
<li><code>creation_time DateTime</code> – Time spent for the creation or last successful reload of the dictionary.</li>
<li><code>last_exception String</code> – Text of an error that occurred when creating or reloading the dictionary, if the dictionary couldn't be created.</li>
<li><code>source String</code> – Text describing the data source for the dictionary.</li>
</ul>
<p>Note that the amount of memory used by the dictionary is not proportional to the number of items stored in it. So for flat and cached dictionaries, all the memory cells are pre-assigned, regardless of how full the dictionary actually is.</p>
<h2 id="systemclusters">system.clusters</h2>
<p>Contains information about clusters available in the config file and the servers in them.
Columns:</p>
<div class="codehilite"><pre><span></span>cluster String      – Cluster name.
shard_num UInt32    – Number of a shard in the cluster, starting from 1.
shard_weight UInt32 – Relative weight of a shard when writing data.
replica_num UInt32  – Number of a replica in the shard, starting from 1.
host_name String    – Host name as specified in the config.
host_address String – Host&#39;s IP address obtained from DNS.
port UInt16         – The port used to access the server.
user String         – The username to use for connecting to the server.
</pre></div>


<h2 id="systemfunctions">system.functions</h2>
<p>Contains information about normal and aggregate functions.</p>
<p>Columns:</p>
<ul>
<li><code>name</code> (<code>String</code>) – Function name.</li>
<li><code>is_aggregate</code> (<code>UInt8</code>) – Whether it is an aggregate function.</li>
</ul>
<h2 id="systemsettings">system.settings</h2>
<p>Contains information about settings that are currently in use.
I.e. used for executing the query you are using to read from the system.settings table).</p>
<p>Columns:</p>
<div class="codehilite"><pre><span></span>name String   – Setting name.
value String  – Setting value.
changed UInt8 - Whether the setting was explicitly defined in the config or explicitly changed.
</pre></div>


<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="k">system</span><span class="p">.</span><span class="n">settings</span>
<span class="k">WHERE</span> <span class="n">changed</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─name───────────────────┬─value───────┬─changed─┐
│ max_threads            │ 8           │       1 │
│ use_uncompressed_cache │ 0           │       1 │
│ load_balancing         │ random      │       1 │
│ max_memory_usage       │ 10000000000 │       1 │
└────────────────────────┴─────────────┴─────────┘
</pre></div>


<h2 id="systemzookeeper">system.zookeeper</h2>
<p>Allows reading data from the ZooKeeper cluster defined in the config.
The query must have a 'path' equality condition in the WHERE clause. This is the path in ZooKeeper for the children that you want to get data for.</p>
<p>The query <code>SELECT * FROM system.zookeeper WHERE path = '/clickhouse'</code> outputs data for all children on the <code>/clickhouse</code> node.
To output data for all root nodes, write path = '/'.
If the path specified in 'path' doesn't exist, an exception will be thrown.</p>
<p>Columns:</p>
<ul>
<li><code>name String</code> — Name of the node.</li>
<li><code>path String</code> — Path to the node.</li>
<li><code>value String</code> — Value of the node.</li>
<li><code>dataLength Int32</code> — Size of the value.</li>
<li><code>numChildren Int32</code> — Number of children.</li>
<li><code>czxid Int64</code> — ID of the transaction that created the node.</li>
<li><code>mzxid Int64</code> — ID of the transaction that last changed the node.</li>
<li><code>pzxid Int64</code> — ID of the transaction that last added or removed children.</li>
<li><code>ctime DateTime</code> — Time of node creation.</li>
<li><code>mtime DateTime</code> — Time of the last node modification.</li>
<li><code>version Int32</code> — Node version - the number of times the node was changed.</li>
<li><code>cversion Int32</code> — Number of added or removed children.</li>
<li><code>aversion Int32</code> — Number of changes to ACL.</li>
<li><code>ephemeralOwner Int64</code> — For ephemeral nodes, the ID of the session that owns this node.</li>
</ul>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="k">system</span><span class="p">.</span><span class="n">zookeeper</span>
<span class="k">WHERE</span> <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/clickhouse/tables/01-08/visits/replicas&#39;</span>
<span class="n">FORMAT</span> <span class="n">Vertical</span>
</pre></div>


<div class="codehilite"><pre><span></span>Row 1:
──────
name:           example01-08-1.yandex.ru
value:
czxid:          932998691229
mzxid:          932998691229
ctime:          2015-03-27 16:49:51
mtime:          2015-03-27 16:49:51
version:        0
cversion:       47
aversion:       0
ephemeralOwner: 0
dataLength:     0
numChildren:    7
pzxid:          987021031383
path:           /clickhouse/tables/01-08/visits/replicas

Row 2:
──────
name:           example01-08-2.yandex.ru
value:
czxid:          933002738135
mzxid:          933002738135
ctime:          2015-03-27 16:57:01
mtime:          2015-03-27 16:57:01
version:        0
cversion:       37
aversion:       0
ephemeralOwner: 0
dataLength:     0
numChildren:    7
pzxid:          987021252247
path:           /clickhouse/tables/01-08/visits/replicas
</pre></div>


<h2 id="table-functions">Table functions</h2>
<p>Table functions can be specified in the FROM clause instead of the database and table names.
Table functions can only be used if 'readonly' is not set.
Table functions aren't related to other functions.</p>
<p><a name="table_functions-remote"></a></p>
<h2 id="remote">remote</h2>
<p>Allows you to access remote servers without creating a <code>Distributed</code> table.</p>
<p>Signatures:</p>
<div class="codehilite"><pre><span></span><span class="n">remote</span><span class="p">(</span><span class="s1">&#39;addresses_expr&#39;</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="k">table</span><span class="p">[,</span> <span class="s1">&#39;user&#39;</span><span class="p">[,</span> <span class="s1">&#39;password&#39;</span><span class="p">]])</span>
<span class="n">remote</span><span class="p">(</span><span class="s1">&#39;addresses_expr&#39;</span><span class="p">,</span> <span class="n">db</span><span class="p">.</span><span class="k">table</span><span class="p">[,</span> <span class="s1">&#39;user&#39;</span><span class="p">[,</span> <span class="s1">&#39;password&#39;</span><span class="p">]])</span>
</pre></div>


<p><code>addresses_expr</code> – An expression that generates addresses of remote servers. This may be just one server address. The server address is <code>host:port</code>, or just <code>host</code>. The host can be specified as the server name, or as the IPv4 or IPv6 address. An IPv6 address is specified in square brackets. The port is the TCP port on the remote server. If the port is omitted, it uses <code>tcp_port</code> from the server's config file (by default, 9000).</p>
<div class="admonition important">

The port is required for an IPv6 address.

</div>

<p>Examples:</p>
<div class="codehilite"><pre><span></span>example01-01-1
example01-01-1:9000
localhost
127.0.0.1
[::]:9000
[2a02:6b8:0:1111::11]:9000
</pre></div>


<p>Multiple addresses can be comma-separated. In this case, ClickHouse will use distributed processing, so it will send the query to all specified addresses (like to shards with different data).</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span>example01-01-1,example01-02-1
</pre></div>


<p>Part of the expression can be specified in curly brackets. The previous example can be written as follows:</p>
<div class="codehilite"><pre><span></span>example01-0{1,2}-1
</pre></div>


<p>Curly brackets can contain a range of numbers separated by two dots (non-negative integers). In this case, the range is expanded to a set of values that generate shard addresses. If the first number starts with zero, the values are formed with the same zero alignment. The previous example can be written as follows:</p>
<div class="codehilite"><pre><span></span>example01-{01..02}-1
</pre></div>


<p>If you have multiple pairs of curly brackets, it generates the direct product of the corresponding sets.</p>
<p>Addresses and parts of addresses in curly brackets can be separated by the pipe symbol (|). In this case, the corresponding sets of addresses are interpreted as replicas, and the query will be sent to the first healthy replica. However, the replicas are iterated in the order currently set in the <a href="#settings-load_balancing">load_balancing</a> setting.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span>example01-{01..02}-{1|2}
</pre></div>


<p>This example specifies two shards that each have two replicas.</p>
<p>The number of addresses generated is limited by a constant. Right now this is 1000 addresses.</p>
<p>Using the <code>remote</code> table function is less optimal than creating a <code>Distributed</code> table, because in this case, the server connection is re-established for every request. In addition, if host names are set, the names are resolved, and errors are not counted when working with various replicas. When processing a large number of queries, always create the <code>Distributed</code> table ahead of time, and don't use the <code>remote</code> table function.</p>
<p>The <code>remote</code> table function can be useful in the following cases:</p>
<ul>
<li>Accessing a specific server for data comparison, debugging, and testing.</li>
<li>Queries between various ClickHouse clusters for research purposes.</li>
<li>Infrequent distributed requests that are made manually.</li>
<li>Distributed requests where the set of servers is re-defined each time.</li>
</ul>
<p>If the user is not specified, <code>default</code> is used.
If the password is not specified, an empty password is used.</p>
<h2 id="merge_1">merge</h2>
<p><code>merge(db_name, 'tables_regexp')</code> – Creates a temporary Merge table. For more information, see the section "Table engines, Merge".</p>
<p>The table structure is taken from the first table encountered that matches the regular expression.</p>
<h2 id="numbers">numbers</h2>
<p><code>numbers(N)</code> – Returns a table with the single 'number' column (UInt64) that contains integers from 0 to N-1.</p>
<p>Similar to the <code>system.numbers</code> table, it can be used for testing and generating successive values.</p>
<p>The following two queries are equivalent:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">numbers</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="k">system</span><span class="p">.</span><span class="n">numbers</span> <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>


<p>Examples:</p>
<div class="codehilite"><pre><span></span><span class="c1">-- Generate a sequence of dates from 2010-01-01 to 2010-12-31</span>
<span class="k">select</span> <span class="n">toDate</span><span class="p">(</span><span class="s1">&#39;2010-01-01&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">number</span> <span class="k">as</span> <span class="n">d</span> <span class="k">FROM</span> <span class="n">numbers</span><span class="p">(</span><span class="mi">365</span><span class="p">);</span>
</pre></div>


<p><a name="formats"></a></p>
<h2 id="formats">Formats</h2>
<p>The format determines how data is returned to you after SELECTs (how it is written and formatted by the server), and how it is accepted for INSERTs (how it is read and parsed by the server).</p>
<h2 id="tabseparated">TabSeparated</h2>
<p>In TabSeparated format, data is written by row. Each row contains values separated by tabs. Each value is follow by a tab, except the last value in the row, which is followed by a line feed. Strictly Unix line feeds are assumed everywhere. The last row also must contain a line feed at the end. Values are written in text format, without enclosing quotation marks, and with special characters escaped.</p>
<p>Integer numbers are written in decimal form. Numbers can contain an extra "+" character at the beginning (ignored when parsing, and not recorded when formatting). Non-negative numbers can't contain the negative sign. When reading, it is allowed to parse an empty string as a zero, or (for signed types) a string consisting of just a minus sign as a zero. Numbers that do not fit into the corresponding data type may be parsed as a different number, without an error message.</p>
<p>Floating-point numbers are written in decimal form. The dot is used as the decimal separator. Exponential entries are supported, as are 'inf', '+inf', '-inf', and 'nan'. An entry of floating-point numbers may begin or end with a decimal point.
During formatting, accuracy may be lost on floating-point numbers.
During parsing, it is not strictly required to read the nearest machine-representable number.</p>
<p>Dates are written in YYYY-MM-DD format and parsed in the same format, but with any characters as separators.
Dates with times are written in the format YYYY-MM-DD hh:mm:ss and parsed in the same format, but with any characters as separators.
This all occurs in the system time zone at the time the client or server starts (depending on which one formats data). For dates with times, daylight saving time is not specified. So if a dump has times during daylight saving time, the dump does not unequivocally match the data, and parsing will select one of the two times.
During a read operation, incorrect dates and dates with times can be parsed with natural overflow or as null dates and times, without an error message.</p>
<p>As an exception, parsing dates with times is also supported in Unix timestamp format, if it consists of exactly 10 decimal digits. The result is not time zone-dependent. The formats YYYY-MM-DD hh:mm:ss and NNNNNNNNNN are differentiated automatically.</p>
<p>Strings are output with backslash-escaped special characters. The following escape sequences are used for output: <code>\b</code>, <code>\f</code>, <code>\r</code>, <code>\n</code>, <code>\t</code>, <code>\0</code>, <code>\'</code>, <code>\\</code>. Parsing also supports the sequences <code>\a</code>, <code>\v</code>, and <code>\xHH</code>  (hex escape sequences) and any <code>\c</code> sequences, where <code>c</code> is any character (these sequences are converted to <code>c</code>). Thus, reading data supports formats where a line feed can be written as <code>\n</code>  or <code>\</code>, or as a line feed. For example, the string <code>Hello world</code> with a line feed between the words instead of a space can be parsed in any of the following variations:</p>
<div class="codehilite"><pre><span></span>Hello\nworld

Hello\
world
</pre></div>


<p>The second variant is supported because MySQL uses it when writing tab-separated dumps.</p>
<p>The minimum set of characters that you need to escape when passing data in TabSeparated format: tab, line feed (LF) and backslash.</p>
<p>Only a small set of symbols are escaped. You can easily stumble onto a string value that your terminal will ruin in output.</p>
<p>Arrays are written as a list of comma-separated values in square brackets. Number items in the array are fomratted as normally, but dates, dates with times, and strings are written in single quotes with the same escaping rules as above.</p>
<p>The TabSeparated format is convenient for processing data using custom programs and scripts. It is used by default in the HTTP interface, and in the command-line client's batch mode. This format also allows transferring data between different DBMSs. For example, you can get a dump from MySQL and upload it to ClickHouse, or vice versa.</p>
<p>The TabSeparated format supports outputting total values (when using WITH TOTALS) and extreme values (when 'extremes' is set to 1). In these cases, the total values and extremes are output after the main data. The main result, total values, and extremes are separated from each other by an empty line. Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">EventDate</span><span class="p">,</span> <span class="k">count</span><span class="p">()</span> <span class="k">AS</span> <span class="k">c</span> <span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">hits</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">EventDate</span> <span class="k">WITH</span> <span class="n">TOTALS</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">EventDate</span> <span class="n">FORMAT</span> <span class="n">TabSeparated</span><span class="o">``</span>
</pre></div>


<div class="codehilite"><pre><span></span>2014-03-17      1406958
2014-03-18      1383658
2014-03-19      1405797
2014-03-20      1353623
2014-03-21      1245779
2014-03-22      1031592
2014-03-23      1046491

0000-00-00      8873898

2014-03-17      1031592
2014-03-23      1406958
</pre></div>


<p>This format is also available under the name <code>TSV</code>.</p>
<h2 id="tabseparatedraw">TabSeparatedRaw</h2>
<p>Differs from <code>TabSeparated</code> format in that the rows are written without escaping.
This format is only appropriate for outputting a query result, but not for parsing (retrieving data to insert in a table).</p>
<p>This format is also available under the name <code>TSVRaw</code>.</p>
<h2 id="tabseparatedwithnames">TabSeparatedWithNames</h2>
<p>Differs from the <code>TabSeparated</code> format in that the column names are written in the first row.
During parsing, the first row is completely ignored. You can't use column names to determine their position or to check their correctness.
(Support for parsing the header row may be added in the future.)</p>
<p>This format is also available under the name <code>TSVWithNames</code>.</p>
<h2 id="tabseparatedwithnamesandtypes">TabSeparatedWithNamesAndTypes</h2>
<p>Differs from the <code>TabSeparated</code> format in that the column names are written to the first row, while the column types are in the second row.
During parsing, the first and second rows are completely ignored.</p>
<p>This format is also available under the name <code>TSVWithNamesAndTypes</code>.</p>
<h2 id="csv">CSV</h2>
<p>Comma Separated Values format (<a href="https://tools.ietf.org/html/rfc4180">RFC</a>).</p>
<p>When formatting, rows are enclosed in double quotes. A double quote inside a string is output as two double quotes in a row. There are no other rules for escaping characters. Date and date-time are enclosed in double quotes. Numbers are output without quotes. Values ​​are separated by a delimiter&ast;. Rows are separated using the Unix line feed (LF). Arrays are serialized in CSV as follows: first the array is serialized to a string as in TabSeparated format, and then the resulting string is output to CSV in double quotes. Tuples in CSV format are serialized as separate columns (that is, their nesting in the tuple is lost).</p>
<p>&ast;By default — <code>,</code>. See a <a href="#format_csv_delimiter">format_csv_delimiter</a> setting for additional info.</p>
<p>When parsing, all values can be parsed either with or without quotes. Both double and single quotes are supported. Rows can also be arranged without quotes. In this case, they are parsed up to a delimiter or line feed (CR or LF). In violation of the RFC, when parsing rows without quotes, the leading and trailing spaces and tabs are ignored. For the line feed, Unix (LF), Windows (CR LF) and Mac OS Classic (CR LF) are all supported.</p>
<p>The CSV format supports the output of totals and extremes the same way as <code>TabSeparated</code>.</p>
<h2 id="csvwithnames">CSVWithNames</h2>
<p>Also prints the header row, similar to <code>TabSeparatedWithNames</code>.</p>
<h2 id="values">Values</h2>
<p>Prints every row in brackets. Rows are separated by commas. There is no comma after the last row. The values inside the brackets are also comma-separated. Numbers are output in decimal format without quotes. Arrays are output in square brackets. Strings, dates, and dates with times are output in quotes. Escaping rules and parsing are similar to the TabSeparated format. During formatting, extra spaces aren't inserted, but during parsing, they are allowed and skipped (except for spaces inside array values, which are not allowed).</p>
<p>The minimum set of characters that you need to escape when passing data in Values ​​format: single quotes and backslashes.</p>
<p>This is the format that is used in <code>INSERT INTO t VALUES ...</code>, but you can also use it for formatting query results.</p>
<h2 id="vertical">Vertical</h2>
<p>Prints each value on a separate line with the column name specified. This format is convenient for printing just one or a few rows, if each row consists of a large number of columns.
This format is only appropriate for outputting a query result, but not for parsing (retrieving data to insert in a table).</p>
<h2 id="verticalraw">VerticalRaw</h2>
<p>Differs from <code>Vertical</code> format in that the rows are not escaped.
This format is only appropriate for outputting a query result, but not for parsing (retrieving data to insert in a table).</p>
<p>Examples:</p>
<div class="codehilite"><pre><span></span>:) SHOW CREATE TABLE geonames FORMAT VerticalRaw;
Row 1:
──────
statement: CREATE TABLE default.geonames ( geonameid UInt32, date Date DEFAULT CAST(&#39;2017-12-08&#39; AS Date)) ENGINE = MergeTree(date, geonameid, 8192)

:) SELECT &#39;string with \&#39;quotes\&#39; and \t with some special \n characters&#39; AS test FORMAT VerticalRaw;
Row 1:
──────
test: string with &#39;quotes&#39; and   with some special
 characters
</pre></div>


<p>Compare with the Vertical format:</p>
<div class="codehilite"><pre><span></span>:) SELECT &#39;string with \&#39;quotes\&#39; and \t with some special \n characters&#39; AS test FORMAT Vertical;
Row 1:
──────
test: string with \&#39;quotes\&#39; and \t with some special \n characters
</pre></div>


<h2 id="json">JSON</h2>
<p>Outputs data in JSON format. Besides data tables, it also outputs column names and types, along with some additional information: the total number of output rows, and the number of rows that could have been output if there weren't a LIMIT. Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">SearchPhrase</span><span class="p">,</span> <span class="k">count</span><span class="p">()</span> <span class="k">AS</span> <span class="k">c</span> <span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">hits</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">SearchPhrase</span> <span class="k">WITH</span> <span class="n">TOTALS</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">c</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">5</span> <span class="n">FORMAT</span> <span class="n">JSON</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="p">{</span>
        <span class="nt">&quot;meta&quot;</span><span class="p">:</span>
        <span class="p">[</span>
                <span class="p">{</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;SearchPhrase&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;String&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;UInt64&quot;</span>
                <span class="p">}</span>
        <span class="p">],</span>

        <span class="nt">&quot;data&quot;</span><span class="p">:</span>
        <span class="p">[</span>
                <span class="p">{</span>
                        <span class="nt">&quot;SearchPhrase&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;8267016&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                        <span class="nt">&quot;SearchPhrase&quot;</span><span class="p">:</span> <span class="s2">&quot;bathroom interior design&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;2166&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                        <span class="nt">&quot;SearchPhrase&quot;</span><span class="p">:</span> <span class="s2">&quot;yandex&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;1655&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                        <span class="nt">&quot;SearchPhrase&quot;</span><span class="p">:</span> <span class="s2">&quot;spring 2014 fashion&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;1549&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                        <span class="nt">&quot;SearchPhrase&quot;</span><span class="p">:</span> <span class="s2">&quot;freeform photos&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;1480&quot;</span>
                <span class="p">}</span>
        <span class="p">],</span>

        <span class="nt">&quot;totals&quot;</span><span class="p">:</span>
        <span class="p">{</span>
                <span class="nt">&quot;SearchPhrase&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="nt">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;8873898&quot;</span>
        <span class="p">},</span>

        <span class="nt">&quot;extremes&quot;</span><span class="p">:</span>
        <span class="p">{</span>
                <span class="nt">&quot;min&quot;</span><span class="p">:</span>
                <span class="p">{</span>
                        <span class="nt">&quot;SearchPhrase&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;1480&quot;</span>
                <span class="p">},</span>
                <span class="nt">&quot;max&quot;</span><span class="p">:</span>
                <span class="p">{</span>
                        <span class="nt">&quot;SearchPhrase&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;8267016&quot;</span>
                <span class="p">}</span>
        <span class="p">},</span>

        <span class="nt">&quot;rows&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>

        <span class="nt">&quot;rows_before_limit_at_least&quot;</span><span class="p">:</span> <span class="mi">141137</span>
<span class="p">}</span>
</pre></div>


<p>The JSON is compatible with JavaScript. To ensure this, some characters are additionally escaped: the slash <code>/</code>  is escaped as <code>\/</code>; alternative line breaks <code>U+2028</code> and <code>U+2029</code>, which break some browsers, are escaped as <code>\uXXXX</code>. ASCII control characters are escaped: backspace, form feed, line feed, carriage return, and horizontal tab are replaced with <code>\b</code>, <code>\f</code>, <code>\n</code>, <code>\r</code>, <code>\t</code>  , as well as the remaining bytes in the 00-1F range using <code>\uXXXX</code> sequences. Invalid UTF-8 sequences are changed to the replacement character � so the output text will consist of valid UTF-8 sequences. For compatibility with JavaScript, Int64 and UInt64 integers are enclosed in double quotes  by default. To remove the quotes, you can set the configuration parameter output_format_json_quote_64bit_integers to 0.</p>
<p><code>rows</code> – The total number of output rows.</p>
<p><code>rows_before_limit_at_least</code> The minimal number of rows there would have been without LIMIT. Output only if the query contains LIMIT.
If the query contains GROUP BY, rows_before_limit_at_least is the exact number of rows there would have been without a LIMIT.</p>
<p><code>totals</code> – Total values (when using WITH TOTALS).</p>
<p><code>extremes</code> – Extreme values (when extremes is set to 1).</p>
<p>This format is only appropriate for outputting a query result, but not for parsing (retrieving data to insert in a table).
See also the JSONEachRow format.</p>
<h2 id="jsoncompact">JSONCompact</h2>
<p>Differs from JSON only in that data rows are output in arrays, not in objects.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
        <span class="nt">&quot;meta&quot;</span><span class="p">:</span>
        <span class="p">[</span>
                <span class="p">{</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;SearchPhrase&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;String&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;UInt64&quot;</span>
                <span class="p">}</span>
        <span class="p">],</span>

        <span class="nt">&quot;data&quot;</span><span class="p">:</span>
        <span class="p">[</span>
                <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;8267016&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;bathroom interior design&quot;</span><span class="p">,</span> <span class="s2">&quot;2166&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;yandex&quot;</span><span class="p">,</span> <span class="s2">&quot;1655&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;spring 2014 fashion&quot;</span><span class="p">,</span> <span class="s2">&quot;1549&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;freeform photos&quot;</span><span class="p">,</span> <span class="s2">&quot;1480&quot;</span><span class="p">]</span>
        <span class="p">],</span>

        <span class="nt">&quot;totals&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;8873898&quot;</span><span class="p">],</span>

        <span class="nt">&quot;extremes&quot;</span><span class="p">:</span>
        <span class="p">{</span>
                <span class="nt">&quot;min&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;1480&quot;</span><span class="p">],</span>
                <span class="nt">&quot;max&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;8267016&quot;</span><span class="p">]</span>
        <span class="p">},</span>

        <span class="nt">&quot;rows&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>

        <span class="nt">&quot;rows_before_limit_at_least&quot;</span><span class="p">:</span> <span class="mi">141137</span>
<span class="p">}</span>
</pre></div>


<p>This format is only appropriate for outputting a query result, but not for parsing (retrieving data to insert in a table).
See also the <code>JSONEachRow</code> format.</p>
<h2 id="jsoneachrow">JSONEachRow</h2>
<p>Outputs data as separate JSON objects for each row (newline delimited JSON).</p>
<div class="codehilite"><pre><span></span><span class="p">{</span><span class="nt">&quot;SearchPhrase&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="nt">&quot;count()&quot;</span><span class="p">:</span><span class="s2">&quot;8267016&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;SearchPhrase&quot;</span><span class="p">:</span><span class="s2">&quot;bathroom interior design&quot;</span><span class="p">,</span><span class="nt">&quot;count()&quot;</span><span class="p">:</span><span class="s2">&quot;2166&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;SearchPhrase&quot;</span><span class="p">:</span><span class="s2">&quot;yandex&quot;</span><span class="p">,</span><span class="nt">&quot;count()&quot;</span><span class="p">:</span><span class="s2">&quot;1655&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;SearchPhrase&quot;</span><span class="p">:</span><span class="s2">&quot;spring 2014 fashion&quot;</span><span class="p">,</span><span class="nt">&quot;count()&quot;</span><span class="p">:</span><span class="s2">&quot;1549&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;SearchPhrase&quot;</span><span class="p">:</span><span class="s2">&quot;freeform photo&quot;</span><span class="p">,</span><span class="nt">&quot;count()&quot;</span><span class="p">:</span><span class="s2">&quot;1480&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;SearchPhrase&quot;</span><span class="p">:</span><span class="s2">&quot;angelina jolie&quot;</span><span class="p">,</span><span class="nt">&quot;count()&quot;</span><span class="p">:</span><span class="s2">&quot;1245&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;SearchPhrase&quot;</span><span class="p">:</span><span class="s2">&quot;omsk&quot;</span><span class="p">,</span><span class="nt">&quot;count()&quot;</span><span class="p">:</span><span class="s2">&quot;1112&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;SearchPhrase&quot;</span><span class="p">:</span><span class="s2">&quot;photos of dog breeds&quot;</span><span class="p">,</span><span class="nt">&quot;count()&quot;</span><span class="p">:</span><span class="s2">&quot;1091&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;SearchPhrase&quot;</span><span class="p">:</span><span class="s2">&quot;curtain design&quot;</span><span class="p">,</span><span class="nt">&quot;count()&quot;</span><span class="p">:</span><span class="s2">&quot;1064&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;SearchPhrase&quot;</span><span class="p">:</span><span class="s2">&quot;baku&quot;</span><span class="p">,</span><span class="nt">&quot;count()&quot;</span><span class="p">:</span><span class="s2">&quot;1000&quot;</span><span class="p">}</span>
</pre></div>


<p>Unlike the JSON format, there is no substitution of invalid UTF-8 sequences. Any set of bytes can be output in the rows. This is necessary so that data can be formatted without losing any information. Values are escaped in the same way as for JSON.</p>
<p>For parsing, any order is supported for the values of different columns. It is acceptable for some values to be omitted – they are treated as equal to their default values. In this case, zeros and blank rows are used as default values. Complex values that could be specified in the table are not supported as defaults. Whitespace between elements is ignored. If a comma is placed after the objects, it is ignored. Objects don't necessarily have to be separated by new lines.</p>
<h2 id="tskv">TSKV</h2>
<p>Similar to TabSeparated, but outputs a value in name=value format. Names are escaped the same way as in TabSeparated format, and the = symbol is also escaped.</p>
<div class="codehilite"><pre><span></span>SearchPhrase=   count()=8267016
SearchPhrase=bathroom interior design    count()=2166
SearchPhrase=yandex     count()=1655
SearchPhrase=spring 2014 fashion    count()=1549
SearchPhrase=freeform photos       count()=1480
SearchPhrase=angelina jolia    count()=1245
SearchPhrase=omsk       count()=1112
SearchPhrase=photos of dog breeds    count()=1091
SearchPhrase=curtain design        count()=1064
SearchPhrase=baku       count()=1000
</pre></div>


<p>When there is a large number of small columns, this format is ineffective, and there is generally no reason to use it. It is used in some departments of Yandex.</p>
<p>Both data output and parsing are supported in this format. For parsing, any order is supported for the values of different columns. It is acceptable for some values to be omitted – they are treated as equal to their default values. In this case, zeros and blank rows are used as default values. Complex values that could be specified in the table are not supported as defaults.</p>
<p>Parsing allows the presence of the additional field <code>tskv</code> without the equal sign or a value. This field is ignored.</p>
<h2 id="pretty">Pretty</h2>
<p>Outputs data as Unicode-art tables, also using ANSI-escape sequences for setting colors in the terminal.
A full grid of the table is drawn, and each row occupies two lines in the terminal.
Each result block is output as a separate table. This is necessary so that blocks can be output without buffering results (buffering would be necessary in order to pre-calculate the visible width of all the values).
To avoid dumping too much data to the terminal, only the first 10,000 rows are printed. If the number of rows is greater than or equal to 10,000, the message "Showed first 10 000" is printed.
This format is only appropriate for outputting a query result, but not for parsing (retrieving data to insert in a table).</p>
<p>The Pretty format supports outputting total values (when using WITH TOTALS) and extremes (when 'extremes' is set to 1). In these cases, total values and extreme values are output after the main data, in separate tables. Example (shown for the PrettyCompact format):</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">EventDate</span><span class="p">,</span> <span class="k">count</span><span class="p">()</span> <span class="k">AS</span> <span class="k">c</span> <span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">hits</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">EventDate</span> <span class="k">WITH</span> <span class="n">TOTALS</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">EventDate</span> <span class="n">FORMAT</span> <span class="n">PrettyCompact</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌──EventDate─┬───────c─┐
│ 2014-03-17 │ 1406958 │
│ 2014-03-18 │ 1383658 │
│ 2014-03-19 │ 1405797 │
│ 2014-03-20 │ 1353623 │
│ 2014-03-21 │ 1245779 │
│ 2014-03-22 │ 1031592 │
│ 2014-03-23 │ 1046491 │
└────────────┴─────────┘

Totals:
┌──EventDate─┬───────c─┐
│ 0000-00-00 │ 8873898 │
└────────────┴─────────┘

Extremes:
┌──EventDate─┬───────c─┐
│ 2014-03-17 │ 1031592 │
│ 2014-03-23 │ 1406958 │
└────────────┴─────────┘
</pre></div>


<h2 id="prettycompact">PrettyCompact</h2>
<p>Differs from <code>Pretty</code> in that the grid is drawn between rows and the result is more compact.
This format is used by default in the command-line client in interactive mode.</p>
<h2 id="prettycompactmonoblock">PrettyCompactMonoBlock</h2>
<p>Differs from <code>PrettyCompact</code> in that up to 10,000 rows are buffered, then output as a single table, not by blocks.</p>
<h2 id="prettynoescapes">PrettyNoEscapes</h2>
<p>Differs from Pretty in that ANSI-escape sequences aren't used. This is necessary for displaying this format in a browser, as well as for using the 'watch' command-line utility.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span>watch -n1 <span class="s2">&quot;clickhouse-client --query=&#39;SELECT * FROM system.events FORMAT PrettyCompactNoEscapes&#39;&quot;</span>
</pre></div>


<p>You can use the HTTP interface for displaying in the browser.</p>
<h3 id="prettycompactnoescapes">PrettyCompactNoEscapes</h3>
<p>The same as the previous setting.</p>
<h3 id="prettyspacenoescapes">PrettySpaceNoEscapes</h3>
<p>The same as the previous setting.</p>
<h2 id="prettyspace">PrettySpace</h2>
<p>Differs from <code>PrettyCompact</code> in that whitespace (space characters) is used instead of the grid.</p>
<h2 id="rowbinary">RowBinary</h2>
<p>Formats and parses data by row in binary format. Rows and values are listed consecutively, without separators.
This format is less efficient than the Native format, since it is row-based.</p>
<p>Integers use fixed-length little endian representation. For example, UInt64 uses 8 bytes.
DateTime is represented as UInt32 containing the Unix timestamp as the value.
Date is represented as a UInt16 object that contains the number of days since 1970-01-01 as the value.
String is represented as a varint length (unsigned <a href="https://en.wikipedia.org/wiki/LEB128">LEB128</a>), followed by the bytes of the string.
FixedString is represented simply as a sequence of bytes.</p>
<p>Array is represented as a varint length (unsigned <a href="https://en.wikipedia.org/wiki/LEB128">LEB128</a>), followed by successive elements of the array.</p>
<h2 id="native">Native</h2>
<p>The most efficient format. Data is written and read by blocks in binary format. For each block, the number of rows, number of columns, column names and types, and parts of columns in this block are recorded one after another. In other words, this format is "columnar" – it doesn't convert columns to rows. This is the format used in the native interface for interaction between servers, for using the command-line client, and for C++ clients.</p>
<p>You can use this format to quickly generate dumps that can only be read by the ClickHouse DBMS. It doesn't make sense to work with this format yourself.</p>
<h2 id="null_1">Null</h2>
<p>Nothing is output. However, the query is processed, and when using the command-line client, data is transmitted to the client. This is used for tests, including productivity testing.
Obviously, this format is only appropriate for output, not for parsing.</p>
<h2 id="xml">XML</h2>
<p>XML format is suitable only for output, not for parsing. Example:</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?xml version=&#39;1.0&#39; encoding=&#39;UTF-8&#39; ?&gt;</span>
<span class="nt">&lt;result&gt;</span>
        <span class="nt">&lt;meta&gt;</span>
                <span class="nt">&lt;columns&gt;</span>
                        <span class="nt">&lt;column&gt;</span>
                                <span class="nt">&lt;name&gt;</span>SearchPhrase<span class="nt">&lt;/name&gt;</span>
                                <span class="nt">&lt;type&gt;</span>String<span class="nt">&lt;/type&gt;</span>
                        <span class="nt">&lt;/column&gt;</span>
                        <span class="nt">&lt;column&gt;</span>
                                <span class="nt">&lt;name&gt;</span>count()<span class="nt">&lt;/name&gt;</span>
                                <span class="nt">&lt;type&gt;</span>UInt64<span class="nt">&lt;/type&gt;</span>
                        <span class="nt">&lt;/column&gt;</span>
                <span class="nt">&lt;/columns&gt;</span>
        <span class="nt">&lt;/meta&gt;</span>
        <span class="nt">&lt;data&gt;</span>
                <span class="nt">&lt;row&gt;</span>
                        <span class="nt">&lt;SearchPhrase&gt;&lt;/SearchPhrase&gt;</span>
                        <span class="nt">&lt;field&gt;</span>8267016<span class="nt">&lt;/field&gt;</span>
                <span class="nt">&lt;/row&gt;</span>
                <span class="nt">&lt;row&gt;</span>
                        <span class="nt">&lt;SearchPhrase&gt;</span>bathroom interior design<span class="nt">&lt;/SearchPhrase&gt;</span>
                        <span class="nt">&lt;field&gt;</span>2166<span class="nt">&lt;/field&gt;</span>
                <span class="nt">&lt;/row&gt;</span>
                <span class="nt">&lt;row&gt;</span>
                        <span class="nt">&lt;SearchPhrase&gt;</span>yandex<span class="nt">&lt;/SearchPhrase&gt;</span>
                        <span class="nt">&lt;field&gt;</span>1655<span class="nt">&lt;/field&gt;</span>
                <span class="nt">&lt;/row&gt;</span>
                <span class="nt">&lt;row&gt;</span>
                        <span class="nt">&lt;SearchPhrase&gt;</span>spring 2014 fashion<span class="nt">&lt;/SearchPhrase&gt;</span>
                        <span class="nt">&lt;field&gt;</span>1549<span class="nt">&lt;/field&gt;</span>
                <span class="nt">&lt;/row&gt;</span>
                <span class="nt">&lt;row&gt;</span>
                        <span class="nt">&lt;SearchPhrase&gt;</span>freeform photos<span class="nt">&lt;/SearchPhrase&gt;</span>
                        <span class="nt">&lt;field&gt;</span>1480<span class="nt">&lt;/field&gt;</span>
                <span class="nt">&lt;/row&gt;</span>
                <span class="nt">&lt;row&gt;</span>
                        <span class="nt">&lt;SearchPhrase&gt;</span>angelina jolie<span class="nt">&lt;/SearchPhrase&gt;</span>
                        <span class="nt">&lt;field&gt;</span>1245<span class="nt">&lt;/field&gt;</span>
                <span class="nt">&lt;/row&gt;</span>
                <span class="nt">&lt;row&gt;</span>
                        <span class="nt">&lt;SearchPhrase&gt;</span>omsk<span class="nt">&lt;/SearchPhrase&gt;</span>
                        <span class="nt">&lt;field&gt;</span>1112<span class="nt">&lt;/field&gt;</span>
                <span class="nt">&lt;/row&gt;</span>
                <span class="nt">&lt;row&gt;</span>
                        <span class="nt">&lt;SearchPhrase&gt;</span>photos of dog breeds<span class="nt">&lt;/SearchPhrase&gt;</span>
                        <span class="nt">&lt;field&gt;</span>1091<span class="nt">&lt;/field&gt;</span>
                <span class="nt">&lt;/row&gt;</span>
                <span class="nt">&lt;row&gt;</span>
                        <span class="nt">&lt;SearchPhrase&gt;</span>curtain design<span class="nt">&lt;/SearchPhrase&gt;</span>
                        <span class="nt">&lt;field&gt;</span>1064<span class="nt">&lt;/field&gt;</span>
                <span class="nt">&lt;/row&gt;</span>
                <span class="nt">&lt;row&gt;</span>
                        <span class="nt">&lt;SearchPhrase&gt;</span>baku<span class="nt">&lt;/SearchPhrase&gt;</span>
                        <span class="nt">&lt;field&gt;</span>1000<span class="nt">&lt;/field&gt;</span>
                <span class="nt">&lt;/row&gt;</span>
        <span class="nt">&lt;/data&gt;</span>
        <span class="nt">&lt;rows&gt;</span>10<span class="nt">&lt;/rows&gt;</span>
        <span class="nt">&lt;rows_before_limit_at_least&gt;</span>141137<span class="nt">&lt;/rows_before_limit_at_least&gt;</span>
<span class="nt">&lt;/result&gt;</span>
</pre></div>


<p>If the column name does not have an acceptable format, just 'field' is used as the element name. In general, the XML structure follows the JSON structure.
Just as for JSON, invalid UTF-8 sequences are changed to the replacement character � so the output text will consist of valid UTF-8 sequences.</p>
<p>In string values, the characters <code>&lt;</code> and <code>&amp;</code> are escaped as <code>&lt;</code> and <code>&amp;</code>.</p>
<p>Arrays are output as <code>&lt;array&gt;&lt;elem&gt;Hello&lt;/elem&gt;&lt;elem&gt;World&lt;/elem&gt;...&lt;/array&gt;</code>,
and tuples as <code>&lt;tuple&gt;&lt;elem&gt;Hello&lt;/elem&gt;&lt;elem&gt;World&lt;/elem&gt;...&lt;/tuple&gt;</code>.</p>
<p><a name="format_capnproto"></a></p>
<h2 id="capnproto">CapnProto</h2>
<p>Cap'n Proto is a binary message format similar to Protocol Buffers and Thrift, but not like JSON or MessagePack.</p>
<p>Cap'n Proto messages are strictly typed and not self-describing, meaning they need an external schema description. The schema is applied on the fly and cached for each query.</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">SearchPhrase</span><span class="p">,</span> <span class="k">count</span><span class="p">()</span> <span class="k">AS</span> <span class="k">c</span> <span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">hits</span>
       <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">SearchPhrase</span> <span class="n">FORMAT</span> <span class="n">CapnProto</span> <span class="n">SETTINGS</span> <span class="k">schema</span> <span class="o">=</span> <span class="s1">&#39;schema:Message&#39;</span>
</pre></div>


<p>Where <code>schema.capnp</code> looks like this:</p>
<div class="codehilite"><pre><span></span><span class="k">struct</span> <span class="n">Message</span> <span class="p">{</span>
  <span class="n">SearchPhrase</span> <span class="mi">@0</span> <span class="o">:</span><span class="n">Text</span><span class="p">;</span>
  <span class="n">c</span> <span class="mi">@1</span> <span class="o">:</span><span class="n">Uint64</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>Schema files are in the file that is located in the directory specified in <a href="#server_settings-format_schema_path"> format_schema_path</a> in the server configuration.</p>
<p>Deserialization is effective and usually doesn't increase the system load.</p>
<p><a name="data_types"></a></p>
<h2 id="data-types">Data types</h2>
<p>ClickHouse can store various types of data in table cells.</p>
<p>This section describes the supported data types and special considerations when using and/or implementing them, if any.</p>
<h2 id="uint8-uint16-uint32-uint64-int8-int16-int32-int64">UInt8, UInt16, UInt32, UInt64, Int8, Int16, Int32, Int64</h2>
<p>Fixed-length integers, with or without a sign.</p>
<h3 id="int-ranges">Int ranges</h3>
<ul>
<li>Int8 - [-128 : 127]</li>
<li>Int16 - [-32768 : 32767]</li>
<li>Int32 - [-2147483648 : 2147483647]</li>
<li>Int64 - [-9223372036854775808 : 9223372036854775807]</li>
</ul>
<h3 id="uint-ranges">Uint ranges</h3>
<ul>
<li>UInt8 - [0 : 255]</li>
<li>UInt16 - [0 : 65535]</li>
<li>UInt32 - [0 : 4294967295]</li>
<li>UInt64 - [0 : 18446744073709551615]</li>
</ul>
<h2 id="float32-float64">Float32, Float64</h2>
<p><a href="https://en.wikipedia.org/wiki/IEEE_754">Floating point numbers</a>.</p>
<p>Types are equivalent to types of C:</p>
<ul>
<li><code>Float32</code> - <code>float</code></li>
<li><code>Float64</code>  - <code>double</code></li>
</ul>
<p>We recommend that you store data in integer form whenever possible. For example, convert fixed precision numbers to integer values, such as monetary amounts or page load times in milliseconds.</p>
<h3 id="using-floating-point-numbers">Using floating-point numbers</h3>
<ul>
<li>Computations with floating-point numbers might produce a rounding error.</li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">0</span><span class="p">.</span><span class="mi">9</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌───────minus(1, 0.9)─┐
│ 0.09999999999999998 │
└─────────────────────┘
</pre></div>


<ul>
<li>The result of the calculation depends on the calculation method (the processor type and architecture of the computer system).</li>
<li>Floating-point calculations might result in numbers such as infinity (<code>Inf</code>) and "not-a-number" (<code>NaN</code>). This should be taken into account when processing the results of calculations.</li>
<li>When reading floating point numbers from rows, the result might not be the nearest machine-representable number.</li>
</ul>
<h3 id="nan-and-inf">NaN and Inf</h3>
<p>In contrast to standard SQL, ClickHouse supports the following categories of floating-point numbers:</p>
<ul>
<li><code>Inf</code> – Infinity.</li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="o">/</span> <span class="mi">0</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─divide(0.5, 0)─┐
│            inf │
└────────────────┘
</pre></div>


<ul>
<li><code>-Inf</code> – Negative infinity.</li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="o">/</span> <span class="mi">0</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─divide(-0.5, 0)─┐
│            -inf │
└─────────────────┘
</pre></div>


<ul>
<li><code>NaN</code> – Not a number.</li>
</ul>
<div class="codehilite"><pre><span></span>SELECT 0 / 0
</pre></div>


<div class="codehilite"><pre><span></span>┌─divide(0, 0)─┐
│          nan │
└──────────────┘
</pre></div>


<p>See the rules for <code>NaN</code> sorting in the section <a href="#query_language-queries-order_by">ORDER BY clause</a>.</p>
<h2 id="boolean-values">Boolean values</h2>
<p>There isn't a separate type for boolean values. They use the UInt8 type, restricted to the values 0 or 1.</p>
<h2 id="string">String</h2>
<p>Strings of an arbitrary length. The length is not limited. The value can contain an arbitrary set of bytes, including null bytes.
The String type replaces the types VARCHAR, BLOB, CLOB, and others from other DBMSs.</p>
<h3 id="encodings">Encodings</h3>
<p>ClickHouse doesn't have the concept of encodings. Strings can contain an arbitrary set of bytes, which are stored and output as-is.
If you need to store texts, we recommend using UTF-8 encoding. At the very least, if your terminal uses UTF-8 (as recommended), you can read and write your values without making conversions.
Similarly, certain functions for working with strings have separate variations that work under the assumption that the string contains a set of bytes representing a UTF-8 encoded text.
For example, the 'length' function calculates the string length in bytes, while the 'lengthUTF8' function calculates the string length in Unicode code points, assuming that the value is UTF-8 encoded.</p>
<h2 id="fixedstringn">FixedString(N)</h2>
<p>A fixed-length string of N bytes (not characters or code points). N must be a strictly positive natural number.
When the server reads a string that contains fewer bytes (such as when parsing INSERT data), the string is padded to N bytes by appending null bytes at the right.
When the server reads a string that contains more bytes, an error message is returned.
When the server writes a string (such as when outputting the result of a SELECT query), null bytes are not trimmed off of the end of the string, but are output.
Note that this behavior differs from MySQL behavior for the CHAR type (where strings are padded with spaces, and the spaces are removed for output).</p>
<p>Fewer functions can work with the FixedString(N) type than with String, so it is less convenient to use.</p>
<h2 id="date">Date</h2>
<p>A date. Stored in two bytes as the number of days since 1970-01-01 (unsigned). Allows storing values from just after the beginning of the Unix Epoch to the upper threshold defined by a constant at the compilation stage (currently, this is until the year 2106, but the final fully-supported year is 2105).
The minimum value is output as 0000-00-00.</p>
<p>The date is stored without the time zone.</p>
<h2 id="datetime">DateTime</h2>
<p>Date with time. Stored in four bytes as a Unix timestamp (unsigned). Allows storing values in the same range as for the Date type. The minimal value is output as 0000-00-00 00:00:00.
The time is stored with accuracy up to one second (without leap seconds).</p>
<h3 id="time-zones">Time zones</h3>
<p>The date with time is converted from text (divided into component parts) to binary and back, using the system's time zone at the time the client or server starts. In text format, information about daylight savings is lost.</p>
<p>By default, the client switches to the timezone of the server when it connects. You can change this behavior by enabling the client command-line option <code>--use_client_time_zone</code>.</p>
<p>Supports only those time zones that never had the time differ from UTC for a partial number of hours (without leap seconds) over the entire time range you will be working with.</p>
<p>So when working with a textual date (for example, when saving text dumps), keep in mind that there may be ambiguity during changes for daylight savings time, and there may be problems matching data if the time zone changed.</p>
<h2 id="enum">Enum</h2>
<p>Enum8 or Enum16. A finite set of string values that can be stored more efficiently than the <code>String</code> data type.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span>Enum8(&#39;hello&#39; = 1, &#39;world&#39; = 2)
</pre></div>


<ul>
<li>A data type with two possible values: 'hello' and 'world'.</li>
</ul>
<p>Each of the values is assigned a number in the range <code>-128 ... 127</code> for <code>Enum8</code> or in the range <code>-32768 ... 32767</code> for <code>Enum16</code>. All the strings and numbers must be different. An empty string is allowed. If this type is specified (in a table definition), numbers can be in an arbitrary order. However, the order does not matter.</p>
<p>In RAM, this type of column is stored in the same way as <code>Int8</code> or <code>Int16</code>  of the corresponding numerical values.
When reading in text form, ClickHouse parses the value as a string and searches for the corresponding string from the set of Enum values. If it is not found, an exception is thrown. When reading in text format, the string is read and the corresponding numeric value is looked up. An exception will be thrown if it is not found.
When writing in text form, it writes the value as the corresponding string. If column data contains garbage (numbers that are not from the valid set), an exception is thrown. When reading and writing in binary form, it works the same way as for Int8 and Int16 data types.
The implicit default value is the value with the lowest number.</p>
<p>During <code>ORDER BY</code>, <code>GROUP BY</code>, <code>IN</code>, <code>DISTINCT</code> and so on, Enums behave the same way as the corresponding numbers. For example, ORDER BY sorts them numerically. Equality and comparison operators work the same way on Enums as they do on the underlying numeric values.</p>
<p>Enum values cannot be compared with numbers. Enums can be compared to a constant string. If the string compared to is not a valid value for the Enum, an exception will be thrown. The IN operator is supported with the Enum on the left hand side and a set of strings on the right hand side. The strings are the values of the corresponding Enum.</p>
<p>Most numeric and string operations are not defined for Enum values, e.g. adding a number to an Enum or concatenating a string to an Enum.
However, the Enum has a natural <code>toString</code> function that returns its string value.</p>
<p>Enum values are also convertible to numeric types using the <code>toT</code> function, where T is a numeric type. When T corresponds to the enum’s underlying numeric type, this conversion is zero-cost.
The Enum type can be changed without cost using ALTER, if only the set of values is changed. It is possible to both add and remove members of the Enum using ALTER (removing is safe only if the removed value has never been used in the table). As a safeguard, changing the numeric value of a previously defined Enum member will throw an exception.</p>
<p>Using ALTER, it is possible to change an Enum8 to an Enum16 or vice versa, just like changing an Int8 to Int16.</p>
<h2 id="arrayt">Array(T)</h2>
<p>An array of elements of type T. The T type can be any type, including an array.
We don't recommend using multidimensional arrays, because they are not well supported (for example, you can't store multidimensional arrays in tables with a MergeTree engine).</p>
<h2 id="aggregatefunctionname-types_of_arguments">AggregateFunction(name, types_of_arguments...)</h2>
<p>The intermediate state of an aggregate function. To get it, use aggregate functions with the '-State' suffix. For more information, see "AggregatingMergeTree".</p>
<h2 id="tuplet1-t2">Tuple(T1, T2, ...)</h2>
<p>Tuples can't be written to tables (other than Memory tables). They are used for temporary column grouping. Columns can be grouped when an IN expression is used in a query, and for specifying certain formal parameters of lambda functions. For more information, see "IN operators" and "Higher order functions".</p>
<p>Tuples can be output as the result of running a query. In this case, for text formats other than JSON*, values are comma-separated in brackets. In JSON* formats, tuples are output as arrays (in square brackets).</p>
<h2 id="nested-data-structures">Nested data structures</h2>
<h2 id="nestedname1-type1-name2-type2">Nested(Name1 Type1, Name2 Type2, ...)</h2>
<p>A nested data structure is like a nested table. The parameters of a nested data structure – the column names and types – are specified the same way as in a CREATE query. Each table row can correspond to any number of rows in a nested data structure.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">test</span><span class="p">.</span><span class="n">visits</span>
<span class="p">(</span>
    <span class="n">CounterID</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">StartDate</span> <span class="nb">Date</span><span class="p">,</span>
    <span class="n">Sign</span> <span class="nb">Int8</span><span class="p">,</span>
    <span class="n">IsNew</span> <span class="n">UInt8</span><span class="p">,</span>
    <span class="n">VisitID</span> <span class="n">UInt64</span><span class="p">,</span>
    <span class="n">UserID</span> <span class="n">UInt64</span><span class="p">,</span>
    <span class="p">...</span>
    <span class="n">Goals</span> <span class="n">Nested</span>
    <span class="p">(</span>
        <span class="n">ID</span> <span class="n">UInt32</span><span class="p">,</span>
        <span class="nb">Serial</span> <span class="n">UInt32</span><span class="p">,</span>
        <span class="n">EventTime</span> <span class="n">DateTime</span><span class="p">,</span>
        <span class="n">Price</span> <span class="n">Int64</span><span class="p">,</span>
        <span class="n">OrderID</span> <span class="n">String</span><span class="p">,</span>
        <span class="n">CurrencyID</span> <span class="n">UInt32</span>
    <span class="p">),</span>
    <span class="p">...</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">CollapsingMergeTree</span><span class="p">(</span><span class="n">StartDate</span><span class="p">,</span> <span class="n">intHash32</span><span class="p">(</span><span class="n">UserID</span><span class="p">),</span> <span class="p">(</span><span class="n">CounterID</span><span class="p">,</span> <span class="n">StartDate</span><span class="p">,</span> <span class="n">intHash32</span><span class="p">(</span><span class="n">UserID</span><span class="p">),</span> <span class="n">VisitID</span><span class="p">),</span> <span class="mi">8192</span><span class="p">,</span> <span class="n">Sign</span><span class="p">)</span>
</pre></div>


<p>This example declares the <code>Goals</code> nested data structure, which contains data about conversions (goals reached). Each row in the 'visits' table can correspond to zero or any number of conversions.</p>
<p>Only a single nesting level is supported. Columns of nested structures containing arrays are equivalent to multidimensional arrays, so they have limited support (there is no support for storing these columns in tables with the MergeTree engine).</p>
<p>In most cases, when working with a nested data structure, its individual columns are specified. To do this, the column names are separated by a dot. These columns make up an array of matching types. All the column arrays of a single nested data structure have the same length.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="n">Goals</span><span class="p">.</span><span class="n">ID</span><span class="p">,</span>
    <span class="n">Goals</span><span class="p">.</span><span class="n">EventTime</span>
<span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">visits</span>
<span class="k">WHERE</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">101500</span> <span class="k">AND</span> <span class="k">length</span><span class="p">(</span><span class="n">Goals</span><span class="p">.</span><span class="n">ID</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span>
<span class="k">LIMIT</span> <span class="mi">10</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─Goals.ID───────────────────────┬─Goals.EventTime───────────────────────────────────────────────────────────────────────────┐
│ [1073752,591325,591325]        │ [&#39;2014-03-17 16:38:10&#39;,&#39;2014-03-17 16:38:48&#39;,&#39;2014-03-17 16:42:27&#39;]                       │
│ [1073752]                      │ [&#39;2014-03-17 00:28:25&#39;]                                                                   │
│ [1073752]                      │ [&#39;2014-03-17 10:46:20&#39;]                                                                   │
│ [1073752,591325,591325,591325] │ [&#39;2014-03-17 13:59:20&#39;,&#39;2014-03-17 22:17:55&#39;,&#39;2014-03-17 22:18:07&#39;,&#39;2014-03-17 22:18:51&#39;] │
│ []                             │ []                                                                                        │
│ [1073752,591325,591325]        │ [&#39;2014-03-17 11:37:06&#39;,&#39;2014-03-17 14:07:47&#39;,&#39;2014-03-17 14:36:21&#39;]                       │
│ []                             │ []                                                                                        │
│ []                             │ []                                                                                        │
│ [591325,1073752]               │ [&#39;2014-03-17 00:46:05&#39;,&#39;2014-03-17 00:46:05&#39;]                                             │
│ [1073752,591325,591325,591325] │ [&#39;2014-03-17 13:28:33&#39;,&#39;2014-03-17 13:30:26&#39;,&#39;2014-03-17 18:51:21&#39;,&#39;2014-03-17 18:51:45&#39;] │
└────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────────────────┘
</pre></div>


<p>It is easiest to think of a nested data structure as a set of multiple column arrays of the same length.</p>
<p>The only place where a SELECT query can specify the name of an entire nested data structure instead of individual columns is the ARRAY JOIN clause. For more information, see "ARRAY JOIN clause". Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="n">Goal</span><span class="p">.</span><span class="n">ID</span><span class="p">,</span>
    <span class="n">Goal</span><span class="p">.</span><span class="n">EventTime</span>
<span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">visits</span>
<span class="nb">ARRAY</span> <span class="k">JOIN</span> <span class="n">Goals</span> <span class="k">AS</span> <span class="n">Goal</span>
<span class="k">WHERE</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">101500</span> <span class="k">AND</span> <span class="k">length</span><span class="p">(</span><span class="n">Goals</span><span class="p">.</span><span class="n">ID</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span>
<span class="k">LIMIT</span> <span class="mi">10</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─Goal.ID─┬──────Goal.EventTime─┐
│ 1073752 │ 2014-03-17 16:38:10 │
│  591325 │ 2014-03-17 16:38:48 │
│  591325 │ 2014-03-17 16:42:27 │
│ 1073752 │ 2014-03-17 00:28:25 │
│ 1073752 │ 2014-03-17 10:46:20 │
│ 1073752 │ 2014-03-17 13:59:20 │
│  591325 │ 2014-03-17 22:17:55 │
│  591325 │ 2014-03-17 22:18:07 │
│  591325 │ 2014-03-17 22:18:51 │
│ 1073752 │ 2014-03-17 11:37:06 │
└─────────┴─────────────────────┘
</pre></div>


<p>You can't perform SELECT for an entire nested data structure. You can only explicitly list individual columns that are part of it.</p>
<p>For an INSERT query, you should pass all the component column arrays of a nested data structure separately (as if they were individual column arrays). During insertion, the system checks that they have the same length.</p>
<p>For a DESCRIBE query, the columns in a nested data structure are listed separately in the same way.</p>
<p>The ALTER query is very limited for elements in a nested data structure.</p>
<h2 id="special-data-types">Special data types</h2>
<p>Special data type values can't be saved to a table or output in results, but are used as the intermediate result of running a query.</p>
<h2 id="expression">Expression</h2>
<p>Used for representing lambda expressions in high-order functions.</p>
<h2 id="set_2">Set</h2>
<p>Used for the right half of an IN expression.</p>
<h2 id="operators_1">Operators</h2>
<p>All operators are transformed to the corresponding functions at the query parsing stage, in accordance with their precedence and associativity.
Groups of operators are listed in order of priority (the higher it is in the list, the earlier the operator is connected to its arguments).</p>
<h3 id="access-operators">Access operators</h3>
<p><code>a[N]</code>  Access to an element of an array; <code>arrayElement(a, N) function</code>.</p>
<p><code>a.N</code> – Access to a tuble element; <code>tupleElement(a, N)</code> function.</p>
<h3 id="numeric-negation-operator">Numeric negation operator</h3>
<p><code>-a</code>  – The <code>negate (a)</code> function.</p>
<h3 id="multiplication-and-division-operators">Multiplication and division operators</h3>
<p><code>a * b</code>  – The <code>multiply (a, b) function.</code></p>
<p><code>a / b</code>  – The <code>divide(a, b) function.</code></p>
<p><code>a % b</code> – The <code>modulo(a, b) function.</code></p>
<h3 id="addition-and-subtraction-operators">Addition and subtraction operators</h3>
<p><code>a + b</code> – The <code>plus(a, b) function.</code></p>
<p><code>a - b</code>  – The <code>minus(a, b) function.</code></p>
<h3 id="comparison-operators">Comparison operators</h3>
<p><code>a = b</code> – The <code>equals(a, b) function.</code></p>
<p><code>a == b</code> – The <code>equals(a, b) function.</code></p>
<p><code>a != b</code> – The <code>notEquals(a, b) function.</code></p>
<p><code>a &lt;&gt; b</code> – The <code>notEquals(a, b) function.</code></p>
<p><code>a &lt;= b</code> – The <code>lessOrEquals(a, b) function.</code></p>
<p><code>a &gt;= b</code> – The <code>greaterOrEquals(a, b) function.</code></p>
<p><code>a &lt; b</code> – The <code>less(a, b) function.</code></p>
<p><code>a &gt; b</code> – The <code>greater(a, b) function.</code></p>
<p><code>a LIKE s</code> – The <code>like(a, b) function.</code></p>
<p><code>a NOT LIKE s</code> – The <code>notLike(a, b) function.</code></p>
<p><code>a BETWEEN b AND c</code> – The same as <code>a &gt;= b AND a &lt;= c.</code></p>
<h3 id="operators-for-working-with-data-sets">Operators for working with data sets</h3>
<p><em>See the section "IN operators".</em></p>
<p><code>a IN ...</code> – The <code>in(a, b) function</code></p>
<p><code>a NOT IN ...</code> – The <code>notIn(a, b) function.</code></p>
<p><code>a GLOBAL IN ...</code> – The <code>globalIn(a, b) function.</code></p>
<p><code>a GLOBAL NOT IN ...</code> – The <code>globalNotIn(a, b) function.</code></p>
<h3 id="logical-negation-operator">Logical negation operator</h3>
<p><code>NOT a</code> The <code>not(a) function.</code></p>
<h3 id="logical-and-operator">Logical AND operator</h3>
<p><code>a AND b</code> – The<code>and(a, b) function.</code></p>
<h3 id="logical-or-operator">Logical OR operator</h3>
<p><code>a OR b</code> – The <code>or(a, b) function.</code></p>
<h3 id="conditional-operator">Conditional operator</h3>
<p><code>a ? b : c</code> – The <code>if(a, b, c) function.</code></p>
<p>Note:</p>
<p>The conditional operator calculates the values of b and c, then checks whether condition a is met, and then returns the corresponding value. If "b" or "c" is an arrayJoin() function, each row will be replicated regardless of the "a" condition.</p>
<h3 id="conditional-expression">Conditional expression</h3>
<div class="codehilite"><pre><span></span><span class="k">CASE</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>
    <span class="k">WHEN</span> <span class="n">a</span> <span class="k">THEN</span> <span class="n">b</span>
    <span class="p">[</span><span class="k">WHEN</span> <span class="p">...</span> <span class="k">THEN</span> <span class="p">...]</span>
    <span class="k">ELSE</span> <span class="k">c</span>
<span class="k">END</span>
</pre></div>


<p>If "x" is specified, then transform(x, [a, ...], [b, ...], c). Otherwise – multiIf(a, b, ..., c).</p>
<h3 id="concatenation-operator">Concatenation operator</h3>
<p><code>s1 || s2</code> – The <code>concat(s1, s2) function.</code></p>
<h3 id="lambda-creation-operator">Lambda creation operator</h3>
<p><code>x -&gt; expr</code> – The <code>lambda(x, expr) function.</code></p>
<p>The following operators do not have a priority, since they are brackets:</p>
<h3 id="array-creation-operator">Array creation operator</h3>
<p><code>[x1, ...]</code> – The <code>array(x1, ...) function.</code></p>
<h3 id="tuple-creation-operator">Tuple creation operator</h3>
<p><code>(x1, x2, ...)</code> – The <code>tuple(x2, x2, ...) function.</code></p>
<h3 id="associativity">Associativity</h3>
<p>All binary operators have left associativity. For example, <code>1 + 2 + 3</code> is transformed to <code>plus(plus(1, 2), 3)</code>.
Sometimes this doesn't work the way you expect. For example, <code>SELECT 4 &gt; 2 &gt; 3</code>  will result in 0.</p>
<p>For efficiency, the <code>and</code> and <code>or</code> functions accept any number of arguments. The corresponding chains of <code>AND</code> and <code>OR</code> operators are transformed to a single call of these functions.</p>
<h2 id="functions_1">Functions</h2>
<p>There are at least* two types of functions - regular functions (they are just called "functions") and aggregate functions. These are completely different concepts. Regular functions work as if they are applied to each row separately (for each row, the result of the function doesn't depend on the other rows). Aggregate functions accumulate a set of values from various rows (i.e. they depend on the entire set of rows).</p>
<p>In this section we discuss regular functions. For aggregate functions, see the section "Aggregate functions".</p>
<p>* - There is a third type of function that the 'arrayJoin' function belongs to; table functions can also be mentioned separately.*</p>
<h3 id="strong-typing">Strong typing</h3>
<p>In contrast to standard SQL, ClickHouse has strong typing. In other words, it doesn't make implicit conversions between types. Each function works for a specific set of types. This means that sometimes you need to use type conversion functions.</p>
<h3 id="common-subexpression-elimination">Common subexpression elimination</h3>
<p>All expressions in a query that have the same AST (the same record or same result of syntactic parsing) are considered to have identical values. Such expressions are concatenated and executed once. Identical subqueries are also eliminated this way.</p>
<h3 id="types-of-results">Types of results</h3>
<p>All functions return a single return as the result (not several values, and not zero values). The type of result is usually defined only by the types of arguments, not by the values. Exceptions are the tupleElement function (the a.N operator), and the toFixedString function.</p>
<h3 id="constants">Constants</h3>
<p>For simplicity, certain functions can only work with constants for some arguments. For example, the right argument of the LIKE operator must be a constant.
Almost all functions return a constant for constant arguments. The exception is functions that generate random numbers.
The 'now' function returns different values for queries that were run at different times, but the result is considered a constant, since constancy is only important within a single query.
A constant expression is also considered a constant (for example, the right half of the LIKE operator can be constructed from multiple constants).</p>
<p>Functions can be implemented in different ways for constant and non-constant arguments (different code is executed). But the results for a constant and for a true column containing only the same value should match each other.</p>
<h3 id="constancy">Constancy</h3>
<p>Functions can't change the values of their arguments – any changes are returned as the result. Thus, the result of calculating separate functions does not depend on the order in which the functions are written in the query.</p>
<h3 id="error-handling">Error handling</h3>
<p>Some functions might throw an exception if the data is invalid. In this case, the query is canceled and an error text is returned to the client. For distributed processing, when an exception occurs on one of the servers, the other servers also attempt to abort the query.</p>
<h3 id="evaluation-of-argument-expressions">Evaluation of argument expressions</h3>
<p>In almost all programming languages, one of the arguments might not be evaluated for certain operators. This is usually the operators <code>&amp;&amp;</code>, <code>||</code>, and <code>?:</code>.
But in ClickHouse, arguments of functions (operators) are always evaluated. This is because entire parts of columns are evaluated at once, instead of calculating each row separately.</p>
<h3 id="performing-functions-for-distributed-query-processing">Performing functions for distributed query processing</h3>
<p>For distributed query processing, as many stages of query processing as possible are performed on remote servers, and the rest of the stages (merging intermediate results and everything after that) are performed on the requestor server.</p>
<p>This means that functions can be performed on different servers.
For example, in the query <code>SELECT f(sum(g(x))) FROM distributed_table GROUP BY h(y),</code></p>
<ul>
<li>if a <code>distributed_table</code> has at least two shards, the functions 'g' and 'h' are performed on remote servers, and the function 'f' is performed on the requestor server.</li>
<li>if a <code>distributed_table</code> has only one shard, all the 'f', 'g', and 'h' functions are performed on this shard's server.</li>
</ul>
<p>The result of a function usually doesn't depend on which server it is performed on. However, sometimes this is important.
For example, functions that work with dictionaries use the dictionary that exists on the server they are running on.
Another example is the <code>hostName</code> function, which returns the name of the server it is running on in order to make <code>GROUP BY</code> by servers in a <code>SELECT</code> query.</p>
<p>If a function in a query is performed on the requestor server, but you need to perform it on remote servers, you can wrap it in an 'any' aggregate function or add it to a key in <code>GROUP BY</code>.</p>
<h2 id="arithmetic-functions">Arithmetic functions</h2>
<p>For all arithmetic functions, the result type is calculated as the smallest number type that the result fits in, if there is such a type. The minimum is taken simultaneously based on the number of bits, whether it is signed, and whether it floats. If there are not enough bits, the highest bit type is taken.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">toTypeName</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">toTypeName</span><span class="p">(</span><span class="mi">0</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">toTypeName</span><span class="p">(</span><span class="mi">0</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">toTypeName</span><span class="p">(</span><span class="mi">0</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─toTypeName(0)─┬─toTypeName(plus(0, 0))─┬─toTypeName(plus(plus(0, 0), 0))─┬─toTypeName(plus(plus(plus(0, 0), 0), 0))─┐
│ UInt8         │ UInt16                 │ UInt32                          │ UInt64                                   │
└───────────────┴────────────────────────┴─────────────────────────────────┴──────────────────────────────────────────┘
</pre></div>


<p>Arithmetic functions work for any pair of types from UInt8, UInt16, UInt32, UInt64, Int8, Int16, Int32, Int64, Float32, or Float64.</p>
<p>Overflow is produced the same way as in C++.</p>
<h3 id="plusa-b-a-b-operator">plus(a, b), a + b operator</h3>
<p>Calculates the sum of the numbers.
You can also add integer numbers with a date or date and time. In the case of a date, adding an integer means adding the corresponding number of days. For a date with time, it means adding the corresponding number of seconds.</p>
<h3 id="minusa-b-a-b-operator">minus(a, b), a - b operator</h3>
<p>Calculates the difference. The result is always signed.</p>
<p>You can also calculate integer numbers from a date or date with time. The idea is the same – see above for 'plus'.</p>
<h3 id="multiplya-b-a-42-b-operator">multiply(a, b), a * b operator</h3>
<p>Calculates the product of the numbers.</p>
<h3 id="dividea-b-a-b-operator">divide(a, b), a / b operator</h3>
<p>Calculates the quotient of the numbers. The result type is always a floating-point type.
It is not integer division. For integer division, use the 'intDiv' function.
When dividing by zero you get 'inf', '-inf', or 'nan'.</p>
<h3 id="intdiva-b">intDiv(a, b)</h3>
<p>Calculates the quotient of the numbers. Divides into integers, rounding down (by the absolute value).
An exception is thrown when dividing by zero or when dividing a minimal negative number by minus one.</p>
<h3 id="intdivorzeroa-b">intDivOrZero(a, b)</h3>
<p>Differs from 'intDiv' in that it returns zero when dividing by zero or when dividing a minimal negative number by minus one.</p>
<h3 id="moduloa-b-a-b-operator">modulo(a, b), a % b operator</h3>
<p>Calculates the remainder after division.
If arguments are floating-point numbers, they are pre-converted to integers by dropping the decimal portion.
The remainder is taken in the same sense as in C++. Truncated division is used for negative numbers.
An exception is thrown when dividing by zero or when dividing a minimal negative number by minus one.</p>
<h3 id="negatea-a-operator">negate(a), -a operator</h3>
<p>Calculates a number with the reverse sign. The result is always signed.</p>
<h3 id="absa">abs(a)</h3>
<p>Calculates the absolute value of the number (a). That is, if a &lt; 0, it returns -a. For unsigned types it doesn't do anything. For signed integer types, it returns an unsigned number.</p>
<h3 id="gcda-b">gcd(a, b)</h3>
<p>Returns the greatest common divisor of the numbers.
An exception is thrown when dividing by zero or when dividing a minimal negative number by minus one.</p>
<h3 id="lcma-b">lcm(a, b)</h3>
<p>Returns the least common multiple of the numbers.
An exception is thrown when dividing by zero or when dividing a minimal negative number by minus one.</p>
<h2 id="comparison-functions">Comparison functions</h2>
<p>Comparison functions always return 0 or 1 (Uint8).</p>
<p>The following types can be compared:</p>
<ul>
<li>numbers</li>
<li>strings and fixed strings</li>
<li>dates</li>
<li>dates with times</li>
</ul>
<p>within each group, but not between different groups.</p>
<p>For example, you can't compare a date with a string. You have to use a function to convert the string to a date, or vice versa.</p>
<p>Strings are compared by bytes. A shorter string is smaller than all strings that start with it and that contain at least one more character.</p>
<p>Note. Up until version 1.1.54134, signed and unsigned numbers were compared the same way as in C++. In other words, you could get an incorrect result in cases like SELECT 9223372036854775807 &gt; -1. This behavior changed in version 1.1.54134 and is now mathematically correct.</p>
<h3 id="equals-a-b-and-a-b-operator">equals, a = b and a == b operator</h3>
<h3 id="notequals-a-operator-b-and-a-b">notEquals, a ! operator= b and a <code>&lt;&gt;</code> b</h3>
<h3 id="less-operator">less, <code>&lt; operator</code></h3>
<h3 id="greater-operator">greater, <code>&gt; operator</code></h3>
<h3 id="lessorequals-operator">lessOrEquals, <code>&lt;= operator</code></h3>
<h3 id="greaterorequals-operator">greaterOrEquals, <code>&gt;= operator</code></h3>
<h2 id="logical-functions">Logical functions</h2>
<p>Logical functions accept any numeric types, but return a UInt8 number equal to 0 or 1.</p>
<p>Zero as an argument is considered "false," while any non-zero value is considered "true".</p>
<h3 id="and-and-operator">and, AND operator</h3>
<h3 id="or-or-operator">or, OR operator</h3>
<h3 id="not-not-operator">not, NOT operator</h3>
<h3 id="xor">xor</h3>
<p><a name="type_conversion_functions"></a></p>
<h2 id="type-conversion-functions">Type conversion functions</h2>
<h3 id="touint8-touint16-touint32-touint64">toUInt8, toUInt16, toUInt32, toUInt64</h3>
<h3 id="toint8-toint16-toint32-toint64">toInt8, toInt16, toInt32, toInt64</h3>
<h3 id="tofloat32-tofloat64">toFloat32, toFloat64</h3>
<h3 id="touint8orzero-touint16orzero-touint32orzero-touint64orzero-toint8orzero-toint16orzero-toint32orzero-toint64orzero-tofloat32orzero-tofloat64orzero">toUInt8OrZero, toUInt16OrZero, toUInt32OrZero, toUInt64OrZero, toInt8OrZero, toInt16OrZero, toInt32OrZero, toInt64OrZero, toFloat32OrZero, toFloat64OrZero</h3>
<h3 id="todate-todatetime">toDate, toDateTime</h3>
<h3 id="tostring">toString</h3>
<p>Functions for converting between numbers, strings (but not fixed strings), dates, and dates with times.
All these functions accept one argument.</p>
<p>When converting to or from a string, the value is formatted or parsed using the same rules as for the TabSeparated format (and almost all other text formats). If the string can't be parsed, an exception is thrown and the request is canceled.</p>
<p>When converting dates to numbers or vice versa, the date corresponds to the number of days since the beginning of the Unix epoch.
When converting dates with times to numbers or vice versa, the date with time corresponds to the number of seconds since the beginning of the Unix epoch.</p>
<p>The date and date-with-time formats for the toDate/toDateTime functions are defined as follows:</p>
<div class="codehilite"><pre><span></span>YYYY-MM-DD
YYYY-MM-DD hh:mm:ss
</pre></div>


<p>As an exception, if converting from UInt32, Int32, UInt64, or Int64 numeric types to Date, and if the number is greater than or equal to 65536, the number is interpreted as a Unix timestamp (and not as the number of days) and is rounded to the date. This allows support for the common occurrence of writing 'toDate(unix_timestamp)', which otherwise would be an error and would require writing the more cumbersome 'toDate(toDateTime(unix_timestamp))'.</p>
<p>Conversion between a date and date with time is performed the natural way: by adding a null time or dropping the time.</p>
<p>Conversion between numeric types uses the same rules as assignments between different numeric types in C++.</p>
<p>Additionally, the toString function of the DateTime argument can take a second String argument containing the name of the time zone. Example: <code>Asia/Yekaterinburg</code> In this case, the time is formatted according to the specified time zone.</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="n">now</span><span class="p">()</span> <span class="k">AS</span> <span class="n">now_local</span><span class="p">,</span>
    <span class="n">toString</span><span class="p">(</span><span class="n">now</span><span class="p">(),</span> <span class="s1">&#39;Asia/Yekaterinburg&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">now_yekat</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌───────────now_local─┬─now_yekat───────────┐
│ 2016-06-15 00:11:21 │ 2016-06-15 02:11:21 │
└─────────────────────┴─────────────────────┘
</pre></div>


<p>Also see the <code>toUnixTimestamp</code> function.</p>
<h3 id="tofixedstrings-n">toFixedString(s, N)</h3>
<p>Converts a String type argument to a FixedString(N) type (a string with fixed length N). N must be a constant.
If the string has fewer bytes than N, it is passed with null bytes to the right. If the string has more bytes than N, an exception is thrown.</p>
<h3 id="tostringcuttozeros">toStringCutToZero(s)</h3>
<p>Accepts a String or FixedString argument. Returns the String with the content truncated at the first zero byte found.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">toFixedString</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="k">AS</span> <span class="n">s</span><span class="p">,</span> <span class="n">toStringCutToZero</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">AS</span> <span class="n">s_cut</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─s─────────────┬─s_cut─┐
│ foo\0\0\0\0\0 │ foo   │
└───────────────┴───────┘
</pre></div>


<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">toFixedString</span><span class="p">(</span><span class="s1">&#39;foo\0bar&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="k">AS</span> <span class="n">s</span><span class="p">,</span> <span class="n">toStringCutToZero</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">AS</span> <span class="n">s_cut</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─s──────────┬─s_cut─┐
│ foo\0bar\0 │ foo   │
└────────────┴───────┘
</pre></div>


<h3 id="reinterpretasuint8-reinterpretasuint16-reinterpretasuint32-reinterpretasuint64">reinterpretAsUInt8, reinterpretAsUInt16, reinterpretAsUInt32, reinterpretAsUInt64</h3>
<h3 id="reinterpretasint8-reinterpretasint16-reinterpretasint32-reinterpretasint64">reinterpretAsInt8, reinterpretAsInt16, reinterpretAsInt32, reinterpretAsInt64</h3>
<h3 id="reinterpretasfloat32-reinterpretasfloat64">reinterpretAsFloat32, reinterpretAsFloat64</h3>
<h3 id="reinterpretasdate-reinterpretasdatetime">reinterpretAsDate, reinterpretAsDateTime</h3>
<p>These functions accept a string and interpret the bytes placed at the beginning of the string as a number in host order (little endian). If the string isn't long enough, the functions work as if the string is padded with the necessary number of null bytes. If the string is longer than needed, the extra bytes are ignored. A date is interpreted as the number of days since the beginning of the Unix Epoch, and a date with time is interpreted as the number of seconds since the beginning of the Unix Epoch.</p>
<h3 id="reinterpretasstring">reinterpretAsString</h3>
<p>This function accepts a number or date or date with time, and returns a string containing bytes representing the corresponding value in host order (little endian). Null bytes are dropped from the end. For example, a UInt32 type value of 255 is a string that is one byte long.</p>
<h3 id="castx-t">CAST(x, t)</h3>
<p>Converts 'x' to the 't' data type. The syntax CAST(x AS t) is also supported.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="s1">&#39;2016-06-15 23:00:00&#39;</span> <span class="k">AS</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="k">CAST</span><span class="p">(</span><span class="k">timestamp</span> <span class="k">AS</span> <span class="n">DateTime</span><span class="p">)</span> <span class="k">AS</span> <span class="n">datetime</span><span class="p">,</span>
    <span class="k">CAST</span><span class="p">(</span><span class="k">timestamp</span> <span class="k">AS</span> <span class="nb">Date</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">date</span><span class="p">,</span>
    <span class="k">CAST</span><span class="p">(</span><span class="k">timestamp</span><span class="p">,</span> <span class="s1">&#39;String&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">string</span><span class="p">,</span>
    <span class="k">CAST</span><span class="p">(</span><span class="k">timestamp</span><span class="p">,</span> <span class="s1">&#39;FixedString(22)&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">fixed_string</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─timestamp───────────┬────────────datetime─┬───────date─┬─string──────────────┬─fixed_string──────────────┐
│ 2016-06-15 23:00:00 │ 2016-06-15 23:00:00 │ 2016-06-15 │ 2016-06-15 23:00:00 │ 2016-06-15 23:00:00\0\0\0 │
└─────────────────────┴─────────────────────┴────────────┴─────────────────────┴───────────────────────────┘
</pre></div>


<p>Conversion to FixedString (N) only works for arguments of type String or FixedString (N).</p>
<h2 id="functions-for-working-with-dates-and-times">Functions for working with dates and times</h2>
<p>Support for time zones</p>
<p>All functions for working with the date and time that have a logical use for the time zone can accept a second optional time zone argument. Example: Asia/Yekaterinburg. In this case, they use the specified time zone instead of the local (default) one.</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="n">toDateTime</span><span class="p">(</span><span class="s1">&#39;2016-06-15 23:00:00&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">time</span><span class="p">,</span>
    <span class="n">toDate</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="k">AS</span> <span class="n">date_local</span><span class="p">,</span>
    <span class="n">toDate</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="s1">&#39;Asia/Yekaterinburg&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">date_yekat</span><span class="p">,</span>
    <span class="n">toString</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="s1">&#39;US/Samoa&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">time_samoa</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌────────────────time─┬─date_local─┬─date_yekat─┬─time_samoa──────────┐
│ 2016-06-15 23:00:00 │ 2016-06-15 │ 2016-06-16 │ 2016-06-15 09:00:00 │
└─────────────────────┴────────────┴────────────┴─────────────────────┘
</pre></div>


<p>Only time zones that differ from UTC by a whole number of hours are supported.</p>
<h3 id="toyear">toYear</h3>
<p>Converts a date or date with time to a UInt16 number containing the year number (AD).</p>
<h3 id="tomonth">toMonth</h3>
<p>Converts a date or date with time to a UInt8 number containing the month number (1-12).</p>
<h3 id="todayofmonth">toDayOfMonth</h3>
<p>-Converts a date or date with time to a UInt8 number containing the number of the day of the month (1-31).</p>
<h3 id="todayofweek">toDayOfWeek</h3>
<p>Converts a date or date with time to a UInt8 number containing the number of the day of the week (Monday is 1, and Sunday is 7).</p>
<h3 id="tohour">toHour</h3>
<p>Converts a date with time to a UInt8 number containing the number of the hour in 24-hour time (0-23).
This function assumes that if clocks are moved ahead, it is by one hour and occurs at 2 a.m., and if clocks are moved back, it is by one hour and occurs at 3 a.m. (which is not always true – even in Moscow the clocks were twice changed at a different time).</p>
<h3 id="tominute">toMinute</h3>
<p>Converts a date with time to a UInt8 number containing the number of the minute of the hour (0-59).</p>
<h3 id="tosecond">toSecond</h3>
<p>Converts a date with time to a UInt8 number containing the number of the second in the minute (0-59).
Leap seconds are not accounted for.</p>
<h3 id="tomonday">toMonday</h3>
<p>Rounds down a date or date with time to the nearest Monday.
Returns the date.</p>
<h3 id="tostartofmonth">toStartOfMonth</h3>
<p>Rounds down a date or date with time to the first day of the month.
Returns the date.</p>
<h3 id="tostartofquarter">toStartOfQuarter</h3>
<p>Rounds down a date or date with time to the first day of the quarter.
The first day of the quarter is either 1 January, 1 April, 1 July, or 1 October.
Returns the date.</p>
<h3 id="tostartofyear">toStartOfYear</h3>
<p>Rounds down a date or date with time to the first day of the year.
Returns the date.</p>
<h3 id="tostartofminute">toStartOfMinute</h3>
<p>Rounds down a date with time to the start of the minute.</p>
<h3 id="tostartoffiveminute">toStartOfFiveMinute</h3>
<p>Rounds down a date with time to the start of the hour.</p>
<h3 id="tostartoffifteenminutes">toStartOfFifteenMinutes</h3>
<p>Rounds down the date with time to the start of the fifteen-minute interval.</p>
<p>Note: If you need to round a date with time to any other number of seconds, minutes, or hours, you can convert it into a number by using the toUInt32 function, then round the number using intDiv and multiplication, and convert it back using the toDateTime function.</p>
<h3 id="tostartofhour">toStartOfHour</h3>
<p>Rounds down a date with time to the start of the hour.</p>
<h3 id="tostartofday">toStartOfDay</h3>
<p>Rounds down a date with time to the start of the day.</p>
<h3 id="totime">toTime</h3>
<p>Converts a date with time to a certain fixed date, while preserving the time.</p>
<h3 id="torelativeyearnum">toRelativeYearNum</h3>
<p>Converts a date with time or date to the number of the year, starting from a certain fixed point in the past.</p>
<h3 id="torelativemonthnum">toRelativeMonthNum</h3>
<p>Converts a date with time or date to the number of the month, starting from a certain fixed point in the past.</p>
<h3 id="torelativeweeknum">toRelativeWeekNum</h3>
<p>Converts a date with time or date to the number of the week, starting from a certain fixed point in the past.</p>
<h3 id="torelativedaynum">toRelativeDayNum</h3>
<p>Converts a date with time or date to the number of the day, starting from a certain fixed point in the past.</p>
<h3 id="torelativehournum">toRelativeHourNum</h3>
<p>Converts a date with time or date to the number of the hour, starting from a certain fixed point in the past.</p>
<h3 id="torelativeminutenum">toRelativeMinuteNum</h3>
<p>Converts a date with time or date to the number of the minute, starting from a certain fixed point in the past.</p>
<h3 id="torelativesecondnum">toRelativeSecondNum</h3>
<p>Converts a date with time or date to the number of the second, starting from a certain fixed point in the past.</p>
<h3 id="now">now</h3>
<p>Accepts zero arguments and returns the current time at one of the moments of request execution.
This function returns a constant, even if the request took a long time to complete.</p>
<h3 id="today">today</h3>
<p>Accepts zero arguments and returns the current date at one of the moments of request execution.
The same as 'toDate(now())'.</p>
<h3 id="yesterday">yesterday</h3>
<p>Accepts zero arguments and returns yesterday's date at one of the moments of request execution.
The same as 'today() - 1'.</p>
<h3 id="timeslot">timeSlot</h3>
<p>Rounds the time to the half hour.
This function is specific to Yandex.Metrica, since half an hour is the minimum amount of time for breaking a session into two sessions if a tracking tag shows a single user's consecutive pageviews that differ in time by strictly more than this amount. This means that tuples (the tag ID, user ID, and time slot) can be used to search for pageviews that are included in the corresponding session.</p>
<h3 id="timeslotsstarttime-duration">timeSlots(StartTime, Duration)</h3>
<p>For a time interval starting at 'StartTime' and continuing for 'Duration' seconds, it returns an array of moments in time, consisting of points from this interval rounded down to the half hour.
For example, <code>timeSlots(toDateTime('2012-01-01 12:20:00'), 600) = [toDateTime('2012-01-01 12:00:00'), toDateTime('2012-01-01 12:30:00')]</code>.
This is necessary for searching for pageviews in the corresponding session.</p>
<h2 id="functions-for-working-with-strings">Functions for working with strings</h2>
<h3 id="empty">empty</h3>
<p>Returns 1 for an empty string or 0 for a non-empty string.
The result type is UInt8.
A string is considered non-empty if it contains at least one byte, even if this is a space or a null byte.
The function also works for arrays.</p>
<h3 id="notempty">notEmpty</h3>
<p>Returns 0 for an empty string or 1 for a non-empty string.
The result type is UInt8.
The function also works for arrays.</p>
<h3 id="length">length</h3>
<p>Returns the length of a string in bytes (not in characters, and not in code points).
The result type is UInt64.
The function also works for arrays.</p>
<h3 id="lengthutf8">lengthUTF8</h3>
<p>Returns the length of a string in Unicode code points (not in characters), assuming that the string contains a set of bytes that make up UTF-8 encoded text. If this assumption is not met, it returns some result (it doesn't throw an exception).
The result type is UInt64.</p>
<h3 id="lower">lower</h3>
<p>Converts ASCII Latin symbols in a string to lowercase.</p>
<h3 id="upper">upper</h3>
<p>Converts ASCII Latin symbols in a string to uppercase.</p>
<h3 id="lowerutf8">lowerUTF8</h3>
<p>Converts a string to lowercase, assuming the string contains a set of bytes that make up a UTF-8 encoded text.
It doesn't detect the language. So for Turkish the result might not be exactly correct.
If the length of the UTF-8 byte sequence is different for upper and lower case of a code point, the result may be incorrect for this code point.
If the string contains a set of bytes that is not UTF-8, then the behavior is undefined.</p>
<h3 id="upperutf8">upperUTF8</h3>
<p>Converts a string to uppercase, assuming the string contains a set of bytes that make up a UTF-8 encoded text.
It doesn't detect the language. So for Turkish the result might not be exactly correct.
If the length of the UTF-8 byte sequence is different for upper and lower case of a code point, the result may be incorrect for this code point.
If the string contains a set of bytes that is not UTF-8, then the behavior is undefined.</p>
<h3 id="reverse">reverse</h3>
<p>Reverses the string (as a sequence of bytes).</p>
<h3 id="reverseutf8">reverseUTF8</h3>
<p>Reverses a sequence of Unicode code points, assuming that the string contains a set of bytes representing a UTF-8 text. Otherwise, it does something else (it doesn't throw an exception).</p>
<h3 id="concats1-s2">concat(s1, s2, ...)</h3>
<p>Concatenates the strings listed in the arguments, without a separator.</p>
<h3 id="substrings-offset-length">substring(s, offset, length)</h3>
<p>Returns a substring starting with the byte from the 'offset' index that is 'length' bytes long. Character indexing starts from one (as in standard SQL). The 'offset' and 'length' arguments must be constants.</p>
<h3 id="substringutf8s-offset-length">substringUTF8(s, offset, length)</h3>
<p>The same as 'substring', but for Unicode code points. Works under the assumption that the string contains a set of bytes representing a UTF-8 encoded text. If this assumption is not met, it returns some result (it doesn't throw an exception).</p>
<h3 id="appendtrailingcharifabsents-c">appendTrailingCharIfAbsent(s, c)</h3>
<p>If the 's' string is non-empty and does not contain the 'c' character at the end, it appends the 'c' character to the end.</p>
<h3 id="convertcharsets-from-to">convertCharset(s, from, to)</h3>
<p>Returns the string 's' that was converted from the encoding in 'from' to the encoding in 'to'.</p>
<h2 id="functions-for-searching-strings">Functions for searching strings</h2>
<p>The search is case-sensitive in all these functions.
The search substring or regular expression must be a constant in all these functions.</p>
<h3 id="positionhaystack-needle">position(haystack, needle)</h3>
<p>Search for the <code>needle</code> substring in the <code>haystack</code> string.
Returns the position (in bytes) of the found substring, starting from 1, or returns 0 if the substring was not found.</p>
<p>For case-insensitive search use <code>positionCaseInsensitive</code> function.</p>
<h3 id="positionutf8haystack-needle">positionUTF8(haystack, needle)</h3>
<p>The same as <code>position</code>, but the position is returned in Unicode code points. Works under the assumption that the string contains a set of bytes representing a UTF-8 encoded text. If this assumption is not met, it returns some result (it doesn't throw an exception).</p>
<p>For case-insensitive search use <code>positionCaseInsensitiveUTF8</code> function.</p>
<h3 id="matchhaystack-pattern">match(haystack, pattern)</h3>
<p>Checks whether the string matches the 'pattern' regular expression. A re2 regular expression.
Returns 0 if it doesn't match, or 1 if it matches.</p>
<p>Note that the backslash symbol (<code>\</code>) is used for escaping in the regular expression. The same symbol is used for escaping in string literals. So in order to escape the symbol in a regular expression, you must write two backslashes (\) in a string literal.</p>
<p>The regular expression works with the string as if it is a set of bytes. The regular expression can't contain null bytes.
For patterns to search for substrings in a string, it is better to use LIKE or 'position', since they work much faster.</p>
<h3 id="extracthaystack-pattern">extract(haystack, pattern)</h3>
<p>Extracts a fragment of a string using a regular expression. If 'haystack' doesn't match the 'pattern' regex, an empty string is returned. If the regex doesn't contain subpatterns, it takes the fragment that matches the entire regex. Otherwise, it takes the fragment that matches the first subpattern.</p>
<h3 id="extractallhaystack-pattern">extractAll(haystack, pattern)</h3>
<p>Extracts all the fragments of a string using a regular expression. If 'haystack' doesn't match the 'pattern' regex, an empty string is returned. Returns an array of strings consisting of all matches to the regex. In general, the behavior is the same as the 'extract' function (it takes the first subpattern, or the entire expression if there isn't a subpattern).</p>
<h3 id="likehaystack-pattern-haystack-like-pattern-operator">like(haystack, pattern), haystack LIKE pattern operator</h3>
<p>Checks whether a string matches a simple regular expression.
The regular expression can contain the metasymbols <code>%</code> and <code>_</code>.</p>
<p>``% indicates any quantity of any bytes (including zero characters).</p>
<p><code>_</code> indicates any one byte.</p>
<p>Use the backslash (<code>\</code>) for escaping metasymbols. See the note on escaping in the description of the 'match' function.</p>
<p>For regular expressions like <code>%needle%</code>, the code is more optimal and works as fast as the <code>position</code> function.
For other regular expressions, the code is the same as for the 'match' function.</p>
<h3 id="notlikehaystack-pattern-haystack-not-like-pattern-operator">notLike(haystack, pattern), haystack NOT LIKE pattern operator</h3>
<p>The same thing as 'like', but negative.</p>
<h2 id="functions-for-searching-and-replacing-in-strings">Functions for searching and replacing in strings</h2>
<h3 id="replaceonehaystack-pattern-replacement">replaceOne(haystack, pattern, replacement)</h3>
<p>Replaces the first occurrence, if it exists, of the 'pattern' substring in 'haystack' with the 'replacement' substring.
Hereafter, 'pattern' and 'replacement' must be constants.</p>
<h3 id="replaceallhaystack-pattern-replacement">replaceAll(haystack, pattern, replacement)</h3>
<p>Replaces all occurrences of the 'pattern' substring in 'haystack' with the 'replacement' substring.</p>
<h3 id="replaceregexponehaystack-pattern-replacement">replaceRegexpOne(haystack, pattern, replacement)</h3>
<p>Replacement using the 'pattern' regular expression. A re2 regular expression.
Replaces only the first occurrence, if it exists.
A pattern can be specified as 'replacement'. This pattern can include substitutions <code>\0-\9</code>.
The substitution <code>\0</code> includes the entire regular expression. Substitutions <code>\1-\9</code> correspond to the subpattern numbers.To use the <code>\</code> character in a template, escape it using <code>\</code>.
Also keep in mind that a string literal requires an extra escape.</p>
<p>Example 1. Converting the date to American format:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="k">DISTINCT</span>
    <span class="n">EventDate</span><span class="p">,</span>
    <span class="n">replaceRegexpOne</span><span class="p">(</span><span class="n">toString</span><span class="p">(</span><span class="n">EventDate</span><span class="p">),</span> <span class="s1">&#39;(\\d{4})-(\\d{2})-(\\d{2})&#39;</span><span class="p">,</span> <span class="s1">&#39;\\2/\\3/\\1&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">res</span>
<span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">hits</span>
<span class="k">LIMIT</span> <span class="mi">7</span>
<span class="n">FORMAT</span> <span class="n">TabSeparated</span>
</pre></div>


<div class="codehilite"><pre><span></span>2014-03-17      03/17/2014
2014-03-18      03/18/2014
2014-03-19      03/19/2014
2014-03-20      03/20/2014
2014-03-21      03/21/2014
2014-03-22      03/22/2014
2014-03-23      03/23/2014
</pre></div>


<p>Example 2. Copying a string ten times:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">replaceRegexpOne</span><span class="p">(</span><span class="s1">&#39;Hello, World!&#39;</span><span class="p">,</span> <span class="s1">&#39;.*&#39;</span><span class="p">,</span> <span class="s1">&#39;\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">res</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─res────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ Hello, World!Hello, World!Hello, World!Hello, World!Hello, World!Hello, World!Hello, World!Hello, World!Hello, World!Hello, World! │
└────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</pre></div>


<h3 id="replaceregexpallhaystack-pattern-replacement">replaceRegexpAll(haystack, pattern, replacement)</h3>
<p>This does the same thing, but replaces all the occurrences. Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">replaceRegexpAll</span><span class="p">(</span><span class="s1">&#39;Hello, World!&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;\\0\\0&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">res</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─res────────────────────────┐
│ HHeelllloo,,  WWoorrlldd!! │
└────────────────────────────┘
</pre></div>


<p>As an exception, if a regular expression worked on an empty substring, the replacement is not made more than once.
Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">replaceRegexpAll</span><span class="p">(</span><span class="s1">&#39;Hello, World!&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;here: &#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">res</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─res─────────────────┐
│ here: Hello, World! │
└─────────────────────┘
</pre></div>


<h2 id="conditional-functions">Conditional functions</h2>
<h3 id="ifcond-then-else-cond-operator-then-else">if(cond, then, else), cond ? operator then : else</h3>
<p>Returns 'then' if cond !or 'else' if cond = 0.'cond' must be UInt 8, and 'then' and 'else' must be a type that has the smallest common type.</p>
<h2 id="mathematical-functions">Mathematical functions</h2>
<p>All the functions return a Float64 number. The accuracy of the result is close to the maximum precision possible, but the result might not coincide with the machine representable number nearest to the corresponding real number.</p>
<h3 id="e">e()</h3>
<p>Returns a Float64 number close to the e number.</p>
<h3 id="pi">pi()</h3>
<p>Returns a Float64 number close to π.</p>
<h3 id="expx">exp(x)</h3>
<p>Accepts a numeric argument and returns a Float64 number close to the exponent of the argument.</p>
<h3 id="logx">log(x)</h3>
<p>Accepts a numeric argument and returns a Float64 number close to the natural logarithm of the argument.</p>
<h3 id="exp2x">exp2(x)</h3>
<p>Accepts a numeric argument and returns a Float64 number close to 2^x.</p>
<h3 id="log2x">log2(x)</h3>
<p>Accepts a numeric argument and returns a Float64 number close to the binary logarithm of the argument.</p>
<h3 id="exp10x">exp10(x)</h3>
<p>Accepts a numeric argument and returns a Float64 number close to 10^x.</p>
<h3 id="log10x">log10(x)</h3>
<p>Accepts a numeric argument and returns a Float64 number close to the decimal logarithm of the argument.</p>
<h3 id="sqrtx">sqrt(x)</h3>
<p>Accepts a numeric argument and returns a Float64 number close to the square root of the argument.</p>
<h3 id="cbrtx">cbrt(x)</h3>
<p>Accepts a numeric argument and returns a Float64 number close to the cubic root of the argument.</p>
<h3 id="erfx">erf(x)</h3>
<p>If 'x' is non-negative, then erf(x / σ√2)<g> is the probability that a random variable having a normal distribution with standard deviation 'σ' takes the value that is separated from the expected value by more than 'x'.</p>
<p>Example (three sigma rule):</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">erf</span><span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─erf(divide(3, sqrt(2)))─┐
│      0.9973002039367398 │
└─────────────────────────┘
</pre></div>


<h3 id="erfcx">erfc(x)</h3>
<p>Accepts a numeric argument and returns a Float64 number close to 1 - erf(x), but without loss of precision for large 'x' values.</p>
<h3 id="lgammax">lgamma(x)</h3>
<p>The logarithm of the gamma function.</p>
<h3 id="tgammax">tgamma(x)</h3>
<p>Gamma function.</p>
<h3 id="sinx">sin(x)</h3>
<p>The sine.</p>
<h3 id="cosx">cos(x)</h3>
<p>The cosine.</p>
<h3 id="tanx">tan(x)</h3>
<p>The tangent.</p>
<h3 id="asinx">asin(x)</h3>
<p>The arc sine.</p>
<h3 id="acosx">acos(x)</h3>
<p>The arc cosine.</p>
<h3 id="atanx">atan(x)</h3>
<p>The arc tangent.</p>
<h3 id="powx-y">pow(x, y)</h3>
<p>Accepts two numeric arguments and returns a Float64 number close to x^y.</p>
<h2 id="rounding-functions">Rounding functions</h2>
<h3 id="floorx91-n93">floor(x[, N])</h3>
<p>Returns the largest round number that is less than or equal to x. A round number is a multiple of 1/10N, or the nearest number of the appropriate data type if 1 / 10N isn't exact.
'N' is an integer constant, optional parameter. By default it is zero, which means to round to an integer.
'N' may be negative.</p>
<p>Examples: <code>floor(123.45, 1) = 123.4, floor(123.45, -1) = 120.</code></p>
<p><code>x</code> is any numeric type. The result is a number of the same type.
For integer arguments, it makes sense to round with a negative 'N' value (for non-negative 'N', the function doesn't do anything).
If rounding causes overflow (for example, floor(-128, -1)), an implementation-specific result is returned.</p>
<h3 id="ceilx91-n93">ceil(x[, N])</h3>
<p>Returns the smallest round number that is greater than or equal to 'x'. In every other way, it is the same as the 'floor' function (see above).</p>
<h3 id="roundx91-n93">round(x[, N])</h3>
<p>Returns the round number nearest to 'num', which may be less than, greater than, or equal to 'x'.If 'x' is exactly in the middle between the nearest round numbers, one of them is returned (implementation-specific).
The number '-0.' may or may not be considered round (implementation-specific).
In every other way, this function is the same as 'floor' and 'ceil' described above.</p>
<h3 id="roundtoexp2num">roundToExp2(num)</h3>
<p>Accepts a number. If the number is less than one, it returns 0. Otherwise, it rounds the number down to the nearest (whole non-negative) degree of two.</p>
<h3 id="rounddurationnum">roundDuration(num)</h3>
<p>Accepts a number. If the number is less than one, it returns 0. Otherwise, it rounds the number down to numbers from the set: 1, 10, 30, 60, 120, 180, 240, 300, 600, 1200, 1800, 3600, 7200, 18000, 36000. This function is specific to Yandex.Metrica and used for implementing the report on session length</p>
<h3 id="roundagenum">roundAge(num)</h3>
<p>Accepts a number. If the number is less than 18, it returns 0. Otherwise, it rounds the number down to a number from the set: 18, 25, 35, 45, 55. This function is specific to Yandex.Metrica and used for implementing the report on user age.</p>
<h2 id="functions-for-working-with-arrays">Functions for working with arrays</h2>
<h3 id="empty_1">empty</h3>
<p>Returns 1 for an empty array, or 0 for a non-empty array.
The result type is UInt8.
The function also works for strings.</p>
<h3 id="notempty_1">notEmpty</h3>
<p>Returns 0 for an empty array, or 1 for a non-empty array.
The result type is UInt8.
The function also works for strings.</p>
<h3 id="length_1">length</h3>
<p>Returns the number of items in the array.
The result type is UInt64.
The function also works for strings.</p>
<h3 id="emptyarrayuint8-emptyarrayuint16-emptyarrayuint32-emptyarrayuint64">emptyArrayUInt8, emptyArrayUInt16, emptyArrayUInt32, emptyArrayUInt64</h3>
<h3 id="emptyarrayint8-emptyarrayint16-emptyarrayint32-emptyarrayint64">emptyArrayInt8, emptyArrayInt16, emptyArrayInt32, emptyArrayInt64</h3>
<h3 id="emptyarrayfloat32-emptyarrayfloat64">emptyArrayFloat32, emptyArrayFloat64</h3>
<h3 id="emptyarraydate-emptyarraydatetime">emptyArrayDate, emptyArrayDateTime</h3>
<h3 id="emptyarraystring">emptyArrayString</h3>
<p>Accepts zero arguments and returns an empty array of the appropriate type.</p>
<h3 id="emptyarraytosingle">emptyArrayToSingle</h3>
<p>Accepts an empty array and returns a one-element array that is equal to the default value.</p>
<h3 id="rangen">range(N)</h3>
<p>Returns an array of numbers from 0 to N-1.
Just in case, an exception is thrown if arrays with a total length of more than 100,000,000 elements are created in a data block.</p>
<h3 id="arrayx1-operator-91x1-93">array(x1, ...), operator [x1, ...]</h3>
<p>Creates an array from the function arguments.
The arguments must be constants and have types that have the smallest common type. At least one argument must be passed, because otherwise it isn't clear which type of array to create. That is, you can't use this function to create an empty array (to do that, use the 'emptyArray*' function described above).
Returns an 'Array(T)' type result, where 'T' is the smallest common type out of the passed arguments.</p>
<h3 id="arrayconcat">arrayConcat</h3>
<p>Combines arrays passed as arguments.</p>
<div class="codehilite"><pre><span></span>arrayConcat(arrays)
</pre></div>


<p><strong>Arguments</strong></p>
<ul>
<li><code>arrays</code> – Arrays of comma-separated <code>[values]</code>.</li>
</ul>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">arrayConcat</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span> <span class="k">AS</span> <span class="n">res</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─res───────────┐
│ [1,2,3,4,5,6] │
└───────────────┘
</pre></div>


<h3 id="arrayelementarr-n-operator-arrn">arrayElement(arr, n), operator arr[n]</h3>
<p>Get the element with the index 'n' from the array 'arr'.'n' must be any integer type.
Indexes in an array begin from one.
Negative indexes are supported. In this case, it selects the corresponding element numbered from the end. For example, 'arr[-1]' is the last item in the array.</p>
<p>If the index falls outside of the bounds of an array, it returns some default value (0 for numbers, an empty string for strings, etc.).</p>
<h3 id="hasarr-elem">has(arr, elem)</h3>
<p>Checks whether the 'arr' array has the 'elem' element.
Returns 0 if the the element is not in the array, or 1 if it is.</p>
<h3 id="indexofarr-x">indexOf(arr, x)</h3>
<p>Returns the index of the 'x' element (starting from 1) if it is in the array, or 0 if it is not.</p>
<h3 id="countequalarr-x">countEqual(arr, x)</h3>
<p>Returns the number of elements in the array equal to x. Equivalent to arrayCount (elem-&gt;  elem = x, arr).</p>
<h3 id="arrayenumeratearr">arrayEnumerate(arr)</h3>
<p>Returns the array [1, 2, 3, ..., length (arr) ]</p>
<p>This function is normally used with ARRAY JOIN. It allows counting something just once for each array after applying ARRAY JOIN. Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="k">count</span><span class="p">()</span> <span class="k">AS</span> <span class="n">Reaches</span><span class="p">,</span>
    <span class="n">countIf</span><span class="p">(</span><span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Hits</span>
<span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">hits</span>
<span class="nb">ARRAY</span> <span class="k">JOIN</span>
    <span class="n">GoalsReached</span><span class="p">,</span>
    <span class="n">arrayEnumerate</span><span class="p">(</span><span class="n">GoalsReached</span><span class="p">)</span> <span class="k">AS</span> <span class="n">num</span>
<span class="k">WHERE</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">160656</span>
<span class="k">LIMIT</span> <span class="mi">10</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─Reaches─┬──Hits─┐
│   95606 │ 31406 │
└─────────┴───────┘
</pre></div>


<p>In this example, Reaches is the number of conversions (the strings received after applying ARRAY JOIN), and Hits is the number of pageviews (strings before ARRAY JOIN). In this particular case, you can get the same result in an easier way:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="k">sum</span><span class="p">(</span><span class="k">length</span><span class="p">(</span><span class="n">GoalsReached</span><span class="p">))</span> <span class="k">AS</span> <span class="n">Reaches</span><span class="p">,</span>
    <span class="k">count</span><span class="p">()</span> <span class="k">AS</span> <span class="n">Hits</span>
<span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">hits</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="n">CounterID</span> <span class="o">=</span> <span class="mi">160656</span><span class="p">)</span> <span class="k">AND</span> <span class="n">notEmpty</span><span class="p">(</span><span class="n">GoalsReached</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─Reaches─┬──Hits─┐
│   95606 │ 31406 │
└─────────┴───────┘
</pre></div>


<p>This function can also be used in higher-order functions. For example, you can use it to get array indexes for elements that match a condition.</p>
<h3 id="arrayenumerateuniqarr">arrayEnumerateUniq(arr, ...)</h3>
<p>Returns an array the same size as the source array, indicating for each element what its position is among elements with the same value.
For example: arrayEnumerateUniq([10, 20, 10, 30]) = [1,  1,  2,  1].</p>
<p>This function is useful when using ARRAY JOIN and aggregation of array elements.
Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="n">Goals</span><span class="p">.</span><span class="n">ID</span> <span class="k">AS</span> <span class="n">GoalID</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">Sign</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Reaches</span><span class="p">,</span>
    <span class="n">sumIf</span><span class="p">(</span><span class="n">Sign</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Visits</span>
<span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">visits</span>
<span class="nb">ARRAY</span> <span class="k">JOIN</span>
    <span class="n">Goals</span><span class="p">,</span>
    <span class="n">arrayEnumerateUniq</span><span class="p">(</span><span class="n">Goals</span><span class="p">.</span><span class="n">ID</span><span class="p">)</span> <span class="k">AS</span> <span class="n">num</span>
<span class="k">WHERE</span> <span class="n">CounterID</span> <span class="o">=</span> <span class="mi">160656</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">GoalID</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">Reaches</span> <span class="k">DESC</span>
<span class="k">LIMIT</span> <span class="mi">10</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌──GoalID─┬─Reaches─┬─Visits─┐
│   53225 │    3214 │   1097 │
│ 2825062 │    3188 │   1097 │
│   56600 │    2803 │    488 │
│ 1989037 │    2401 │    365 │
│ 2830064 │    2396 │    910 │
│ 1113562 │    2372 │    373 │
│ 3270895 │    2262 │    812 │
│ 1084657 │    2262 │    345 │
│   56599 │    2260 │    799 │
│ 3271094 │    2256 │    812 │
└─────────┴─────────┴────────┘
</pre></div>


<p>In this example, each goal ID has a calculation of the number of conversions (each element in the Goals nested data structure is a goal that was reached, which we refer to as a conversion) and the number of sessions. Without ARRAY JOIN, we would have counted the number of sessions as sum(Sign). But in this particular case, the rows were multiplied by the nested Goals structure, so in order to count each session one time after this, we apply a condition to the value of the arrayEnumerateUniq(Goals.ID) function.</p>
<p>The arrayEnumerateUniq function can take multiple arrays of the same size as arguments. In this case, uniqueness is considered for tuples of elements in the same positions in all the arrays.</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">arrayEnumerateUniq</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="k">AS</span> <span class="n">res</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─res───────────┐
│ [1,2,1,1,2,1] │
└───────────────┘
</pre></div>


<p>This is necessary when using ARRAY JOIN with a nested data structure and further aggregation across multiple elements in this structure.</p>
<h3 id="arraypopback">arrayPopBack</h3>
<p>Removes the last item from the array.</p>
<div class="codehilite"><pre><span></span>arrayPopBack(array)
</pre></div>


<p><strong>Arguments</strong></p>
<ul>
<li><code>array</code> – Array.</li>
</ul>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">arrayPopBack</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span> <span class="k">AS</span> <span class="n">res</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─res───┐
│ [1,2] │
└───────┘
</pre></div>


<h3 id="arraypopfront">arrayPopFront</h3>
<p>Removes the first item from the array.</p>
<div class="codehilite"><pre><span></span>arrayPopFront(array)
</pre></div>


<p><strong>Arguments</strong></p>
<ul>
<li><code>array</code> – Array.</li>
</ul>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">arrayPopFront</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span> <span class="k">AS</span> <span class="n">res</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─res───┐
│ [2,3] │
└───────┘
</pre></div>


<h3 id="arraypushback">arrayPushBack</h3>
<p>Adds one item to the end of the array.</p>
<div class="codehilite"><pre><span></span>arrayPushBack(array, single_value)
</pre></div>


<p><strong>Arguments</strong></p>
<ul>
<li><code>array</code> – Array.</li>
<li><code>single_value</code> – A single value. Only numbers can be added to an array with numbers, and only strings can be added to an array of strings. When adding numbers, ClickHouse automatically sets the <code>single_value</code> type for the data type of the array. For more information about ClickHouse data types, read the section "<a href="#data_types">Data types</a>".</li>
</ul>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">arrayPushBack</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">res</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─res───────┐
│ [&#39;a&#39;,&#39;b&#39;] │
└───────────┘
</pre></div>


<h3 id="arraypushfront">arrayPushFront</h3>
<p>Adds one element to the beginning of the array.</p>
<div class="codehilite"><pre><span></span>arrayPushFront(array, single_value)
</pre></div>


<p><strong>Arguments</strong></p>
<ul>
<li><code>array</code> – Array.</li>
<li><code>single_value</code> – A single value.  Only numbers can be added to an array with numbers, and only strings can be added to an array of strings. When adding numbers, ClickHouse automatically sets the <code>single_value</code> type for the data type of the array.  For more information about ClickHouse data types, read the section "<a href="#data_types">Data types</a>".</li>
</ul>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">arrayPushBack</span><span class="p">([</span><span class="s1">&#39;b&#39;</span><span class="p">],</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">res</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─res───────┐
│ [&#39;a&#39;,&#39;b&#39;] │
└───────────┘
</pre></div>


<h3 id="arrayslice">arraySlice</h3>
<p>Returns a slice of the array.</p>
<div class="codehilite"><pre><span></span>arraySlice(array, offset[, length])
</pre></div>


<p><strong>Arguments</strong></p>
<ul>
<li><code>array</code> –  Array of data.</li>
<li><code>offset</code> – Indent from the edge of the array. A positive value indicates an offset on the left, and a negative value is an indent on the right. Numbering of the array items begins with 1.</li>
<li><code>length</code> - The length of the required slice. If you specify a negative value, the function returns an open slice <code>[offset, array_length - length)</code>. If you omit the value, the function returns the slice <code>[offset, the_end_of_array]</code>.</li>
</ul>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">arraySlice</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">AS</span> <span class="n">res</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─res─────┐
│ [2,3,4] │
└─────────┘
</pre></div>


<h3 id="arrayuniqarr">arrayUniq(arr, ...)</h3>
<p>If one argument is passed, it counts the number of different elements in the array.
If multiple arguments are passed, it counts the number of different tuples of elements at corresponding positions in multiple arrays.</p>
<p>If you want to get a list of unique items in an array, you can use arrayReduce('groupUniqArray', arr).</p>
<h3 id="arrayjoinarr">arrayJoin(arr)</h3>
<p>A special function. See the section <a href="#functions_arrayjoin">"ArrayJoin function"</a>.</p>
<h2 id="functions-for-splitting-and-merging-strings-and-arrays">Functions for splitting and merging strings and arrays</h2>
<h3 id="splitbycharseparator-s">splitByChar(separator, s)</h3>
<p>Splits a string into substrings separated by 'separator'.'separator' must be a string constant consisting of exactly one character.
Returns an array of selected substrings. Empty substrings may be selected if the separator occurs at the beginning or end of the string, or if there are multiple consecutive separators.</p>
<h3 id="splitbystringseparator-s">splitByString(separator, s)</h3>
<p>The same as above, but it uses a string of multiple characters as the separator. The string must be non-empty.</p>
<h3 id="arraystringconcatarr91-separator93">arrayStringConcat(arr[, separator])</h3>
<p>Concatenates the strings listed in the array with the separator.'separator' is an optional parameter: a constant string, set to an empty string by default.
Returns the string.</p>
<h3 id="alphatokenss">alphaTokens(s)</h3>
<p>Selects substrings of consecutive bytes from the ranges a-z and A-Z.Returns an array of substrings.</p>
<h2 id="bit-functions">Bit functions</h2>
<p>Bit functions work for any pair of types from UInt8, UInt16, UInt32, UInt64, Int8, Int16, Int32, Int64, Float32, or Float64.</p>
<p>The result type is an integer with bits equal to the maximum bits of its arguments. If at least one of the arguments is signed, the result is a signed number. If an argument is a floating-point number, it is cast to Int64.</p>
<h3 id="bitanda-b">bitAnd(a, b)</h3>
<h3 id="bitora-b">bitOr(a, b)</h3>
<h3 id="bitxora-b">bitXor(a, b)</h3>
<h3 id="bitnota">bitNot(a)</h3>
<h3 id="bitshiftlefta-b">bitShiftLeft(a, b)</h3>
<h3 id="bitshiftrighta-b">bitShiftRight(a, b)</h3>
<h2 id="hash-functions">Hash functions</h2>
<p>Hash functions can be used for deterministic pseudo-random shuffling of elements.</p>
<h3 id="halfmd5">halfMD5</h3>
<p>Calculates the MD5 from a string. Then it takes the first 8 bytes of the hash and interprets them as UInt64 in big endian.
Accepts a String-type argument. Returns UInt64.
This function works fairly slowly (5 million short strings per second per processor core).
If you don't need MD5 in particular, use the 'sipHash64' function instead.</p>
<h3 id="md5">MD5</h3>
<p>Calculates the MD5 from a string and returns the resulting set of bytes as FixedString(16).
If you don't need MD5 in particular, but you need a decent cryptographic 128-bit hash, use the 'sipHash128' function instead.
If you want to get the same result as output by the md5sum utility, use lower(hex(MD5(s))).</p>
<h3 id="siphash64">sipHash64</h3>
<p>Calculates SipHash from a string.
Accepts a String-type argument. Returns UInt64.
SipHash is a cryptographic hash function. It works at least three times faster than MD5.
For more information, see the link: <a href="https://131002.net/siphash/">https://131002.net/siphash/</a></p>
<h3 id="siphash128">sipHash128</h3>
<p>Calculates SipHash from a string.
Accepts a String-type argument. Returns FixedString(16).
Differs from sipHash64 in that the final xor-folding state is only done up to 128 bytes.</p>
<h3 id="cityhash64">cityHash64</h3>
<p>Calculates CityHash64 from a string or a similar hash function for any number of any type of arguments.
For String-type arguments, CityHash is used. This is a fast non-cryptographic hash function for strings with decent quality.
For other types of arguments, a decent implementation-specific fast non-cryptographic hash function is used.
If multiple arguments are passed, the function is calculated using the same rules and chain combinations using the CityHash combinator.
For example, you can compute the checksum of an entire table with accuracy up to the row order: <code>SELECT sum(cityHash64(*)) FROM table</code>.</p>
<h3 id="inthash32">intHash32</h3>
<p>Calculates a 32-bit hash code from any type of integer.
This is a relatively fast non-cryptographic hash function of average quality for numbers.</p>
<h3 id="inthash64">intHash64</h3>
<p>Calculates a 64-bit hash code from any type of integer.
It works faster than intHash32. Average quality.</p>
<h3 id="sha1">SHA1</h3>
<h3 id="sha224">SHA224</h3>
<h3 id="sha256">SHA256</h3>
<p>Calculates SHA-1, SHA-224, or SHA-256 from a string and returns the resulting set of bytes as FixedString(20), FixedString(28), or FixedString(32).
The function works fairly slowly (SHA-1 processes about 5 million short strings per second per processor core, while SHA-224 and SHA-256 process about 2.2 million).
We recommend using this function only in cases when you need a specific hash function and you can't select it.
Even in these cases, we recommend applying the function offline and pre-calculating values when inserting them into the table, instead of applying it in SELECTS.</p>
<h3 id="urlhashurl91-n93">URLHash(url[, N])</h3>
<p>A fast, decent-quality non-cryptographic hash function for a string obtained from a URL using some type of normalization.
<code>URLHash(s)</code> – Calculates a hash from a string without one of the trailing symbols <code>/</code>,<code>?</code> or <code>#</code> at the end, if present.
<code>URLHash(s, N)</code> – Calculates a hash from a string up to the N level in the URL hierarchy, without one of the trailing symbols <code>/</code>,<code>?</code> or <code>#</code> at the end, if present.
Levels are the same as in URLHierarchy. This function is specific to Yandex.Metrica.</p>
<h2 id="functions-for-generating-pseudo-random-numbers">Functions for generating pseudo-random numbers</h2>
<p>Non-cryptographic generators of pseudo-random numbers are used.</p>
<p>All the functions accept zero arguments or one argument.
If an argument is passed, it can be any type, and its value is not used for anything.
The only purpose of this argument is to prevent common subexpression elimination, so that two different instances of the same function return different columns with different random numbers.</p>
<h3 id="rand">rand</h3>
<p>Returns a pseudo-random UInt32 number, evenly distributed among all UInt32-type numbers.
Uses a linear congruential generator.</p>
<h3 id="rand64">rand64</h3>
<p>Returns a pseudo-random UInt64 number, evenly distributed among all UInt64-type numbers.
Uses a linear congruential generator.</p>
<h2 id="encoding-functions">Encoding functions</h2>
<h3 id="hex">hex</h3>
<p>Accepts arguments of types: <code>String</code>, <code>unsigned integer</code>, <code>Date</code>, or <code>DateTime</code>. Returns a string containing the argument's hexadecimal representation. Uses uppercase letters <code>A-F</code>. Does not use <code>0x</code> prefixes or <code>h</code> suffixes. For strings, all bytes are simply encoded as two hexadecimal numbers. Numbers are converted to big endian ("human readable") format. For numbers, older zeros are trimmed, but only by entire bytes. For example, <code>hex (1) = '01'</code>. <code>Date</code> is encoded as the number of days since the beginning of the Unix epoch. <code>DateTime</code> is encoded as the number of seconds since the beginning of the Unix epoch.</p>
<h3 id="unhexstr">unhex(str)</h3>
<p>Accepts a string containing any number of hexadecimal digits, and returns a string containing the corresponding bytes. Supports both uppercase and lowercase letters A-F. The number of hexadecimal digits does not have to be even. If it is odd, the last digit is interpreted as the younger half of the 00-0F byte. If the argument string contains anything other than hexadecimal digits, some implementation-defined result is returned (an exception isn't thrown).
If you want to convert the result to a number, you can use the 'reverse' and 'reinterpretAsType' functions.</p>
<h3 id="uuidstringtonumstr">UUIDStringToNum(str)</h3>
<p>Accepts a string containing 36 characters in the format <code>123e4567-e89b-12d3-a456-426655440000</code>, and returns it as a set of bytes in a FixedString(16).</p>
<h3 id="uuidnumtostringstr">UUIDNumToString(str)</h3>
<p>Accepts a FixedString(16) value. Returns a string containing 36 characters in text format.</p>
<h3 id="bitmasktolistnum">bitmaskToList(num)</h3>
<p>Accepts an integer. Returns a string containing the list of powers of two that total the source number when summed. They are comma-separated without spaces in text format, in ascending order.</p>
<h3 id="bitmasktoarraynum">bitmaskToArray(num)</h3>
<p>Accepts an integer. Returns an array of UInt64 numbers containing the list of powers of two that total the source number when summed. Numbers in the array are in ascending order.</p>
<h2 id="functions-for-working-with-urls">Functions for working with URLs</h2>
<p>All these functions don't follow the RFC. They are maximally simplified for improved performance.</p>
<h3 id="functions-that-extract-part-of-a-url">Functions that extract part of a URL</h3>
<p>If there isn't anything similar in a URL, an empty string is returned.</p>
<h4 id="protocol">protocol</h4>
<p>Returns the protocol. Examples: http, ftp, mailto, magnet...</p>
<h4 id="domain">domain</h4>
<p>Gets the domain.</p>
<h4 id="domainwithoutwww">domainWithoutWWW</h4>
<p>Returns the domain and removes no more than one 'www.' from the beginning of it, if present.</p>
<h4 id="topleveldomain">topLevelDomain</h4>
<p>Returns the top-level domain. Example: .ru.</p>
<h4 id="firstsignificantsubdomain">firstSignificantSubdomain</h4>
<p>Returns the "first significant subdomain". This is a non-standard concept specific to Yandex.Metrica. The first significant subdomain is a second-level domain if it is 'com', 'net', 'org', or 'co'. Otherwise, it is a third-level domain. For example, firstSignificantSubdomain ('<a href="https://news.yandex.ru/">https://news.yandex.ru/</a>') = 'yandex ', firstSignificantSubdomain ('<a href="https://news.yandex.com.tr/">https://news.yandex.com.tr/</a>') = 'yandex '. The list of "insignificant" second-level domains and other implementation details may change in the future.</p>
<h4 id="cuttofirstsignificantsubdomain">cutToFirstSignificantSubdomain</h4>
<p>Returns the part of the domain that includes top-level subdomains up to the "first significant subdomain" (see the explanation above).</p>
<p>For example, <code>cutToFirstSignificantSubdomain('https://news.yandex.com.tr/') = 'yandex.com.tr'</code>.</p>
<h4 id="path">path</h4>
<p>Returns the path. Example: <code>/top/news.html</code>  The path does not include the query string.</p>
<h4 id="pathfull">pathFull</h4>
<p>The same as above, but including query string and fragment. Example: /top/news.html?page=2#comments</p>
<h4 id="querystring">queryString</h4>
<p>Returns the query string. Example: page=1&amp;lr=213. query-string does not include the initial question mark, as well as #  and everything after #.</p>
<h4 id="fragment">fragment</h4>
<p>Returns the fragment identifier. fragment does not include the initial hash symbol.</p>
<h4 id="querystringandfragment">queryStringAndFragment</h4>
<p>Returns the query string and fragment identifier. Example: page=1#29390.</p>
<h4 id="extracturlparameterurl-name">extractURLParameter(URL, name)</h4>
<p>Returns the value of the 'name' parameter in the URL, if present. Otherwise, an empty string. If there are many parameters with this name, it returns the first occurrence. This function works under the assumption that the parameter name is encoded in the URL exactly the same way as in the passed argument.</p>
<h4 id="extracturlparametersurl">extractURLParameters(URL)</h4>
<p>Returns an array of name=value strings corresponding to the URL parameters. The values are not decoded in any way.</p>
<h4 id="extracturlparameternamesurl">extractURLParameterNames(URL)</h4>
<p>Returns an array of name strings corresponding to the names of URL parameters. The values are not decoded in any way.</p>
<h4 id="urlhierarchyurl">URLHierarchy(URL)</h4>
<p>Returns an array containing the URL, truncated at the end by the symbols /,? in the path and query-string. Consecutive separator characters are counted as one. The cut is made in the position after all the consecutive separator characters. Example:</p>
<h4 id="urlpathhierarchyurl">URLPathHierarchy(URL)</h4>
<p>The same as above, but without the protocol and host in the result. The / element (root) is not included. Example: the function is used to implement tree reports the URL in Yandex. Metric.</p>
<div class="codehilite"><pre><span></span>URLPathHierarchy(&#39;https://example.com/browse/CONV-6788&#39;) =
[
    &#39;/browse/&#39;,
    &#39;/browse/CONV-6788&#39;
]
</pre></div>


<h4 id="decodeurlcomponenturl">decodeURLComponent(URL)</h4>
<p>Returns the decoded URL.
Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">decodeURLComponent</span><span class="p">(</span><span class="s1">&#39;http://127.0.0.1:8123/?query=SELECT%201%3B&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">DecodedURL</span><span class="p">;</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─DecodedURL─────────────────────────────┐
│ http://127.0.0.1:8123/?query=SELECT 1; │
└────────────────────────────────────────┘
</pre></div>


<h3 id="functions-that-remove-part-of-a-url">Functions that remove part of a URL.</h3>
<p>If the URL doesn't have anything similar, the URL remains unchanged.</p>
<h4 id="cutwww">cutWWW</h4>
<p>Removes no more than one 'www.' from the beginning of the URL's domain, if present.</p>
<h4 id="cutquerystring">cutQueryString</h4>
<p>Removes query string. The question mark is also removed.</p>
<h4 id="cutfragment">cutFragment</h4>
<p>Removes the fragment identifier. The number sign is also removed.</p>
<h4 id="cutquerystringandfragment">cutQueryStringAndFragment</h4>
<p>Removes the query string and fragment identifier. The question mark and number sign are also removed.</p>
<h4 id="cuturlparameterurl-name">cutURLParameter(URL, name)</h4>
<p>Removes the 'name' URL parameter, if present. This function works under the assumption that the parameter name is encoded in the URL exactly the same way as in the passed argument.</p>
<h2 id="functions-for-working-with-ip-addresses">Functions for working with IP addresses</h2>
<h3 id="ipv4numtostringnum">IPv4NumToString(num)</h3>
<p>Takes a UInt32 number. Interprets it as an IPv4 address in big endian. Returns a string containing the corresponding IPv4 address in the format A.B.C.d (dot-separated numbers in decimal form).</p>
<h3 id="ipv4stringtonums">IPv4StringToNum(s)</h3>
<p>The reverse function of IPv4NumToString. If the IPv4 address has an invalid format, it returns 0.</p>
<h3 id="ipv4numtostringclasscnum">IPv4NumToStringClassC(num)</h3>
<p>Similar to IPv4NumToString, but using xxx instead of the last octet.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="n">IPv4NumToStringClassC</span><span class="p">(</span><span class="n">ClientIP</span><span class="p">)</span> <span class="k">AS</span> <span class="n">k</span><span class="p">,</span>
    <span class="k">count</span><span class="p">()</span> <span class="k">AS</span> <span class="k">c</span>
<span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">hits</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">k</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">c</span> <span class="k">DESC</span>
<span class="k">LIMIT</span> <span class="mi">10</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─k──────────────┬─────c─┐
│ 83.149.9.xxx   │ 26238 │
│ 217.118.81.xxx │ 26074 │
│ 213.87.129.xxx │ 25481 │
│ 83.149.8.xxx   │ 24984 │
│ 217.118.83.xxx │ 22797 │
│ 78.25.120.xxx  │ 22354 │
│ 213.87.131.xxx │ 21285 │
│ 78.25.121.xxx  │ 20887 │
│ 188.162.65.xxx │ 19694 │
│ 83.149.48.xxx  │ 17406 │
└────────────────┴───────┘
</pre></div>


<p>Since using 'xxx' is highly unusual, this may be changed in the future. We recommend that you don't rely on the exact format of this fragment.</p>
<h4 id="ipv6numtostringx">IPv6NumToString(x)</h4>
<p>Accepts a FixedString(16) value containing the IPv6 address in binary format. Returns a string containing this address in text format.
IPv6-mapped IPv4 addresses are output in the format ::ffff:111.222.33.44. Examples:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">IPv6NumToString</span><span class="p">(</span><span class="n">toFixedString</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="s1">&#39;2A0206B8000000000000000000000011&#39;</span><span class="p">),</span> <span class="mi">16</span><span class="p">))</span> <span class="k">AS</span> <span class="n">addr</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─addr─────────┐
│ 2a02:6b8::11 │
└──────────────┘
</pre></div>


<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="n">IPv6NumToString</span><span class="p">(</span><span class="n">ClientIP6</span> <span class="k">AS</span> <span class="n">k</span><span class="p">),</span>
    <span class="k">count</span><span class="p">()</span> <span class="k">AS</span> <span class="k">c</span>
<span class="k">FROM</span> <span class="n">hits_all</span>
<span class="k">WHERE</span> <span class="n">EventDate</span> <span class="o">=</span> <span class="n">today</span><span class="p">()</span> <span class="k">AND</span> <span class="k">substring</span><span class="p">(</span><span class="n">ClientIP6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">unhex</span><span class="p">(</span><span class="s1">&#39;00000000000000000000FFFF&#39;</span><span class="p">)</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">k</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">c</span> <span class="k">DESC</span>
<span class="k">LIMIT</span> <span class="mi">10</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─IPv6NumToString(ClientIP6)──────────────┬─────c─┐
│ 2a02:2168:aaa:bbbb::2                   │ 24695 │
│ 2a02:2698:abcd:abcd:abcd:abcd:8888:5555 │ 22408 │
│ 2a02:6b8:0:fff::ff                      │ 16389 │
│ 2a01:4f8:111:6666::2                    │ 16016 │
│ 2a02:2168:888:222::1                    │ 15896 │
│ 2a01:7e00::ffff:ffff:ffff:222           │ 14774 │
│ 2a02:8109:eee:ee:eeee:eeee:eeee:eeee    │ 14443 │
│ 2a02:810b:8888:888:8888:8888:8888:8888  │ 14345 │
│ 2a02:6b8:0:444:4444:4444:4444:4444      │ 14279 │
│ 2a01:7e00::ffff:ffff:ffff:ffff          │ 13880 │
└─────────────────────────────────────────┴───────┘
</pre></div>


<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="n">IPv6NumToString</span><span class="p">(</span><span class="n">ClientIP6</span> <span class="k">AS</span> <span class="n">k</span><span class="p">),</span>
    <span class="k">count</span><span class="p">()</span> <span class="k">AS</span> <span class="k">c</span>
<span class="k">FROM</span> <span class="n">hits_all</span>
<span class="k">WHERE</span> <span class="n">EventDate</span> <span class="o">=</span> <span class="n">today</span><span class="p">()</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">k</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">c</span> <span class="k">DESC</span>
<span class="k">LIMIT</span> <span class="mi">10</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─IPv6NumToString(ClientIP6)─┬──────c─┐
│ ::ffff:94.26.111.111       │ 747440 │
│ ::ffff:37.143.222.4        │ 529483 │
│ ::ffff:5.166.111.99        │ 317707 │
│ ::ffff:46.38.11.77         │ 263086 │
│ ::ffff:79.105.111.111      │ 186611 │
│ ::ffff:93.92.111.88        │ 176773 │
│ ::ffff:84.53.111.33        │ 158709 │
│ ::ffff:217.118.11.22       │ 154004 │
│ ::ffff:217.118.11.33       │ 148449 │
│ ::ffff:217.118.11.44       │ 148243 │
└────────────────────────────┴────────┘
</pre></div>


<h3 id="ipv6stringtonums">IPv6StringToNum(s)</h3>
<p>The reverse function of IPv6NumToString. If the IPv6 address has an invalid format, it returns a string of null bytes.
HEX can be uppercase or lowercase.</p>
<h2 id="functions-for-working-with-json">Functions for working with JSON</h2>
<p>In Yandex.Metrica, JSON is transmitted by users as session parameters. There are some special functions for working with this JSON. (Although in most of the cases, the JSONs are additionally pre-processed, and the resulting values are put in separate columns in their processed format.) All these functions are based on strong assumptions about what the JSON can be, but they try to do as little as possible to get the job done.</p>
<p>The following assumptions are made:</p>
<ol>
<li>The field name (function argument) must be a constant.</li>
<li>The field name is somehow canonically encoded in JSON. For example: <code>visitParamHas('{"abc":"def"}', 'abc') = 1</code>, but <code>visitParamHas('{"\\u0061\\u0062\\u0063":"def"}', 'abc') = 0</code></li>
<li>Fields are searched for on any nesting level, indiscriminately. If there are multiple matching fields, the first occurrence is used.</li>
<li>The JSON doesn't have space characters outside of string literals.</li>
</ol>
<h3 id="visitparamhasparams-name">visitParamHas(params, name)</h3>
<p>Checks whether there is a field with the 'name' name.</p>
<h3 id="visitparamextractuintparams-name">visitParamExtractUInt(params, name)</h3>
<p>Parses UInt64 from the value of the field named 'name'. If this is a string field, it tries to parse a number from the beginning of the string. If the field doesn't exist, or it exists but doesn't contain a number, it returns 0.</p>
<h3 id="visitparamextractintparams-name">visitParamExtractInt(params, name)</h3>
<p>The same as for Int64.</p>
<h3 id="visitparamextractfloatparams-name">visitParamExtractFloat(params, name)</h3>
<p>The same as for Float64.</p>
<h3 id="visitparamextractboolparams-name">visitParamExtractBool(params, name)</h3>
<p>Parses a true/false value. The result is UInt8.</p>
<h3 id="visitparamextractrawparams-name">visitParamExtractRaw(params, name)</h3>
<p>Returns the value of a field, including separators.</p>
<p>Examples:</p>
<div class="codehilite"><pre><span></span>visitParamExtractRaw(&#39;{&quot;abc&quot;:&quot;\\n\\u0000&quot;}&#39;, &#39;abc&#39;) = &#39;&quot;\\n\\u0000&quot;&#39;
visitParamExtractRaw(&#39;{&quot;abc&quot;:{&quot;def&quot;:[1,2,3]}}&#39;, &#39;abc&#39;) = &#39;{&quot;def&quot;:[1,2,3]}&#39;
</pre></div>


<h3 id="visitparamextractstringparams-name">visitParamExtractString(params, name)</h3>
<p>Parses the string in double quotes. The value is unescaped. If unescaping failed, it returns an empty string.</p>
<p>Examples:</p>
<div class="codehilite"><pre><span></span>visitParamExtractString(&#39;{&quot;abc&quot;:&quot;\\n\\u0000&quot;}&#39;, &#39;abc&#39;) = &#39;\n\0&#39;
visitParamExtractString(&#39;{&quot;abc&quot;:&quot;\\u263a&quot;}&#39;, &#39;abc&#39;) = &#39;☺&#39;
visitParamExtractString(&#39;{&quot;abc&quot;:&quot;\\u263&quot;}&#39;, &#39;abc&#39;) = &#39;&#39;
visitParamExtractString(&#39;{&quot;abc&quot;:&quot;hello}&#39;, &#39;abc&#39;) = &#39;&#39;
</pre></div>


<p>There is currently no support for code points in the format <code>\uXXXX\uYYYY</code> that are not from the basic multilingual plane (they are converted to CESU-8 instead of UTF-8).</p>
<h2 id="higher-order-functions">Higher-order functions</h2>
<h3 id="-operator-lambdaparams-expr-function"><code>-&gt;</code> operator, lambda(params, expr) function</h3>
<p>Allows describing a lambda function for passing to a higher-order function. The left side of the arrow has a formal parameter, which is any ID, or multiple formal parameters – any IDs in a tuple. The right side of the arrow has an expression that can use these formal parameters, as well as any table columns.</p>
<p>Examples: <code>x -&gt; 2 * x, str -&gt; str != Referer.</code></p>
<p>Higher-order functions can only accept lambda functions as their functional argument.</p>
<p>A lambda function that accepts multiple arguments can be passed to a higher-order function. In this case, the higher-order function is passed several arrays of identical length that these arguments will correspond to.</p>
<p>For all functions other than 'arrayMap' and 'arrayFilter', the first argument (the lambda function) can be omitted. In this case, identical mapping is assumed.</p>
<h4 id="arraymapfunc-arr1">arrayMap(func, arr1, ...)</h4>
<p>Returns an array obtained from the original application of the 'func' function to each element in the 'arr' array.</p>
<h4 id="arrayfilterfunc-arr1">arrayFilter(func, arr1, ...)</h4>
<p>Returns an array containing only the elements in 'arr1' for which 'func' returns something other than 0.</p>
<p>Examples:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">arrayFilter</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="k">LIKE</span> <span class="s1">&#39;%World%&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Hello&#39;</span><span class="p">,</span> <span class="s1">&#39;abc World&#39;</span><span class="p">])</span> <span class="k">AS</span> <span class="n">res</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─res───────────┐
│ [&#39;abc World&#39;] │
└───────────────┘
</pre></div>


<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="n">arrayFilter</span><span class="p">(</span>
        <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="k">LIKE</span> <span class="s1">&#39;%World%&#39;</span><span class="p">,</span>
        <span class="n">arrayEnumerate</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span>
        <span class="p">[</span><span class="s1">&#39;Hello&#39;</span><span class="p">,</span> <span class="s1">&#39;abc World&#39;</span><span class="p">]</span> <span class="k">AS</span> <span class="n">arr</span><span class="p">)</span>
    <span class="k">AS</span> <span class="n">res</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─res─┐
│ [2] │
└─────┘
</pre></div>


<h4 id="arraycount91func93-arr1">arrayCount([func,] arr1, ...)</h4>
<p>Returns the number of elements in the arr array for which func returns something other than 0. If 'func' is not specified, it returns the number of non-zero elements in the array.</p>
<h4 id="arrayexists91func93-arr1">arrayExists([func,] arr1, ...)</h4>
<p>Returns 1 if there is at least one element in 'arr' for which 'func' returns something other than 0. Otherwise, it returns 0.</p>
<h4 id="arrayall91func93-arr1">arrayAll([func,] arr1, ...)</h4>
<p>Returns 1 if 'func' returns something other than 0 for all the elements in 'arr'. Otherwise, it returns 0.</p>
<h4 id="arraysum91func93-arr1">arraySum([func,] arr1, ...)</h4>
<p>Returns the sum of the 'func' values. If the function is omitted, it just returns the sum of the array elements.</p>
<h4 id="arrayfirstfunc-arr1">arrayFirst(func, arr1, ...)</h4>
<p>Returns the first element in the 'arr1' array for which 'func' returns something other than 0.</p>
<h4 id="arrayfirstindexfunc-arr1">arrayFirstIndex(func, arr1, ...)</h4>
<p>Returns the index of the first element in the 'arr1' array for which 'func' returns something other than 0.</p>
<h4 id="arraycumsum91func93-arr1">arrayCumSum([func,] arr1, ...)</h4>
<p>Returns an array of partial sums of elements in the source array (a running sum). If the <code>func</code> function is specified, then the values of the array elements are converted by this function before summing.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">arrayCumSum</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="k">AS</span> <span class="n">res</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─res──────────┐
│ [1, 2, 3, 4] │
└──────────────┘
</pre></div>


<h4 id="arraysort91func93-arr1">arraySort([func,] arr1, ...)</h4>
<p>Returns an array as result of sorting the elements of <code>arr1</code> in ascending order. If the <code>func</code> function is specified, sorting order is determined by the result of the function <code>func</code> applied to the elements of array (arrays)  </p>
<p>The <a href="https://en.wikipedia.org/wiki/Schwartzian_transform">Schwartzian transform</a> is used to impove sorting efficiency.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">arraySort</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">y</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─res────────────────┐
│ [&#39;world&#39;, &#39;hello&#39;] │
└────────────────────┘
</pre></div>


<h4 id="arrayreversesort91func93-arr1">arrayReverseSort([func,] arr1, ...)</h4>
<p>Returns an array as result of sorting the elements of <code>arr1</code> in descending order. If the <code>func</code> function is specified, sorting order is determined by the result of the function <code>func</code> applied to the elements of array (arrays)  </p>
<h2 id="other-functions">Other functions</h2>
<h3 id="hostname">hostName()</h3>
<p>Returns a string with the name of the host that this function was performed on. For distributed processing, this is the name of the remote server host, if the function is performed on a remote server.</p>
<h3 id="visiblewidthx">visibleWidth(x)</h3>
<p>Calculates the approximate width when outputting values to the console in text format (tab-separated).
This function is used by the system for implementing Pretty formats.</p>
<h3 id="totypenamex">toTypeName(x)</h3>
<p>Returns a string containing the type name of the passed argument.</p>
<h3 id="blocksize">blockSize()</h3>
<p>Gets the size of the block.
In ClickHouse, queries are always run on blocks (sets of column parts). This function allows getting the size of the block that you called it for.</p>
<h3 id="materializex">materialize(x)</h3>
<p>Turns a constant into a full column containing just one value.
In ClickHouse, full columns and constants are represented differently in memory. Functions work differently for constant arguments and normal arguments (different code is executed), although the result is almost always the same. This function is for debugging this behavior.</p>
<h3 id="ignore">ignore(...)</h3>
<p>Accepts any arguments and always returns 0.
However, the argument is still evaluated. This can be used for benchmarks.</p>
<h3 id="sleepseconds">sleep(seconds)</h3>
<p>Sleeps 'seconds' seconds on each data block. You can specify an integer or a floating-point number.</p>
<h3 id="currentdatabase">currentDatabase()</h3>
<p>Returns the name of the current database.
You can use this function in table engine parameters in a CREATE TABLE query where you need to specify the database.</p>
<h3 id="isfinitex">isFinite(x)</h3>
<p>Accepts Float32 and Float64 and returns UInt8 equal to 1 if the argument is not infinite and not a NaN, otherwise 0.</p>
<h3 id="isinfinitex">isInfinite(x)</h3>
<p>Accepts Float32 and Float64 and returns UInt8 equal to 1 if the argument is infinite, otherwise 0. Note that 0 is returned for a NaN.</p>
<h3 id="isnanx">isNaN(x)</h3>
<p>Accepts Float32 and Float64 and returns UInt8 equal to 1 if the argument is a NaN, otherwise 0.</p>
<h3 id="hascolumnintable91hostname91-username91-password939393-database-table-column">hasColumnInTable(['hostname'[, 'username'[, 'password']],] 'database', 'table', 'column')</h3>
<p>Accepts constant strings: database name, table name, and column name. Returns a UInt8 constant expression equal to 1 if there is a column, otherwise 0. If the hostname parameter is set, the test will run on a remote server.
The function throws an exception if the table does not exist.
For elements in a nested data structure, the function checks for the existence of a column. For the nested data structure itself, the function returns 0.</p>
<h3 id="bar">bar</h3>
<p>Allows building a unicode-art diagram.</p>
<p><code>bar (x, min, max, width)</code> draws a band with a width proportional to <code>(x - min)</code> and equal to <code>width</code> characters when <code>x = max</code>.</p>
<p>Parameters:</p>
<ul>
<li><code>x</code> – Value to display.</li>
<li><code>min, max</code> – Integer constants. The value must fit in Int64.</li>
<li><code>width</code> – Constant, positive number, may be a fraction.</li>
</ul>
<p>The band is drawn with accuracy to one eighth of a symbol.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="n">toHour</span><span class="p">(</span><span class="n">EventTime</span><span class="p">)</span> <span class="k">AS</span> <span class="n">h</span><span class="p">,</span>
    <span class="k">count</span><span class="p">()</span> <span class="k">AS</span> <span class="k">c</span><span class="p">,</span>
    <span class="n">bar</span><span class="p">(</span><span class="k">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">600000</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="k">AS</span> <span class="n">bar</span>
<span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">hits</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">h</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">h</span> <span class="k">ASC</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌──h─┬──────c─┬─bar────────────────┐
│  0 │ 292907 │ █████████▋         │
│  1 │ 180563 │ ██████             │
│  2 │ 114861 │ ███▋               │
│  3 │  85069 │ ██▋                │
│  4 │  68543 │ ██▎                │
│  5 │  78116 │ ██▌                │
│  6 │ 113474 │ ███▋               │
│  7 │ 170678 │ █████▋             │
│  8 │ 278380 │ █████████▎         │
│  9 │ 391053 │ █████████████      │
│ 10 │ 457681 │ ███████████████▎   │
│ 11 │ 493667 │ ████████████████▍  │
│ 12 │ 509641 │ ████████████████▊  │
│ 13 │ 522947 │ █████████████████▍ │
│ 14 │ 539954 │ █████████████████▊ │
│ 15 │ 528460 │ █████████████████▌ │
│ 16 │ 539201 │ █████████████████▊ │
│ 17 │ 523539 │ █████████████████▍ │
│ 18 │ 506467 │ ████████████████▊  │
│ 19 │ 520915 │ █████████████████▎ │
│ 20 │ 521665 │ █████████████████▍ │
│ 21 │ 542078 │ ██████████████████ │
│ 22 │ 493642 │ ████████████████▍  │
│ 23 │ 400397 │ █████████████▎     │
└────┴────────┴────────────────────┘
</pre></div>


<p><a name="other_functions-transform"></a></p>
<h3 id="transform">transform</h3>
<p>Transforms a value according to the explicitly defined mapping of some elements to other ones.
There are two variations of this function:</p>
<ol>
<li><code>transform(x, array_from, array_to, default)</code></li>
</ol>
<p><code>x</code> – What to transform.</p>
<p><code>array_from</code> – Constant array of values for converting.</p>
<p><code>array_to</code> – Constant array of values to convert the values in 'from' to.</p>
<p><code>default</code> – Which value to use if 'x' is not equal to any of the values in 'from'.</p>
<p><code>array_from</code> and <code>array_to</code> – Arrays of the same size.</p>
<p>Types:</p>
<p><code>transform(T, Array(T), Array(U), U) -&gt; U</code></p>
<p><code>T</code> and <code>U</code> can be numeric, string, or Date or DateTime types.
Where the same letter is indicated (T or U), for numeric types these might not be matching types, but types that have a common type.
For example, the first argument can have the Int64 type, while the second has the Array(Uint16) type.</p>
<p>If the 'x' value is equal to one of the elements in the 'array_from' array, it returns the existing element (that is numbered the same) from the 'array_to' array. Otherwise, it returns 'default'. If there are multiple matching elements in 'array_from', it returns one of the matches.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="k">transform</span><span class="p">(</span><span class="n">SearchEngineID</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Yandex&#39;</span><span class="p">,</span> <span class="s1">&#39;Google&#39;</span><span class="p">],</span> <span class="s1">&#39;Other&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">title</span><span class="p">,</span>
    <span class="k">count</span><span class="p">()</span> <span class="k">AS</span> <span class="k">c</span>
<span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">hits</span>
<span class="k">WHERE</span> <span class="n">SearchEngineID</span> <span class="o">!=</span> <span class="mi">0</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">title</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">c</span> <span class="k">DESC</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─title─────┬──────c─┐
│ Yandex    │ 498635 │
│ Google    │ 229872 │
│ Other     │ 104472 │
└───────────┴────────┘
</pre></div>


<ol>
<li><code>transform(x, array_from, array_to)</code></li>
</ol>
<p>Differs from the first variation in that the 'default' argument is omitted.
If the 'x' value is equal to one of the elements in the 'array_from' array, it returns the matching element (that is numbered the same) from the 'array_to' array. Otherwise, it returns 'x'.</p>
<p>Types:</p>
<p><code>transform(T, Array(T), Array(T)) -&gt; T</code></p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="k">transform</span><span class="p">(</span><span class="k">domain</span><span class="p">(</span><span class="n">Referer</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;yandex.ru&#39;</span><span class="p">,</span> <span class="s1">&#39;google.ru&#39;</span><span class="p">,</span> <span class="s1">&#39;vk.com&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;www.yandex&#39;</span><span class="p">,</span> <span class="s1">&#39;example.com&#39;</span><span class="p">])</span> <span class="k">AS</span> <span class="n">s</span><span class="p">,</span>
    <span class="k">count</span><span class="p">()</span> <span class="k">AS</span> <span class="k">c</span>
<span class="k">FROM</span> <span class="n">test</span><span class="p">.</span><span class="n">hits</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">domain</span><span class="p">(</span><span class="n">Referer</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">count</span><span class="p">()</span> <span class="k">DESC</span>
<span class="k">LIMIT</span> <span class="mi">10</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─s──────────────┬───────c─┐
│                │ 2906259 │
│ www.yandex     │  867767 │
│ ███████.ru     │  313599 │
│ mail.yandex.ru │  107147 │
│ ██████.ru      │  100355 │
│ █████████.ru   │   65040 │
│ news.yandex.ru │   64515 │
│ ██████.net     │   59141 │
│ example.com    │   57316 │
└────────────────┴─────────┘
</pre></div>


<h3 id="formatreadablesizex">formatReadableSize(x)</h3>
<p>Accepts the size (number of bytes). Returns a rounded size with a suffix (KiB, MiB, etc.) as a string.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="n">arrayJoin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">192851925</span><span class="p">])</span> <span class="k">AS</span> <span class="n">filesize_bytes</span><span class="p">,</span>
    <span class="n">formatReadableSize</span><span class="p">(</span><span class="n">filesize_bytes</span><span class="p">)</span> <span class="k">AS</span> <span class="n">filesize</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─filesize_bytes─┬─filesize───┐
│              1 │ 1.00 B     │
│           1024 │ 1.00 KiB   │
│        1048576 │ 1.00 MiB   │
│      192851925 │ 183.92 MiB │
└────────────────┴────────────┘
</pre></div>


<h3 id="leasta-b">least(a, b)</h3>
<p>Returns the smallest value from a and b.</p>
<h3 id="greatesta-b">greatest(a, b)</h3>
<p>Returns the largest value of a and b.</p>
<h3 id="uptime">uptime()</h3>
<p>Returns the server's uptime in seconds.</p>
<h3 id="version">version()</h3>
<p>Returns the version of the server as a string.</p>
<h3 id="rownumberinallblocks">rowNumberInAllBlocks()</h3>
<p>Returns the ordinal number of the row in the data block. This function only considers the affected data blocks.</p>
<h3 id="runningdifferencex">runningDifference(x)</h3>
<p>Calculates the difference between successive row values ​​in the data block.
Returns 0 for the first row and the difference from the previous row for each subsequent row.</p>
<p>The result of the function depends on the affected data blocks and the order of data in the block.
If you make a subquery with ORDER BY and call the function from outside the subquery, you can get the expected result.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span>
    <span class="n">EventID</span><span class="p">,</span>
    <span class="n">EventTime</span><span class="p">,</span>
    <span class="n">runningDifference</span><span class="p">(</span><span class="n">EventTime</span><span class="p">)</span> <span class="k">AS</span> <span class="n">delta</span>
<span class="k">FROM</span>
<span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">EventID</span><span class="p">,</span>
        <span class="n">EventTime</span>
    <span class="k">FROM</span> <span class="n">events</span>
    <span class="k">WHERE</span> <span class="n">EventDate</span> <span class="o">=</span> <span class="s1">&#39;2016-11-24&#39;</span>
    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">EventTime</span> <span class="k">ASC</span>
    <span class="k">LIMIT</span> <span class="mi">5</span>
<span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─EventID─┬───────────EventTime─┬─delta─┐
│    1106 │ 2016-11-24 00:00:04 │     0 │
│    1107 │ 2016-11-24 00:00:05 │     1 │
│    1108 │ 2016-11-24 00:00:05 │     0 │
│    1109 │ 2016-11-24 00:00:09 │     4 │
│    1110 │ 2016-11-24 00:00:10 │     1 │
└─────────┴─────────────────────┴───────┘
</pre></div>


<h3 id="macnumtostringnum">MACNumToString(num)</h3>
<p>Accepts a UInt64 number. Interprets it as a MAC address in big endian. Returns a string containing the corresponding MAC address in the format AA:BB:CC:DD:EE:FF (colon-separated numbers in hexadecimal form).</p>
<h3 id="macstringtonums">MACStringToNum(s)</h3>
<p>The inverse function of MACNumToString. If the MAC address has an invalid format, it returns 0.</p>
<h3 id="macstringtoouis">MACStringToOUI(s)</h3>
<p>Accepts a MAC address in the format AA:BB:CC:DD:EE:FF (colon-separated numbers in hexadecimal form). Returns the first three octets as a UInt64 number. If the MAC address has an invalid format, it returns 0.</p>
<p><a name="ext_dict_functions"></a></p>
<h2 id="functions-for-working-with-external-dictionaries">Functions for working with external dictionaries</h2>
<p>For information on connecting and configuring external dictionaries, see "<a href="#dicts-external_dicts">External dictionaries</a>".</p>
<h3 id="dictgetuint8-dictgetuint16-dictgetuint32-dictgetuint64">dictGetUInt8, dictGetUInt16, dictGetUInt32, dictGetUInt64</h3>
<h3 id="dictgetint8-dictgetint16-dictgetint32-dictgetint64">dictGetInt8, dictGetInt16, dictGetInt32, dictGetInt64</h3>
<h3 id="dictgetfloat32-dictgetfloat64">dictGetFloat32, dictGetFloat64</h3>
<h3 id="dictgetdate-dictgetdatetime">dictGetDate, dictGetDateTime</h3>
<h3 id="dictgetuuid">dictGetUUID</h3>
<h3 id="dictgetstring">dictGetString</h3>
<p><code>dictGetT('dict_name', 'attr_name', id)</code></p>
<ul>
<li>Get the value of the attr_name attribute  from the dict_name dictionary using the 'id' key.<code>dict_name</code>  and <code>attr_name</code>  are constant strings.<code>id</code>must be UInt64.
If there is no <code>id</code> key in the dictionary, it returns the default value specified in the dictionary description.</li>
</ul>
<h3 id="dictgettordefault">dictGetTOrDefault</h3>
<p><code>dictGetT('dict_name', 'attr_name', id, default)</code></p>
<p>The same as the <code>dictGetT</code> functions, but the default value is taken from the function's last argument.</p>
<h3 id="dictisin">dictIsIn</h3>
<p><code>dictIsIn('dict_name', child_id, ancestor_id)</code></p>
<ul>
<li>For the 'dict_name' hierarchical dictionary, finds out whether the 'child_id' key is located inside 'ancestor_id' (or matches 'ancestor_id'). Returns UInt8.</li>
</ul>
<h3 id="dictgethierarchy">dictGetHierarchy</h3>
<p><code>dictGetHierarchy('dict_name', id)</code></p>
<ul>
<li>For the 'dict_name' hierarchical dictionary, returns an array of dictionary keys starting from 'id' and continuing along the chain of parent elements. Returns Array(UInt64).</li>
</ul>
<h3 id="dicthas">dictHas</h3>
<p><code>dictHas('dict_name', id)</code></p>
<ul>
<li>Check whether the dictionary has the key. Returns a UInt8 value equal to 0 if there is no key and 1 if there is a key.</li>
</ul>
<h2 id="functions-for-working-with-yandexmetrica-dictionaries">Functions for working with Yandex.Metrica dictionaries</h2>
<p>In order for the functions below to work, the server config must specify the paths and addresses for getting all the Yandex.Metrica dictionaries. The dictionaries are loaded at the first call of any of these functions. If the reference lists can't be loaded, an exception is thrown.</p>
<p>For information about creating reference lists, see the section "Dictionaries".</p>
<h3 id="multiple-geobases">Multiple geobases</h3>
<p>ClickHouse supports working with multiple alternative geobases (regional hierarchies) simultaneously, in order to support various perspectives on which countries certain regions belong to.</p>
<p>The 'clickhouse-server' config specifies the file with the regional hierarchy::<code>&lt;path_to_regions_hierarchy_file&gt;/opt/geo/regions_hierarchy.txt&lt;/path_to_regions_hierarchy_file&gt;</code></p>
<p>Besides this file, it also searches for files nearby that have the _ symbol and any suffix appended to the name (before the file extension).
For example, it will also find the file <code>/opt/geo/regions_hierarchy_ua.txt</code>, if present.</p>
<p><code>ua</code> is called the dictionary key. For a dictionary without a suffix, the key is an empty string.</p>
<p>All the dictionaries are re-loaded in runtime (once every certain number of seconds, as defined in the builtin_dictionaries_reload_interval config parameter, or once an hour by default). However, the list of available dictionaries is defined one time, when the server starts.</p>
<p>All functions for working with regions have an optional argument at the end – the dictionary key. It is referred to as the geobase.
Example:</p>
<div class="codehilite"><pre><span></span>regionToCountry(RegionID) – Uses the default dictionary: /opt/geo/regions_hierarchy.txt
regionToCountry(RegionID, &#39;&#39;) – Uses the default dictionary: /opt/geo/regions_hierarchy.txt
regionToCountry(RegionID, &#39;ua&#39;) – Uses the dictionary for the &#39;ua&#39; key: /opt/geo/regions_hierarchy_ua.txt
</pre></div>


<h4 id="regiontocityid-geobase">regionToCity(id[, geobase])</h4>
<p>Accepts a UInt32 number – the region ID from the Yandex geobase. If this region is a city or part of a city, it returns the region ID for the appropriate city. Otherwise, returns 0.</p>
<h4 id="regiontoareaid91-geobase93">regionToArea(id[, geobase])</h4>
<p>Converts a region to an area (type 5 in the geobase). In every other way, this function is the same as 'regionToCity'.</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">regionToName</span><span class="p">(</span><span class="n">regionToArea</span><span class="p">(</span><span class="n">toUInt32</span><span class="p">(</span><span class="nb">number</span><span class="p">),</span> <span class="s1">&#39;ua&#39;</span><span class="p">))</span>
<span class="k">FROM</span> <span class="k">system</span><span class="p">.</span><span class="n">numbers</span>
<span class="k">LIMIT</span> <span class="mi">15</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─regionToName(regionToArea(toUInt32(number), \&#39;ua\&#39;))─┐
│                                                      │
│ Moscow and Moscow region                             │
│ St. Petersburg and Leningrad region                  │
│ Belgorod region                                      │
│ Ivanovsk region                                      │
│ Kaluga region                                        │
│ Kostroma region                                      │
│ Kursk region                                         │
│ Lipetsk region                                       │
│ Orlov region                                         │
│ Ryazan region                                        │
│ Smolensk region                                      │
│ Tambov region                                        │
│ Tver region                                          │
│ Tula region                                          │
└──────────────────────────────────────────────────────┘
</pre></div>


<h4 id="regiontodistrictid-geobase">regionToDistrict(id[, geobase])</h4>
<p>Converts a region to a federal district (type 4 in the geobase). In every other way, this function is the same as 'regionToCity'.</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">regionToName</span><span class="p">(</span><span class="n">regionToDistrict</span><span class="p">(</span><span class="n">toUInt32</span><span class="p">(</span><span class="nb">number</span><span class="p">),</span> <span class="s1">&#39;ua&#39;</span><span class="p">))</span>
<span class="k">FROM</span> <span class="k">system</span><span class="p">.</span><span class="n">numbers</span>
<span class="k">LIMIT</span> <span class="mi">15</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─regionToName(regionToDistrict(toUInt32(number), \&#39;ua\&#39;))─┐
│                                                          │
│ Central federal district                                 │
│ Northwest federal district                               │
│ South federal district                                   │
│ North Caucases federal district                          │
│ Privolga federal district                                │
│ Ural federal district                                    │
│ Siberian federal district                                │
│ Far East federal district                                │
│ Scotland                                                 │
│ Faroe Islands                                            │
│ Flemish region                                           │
│ Brussels capital region                                  │
│ Wallonia                                                 │
│ Federation of Bosnia and Herzegovina                     │
└──────────────────────────────────────────────────────────┘
</pre></div>


<h4 id="regiontocountryid-geobase">regionToCountry(id[, geobase])</h4>
<p>Converts a region to a country. In every other way, this function is the same as 'regionToCity'.
Example: <code>regionToCountry(toUInt32(213)) = 225</code> converts Moscow (213) to Russia (225).</p>
<h4 id="regiontocontinentid-geobase">regionToContinent(id[, geobase])</h4>
<p>Converts a region to a continent. In every other way, this function is the same as 'regionToCity'.
Example: <code>regionToContinent(toUInt32(213)) = 10001</code> converts Moscow (213) to Eurasia (10001).</p>
<h4 id="regiontopopulationid-geobase">regionToPopulation(id[, geobase])</h4>
<p>Gets the population for a region.
The population can be recorded in files with the geobase. See the section "External dictionaries".
If the population is not recorded for the region, it returns 0.
In the Yandex geobase, the population might be recorded for child regions, but not for parent regions.</p>
<h4 id="regioninlhs-rhs-geobase">regionIn(lhs, rhs[, geobase])</h4>
<p>Checks whether a 'lhs' region belongs to a 'rhs' region. Returns a UInt8 number equal to 1 if it belongs, or 0 if it doesn't belong.
The relationship is reflexive – any region also belongs to itself.</p>
<h4 id="regionhierarchyid91-geobase93">regionHierarchy(id[, geobase])</h4>
<p>Accepts a UInt32 number – the region ID from the Yandex geobase. Returns an array of region IDs consisting of the passed region and all parents along the chain.
Example: <code>regionHierarchy(toUInt32(213)) = [213,1,3,225,10001,10000]</code>.</p>
<h4 id="regiontonameid91-lang93">regionToName(id[, lang])</h4>
<p>Accepts a UInt32 number – the region ID from the Yandex geobase. A string with the name of the language can be passed as a second argument. Supported languages are: ru, en, ua, uk, by, kz, tr. If the second argument is omitted, the language 'ru' is used. If the language is not supported, an exception is thrown. Returns a string – the name of the region in the corresponding language. If the region with the specified ID doesn't exist, an empty string is returned.</p>
<p><code>ua</code> and <code>uk</code> both mean Ukrainian.</p>
<h2 id="functions-for-implementing-the-in-operator">Functions for implementing the IN operator</h2>
<h3 id="in-notin-globalin-globalnotin">in, notIn, globalIn, globalNotIn</h3>
<p>See the section "IN operators".</p>
<h3 id="tuplex-y-operator-x-y">tuple(x, y, ...), operator (x, y, ...)</h3>
<p>A function that allows grouping multiple columns.
For columns with the types T1, T2, ..., it returns a Tuple(T1, T2, ...) type tuple containing these columns. There is no cost to execute the function.
Tuples are normally used as intermediate values for an argument of IN operators, or for creating a list of formal parameters of lambda functions. Tuples can't be written to a table.</p>
<h3 id="tupleelementtuple-n-operator-xn">tupleElement(tuple, n), operator x.N</h3>
<p>A function that allows getting a column from a tuple.
'N' is the column index, starting from 1. N must be a constant. 'N' must be a constant. 'N' must be a strict postive integer no greater than the size of the tuple.
There is no cost to execute the function.</p>
<p><a name="functions_arrayjoin"></a></p>
<h2 id="arrayjoin-function">arrayJoin function</h2>
<p>This is a very unusual function.</p>
<p>Normal functions don't change a set of rows, but just change the values in each row (map).
Aggregate functions compress a set of rows (fold or reduce).
The 'arrayJoin' function takes each row and generates a set of rows (unfold).</p>
<p>This function takes an array as an argument, and propagates the source row to multiple rows for the number of elements in the array.
All the values in columns are simply copied, except the values in the column where this function is applied; it is replaced with the corresponding array value.</p>
<p>A query can use multiple <code>arrayJoin</code> functions. In this case, the transformation is performed multiple times.</p>
<p>Note the ARRAY JOIN syntax in the SELECT query, which provides broader possibilities.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">arrayJoin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="k">AS</span> <span class="n">src</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dst</span><span class="p">,</span> <span class="s1">&#39;Hello&#39;</span><span class="p">,</span> <span class="n">src</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─dst─┬─\&#39;Hello\&#39;─┬─src─────┐
│   1 │ Hello     │ [1,2,3] │
│   2 │ Hello     │ [1,2,3] │
│   3 │ Hello     │ [1,2,3] │
└─────┴───────────┴─────────┘
</pre></div>


<p><a name="aggregate_functions"></a></p>
<h2 id="aggregate-functions">Aggregate functions</h2>
<p>Aggregate functions work in the <a href="http://www.sql-tutorial.com/sql-aggregate-functions-sql-tutorial">normal</a> way as expected by database experts.</p>
<p>ClickHouse also supports:</p>
<ul>
<li><a href="#aggregate_functions_parametric">Parametric aggregate functions</a>, which accept other parameters in addition to columns.</li>
<li><a href="#aggregate_functions_combinators">Combinators</a>, which change the behavior of aggregate functions.</li>
</ul>
<p><a name="aggregate_functions_reference"></a></p>
<h2 id="function-reference">Function reference</h2>
<h3 id="count">count()</h3>
<p>Counts the number of rows. Accepts zero arguments and returns UInt64.
The syntax <code>COUNT(DISTINCT x)</code> is not supported. The separate <code>uniq</code> aggregate function exists for this purpose.</p>
<p>A <code>SELECT count() FROM table</code> query is not optimized, because the number of entries in the table is not stored separately. It will select some small column from the table and count the number of values in it.</p>
<h3 id="anyx">any(x)</h3>
<p>Selects the first encountered value.
The query can be executed in any order and even in a different order each time, so the result of this function is indeterminate.
To get a determinate result, you can use the 'min' or 'max' function instead of 'any'.</p>
<p>In some cases, you can rely on the order of execution. This applies to cases when SELECT comes from a subquery that uses ORDER BY.</p>
<p>When a <code>SELECT</code> query has the <code>GROUP BY</code> clause or at least one aggregate function, ClickHouse (in contrast to MySQL) requires that all expressions in the <code>SELECT</code>, <code>HAVING</code>, and <code>ORDER BY</code> clauses be calculated from keys or from aggregate functions. In other words, each column selected from the table must be used either in keys or inside aggregate functions. To get behavior like in MySQL, you can put the other columns in the <code>any</code> aggregate function.</p>
<h3 id="anyheavyx">anyHeavy(x)</h3>
<p>Selects a frequently occurring value using the <a href="http://www.cs.umd.edu/~samir/498/karp.pdf">heavy hitters</a> algorithm. If there is a value that occurs more than in half the cases in each of the query's execution threads, this value is returned. Normally, the result is nondeterministic.</p>
<div class="codehilite"><pre><span></span>anyHeavy(column)
</pre></div>


<p><strong>Arguments</strong>
- <code>column</code> – The column name.</p>
<p><strong>Example</strong></p>
<p>Take the <a href="#example_datasets-ontime">OnTime</a> data set and select any frequently occurring value in the <code>AirlineID</code> column.</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">anyHeavy</span><span class="p">(</span><span class="n">AirlineID</span><span class="p">)</span> <span class="k">AS</span> <span class="n">res</span>
<span class="k">FROM</span> <span class="n">ontime</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌───res─┐
│ 19690 │
└───────┘
</pre></div>


<h3 id="anylastx">anyLast(x)</h3>
<p>Selects the last value encountered.
The result is just as indeterminate as for the <code>any</code> function.</p>
<h3 id="minx">min(x)</h3>
<p>Calculates the minimum.</p>
<h3 id="maxx">max(x)</h3>
<p>Calculates the maximum.</p>
<h3 id="argminarg-val">argMin(arg, val)</h3>
<p>Calculates the 'arg' value for a minimal 'val' value. If there are several different values of 'arg' for minimal values of 'val', the first of these values encountered is output.</p>
<h3 id="argmaxarg-val">argMax(arg, val)</h3>
<p>Calculates the 'arg' value for a maximum 'val' value. If there are several different values of 'arg' for maximum values of 'val', the first of these values encountered is output.</p>
<h3 id="sumx">sum(x)</h3>
<p>Calculates the sum.
Only works for numbers.</p>
<h3 id="sumwithoverflowx">sumWithOverflow(x)</h3>
<p>Computes the sum of the numbers, using the same data type for the result as for the input parameters. If the sum exceeds the maximum value for this data type, the function returns an error.</p>
<p>Only works for numbers.</p>
<h3 id="summapkey-value">sumMap(key, value)</h3>
<p>Totals the 'value' array according to the keys specified in the 'key' array.
The number of elements in 'key' and 'value' must be the same for each row that is totaled.
Returns a tuple of two arrays: keys in sorted order, and values ​​summed for the corresponding keys.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">sum_map</span><span class="p">(</span>
    <span class="nb">date</span> <span class="nb">Date</span><span class="p">,</span>
    <span class="n">timeslot</span> <span class="n">DateTime</span><span class="p">,</span>
    <span class="n">statusMap</span> <span class="n">Nested</span><span class="p">(</span>
        <span class="n">status</span> <span class="n">UInt16</span><span class="p">,</span>
        <span class="n">requests</span> <span class="n">UInt64</span>
    <span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">Log</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">sum_map</span> <span class="k">VALUES</span>
    <span class="p">(</span><span class="s1">&#39;2000-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-01-01 00:00:00&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]),</span>
    <span class="p">(</span><span class="s1">&#39;2000-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-01-01 00:00:00&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]),</span>
    <span class="p">(</span><span class="s1">&#39;2000-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-01-01 00:01:00&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]),</span>
    <span class="p">(</span><span class="s1">&#39;2000-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-01-01 00:01:00&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]);</span>
<span class="k">SELECT</span>
    <span class="n">timeslot</span><span class="p">,</span>
    <span class="n">sumMap</span><span class="p">(</span><span class="n">statusMap</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="n">statusMap</span><span class="p">.</span><span class="n">requests</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">sum_map</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">timeslot</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌────────────timeslot─┬─sumMap(statusMap.status, statusMap.requests)─┐
│ 2000-01-01 00:00:00 │ ([1,2,3,4,5],[10,10,20,10,10])               │
│ 2000-01-01 00:01:00 │ ([4,5,6,7,8],[10,10,20,10,10])               │
└─────────────────────┴──────────────────────────────────────────────┘
</pre></div>


<h3 id="avgx">avg(x)</h3>
<p>Calculates the average.
Only works for numbers.
The result is always Float64.</p>
<h3 id="uniqx">uniq(x)</h3>
<p>Calculates the approximate number of different values of the argument. Works for numbers, strings, dates, date-with-time, and for multiple arguments and tuple arguments.</p>
<p>Uses an adaptive sampling algorithm: for the calculation state, it uses a sample of element hash values with a size up to 65536.
This algorithm is also very accurate for data sets with low cardinality (up to 65536) and very efficient on CPU (when computing not too many of these functions, using <code>uniq</code> is almost as fast as using other aggregate functions).</p>
<p>The result is determinate (it doesn't depend on the order of query processing).</p>
<p>This function provides excellent accuracy even for data sets with extremely high cardinality (over 10 billion elements). It is recommended for default use.</p>
<h3 id="uniqcombinedx">uniqCombined(x)</h3>
<p>Calculates the approximate number of different values of the argument. Works for numbers, strings, dates, date-with-time, and for multiple arguments and tuple arguments.</p>
<p>A combination of three algorithms is used: array, hash table and <a href="https://en.wikipedia.org/wiki/HyperLogLog">HyperLogLog</a> with an error correction table. The memory consumption is several times smaller than for the <code>uniq</code> function, and the accuracy is several times higher. Performance is slightly lower than for the <code>uniq</code> function, but sometimes it can be even higher than it, such as with distributed queries that transmit a large number of aggregation states over the network. The maximum state size is 96 KiB (HyperLogLog of 217 6-bit cells).</p>
<p>The result is determinate (it doesn't depend on the order of query processing).</p>
<p>The <code>uniqCombined</code> function is a good default choice for calculating the number of different values, but keep in mind that the estimation error will increase for high-cardinality data sets (200M+ elements), and the function will return very inaccurate results for data sets with extremely high cardinality (1B+ elements).</p>
<h3 id="uniqhll12x">uniqHLL12(x)</h3>
<p>Uses the <a href="https://en.wikipedia.org/wiki/HyperLogLog">HyperLogLog</a> algorithm to approximate the number of different values of the argument.
212 5-bit cells are used. The size of the state is slightly more than 2.5 KB. The result is not very accurate (up to ~10% error) for small data sets (&lt;10K elements). However, the result is fairly accurate for high-cardinality data sets (10K-100M), with a maximum error of ~1.6%. Starting from 100M, the estimation error increases, and the function will return very inaccurate results for data sets with extremely high cardinality (1B+ elements).</p>
<p>The result is determinate (it doesn't depend on the order of query processing).</p>
<p>We don't recommend using this function. In most cases, use the  <code>uniq</code> or <code>uniqCombined</code> function.</p>
<h3 id="uniqexactx">uniqExact(x)</h3>
<p>Calculates the number of different values of the argument, exactly.
There is no reason to fear approximations. It's better to use the <code>uniq</code> function.
Use the <code>uniqExact</code> function if you definitely need an exact result.</p>
<p>The <code>uniqExact</code> function uses more memory than the <code>uniq</code> function, because the size of the state has unbounded growth as the number of different values increases.</p>
<h3 id="grouparrayx-grouparraymax_sizex">groupArray(x), groupArray(max_size)(x)</h3>
<p>Creates an array of argument values.
Values can be added to the array in any (indeterminate) order.</p>
<p>The second version (with the <code>max_size</code> parameter) limits the size of the resulting array to <code>max_size</code> elements.
For example, <code>groupArray (1) (x)</code> is equivalent to <code>[any (x)]</code>.</p>
<p>In some cases, you can still rely on the order of execution. This applies to cases when <code>SELECT</code> comes from a subquery that uses <code>ORDER BY</code>.</p>
<p><a name="agg_functions_groupArrayInsertAt"></a></p>
<h3 id="grouparrayinsertatx">groupArrayInsertAt(x)</h3>
<p>Inserts a value into the array in the specified position.</p>
<p>Accepts the value and position as input. If several values ​​are inserted into the same position, any of them might end up in the resulting array (the first one will be used in the case of single-threaded execution). If no value is inserted into a position, the position is assigned the default value.</p>
<p>Optional parameters:</p>
<ul>
<li>The default value for substituting in empty positions.</li>
<li>The length of the resulting array. This allows you to receive arrays of the same size for all the aggregate keys. When using this parameter, the default value must be specified.</li>
</ul>
<h3 id="groupuniqarrayx">groupUniqArray(x)</h3>
<p>Creates an array from different argument values. Memory consumption is the same as for the <code>uniqExact</code> function.</p>
<h3 id="quantilelevelx">quantile(level)(x)</h3>
<p>Approximates the 'level' quantile. 'level' is a constant, a floating-point number from 0 to 1.
We recommend using a 'level' value in the range of 0.01..0.99
Don't use a 'level' value equal to 0 or 1 – use the 'min' and 'max' functions for these cases.</p>
<p>In this function, as well as in all functions for calculating quantiles, the 'level' parameter can be omitted. In this case, it is assumed to be equal to 0.5 (in other words, the function will calculate the median).</p>
<p>Works for numbers, dates, and dates with times.
Returns: for numbers – Float64; for dates – a date; for dates with times – a date with time.</p>
<p>Uses <a href="https://en.wikipedia.org/wiki/Reservoir_sampling">reservoir sampling</a> with a reservoir size up to 8192.
If necessary, the result is output with linear approximation from the two neighboring values.
This algorithm provides very low accuracy. See also: <code>quantileTiming</code>, <code>quantileTDigest</code>, <code>quantileExact</code>.</p>
<p>The result depends on the order of running the query, and is nondeterministic.</p>
<p>When using multiple <code>quantile</code> (and similar) functions with different levels in a query, the internal states are not combined (that is, the query works less efficiently than it could). In this case, use the <code>quantiles</code> (and similar) functions.</p>
<h3 id="quantiledeterministiclevelx-determinator">quantileDeterministic(level)(x, determinator)</h3>
<p>Works the same way as the <code>quantile</code> function, but the result is deterministic and does not depend on the order of query execution.</p>
<p>To achieve this, the function takes a second argument – the "determinator". This is a number whose hash is used instead of a random number generator in the reservoir sampling algorithm. For the function to work correctly, the same determinator value should not occur too often. For the determinator, you can use an event ID, user ID, and so on.</p>
<p>Don't use this function for calculating timings. There is a more suitable function for this purpose: <code>quantileTiming</code>.</p>
<h3 id="quantiletiminglevelx">quantileTiming(level)(x)</h3>
<p>Computes the quantile of 'level' with a fixed precision.
Works for numbers. Intended for calculating quantiles of page loading time in milliseconds.</p>
<p>If the value is greater than 30,000 (a page loading time of more than 30 seconds), the result is equated to 30,000.</p>
<p>If the total value is not more than about 5670, then the calculation is accurate.</p>
<p>Otherwise:</p>
<ul>
<li>if the time is less than 1024 ms, then the calculation is accurate.</li>
<li>otherwise the calculation is rounded to a multiple of 16 ms.</li>
</ul>
<p>When passing negative values to the function, the behavior is undefined.</p>
<p>The returned value has the Float32 type. If no values were passed to the function (when using <code>quantileTimingIf</code>), 'nan' is returned. The purpose of this is to differentiate these instances from zeros. See the note on sorting NaNs in "ORDER BY clause".</p>
<p>The result is determinate (it doesn't depend on the order of query processing).</p>
<p>For its purpose (calculating quantiles of page loading times), using this function is more effective and the result is more accurate than for the <code>quantile</code> function.</p>
<h3 id="quantiletimingweightedlevelx-weight">quantileTimingWeighted(level)(x, weight)</h3>
<p>Differs from the <code>quantileTiming</code>  function in that it has a second argument, "weights". Weight is a non-negative integer.
The result is calculated as if the <code>x</code>  value were passed <code>weight</code> number of times to the <code>quantileTiming</code> function.</p>
<h3 id="quantileexactlevelx">quantileExact(level)(x)</h3>
<p>Computes the quantile of 'level' exactly. To do this, all the passed values ​​are combined into an array, which is then partially sorted. Therefore, the function consumes O(n) memory, where 'n' is the number of values that were passed. However, for a small number of values, the function is very effective.</p>
<h3 id="quantileexactweightedlevelx-weight">quantileExactWeighted(level)(x, weight)</h3>
<p>Computes the quantile of 'level' exactly. In addition, each value is counted with its weight, as if it is present 'weight' times. The arguments of the function can be considered as histograms, where the value 'x' corresponds to a histogram "column" of the height 'weight', and the function itself can be considered as a summation of histograms.</p>
<p>A hash table is used as the algorithm. Because of this, if the passed values ​​are frequently repeated, the function consumes less RAM than <code>quantileExact</code>. You can use this function instead of <code>quantileExact</code> and specify the weight as 1.</p>
<h3 id="quantiletdigestlevelx">quantileTDigest(level)(x)</h3>
<p>Approximates the quantile level using the <a href="https://github.com/tdunning/t-digest/blob/master/docs/t-digest-paper/histo.pdf">t-digest</a> algorithm. The maximum error is 1%. Memory consumption by State is proportional to the logarithm of the number of passed values.</p>
<p>The performance of the function is lower than for <code>quantile</code>, <code>quantileTiming</code>. In terms of the ratio of State size to precision, this function is much better than <code>quantile</code>.</p>
<p>The result depends on the order of running the query, and is nondeterministic.</p>
<h3 id="medianx">median(x)</h3>
<p>All the quantile functions have corresponding median functions: <code>median</code>, <code>medianDeterministic</code>, <code>medianTiming</code>, <code>medianTimingWeighted</code>, <code>medianExact</code>, <code>medianExactWeighted</code>, <code>medianTDigest</code>. They are synonyms and their behavior is identical.</p>
<h3 id="quantileslevel1-level2-x">quantiles(level1, level2, ...)(x)</h3>
<p>All the quantile functions also have corresponding quantiles functions: <code>quantiles</code>, <code>quantilesDeterministic</code>, <code>quantilesTiming</code>, <code>quantilesTimingWeighted</code>, <code>quantilesExact</code>, <code>quantilesExactWeighted</code>, <code>quantilesTDigest</code>. These functions calculate all the quantiles of the listed levels in one pass, and return an array of the resulting values.</p>
<h3 id="varsampx">varSamp(x)</h3>
<p>Calculates the amount <code>Σ((x - x̅)^2) / (n - 1)</code>, where <code>n</code> is the sample size and <code>x̅</code>is the average value of <code>x</code>.</p>
<p>It represents an unbiased estimate of the variance of a random variable, if the values passed to the function are a sample of this random amount.</p>
<p>Returns <code>Float64</code>. When <code>n &lt;= 1</code>, returns <code>+∞</code>.</p>
<h3 id="varpopx">varPop(x)</h3>
<p>Calculates the amount <code>Σ((x - x̅)^2) / (n - 1)</code>, where <code>n</code> is the sample size and <code>x̅</code>is the average value of <code>x</code>.</p>
<p>In other words, dispersion for a set of values. Returns <code>Float64</code>.</p>
<h3 id="stddevsampx">stddevSamp(x)</h3>
<p>The result is equal to the square root of <code>varSamp(x)</code>.</p>
<h3 id="stddevpopx">stddevPop(x)</h3>
<p>The result is equal to the square root of <code>varPop(x)</code>.</p>
<h3 id="topkncolumn">topK(N)(column)</h3>
<p>Returns an array of the most frequent values in the specified column. The resulting array is sorted in descending order of frequency of values (not by the values themselves).</p>
<p>Implements the <a href="http://www.l2f.inesc-id.pt/~fmmb/wiki/uploads/Work/misnis.ref0a.pdf">Filtered Space-Saving</a>  algorithm for analyzing TopK, based on the reduce-and-combine algorithm from <a href="https://arxiv.org/pdf/1401.0702.pdf">Parallel Space Saving</a>.</p>
<div class="codehilite"><pre><span></span>topK(N)(column)
</pre></div>


<p>This function doesn't provide a guaranteed result. In certain situations, errors might occur and it might return frequent values that aren't the most frequent values.</p>
<p>We recommend using the <code>N &lt; 10</code> value; performance is reduced with large <code>N</code> values. Maximum value of <code>N = 65536</code>.</p>
<p><strong>Arguments</strong>
- 'N' is the number of values.
- ' x ' – The column.</p>
<p><strong>Example</strong></p>
<p>Take the <a href="#example_datasets-ontime">OnTime</a> data set and select the three most frequently occurring values in the <code>AirlineID</code> column.</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">topK</span><span class="p">(</span><span class="mi">3</span><span class="p">)(</span><span class="n">AirlineID</span><span class="p">)</span> <span class="k">AS</span> <span class="n">res</span>
<span class="k">FROM</span> <span class="n">ontime</span>
</pre></div>


<div class="codehilite"><pre><span></span>┌─res─────────────────┐
│ [19393,19790,19805] │
└─────────────────────┘
</pre></div>


<h3 id="covarsampx-y">covarSamp(x, y)</h3>
<p>Calculates the value of <code>Σ((x - x̅)(y - y̅)) / (n - 1)</code>.</p>
<p>Returns Float64. When <code>n &lt;= 1</code>, returns +∞.</p>
<h3 id="covarpopx-y">covarPop(x, y)</h3>
<p>Calculates the value of <code>Σ((x - x̅)(y - y̅)) / n</code>.</p>
<h3 id="corrx-y">corr(x, y)</h3>
<p>Calculates the Pearson correlation coefficient: <code>Σ((x - x̅)(y - y̅)) / sqrt(Σ((x - x̅)^2) * Σ((y - y̅)^2))</code>.</p>
<p><a name="aggregate_functions_combinators"></a></p>
<h2 id="aggregate-function-combinators">Aggregate function combinators</h2>
<p>The name of an aggregate function can have a suffix appended to it. This changes the way the aggregate function works.</p>
<h3 id="-if">-If</h3>
<p>The suffix -If can be appended to the name of any aggregate function. In this case, the aggregate function accepts an extra argument – a condition (Uint8 type). The aggregate function processes only the rows that trigger the condition. If the condition was not triggered even once, it returns a default value (usually zeros or empty strings).</p>
<p>Examples: <code>sumIf(column, cond)</code>, <code>countIf(cond)</code>, <code>avgIf(x, cond)</code>, <code>quantilesTimingIf(level1, level2)(x, cond)</code>, <code>argMinIf(arg, val, cond)</code> and so on.</p>
<p>With conditional aggregate functions, you can calculate aggregates for several conditions at once, without using subqueries and <code>JOIN</code>s. For example, in Yandex.Metrica, conditional aggregate functions are used to implement the segment comparison functionality.</p>
<h3 id="-array">-Array</h3>
<p>The -Array suffix can be appended to any aggregate function. In this case, the aggregate function takes arguments of the 'Array(T)' type (arrays) instead of 'T' type arguments. If the aggregate function accepts multiple arguments, this must be arrays of equal lengths. When processing arrays, the aggregate function works like the original aggregate function across all array elements.</p>
<p>Example 1: <code>sumArray(arr)</code> - Totals all the elements of all 'arr' arrays. In this example, it could have been written more simply: <code>sum(arraySum(arr))</code>.</p>
<p>Example 2: <code>uniqArray(arr)</code> – Count the number of unique elements in all 'arr' arrays. This could be done an easier way: <code>uniq(arrayJoin(arr))</code>, but it's not always possible to add 'arrayJoin' to a query.</p>
<p>-If and -Array can be combined. However, 'Array' must come first, then 'If'. Examples: <code>uniqArrayIf(arr, cond)</code>, <code>quantilesTimingArrayIf(level1, level2)(arr, cond)</code>. Due to this order, the 'cond' argument can't be an array.</p>
<h3 id="-state">-State</h3>
<p>If you apply this combinator, the aggregate function doesn't return the resulting value (such as the number of unique values for the 'uniq' function), but an intermediate state of the aggregation (for <code>uniq</code>, this is the hash table for calculating the number of unique values). This is an AggregateFunction(...) that can be used for further processing or stored in a table to finish aggregating later. See the sections "AggregatingMergeTree" and "Functions for working with intermediate aggregation states".</p>
<h3 id="-merge">-Merge</h3>
<p>If you apply this combinator, the aggregate function takes the intermediate aggregation state as an argument, combines the states to finish aggregation, and returns the resulting value.</p>
<h3 id="-mergestate">-MergeState.</h3>
<p>Merges the intermediate aggregation states in the same way as the -Merge combinator. However, it doesn't return the resulting value, but an intermediate aggregation state, similar to the -State combinator.</p>
<h3 id="-foreach">-ForEach</h3>
<p>Converts an aggregate function for tables into an aggregate function for arrays that aggregates the corresponding array items and returns an array of results. For example, <code>sumForEach</code> for the arrays <code>[1, 2]</code>, <code>[3, 4, 5]</code>and<code>[6, 7]</code>returns the result <code>[10, 13, 5]</code> after adding together the corresponding array items.</p>
<p><a name="aggregate_functions_parametric"></a></p>
<h2 id="parametric-aggregate-functions">Parametric aggregate functions</h2>
<p>Some aggregate functions can accept not only argument columns (used for compression), but a set of parameters – constants for initialization. The syntax is two pairs of brackets instead of one. The first is for parameters, and the second is for arguments.</p>
<h3 id="sequencematchpatterntime-cond1-cond2">sequenceMatch(pattern)(time, cond1, cond2, ...)</h3>
<p>Pattern matching for event chains.</p>
<p><code>pattern</code> is a string containing a pattern to match. The pattern is similar to a regular expression.</p>
<p><code>time</code> is the time of the event with the DateTime type.</p>
<p><code>cond1</code>, <code>cond2</code> ... is from one to 32 arguments of type UInt8 that indicate whether a certain condition was met for the event.</p>
<p>The function collects a sequence of events in RAM. Then it checks whether this sequence matches the pattern.
It returns UInt8: 0 if the pattern isn't matched, or 1 if it matches.</p>
<p>Example: <code>sequenceMatch ('(?1).*(?2)')(EventTime, URL LIKE '%company%', URL LIKE '%cart%')</code></p>
<ul>
<li>whether there was a chain of events in which a pageview with 'company' in the address occurred earlier than a pageview with 'cart' in the address.</li>
</ul>
<p>This is a singular example. You could write it using other aggregate functions:</p>
<div class="codehilite"><pre><span></span>minIf(EventTime, URL LIKE &#39;%company%&#39;) &lt; maxIf(EventTime, URL LIKE &#39;%cart%&#39;).
</pre></div>


<p>However, there is no such solution for more complex situations.</p>
<p>Pattern syntax:</p>
<p><code>(?1)</code> refers to the condition (any number can be used in place of 1).</p>
<p><code>.*</code> is any number of any events.</p>
<p><code>(?t&gt;=1800)</code> is a time condition.</p>
<p>Any quantity of any type of events is allowed over the specified time.</p>
<p>Instead of <code>&gt;=</code>,  the following operators can be used:<code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>.</p>
<p>Any number may be specified in place of 1800.</p>
<p>Events that occur during the same second can be put in the chain in any order. This may affect the result of the function.</p>
<h3 id="sequencecountpatterntime-cond1-cond2">sequenceCount(pattern)(time, cond1, cond2, ...)</h3>
<p>Works the same way as the sequenceMatch function, but instead of returning whether there is an event chain, it returns UInt64 with the number of event chains found.
Chains are searched for without overlapping. In other words, the next chain can start only after the end of the previous one.</p>
<h3 id="windowfunnelwindowtimestamp-cond1-cond2-cond3">windowFunnel(window)(timestamp, cond1, cond2, cond3, ....)</h3>
<p>Window funnel matching for event chains, calculates the max event level in a sliding window.</p>
<p><code>window</code> is the timestamp window value, such as 3600.</p>
<p><code>timestamp</code> is the time of the event with the DateTime type or UInt32 type.</p>
<p><code>cond1</code>, <code>cond2</code> ... is from one to 32 arguments of type UInt8 that indicate whether a certain condition was met for the event</p>
<p>Example: </p>
<p>Consider you are doing a website analytics, intend to find out the user counts clicked login button( event = 1001 ), then the user counts followed by searched the phones( event = 1003 and product = 'phone' ) , then the user counts followed by made an order ( event = 1009 ). And all event chains must be in a 3600 seconds sliding window. </p>
<p>This could be easily calculate by <code>windowFunnel</code></p>
<div class="codehilite"><pre><span></span>SELECT
    level,
    count() AS c
FROM
(
    SELECT
        user_id,
        windowFunnel(3600)(timestamp, event_id = 1001, event_id = 1003 AND product = &#39;phone&#39;, event_id = 1009) AS level
    FROM trend_event
    WHERE (event_date &gt;= &#39;2017-01-01&#39;) AND (event_date &lt;= &#39;2017-01-31&#39;)
    GROUP BY user_id
)
GROUP BY level
ORDER BY level
</pre></div>


<p>Simply, the level could only be 0,1,2,3, it means the maxium event action stage that one user could reach.</p>
<h3 id="uniquptonx">uniqUpTo(N)(x)</h3>
<p>Calculates the number of different argument values ​​if it is less than or equal to N. If the number of different argument values is greater than N, it returns N + 1.</p>
<p>Recommended for use with small Ns, up to 10. The maximum value of N is 100.</p>
<p>For the state of an aggregate function, it uses the amount of memory equal to 1 + N * the size of one value of bytes.
For strings, it stores a non-cryptographic hash of 8 bytes. That is, the calculation is approximated for strings.</p>
<p>The function also works for several arguments.</p>
<p>It works as fast as possible, except for cases when a large N value is used and the number of unique values is slightly less than N.</p>
<p>Usage example:</p>
<div class="codehilite"><pre><span></span>Problem: Generate a report that shows only keywords that produced at least 5 unique users.
Solution: Write in the GROUP BY query SearchPhrase HAVING uniqUpTo(4)(UserID) &gt;= 5
</pre></div>


<h2 id="dictionaries">Dictionaries</h2>
<p><code>A dictionary</code> is a mapping (key <code>-&gt;</code> attributes) that can be used in a query as functions.
You can think of this as a more convenient and efficient type of JOIN with dimension tables.</p>
<p>There are built-in (internal) and add-on (external) dictionaries.</p>
<p><a name="dicts-external_dicts"></a></p>
<h2 id="external-dictionaries">External dictionaries</h2>
<p>You can add your own dictionaries from various data sources. The data source for a dictionary can be a local text or executable file, an HTTP(s) resource, or another DBMS. For more information, see "<a href="#dicts-external_dicts_dict_sources">Sources for external dictionaries</a>".</p>
<p>ClickHouse:</p>
<blockquote>
<ul>
<li>Fully or partially stores dictionaries in RAM.</li>
<li>Periodically updates dictionaries and dynamically loads missing values. In other words, dictionaries can be loaded dynamically.</li>
</ul>
</blockquote>
<p>The configuration of external dictionaries is located in one or more files. The path to the configuration is specified in the <a href="#server_settings-dictionaries_config">dictionaries_config</a> parameter.</p>
<p>Dictionaries can be loaded at server startup or at first use, depending on the <a href="#server_settings-dictionaries_lazy_load">dictionaries_lazy_load</a> setting.</p>
<p>The dictionary config file has the following format:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;yandex&gt;</span>
    <span class="nt">&lt;comment&gt;</span>An optional element with any content. Ignored by the ClickHouse server.<span class="nt">&lt;/comment&gt;</span>

    <span class="c">&lt;!--Optional element. File name with substitutions--&gt;</span>
    <span class="nt">&lt;include_from&gt;</span>/etc/metrika.xml<span class="nt">&lt;/include_from&gt;</span>


    <span class="nt">&lt;dictionary&gt;</span>
        <span class="c">&lt;!-- Dictionary configuration --&gt;</span>
    <span class="nt">&lt;/dictionary&gt;</span>

    ...

    <span class="nt">&lt;dictionary&gt;</span>
        <span class="c">&lt;!-- Dictionary configuration --&gt;</span>
    <span class="nt">&lt;/dictionary&gt;</span>
<span class="nt">&lt;/yandex&gt;</span>
</pre></div>


<p>You can <a href="#dicts-external_dicts_dict">configure</a> any number of dictionaries in the same file. The file format is preserved even if there is only one dictionary (i.e. <code>&lt;yandex&gt;&lt;dictionary&gt; &lt;!--configuration -&gt; &lt;/dictionary&gt;&lt;/yandex&gt;</code> ).</p>
<p>See also "<a href="#ext_dict_functions">Functions for working with external dictionaries</a>".</p>
<div class="admonition attention">

You can convert values ​​for a small dictionary by describing it in a `SELECT` query (see the [transform](#other_functions-transform) function). This functionality is not related to external dictionaries.

</div>

<p><a name="dicts-external_dicts_dict"></a></p>
<h2 id="configuring-an-external-dictionary">Configuring an external dictionary</h2>
<p>The dictionary configuration has the following structure:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;dictionary&gt;</span>
    <span class="nt">&lt;name&gt;</span>dict_name<span class="nt">&lt;/name&gt;</span>

    <span class="nt">&lt;source&gt;</span>
      <span class="c">&lt;!-- Source configuration --&gt;</span>
    <span class="nt">&lt;/source&gt;</span>

    <span class="nt">&lt;layout&gt;</span>
      <span class="c">&lt;!-- Memory layout configuration --&gt;</span>
    <span class="nt">&lt;/layout&gt;</span>

    <span class="nt">&lt;structure&gt;</span>
      <span class="c">&lt;!-- Complex key configuration --&gt;</span>
    <span class="nt">&lt;/structure&gt;</span>

    <span class="nt">&lt;lifetime&gt;</span>
      <span class="c">&lt;!-- Lifetime of dictionary in memory --&gt;</span>
    <span class="nt">&lt;/lifetime&gt;</span>
<span class="nt">&lt;/dictionary&gt;</span>
</pre></div>


<ul>
<li>name – The identifier that can be used to access the dictionary. Use the characters <code>[a-zA-Z0-9_\-]</code>.</li>
<li><a href="#dicts-external_dicts_dict_sources">source</a> — Source of the dictionary.</li>
<li><a href="#dicts-external_dicts_dict_layout">layout</a> — Dictionary layout in memory.</li>
<li><a href="#dicts-external_dicts_dict_structure">structure</a> — Structure of the dictionary . A key and attributes that can be retrieved by this key.</li>
<li><a href="#dicts-external_dicts_dict_lifetime">lifetime</a> — Frequency of dictionary updates.</li>
</ul>
<p><a name="dicts-external_dicts_dict_layout"></a></p>
<h2 id="storing-dictionaries-in-memory">Storing dictionaries in memory</h2>
<p>There are a <a href="#dicts-external_dicts_dict_layout-manner">variety of ways</a> to store dictionaries in memory.</p>
<p>We recommend <a href="#dicts-external_dicts_dict_layout-flat">flat</a>, <a href="#dicts-external_dicts_dict_layout-hashed">hashed</a>and<a href="#dicts-external_dicts_dict_layout-complex_key_hashed">complex_key_hashed</a>. which provide optimal processing speed.</p>
<p>Caching is not recommended because of potentially poor performance and difficulties in selecting optimal parameters. Read more in the section "<a href="#dicts-external_dicts_dict_layout-cache">cache</a>".</p>
<p>There are several ways to improve dictionary performance:</p>
<ul>
<li>Call the function for working with the dictionary after <code>GROUP BY</code>.</li>
<li>Mark attributes to extract as injective. An attribute is called injective if different attribute values correspond to different keys. So when <code>GROUP BY</code> uses a function that fetches an attribute value by the key, this function is automatically taken out of <code>GROUP BY</code>.</li>
</ul>
<p>ClickHouse generates an exception for errors with dictionaries. Examples of errors:</p>
<ul>
<li>The dictionary being accessed could not be loaded.</li>
<li>Error querying a <code>cached</code> dictionary.</li>
</ul>
<p>You can view the list of external dictionaries and their statuses in the <code>system.dictionaries</code> table.</p>
<p>The configuration looks like this:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;yandex&gt;</span>
    <span class="nt">&lt;dictionary&gt;</span>
        ...
        <span class="nt">&lt;layout&gt;</span>
            <span class="nt">&lt;layout_type&gt;</span>
                <span class="c">&lt;!-- layout settings --&gt;</span>
            <span class="nt">&lt;/layout_type&gt;</span>
        <span class="nt">&lt;/layout&gt;</span>
        ...
    <span class="nt">&lt;/dictionary&gt;</span>
<span class="nt">&lt;/yandex&gt;</span>
</pre></div>


<p><a name="dicts-external_dicts_dict_layout-manner"></a></p>
<h3 id="ways-to-store-dictionaries-in-memory">Ways to store dictionaries in memory</h3>
<ul>
<li><a href="#dicts-external_dicts_dict_layout-flat">flat</a></li>
<li><a href="#dicts-external_dicts_dict_layout-hashed">hashed</a></li>
<li><a href="#dicts-external_dicts_dict_layout-cache">cache</a></li>
<li><a href="#dicts-external_dicts_dict_layout-range_hashed">range_hashed</a></li>
<li><a href="#dicts-external_dicts_dict_layout-complex_key_hashed">complex_key_hashed</a></li>
<li><a href="#dicts-external_dicts_dict_layout-complex_key_cache">complex_key_cache</a></li>
<li><a href="#dicts-external_dicts_dict_layout-ip_trie">ip_trie</a></li>
</ul>
<p><a name="dicts-external_dicts_dict_layout-flat"></a></p>
<h4 id="flat">flat</h4>
<p>The dictionary is completely stored in memory in the form of flat arrays. How much memory does the dictionary use? The amount is proportional to the size of the largest key (in space used).</p>
<p>The dictionary key has the <code>UInt64</code> type and the value is limited to 500,000. If a larger key is discovered when creating the dictionary, ClickHouse throws an exception and does not create the dictionary.</p>
<p>All types of sources are supported. When updating, data (from a file or from a table) is read in its entirety.</p>
<p>This method provides the best performance among all available methods of storing the dictionary.</p>
<p>Configuration example:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;layout&gt;</span>
  <span class="nt">&lt;flat</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/layout&gt;</span>
</pre></div>


<p><a name="dicts-external_dicts_dict_layout-hashed"></a></p>
<h4 id="hashed">hashed</h4>
<p>The dictionary is completely stored in memory in the form of a hash table. The dictionary can contain any number of elements with any identifiers In practice, the number of keys can reach tens of millions of items.</p>
<p>All types of sources are supported. When updating, data (from a file or from a table) is read in its entirety.</p>
<p>Configuration example:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;layout&gt;</span>
  <span class="nt">&lt;hashed</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/layout&gt;</span>
</pre></div>


<p><a name="dicts-external_dicts_dict_layout-complex_key_hashed"></a></p>
<h4 id="complex_key_hashed">complex_key_hashed</h4>
<p>This type of storage is for use with composite <a href="#dicts-external_dicts_dict_structure">keys</a>. Similar to <code>hashed</code>.</p>
<p>Configuration example:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;layout&gt;</span>
  <span class="nt">&lt;complex_key_hashed</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/layout&gt;</span>
</pre></div>


<p><a name="dicts-external_dicts_dict_layout-range_hashed"></a></p>
<h4 id="range_hashed">range_hashed</h4>
<p>The dictionary is stored in memory in the form of a hash table with an ordered array of ranges and their corresponding values.</p>
<p>This storage method works the same way as hashed and allows using date/time ranges  in addition to the key, if they appear in the dictionary.</p>
<p>Example: The table contains discounts for each advertiser in the format:</p>
<div class="codehilite"><pre><span></span>+---------------+---------------------+-------------------+--------+
| advertiser id | discount start date | discount end date | amount |
+===============+=====================+===================+========+
| 123           | 2015-01-01          | 2015-01-15        | 0.15   |
+---------------+---------------------+-------------------+--------+
| 123           | 2015-01-16          | 2015-01-31        | 0.25   |
+---------------+---------------------+-------------------+--------+
| 456           | 2015-01-01          | 2015-01-15        | 0.05   |
+---------------+---------------------+-------------------+--------+
</pre></div>


<p>To use a sample for date ranges, define the <code>range_min</code> and <code>range_max</code> elements in the <a href="#dicts-external_dicts_dict_structure">structure</a>.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;structure&gt;</span>
    <span class="nt">&lt;id&gt;</span>
        <span class="nt">&lt;name&gt;</span>Id<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;/id&gt;</span>
    <span class="nt">&lt;range_min&gt;</span>
        <span class="nt">&lt;name&gt;</span>first<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;/range_min&gt;</span>
    <span class="nt">&lt;range_max&gt;</span>
        <span class="nt">&lt;name&gt;</span>last<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;/range_max&gt;</span>
    ...
</pre></div>


<p>To work with these dictionaries, you need to pass an additional date argument to the <code>dictGetT</code> function:</p>
<div class="codehilite"><pre><span></span>dictGetT(&#39;dict_name&#39;, &#39;attr_name&#39;, id, date)
</pre></div>


<p>This function returns the value for the specified <code>id</code>s and the date range that includes the passed date.</p>
<p>Details of the algorithm:</p>
<ul>
<li>If the <code>id</code> is not found or a range is not found for the <code>id</code>, it returns the default value for the dictionary.</li>
<li>If there are overlapping ranges, you can use any.</li>
<li>If the range delimiter is <code>NULL</code> or an invalid date (such as 1900-01-01 or 2039-01-01), the range is left open. The range can be open on both sides.</li>
</ul>
<p>Configuration example:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;yandex&gt;</span>
        <span class="nt">&lt;dictionary&gt;</span>

                ...

                <span class="nt">&lt;layout&gt;</span>
                        <span class="nt">&lt;range_hashed</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/layout&gt;</span>

                <span class="nt">&lt;structure&gt;</span>
                        <span class="nt">&lt;id&gt;</span>
                                <span class="nt">&lt;name&gt;</span>Abcdef<span class="nt">&lt;/name&gt;</span>
                        <span class="nt">&lt;/id&gt;</span>
                        <span class="nt">&lt;range_min&gt;</span>
                                <span class="nt">&lt;name&gt;</span>StartDate<span class="nt">&lt;/name&gt;</span>
                        <span class="nt">&lt;/range_min&gt;</span>
                        <span class="nt">&lt;range_max&gt;</span>
                                <span class="nt">&lt;name&gt;</span>EndDate<span class="nt">&lt;/name&gt;</span>
                        <span class="nt">&lt;/range_max&gt;</span>
                        <span class="nt">&lt;attribute&gt;</span>
                                <span class="nt">&lt;name&gt;</span>XXXType<span class="nt">&lt;/name&gt;</span>
                                <span class="nt">&lt;type&gt;</span>String<span class="nt">&lt;/type&gt;</span>
                                <span class="nt">&lt;null_value</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;/attribute&gt;</span>
                <span class="nt">&lt;/structure&gt;</span>

        <span class="nt">&lt;/dictionary&gt;</span>
<span class="nt">&lt;/yandex&gt;</span>
</pre></div>


<p><a name="dicts-external_dicts_dict_layout-cache"></a></p>
<h4 id="cache">cache</h4>
<p>The dictionary is stored in a cache that has a fixed number of cells. These cells contain frequently used elements.</p>
<p>When searching for a dictionary, the cache is searched first. For each block of data, all keys that are not found in the cache or are outdated are requested from the source using <code>SELECT attrs... FROM db.table WHERE id IN (k1, k2, ...)</code>. The received data is then written to the cache.</p>
<p>For cache dictionaries, the expiration <a href="#dicts-external_dicts_dict_lifetime">lifetime</a> of data in the cache can be set. If more time than <code>lifetime</code> has passed since loading the data in a cell, the cell's value is not used, and it is re-requested the next time it needs to be used.</p>
<p>This is the least effective of all the ways to store dictionaries. The speed of the cache depends strongly on correct settings and the usage scenario. A cache type dictionary performs well only when the hit rates are high enough (recommended 99% and higher). You can view the average hit rate in the <code>system.dictionaries</code> table.</p>
<p>To improve cache performance, use a subquery with <code>LIMIT</code>, and call the function with the dictionary externally.</p>
<p>Supported <a href="#dicts-external_dicts_dict_sources">sources</a>: MySQL, ClickHouse, executable, HTTP.</p>
<p>Example of settings:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;layout&gt;</span>
    <span class="nt">&lt;cache&gt;</span>
        <span class="c">&lt;!-- The size of the cache, in number of cells. Rounded up to a power of two. --&gt;</span>
        <span class="nt">&lt;size_in_cells&gt;</span>1000000000<span class="nt">&lt;/size_in_cells&gt;</span>
    <span class="nt">&lt;/cache&gt;</span>
<span class="nt">&lt;/layout&gt;</span>
</pre></div>


<p>Set a large enough cache size. You need to experiment to select the number of cells:</p>
<ol>
<li>Set some value.</li>
<li>Run queries until the cache is completely full.</li>
<li>Assess memory consumption using the <code>system.dictionaries</code> table.</li>
<li>Increase or decrease the number of cells until the required memory consumption is reached.</li>
</ol>
<div class="admonition warning">

Do not use ClickHouse as a source, because it is slow to process queries with random reads.

</div>

<p><a name="dicts-external_dicts_dict_layout-complex_key_cache"></a></p>
<h4 id="complex_key_cache">complex_key_cache</h4>
<p>This type of storage is for use with composite <a href="#dicts-external_dicts_dict_structure">keys</a>. Similar to <code>cache</code>.</p>
<p><a name="dicts-external_dicts_dict_layout-ip_trie"></a></p>
<h4 id="ip_trie">ip_trie</h4>
<p>This type of storage is for mapping network prefixes (IP addresses) to metadata such as ASN.</p>
<p>Example: The table contains network prefixes and their corresponding AS number and country code:</p>
<div class="codehilite"><pre><span></span>  +-----------------+-------+--------+
  | prefix          | asn   | cca2   |
  +=================+=======+========+
  | 202.79.32.0/20  | 17501 | NP     |
  +-----------------+-------+--------+
  | 2620:0:870::/48 | 3856  | US     |
  +-----------------+-------+--------+
  | 2a02:6b8:1::/48 | 13238 | RU     |
  +-----------------+-------+--------+
  | 2001:db8::/32   | 65536 | ZZ     |
  +-----------------+-------+--------+
</pre></div>


<p>When using this type of layout, the structure must have a composite key.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;structure&gt;</span>
    <span class="nt">&lt;key&gt;</span>
        <span class="nt">&lt;attribute&gt;</span>
            <span class="nt">&lt;name&gt;</span>prefix<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>String<span class="nt">&lt;/type&gt;</span>
        <span class="nt">&lt;/attribute&gt;</span>
    <span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;attribute&gt;</span>
            <span class="nt">&lt;name&gt;</span>asn<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>UInt32<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;null_value</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/attribute&gt;</span>
    <span class="nt">&lt;attribute&gt;</span>
            <span class="nt">&lt;name&gt;</span>cca2<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>String<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;null_value&gt;</span>??<span class="nt">&lt;/null_value&gt;</span>
    <span class="nt">&lt;/attribute&gt;</span>
    ...
</pre></div>


<p>The key must have only one String type attribute that contains an allowed IP prefix. Other types are not supported yet.</p>
<p>For queries, you must use the same functions (<code>dictGetT</code> with a tuple) as for dictionaries with composite keys:</p>
<div class="codehilite"><pre><span></span>dictGetT(&#39;dict_name&#39;, &#39;attr_name&#39;, tuple(ip))
</pre></div>


<p>The function takes either <code>UInt32</code> for IPv4, or <code>FixedString(16)</code> for IPv6:</p>
<div class="codehilite"><pre><span></span>dictGetString(&#39;prefix&#39;, &#39;asn&#39;, tuple(IPv6StringToNum(&#39;2001:db8::1&#39;)))
</pre></div>


<p>Other types are not supported yet. The function returns the attribute for the prefix that corresponds to this IP address. If there are overlapping prefixes, the most specific one is returned.</p>
<p>Data is stored in a <code>trie</code>. It must completely fit into RAM.</p>
<p><a name="dicts-external_dicts_dict_lifetime"></a></p>
<h2 id="dictionary-updates">Dictionary updates</h2>
<p>ClickHouse periodically updates the dictionaries. The update interval for fully downloaded dictionaries and the invalidation interval for cached dictionaries are defined in the <code>&lt;lifetime&gt;</code> tag in seconds.</p>
<p>Dictionary updates (other than loading for first use) do not block queries. During updates, the old version of a dictionary is used. If an error occurs during an update, the error is written to the server log, and queries continue using the old version of dictionaries.</p>
<p>Example of settings:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;dictionary&gt;</span>
    ...
    <span class="nt">&lt;lifetime&gt;</span>300<span class="nt">&lt;/lifetime&gt;</span>
    ...
<span class="nt">&lt;/dictionary&gt;</span>
</pre></div>


<p>Setting <code>&lt;lifetime&gt; 0&lt;/lifetime&gt;</code>  prevents updating dictionaries.</p>
<p>You can set a time interval for upgrades, and ClickHouse will choose a uniformly random time within this range. This is necessary in order to distribute the load on the dictionary source when upgrading on a large number of servers.</p>
<p>Example of settings:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;dictionary&gt;</span>
    ...
    <span class="nt">&lt;lifetime&gt;</span>
        <span class="nt">&lt;min&gt;</span>300<span class="nt">&lt;/min&gt;</span>
        <span class="nt">&lt;max&gt;</span>360<span class="nt">&lt;/max&gt;</span>
    <span class="nt">&lt;/lifetime&gt;</span>
    ...
<span class="nt">&lt;/dictionary&gt;</span>
</pre></div>


<p>When upgrading the dictionaries, the ClickHouse server applies different logic depending on the type of <a href="#dicts-external_dicts_dict_sources"> source</a>:</p>
<blockquote>
<ul>
<li>For a text file, it checks the time of modification. If the time differs from the previously recorded time, the dictionary is updated.</li>
<li>For MyISAM tables, the time of modification is checked using a <code>SHOW TABLE STATUS</code> query.</li>
<li>Dictionaries from other sources are updated every time by default.</li>
</ul>
</blockquote>
<p>For MySQL (InnoDB) and ODBC sources, you can set up a query that will update the dictionaries only if they really changed, rather than each time. To do this, follow these steps:</p>
<blockquote>
<ul>
<li>The dictionary table must have a field that always changes when the source data is updated.</li>
<li>The settings of the source must specify a query that retrieves the changing field. The ClickHouse server interprets the query result as a row, and if this row has changed relative to its previous state, the dictionary is updated. Specify the query in the <code>&lt;invalidate_query&gt;</code> field in the settings for the <a href="#dicts-external_dicts_dict_sources">source</a>.</li>
</ul>
</blockquote>
<p>Example of settings:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;dictionary&gt;</span>
    ...
    <span class="nt">&lt;odbc&gt;</span>
      ...
      <span class="nt">&lt;invalidate_query&gt;</span>SELECT update_time FROM dictionary_source where id = 1<span class="nt">&lt;/invalidate_query&gt;</span>
    <span class="nt">&lt;/odbc&gt;</span>
    ...
<span class="nt">&lt;/dictionary&gt;</span>
</pre></div>


<p><a name="dicts-external_dicts_dict_sources"></a></p>
<h2 id="sources-of-external-dictionaries">Sources of external dictionaries</h2>
<p>An external dictionary can be connected from many different sources.</p>
<p>The configuration looks like this:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;yandex&gt;</span>
  <span class="nt">&lt;dictionary&gt;</span>
    ...
    <span class="nt">&lt;source&gt;</span>
      <span class="nt">&lt;source_type&gt;</span>
        <span class="c">&lt;!-- Source configuration --&gt;</span>
      <span class="nt">&lt;/source_type&gt;</span>
    <span class="nt">&lt;/source&gt;</span>
    ...
  <span class="nt">&lt;/dictionary&gt;</span>
  ...
<span class="nt">&lt;/yandex&gt;</span>
</pre></div>


<p>The source is configured in the <code>source</code> section.</p>
<p>Types of sources (<code>source_type</code>):</p>
<ul>
<li><a href="#dicts-external_dicts_dict_sources-local_file">Local file</a></li>
<li><a href="#dicts-external_dicts_dict_sources-executable">Executable file</a></li>
<li><a href="#dicts-external_dicts_dict_sources-http">HTTP(s)</a></li>
<li><a href="#dicts-external_dicts_dict_sources-odbc">ODBC</a></li>
<li>DBMS</li>
<li><a href="#dicts-external_dicts_dict_sources-mysql">MySQL</a></li>
<li><a href="#dicts-external_dicts_dict_sources-clickhouse">ClickHouse</a></li>
<li><a href="#dicts-external_dicts_dict_sources-mongodb">MongoDB</a></li>
</ul>
<p><a name="dicts-external_dicts_dict_sources-local_file"></a></p>
<h3 id="local-file">Local file</h3>
<p>Example of settings:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;source&gt;</span>
  <span class="nt">&lt;file&gt;</span>
    <span class="nt">&lt;path&gt;</span>/opt/dictionaries/os.tsv<span class="nt">&lt;/path&gt;</span>
    <span class="nt">&lt;format&gt;</span>TabSeparated<span class="nt">&lt;/format&gt;</span>
  <span class="nt">&lt;/file&gt;</span>
<span class="nt">&lt;/source&gt;</span>
</pre></div>


<p>Setting fields:</p>
<ul>
<li><code>path</code> – The absolute path to the file.</li>
<li><code>format</code> – The file format. All the formats described in "<a href="#formats">Formats</a>" are supported.</li>
</ul>
<p><a name="dicts-external_dicts_dict_sources-executable"></a></p>
<h3 id="executable-file">Executable file</h3>
<p>Working with executable files depends on <a href="#dicts-external_dicts_dict_layout">how the dictionary is stored in memory</a>. If the dictionary is stored using <code>cache</code> and <code>complex_key_cache</code>, ClickHouse requests the necessary keys by sending a request to the executable file's <code>STDIN</code>.</p>
<p>Example of settings:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;source&gt;</span>
    <span class="nt">&lt;executable&gt;</span>
        <span class="nt">&lt;command&gt;</span>cat /opt/dictionaries/os.tsv<span class="nt">&lt;/command&gt;</span>
        <span class="nt">&lt;format&gt;</span>TabSeparated<span class="nt">&lt;/format&gt;</span>
    <span class="nt">&lt;/executable&gt;</span>
<span class="nt">&lt;/source&gt;</span>
</pre></div>


<p>Setting fields:</p>
<ul>
<li><code>command</code> – The absolute path to the executable file, or the file name (if the program directory is written to <code>PATH</code>).</li>
<li><code>format</code> – The file format. All the formats described in "<a href="#formats">Formats</a>" are supported.</li>
</ul>
<p><a name="dicts-external_dicts_dict_sources-http"></a></p>
<h3 id="https">HTTP(s)</h3>
<p>Working with an HTTP(s) server depends on <a href="#dicts-external_dicts_dict_layout">how the dictionary is stored in memory</a>. If the dictionary is stored using <code>cache</code> and <code>complex_key_cache</code>, ClickHouse requests the necessary keys by sending a request via the <code>POST</code> method.</p>
<p>Example of settings:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;source&gt;</span>
    <span class="nt">&lt;http&gt;</span>
        <span class="nt">&lt;url&gt;</span>http://[::1]/os.tsv<span class="nt">&lt;/url&gt;</span>
        <span class="nt">&lt;format&gt;</span>TabSeparated<span class="nt">&lt;/format&gt;</span>
    <span class="nt">&lt;/http&gt;</span>
<span class="nt">&lt;/source&gt;</span>
</pre></div>


<p>In order for ClickHouse to access an HTTPS resource, you must <a href="#server_settings-openSSL">configure openSSL</a> in the server configuration.</p>
<p>Setting fields:</p>
<ul>
<li><code>url</code> – The source URL.</li>
<li><code>format</code> – The file format. All the formats described in "<a href="#formats">Formats</a>" are supported.</li>
</ul>
<p><a name="dicts-external_dicts_dict_sources-odbc"></a></p>
<h3 id="odbc">ODBC</h3>
<p>You can use this method to connect any database that has an ODBC driver.</p>
<p>Example of settings:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;odbc&gt;</span>
    <span class="nt">&lt;db&gt;</span>DatabaseName<span class="nt">&lt;/db&gt;</span>
    <span class="nt">&lt;table&gt;</span>TableName<span class="nt">&lt;/table&gt;</span>
    <span class="nt">&lt;connection_string&gt;</span>DSN=some_parameters<span class="nt">&lt;/connection_string&gt;</span>
    <span class="nt">&lt;invalidate_query&gt;</span>SQL_QUERY<span class="nt">&lt;/invalidate_query&gt;</span>
<span class="nt">&lt;/odbc&gt;</span>
</pre></div>


<p>Setting fields:</p>
<ul>
<li><code>db</code> – Name of the database. Omit it if the database name is set in the <code>&lt;connection_string&gt;</code> parameters.</li>
<li><code>table</code> – Name of the table.</li>
<li><code>connection_string</code> – Connection string.</li>
<li><code>invalidate_query</code> – Query for checking the dictionary status. Optional parameter. Read more in the section <a href="#dicts-external_dicts_dict_lifetime">Updating dictionaries</a>.</li>
</ul>
<h3 id="example-of-connecting-postgresql">Example of connecting PostgreSQL</h3>
<p>Ubuntu OS.</p>
<p>Installing unixODBC and the ODBC driver for PostgreSQL:</p>
<div class="codehilite"><pre><span></span>sudo apt-get install -y unixodbc odbcinst odbc-postgresql
</pre></div>


<p>Configuring <code>/etc/odbc.ini</code> (or <code>~/.odbc.ini</code>):</p>
<div class="codehilite"><pre><span></span>    [DEFAULT]
    Driver = myconnection

    [myconnection]
    Description         = PostgreSQL connection to my_db
    Driver              = PostgreSQL Unicode
    Database            = my_db
    Servername          = 127.0.0.1
    UserName            = username
    Password            = password
    Port                = 5432
    Protocol            = 9.3
    ReadOnly            = No
    RowVersioning       = No
    ShowSystemTables    = No
    ConnSettings        =
</pre></div>


<p>The dictionary configuration in ClickHouse:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;dictionary&gt;</span>
    <span class="nt">&lt;name&gt;</span>table_name<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;source&gt;</span>
    <span class="nt">&lt;odbc&gt;</span>
        <span class="c">&lt;!-- You can specifiy the following parameters in connection_string: --&gt;</span>
        <span class="c">&lt;!-- DSN=myconnection;UID=username;PWD=password;HOST=127.0.0.1;PORT=5432;DATABASE=my_db --&gt;</span>
            <span class="nt">&lt;connection_string&gt;</span>DSN=myconnection<span class="nt">&lt;/connection_string&gt;</span>
            <span class="nt">&lt;table&gt;</span>postgresql_table<span class="nt">&lt;/table&gt;</span>
        <span class="nt">&lt;/odbc&gt;</span>
    <span class="nt">&lt;/source&gt;</span>
    <span class="nt">&lt;lifetime&gt;</span>
        <span class="nt">&lt;min&gt;</span>300<span class="nt">&lt;/min&gt;</span>
        <span class="nt">&lt;max&gt;</span>360<span class="nt">&lt;/max&gt;</span>
    <span class="nt">&lt;/lifetime&gt;</span>
    <span class="nt">&lt;layout&gt;</span>
        <span class="nt">&lt;hashed/&gt;</span>
    <span class="nt">&lt;/layout&gt;</span>
    <span class="nt">&lt;structure&gt;</span>
        <span class="nt">&lt;id&gt;</span>
            <span class="nt">&lt;name&gt;</span>id<span class="nt">&lt;/name&gt;</span>
        <span class="nt">&lt;/id&gt;</span>
        <span class="nt">&lt;attribute&gt;</span>
            <span class="nt">&lt;name&gt;</span>some_column<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>UInt64<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;null_value&gt;</span>0<span class="nt">&lt;/null_value&gt;</span>
        <span class="nt">&lt;/attribute&gt;</span>
    <span class="nt">&lt;/structure&gt;</span>
<span class="nt">&lt;/dictionary&gt;</span>
</pre></div>


<p>You may need to edit <code>odbc.ini</code> to specify the full path to the library with the driver <code>DRIVER=/usr/local/lib/psqlodbcw.so</code>.</p>
<h4 id="example-of-connecting-ms-sql-server">Example of connecting MS SQL Server</h4>
<p>Ubuntu OS.</p>
<p>Installing the driver: :</p>
<div class="codehilite"><pre><span></span>    sudo apt-get install tdsodbc freetds-bin sqsh
</pre></div>


<p>Configuring the driver: :</p>
<div class="codehilite"><pre><span></span>    $ cat /etc/freetds/freetds.conf 
    ...

    [MSSQL]
    host = 192.168.56.101
    port = 1433
    tds version = 7.0
    client charset = UTF-8

    $ cat /etc/odbcinst.ini 
    ...

    [FreeTDS]
    Description     = FreeTDS
    Driver          = /usr/lib/x86_64-linux-gnu/odbc/libtdsodbc.so
    Setup           = /usr/lib/x86_64-linux-gnu/odbc/libtdsS.so
    FileUsage       = 1
    UsageCount      = 5

    $ cat ~/.odbc.ini 
    ...

    [MSSQL]
    Description     = FreeTDS
    Driver          = FreeTDS
    Servername      = MSSQL
    Database        = test
    UID             = test
    PWD             = test
    Port            = 1433
</pre></div>


<p>Configuring the dictionary in ClickHouse:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;yandex&gt;</span>
    <span class="nt">&lt;dictionary&gt;</span>
        <span class="nt">&lt;name&gt;</span>test<span class="nt">&lt;/name&gt;</span>
        <span class="nt">&lt;source&gt;</span>
            <span class="nt">&lt;odbc&gt;</span>
                <span class="nt">&lt;table&gt;</span>dict<span class="nt">&lt;/table&gt;</span>
                <span class="nt">&lt;connection_string&gt;</span>DSN=MSSQL;UID=test;PWD=test<span class="nt">&lt;/connection_string&gt;</span>
            <span class="nt">&lt;/odbc&gt;</span>
        <span class="nt">&lt;/source&gt;</span>

        <span class="nt">&lt;lifetime&gt;</span>
            <span class="nt">&lt;min&gt;</span>300<span class="nt">&lt;/min&gt;</span>
            <span class="nt">&lt;max&gt;</span>360<span class="nt">&lt;/max&gt;</span>
        <span class="nt">&lt;/lifetime&gt;</span>

        <span class="nt">&lt;layout&gt;</span>
            <span class="nt">&lt;flat</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/layout&gt;</span>

        <span class="nt">&lt;structure&gt;</span>
            <span class="nt">&lt;id&gt;</span>
                <span class="nt">&lt;name&gt;</span>k<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;attribute&gt;</span>
                <span class="nt">&lt;name&gt;</span>s<span class="nt">&lt;/name&gt;</span>
                <span class="nt">&lt;type&gt;</span>String<span class="nt">&lt;/type&gt;</span>
                <span class="nt">&lt;null_value&gt;&lt;/null_value&gt;</span>
            <span class="nt">&lt;/attribute&gt;</span>
        <span class="nt">&lt;/structure&gt;</span>
    <span class="nt">&lt;/dictionary&gt;</span>
<span class="nt">&lt;/yandex&gt;</span>
</pre></div>


<h3 id="dbms">DBMS</h3>
<p><a name="dicts-external_dicts_dict_sources-mysql"></a></p>
<h4 id="mysql_1">MySQL</h4>
<p>Example of settings:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;source&gt;</span>
  <span class="nt">&lt;mysql&gt;</span>
      <span class="nt">&lt;port&gt;</span>3306<span class="nt">&lt;/port&gt;</span>
      <span class="nt">&lt;user&gt;</span>clickhouse<span class="nt">&lt;/user&gt;</span>
      <span class="nt">&lt;password&gt;</span>qwerty<span class="nt">&lt;/password&gt;</span>
      <span class="nt">&lt;replica&gt;</span>
          <span class="nt">&lt;host&gt;</span>example01-1<span class="nt">&lt;/host&gt;</span>
          <span class="nt">&lt;priority&gt;</span>1<span class="nt">&lt;/priority&gt;</span>
      <span class="nt">&lt;/replica&gt;</span>
      <span class="nt">&lt;replica&gt;</span>
          <span class="nt">&lt;host&gt;</span>example01-2<span class="nt">&lt;/host&gt;</span>
          <span class="nt">&lt;priority&gt;</span>1<span class="nt">&lt;/priority&gt;</span>
      <span class="nt">&lt;/replica&gt;</span>
      <span class="nt">&lt;db&gt;</span>db_name<span class="nt">&lt;/db&gt;</span>
      <span class="nt">&lt;table&gt;</span>table_name<span class="nt">&lt;/table&gt;</span>
      <span class="nt">&lt;where&gt;</span>id=10<span class="nt">&lt;/where&gt;</span>
      <span class="nt">&lt;invalidate_query&gt;</span>SQL_QUERY<span class="nt">&lt;/invalidate_query&gt;</span>
  <span class="nt">&lt;/mysql&gt;</span>
<span class="nt">&lt;/source&gt;</span>
</pre></div>


<p>Setting fields:</p>
<ul>
<li>
<p><code>port</code> – The port on the MySQL server. You can specify it for all replicas, or for each one individually (inside <code>&lt;replica&gt;</code>).</p>
</li>
<li>
<p><code>user</code> – Name of the MySQL user. You can specify it for all replicas, or for each one individually (inside <code>&lt;replica&gt;</code>).</p>
</li>
<li>
<p><code>password</code> – Password of the MySQL user. You can specify it for all replicas, or for each one individually (inside <code>&lt;replica&gt;</code>).</p>
</li>
<li>
<p><code>replica</code> – Section of replica configurations. There can be multiple sections.</p>
</li>
<li><code>replica/host</code> – The MySQL host.</li>
</ul>
<p>* <code>replica/priority</code> – The replica priority. When attempting to connect, ClickHouse traverses the replicas in order of priority. The lower the number, the higher the priority.</p>
<ul>
<li>
<p><code>db</code> – Name of the database.</p>
</li>
<li>
<p><code>table</code> – Name of the table.</p>
</li>
<li>
<p><code>where</code> – The selection criteria. Optional parameter.</p>
</li>
<li>
<p><code>invalidate_query</code> – Query for checking the dictionary status. Optional parameter. Read more in the section <a href="#dicts-external_dicts_dict_lifetime">Updating dictionaries</a>.</p>
</li>
</ul>
<p>MySQL can be connected on a local host via sockets. To do this, set <code>host</code> and <code>socket</code>.</p>
<p>Example of settings:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;source&gt;</span>
  <span class="nt">&lt;mysql&gt;</span>
      <span class="nt">&lt;host&gt;</span>localhost<span class="nt">&lt;/host&gt;</span>
      <span class="nt">&lt;socket&gt;</span>/path/to/socket/file.sock<span class="nt">&lt;/socket&gt;</span>
      <span class="nt">&lt;user&gt;</span>clickhouse<span class="nt">&lt;/user&gt;</span>
      <span class="nt">&lt;password&gt;</span>qwerty<span class="nt">&lt;/password&gt;</span>
      <span class="nt">&lt;db&gt;</span>db_name<span class="nt">&lt;/db&gt;</span>
      <span class="nt">&lt;table&gt;</span>table_name<span class="nt">&lt;/table&gt;</span>
      <span class="nt">&lt;where&gt;</span>id=10<span class="nt">&lt;/where&gt;</span>
      <span class="nt">&lt;invalidate_query&gt;</span>SQL_QUERY<span class="nt">&lt;/invalidate_query&gt;</span>
  <span class="nt">&lt;/mysql&gt;</span>
<span class="nt">&lt;/source&gt;</span>
</pre></div>


<p><a name="dicts-external_dicts_dict_sources-clickhouse"></a></p>
<h4 id="clickhouse">ClickHouse</h4>
<p>Example of settings:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;source&gt;</span>
    <span class="nt">&lt;clickhouse&gt;</span>
        <span class="nt">&lt;host&gt;</span>example01-01-1<span class="nt">&lt;/host&gt;</span>
        <span class="nt">&lt;port&gt;</span>9000<span class="nt">&lt;/port&gt;</span>
        <span class="nt">&lt;user&gt;</span>default<span class="nt">&lt;/user&gt;</span>
        <span class="nt">&lt;password&gt;&lt;/password&gt;</span>
        <span class="nt">&lt;db&gt;</span>default<span class="nt">&lt;/db&gt;</span>
        <span class="nt">&lt;table&gt;</span>ids<span class="nt">&lt;/table&gt;</span>
        <span class="nt">&lt;where&gt;</span>id=10<span class="nt">&lt;/where&gt;</span>
    <span class="nt">&lt;/clickhouse&gt;</span>
<span class="nt">&lt;/source&gt;</span>
</pre></div>


<p>Setting fields:</p>
<ul>
<li><code>host</code> – The ClickHouse host. If it is a local host, the query is processed without any network activity. To improve fault tolerance, you can create a <a href="#table_engines-distributed">Distributed</a> table and enter it in subsequent configurations.</li>
<li><code>port</code> – The port on the ClickHouse server.</li>
<li><code>user</code> – Name of the ClickHouse user.</li>
<li><code>password</code> – Password of the ClickHouse user.</li>
<li><code>db</code> – Name of the database.</li>
<li><code>table</code> – Name of the table.</li>
<li><code>where</code> – The selection criteria. May be omitted.</li>
</ul>
<p><a name="dicts-external_dicts_dict_sources-mongodb"></a></p>
<h4 id="mongodb">MongoDB</h4>
<p>Example of settings:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;source&gt;</span>
    <span class="nt">&lt;mongodb&gt;</span>
        <span class="nt">&lt;host&gt;</span>localhost<span class="nt">&lt;/host&gt;</span>
        <span class="nt">&lt;port&gt;</span>27017<span class="nt">&lt;/port&gt;</span>
        <span class="nt">&lt;user&gt;&lt;/user&gt;</span>
        <span class="nt">&lt;password&gt;&lt;/password&gt;</span>
        <span class="nt">&lt;db&gt;</span>test<span class="nt">&lt;/db&gt;</span>
        <span class="nt">&lt;collection&gt;</span>dictionary_source<span class="nt">&lt;/collection&gt;</span>
    <span class="nt">&lt;/mongodb&gt;</span>
<span class="nt">&lt;/source&gt;</span>
</pre></div>


<p>Setting fields:</p>
<ul>
<li><code>host</code> – The MongoDB host.</li>
<li><code>port</code> – The port on the MongoDB server.</li>
<li><code>user</code> – Name of the MongoDB user.</li>
<li><code>password</code> – Password of the MongoDB user.</li>
<li><code>db</code> – Name of the database.</li>
<li><code>collection</code> – Name of the collection.</li>
</ul>
<p><a name="dicts-external_dicts_dict_structure"></a></p>
<h2 id="dictionary-key-and-fields">Dictionary key and fields</h2>
<p>The <code>&lt;structure&gt;</code> clause describes the dictionary key and fields available for queries.</p>
<p>Overall structure:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;dictionary&gt;</span>
    <span class="nt">&lt;structure&gt;</span>
        <span class="nt">&lt;id&gt;</span>
            <span class="nt">&lt;name&gt;</span>Id<span class="nt">&lt;/name&gt;</span>
        <span class="nt">&lt;/id&gt;</span>

        <span class="nt">&lt;attribute&gt;</span>
            <span class="c">&lt;!-- Attribute parameters --&gt;</span>
        <span class="nt">&lt;/attribute&gt;</span>

        ...

    <span class="nt">&lt;/structure&gt;</span>
<span class="nt">&lt;/dictionary&gt;</span>
</pre></div>


<p>Columns are described in the structure:</p>
<ul>
<li><code>&lt;id&gt;</code> - <a href="#dicts-external_dicts_dict_structure-key">key column</a>.</li>
<li><code>&lt;attribute&gt;</code> - <a href="#dicts-external_dicts_dict_structure-attributes">data column</a>. There can be a large number of columns.</li>
</ul>
<p><a name="dicts-external_dicts_dict_structure-key"></a></p>
<h3 id="key">Key</h3>
<p>ClickHouse supports the following types of keys:</p>
<ul>
<li>Numeric key. UInt64. Defined in the tag <code>&lt;id&gt;</code> .</li>
<li>Composite key. Set of values of different types. Defined in the tag <code>&lt;key&gt;</code> .</li>
</ul>
<p>A structure can contain either <code>&lt;id&gt;</code> or <code>&lt;key&gt;</code> .</p>
<div class="admonition attention">

The key doesn't need to be defined separately in attributes.

</div>

<h4 id="numeric-key">Numeric key</h4>
<p>Format: <code>UInt64</code>.</p>
<p>Configuration example:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;id&gt;</span>
    <span class="nt">&lt;name&gt;</span>Id<span class="nt">&lt;/name&gt;</span>
<span class="nt">&lt;/id&gt;</span>
</pre></div>


<p>Configuration fields:</p>
<ul>
<li>name – The name of the column with keys.</li>
</ul>
<h4 id="composite-key">Composite key</h4>
<p>The key can be a <code>tuple</code> from any types of fields. The <a href="#dicts-external_dicts_dict_layout">layout</a> in this case must be <code>complex_key_hashed</code> or <code>complex_key_cache</code>.</p>
<div class="admonition tip">
A composite key can consist of a single element. This makes it possible to use a string as the key, for instance.
</div>

<p>The key structure is set in the element <code>&lt;key&gt;</code>. Key fields are specified in the same format as the dictionary <a href="#dicts-external_dicts_dict_structure-attributes">attributes</a>. Example:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;structure&gt;</span>
    <span class="nt">&lt;key&gt;</span>
        <span class="nt">&lt;attribute&gt;</span>
            <span class="nt">&lt;name&gt;</span>field1<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>String<span class="nt">&lt;/type&gt;</span>
        <span class="nt">&lt;/attribute&gt;</span>
        <span class="nt">&lt;attribute&gt;</span>
            <span class="nt">&lt;name&gt;</span>field2<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>UInt32<span class="nt">&lt;/type&gt;</span>
        <span class="nt">&lt;/attribute&gt;</span>
        ...
    <span class="nt">&lt;/key&gt;</span>
...
</pre></div>


<p>For a query to the <code>dictGet*</code> function, a tuple is passed as the key. Example: <code>dictGetString('dict_name', 'attr_name', tuple('string for field1', num_for_field2))</code>.</p>
<p><a name="dicts-external_dicts_dict_structure-attributes"></a></p>
<h3 id="attributes">Attributes</h3>
<p>Configuration example:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;structure&gt;</span>
    ...
    <span class="nt">&lt;attribute&gt;</span>
        <span class="nt">&lt;name&gt;</span>Name<span class="nt">&lt;/name&gt;</span>
        <span class="nt">&lt;type&gt;</span>Type<span class="nt">&lt;/type&gt;</span>
        <span class="nt">&lt;null_value&gt;&lt;/null_value&gt;</span>
        <span class="nt">&lt;expression&gt;</span>rand64()<span class="nt">&lt;/expression&gt;</span>
        <span class="nt">&lt;hierarchical&gt;</span>true<span class="nt">&lt;/hierarchical&gt;</span>
        <span class="nt">&lt;injective&gt;</span>true<span class="nt">&lt;/injective&gt;</span>
        <span class="nt">&lt;is_object_id&gt;</span>true<span class="nt">&lt;/is_object_id&gt;</span>
    <span class="nt">&lt;/attribute&gt;</span>
<span class="nt">&lt;/structure&gt;</span>
</pre></div>


<p>Configuration fields:</p>
<ul>
<li><code>name</code> – The column name.</li>
<li><code>type</code> – The column type. Sets the method for interpreting data in the source. For example, for MySQL, the field might be <code>TEXT</code>, <code>VARCHAR</code>, or <code>BLOB</code> in the source table, but it can be uploaded as <code>String</code>.</li>
<li><code>null_value</code> – The default value for a non-existing element. In the example, it is an empty string.</li>
<li><code>expression</code> – The attribute can be an expression. The tag is not required.</li>
<li><code>hierarchical</code> – Hierarchical support. Mirrored to the parent identifier. By default, <code>false</code>.</li>
<li><code>injective</code> – Whether the <code>id -&gt; attribute</code> image is injective. If <code>true</code>, then you can optimize the <code>GROUP BY</code> clause. By default, <code>false</code>.</li>
<li><code>is_object_id</code> – Whether the query is executed for a MongoDB document by <code>ObjectID</code>.</li>
</ul>
<h2 id="internal-dictionaries">Internal dictionaries</h2>
<p>ClickHouse contains a built-in feature for working with a geobase.</p>
<p>This allows you to:</p>
<ul>
<li>Use a region's ID to get its name in the desired language.</li>
<li>Use a region's ID to get the ID of a city, area, federal district, country, or continent.</li>
<li>Check whether a region is part of another region.</li>
<li>Get a chain of parent regions.</li>
</ul>
<p>All the functions support "translocality," the ability to simultaneously use different perspectives on region ownership. For more information, see the section "Functions for working with Yandex.Metrica dictionaries".</p>
<p>The internal dictionaries are disabled in the default package.
To enable them, uncomment the parameters <code>path_to_regions_hierarchy_file</code> and <code>path_to_regions_names_files</code> in the server configuration file.</p>
<p>The geobase is loaded from text files.
If you work at Yandex, you can follow these instructions to create them:
<a href="https://github.yandex-team.ru/raw/Metrika/ClickHouse_private/master/doc/create_embedded_geobase_dictionaries.txt">https://github.yandex-team.ru/raw/Metrika/ClickHouse_private/master/doc/create_embedded_geobase_dictionaries.txt</a></p>
<p>Put the regions_hierarchy*.txt files in the path_to_regions_hierarchy_file directory. This configuration parameter must contain the path to the regions_hierarchy.txt file (the default regional hierarchy), and the other files (regions_hierarchy_ua.txt) must be located in the same directory.</p>
<p>Put the <code>regions_names_*.txt</code> files in the path_to_regions_names_files directory.</p>
<p>You can also create these files yourself. The file format is as follows:</p>
<p><code>regions_hierarchy*.txt</code>: TabSeparated (no header), columns:</p>
<ul>
<li>Region ID (UInt32)</li>
<li>Parent region ID (UInt32)</li>
<li>Region type (UInt8): 1 - continent, 3 - country, 4 - federal district, 5 - region, 6 - city; other types don't have values.</li>
<li>Population (UInt32) - Optional column.</li>
</ul>
<p><code>regions_names_*.txt</code>: TabSeparated (no header), columns:</p>
<ul>
<li>Region ID (UInt32)</li>
<li>Region name (String) - Can't contain tabs or line feeds, even escaped ones.</li>
</ul>
<p>A flat array is used for storing in RAM. For this reason, IDs shouldn't be more than a million.</p>
<p>Dictionaries can be updated without restarting the server. However, the set of available dictionaries is not updated.
For updates, the file modification times are checked. If a file has changed, the dictionary is updated.
The interval to check for changes is configured in the 'builtin_dictionaries_reload_interval' parameter.
Dictionary updates (other than loading at first use) do not block queries. During updates, queries use the old versions of dictionaries. If an error occurs during an update, the error is written to the server log, and queries continue using the old version of dictionaries.</p>
<p>We recommend periodically updating the dictionaries with the geobase. During an update, generate new files and write them to a separate location. When everything is ready, rename them to the files used by the server.</p>
<p>There are also functions for working with OS identifiers and Yandex.Metrica search engines, but they shouldn't be used.</p>
<h2 id="usage_1">Usage</h2>
<h2 id="access-rights">Access rights</h2>
<p>Users and access rights are set up in the user config. This is usually <code>users.xml</code>.</p>
<p>Users are recorded in the <code>users</code> section. Here is a fragment of the <code>users.xml</code> file:</p>
<div class="codehilite"><pre><span></span><span class="c">&lt;!-- Users and ACL. --&gt;</span>
<span class="nt">&lt;users&gt;</span>
    <span class="c">&lt;!-- If the user name is not specified, the &#39;default&#39; user is used. --&gt;</span>
    <span class="nt">&lt;default&gt;</span>
        <span class="c">&lt;!-- Password could be specified in plaintext or in SHA256 (in hex format).</span>

<span class="c">             If you want to specify the password in plain text (not recommended), place it in the &#39;password&#39; element.</span>
<span class="c">             Example: &lt;password&gt;qwerty&lt;/password&gt;.</span>
<span class="c">             Password can be empty.</span>

<span class="c">             If you want to specify SHA256, place it in the &#39;password_sha256_hex&#39; element.</span>
<span class="c">                          Example: &lt;password_sha256_hex&gt;65e84be33532fb784c48129675f9eff3a682b27168c0ea744b2cf58ee02337c5&lt;/password_sha256_hex&gt;</span>

<span class="c">             How to generate decent password:</span>
<span class="c">             Execute: PASSWORD=$(base64 &lt; /dev/urandom | head -c8); echo &quot;$PASSWORD&quot;; echo -n &quot;$PASSWORD&quot; | sha256sum | tr -d &#39;-&#39;</span>
<span class="c">             In first line will be password and in second - corresponding SHA256.</span>
<span class="c">        --&gt;</span>
        <span class="nt">&lt;password&gt;&lt;/password&gt;</span>
        <span class="c">&lt;!-- A list of networks that access is allowed from.</span>
<span class="c">            Each list item has one of the following forms:</span>
<span class="c">            &lt;ip&gt;IP address or subnet mask. For example: 198.51.100.0/24 or 2001:DB8::/32.</span>
<span class="c">            &lt;host&gt; Host name. For example: example01. A DNS query is made for verification, and all addresses obtained are compared with the address of the customer.</span>
<span class="c">            &lt;host_regexp&gt; Regular expression for host names. For example: ^example\d\d-\d\d-\d\.yandex\.ru$</span>
<span class="c">                For verification, a DNS PTR query is made for the customer&#39;s address and a regular expression is applied to the result.</span>
<span class="c">                Then another DNS query is made for the result of the PTR query, and all received address are compared to the client address.</span>
<span class="c">                We strongly recommend that the regex ends with \.yandex\.ru$.</span>

<span class="c">            If you are installing ClickHouse yourself, enter:</span>
<span class="c">                &lt;networks&gt;</span>
<span class="c">                        &lt;ip&gt;::/0&lt;/ip&gt;</span>
<span class="c">                &lt;/networks&gt;</span>
<span class="c">        --&gt;</span>
        <span class="nt">&lt;networks</span> <span class="na">incl=</span><span class="s">&quot;networks&quot;</span> <span class="nt">/&gt;</span>

        <span class="c">&lt;!-- Settings profile for the user. --&gt;</span>
        <span class="nt">&lt;profile&gt;</span>default<span class="nt">&lt;/profile&gt;</span>

        <span class="c">&lt;!-- Quota for the user. --&gt;</span>
        <span class="nt">&lt;quota&gt;</span>default<span class="nt">&lt;/quota&gt;</span>
    <span class="nt">&lt;/default&gt;</span>

    <span class="c">&lt;!-- For requests from the Yandex.Metrica user interface via the API for data on specific counters. --&gt;</span>
    <span class="nt">&lt;web&gt;</span>
        <span class="nt">&lt;password&gt;&lt;/password&gt;</span>
        <span class="nt">&lt;networks</span> <span class="na">incl=</span><span class="s">&quot;networks&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;profile&gt;</span>web<span class="nt">&lt;/profile&gt;</span>
        <span class="nt">&lt;quota&gt;</span>default<span class="nt">&lt;/quota&gt;</span>
        <span class="nt">&lt;allow_databases&gt;</span>
        <span class="nt">&lt;database&gt;</span>test<span class="nt">&lt;/database&gt;</span>
        <span class="nt">&lt;/allow_databases&gt;</span>
    <span class="nt">&lt;/web&gt;</span>
<span class="nt">&lt;/users&gt;</span>
</pre></div>


<p>You can see a declaration from two users: <code>default</code> and <code>web</code>. We added the <code>web</code> user separately.</p>
<p>The <code>default</code> user is chosen in cases when the username is not passed. The <code>default</code> user is also used for distributed query processing, if the configuration of the server or cluster doesn't specify the <code>user</code> and <code>password</code> (see the section on the <a href="#table_engines-distributed">Distributed</a> engine).</p>
<p>The user that is used for exchanging information between servers combined in a cluster must not have substantial restrictions or quotas – otherwise, distributed queries will fail.</p>
<p>The password is specified in open format (not recommended) or in SHA-256. The hash isn't salted. In this regard, you should not consider these passwords as providing security against potential malicious attacks. Rather, they are necessary for protection from employees.</p>
<p>A list of networks is specified that access is allowed from. In this example, the list of networks for both users is loaded from a separate file (/etc/metrika.xml) containing the 'networks' substitution. Here is a fragment of it:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;yandex&gt;</span>
    ...
    <span class="nt">&lt;networks&gt;</span>
        <span class="nt">&lt;ip&gt;</span>::/64<span class="nt">&lt;/ip&gt;</span>
        <span class="nt">&lt;ip&gt;</span>203.0.113.0/24<span class="nt">&lt;/ip&gt;</span>
        <span class="nt">&lt;ip&gt;</span>2001:DB8::/32<span class="nt">&lt;/ip&gt;</span>
        ...
    <span class="nt">&lt;/networks&gt;</span>
<span class="nt">&lt;/yandex&gt;</span>
</pre></div>


<p>We could have defined this list of networks directly in 'users.xml', or in a file in the 'users.d' directory (for more information, see the section "Configuration files").</p>
<p>The config includes comments explaining how to open access from everywhere.</p>
<p>For use in production, only specify IP elements (IP addresses and their masks), since using 'host' and 'hoost_regexp' might cause extra latency.</p>
<p>Next the user settings profile is specified (see the section "Settings profiles"). You can specify the default profile, <code>default</code>. The profile can have any name. You can specify the same profile for different users. The most important thing you can write in the settings profile is 'readonly' set to 1, which provides read-only access.</p>
<p>After this, the quota is defined (see the section "Quotas"). You can specify the default quota, <code>default</code>. It is set in the config by default so that it only counts resource usage, but does not restrict it. The quota can have any name. You can specify the same quota for different users – in this case, resource usage is calculated for each user individually.</p>
<p>In the optional <code>&lt;allow_databases&gt;</code> section, you can also specify a list of databases that the user can access. By default, all databases are available to the user. You can specify the <code>default</code> database. In this case, the user will receive access to the database by default.</p>
<p>Access to the <code>system</code> database is always allowed (since this database is used for processing queries).</p>
<p>The user can get a list of all databases and tables in them by using <code>SHOW</code> queries or system tables, even if access to individual databases isn't allowed.</p>
<p>Database access is not related to the <a href="#query_complexity_readonly">readonly</a> setting. You can't grant full access to one database and <code>readonly</code> access to another one.</p>
<p><a name="configuration_files"></a></p>
<h2 id="configuration-files_1">Configuration files</h2>
<p>The main server config file is <code>config.xml</code>. It resides in the <code>/etc/clickhouse-server/</code> directory.</p>
<p>Individual settings can be overridden in the <code>*.xml</code>and<code>*.conf</code> files in the <code>conf.d</code> and <code>config.d</code> directories next to the config file.</p>
<p>The <code>replace</code> or <code>remove</code> attributes can be specified for the elements of these config files.</p>
<p>If neither is specified, it combines the contents of elements recursively, replacing values of duplicate children.</p>
<p>If <code>replace</code> is specified, it replaces the entire element with the specified one.</p>
<p>If <code>remove</code> is specified, it deletes the element.</p>
<p>The config can also define "substitutions". If an element has the <code>incl</code> attribute, the corresponding substitution from the file will be used as the value. By default, the path to the file with substitutions is <code>/etc/metrika.xml</code>. This can be changed in the <a href="#server_settings-include_from">include_from</a> element in the server config. The substitution values are specified in  <code>/yandex/substitution_name</code> elements in this file. If a substitution specified in <code>incl</code>  does not exist, it is recorded in the log. To prevent ClickHouse from logging missing substitutions, specify the  <code>optional="true"</code> attribute (for example, settings for <a href="#server_settings-macros">macros</a>).</p>
<p>Substitutions can also be performed from ZooKeeper. To do this, specify the attribute <code>from_zk = "/path/to/node"</code>. The element value is replaced with the contents of the node at <code>/path/to/node</code> in ZooKeeper. You can also put an entire XML subtree on the ZooKeeper node and it will be fully inserted into the source element.</p>
<p>The <code>config.xml</code> file can specify a separate config with user settings, profiles, and quotas. The relative path to this config is set in the 'users_config' element. By default, it is <code>users.xml</code>. If <code>users_config</code> is omitted, the user settings, profiles, and quotas are specified directly in <code>config.xml</code>.</p>
<p>In addition, <code>users_config</code> may have overrides in files from the <code>users_config.d</code> directory (for example, <code>users.d</code>) and substitutions.</p>
<p>For each config file, the server also generates <code>file-preprocessed.xml</code> files when starting. These files contain all the completed substitutions and overrides, and they are intended for informational use. If ZooKeeper substitutions were used in the config files but ZooKeeper is not available on the server start, the server loads the configuration from the preprocessed file.</p>
<p>The server tracks changes in config files, as well as files and ZooKeeper nodes that were used when performing substitutions and overrides, and reloads the settings for users and clusters on the fly. This means that you can modify the cluster, users, and their settings without restarting the server.</p>
<h2 id="quotas">Quotas</h2>
<p>Quotas allow you to limit resource usage over a period of time, or simply track the use of resources.
Quotas are set up in the user config. This is usually 'users.xml'.</p>
<p>The system also has a feature for limiting the complexity of a single query. See the section "Restrictions on query complexity").</p>
<p>In contrast to query complexity restrictions, quotas:</p>
<ul>
<li>Place restrictions on a set of queries that can be run over a period of time, instead of limiting a single query.</li>
<li>Account for resources spent on all remote servers for distributed query processing.</li>
</ul>
<p>Let's look at the section of the 'users.xml' file that defines quotas.</p>
<div class="codehilite"><pre><span></span><span class="c">&lt;!-- Quotas. --&gt;</span>
<span class="nt">&lt;quotas&gt;</span>
    <span class="c">&lt;!-- Quota name. --&gt;</span>
    <span class="nt">&lt;default&gt;</span>
        <span class="c">&lt;!-- Restrictions for a time period. You can set many intervals with different restrictions. --&gt;</span>
        <span class="nt">&lt;interval&gt;</span>
            <span class="c">&lt;!-- Length of the interval. --&gt;</span>
            <span class="nt">&lt;duration&gt;</span>3600<span class="nt">&lt;/duration&gt;</span>

            <span class="c">&lt;!-- Unlimited. Just collect data for the specified time interval. --&gt;</span>
            <span class="nt">&lt;queries&gt;</span>0<span class="nt">&lt;/queries&gt;</span>
            <span class="nt">&lt;errors&gt;</span>0<span class="nt">&lt;/errors&gt;</span>
            <span class="nt">&lt;result_rows&gt;</span>0<span class="nt">&lt;/result_rows&gt;</span>
            <span class="nt">&lt;read_rows&gt;</span>0<span class="nt">&lt;/read_rows&gt;</span>
            <span class="nt">&lt;execution_time&gt;</span>0<span class="nt">&lt;/execution_time&gt;</span>
        <span class="nt">&lt;/interval&gt;</span>
    <span class="nt">&lt;/default&gt;</span>
</pre></div>


<p>By default, the quota just tracks resource consumption for each hour, without limiting usage.
The resource consumption calculated for each interval is output to the server log after each request.</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;statbox&gt;</span>
    <span class="c">&lt;!-- Restrictions for a time period. You can set many intervals with different restrictions. --&gt;</span>
    <span class="nt">&lt;interval&gt;</span>
        <span class="c">&lt;!-- Length of the interval. --&gt;</span>
        <span class="nt">&lt;duration&gt;</span>3600<span class="nt">&lt;/duration&gt;</span>

        <span class="nt">&lt;queries&gt;</span>1000<span class="nt">&lt;/queries&gt;</span>
        <span class="nt">&lt;errors&gt;</span>100<span class="nt">&lt;/errors&gt;</span>
        <span class="nt">&lt;result_rows&gt;</span>1000000000<span class="nt">&lt;/result_rows&gt;</span>
        <span class="nt">&lt;read_rows&gt;</span>100000000000<span class="nt">&lt;/read_rows&gt;</span>
        <span class="nt">&lt;execution_time&gt;</span>900<span class="nt">&lt;/execution_time&gt;</span>
    <span class="nt">&lt;/interval&gt;</span>

    <span class="nt">&lt;interval&gt;</span>
        <span class="nt">&lt;duration&gt;</span>86400<span class="nt">&lt;/duration&gt;</span>

        <span class="nt">&lt;queries&gt;</span>10000<span class="nt">&lt;/queries&gt;</span>
        <span class="nt">&lt;errors&gt;</span>1000<span class="nt">&lt;/errors&gt;</span>
        <span class="nt">&lt;result_rows&gt;</span>5000000000<span class="nt">&lt;/result_rows&gt;</span>
        <span class="nt">&lt;read_rows&gt;</span>500000000000<span class="nt">&lt;/read_rows&gt;</span>
        <span class="nt">&lt;execution_time&gt;</span>7200<span class="nt">&lt;/execution_time&gt;</span>
    <span class="nt">&lt;/interval&gt;</span>
<span class="nt">&lt;/statbox&gt;</span>
</pre></div>


<p>For the 'statbox' quota, restrictions are set for every hour and for every 24 hours (86,400 seconds). The time interval is counted starting from an implementation-defined fixed moment in time. In other words, the 24-hour interval doesn't necessarily begin at midnight.</p>
<p>When the interval ends, all collected values are cleared. For the next hour, the quota calculation starts over.</p>
<p>Here are the amounts that can be restricted:</p>
<p><code>queries</code> – The total number of requests.</p>
<p><code>errors</code> – The number of queries that threw an exception.</p>
<p><code>result_rows</code> – The total number of rows given as the result.</p>
<p><code>read_rows</code> – The total number of source rows read from tables for running the query, on all remote servers.</p>
<p><code>execution_time</code> – The total query execution time, in seconds (wall time).</p>
<p>If the limit is exceeded for at least one time interval, an exception is thrown with a text about which restriction was exceeded, for which interval, and when the new interval begins (when queries can be sent again).</p>
<p>Quotas can use the "quota key" feature in order to report on resources for multiple keys independently. Here is an example of this:</p>
<div class="codehilite"><pre><span></span><span class="c">&lt;!-- For the global reports designer. --&gt;</span>
<span class="nt">&lt;web_global&gt;</span>
    <span class="c">&lt;!-- keyed - The quota_key &quot;key&quot; is passed in the query parameter,</span>
<span class="c">            and the quota is tracked separately for each key value.</span>
<span class="c">        For example, you can pass a Yandex.Metrica username as the key,</span>
<span class="c">            so the quota will be counted separately for each username.</span>
<span class="c">        Using keys makes sense only if quota_key is transmitted by the program, not by a user.</span>

<span class="c">        You can also write &lt;keyed_by_ip /&gt; so the IP address is used as the quota key.</span>
<span class="c">        (But keep in mind that users can change the IPv6 address fairly easily.)</span>
<span class="c">    --&gt;</span>
    <span class="nt">&lt;keyed</span> <span class="nt">/&gt;</span>
</pre></div>


<p>The quota is assigned to users in the 'users' section of the config. See the section "Access rights".</p>
<p>For distributed query processing, the accumulated amounts are stored on the requestor server. So if the user goes to another server, the quota there will "start over".</p>
<p>When the server is restarted, quotas are reset.</p>
<h2 id="usage-recommendations">Usage recommendations</h2>
<h3 id="cpu">CPU</h3>
<p>The SSE 4.2 instruction set must be supported. Modern processors (since 2008) support it.</p>
<p>When choosing a processor, prefer a large number of cores and slightly slower clock rate over fewer cores and a higher clock rate.
For example, 16 cores with 2600 MHz is better than 8 cores with 3600 MHz.</p>
<h3 id="hyper-threading">Hyper-threading</h3>
<p>Don't disable hyper-threading. It helps for some queries, but not for others.</p>
<h3 id="turbo-boost">Turbo Boost</h3>
<p>Turbo Boost is highly recommended. It significantly improves performance with a typical load.
You can use <code>turbostat</code> to view the CPU's actual clock rate under a load.</p>
<h3 id="cpu-scaling-governor">CPU scaling governor</h3>
<p>Always use the <code>performance</code> scaling governor.  The <code>on-demand</code> scaling governor works much worse with constantly high demand.</p>
<div class="codehilite"><pre><span></span>sudo <span class="nb">echo</span> <span class="s1">&#39;performance&#39;</span> <span class="p">|</span> tee /sys/devices/system/cpu/cpu<span class="se">\*</span>/cpufreq/scaling_governor
</pre></div>


<h3 id="cpu-limitations">CPU limitations</h3>
<p>Processors can overheat. Use <code>dmesg</code> to see if the CPU's clock rate was limited due to overheating.
The restriction can also be set externally at the datacenter level. You can use <code>turbostat</code> to monitor it under a load.</p>
<h3 id="ram">RAM</h3>
<p>For small amounts of data (up to \~200 GB compressed), it is best to use as much memory as the volume of data.
For large amounts of data and when processing interactive (online) queries, you should use a reasonable amount of RAM (128 GB or more) so the hot data subset will fit in the cache of pages.
Even for data volumes of \~50 TB per server, using 128 GB of RAM significantly improves query performance compared to 64 GB.</p>
<h3 id="swap-file">Swap file</h3>
<p>Always disable the swap file. The only reason for not doing this is if you are using ClickHouse on your personal laptop.</p>
<h3 id="huge-pages">Huge pages</h3>
<p>Always disable transparent huge pages. It interferes with memory allocators, which leads to significant performance degradation.</p>
<div class="codehilite"><pre><span></span><span class="nb">echo</span> <span class="s1">&#39;never&#39;</span> <span class="p">|</span> sudo tee /sys/kernel/mm/transparent_hugepage/enabled
</pre></div>


<p>Use <code>perf top</code> to watch the time spent in the kernel for memory management.
Permanent huge pages also do not need to be allocated.</p>
<h3 id="storage-subsystem">Storage subsystem</h3>
<p>If your budget allows you to use SSD, use SSD.
If not, use HDD. SATA HDDs 7200 RPM will do.</p>
<p>Give preference to a lot of servers with local hard drives over a smaller number of servers with attached disk shelves.
But for storing archives with rare queries, shelves will work.</p>
<h3 id="raid">RAID</h3>
<p>When using HDD, you can combine their RAID-10, RAID-5, RAID-6 or RAID-50.
For Linux, software RAID is better (with <code>mdadm</code>). We don't recommend using LVM.
When creating RAID-10, select the <code>far</code> layout.
If your budget allows, choose RAID-10.</p>
<p>If you have more than 4 disks, use RAID-6 (preferred) or RAID-50, instead of RAID-5.
When using RAID-5, RAID-6 or RAID-50, always increase stripe_cache_size, since the default value is usually not the best choice.</p>
<div class="codehilite"><pre><span></span><span class="nb">echo</span> <span class="m">4096</span> <span class="p">|</span> sudo tee /sys/block/md2/md/stripe_cache_size
</pre></div>


<p>Calculate the exact number from the number of devices and the block size, using the formula: <code>2 * num_devices * chunk_size_in_bytes / 4096</code>.</p>
<p>A block size of 1025 KB is sufficient for all RAID configurations.
Never set the block size too small or too large.</p>
<p>You can use RAID-0 on SSD.
Regardless of RAID use, always use replication for data security.</p>
<p>Enable NCQ with a long queue. For HDD, choose the CFQ scheduler, and for SSD, choose noop. Don't reduce the 'readahead' setting.
For HDD, enable the write cache.</p>
<h3 id="file-system">File system</h3>
<p>Ext4 is the most reliable option. Set the mount options <code>noatime, nobarrier</code>.
XFS is also suitable, but it hasn't been as thoroughly tested with ClickHouse.
Most other file systems should also work fine. File systems with delayed allocation work better.</p>
<h3 id="linux-kernel">Linux kernel</h3>
<p>Don't use an outdated Linux kernel. In 2015, 3.18.19 was new enough.
Consider using the kernel build from Yandex:<a href="https://github.com/yandex/smart">https://github.com/yandex/smart</a> – it provides at least a 5% performance increase.</p>
<h3 id="network">Network</h3>
<p>If you are using IPv6, increase the size of the route cache.
The Linux kernel prior to 3.2 had a multitude of problems with IPv6 implementation.</p>
<p>Use at least a 10 GB network, if possible. 1 Gb will also work, but it will be much worse for patching replicas with tens of terabytes of data, or for processing distributed queries with a large amount of intermediate data.</p>
<h3 id="zookeeper">ZooKeeper</h3>
<p>You are probably already using ZooKeeper for other purposes. You can use the same installation of ZooKeeper, if it isn't already overloaded.</p>
<p>It's best to use a fresh version of ZooKeeper – 3.4.9 or later. The version in stable Linux distributions may be outdated.</p>
<p>With the default settings, ZooKeeper is a time bomb:</p>
<blockquote>
<p>The ZooKeeper server won't delete files from old snapshots and logs when using the default configuration (see autopurge), and this is the responsibility of the operator.</p>
</blockquote>
<p>This bomb must be defused.</p>
<p>The ZooKeeper (3.5.1) configuration below is used in the Yandex.Metrica production environment as of May 20, 2017:</p>
<p>zoo.cfg:</p>
<div class="codehilite"><pre><span></span><span class="c1">## http://hadoop.apache.org/zookeeper/docs/current/zookeeperAdmin.html</span>

<span class="c1">## The number of milliseconds of each tick</span>
<span class="nv">tickTime</span><span class="o">=</span><span class="m">2000</span>
<span class="c1">## The number of ticks that the initial</span>
<span class="c1">## synchronization phase can take</span>
<span class="nv">initLimit</span><span class="o">=</span><span class="m">30000</span>
<span class="c1">## The number of ticks that can pass between</span>
<span class="c1">## sending a request and getting an acknowledgement</span>
<span class="nv">syncLimit</span><span class="o">=</span><span class="m">10</span>

<span class="nv">maxClientCnxns</span><span class="o">=</span><span class="m">2000</span>

<span class="nv">maxSessionTimeout</span><span class="o">=</span><span class="m">60000000</span>
<span class="c1">## the directory where the snapshot is stored.</span>
<span class="nv">dataDir</span><span class="o">=</span>/opt/zookeeper/<span class="o">{{</span> cluster<span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="o">]</span> <span class="o">}}</span>/data
<span class="c1">## Place the dataLogDir to a separate physical disc for better performance</span>
<span class="nv">dataLogDir</span><span class="o">=</span>/opt/zookeeper/<span class="o">{{</span> cluster<span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="o">]</span> <span class="o">}}</span>/logs

autopurge.snapRetainCount<span class="o">=</span><span class="m">10</span>
autopurge.purgeInterval<span class="o">=</span><span class="m">1</span>


<span class="c1">## To avoid seeks ZooKeeper allocates space in the transaction log file in</span>
<span class="c1">## blocks of preAllocSize kilobytes. The default block size is 64M. One reason</span>
<span class="c1">## for changing the size of the blocks is to reduce the block size if snapshots</span>
<span class="c1">## are taken more often. (Also, see snapCount).</span>
<span class="nv">preAllocSize</span><span class="o">=</span><span class="m">131072</span>

<span class="c1">## Clients can submit requests faster than ZooKeeper can process them,</span>
<span class="c1">## especially if there are a lot of clients. To prevent ZooKeeper from running</span>
<span class="c1">## out of memory due to queued requests, ZooKeeper will throttle clients so that</span>
<span class="c1">## there is no more than globalOutstandingLimit outstanding requests in the</span>
<span class="c1">## system. The default limit is 1,000.ZooKeeper logs transactions to a</span>
<span class="c1">## transaction log. After snapCount transactions are written to a log file a</span>
<span class="c1">## snapshot is started and a new transaction log file is started. The default</span>
<span class="c1">## snapCount is 10,000.</span>
<span class="nv">snapCount</span><span class="o">=</span><span class="m">3000000</span>

<span class="c1">## If this option is defined, requests will be will logged to a trace file named</span>
<span class="c1">## traceFile.year.month.day.</span>
<span class="c1">##traceFile=</span>

<span class="c1">## Leader accepts client connections. Default value is &quot;yes&quot;. The leader machine</span>
<span class="c1">## coordinates updates. For higher update throughput at thes slight expense of</span>
<span class="c1">## read throughput the leader can be configured to not accept clients and focus</span>
<span class="c1">## on coordination.</span>
<span class="nv">leaderServes</span><span class="o">=</span>yes

<span class="nv">standaloneEnabled</span><span class="o">=</span><span class="nb">false</span>
<span class="nv">dynamicConfigFile</span><span class="o">=</span>/etc/zookeeper-<span class="o">{{</span> cluster<span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="o">]</span> <span class="o">}}</span>/conf/zoo.cfg.dynamic
</pre></div>


<p>Java version:</p>
<div class="codehilite"><pre><span></span>Java(TM) SE Runtime Environment (build 1.8.0_25-b17)
Java HotSpot(TM) 64-Bit Server VM (build 25.25-b02, mixed mode)
</pre></div>


<p>JVM parameters:</p>
<div class="codehilite"><pre><span></span><span class="nv">NAME</span><span class="o">=</span>zookeeper-<span class="o">{{</span> cluster<span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="o">]</span> <span class="o">}}</span>
<span class="nv">ZOOCFGDIR</span><span class="o">=</span>/etc/<span class="nv">$NAME</span>/conf

<span class="c1">## TODO this is really ugly</span>
<span class="c1">## How to find out, which jars are needed?</span>
<span class="c1">## seems, that log4j requires the log4j.properties file to be in the classpath</span>
<span class="nv">CLASSPATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ZOOCFGDIR</span><span class="s2">:/usr/build/classes:/usr/build/lib/*.jar:/usr/share/zookeeper/zookeeper-3.5.1-metrika.jar:/usr/share/zookeeper/slf4j-log4j12-1.7.5.jar:/usr/share/zookeeper/slf4j-api-1.7.5.jar:/usr/share/zookeeper/servlet-api-2.5-20081211.jar:/usr/share/zookeeper/netty-3.7.0.Final.jar:/usr/share/zookeeper/log4j-1.2.16.jar:/usr/share/zookeeper/jline-2.11.jar:/usr/share/zookeeper/jetty-util-6.1.26.jar:/usr/share/zookeeper/jetty-6.1.26.jar:/usr/share/zookeeper/javacc.jar:/usr/share/zookeeper/jackson-mapper-asl-1.9.11.jar:/usr/share/zookeeper/jackson-core-asl-1.9.11.jar:/usr/share/zookeeper/commons-cli-1.2.jar:/usr/src/java/lib/*.jar:/usr/etc/zookeeper&quot;</span>

<span class="nv">ZOOCFG</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ZOOCFGDIR</span><span class="s2">/zoo.cfg&quot;</span>
<span class="nv">ZOO_LOG_DIR</span><span class="o">=</span>/var/log/<span class="nv">$NAME</span>
<span class="nv">USER</span><span class="o">=</span>zookeeper
<span class="nv">GROUP</span><span class="o">=</span>zookeeper
<span class="nv">PIDDIR</span><span class="o">=</span>/var/run/<span class="nv">$NAME</span>
<span class="nv">PIDFILE</span><span class="o">=</span><span class="nv">$PIDDIR</span>/<span class="nv">$NAME</span>.pid
<span class="nv">SCRIPTNAME</span><span class="o">=</span>/etc/init.d/<span class="nv">$NAME</span>
<span class="nv">JAVA</span><span class="o">=</span>/usr/bin/java
<span class="nv">ZOOMAIN</span><span class="o">=</span><span class="s2">&quot;org.apache.zookeeper.server.quorum.QuorumPeerMain&quot;</span>
<span class="nv">ZOO_LOG4J_PROP</span><span class="o">=</span><span class="s2">&quot;INFO,ROLLINGFILE&quot;</span>
<span class="nv">JMXLOCALONLY</span><span class="o">=</span><span class="nb">false</span>
<span class="nv">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;-Xms{{ cluster.get(&#39;xms&#39;,&#39;128M&#39;) }} \</span>
<span class="s2">    -Xmx{{ cluster.get(&#39;xmx&#39;,&#39;1G&#39;) }} \</span>
<span class="s2">    -Xloggc:/var/log/</span><span class="nv">$NAME</span><span class="s2">/zookeeper-gc.log \</span>
<span class="s2">    -XX:+UseGCLogFileRotation \</span>
<span class="s2">    -XX:NumberOfGCLogFiles=16 \</span>
<span class="s2">    -XX:GCLogFileSize=16M \</span>
<span class="s2">    -verbose:gc \</span>
<span class="s2">    -XX:+PrintGCTimeStamps \</span>
<span class="s2">    -XX:+PrintGCDateStamps \</span>
<span class="s2">    -XX:+PrintGCDetails</span>
<span class="s2">    -XX:+PrintTenuringDistribution \</span>
<span class="s2">    -XX:+PrintGCApplicationStoppedTime \</span>
<span class="s2">    -XX:+PrintGCApplicationConcurrentTime \</span>
<span class="s2">    -XX:+PrintSafepointStatistics \</span>
<span class="s2">    -XX:+UseParNewGC \</span>
<span class="s2">    -XX:+UseConcMarkSweepGC \</span>
<span class="s2">-XX:+CMSParallelRemarkEnabled&quot;</span>
</pre></div>


<p>Salt init:</p>
<div class="codehilite"><pre><span></span>description &quot;zookeeper-{{ cluster[&#39;name&#39;] }} centralized coordination service&quot;

start on runlevel [2345]
stop on runlevel [!2345]

respawn

limit nofile 8192 8192

pre-start script
    [ -r &quot;/etc/zookeeper-{{ cluster[&#39;name&#39;] }}/conf/environment&quot; ] || exit 0
    . /etc/zookeeper-{{ cluster[&#39;name&#39;] }}/conf/environment
    [ -d $ZOO_LOG_DIR ] || mkdir -p $ZOO_LOG_DIR
    chown $USER:$GROUP $ZOO_LOG_DIR
end script

script
    . /etc/zookeeper-{{ cluster[&#39;name&#39;] }}/conf/environment
    [ -r /etc/default/zookeeper ] &amp;&amp; . /etc/default/zookeeper
    if [ -z &quot;$JMXDISABLE&quot; ]; then
        JAVA_OPTS=&quot;$JAVA_OPTS -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only=$JMXLOCALONLY&quot;
    fi
    exec start-stop-daemon --start -c $USER --exec $JAVA --name zookeeper-{{ cluster[&#39;name&#39;] }} \
        -- -cp $CLASSPATH $JAVA_OPTS -Dzookeeper.log.dir=${ZOO_LOG_DIR} \
        -Dzookeeper.root.logger=${ZOO_LOG4J_PROP} $ZOOMAIN $ZOOCFG
end script
</pre></div>


<p><a name="server_settings"></a></p>
<h2 id="server-configuration-parameters">Server configuration parameters</h2>
<p>This section contains descriptions of server settings that cannot be changed at the session or query level.</p>
<p>These settings are stored in the <code>config.xml</code> file on the ClickHouse server.</p>
<p>Other settings are described in the "<a href="#settings">Settings</a>" section.</p>
<p>Before studying the settings, read the <a href="#configuration_files">Configuration files</a> section and note the use of substitutions (the <code>incl</code> and <code>optional</code> attributes).</p>
<h2 id="server-settings">Server settings</h2>
<p><a name="server_settings-builtin_dictionaries_reload_interval"></a></p>
<h3 id="builtin_dictionaries_reload_interval">builtin_dictionaries_reload_interval</h3>
<p>The interval in seconds before reloading built-in dictionaries.</p>
<p>ClickHouse reloads built-in dictionaries every x seconds. This makes it possible to edit dictionaries "on the fly" without restarting the server.</p>
<p>Default value: 3600.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;builtin_dictionaries_reload_interval&gt;</span>3600<span class="nt">&lt;/builtin_dictionaries_reload_interval&gt;</span>
</pre></div>


<p><a name="server_settings-compression"></a></p>
<h3 id="compression">compression</h3>
<p>Data compression settings.</p>
<div class="admonition warning">

Don't use it if you have just started using ClickHouse.

</div>

<p>The configuration looks like this:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;compression&gt;</span>
    <span class="nt">&lt;case&gt;</span>
      <span class="nt">&lt;parameters/&gt;</span>
    <span class="nt">&lt;/case&gt;</span>
    ...
<span class="nt">&lt;/compression&gt;</span>
</pre></div>


<p>You can configure multiple sections <code>&lt;case&gt;</code>.</p>
<p>Block field <code>&lt;case&gt;</code>:</p>
<ul>
<li><code>min_part_size</code> – The minimum size of a table part.</li>
<li><code>min_part_size_ratio</code> – The ratio of the minimum size of a table part to the full size of the table.</li>
<li><code>method</code> – Compression method. Acceptable values ​: <code>lz4</code> or <code>zstd</code>(experimental).</li>
</ul>
<p>ClickHouse checks <code>min_part_size</code>  and <code>min_part_size_ratio</code>  and processes the <code>case</code> blocks that match these conditions. If none of the <code>&lt;case&gt;</code> matches, ClickHouse applies the <code>lz4</code> compression algorithm.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;compression</span> <span class="na">incl=</span><span class="s">&quot;clickhouse_compression&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;case&gt;</span>
        <span class="nt">&lt;min_part_size&gt;</span>10000000000<span class="nt">&lt;/min_part_size&gt;</span>
        <span class="nt">&lt;min_part_size_ratio&gt;</span>0.01<span class="nt">&lt;/min_part_size_ratio&gt;</span>
        <span class="nt">&lt;method&gt;</span>zstd<span class="nt">&lt;/method&gt;</span>
    <span class="nt">&lt;/case&gt;</span>
<span class="nt">&lt;/compression&gt;</span>
</pre></div>


<p><a name="server_settings-default_database"></a></p>
<h3 id="default_database">default_database</h3>
<p>The default database.</p>
<p>To get a list of databases, use the <a href="#query_language_queries_show_databases">SHOW DATABASES</a>.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;default_database&gt;</span>default<span class="nt">&lt;/default_database&gt;</span>
</pre></div>


<p><a name="server_settings-default_profile"></a></p>
<h3 id="default_profile">default_profile</h3>
<p>Default settings profile.</p>
<p>Settings profiles are located in the file specified in the parameter <a href="#server_settings-users_config">user_config</a>.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;default_profile&gt;</span>default<span class="nt">&lt;/default_profile&gt;</span>
</pre></div>


<p><a name="server_settings-dictionaries_config"></a></p>
<h3 id="dictionaries_config">dictionaries_config</h3>
<p>The path to the config file for external dictionaries.</p>
<p>Path:</p>
<ul>
<li>Specify the absolute path or the path relative to the server config file.</li>
<li>The path can contain wildcards * and ?.</li>
</ul>
<p>See also "<a href="#dicts-external_dicts">External dictionaries</a>".</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;dictionaries_config&gt;</span>*_dictionary.xml<span class="nt">&lt;/dictionaries_config&gt;</span>
</pre></div>


<p><a name="server_settings-dictionaries_lazy_load"></a></p>
<h3 id="dictionaries_lazy_load">dictionaries_lazy_load</h3>
<p>Lazy loading of dictionaries.</p>
<p>If <code>true</code>, then each dictionary is created on first use. If dictionary creation failed, the function that was using the dictionary throws an exception.</p>
<p>If <code>false</code>, all dictionaries are created when the server starts, and if there is an error, the server shuts down.</p>
<p>The default is <code>true</code>.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;dictionaries_lazy_load&gt;</span>true<span class="nt">&lt;/dictionaries_lazy_load&gt;</span>
</pre></div>


<p><a name="server_settings-format_schema_path"></a></p>
<h3 id="format_schema_path">format_schema_path</h3>
<p>The path to the directory with the schemes for the input data, such as schemas for the <a href="#format_capnproto">CapnProto</a> format.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span>  <span class="c">&lt;!-- Directory containing schema files for various input formats. --&gt;</span>
  <span class="nt">&lt;format_schema_path&gt;</span>format_schemas/<span class="nt">&lt;/format_schema_path&gt;</span>
</pre></div>


<p><a name="server_settings-graphite"></a></p>
<h3 id="graphite">graphite</h3>
<p>Sending data to <a href="https://github.com/graphite-project">Graphite</a>.</p>
<p>Settings:</p>
<ul>
<li>host – The Graphite server.</li>
<li>port – The port on the Graphite server.</li>
<li>interval – The interval for sending, in seconds.</li>
<li>timeout – The timeout for sending data, in seconds.</li>
<li>root_path – Prefix for keys.</li>
<li>metrics – Sending data from a :ref:<code>system_tables-system.metrics</code> table.</li>
<li>events – Sending data from a :ref:<code>system_tables-system.events</code> table.</li>
<li>asynchronous_metrics – Sending data from a :ref:<code>system_tables-system.asynchronous_metrics</code> table.</li>
</ul>
<p>You can configure multiple <code>&lt;graphite&gt;</code> clauses. For instance, you can use this for sending different data at different intervals.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;graphite&gt;</span>
    <span class="nt">&lt;host&gt;</span>localhost<span class="nt">&lt;/host&gt;</span>
    <span class="nt">&lt;port&gt;</span>42000<span class="nt">&lt;/port&gt;</span>
    <span class="nt">&lt;timeout&gt;</span>0.1<span class="nt">&lt;/timeout&gt;</span>
    <span class="nt">&lt;interval&gt;</span>60<span class="nt">&lt;/interval&gt;</span>
    <span class="nt">&lt;root_path&gt;</span>one_min<span class="nt">&lt;/root_path&gt;</span>
    <span class="nt">&lt;metrics&gt;</span>true<span class="nt">&lt;/metrics&gt;</span>
    <span class="nt">&lt;events&gt;</span>true<span class="nt">&lt;/events&gt;</span>
    <span class="nt">&lt;asynchronous_metrics&gt;</span>true<span class="nt">&lt;/asynchronous_metrics&gt;</span>
<span class="nt">&lt;/graphite&gt;</span>
</pre></div>


<p><a name="server_settings-graphite_rollup"></a></p>
<h3 id="graphite_rollup">graphite_rollup</h3>
<p>Settings for thinning data for Graphite.</p>
<p>For more information, see <a href="#table_engines-graphitemergetree">GraphiteMergeTree</a>.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;graphite_rollup_example&gt;</span>
    <span class="nt">&lt;default&gt;</span>
        <span class="nt">&lt;function&gt;</span>max<span class="nt">&lt;/function&gt;</span>
        <span class="nt">&lt;retention&gt;</span>
            <span class="nt">&lt;age&gt;</span>0<span class="nt">&lt;/age&gt;</span>
            <span class="nt">&lt;precision&gt;</span>60<span class="nt">&lt;/precision&gt;</span>
        <span class="nt">&lt;/retention&gt;</span>
        <span class="nt">&lt;retention&gt;</span>
            <span class="nt">&lt;age&gt;</span>3600<span class="nt">&lt;/age&gt;</span>
            <span class="nt">&lt;precision&gt;</span>300<span class="nt">&lt;/precision&gt;</span>
        <span class="nt">&lt;/retention&gt;</span>
        <span class="nt">&lt;retention&gt;</span>
            <span class="nt">&lt;age&gt;</span>86400<span class="nt">&lt;/age&gt;</span>
            <span class="nt">&lt;precision&gt;</span>3600<span class="nt">&lt;/precision&gt;</span>
        <span class="nt">&lt;/retention&gt;</span>
    <span class="nt">&lt;/default&gt;</span>
<span class="nt">&lt;/graphite_rollup_example&gt;</span>
</pre></div>


<p><a name="server_settings-http_port"></a></p>
<h3 id="http_porthttps_port">http_port/https_port</h3>
<p>The port for connecting to the server over HTTP(s).</p>
<p>If <code>https_port</code> is specified, <a href="#server_settings-openSSL">openSSL</a> must be configured.</p>
<p>If <code>http_port</code> is specified, the openSSL configuration is ignored even if it is set.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;https&gt;</span>0000<span class="nt">&lt;/https&gt;</span>
</pre></div>


<p><a name="server_settings-http_server_default_response"></a></p>
<h3 id="http_server_default_response">http_server_default_response</h3>
<p>The page that is shown by default when you access the ClickHouse HTTP(s) server.</p>
<p><strong>Example</strong></p>
<p>Opens <code>https://tabix.io/</code> when accessing <code>http://localhost: http_port</code>.</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;http_server_default_response&gt;</span>
  <span class="cp">&lt;![CDATA[&lt;html ng-app=&quot;SMI2&quot;&gt;&lt;head&gt;&lt;base href=&quot;http://ui.tabix.io/&quot;&gt;&lt;/head&gt;&lt;body&gt;&lt;div ui-view=&quot;&quot; class=&quot;content-ui&quot;&gt;&lt;/div&gt;&lt;script src=&quot;http://loader.tabix.io/master.js&quot;&gt;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;]]&gt;</span>
<span class="nt">&lt;/http_server_default_response&gt;</span>
</pre></div>


<p><a name="server_settings-include_from"></a></p>
<h3 id="include_from">include_from</h3>
<p>The path to the file with substitutions.</p>
<p>For more information, see the section "<a href="#configuration_files">Configuration files</a>".</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;include_from&gt;</span>/etc/metrica.xml<span class="nt">&lt;/include_from&gt;</span>
</pre></div>


<p><a name="server_settings-interserver_http_port"></a></p>
<h3 id="interserver_http_port">interserver_http_port</h3>
<p>Port for exchanging data between ClickHouse servers.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;interserver_http_port&gt;</span>9009<span class="nt">&lt;/interserver_http_port&gt;</span>
</pre></div>


<p><a name="server_settings-interserver_http_host"></a></p>
<h3 id="interserver_http_host">interserver_http_host</h3>
<p>The host name that can be used by other servers to access this server.</p>
<p>If omitted, it is defined in the same way as the <code>hostname-f</code> command.</p>
<p>Useful for breaking away from a specific network interface.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;interserver_http_host&gt;</span>example.yandex.ru<span class="nt">&lt;/interserver_http_host&gt;</span>
</pre></div>


<p><a name="server_settings-keep_alive_timeout"></a></p>
<h3 id="keep_alive_timeout">keep_alive_timeout</h3>
<p>The number of milliseconds that ClickHouse waits for incoming requests before closing the connection.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;keep_alive_timeout&gt;</span>3<span class="nt">&lt;/keep_alive_timeout&gt;</span>
</pre></div>


<p><a name="server_settings-listen_host"></a></p>
<h3 id="listen_host">listen_host</h3>
<p>Restriction on hosts that requests can come from. If you want the server to answer all of them, specify <code>::</code>.</p>
<p>Examples:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;listen_host&gt;</span>::1<span class="nt">&lt;/listen_host&gt;</span>
<span class="nt">&lt;listen_host&gt;</span>127.0.0.1<span class="nt">&lt;/listen_host&gt;</span>
</pre></div>


<p><a name="server_settings-logger"></a></p>
<h3 id="logger">logger</h3>
<p>Logging settings.</p>
<p>Keys:</p>
<ul>
<li>level – Logging level. Acceptable values: <code>trace</code>, <code>debug</code>, <code>information</code>, <code>warning</code>, <code>error</code>.</li>
<li>log – The log file. Contains all the entries according to <code>level</code>.</li>
<li>errorlog – Error log file.</li>
<li>size – Size of the file. Applies to <code>log</code>and<code>errorlog</code>. Once the file reaches <code>size</code>, ClickHouse archives and renames it, and creates a new log file in its place.</li>
<li>count – The number of archived log files that ClickHouse stores.</li>
</ul>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;logger&gt;</span>
    <span class="nt">&lt;level&gt;</span>trace<span class="nt">&lt;/level&gt;</span>
    <span class="nt">&lt;log&gt;</span>/var/log/clickhouse-server/clickhouse-server.log<span class="nt">&lt;/log&gt;</span>
    <span class="nt">&lt;errorlog&gt;</span>/var/log/clickhouse-server/clickhouse-server.err.log<span class="nt">&lt;/errorlog&gt;</span>
    <span class="nt">&lt;size&gt;</span>1000M<span class="nt">&lt;/size&gt;</span>
    <span class="nt">&lt;count&gt;</span>10<span class="nt">&lt;/count&gt;</span>
<span class="nt">&lt;/logger&gt;</span>
</pre></div>


<p><a name="server_settings-macros"></a></p>
<h3 id="macros">macros</h3>
<p>Parameter substitutions for replicated tables.</p>
<p>Can be omitted if replicated tables are not used.</p>
<p>For more information, see the section "<a href="#table_engines-replication-creation_of_rep_tables">Creating replicated tables</a>".</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;macros</span> <span class="na">incl=</span><span class="s">&quot;macros&quot;</span> <span class="na">optional=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</pre></div>


<p><a name="server_settings-mark_cache_size"></a></p>
<h3 id="mark_cache_size">mark_cache_size</h3>
<p>Approximate size (in bytes) of the cache of "marks" used by <a href="#table_engines-mergetree">MergeTree</a> engines.</p>
<p>The cache is shared for the server and memory is allocated as needed. The cache size must be at least 5368709120.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;mark_cache_size&gt;</span>5368709120<span class="nt">&lt;/mark_cache_size&gt;</span>
</pre></div>


<p><a name="server_settings-max_concurrent_queries"></a></p>
<h3 id="max_concurrent_queries">max_concurrent_queries</h3>
<p>The maximum number of simultaneously processed requests.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;max_concurrent_queries&gt;</span>100<span class="nt">&lt;/max_concurrent_queries&gt;</span>
</pre></div>


<p><a name="server_settings-max_connections"></a></p>
<h3 id="max_connections">max_connections</h3>
<p>The maximum number of inbound connections.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;max_connections&gt;</span>4096<span class="nt">&lt;/max_connections&gt;</span>
</pre></div>


<p><a name="server_settings-max_open_files"></a></p>
<h3 id="max_open_files">max_open_files</h3>
<p>The maximum number of open files.</p>
<p>By default: <code>maximum</code>.</p>
<p>We recommend using this option in Mac OS X, since the <code>getrlimit()</code> function returns an incorrect value.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;max_open_files&gt;</span>262144<span class="nt">&lt;/max_open_files&gt;</span>
</pre></div>


<p><a name="server_settings-max_table_size_to_drop"></a></p>
<h3 id="max_table_size_to_drop">max_table_size_to_drop</h3>
<p>Restriction on deleting tables.</p>
<p>If the size of a <a href="#table_engines-mergetree">MergeTree</a> type table exceeds <code>max_table_size_to_drop</code> (in bytes), you can't delete it using a DROP query.</p>
<p>If you still need to delete the table without restarting the ClickHouse server, create the <code>&lt;clickhouse-path&gt;/flags/force_drop_table</code> file and run the DROP query.</p>
<p>Default value: 50 GB.</p>
<p>The value 0 means that you can delete all tables without any restrictions.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;max_table_size_to_drop&gt;</span>0<span class="nt">&lt;/max_table_size_to_drop&gt;</span>
</pre></div>


<p><a name="server_settings-merge_tree"></a></p>
<h3 id="merge_tree">merge_tree</h3>
<p>Fine tuning for tables in the <a href="#table_engines-mergetree"> MergeTree</a> family.</p>
<p>For more information, see the MergeTreeSettings.h header file.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;merge_tree&gt;</span>
    <span class="nt">&lt;max_suspicious_broken_parts&gt;</span>5<span class="nt">&lt;/max_suspicious_broken_parts&gt;</span>
<span class="nt">&lt;/merge_tree&gt;</span>
</pre></div>


<p><a name="server_settings-openSSL"></a></p>
<h3 id="openssl">openSSL</h3>
<p>SSL client/server configuration.</p>
<p>Support for SSL is provided by the <code>libpoco</code> library. The interface is described in the file <a href="https://github.com/ClickHouse-Extras/poco/blob/master/NetSSL_OpenSSL/include/Poco/Net/SSLManager.h">SSLManager.h</a></p>
<p>Keys for server/client settings:</p>
<ul>
<li>privateKeyFile – The path to the file with the secret key of the PEM certificate. The file may contain a key and certificate at the same time.</li>
<li>certificateFile – The path to the client/server certificate file in PEM format. You can omit it if <code>privateKeyFile</code> contains the certificate.</li>
<li>caConfig – The path to the file or directory that contains trusted root certificates.</li>
<li>verificationMode – The method for checking the node's certificates. Details are in the description of the <a href="https://github.com/ClickHouse-Extras/poco/blob/master/NetSSL_OpenSSL/include/Poco/Net/Context.h">Context</a> class. Possible values: <code>none</code>, <code>relaxed</code>, <code>strict</code>, <code>once</code>.</li>
<li>verificationDepth – The maximum length of the verification chain. Verification will fail if the certificate chain length exceeds the set value.</li>
<li>loadDefaultCAFile – Indicates that built-in CA certificates for OpenSSL will be used. Acceptable values: <code>true</code>, <code>false</code>.  |</li>
<li>cipherList – Supported OpenSSL encryptions. For example: <code>ALL:!ADH:!LOW:!EXP:!MD5:@STRENGTH</code>.</li>
<li>cacheSessions – Enables or disables caching sessions. Must be used in combination with <code>sessionIdContext</code>. Acceptable values: <code>true</code>, <code>false</code>.</li>
<li>sessionIdContext – A unique set of random characters that the server appends to each generated identifier. The length of the string must not exceed <code>SSL_MAX_SSL_SESSION_ID_LENGTH</code>. This parameter is always recommended, since it helps avoid problems both if the server caches the session and if the client requested caching. Default value: <code>${application.name}</code>.</li>
<li>sessionCacheSize – The maximum number of sessions that the server caches. Default value: 1024*20. 0 – Unlimited sessions.</li>
<li>sessionTimeout – Time for caching the session on the server.</li>
<li>extendedVerification – Automatically extended verification of certificates after the session ends. Acceptable values: <code>true</code>, <code>false</code>.</li>
<li>requireTLSv1 – Require a TLSv1 connection. Acceptable values: <code>true</code>, <code>false</code>.</li>
<li>requireTLSv1_1 – Require a TLSv1.1 connection. Acceptable values: <code>true</code>, <code>false</code>.</li>
<li>requireTLSv1 – Require a TLSv1.2 connection. Acceptable values: <code>true</code>, <code>false</code>.</li>
<li>fips – Activates OpenSSL FIPS mode. Supported if the library's OpenSSL version supports FIPS.</li>
<li>privateKeyPassphraseHandler – Class (PrivateKeyPassphraseHandler subclass) that requests the passphrase for accessing the private key. For example: <code>&lt;privateKeyPassphraseHandler&gt;</code>, <code>&lt;name&gt;KeyFileHandler&lt;/name&gt;</code>, <code>&lt;options&gt;&lt;password&gt;test&lt;/password&gt;&lt;/options&gt;</code>, <code>&lt;/privateKeyPassphraseHandler&gt;</code>.</li>
<li>invalidCertificateHandler – Class (subclass of CertificateHandler) for verifying invalid certificates. For example: <code>&lt;invalidCertificateHandler&gt; &lt;name&gt;ConsoleCertificateHandler&lt;/name&gt;  &lt;/invalidCertificateHandler&gt;</code> .</li>
<li>disableProtocols – Protocols that are not allowed to use.</li>
<li>preferServerCiphers – Preferred server ciphers on the client.</li>
</ul>
<p><strong>Example of settings:</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;openSSL&gt;</span>
    <span class="nt">&lt;server&gt;</span>
        <span class="c">&lt;!-- openssl req -subj &quot;/CN=localhost&quot; -new -newkey rsa:2048 -days 365 -nodes -x509 -keyout /etc/clickhouse-server/server.key -out /etc/clickhouse-server/server.crt --&gt;</span>
        <span class="nt">&lt;certificateFile&gt;</span>/etc/clickhouse-server/server.crt<span class="nt">&lt;/certificateFile&gt;</span>
        <span class="nt">&lt;privateKeyFile&gt;</span>/etc/clickhouse-server/server.key<span class="nt">&lt;/privateKeyFile&gt;</span>
        <span class="c">&lt;!-- openssl dhparam -out /etc/clickhouse-server/dhparam.pem 4096 --&gt;</span>
        <span class="nt">&lt;dhParamsFile&gt;</span>/etc/clickhouse-server/dhparam.pem<span class="nt">&lt;/dhParamsFile&gt;</span>
        <span class="nt">&lt;verificationMode&gt;</span>none<span class="nt">&lt;/verificationMode&gt;</span>
        <span class="nt">&lt;loadDefaultCAFile&gt;</span>true<span class="nt">&lt;/loadDefaultCAFile&gt;</span>
        <span class="nt">&lt;cacheSessions&gt;</span>true<span class="nt">&lt;/cacheSessions&gt;</span>
        <span class="nt">&lt;disableProtocols&gt;</span>sslv2,sslv3<span class="nt">&lt;/disableProtocols&gt;</span>
        <span class="nt">&lt;preferServerCiphers&gt;</span>true<span class="nt">&lt;/preferServerCiphers&gt;</span>
    <span class="nt">&lt;/server&gt;</span>
    <span class="nt">&lt;client&gt;</span>
        <span class="nt">&lt;loadDefaultCAFile&gt;</span>true<span class="nt">&lt;/loadDefaultCAFile&gt;</span>
        <span class="nt">&lt;cacheSessions&gt;</span>true<span class="nt">&lt;/cacheSessions&gt;</span>
        <span class="nt">&lt;disableProtocols&gt;</span>sslv2,sslv3<span class="nt">&lt;/disableProtocols&gt;</span>
        <span class="nt">&lt;preferServerCiphers&gt;</span>true<span class="nt">&lt;/preferServerCiphers&gt;</span>
        <span class="c">&lt;!-- Use for self-signed: &lt;verificationMode&gt;none&lt;/verificationMode&gt; --&gt;</span>
        <span class="nt">&lt;invalidCertificateHandler&gt;</span>
            <span class="c">&lt;!-- Use for self-signed: &lt;name&gt;AcceptCertificateHandler&lt;/name&gt; --&gt;</span>
            <span class="nt">&lt;name&gt;</span>RejectCertificateHandler<span class="nt">&lt;/name&gt;</span>
        <span class="nt">&lt;/invalidCertificateHandler&gt;</span>
    <span class="nt">&lt;/client&gt;</span>
<span class="nt">&lt;/openSSL&gt;</span>
</pre></div>


<p><a name="server_settings-part_log"></a></p>
<h3 id="part_log">part_log</h3>
<p>Logging events that are associated with <a href="#table_engines-mergetree">MergeTree</a> data. For instance, adding or merging data. You can use the log to simulate merge algorithms and compare their characteristics. You can visualize the merge process.</p>
<p>Queries are logged in the ClickHouse table, not in a separate file.</p>
<p>Columns in the log:</p>
<ul>
<li>event_time – Date of the event.</li>
<li>duration_ms – Duration of the event.</li>
<li>event_type – Type of event. 1 – new data part; 2 – merge result; 3 – data part downloaded from replica; 4 – data part deleted.</li>
<li>database_name – The name of the database.</li>
<li>table_name – Name of the table.</li>
<li>part_name – Name of the data part.</li>
<li>size_in_bytes – Size of the data part in bytes.</li>
<li>merged_from – An array of names of data parts that make up the merge (also used when downloading a merged part).</li>
<li>merge_time_ms – Time spent on the merge.</li>
</ul>
<p>Use the following parameters to configure logging:</p>
<ul>
<li>database – Name of the database.</li>
<li>table – Name of the table.</li>
<li>partition_by – Sets a <a href="#custom-partitioning-key">custom partitioning key</a>.</li>
<li>flush_interval_milliseconds – Interval for flushing data from memory to the disk.</li>
</ul>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;part_log&gt;</span>
    <span class="nt">&lt;database&gt;</span>system<span class="nt">&lt;/database&gt;</span>
    <span class="nt">&lt;table&gt;</span>part_log<span class="nt">&lt;/table&gt;</span>
    <span class="nt">&lt;partition_by&gt;</span>toMonday(event_date)<span class="nt">&lt;/partition_by&gt;</span>
    <span class="nt">&lt;flush_interval_milliseconds&gt;</span>7500<span class="nt">&lt;/flush_interval_milliseconds&gt;</span>
<span class="nt">&lt;/part_log&gt;</span>
</pre></div>


<p><a name="server_settings-path"></a></p>
<h3 id="path_1">path</h3>
<p>The path to the directory containing data.</p>
<div class="admonition warning">

The end slash is mandatory.

</div>

<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;path&gt;</span>/var/lib/clickhouse/<span class="nt">&lt;/path&gt;</span>
</pre></div>


<p><a name="server_settings-query_log"></a></p>
<h3 id="query_log">query_log</h3>
<p>Setting for logging queries received with the <a href="#settings_settings-log_queries">log_queries=1</a> setting.</p>
<p>Queries are logged in the ClickHouse table, not in a separate file.</p>
<p>Use the following parameters to configure logging:</p>
<ul>
<li>database – Name of the database.</li>
<li>table – Name of the table.</li>
<li>partition_by – Sets a <a href="#custom-partitioning-key">custom partitioning key</a>.</li>
<li>flush_interval_milliseconds – Interval for flushing data from memory to the disk.</li>
</ul>
<p>If the table doesn't exist, ClickHouse will create it. If the structure of the query log changed when the ClickHouse server was updated, the table with the old structure is renamed, and a new table is created automatically.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;query_log&gt;</span>
    <span class="nt">&lt;database&gt;</span>system<span class="nt">&lt;/database&gt;</span>
    <span class="nt">&lt;table&gt;</span>query_log<span class="nt">&lt;/table&gt;</span>
    <span class="nt">&lt;partition_by&gt;</span>toMonday(event_date)<span class="nt">&lt;/partition_by&gt;</span>
    <span class="nt">&lt;flush_interval_milliseconds&gt;</span>7500<span class="nt">&lt;/flush_interval_milliseconds&gt;</span>
<span class="nt">&lt;/query_log&gt;</span>
</pre></div>


<p><a name="server_settings-remote_servers"></a></p>
<h3 id="remote_servers">remote_servers</h3>
<p>Configuration of clusters used by the Distributed table engine.</p>
<p>For more information, see the section "<a href="#table_engines-distributed">Table engines/Distributed</a>".</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;remote_servers</span> <span class="na">incl=</span><span class="s">&quot;clickhouse_remote_servers&quot;</span> <span class="nt">/&gt;</span>
</pre></div>


<p>For the value of the <code>incl</code> attribute, see the section "<a href="#configuration_files">Configuration files</a>".</p>
<p><a name="server_settings-timezone"></a></p>
<h3 id="timezone">timezone</h3>
<p>The server's time zone.</p>
<p>Specified as an IANA identifier for the UTC time zone or geographic location (for example, Africa/Abidjan).</p>
<p>The time zone is necessary for conversions between String and DateTime formats when DateTime fields are output to text format (printed on the screen or in a file), and when getting DateTime from a string. In addition, the time zone is used in functions that work with the time and date if they didn't receive the time zone in the input parameters.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;timezone&gt;</span>Europe/Moscow<span class="nt">&lt;/timezone&gt;</span>
</pre></div>


<p><a name="server_settings-tcp_port"></a></p>
<h3 id="tcp_port">tcp_port</h3>
<p>Port for communicating with clients over the TCP protocol.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;tcp_port&gt;</span>9000<span class="nt">&lt;/tcp_port&gt;</span>
</pre></div>


<p><a name="server_settings-tmp_path"></a></p>
<h3 id="tmp_path">tmp_path</h3>
<p>Path to temporary data for processing large queries.</p>
<div class="admonition warning">

The end slash is mandatory.

</div>

<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;tmp_path&gt;</span>/var/lib/clickhouse/tmp/<span class="nt">&lt;/tmp_path&gt;</span>
</pre></div>


<p><a name="server_settings-uncompressed_cache_size"></a></p>
<h3 id="uncompressed_cache_size">uncompressed_cache_size</h3>
<p>Cache size (in bytes) for uncompressed data used by table engines from the <a href="#table_engines-mergetree">MergeTree</a> family.</p>
<p>There is one shared cache for the server. Memory is allocated on demand. The cache is used if the option <a href="#settings-use_uncompressed_cache">use_uncompressed_cache</a> is enabled.</p>
<p>The uncompressed cache is advantageous for very short queries in individual cases.</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;uncompressed_cache_size&gt;</span>8589934592<span class="nt">&lt;/uncompressed_cache_size&gt;</span>
</pre></div>


<p><a name="server_settings-users_config"></a></p>
<h3 id="users_config">users_config</h3>
<p>Path to the file that contains:</p>
<ul>
<li>User configurations.</li>
<li>Access rights.</li>
<li>Settings profiles.</li>
<li>Quota settings.</li>
</ul>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;users_config&gt;</span>users.xml<span class="nt">&lt;/users_config&gt;</span>
</pre></div>


<p><a name="server_settings-zookeeper"></a></p>
<h3 id="zookeeper_1">zookeeper</h3>
<p>Configuration of ZooKeeper servers.</p>
<p>ClickHouse uses ZooKeeper for storing replica metadata when using replicated tables.</p>
<p>This parameter can be omitted if replicated tables are not used.</p>
<p>For more information, see the section "<a href="#table_engines-replication">Replication</a>".</p>
<p><strong>Example</strong></p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;zookeeper</span> <span class="na">incl=</span><span class="s">&quot;zookeeper-servers&quot;</span> <span class="na">optional=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</pre></div>


<p><a name="settings"></a></p>
<h2 id="settings">Settings</h2>
<p>There are multiple ways to make all the settings described below.
Settings are configured in layers, so each subsequent layer redefines the previous settings.</p>
<p>Ways to configure settings, in order of priority:</p>
<ul>
<li>Settings in the server config file.</li>
</ul>
<p>Settings from user profiles.</p>
<ul>
<li>Session settings.</li>
</ul>
<p>Send <code>SET setting=value</code> from the ClickHouse console client in interactive mode.
Similarly, you can use ClickHouse sessions in the HTTP protocol. To do this, you need to specify the <code>session_id</code> HTTP parameter.</p>
<ul>
<li>For a query.</li>
<li>When starting the ClickHouse console client in non-interactive mode, set the startup parameter <code>--setting=value</code>.</li>
<li>When using the HTTP API, pass CGI parameters (<code>URL?setting_1=value&amp;setting_2=value...</code>).</li>
</ul>
<p>Settings that can only be made in the server config file are not covered in this section.</p>
<h2 id="restrictions-on-query-complexity">Restrictions on query complexity</h2>
<p>Restrictions on query complexity are part of the settings.
They are used in order to provide safer execution from the user interface.
Almost all the restrictions only apply to SELECTs.For distributed query processing, restrictions are applied on each server separately.</p>
<p>Restrictions on the "maximum amount of something" can take the value 0, which means "unrestricted".
Most restrictions also have an 'overflow_mode' setting, meaning what to do when the limit is exceeded.
It can take one of two values: <code>throw</code> or <code>break</code>. Restrictions on aggregation (group_by_overflow_mode) also have the value <code>any</code>.</p>
<p><code>throw</code> – Throw an exception (default).</p>
<p><code>break</code> – Stop executing the query and return the partial result, as if the source data ran out.</p>
<p><code>any (only for group_by_overflow_mode)</code> – Continuing aggregation for the keys that got into the set, but don't add new keys to the set.</p>
<p><a name="query_complexity_readonly"></a></p>
<h3 id="readonly">readonly</h3>
<p>With a value of 0, you can execute any queries.
With a value of 1, you can only execute read requests (such as SELECT and SHOW). Requests for writing and changing settings (INSERT, SET) are prohibited.
With a value of 2, you can process read queries (SELECT, SHOW) and change settings (SET).</p>
<p>After enabling readonly mode, you can't disable it in the current session.</p>
<p>When using the GET method in the HTTP interface, 'readonly = 1' is set automatically. In other words, for queries that modify data, you can only use the POST method. You can send the query itself either in the POST body, or in the URL parameter.</p>
<p><a name="settings_max_memory_usage"></a></p>
<h3 id="max_memory_usage">max_memory_usage</h3>
<p>The maximum amount of RAM to use for running a query on a single server.</p>
<p>In the default configuration file, the maximum is 10 GB.</p>
<p>The setting doesn't consider the volume of available memory or the total volume of memory on the machine.
The restriction applies to a single query within a single server.
You can use <code>SHOW PROCESSLIST</code> to see the current memory consumption for each query.
In addition, the peak memory consumption is tracked for each query and written to the log.</p>
<p>Memory usage is not monitored for the states of certain aggregate functions.</p>
<p>Memory usage is not fully tracked for states of the aggregate functions <code>min</code>, <code>max</code>, <code>any</code>, <code>anyLast</code>, <code>argMin</code>, <code>argMax</code> from <code>String</code> and <code>Array</code> arguments.</p>
<p>Memory consumption is also restricted by the parameters <code>max_memory_usage_for_user</code> and <code>max_memory_usage_for_all_queries</code>.</p>
<h3 id="max_memory_usage_for_user">max_memory_usage_for_user</h3>
<p>The maximum amount of RAM to use for running a user's queries on a single server.</p>
<p>Default values are defined in <a href="https://github.com/yandex/ClickHouse/blob/master/dbms/src/Interpreters/Settings.h#L244">Settings.h</a>. By default, the amount is not restricted (<code>max_memory_usage_for_user = 0</code>).</p>
<p>See also the description of <a href="#settings_max_memory_usage">max_memory_usage</a>.</p>
<h3 id="max_memory_usage_for_all_queries">max_memory_usage_for_all_queries</h3>
<p>The maximum amount of RAM to use for running all queries on a single server.</p>
<p>Default values are defined in <a href="https://github.com/yandex/ClickHouse/blob/master/dbms/src/Interpreters/Settings.h#L245">Settings.h</a>. By default, the amount is not restricted (<code>max_memory_usage_for_all_queries = 0</code>).</p>
<p>See also the description of <a href="#settings_max_memory_usage">max_memory_usage</a>.</p>
<h3 id="max_rows_to_read">max_rows_to_read</h3>
<p>The following restrictions can be checked on each block (instead of on each row). That is, the restrictions can be broken a little.
When running a query in multiple threads, the following restrictions apply to each thread separately.</p>
<p>Maximum number of rows that can be read from a table when running a query.</p>
<h3 id="max_bytes_to_read">max_bytes_to_read</h3>
<p>Maximum number of bytes (uncompressed data) that can be read from a table when running a query.</p>
<h3 id="read_overflow_mode">read_overflow_mode</h3>
<p>What to do when the volume of data read exceeds one of the limits: 'throw' or 'break'. By default, throw.</p>
<h3 id="max_rows_to_group_by">max_rows_to_group_by</h3>
<p>Maximum number of unique keys received from aggregation. This setting lets you limit memory consumption when aggregating.</p>
<h3 id="group_by_overflow_mode">group_by_overflow_mode</h3>
<p>What to do when the number of unique keys for aggregation exceeds the limit: 'throw', 'break', or 'any'. By default, throw.
Using the 'any' value lets you run an approximation of GROUP BY. The quality of this approximation depends on the statistical nature of the data.</p>
<h3 id="max_rows_to_sort">max_rows_to_sort</h3>
<p>Maximum number of rows before sorting. This allows you to limit memory consumption when sorting.</p>
<h3 id="max_bytes_to_sort">max_bytes_to_sort</h3>
<p>Maximum number of bytes before sorting.</p>
<h3 id="sort_overflow_mode">sort_overflow_mode</h3>
<p>What to do if the number of rows received before sorting exceeds one of the limits: 'throw' or 'break'. By default, throw.</p>
<h3 id="max_result_rows">max_result_rows</h3>
<p>Limit on the number of rows in the result. Also checked for subqueries, and on remote servers when running parts of a distributed query.</p>
<h3 id="max_result_bytes">max_result_bytes</h3>
<p>Limit on the number of bytes in the result. The same as the previous setting.</p>
<h3 id="result_overflow_mode">result_overflow_mode</h3>
<p>What to do if the volume of the result exceeds one of the limits: 'throw' or 'break'. By default, throw.
Using 'break' is similar to using LIMIT.</p>
<h3 id="max_execution_time">max_execution_time</h3>
<p>Maximum query execution time in seconds.
At this time, it is not checked for one of the sorting stages, or when merging and finalizing aggregate functions.</p>
<h3 id="timeout_overflow_mode">timeout_overflow_mode</h3>
<p>What to do if the query is run longer than 'max_execution_time': 'throw' or 'break'. By default, throw.</p>
<h3 id="min_execution_speed">min_execution_speed</h3>
<p>Minimal execution speed in rows per second. Checked on every data block when 'timeout_before_checking_execution_speed' expires. If the execution speed is lower, an exception is thrown.</p>
<h3 id="timeout_before_checking_execution_speed">timeout_before_checking_execution_speed</h3>
<p>Checks that execution speed is not too slow (no less than 'min_execution_speed'), after the specified time in seconds has expired.</p>
<h3 id="max_columns_to_read">max_columns_to_read</h3>
<p>Maximum number of columns that can be read from a table in a single query. If a query requires reading a greater number of columns, it throws an exception.</p>
<h3 id="max_temporary_columns">max_temporary_columns</h3>
<p>Maximum number of temporary columns that must be kept in RAM at the same time when running a query, including constant columns. If there are more temporary columns than this, it throws an exception.</p>
<h3 id="max_temporary_non_const_columns">max_temporary_non_const_columns</h3>
<p>The same thing as 'max_temporary_columns', but without counting constant columns.
Note that constant columns are formed fairly often when running a query, but they require approximately zero computing resources.</p>
<h3 id="max_subquery_depth">max_subquery_depth</h3>
<p>Maximum nesting depth of subqueries. If subqueries are deeper, an exception is thrown. By default, 100.</p>
<h3 id="max_pipeline_depth">max_pipeline_depth</h3>
<p>Maximum pipeline depth. Corresponds to the number of transformations that each data block goes through during query processing. Counted within the limits of a single server. If the pipeline depth is greater, an exception is thrown. By default, 1000.</p>
<h3 id="max_ast_depth">max_ast_depth</h3>
<p>Maximum nesting depth of a query syntactic tree. If exceeded, an exception is thrown.
At this time, it isn't checked during parsing, but only after parsing the query. That is, a syntactic tree that is too deep can be created during parsing, but the query will fail. By default, 1000.</p>
<h3 id="max_ast_elements">max_ast_elements</h3>
<p>Maximum number of elements in a query syntactic tree. If exceeded, an exception is thrown.
In the same way as the previous setting, it is checked only after parsing the query. By default, 10,000.</p>
<h3 id="max_rows_in_set">max_rows_in_set</h3>
<p>Maximum number of rows for a data set in the IN clause created from a subquery.</p>
<h3 id="max_bytes_in_set">max_bytes_in_set</h3>
<p>Maximum number of bytes (uncompressed data) used by a set in the IN clause created from a subquery.</p>
<h3 id="set_overflow_mode">set_overflow_mode</h3>
<p>What to do when the amount of data exceeds one of the limits: 'throw' or 'break'. By default, throw.</p>
<h3 id="max_rows_in_distinct">max_rows_in_distinct</h3>
<p>Maximum number of different rows when using DISTINCT.</p>
<h3 id="max_bytes_in_distinct">max_bytes_in_distinct</h3>
<p>Maximum number of bytes used by a hash table when using DISTINCT.</p>
<h3 id="distinct_overflow_mode">distinct_overflow_mode</h3>
<p>What to do when the amount of data exceeds one of the limits: 'throw' or 'break'. By default, throw.</p>
<h3 id="max_rows_to_transfer">max_rows_to_transfer</h3>
<p>Maximum number of rows that can be passed to a remote server or saved in a temporary table when using GLOBAL IN.</p>
<h3 id="max_bytes_to_transfer">max_bytes_to_transfer</h3>
<p>Maximum number of bytes (uncompressed data) that can be passed to a remote server or saved in a temporary table when using GLOBAL IN.</p>
<h3 id="transfer_overflow_mode">transfer_overflow_mode</h3>
<p>What to do when the amount of data exceeds one of the limits: 'throw' or 'break'. By default, throw.</p>
<h2 id="settings_1">Settings</h2>
<p><a name="settings-distributed_product_mode"></a></p>
<h3 id="distributed_product_mode">distributed_product_mode</h3>
<p>Changes the behavior of <a href="#queries-distributed-subrequests">distributed subqueries</a>, i.e. in cases when the query contains the product of distributed tables.</p>
<p>ClickHouse applies the configuration if the subqueries on any level have a distributed table that exists on the local server and has more than one shard.</p>
<p>Restrictions:</p>
<ul>
<li>Only applied for IN and JOIN subqueries.</li>
<li>Used only if a distributed table is used in the FROM clause.</li>
<li>Not used for a table-valued <a href="#table_functions-remote"> remote</a> function.</li>
</ul>
<p>The possible values ​​are:</p>
<p><a name="settings-settings-fallback_to_stale_replicas_for_distributed_queries"></a></p>
<h3 id="fallback_to_stale_replicas_for_distributed_queries">fallback_to_stale_replicas_for_distributed_queries</h3>
<p>Forces a query to an out-of-date replica if updated data is not available. See "<a href="#table_engines-replication">Replication</a>".</p>
<p>ClickHouse selects the most relevant from the outdated replicas of the table.</p>
<p>Used when performing <code>SELECT</code>  from a distributed table that points to replicated tables.</p>
<p>By default, 1 (enabled).</p>
<p><a name="settings-settings-force_index_by_date"></a></p>
<h3 id="force_index_by_date">force_index_by_date</h3>
<p>Disables query execution if the index can't be used by date.</p>
<p>Works with tables in the MergeTree family.</p>
<p>If <code>force_index_by_date=1</code>,  ClickHouse checks whether the query has a date key condition that can be used for restricting data ranges. If there is no suitable condition, it throws an exception. However, it does not check whether the condition actually reduces the amount of data to read. For example, the condition <code>Date != ' 2000-01-01 '</code> is acceptable even when it matches all the data in the table (i.e., running the query requires a full scan). For more information about ranges of data in MergeTree tables, see "<a href="#table_engines-mergetree">MergeTree</a>".</p>
<p><a name="settings-settings-force_primary_key"></a></p>
<h3 id="force_primary_key">force_primary_key</h3>
<p>Disables query execution if indexing by the primary key is not possible.</p>
<p>Works with tables in the MergeTree family.</p>
<p>If <code>force_primary_key=1</code>,  ClickHouse checks to see if the query has a primary key condition that can be used for restricting data ranges. If there is no suitable condition, it throws an exception. However, it does not check whether the condition actually reduces the amount of data to read. For more information about data ranges in MergeTree tables, see "<a href="#table_engines-mergetree">MergeTree</a>".</p>
<p><a name="settings_settings_fsync_metadata"></a></p>
<h3 id="fsync_metadata">fsync_metadata</h3>
<p>Enable or disable fsync when writing .sql files. By default, it is enabled.</p>
<p>It makes sense to disable it if the server has millions of tiny table chunks that are constantly being created and destroyed.</p>
<h3 id="input_format_allow_errors_num">input_format_allow_errors_num</h3>
<p>Sets the maximum number of acceptable errors when reading from text formats (CSV, TSV, etc.).</p>
<p>The default value is 0.</p>
<p>Always pair it with <code>input_format_allow_errors_ratio</code>. To skip errors, both settings must be greater than 0.</p>
<p>If an error occurred while reading rows but the error counter is still less than <code>input_format_allow_errors_num</code>, ClickHouse ignores the row and moves on to the next one.</p>
<p>If <code>input_format_allow_errors_num</code>is exceeded, ClickHouse throws an exception.</p>
<h3 id="input_format_allow_errors_ratio">input_format_allow_errors_ratio</h3>
<p>Sets the maximum percentage of errors allowed when reading from text formats (CSV, TSV, etc.).
The percentage of errors is set as a floating-point number between 0 and 1.</p>
<p>The default value is 0.</p>
<p>Always pair it with <code>input_format_allow_errors_num</code>. To skip errors, both settings must be greater than 0.</p>
<p>If an error occurred while reading rows but the error counter is still less than <code>input_format_allow_errors_ratio</code>, ClickHouse ignores the row and moves on to the next one.</p>
<p>If <code>input_format_allow_errors_ratio</code> is exceeded, ClickHouse throws an exception.</p>
<h3 id="max_block_size">max_block_size</h3>
<p>In ClickHouse, data is processed by blocks (sets of column parts). The internal processing cycles for a single block are efficient enough, but there are noticeable expenditures on each block. <code>max_block_size</code> is a recommendation for what size of block (in number of rows) to load from tables. The block size shouldn't be too small, so that the expenditures on each block are still noticeable, but not too large, so that the query with LIMIT that is completed after the first block is processed quickly, so that too much memory isn't consumed when extracting a large number of columns in multiple threads, and so that at least some cache locality is preserved.</p>
<p>By default, 65,536.</p>
<p>Blocks the size of <code>max_block_size</code> are not always loaded from the table. If it is obvious that less data needs to be retrieved, a smaller block is processed.</p>
<h3 id="preferred_block_size_bytes">preferred_block_size_bytes</h3>
<p>Used for the same purpose as <code>max_block_size</code>, but it sets the recommended block size in bytes by adapting it to the number of rows in the block.
However, the block size cannot be more than <code>max_block_size</code> rows.
Disabled by default (set to 0). It only works when reading from MergeTree engines.</p>
<p><a name="settings_settings-log_queries"></a></p>
<h3 id="log_queries">log_queries</h3>
<p>Setting up query the logging.</p>
<p>Queries sent to ClickHouse with this setup are logged according to the rules in the <a href="#server_settings-query_log">query_log</a> server configuration parameter.</p>
<p><strong>Example</strong>:</p>
<div class="codehilite"><pre><span></span>log_queries=1
</pre></div>


<p><a name="settings-settings-max_insert_block_size"></a></p>
<h3 id="max_insert_block_size">max_insert_block_size</h3>
<p>The size of blocks to form for insertion into a table.
This setting only applies in cases when the server forms the blocks.
For example, for an INSERT via the HTTP interface, the server parses the data format and forms blocks of the specified size.
But when using clickhouse-client, the client parses the data itself, and the 'max_insert_block_size' setting on the server doesn't affect the size of the inserted blocks.
The setting also doesn't have a purpose when using INSERT SELECT, since data is inserted using the same blocks that are formed after SELECT.</p>
<p>By default, it is 1,048,576.</p>
<p>This is slightly more than <code>max_block_size</code>. The reason for this is because certain table engines (<code>*MergeTree</code>) form a data part on the disk for each inserted block, which is a fairly large entity. Similarly, <code>*MergeTree</code> tables sort data during insertion, and a large enough block size allows sorting more data in RAM.</p>
<p><a name="settings_settings_max_replica_delay_for_distributed_queries"></a></p>
<h3 id="max_replica_delay_for_distributed_queries">max_replica_delay_for_distributed_queries</h3>
<p>Disables lagging replicas for distributed queries. See "<a href="#table_engines-replication">Replication</a>".</p>
<p>Sets the time in seconds. If a replica lags more than the set value, this replica is not used.</p>
<p>Default value: 0 (off).</p>
<p>Used when performing <code>SELECT</code>  from a distributed table that points to replicated tables.</p>
<h3 id="max_threads">max_threads</h3>
<p>The maximum number of query processing threads</p>
<ul>
<li>excluding threads for retrieving data from remote servers (see the 'max_distributed_connections' parameter).</li>
</ul>
<p>This parameter applies to threads that perform the same stages of the query processing pipeline in parallel.
For example, if reading from a table, evaluating expressions with functions, filtering with WHERE and pre-aggregating for GROUP BY can all be done in parallel using at least 'max_threads' number of threads, then 'max_threads' are used.</p>
<p>By default, 8.</p>
<p>If less than one SELECT query is normally run on a server at a time, set this parameter to a value slightly less than the actual number of processor cores.</p>
<p>For queries that are completed quickly because of a LIMIT, you can set a lower 'max_threads'. For example, if the necessary number of entries are located in every block and max_threads = 8, 8 blocks are retrieved, although it would have been enough to read just one.</p>
<p>The smaller the <code>max_threads</code> value, the less memory is consumed.</p>
<h3 id="max_compress_block_size">max_compress_block_size</h3>
<p>The maximum size of blocks of uncompressed data before compressing for writing to a table. By default, 1,048,576 (1 MiB). If the size is reduced, the compression rate is significantly reduced, the compression and decompression speed increases slightly due to cache locality, and memory consumption is reduced. There usually isn't any reason to change this setting.</p>
<p>Don't confuse blocks for compression (a chunk of memory consisting of bytes) and blocks for query processing (a set of rows from a table).</p>
<h3 id="min_compress_block_size">min_compress_block_size</h3>
<p>For <a href="#table_engines-mergetree">MergeTree</a>" tables. In order to reduce latency when processing queries, a block is compressed when writing the next mark if its size is at least 'min_compress_block_size'. By default, 65,536.</p>
<p>The actual size of the block, if the uncompressed data is less than 'max_compress_block_size', is no less than this value and no less than the volume of data for one mark.</p>
<p>Let's look at an example. Assume that 'index_granularity' was set to 8192 during table creation.</p>
<p>We are writing a UInt32-type column (4 bytes per value). When writing 8192 rows, the total will be 32 KB of data. Since min_compress_block_size = 65,536, a compressed block will be formed for every two marks.</p>
<p>We are writing a URL column with the String type (average size of 60 bytes per value). When writing 8192 rows, the average will be slightly less than 500 KB of data. Since this is more than 65,536, a compressed block will be formed for each mark. In this case, when reading data from the disk in the range of a single mark, extra data won't be decompressed.</p>
<p>There usually isn't any reason to change this setting.</p>
<h3 id="max_query_size">max_query_size</h3>
<p>The maximum part of a query that can be taken to RAM for parsing with the SQL parser.
The INSERT query also contains data for INSERT that is processed by a separate stream parser (that consumes O(1) RAM), which is not included in this restriction.</p>
<p>The default is 256 KiB.</p>
<h3 id="interactive_delay">interactive_delay</h3>
<p>The interval in microseconds for checking whether request execution has been canceled and sending the progress.</p>
<p>By default, 100,000 (check for canceling and send progress ten times per second).</p>
<h3 id="connect_timeout">connect_timeout</h3>
<h3 id="receive_timeout">receive_timeout</h3>
<h3 id="send_timeout">send_timeout</h3>
<p>Timeouts in seconds on the socket used for communicating with the client.</p>
<p>By default, 10, 300, 300.</p>
<h3 id="poll_interval">poll_interval</h3>
<p>Lock in a wait loop for the specified number of seconds.</p>
<p>By default, 10.</p>
<h3 id="max_distributed_connections">max_distributed_connections</h3>
<p>The maximum number of simultaneous connections with remote servers for distributed processing of a single query to a single Distributed table. We recommend setting a value no less than the number of servers in the cluster.</p>
<p>By default, 100.</p>
<p>The following parameters are only used when creating Distributed tables (and when launching a server), so there is no reason to change them at runtime.</p>
<h3 id="distributed_connections_pool_size">distributed_connections_pool_size</h3>
<p>The maximum number of simultaneous connections with remote servers for distributed processing of all queries to a single Distributed table. We recommend setting a value no less than the number of servers in the cluster.</p>
<p>By default, 128.</p>
<h3 id="connect_timeout_with_failover_ms">connect_timeout_with_failover_ms</h3>
<p>The timeout in milliseconds for connecting to a remote server for a Distributed table engine, if the 'shard' and 'replica' sections are used in the cluster definition.
If unsuccessful, several attempts are made to connect to various replicas.</p>
<p>By default, 50.</p>
<h3 id="connections_with_failover_max_tries">connections_with_failover_max_tries</h3>
<p>The maximum number of connection attempts with each replica, for the Distributed table engine.</p>
<p>By default, 3.</p>
<h3 id="extremes">extremes</h3>
<p>Whether to count extreme values (the minimums and maximums in columns of a query result). Accepts 0 or 1. By default, 0 (disabled).
For more information, see the section "Extreme values".</p>
<p><a name="settings-use_uncompressed_cache"></a></p>
<h3 id="use_uncompressed_cache">use_uncompressed_cache</h3>
<p>Whether to use a cache of uncompressed blocks. Accepts 0 or 1. By default, 0 (disabled).
The uncompressed cache (only for tables in the MergeTree family) allows significantly reducing latency and increasing throughput when working with a large number of short queries. Enable this setting for users who send frequent short requests. Also pay attention to the 'uncompressed_cache_size' configuration parameter (only set in the config file) – the size of uncompressed cache blocks. By default, it is 8 GiB. The uncompressed cache is filled in as needed; the least-used data is automatically deleted.</p>
<p>For queries that read at least a somewhat large volume of data (one million rows or more), the uncompressed cache is disabled automatically in order to save space for truly small queries. So you can keep the 'use_uncompressed_cache' setting always set to 1.</p>
<h3 id="replace_running_query">replace_running_query</h3>
<p>When using the HTTP interface, the 'query_id' parameter can be passed. This is any string that serves as the query identifier.
If a query from the same user with the same 'query_id' already exists at this time, the behavior depends on the 'replace_running_query' parameter.</p>
<p><code>0</code> (default) – Throw an exception (don't allow the query to run if a query with the same 'query_id' is already running).</p>
<p><code>1</code> – Cancel the old query and start running the new one.</p>
<p>Yandex.Metrica uses this parameter set to 1 for implementing suggestions for segmentation conditions. After entering the next character, if the old query hasn't finished yet, it should be canceled.</p>
<h3 id="schema">schema</h3>
<p>This parameter is useful when you are using formats that require a schema definition, such as <a href="https://capnproto.org/">Cap'n Proto</a>. The value depends on the format.</p>
<p><a name="settings-settings_stream_flush_interval_ms"></a></p>
<h3 id="stream_flush_interval_ms">stream_flush_interval_ms</h3>
<p>Works for tables with streaming in the case of a timeout, or when a thread generates<a href="#settings-settings-max_insert_block_size">max_insert_block_size</a> rows.</p>
<p>The default value is 7500.</p>
<p>The smaller the value, the more often data is flushed into the table. Setting the value too low leads to poor performance.</p>
<p><a name="settings-load_balancing"></a></p>
<h3 id="load_balancing">load_balancing</h3>
<p>Which replicas (among healthy replicas) to preferably send a query to (on the first attempt) for distributed processing.</p>
<h4 id="random-default">random (default)</h4>
<p>The number of errors is counted for each replica. The query is sent to the replica with the fewest errors, and if there are several of these, to any one of them.
Disadvantages: Server proximity is not accounted for; if the replicas have different data, you will also get different data.</p>
<h4 id="nearest_hostname">nearest_hostname</h4>
<p>The number of errors is counted for each replica. Every 5 minutes, the number of errors is integrally divided by 2. Thus, the number of errors is calculated for a recent time with exponential smoothing. If there is one replica with a minimal number of errors (i.e. errors occurred recently on the other replicas), the query is sent to it. If there are multiple replicas with the same minimal number of errors, the query is sent to the replica with a host name that is most similar to the server's host name in the config file (for the number of different characters in identical positions, up to the minimum length of both host names).</p>
<p>For instance, example01-01-1 and example01-01-2.yandex.ru are different in one position, while example01-01-1 and example01-02-2 differ in two places.
This method might seem a little stupid, but it doesn't use external data about network topology, and it doesn't compare IP addresses, which would be complicated for our IPv6 addresses.</p>
<p>Thus, if there are equivalent replicas, the closest one by name is preferred.
We can also assume that when sending a query to the same server, in the absence of failures, a distributed query will also go to the same servers. So even if different data is placed on the replicas, the query will return mostly the same results.</p>
<h4 id="in_order">in_order</h4>
<p>Replicas are accessed in the same order as they are specified. The number of errors does not matter.
This method is appropriate when you know exactly which replica is preferable.</p>
<h3 id="totals_mode">totals_mode</h3>
<p>How to calculate TOTALS when HAVING is present, as well as when max_rows_to_group_by and group_by_overflow_mode = 'any' are present.
See the section "WITH TOTALS modifier".</p>
<h3 id="totals_auto_threshold">totals_auto_threshold</h3>
<p>The threshold for <code>totals_mode = 'auto'</code>.
See the section "WITH TOTALS modifier".</p>
<h3 id="default_sample">default_sample</h3>
<p>Floating-point number from 0 to 1. By default, 1.
Allows you to set the default sampling ratio for all SELECT queries.
(For tables that do not support sampling, it throws an exception.)
If set to 1, sampling is not performed by default.</p>
<h3 id="max_parallel_replicas">max_parallel_replicas</h3>
<p>The maximum number of replicas for each shard when executing a query.
For consistency (to get different parts of the same data split), this option only works when the sampling key is set.
Replica lag is not controlled.</p>
<h3 id="compile">compile</h3>
<p>Enable compilation of queries. By default, 0 (disabled).</p>
<p>Compilation is only used for part of the query-processing pipeline: for the first stage of aggregation (GROUP BY).
If this portion of the pipeline was compiled, the query may run faster due to  deployment of short cycles and inlining aggregate function calls. The maximum performance improvement (up to four times faster in rare cases) is seen for queries with multiple simple aggregate functions. Typically, the performance gain is insignificant. In very rare cases, it may slow down query execution.</p>
<h3 id="min_count_to_compile">min_count_to_compile</h3>
<p>How many times to potentially use a compiled chunk of code before running compilation. By default, 3.
If the value is zero, then compilation runs synchronously and the query waits for the end of the compilation process before continuing execution. This can be used for testing; otherwise, use values ​​starting with 1. Compilation normally takes about 5-10 seconds.
If the value is 1 or more, compilation occurs asynchronously in a separate thread. The result will be used as soon as it is ready, including by queries that are currently running.</p>
<p>Compiled code is required for each different combination of aggregate functions used in the query and the type of keys in the GROUP BY clause.
The results of compilation are saved in the build directory in the form of .so files. There is no restriction on the number of compilation results, since they don't use very much space. Old results will be used after server restarts, except in the case of a server upgrade – in this case, the old results are deleted.</p>
<h3 id="input_format_skip_unknown_fields">input_format_skip_unknown_fields</h3>
<p>If the value is true, running INSERT skips input data from columns with unknown names. Otherwise, this situation will generate an exception.
It works for JSONEachRow and TSKV formats.</p>
<h3 id="output_format_json_quote_64bit_integers">output_format_json_quote_64bit_integers</h3>
<p>If the value is true, integers appear in quotes when using JSON* Int64 and UInt64 formats  (for compatibility with most JavaScript implementations); otherwise, integers are output without the quotes.</p>
<p><a name="format_csv_delimiter"></a></p>
<h3 id="format_csv_delimiter">format_csv_delimiter</h3>
<p>The character to be considered as a delimiter in CSV data. By default, <code>,</code>.</p>
<h2 id="settings-profiles">Settings profiles</h2>
<p>A settings profile is a collection of settings grouped under the same name. Each ClickHouse user has a profile.
To apply all the settings in a profile, set <code>profile</code>.</p>
<p>Example:</p>
<p>Setting <code>web</code> profile.</p>
<div class="codehilite"><pre><span></span><span class="k">SET</span> <span class="n">profile</span> <span class="o">=</span> <span class="s1">&#39;web&#39;</span>
</pre></div>


<p>Settings profiles are declared in the user config file. This is usually <code>users.xml</code>.</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="c">&lt;!-- Settings profiles --&gt;</span>
<span class="nt">&lt;profiles&gt;</span>
    <span class="c">&lt;!-- Default settings --&gt;</span>
    <span class="nt">&lt;default&gt;</span>
        <span class="c">&lt;!-- The maximum number of threads when running a single query. --&gt;</span>
        <span class="nt">&lt;max_threads&gt;</span>8<span class="nt">&lt;/max_threads&gt;</span>
    <span class="nt">&lt;/default&gt;</span>

    <span class="c">&lt;!-- Settings for quries from the user interface --&gt;</span>
    <span class="nt">&lt;web&gt;</span>
        <span class="nt">&lt;max_rows_to_read&gt;</span>1000000000<span class="nt">&lt;/max_rows_to_read&gt;</span>
        <span class="nt">&lt;max_bytes_to_read&gt;</span>100000000000<span class="nt">&lt;/max_bytes_to_read&gt;</span>

        <span class="nt">&lt;max_rows_to_group_by&gt;</span>1000000<span class="nt">&lt;/max_rows_to_group_by&gt;</span>
        <span class="nt">&lt;group_by_overflow_mode&gt;</span>any<span class="nt">&lt;/group_by_overflow_mode&gt;</span>

        <span class="nt">&lt;max_rows_to_sort&gt;</span>1000000<span class="nt">&lt;/max_rows_to_sort&gt;</span>
        <span class="nt">&lt;max_bytes_to_sort&gt;</span>1000000000<span class="nt">&lt;/max_bytes_to_sort&gt;</span>

        <span class="nt">&lt;max_result_rows&gt;</span>100000<span class="nt">&lt;/max_result_rows&gt;</span>
        <span class="nt">&lt;max_result_bytes&gt;</span>100000000<span class="nt">&lt;/max_result_bytes&gt;</span>
        <span class="nt">&lt;result_overflow_mode&gt;</span>break<span class="nt">&lt;/result_overflow_mode&gt;</span>

        <span class="nt">&lt;max_execution_time&gt;</span>600<span class="nt">&lt;/max_execution_time&gt;</span>
        <span class="nt">&lt;min_execution_speed&gt;</span>1000000<span class="nt">&lt;/min_execution_speed&gt;</span>
        <span class="nt">&lt;timeout_before_checking_execution_speed&gt;</span>15<span class="nt">&lt;/timeout_before_checking_execution_speed&gt;</span>

        <span class="nt">&lt;max_columns_to_read&gt;</span>25<span class="nt">&lt;/max_columns_to_read&gt;</span>
        <span class="nt">&lt;max_temporary_columns&gt;</span>100<span class="nt">&lt;/max_temporary_columns&gt;</span>
        <span class="nt">&lt;max_temporary_non_const_columns&gt;</span>50<span class="nt">&lt;/max_temporary_non_const_columns&gt;</span>

        <span class="nt">&lt;max_subquery_depth&gt;</span>2<span class="nt">&lt;/max_subquery_depth&gt;</span>
        <span class="nt">&lt;max_pipeline_depth&gt;</span>25<span class="nt">&lt;/max_pipeline_depth&gt;</span>
        <span class="nt">&lt;max_ast_depth&gt;</span>50<span class="nt">&lt;/max_ast_depth&gt;</span>
        <span class="nt">&lt;max_ast_elements&gt;</span>100<span class="nt">&lt;/max_ast_elements&gt;</span>

        <span class="nt">&lt;readonly&gt;</span>1<span class="nt">&lt;/readonly&gt;</span>
    <span class="nt">&lt;/web&gt;</span>
<span class="nt">&lt;/profiles&gt;</span>
</pre></div>


<p>The example specifies two profiles: <code>default</code>  and <code>web</code>. The <code>default</code> profile has a special purpose: it must always be present and is applied when starting the server. In other words, the <code>default</code> profile contains default settings. The <code>web</code> profile is a regular profile that can be set using the <code>SET</code> query or using a URL parameter in an HTTP query.</p>
<p>Settings profiles can inherit from each other. To use inheritance, indicate the <code>profile</code> setting before the other settings that are listed in the profile.</p>
<h2 id="clickhouse-utility">ClickHouse utility</h2>
<ul>
<li><a href="#utils-clickhouse-local">clickhouse-local</a> — Allows running SQL queries on data without stopping the ClickHouse server, similar to how <code>awk</code> does this.</li>
<li><a href="#utils-clickhouse-copier">clickhouse-copier</a> — Copies (and reshards) data from one cluster to another cluster.</li>
</ul>
<p><a name="utils-clickhouse-copier"></a></p>
<h2 id="clickhouse-copier">clickhouse-copier</h2>
<p>Copies data from the tables in one cluster to tables in another (or the same) cluster.</p>
<p>You can run multiple <code>clickhouse-copier</code> instances on different servers to perform the same job. ZooKeeper is used for syncing the processes.</p>
<p>After starting, <code>clickhouse-copier</code>:</p>
<ul>
<li>Connects to ZooKeeper and receives:</li>
<li>Copying jobs.</li>
<li>
<p>The state of the copying jobs.</p>
</li>
<li>
<p>It performs the jobs.</p>
</li>
</ul>
<p>Each running process chooses the "closest" shard of the source cluster and copies the data into the destination cluster, resharding the data if necessary.</p>
<p><code>clickhouse-copier</code> tracks the changes in ZooKeeper and applies them on the fly.</p>
<p>To reduce network traffic, we recommend running <code>clickhouse-copier</code> on the same server where the source data is located.</p>
<h3 id="running-clickhouse-copier">Running clickhouse-copier</h3>
<p>The utility should be run manually:</p>
<div class="codehilite"><pre><span></span>clickhouse-copier copier --daemon --config zookeeper.xml --task-path /task/path --base-dir /path/to/dir
</pre></div>


<p>Parameters:</p>
<ul>
<li><code>daemon</code> — Starts <code>clickhouse-copier</code> in daemon mode.</li>
<li><code>config</code> — The path to the <code>zookeeper.xml</code> file with the parameters for the connection to ZooKeeper.</li>
<li><code>task-path</code> — The path to the ZooKeeper node. This node is used for syncing <code>clickhouse-copier</code> processes and storing tasks. Tasks are stored in <code>$task-path/description</code>.</li>
<li><code>base-dir</code> — The path to logs and auxiliary files. When it starts, <code>clickhouse-copier</code> creates <code>clickhouse-copier_YYYYMMHHSS_&lt;PID&gt;</code> subdirectories in <code>$base-dir</code>. If this parameter is omitted, the directories are created in the directory where <code>clickhouse-copier</code> was launched.</li>
</ul>
<h3 id="format-of-zookeeperxml">Format of zookeeper.xml</h3>
<div class="codehilite"><pre><span></span><span class="nt">&lt;yandex&gt;</span>
    <span class="nt">&lt;zookeeper&gt;</span>
        <span class="nt">&lt;node</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;host&gt;</span>127.0.0.1<span class="nt">&lt;/host&gt;</span>
            <span class="nt">&lt;port&gt;</span>2181<span class="nt">&lt;/port&gt;</span>
        <span class="nt">&lt;/node&gt;</span>
    <span class="nt">&lt;/zookeeper&gt;</span>
<span class="nt">&lt;/yandex&gt;</span>
</pre></div>


<h3 id="configuration-of-copying-tasks">Configuration of copying tasks</h3>
<div class="codehilite"><pre><span></span><span class="nt">&lt;yandex&gt;</span>
    <span class="c">&lt;!-- Configuration of clusters as in an ordinary server config --&gt;</span>
    <span class="nt">&lt;remote_servers&gt;</span>
        <span class="nt">&lt;source_cluster&gt;</span>
            <span class="nt">&lt;shard&gt;</span>
                <span class="nt">&lt;internal_replication&gt;</span>false<span class="nt">&lt;/internal_replication&gt;</span>
                    <span class="nt">&lt;replica&gt;</span>
                        <span class="nt">&lt;host&gt;</span>127.0.0.1<span class="nt">&lt;/host&gt;</span>
                        <span class="nt">&lt;port&gt;</span>9000<span class="nt">&lt;/port&gt;</span>
                    <span class="nt">&lt;/replica&gt;</span>
            <span class="nt">&lt;/shard&gt;</span>
            ...
        <span class="nt">&lt;/source_cluster&gt;</span>

        <span class="nt">&lt;destination_cluster&gt;</span>
        ...
        <span class="nt">&lt;/destination_cluster&gt;</span>
    <span class="nt">&lt;/remote_servers&gt;</span>

    <span class="c">&lt;!-- How many simultaneously active workers are possible. If you run more workers superfluous workers will sleep. --&gt;</span>
    <span class="nt">&lt;max_workers&gt;</span>2<span class="nt">&lt;/max_workers&gt;</span>

    <span class="c">&lt;!-- Setting used to fetch (pull) data from source cluster tables --&gt;</span>
    <span class="nt">&lt;settings_pull&gt;</span>
        <span class="nt">&lt;readonly&gt;</span>1<span class="nt">&lt;/readonly&gt;</span>
    <span class="nt">&lt;/settings_pull&gt;</span>

    <span class="c">&lt;!-- Setting used to insert (push) data to destination cluster tables --&gt;</span>
    <span class="nt">&lt;settings_push&gt;</span>
        <span class="nt">&lt;readonly&gt;</span>0<span class="nt">&lt;/readonly&gt;</span>
    <span class="nt">&lt;/settings_push&gt;</span>

    <span class="c">&lt;!-- Common setting for fetch (pull) and insert (push) operations. The copier process context also uses it.</span>
<span class="c">         They are overlaid by &lt;settings_pull/&gt; and &lt;settings_push/&gt; respectively. --&gt;</span>
    <span class="nt">&lt;settings&gt;</span>
        <span class="nt">&lt;connect_timeout&gt;</span>3<span class="nt">&lt;/connect_timeout&gt;</span>
        <span class="c">&lt;!-- Sync insert is set forcibly, leave it here just in case. --&gt;</span>
        <span class="nt">&lt;insert_distributed_sync&gt;</span>1<span class="nt">&lt;/insert_distributed_sync&gt;</span>
    <span class="nt">&lt;/settings&gt;</span>

    <span class="c">&lt;!-- Copying description of tasks.</span>
<span class="c">         You can specify several table tasks in the same task description (in the same ZooKeeper node), and they will be performed         sequentially.</span>
<span class="c">    --&gt;</span>
    <span class="nt">&lt;tables&gt;</span>
        <span class="c">&lt;!-- A table task that copies one table. --&gt;</span>
        <span class="nt">&lt;table_hits&gt;</span>
            <span class="c">&lt;!-- Source cluster name (from the &lt;remote_servers/&gt; section) and tables in it that should be copied --&gt;</span>
            <span class="nt">&lt;cluster_pull&gt;</span>source_cluster<span class="nt">&lt;/cluster_pull&gt;</span>
            <span class="nt">&lt;database_pull&gt;</span>test<span class="nt">&lt;/database_pull&gt;</span>
            <span class="nt">&lt;table_pull&gt;</span>hits<span class="nt">&lt;/table_pull&gt;</span>

            <span class="c">&lt;!-- Destination cluster name and tables in which the data should be inserted --&gt;</span>
            <span class="nt">&lt;cluster_push&gt;</span>destination_cluster<span class="nt">&lt;/cluster_push&gt;</span>
            <span class="nt">&lt;database_push&gt;</span>test<span class="nt">&lt;/database_push&gt;</span>
            <span class="nt">&lt;table_push&gt;</span>hits2<span class="nt">&lt;/table_push&gt;</span>

            <span class="c">&lt;!-- Engine of destination tables.</span>
<span class="c">                 If the destination tables have not been created yet, workers create them using column definitions from source tables and the engine                 definition from here.</span>

<span class="c">                 NOTE: If the first worker starts to insert data and detects that the destination partition is not empty, then the partition will</span>
<span class="c">                 be dropped and refilled. Take this into account if you already have some data in destination tables. You can directly </span>
<span class="c">                 specify partitions that should be copied in &lt;enabled_partitions/&gt;. They should be in quoted format like the partition column in the                 </span>
<span class="c">                 system.parts table.</span>
<span class="c">            --&gt;</span>
            <span class="nt">&lt;engine&gt;</span>
            ENGINE=ReplicatedMergeTree(&#39;/clickhouse/tables/{cluster}/{shard}/hits2&#39;, &#39;{replica}&#39;)
            PARTITION BY toMonday(date)
            ORDER BY (CounterID, EventDate)
            <span class="nt">&lt;/engine&gt;</span>

            <span class="c">&lt;!-- Sharding key used to insert data to destination cluster --&gt;</span>
            <span class="nt">&lt;sharding_key&gt;</span>jumpConsistentHash(intHash64(UserID), 2)<span class="nt">&lt;/sharding_key&gt;</span>

            <span class="c">&lt;!-- Optional expression that filter data while pull them from source servers --&gt;</span>
            <span class="nt">&lt;where_condition&gt;</span>CounterID != 0<span class="nt">&lt;/where_condition&gt;</span>

            <span class="c">&lt;!-- This section specifies partitions that should be copied, other partition will be ignored.</span>
<span class="c">                 Partition names should have the same format as</span>
<span class="c">                 partition column of system.parts table (i.e. a quoted text).</span>
<span class="c">                 Since partition key of source and destination cluster could be different,</span>
<span class="c">                 these partition names specify destination partitions.</span>

<span class="c">                 Note: Although this section is optional (if it omitted, all partitions will be copied), </span>
<span class="c">                 it is strongly recommended to specify the partitions explicitly.</span>
<span class="c">                 If you already have some partitions ready on the destination cluster, they                 </span>
<span class="c">                 will be removed at the start of the copying, because they will be interpreted                 </span>
<span class="c">                 as unfinished data from the previous copying.</span>
<span class="c">            --&gt;</span>
            <span class="nt">&lt;enabled_partitions&gt;</span>
                <span class="nt">&lt;partition&gt;</span>&#39;2018-02-26&#39;<span class="nt">&lt;/partition&gt;</span>
                <span class="nt">&lt;partition&gt;</span>&#39;2018-03-05&#39;<span class="nt">&lt;/partition&gt;</span>
                ...
            <span class="nt">&lt;/enabled_partitions&gt;</span>
        <span class="nt">&lt;/table_hits&gt;</span>

        <span class="c">&lt;!-- Next table to copy. It is not copied until the previous table is copying. --&gt;</span>
        <span class="nt">&lt;/table_visits&gt;</span>
        ...
        <span class="nt">&lt;/table_visits&gt;</span>
        ...
    <span class="nt">&lt;/tables&gt;</span>
<span class="nt">&lt;/yandex&gt;</span>
</pre></div>


<p><code>clickhouse-copier</code> tracks the changes in <code>/task/path/description</code> and applies them on the fly. For instance, if you change the value of <code>max_workers</code>, the number of processes running tasks will also change.</p>
<p><a name="utils-clickhouse-local"></a></p>
<h2 id="clickhouse-local">clickhouse-local</h2>
<p>The <code>clickhouse-local</code>  program enables you to perform fast processing on local files that store tables, without having to deploy and configure the ClickHouse server.</p>
<h2 id="clickhouse-development">ClickHouse Development</h2>
<h2 id="overview-of-clickhouse-architecture">Overview of ClickHouse architecture</h2>
<p>ClickHouse is a true column-oriented DBMS. Data is stored by columns, and during the execution of arrays (vectors or chunks of columns). Whenever possible, operations are dispatched on arrays, rather than on individual values. This is called "vectorized query execution," and it helps lower the cost of actual data processing.</p>
<blockquote>
<p>This idea is nothing new. It dates back to the <code>APL</code> programming language and its descendants: <code>A +</code>, <code>J</code>, <code>K</code>, and <code>Q</code>. Array programming is used in scientific data processing. Neither is this idea something new in relational databases: for example, it is used in the <code>Vectorwise</code> system.</p>
</blockquote>
<p>There are two different approaches for speeding up the query processing: vectorized query execution and runtime code generation. In the latter, the code is generated for every kind of query on the fly, removing all indirection and dynamic dispatch. Neither of these approaches is strictly better than the other. Runtime code generation can be better when it's fuses many operations together, thus fully utilizing CPU execution units and the pipeline. Vectorized query execution can be less practical, because it involves the temporary vectors that must be written to the cache and read back. If the temporary data does not fit in the L2 cache, this becomes an issue. But vectorized query execution more easily utilizes the SIMD capabilities of the CPU. A <a href="http://15721.courses.cs.cmu.edu/spring2016/papers/p5-sompolski.pdf">research paper</a> written by our friends shows that it is better to combine both approaches. ClickHouse uses vectorized query execution and has limited initial support for runtime code.</p>
<h3 id="columns">Columns</h3>
<p>To represent columns in memory (actually, chunks of columns), the <code>IColumn</code> interface is used. This interface provides helper methods for implementation of various relational operators. Almost all operations are immutable: they do not modify the original column, but create a new modified one. For example, the <code>IColumn :: filter</code> method accepts a filter byte mask. It is used for the <code>WHERE</code> and <code>HAVING</code> relational operators. Additional examples: the <code>IColumn :: permute</code> method to support <code>ORDER BY</code>, the <code>IColumn :: cut</code> method to support <code>LIMIT</code>, and so on.</p>
<p>Various <code>IColumn</code> implementations (<code>ColumnUInt8</code>, <code>ColumnString</code> and so on) are responsible for the memory layout of columns. Memory layout is usually a contiguous array. For the integer type of columns it is just one contiguous array, like <code>std :: vector</code>. For <code>String</code> and <code>Array</code> columns, it is two vectors: one for all array elements, placed contiguously, and a second one for offsets to the beginning of each array. There is also <code>ColumnConst</code> that stores just one value in memory, but looks like a column.</p>
<h3 id="field">Field</h3>
<p>Nevertheless, it is possible to work with individual values as well. To represent an individual value, the <code>Field</code> is used. <code>Field</code> is just a discriminated union of <code>UInt64</code>, <code>Int64</code>, <code>Float64</code>, <code>String</code> and <code>Array</code>. <code>IColumn</code> has the <code>operator[]</code> method to get the n-th value as a <code>Field</code>, and the <code>insert</code> method to append a <code>Field</code> to the end of a column. These methods are not very efficient, because they require dealing with temporary <code>Field</code> objects representing an individual value. There are more efficient methods, such as <code>insertFrom</code>, <code>insertRangeFrom</code>, and so on.</p>
<p><code>Field</code> doesn't have enough information about a specific data type for a table. For example, <code>UInt8</code>, <code>UInt16</code>, <code>UInt32</code>, and <code>UInt64</code> are all represented as <code>UInt64</code> in a <code>Field</code>.</p>
<h3 id="leaky-abstractions">Leaky abstractions</h3>
<p><code>IColumn</code> has methods for common relational transformations of data, but they don't meet all needs. For example, <code>ColumnUInt64</code> doesn't have a method to calculate the sum of two columns, and <code>ColumnString</code> doesn't have a method to run a substring search. These countless routines are implemented outside of <code>IColumn</code>.</p>
<p>Various functions on columns can be implemented in a generic, non-efficient way using <code>IColumn</code> methods to extract <code>Field</code> values, or in a specialized way using knowledge of inner memory layout of data in a specific <code>IColumn</code> implementation. To do this, functions are cast to a specific <code>IColumn</code> type and deal with internal representation directly. For example, <code>ColumnUInt64</code> has the <code>getData</code> method that returns a reference to an internal array, then a separate routine reads or fills that array directly. In fact, we have "leaky abstractions" to allow efficient specializations of various routines.</p>
<h3 id="data-types_1">Data types</h3>
<p><code>IDataType</code> is responsible for serialization and deserialization: for reading and writing chunks of columns or individual values in binary or text form.
<code>IDataType</code> directly corresponds to data types in tables. For example, there are <code>DataTypeUInt32</code>, <code>DataTypeDateTime</code>, <code>DataTypeString</code> and so on.</p>
<p><code>IDataType</code> and <code>IColumn</code> are only loosely related to each other. Different data types can be represented in memory by the same <code>IColumn</code> implementations. For example, <code>DataTypeUInt32</code> and <code>DataTypeDateTime</code> are both represented by <code>ColumnUInt32</code> or <code>ColumnConstUInt32</code>. In addition, the same data type can be represented by different <code>IColumn</code> implementations. For example, <code>DataTypeUInt8</code> can be represented by <code>ColumnUInt8</code> or <code>ColumnConstUInt8</code>.</p>
<p><code>IDataType</code> only stores metadata. For instance, <code>DataTypeUInt8</code> doesn't store anything at all (except vptr) and <code>DataTypeFixedString</code> stores just <code>N</code> (the size of fixed-size strings).</p>
<p><code>IDataType</code> has helper methods for various data formats. Examples are methods to serialize a value with possible quoting, to serialize a value for JSON, and to serialize a value as part of XML format. There is no direct correspondence to data formats. For example, the different data formats <code>Pretty</code> and <code>TabSeparated</code> can use the same <code>serializeTextEscaped</code> helper method from the <code>IDataType</code> interface.</p>
<h3 id="block">Block</h3>
<p>A <code>Block</code> is a container that represents a subset (chunk) of a table in memory. It is just a set of triples: <code>(IColumn, IDataType, column name)</code>. During query execution, data is processed by <code>Block</code>s. If we have a <code>Block</code>, we have data (in the <code>IColumn</code> object), we have information about its type (in <code>IDataType</code>) that tells us how to deal with that column, and we have the column name (either the original column name from the table, or some artificial name assigned for getting temporary results of calculations).</p>
<p>When we calculate some function over columns in a block, we add another column with its result to the block, and we don't touch columns for arguments of the function because operations are immutable. Later, unneeded columns can be removed from the block, but not modified. This is convenient for elimination of common subexpressions.</p>
<p>Blocks are created for every processed chunk of data. Note that for the same type of calculation, the column names and types remain the same for different blocks, and only column data changes. It is better to split block data from the block header, because small block sizes will have a high overhead of temporary strings for copying shared_ptrs and column names.</p>
<h3 id="block-streams">Block Streams</h3>
<p>Block streams are for processing data. We use streams of blocks to read data from somewhere, perform data transformations, or write data to somewhere. <code>IBlockInputStream</code> has the <code>read</code> method to fetch the next block while available. <code>IBlockOutputStream</code> has the <code>write</code> method to push the block somewhere.</p>
<p>Streams are responsible for:</p>
<ol>
<li>Reading or writing to a table. The table just returns a stream for reading or writing blocks.</li>
<li>Implementing data formats. For example, if you want to output data to a terminal in <code>Pretty</code> format, you create a block output stream where you push blocks, and it formats them.</li>
<li>Performing data transformations. Let's say you have <code>IBlockInputStream</code> and want to create a filtered stream. You create <code>FilterBlockInputStream</code> and initialize it with your stream. Then when you pull a block from <code>FilterBlockInputStream</code>, it pulls a block from your stream, filters it, and returns the filtered block to you. Query execution pipelines are represented this way.</li>
</ol>
<p>There are more sophisticated transformations. For example, when you pull from <code>AggregatingBlockInputStream</code>, it reads all data from its source, aggregates it, and then returns a stream of aggregated data for you. Another example: <code>UnionBlockInputStream</code> accepts many input sources in the constructor and also a number of threads. It launches multiple threads and reads from multiple sources in parallel.</p>
<blockquote>
<p>Block streams use the "pull" approach to control flow: when you pull a block from the first stream, it consequently pulls the required blocks from nested streams, and the entire execution pipeline will work. Neither "pull" nor "push" is the best solution, because control flow is implicit, and that limits implementation of various features like simultaneous execution of multiple queries (merging many pipelines together). This limitation could be overcome with coroutines or just running extra threads that wait for each other. We may have more possibilities if we make control flow explicit: if we locate the logic for passing data from one calculation unit to another outside of those calculation units. Read this <a href="http://journal.stuffwithstuff.com/2013/01/13/iteration-inside-and-out/">article</a> for more thoughts.</p>
</blockquote>
<p>We should note that the query execution pipeline creates temporary data at each step. We try to keep block size small enough so that temporary data fits in the CPU cache. With that assumption, writing and reading temporary data is almost free in comparison with other calculations. We could consider an alternative, which is to fuse many operations in the pipeline together, to make the pipeline as short as possible and remove much of the temporary data. This could be an advantage, but it also has drawbacks. For example, a split pipeline makes it easy to implement caching intermediate data, stealing intermediate data from similar queries running at the same time, and merging pipelines for similar queries.</p>
<h3 id="formats_1">Formats</h3>
<p>Data formats are implemented with block streams. There are "presentational" formats only suitable for output of data to the client, such as <code>Pretty</code> format, which provides only <code>IBlockOutputStream</code>. And there are input/output formats, such as <code>TabSeparated</code> or <code>JSONEachRow</code>.</p>
<p>There are also row streams: <code>IRowInputStream</code> and <code>IRowOutputStream</code>. They allow you to pull/push data by individual rows, not by blocks. And they are only needed to simplify implementation of row-oriented formats. The wrappers <code>BlockInputStreamFromRowInputStream</code> and <code>BlockOutputStreamFromRowOutputStream</code> allow you to convert row-oriented streams to regular block-oriented streams.</p>
<h3 id="io">I/O</h3>
<p>For byte-oriented input/output, there are <code>ReadBuffer</code> and <code>WriteBuffer</code> abstract classes. They are used instead of C++ <code>iostream</code>'s. Don't worry: every mature C++ project is using something other than <code>iostream</code>'s for good reasons.</p>
<p><code>ReadBuffer</code> and <code>WriteBuffer</code> are just a contiguous buffer and a cursor pointing to the position in that buffer. Implementations may own or not own the memory for the buffer. There is a virtual method to fill the buffer with the following data (for <code>ReadBuffer</code>) or to flush the buffer somewhere (for <code>WriteBuffer</code>). The virtual methods are rarely called.</p>
<p>Implementations of <code>ReadBuffer</code>/<code>WriteBuffer</code> are used for working with files and file descriptors and network sockets, for implementing compression (<code>CompressedWriteBuffer</code> is initialized with another WriteBuffer and performs compression before writing data to it), and for other purposes – the names <code>ConcatReadBuffer</code>, <code>LimitReadBuffer</code>, and <code>HashingWriteBuffer</code> speak for themselves.</p>
<p>Read/WriteBuffers only deal with bytes. To help with formatted input/output (for instance, to write a number in decimal format), there are functions from <code>ReadHelpers</code> and <code>WriteHelpers</code> header files.</p>
<p>Let's look at what happens when you want to write a result set in <code>JSON</code> format to stdout. You have a result set ready to be fetched from <code>IBlockInputStream</code>. You create <code>WriteBufferFromFileDescriptor(STDOUT_FILENO)</code> to write bytes to stdout. You create <code>JSONRowOutputStream</code>, initialized with that <code>WriteBuffer</code>, to write rows in <code>JSON</code> to stdout. You create <code>BlockOutputStreamFromRowOutputStream</code> on top of it, to represent it as <code>IBlockOutputStream</code>. Then you call <code>copyData</code> to transfer data from <code>IBlockInputStream</code> to <code>IBlockOutputStream</code>, and everything works. Internally, <code>JSONRowOutputStream</code> will write various JSON delimiters and call the <code>IDataType::serializeTextJSON</code> method with a reference to <code>IColumn</code> and the row number as arguments. Consequently, <code>IDataType::serializeTextJSON</code> will call a method from <code>WriteHelpers.h</code>: for example, <code>writeText</code> for numeric types and <code>writeJSONString</code> for <code>DataTypeString</code>.</p>
<h3 id="tables">Tables</h3>
<p>Tables are represented by the <code>IStorage</code> interface. Different implementations of that interface are different table engines. Examples are <code>StorageMergeTree</code>, <code>StorageMemory</code>, and so on. Instances of these classes are just tables.</p>
<p>The most important <code>IStorage</code> methods are <code>read</code> and <code>write</code>. There are also <code>alter</code>, <code>rename</code>, <code>drop</code>, and so on. The <code>read</code> method accepts the following arguments: the set of columns to read from a table, the <code>AST</code> query to consider, and the desired number of streams to return. It returns one or multiple <code>IBlockInputStream</code> objects and information about the stage of data processing that was completed inside a table engine during query execution.</p>
<p>In most cases, the read method is only responsible for reading the specified columns from a table, not for any further data processing. All further data processing is done by the query interpreter and is outside the responsibility of <code>IStorage</code>.</p>
<p>But there are notable exceptions:</p>
<ul>
<li>The AST query is passed to the <code>read</code> method and the table engine can use it to derive index usage and to read less data from a table.</li>
<li>Sometimes the table engine can process data itself to a specific stage. For example, <code>StorageDistributed</code> can send a query to remote servers, ask them to process data to a stage where data from different remote servers can be merged, and return that preprocessed data.
The query interpreter then finishes processing the data.</li>
</ul>
<p>The table's <code>read</code> method can return multiple <code>IBlockInputStream</code> objects to allow parallel data processing. These multiple block input streams can read from a table in parallel. Then you can wrap these streams with various transformations (such as expression evaluation or filtering) that can be calculated independently and create a <code>UnionBlockInputStream</code> on top of them, to read from multiple streams in parallel.</p>
<p>There are also <code>TableFunction</code>s. These are functions that return a temporary <code>IStorage</code> object to use in the <code>FROM</code> clause of a query.</p>
<p>To get a quick idea of how to implement your own table engine, look at something simple, like <code>StorageMemory</code> or <code>StorageTinyLog</code>.</p>
<blockquote>
<p>As the result of the <code>read</code> method, <code>IStorage</code> returns <code>QueryProcessingStage</code> – information about what parts of the query were already calculated inside storage. Currently we have only very coarse granularity for that information. There is no way for the storage to say "I have already processed this part of the expression in WHERE, for this range of data". We need to work on that.</p>
</blockquote>
<h3 id="parsers">Parsers</h3>
<p>A query is parsed by a hand-written recursive descent parser. For example, <code>ParserSelectQuery</code> just recursively calls the underlying parsers for various parts of the query. Parsers create an <code>AST</code>. The <code>AST</code> is represented by nodes, which are instances of <code>IAST</code>.</p>
<blockquote>
<p>Parser generators are not used for historical reasons.</p>
</blockquote>
<h3 id="interpreters">Interpreters</h3>
<p>Interpreters are responsible for creating the query execution pipeline from an <code>AST</code>. There are simple interpreters, such as <code>InterpreterExistsQuery</code>and <code>InterpreterDropQuery</code>, or the more sophisticated <code>InterpreterSelectQuery</code>. The query execution pipeline is a combination of block input or output streams. For example, the result of interpreting the <code>SELECT</code> query is the <code>IBlockInputStream</code> to read the result set from; the result of the INSERT query is the <code>IBlockOutputStream</code> to write data for insertion to; and the result of interpreting the <code>INSERT SELECT</code> query is the <code>IBlockInputStream</code> that returns an empty result set on the first read, but that copies data from <code>SELECT</code> to <code>INSERT</code> at the same time.</p>
<p><code>InterpreterSelectQuery</code> uses <code>ExpressionAnalyzer</code> and <code>ExpressionActions</code> machinery for query analysis and transformations. This is where most rule-based query optimizations are done. <code>ExpressionAnalyzer</code> is quite messy and should be rewritten: various query transformations and optimizations should be extracted to separate classes to allow modular transformations or query.</p>
<h3 id="functions_2">Functions</h3>
<p>There are ordinary functions and aggregate functions. For aggregate functions, see the next section.</p>
<p>Ordinary functions don't change the number of rows – they work as if they are processing each row independently. In fact, functions are not called for individual rows, but for <code>Block</code>'s of data to implement vectorized query execution.</p>
<p>There are some miscellaneous functions, like <code>blockSize</code>, <code>rowNumberInBlock</code>, and <code>runningAccumulate</code>, that exploit block processing and violate the independence of rows.</p>
<p>ClickHouse has strong typing, so implicit type conversion doesn't occur. If a function doesn't support a specific combination of types, an exception will be thrown. But functions can work (be overloaded) for many different combinations of types. For example, the <code>plus</code> function (to implement the <code>+</code> operator) works for any combination of numeric types: <code>UInt8</code> + <code>Float32</code>, <code>UInt16</code> + <code>Int8</code>, and so on. Also, some variadic functions can accept any number of arguments, such as the <code>concat</code> function.</p>
<p>Implementing a function may be slightly inconvenient because a function explicitly dispatches supported data types and supported <code>IColumns</code>. For example, the <code>plus</code> function has code generated by instantiation of a C++ template for each combination of numeric types, and for constant or non-constant left and right arguments.</p>
<blockquote>
<p>This is a nice place to implement runtime code generation to avoid template code bloat. Also, it will make it possible to add fused functions like fused multiply-add, or to make multiple comparisons in one loop iteration.</p>
</blockquote>
<p>Due to vectorized query execution, functions are not short-circuit. For example, if you write <code>WHERE f(x) AND g(y)</code>, both sides will be calculated, even for rows, when <code>f(x)</code> is zero (except when <code>f(x)</code> is a zero constant expression). But if selectivity of the <code>f(x)</code> condition is high, and calculation of <code>f(x)</code> is much cheaper than <code>g(y)</code>, it's better to implement multi-pass calculation: first calculate <code>f(x)</code>, then filter columns by the result, and then calculate <code>g(y)</code> only for smaller, filtered chunks of data.</p>
<h3 id="aggregate-functions_1">Aggregate Functions</h3>
<p>Aggregate functions are stateful functions. They accumulate passed values into some state, and allow you to get results from that state. They are managed with the <code>IAggregateFunction</code> interface. States can be rather simple (the state for <code>AggregateFunctionCount</code> is just a single <code>UInt64</code> value) or quite complex (the state of <code>AggregateFunctionUniqCombined</code> is a combination of a linear array, a hash table and a <code>HyperLogLog</code> probabilistic data structure).</p>
<p>To deal with multiple states while executing a high-cardinality <code>GROUP BY</code> query, states are allocated in <code>Arena</code> (a memory pool), or they could be allocated in any suitable piece of memory. States can have a non-trivial constructor and destructor: for example, complex aggregation states can allocate additional memory themselves. This requires some attention to creating and destroying states and properly passing their ownership, to keep track of who and when will destroy states.</p>
<p>Aggregation states can be serialized and deserialized to pass over the network during distributed query execution or to write them on disk where there is not enough RAM. They can even be stored in a table with the <code>DataTypeAggregateFunction</code> to allow incremental aggregation of data.</p>
<blockquote>
<p>The serialized data format for aggregate function states is not versioned right now. This is ok if aggregate states are only stored temporarily. But we have the <code>AggregatingMergeTree</code> table engine for incremental aggregation, and people are already using it in production. This is why we should add support for backward compatibility when changing the serialized format for any aggregate function in the future.</p>
</blockquote>
<h3 id="server">Server</h3>
<p>The server implements several different interfaces:</p>
<ul>
<li>An HTTP interface for any foreign clients.</li>
<li>A TCP interface for the native ClickHouse client and for cross-server communication during distributed query execution.</li>
<li>An interface for transferring data for replication.</li>
</ul>
<p>Internally, it is just a basic multithreaded server without coroutines, fibers, etc. Since the server is not designed to process a high rate of simple queries but is intended to process a relatively low rate of complex queries, each of them can process a vast amount of data for analytics.</p>
<p>The server initializes the <code>Context</code> class with the necessary environment for query execution: the list of available databases, users and access rights, settings, clusters, the process list, the query log, and so on. This environment is used by interpreters.</p>
<p>We maintain full backward and forward compatibility for the server TCP protocol: old clients can talk to new servers and new clients can talk to old servers. But we don't want to maintain it eternally, and we are removing support for old versions after about one year.</p>
<blockquote>
<p>For all external applications, we recommend using the HTTP interface because it is simple and easy to use. The TCP protocol is more tightly linked to internal data structures: it uses an internal format for passing blocks of data and it uses custom framing for compressed data. We haven't released a C library for that protocol because it requires linking most of the ClickHouse codebase, which is not practical.</p>
</blockquote>
<h3 id="distributed-query-execution">Distributed query execution</h3>
<p>Servers in a cluster setup are mostly independent. You can create a <code>Distributed</code> table on one or all servers in a cluster. The <code>Distributed</code> table does not store data itself – it only provides a "view" to all local tables on multiple nodes of a cluster. When you SELECT from a <code>Distributed</code> table, it rewrites that query, chooses remote nodes according to load balancing settings, and sends the query to them. The <code>Distributed</code> table requests remote servers to process a query just up to a stage where intermediate results from different servers can be merged. Then it receives the intermediate results and merges them. The distributed table tries to distribute as much work as possible to remote servers, and does not send much intermediate data over the network.</p>
<blockquote>
<p>Things become more complicated when you have subqueries in IN or JOIN clauses and each of them uses a <code>Distributed</code> table. We have different strategies for execution of these queries.</p>
</blockquote>
<p>There is no global query plan for distributed query execution. Each node has its own local query plan for its part of the job. We only have simple one-pass distributed query execution: we send queries for remote nodes and then merge the results. But this is not feasible for difficult queries with high cardinality GROUP BYs or with a large amount of temporary data for JOIN: in such cases, we need to "reshuffle" data between servers, which requires additional coordination. ClickHouse does not support that kind of query execution, and we need to work on it.</p>
<h3 id="merge-tree">Merge Tree</h3>
<p><code>MergeTree</code> is a family of storage engines that supports indexing by primary key. The primary key can be an arbitary tuple of columns or expressions. Data in a <code>MergeTree</code> table is stored in "parts". Each part stores data in the primary key order (data is ordered lexicographically by the primary key tuple). All the table columns are stored in separate <code>column.bin</code> files in these parts. The files consist of compressed blocks. Each block is usually from 64 KB to 1 MB of uncompressed data, depending on the average value size. The blocks consist of column values placed contiguously one after the other. Column values are in the same order for each column (the order is defined by the primary key), so when you iterate by many columns, you get values for the corresponding rows.</p>
<p>The primary key itself is "sparse". It doesn't address each single row, but only some ranges of data. A separate <code>primary.idx</code> file has the value of the primary key for each N-th row, where N is called <code>index_granularity</code> (usually, N = 8192). Also, for each column, we have <code>column.mrk</code> files with "marks," which are offsets to each N-th row in the data file. Each mark is a pair: the offset in the file to the beginning of the compressed block, and the offset in the decompressed block to the beginning of data. Usually compressed blocks are aligned by marks, and the offset in the decompressed block is zero. Data for <code>primary.idx</code> always resides in memory and data for <code>column.mrk</code> files is cached.</p>
<p>When we are going to read something from a part in <code>MergeTree</code>, we look at <code>primary.idx</code> data and locate ranges that could possibly contain requested data, then look at <code>column.mrk</code> data and calculate offsets for where to start reading those ranges. Because of sparseness, excess data may be read. ClickHouse is not suitable for a high load of simple point queries, because the entire range with <code>index_granularity</code> rows must be read for each key, and the entire compressed block must be decompressed for each column. We made the index sparse because we must be able to maintain trillions of rows per single server without noticeable memory consumption for the index. Also, because the primary key is sparse, it is not unique: it cannot check the existence of the key in the table at INSERT time. You could have many rows with the same key in a table.</p>
<p>When you <code>INSERT</code> a bunch of data into <code>MergeTree</code>, that bunch is sorted by primary key order and forms a new part. To keep the number of parts relatively low, there are background threads that periodically select some parts and merge them to a single sorted part. That's why it is called <code>MergeTree</code>. Of course, merging leads to "write amplification". All parts are immutable: they are only created and deleted, but not modified. When SELECT is run, it holds a snapshot of the table (a set of parts). After merging, we also keep old parts for some time to make recovery after failure easier, so if we see that some merged part is probably broken, we can replace it with its source parts.</p>
<p><code>MergeTree</code> is not an LSM tree because it doesn't contain "memtable" and "log": inserted data is written directly to the filesystem. This makes it suitable only to INSERT data in batches, not by individual row and not very frequently – about once per second is ok, but a thousand times a second is not. We did it this way for simplicity's sake, and because we are already inserting data in batches in our applications.</p>
<blockquote>
<p>MergeTree tables can only have one (primary) index: there aren't any secondary indices. It would be nice to allow multiple physical representations under one logical table, for example, to store data in more than one physical order or even to allow representations with pre-aggregated data along with original data.</p>
</blockquote>
<p>There are MergeTree engines that are doing additional work during background merges. Examples are <code>CollapsingMergeTree</code> and <code>AggregatingMergeTree</code>. This could be treated as special support for updates. Keep in mind that these are not real updates because users usually have no control over the time when background merges will be executed, and data in a <code>MergeTree</code> table is almost always stored in more than one part, not in completely merged form.</p>
<h3 id="replication">Replication</h3>
<p>Replication in ClickHouse is implemented on a per-table basis. You could have some replicated and some non-replicated tables on the same server. You could also have tables replicated in different ways, such as one table with two-factor replication and another with three-factor.</p>
<p>Replication is implemented in the <code>ReplicatedMergeTree</code> storage engine. The path in <code>ZooKeeper</code> is specified as a parameter for the storage engine. All tables with the same path in <code>ZooKeeper</code> become replicas of each other: they synchronize their data and maintain consistency. Replicas can be added and removed dynamically simply by creating or dropping a table.</p>
<p>Replication uses an asynchronous multi-master scheme. You can insert data into any replica that has a session with <code>ZooKeeper</code>, and data is replicated to all other replicas asynchronously. Because ClickHouse doesn't support UPDATEs, replication is conflict-free. As there is no quorum acknowledgment of inserts, just-inserted data might be lost if one node fails.</p>
<p>Metadata for replication is stored in ZooKeeper. There is a replication log that lists what actions to do. Actions are: get part; merge parts; drop partition, etc. Each replica copies the replication log to its queue and then executes the actions from the queue. For example, on insertion, the "get part" action is created in the log, and every replica downloads that part. Merges are coordinated between replicas to get byte-identical results. All parts are merged in the same way on all replicas. To achieve this, one replica is elected as the leader, and that replica initiates merges and writes "merge parts" actions to the log.</p>
<p>Replication is physical: only compressed parts are transferred between nodes, not queries. To lower the network cost (to avoid network amplification), merges are processed on each replica independently in most cases. Large merged parts are sent over the network only in cases of significant replication lag.</p>
<p>In addition, each replica stores its state in ZooKeeper as the set of parts and its checksums. When the state on the local filesystem diverges from the reference state in ZooKeeper, the replica restores its consistency by downloading missing and broken parts from other replicas. When there is some unexpected or broken data in the local filesystem, ClickHouse does not remove it, but moves it to a separate directory and forgets it.</p>
<blockquote>
<p>The ClickHouse cluster consists of independent shards, and each shard consists of replicas. The cluster is not elastic, so after adding a new shard, data is not rebalanced between shards automatically. Instead, the cluster load will be uneven. This implementation gives you more control, and it is fine for relatively small clusters such as tens of nodes. But for clusters with hundreds of nodes that we are using in production, this approach becomes a significant drawback. We should implement a table engine that will span its data across the cluster with dynamically replicated regions that could be split and balanced between clusters automatically.</p>
</blockquote>
<h2 id="how-to-build-clickhouse-on-linux">How to build ClickHouse on Linux</h2>
<p>Build should work on Linux Ubuntu 12.04, 14.04 or newer.
With appropriate changes, it should also work on any other Linux distribution.
The build process is not intended to work on Mac OS X.
Only x86_64 with SSE 4.2 is supported. Support for AArch64 is experimental.</p>
<p>To test for SSE 4.2, do</p>
<div class="codehilite"><pre><span></span>grep -q sse4_2 /proc/cpuinfo <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;SSE 4.2 supported&quot;</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">&quot;SSE 4.2 not supported&quot;</span>
</pre></div>


<h3 id="install-git-and-cmake">Install Git and CMake</h3>
<div class="codehilite"><pre><span></span>sudo apt-get install git cmake
</pre></div>


<p>Or cmake3 instead of cmake on older systems.</p>
<h3 id="detect-the-number-of-threads">Detect the number of threads</h3>
<div class="codehilite"><pre><span></span><span class="nb">export</span> <span class="nv">THREADS</span><span class="o">=</span><span class="k">$(</span>grep -c ^processor /proc/cpuinfo<span class="k">)</span>
</pre></div>


<h3 id="install-gcc-7">Install GCC 7</h3>
<p>There are several ways to do this.</p>
<h4 id="install-from-a-ppa-package">Install from a PPA package</h4>
<div class="codehilite"><pre><span></span>sudo apt-get install software-properties-common
sudo apt-add-repository ppa:ubuntu-toolchain-r/test
sudo apt-get update
sudo apt-get install gcc-7 g++-7
</pre></div>


<h4 id="install-from-sources">Install from sources</h4>
<p>Look at [https://github.com/yandex/ClickHouse/blob/master/utils/prepare-environment/install-gcc.sh]</p>
<h3 id="use-gcc-7-for-builds">Use GCC 7 for builds</h3>
<div class="codehilite"><pre><span></span><span class="nb">export</span> <span class="nv">CC</span><span class="o">=</span>gcc-7
<span class="nb">export</span> <span class="nv">CXX</span><span class="o">=</span>g++-7
</pre></div>


<h3 id="install-required-libraries-from-packages">Install required libraries from packages</h3>
<div class="codehilite"><pre><span></span>sudo apt-get install libicu-dev libreadline-dev libmysqlclient-dev libssl-dev unixodbc-dev ninja-build
</pre></div>


<h3 id="checkout-clickhouse-sources">Checkout ClickHouse sources</h3>
<p>To get the latest stable version:</p>
<div class="codehilite"><pre><span></span>git clone -b stable --recursive git@github.com:yandex/ClickHouse.git
<span class="c1">## or: git clone -b stable --recursive https://github.com/yandex/ClickHouse.git</span>

<span class="nb">cd</span> ClickHouse
</pre></div>


<p>For development, switch to the <code>master</code> branch.
For the latest release candidate, switch to the <code>testing</code> branch.</p>
<h3 id="build-clickhouse">Build ClickHouse</h3>
<p>There are two build variants.</p>
<h4 id="build-release-package">Build release package</h4>
<p>Install prerequisites to build Debian packages.</p>
<div class="codehilite"><pre><span></span>sudo apt-get install devscripts dupload fakeroot debhelper
</pre></div>


<p>Install the most recent version of Clang.</p>
<p>Clang is embedded into the ClickHouse package and used at runtime. The minimum version is 5.0. It is optional.</p>
<p>To install clang, see <code>utils/prepare-environment/install-clang.sh</code></p>
<p>You may also build ClickHouse with Clang for development purposes.
For production releases, GCC is used.</p>
<p>Run the release script:</p>
<div class="codehilite"><pre><span></span>rm -f ../clickhouse*.deb
./release
</pre></div>


<p>You will find built packages in the parent directory:</p>
<div class="codehilite"><pre><span></span>ls -l ../clickhouse*.deb
</pre></div>


<p>Note that usage of debian packages is not required.
ClickHouse has no runtime dependencies except libc, so it could work on almost any Linux.</p>
<p>Installing freshly built packages on a development server:</p>
<div class="codehilite"><pre><span></span>sudo dpkg -i ../clickhouse*.deb
sudo service clickhouse-server start
</pre></div>


<h4 id="build-to-work-with-code">Build to work with code</h4>
<div class="codehilite"><pre><span></span>mkdir build
<span class="nb">cd</span> build
cmake ..
make -j <span class="nv">$THREADS</span>
<span class="nb">cd</span> ..
</pre></div>


<p>To create an executable, run <code>make clickhouse</code>.
This will create the <code>dbms/src/Server/clickhouse</code> executable, which can be used with <code>client</code> or <code>server</code> arguments.</p>
<h2 id="how-to-build-clickhouse-on-mac-os-x">How to build ClickHouse on Mac OS X</h2>
<p>Build should work on Mac OS X 10.12. If you're using earlier version, you can try to build ClickHouse using Gentoo Prefix and clang sl in this instruction.
With appropriate changes, it should also work on any other Linux distribution.</p>
<h3 id="install-homebrew">Install Homebrew</h3>
<div class="codehilite"><pre><span></span>/usr/bin/ruby -e <span class="s2">&quot;</span><span class="k">$(</span>curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install<span class="k">)</span><span class="s2">&quot;</span>
</pre></div>


<h3 id="install-required-compilers-tools-and-libraries">Install required compilers, tools, and libraries</h3>
<div class="codehilite"><pre><span></span>brew install cmake gcc icu4c mysql openssl unixodbc libtool gettext zlib readline boost --cc<span class="o">=</span>gcc-7
</pre></div>


<h3 id="checkout-clickhouse-sources_1">Checkout ClickHouse sources</h3>
<p>To get the latest stable version:</p>
<div class="codehilite"><pre><span></span>git clone -b stable --recursive --depth<span class="o">=</span><span class="m">10</span> git@github.com:yandex/ClickHouse.git
<span class="c1">## or: git clone -b stable --recursive --depth=10 https://github.com/yandex/ClickHouse.git</span>

<span class="nb">cd</span> ClickHouse
</pre></div>


<p>For development, switch to the <code>master</code> branch.
For the latest release candidate, switch to the <code>testing</code> branch.</p>
<h3 id="build-clickhouse_1">Build ClickHouse</h3>
<div class="codehilite"><pre><span></span>mkdir build
<span class="nb">cd</span> build
cmake .. -DCMAKE_CXX_COMPILER<span class="o">=</span><span class="sb">`</span>which g++-7<span class="sb">`</span> -DCMAKE_C_COMPILER<span class="o">=</span><span class="sb">`</span>which gcc-7<span class="sb">`</span>
make -j <span class="sb">`</span>sysctl -n hw.ncpu<span class="sb">`</span>
<span class="nb">cd</span> ..
</pre></div>


<h3 id="caveats">Caveats</h3>
<p>If you intend to run clickhouse-server, make sure to increase the system's maxfiles variable. See <a href="https://github.com/yandex/ClickHouse/blob/master/MacOS.md">MacOS.md</a> for more details.</p>
<h2 id="how-to-write-c-code">How to write C++ code</h2>
<h3 id="general-recommendations">General recommendations</h3>
<p><strong>1.</strong> The following are recommendations, not requirements.</p>
<p><strong>2.</strong> If you are editing code, it makes sense to follow the formatting of the existing code.</p>
<p><strong>3.</strong> Code style is needed for consistency. Consistency makes it easier to read the code, and it also makes it easier to search the code.</p>
<p><strong>4.</strong> Many of the rules do not have logical reasons; they are dictated by established practices.</p>
<h3 id="formatting">Formatting</h3>
<p><strong>1.</strong> Most of the formatting will be done automatically by <code>clang-format</code>.</p>
<p><strong>2.</strong> Indents are 4 spaces. Configure your development environment so that a tab adds four spaces.</p>
<p><strong>3.</strong> A left curly bracket must be separated on a new line. (And the right one, as well.)</p>
<div class="codehilite"><pre><span></span><span class="kr">inline</span> <span class="kt">void</span> <span class="nf">readBoolText</span><span class="p">(</span><span class="kt">bool</span> <span class="o">&amp;</span> <span class="n">x</span><span class="p">,</span> <span class="n">ReadBuffer</span> <span class="o">&amp;</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">tmp</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
    <span class="n">readChar</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p><strong>4.</strong>
But if the entire function body is quite short (a single statement), you can place it entirely on one line if you wish. Place spaces around curly braces (besides the space at the end of the line).</p>
<div class="codehilite"><pre><span></span><span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">mask</span><span class="p">()</span> <span class="k">const</span>                <span class="p">{</span> <span class="k">return</span> <span class="n">buf_size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
<span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">place</span><span class="p">(</span><span class="n">HashValue</span> <span class="n">x</span><span class="p">)</span> <span class="k">const</span>    <span class="p">{</span> <span class="k">return</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">();</span> <span class="p">}</span>
</pre></div>


<p><strong>5.</strong> For functions, don't put spaces around brackets.</p>
<div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="nf">reinsert</span><span class="p">(</span><span class="k">const</span> <span class="n">Value</span> <span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span>
<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">place_value</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
</pre></div>


<p><strong>6.</strong> When using statements such as <code>if</code>, <code>for</code>, and <code>while</code> (unlike function calls), put a space before the opening bracket.</p>
<p><code>cpp
 for (size_t i = 0; i &lt; rows; i += storage.index_granularity)</code></p>
<p><strong>7.</strong> Put spaces around binary operators (<code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>%</code>, ...), as well as the ternary operator <code>?:</code>.</p>
<div class="codehilite"><pre><span></span><span class="n">UInt16</span> <span class="n">year</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
<span class="n">UInt8</span> <span class="n">month</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
<span class="n">UInt8</span> <span class="n">day</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
</pre></div>


<p><strong>8.</strong> If a line feed is entered, put the operator on a new line and increase the indent before it.</p>
<div class="codehilite"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">elapsed_ns</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; (&quot;</span>
         <span class="o">&lt;&lt;</span> <span class="n">rows_read_on_server</span> <span class="o">*</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">elapsed_ns</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; rows/s., &quot;</span>
        <span class="o">&lt;&lt;</span> <span class="n">bytes_read_on_server</span> <span class="o">*</span> <span class="mf">1000.0</span> <span class="o">/</span> <span class="n">elapsed_ns</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; MB/s.) &quot;</span><span class="p">;</span>
</pre></div>


<p><strong>9.</strong> You can use spaces for alignment within a line, if desired.</p>
<div class="codehilite"><pre><span></span><span class="n">dst</span><span class="p">.</span><span class="n">ClickLogID</span>         <span class="o">=</span> <span class="n">click</span><span class="p">.</span><span class="n">LogID</span><span class="p">;</span>
<span class="n">dst</span><span class="p">.</span><span class="n">ClickEventID</span>       <span class="o">=</span> <span class="n">click</span><span class="p">.</span><span class="n">EventID</span><span class="p">;</span>
<span class="n">dst</span><span class="p">.</span><span class="n">ClickGoodEvent</span>     <span class="o">=</span> <span class="n">click</span><span class="p">.</span><span class="n">GoodEvent</span><span class="p">;</span>
</pre></div>


<p><strong>10.</strong> Don't use spaces around the operators <code>.</code>, <code>-&gt;</code> .</p>
<p>If necessary, the operator can be wrapped to the next line. In this case, the offset in front of it is increased.</p>
<p><strong>11.</strong> Do not use a space to separate unary operators (<code>-</code>, <code>+</code>, <code>*</code>, <code>&amp;</code>, ...) from the argument.</p>
<p><strong>12.</strong> Put a space after a comma, but not before it. The same rule goes for a semicolon inside a for expression.</p>
<p><strong>13.</strong> Do not use spaces to separate the <code>[]</code> operator.</p>
<p><strong>14.</strong> In a <code>template &lt;...&gt;</code> expression, use a space between <code>template</code> and <code>&lt;</code>. No spaces after <code>&lt;</code> or before <code>&gt;</code>.</p>
<div class="codehilite"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">TKey</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TValue</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">AggregatedStatElement</span>
<span class="p">{}</span>
</pre></div>


<p><strong>15.</strong> In classes and structures, public, private, and protected are written on the same level as the <code>class/struct</code>, but all other internal elements should be deeper.</p>
<div class="codehilite"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">MultiVersion</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="c1">/// Version of object for usage. shared_ptr manage lifetime of version.</span>
    <span class="k">using</span> <span class="n">Version</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>


<p><strong>16.</strong> If the same namespace is used for the entire file, and there isn't anything else significant, an offset is not necessary  inside namespace.</p>
<p><strong>17.</strong> If the block for <code>if</code>, <code>for</code>, <code>while</code>... expressions consists of a single statement, you don't need to use curly brackets. Place the statement on a separate line, instead. The same is true for a nested if, for, while... statement. But if the inner statement contains curly brackets or else, the external block should be written in curly brackets.</p>
<div class="codehilite"><pre><span></span><span class="c1">/// Finish write.</span>
<span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span> <span class="nl">stream</span> <span class="p">:</span> <span class="n">streams</span><span class="p">)</span>
    <span class="n">stream</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">finalize</span><span class="p">();</span>
</pre></div>


<p><strong>18.</strong> There should be any spaces at the ends of lines.</p>
<p><strong>19.</strong> Sources are UTF-8 encoded.</p>
<p><strong>20.</strong> Non-ASCII characters can be used in string literals.</p>
<div class="codehilite"><pre><span></span><span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">timer</span><span class="p">.</span><span class="n">elapsed</span><span class="p">()</span> <span class="o">/</span> <span class="n">chunks_stats</span><span class="p">.</span><span class="n">hits</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; μsec/hit.&quot;</span><span class="p">;</span>
</pre></div>


<p><strong>21.</strong> Do not write multiple expressions in a single line.</p>
<p><strong>22.</strong> Group sections of code inside functions and separate them with no more than one empty line.</p>
<p><strong>23.</strong> Separate functions, classes, and so on with one or two empty lines.</p>
<p><strong>24.</strong> A <code>const</code> (related to a value) must be written before the type name.</p>
<div class="codehilite"><pre><span></span><span class="c1">//correct</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">pos</span>
<span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span> <span class="n">s</span>
<span class="c1">//incorrect</span>
<span class="kt">char</span> <span class="k">const</span> <span class="o">*</span> <span class="n">pos</span>
</pre></div>


<p><strong>25.</strong> When declaring a pointer or reference, the <code>*</code> and <code>&amp;</code> symbols should be separated by spaces on both sides.</p>
<div class="codehilite"><pre><span></span><span class="c1">//correct</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">pos</span>
<span class="c1">//incorrect</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pos</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pos</span>
</pre></div>


<p><strong>26.</strong> When using template types, alias them with the <code>using</code> keyword (except in the simplest cases).</p>
<p>In other words, the template parameters are specified only in <code>using</code> and aren't repeated in the code.</p>
<p><code>using</code> can be declared locally, such as inside a function.</p>
<div class="codehilite"><pre><span></span><span class="c1">//correct</span>
<span class="k">using</span> <span class="n">FileStreams</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Stream</span><span class="o">&gt;&gt;</span><span class="p">;</span>
<span class="n">FileStreams</span> <span class="n">streams</span><span class="p">;</span>
<span class="c1">//incorrect</span>
<span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Stream</span><span class="o">&gt;&gt;</span> <span class="n">streams</span><span class="p">;</span>
</pre></div>


<p><strong>27.</strong> Do not declare several variables of different types in one statement.</p>
<div class="codehilite"><pre><span></span><span class="c1">//incorrect</span>
<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">y</span><span class="p">;</span>
</pre></div>


<p><strong>28.</strong> Do not use C-style casts.</p>
<div class="codehilite"><pre><span></span><span class="c1">//incorrect</span>
<span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">c</span> <span class="o">&lt;&lt;</span><span class="p">;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="c1">//correct</span>
<span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</pre></div>


<p><strong>29.</strong> In classes and structs, group members and functions separately inside each visibility scope.</p>
<p><strong>30.</strong> For small classes and structs, it is not necessary to separate the method declaration from the implementation.</p>
<p>The same is true for small methods in any classes or structs.</p>
<p>For templated classes and structs, don't separate the method declarations from the implementation (because otherwise they must be defined in the same translation unit).</p>
<p><strong>31.</strong> You can wrap lines at 140 characters, instead of 80.</p>
<p><strong>32.</strong> Always use the prefix increment/decrement operators if postfix is not required.</p>
<div class="codehilite"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="n">Names</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">column_names</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">column_names</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span>
</pre></div>


<h3 id="comments_1">Comments</h3>
<p><strong>1.</strong> Be sure to add comments for all non-trivial parts of code.</p>
<p>This is very important. Writing the comment might help you realize that the code isn't necessary, or that it is designed wrong.</p>
<div class="codehilite"><pre><span></span><span class="cm">/** Part of piece of memory, that can be used.</span>
<span class="cm">  * For example, if internal_buffer is 1MB, and there was only 10 bytes loaded to buffer from file for reading,</span>
<span class="cm">  * then working_buffer will have size of only 10 bytes</span>
<span class="cm">  * (working_buffer.end() will point to the position right after those 10 bytes available for read).</span>
<span class="cm">*/</span>
</pre></div>


<p><strong>2.</strong> Comments can be as detailed as necessary.</p>
<p><strong>3.</strong> Place comments before the code they describe. In rare cases, comments can come after the code, on the same line.</p>
<div class="codehilite"><pre><span></span><span class="cm">/** Parses and executes the query.</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="n">executeQuery</span><span class="p">(</span>
    <span class="n">ReadBuffer</span> <span class="o">&amp;</span> <span class="n">istr</span><span class="p">,</span> <span class="c1">/// Where to read the query from (and data for INSERT, if applicable)</span>
    <span class="n">WriteBuffer</span> <span class="o">&amp;</span> <span class="n">ostr</span><span class="p">,</span> <span class="c1">/// Where to write the result</span>
    <span class="n">Context</span> <span class="o">&amp;</span> <span class="n">context</span><span class="p">,</span> <span class="c1">/// DB, tables, data types, engines, functions, aggregate functions...</span>
    <span class="n">BlockInputStreamPtr</span> <span class="o">&amp;</span> <span class="n">query_plan</span><span class="p">,</span> <span class="c1">/// A description of query processing can be included here</span>
    <span class="n">QueryProcessingStage</span><span class="o">::</span><span class="n">Enum</span> <span class="n">stage</span> <span class="o">=</span> <span class="n">QueryProcessingStage</span><span class="o">::</span><span class="n">Complete</span> <span class="c1">/// The last stage to process the SELECT query to</span>
    <span class="p">)</span>
</pre></div>


<p><strong>4.</strong> Comments should be written in English only.</p>
<p><strong>5.</strong> If you are writing a library, include detailed comments explaining it in the main header file.</p>
<p><strong>6.</strong> Do not add comments that do not provide additional information. In particular, do not leave empty comments like this:</p>
<div class="codehilite"><pre><span></span><span class="cm">/*</span>
<span class="cm">* Procedure Name:</span>
<span class="cm">* Original procedure name:</span>
<span class="cm">* Author:</span>
<span class="cm">* Date of creation:</span>
<span class="cm">* Dates of modification:</span>
<span class="cm">* Modification authors:</span>
<span class="cm">* Original file name:</span>
<span class="cm">* Purpose:</span>
<span class="cm">* Intent:</span>
<span class="cm">* Designation:</span>
<span class="cm">* Classes used:</span>
<span class="cm">* Constants:</span>
<span class="cm">* Local variables:</span>
<span class="cm">* Parameters:</span>
<span class="cm">* Date of creation:</span>
<span class="cm">* Purpose:</span>
<span class="cm">*/</span>
</pre></div>


<p>The example is borrowed from  <a href="http://home.tamk.fi/~jaalto/course/coding-style/doc/unmaintainable-code/">http://home.tamk.fi/~jaalto/course/coding-style/doc/unmaintainable-code/</a>.</p>
<p><strong>7.</strong> Do not write garbage comments (author, creation date ..) at the beginning of each file.</p>
<p><strong>8.</strong> Single-line comments begin with three slashes: <code>///</code>  and multi-line comments begin with <code>/**</code>. These comments are considered "documentation".</p>
<p>Note: You can use Doxygen to generate documentation from these comments. But Doxygen is not generally used because it is more convenient to navigate the code in the IDE.</p>
<p><strong>9.</strong> Multi-line comments must not have empty lines at the beginning and end (except the line that closes a multi-line comment).</p>
<p><strong>10.</strong> For commenting out code, use basic comments, not "documenting" comments.</p>
<p><strong>11.</strong> Delete the commented out parts of the code before commiting.</p>
<p><strong>12.</strong> Do not use profanity in comments or code.</p>
<p><strong>13.</strong> Do not use uppercase letters. Do not use excessive punctuation.</p>
<div class="codehilite"><pre><span></span><span class="c1">/// WHAT THE FAIL???</span>
</pre></div>


<p><strong>14.</strong> Do not make delimeters from comments.</p>
<div class="codehilite"><pre><span></span>///******************************************************
</pre></div>


<p><strong>15.</strong> Do not start discussions in comments.</p>
<div class="codehilite"><pre><span></span>/// Why did you do this stuff?
</pre></div>


<p><strong>16.</strong> There's no need to write a comment at the end of a block describing what it was about.</p>
<div class="codehilite"><pre><span></span>/// for
</pre></div>


<h3 id="names">Names</h3>
<p><strong>1.</strong> The names of variables and class members use lowercase letters with underscores.</p>
<div class="codehilite"><pre><span></span><span class="kt">size_t</span> <span class="n">max_block_size</span><span class="p">;</span>
</pre></div>


<p><strong>2.</strong> The names of functions (methods) use camelCase beginning with a lowercase letter.</p>
<div class="codehilite"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">getName</span><span class="p">()</span> <span class="k">const</span> <span class="k">override</span> <span class="p">{</span> <span class="k">return</span> <span class="s">&quot;Memory&quot;</span><span class="p">;</span> <span class="p">}</span>
</pre></div>


<p><strong>3.</strong> The names of classes (structures) use CamelCase beginning with an uppercase letter. Prefixes other than I are not used for interfaces.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">StorageMemory</span> <span class="o">:</span> <span class="k">public</span> <span class="n">IStorage</span>
</pre></div>


<p><strong>4.</strong> The names of usings follow the same rules as classes, or you can add _t at the end.</p>
<p><strong>5.</strong> Names of template type arguments for simple cases: T; T, U; T1, T2.</p>
<p>For more complex cases, either follow the rules for class names, or add the prefix T.</p>
<div class="codehilite"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">TKey</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TValue</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">AggregatedStatElement</span>
</pre></div>


<p><strong>6.</strong> Names of template constant arguments: either follow the rules for variable names, or use N in simple cases.</p>
<div class="codehilite"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="kt">bool</span> <span class="n">without_www</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">ExtractDomain</span>
</pre></div>


<p><strong>7.</strong> For abstract classes (interfaces) you can add the I prefix.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">IBlockInputStream</span>
</pre></div>


<p><strong>8.</strong> If you use a variable locally, you can use the short name.</p>
<p>In other cases, use a descriptive name that conveys the meaning.</p>
<div class="codehilite"><pre><span></span><span class="kt">bool</span> <span class="n">info_successfully_loaded</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</pre></div>


<p><strong>9.</strong> <code>define</code>‘s should be in ALL_CAPS with underscores. The same is true for global constants.</p>
<div class="codehilite"><pre><span></span><span class="cp">##define MAX_SRC_TABLE_NAMES_TO_STORE 1000</span>
</pre></div>


<p><strong>10.</strong> File names should use the same style as their contents.</p>
<p>If a file contains a single class, name the file the same way as the class, in CamelCase.</p>
<p>If the file contains a single function, name the file the same way as the function, in camelCase.</p>
<p><strong>11.</strong> If the name contains an abbreviation, then:</p>
<ul>
<li>For variable names, the abbreviation should use lowercase letters <code>mysql_connection</code> (not <code>mySQL_connection</code>).</li>
<li>For names of classes and functions, keep the uppercase letters in the abbreviation <code>MySQLConnection</code> (not <code>MySqlConnection</code>).</li>
</ul>
<p><strong>12.</strong> Constructor arguments that are used just to initialize the class members should be named the same way as the class members, but with an underscore at the end.</p>
<div class="codehilite"><pre><span></span><span class="n">FileQueueProcessor</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span> <span class="n">path_</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span> <span class="n">prefix_</span><span class="p">,</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">FileHandler</span><span class="o">&gt;</span> <span class="n">handler_</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">path</span><span class="p">(</span><span class="n">path_</span><span class="p">),</span>
    <span class="n">prefix</span><span class="p">(</span><span class="n">prefix_</span><span class="p">),</span>
    <span class="n">handler</span><span class="p">(</span><span class="n">handler_</span><span class="p">),</span>
    <span class="n">log</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Logger</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;FileQueueProcessor&quot;</span><span class="p">))</span>
<span class="p">{</span>
<span class="p">}</span>
</pre></div>


<p>The underscore suffix can be omitted if the argument is not used in the constructor body.</p>
<p><strong>13.</strong> There is no difference in the names of local variables and class members (no prefixes required).</p>
<div class="codehilite"><pre><span></span><span class="n">timer</span> <span class="p">(</span><span class="n">not</span> <span class="n">m_timer</span><span class="p">)</span>
</pre></div>


<p><strong>14.</strong> Constants in enums use CamelCase beginning with an uppercase letter. ALL_CAPS is also allowed. If the enum is not local, use enum class.</p>
<div class="codehilite"><pre><span></span><span class="k">enum</span> <span class="k">class</span> <span class="nc">CompressionMethod</span>
<span class="p">{</span>
    <span class="n">QuickLZ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">LZ4</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>


<p><strong>15.</strong> All names must be in English. Transliteration of Russian words is not allowed.</p>
<div class="codehilite"><pre><span></span><span class="n">not</span> <span class="n">Stroka</span>
</pre></div>


<p><strong>16.</strong> Abbreviations are acceptable if they are well known (when you can easily find the meaning of the abbreviation in Wikipedia or in a search engine).</p>
<div class="codehilite"><pre><span></span>`AST`, `SQL`.

Not `NVDH` (some random letters)
</pre></div>


<p>Incomplete words are acceptable if the shortened version is common use.</p>
<p>You can also use an abbreviation if the full name is included next to it in the comments.</p>
<p><strong>17.</strong> File names with C++ source code must have the <code>.cpp</code> extension. Header files must have the <code>.h</code> extension.</p>
<h3 id="how-to-write-code">How to write code</h3>
<p><strong>1.</strong> Memory management.</p>
<p>Manual memory deallocation (delete) can only be used in library code.</p>
<p>In library code, the delete operator can only be used in destructors.</p>
<p>In application code, memory must be freed by the object that owns it.</p>
<p>Examples:</p>
<ul>
<li>The easiest way is to place an object on the stack, or make it a member of another class.</li>
<li>For a large number of small objects, use containers.</li>
<li>For automatic deallocation of a small number of objects that reside in the heap, use shared_ptr/unique_ptr.</li>
</ul>
<p><strong>2.</strong> Resource management.</p>
<p>Use RAII and see the previous point.</p>
<p><strong>3.</strong> Error handling.</p>
<p>Use exceptions. In most cases, you only need to throw an exception, and don't need to catch it (because of RAII).</p>
<p>In offline data processing applications, it's often acceptable to not catch exceptions.</p>
<p>In servers that handle user requests, it's usually enough to catch exceptions at the top level of the connection handler.</p>
<div class="codehilite"><pre><span></span><span class="c1">/// If there were no other calculations yet, do it synchronously</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">started</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">calculate</span><span class="p">();</span>
    <span class="n">started</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span>    <span class="c1">/// If the calculations are already in progress, wait for results</span>
    <span class="n">pool</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>

<span class="k">if</span> <span class="p">(</span><span class="n">exception</span><span class="p">)</span>
    <span class="n">exception</span><span class="o">-&gt;</span><span class="n">rethrow</span><span class="p">();</span>
</pre></div>


<p>Never hide exceptions without handling. Never just blindly put all exceptions to log.</p>
<p>Not <code>catch (...) {}</code>.</p>
<p>If you need to ignore some exceptions, do so only for specific ones and rethrow the rest.</p>
<div class="codehilite"><pre><span></span><span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">DB</span><span class="o">::</span><span class="n">Exception</span> <span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">code</span><span class="p">()</span> <span class="o">==</span> <span class="n">ErrorCodes</span><span class="o">::</span><span class="n">UNKNOWN_AGGREGATE_FUNCTION</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="k">throw</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>When using functions with response codes or errno, always check the result and throw an exception in case of error.</p>
<div class="codehilite"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">))</span>
    <span class="n">throwFromErrno</span><span class="p">(</span><span class="s">&quot;Cannot close file &quot;</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">ErrorCodes</span><span class="o">::</span><span class="n">CANNOT_CLOSE_FILE</span><span class="p">);</span>
</pre></div>


<p>Asserts are not used.</p>
<p><strong>4.</strong> Exception types.</p>
<p>There is no need to use complex exception hierarchy in application code. The exception text should be understandable to a system administrator.</p>
<p><strong>5.</strong> Throwing exceptions from destructors.</p>
<p>This is not recommended, but it is allowed.</p>
<p>Use the following options:</p>
<ul>
<li>Create a (done() or finalize()) function that will do all the work in advance that might lead to an exception. If that function was called, there should be no exceptions in the destructor later.</li>
<li>Tasks that are too complex (such as sending messages over the network) can be put in separate method that the class user will have to call before destruction.</li>
<li>If there is an exception in the destructor, it’s better to log it than to hide it (if the logger is available).</li>
<li>In simple applications, it is acceptable to rely on std::terminate (for cases of noexcept by default in C++11) to handle exceptions.</li>
</ul>
<p><strong>6.</strong> Anonymous code blocks.</p>
<p>You can create a separate code block inside a single function in order to make certain variables local, so that the destructors are called when exiting the block.</p>
<div class="codehilite"><pre><span></span><span class="n">Block</span> <span class="n">block</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">();</span>

<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
    <span class="n">data</span><span class="p">.</span><span class="n">ready</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">data</span><span class="p">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">ready_any</span><span class="p">.</span><span class="n">set</span><span class="p">();</span>
</pre></div>


<p><strong>7.</strong> Multithreading.</p>
<p>For offline data processing applications:</p>
<ul>
<li>Try to get the best possible performance on a single CPU core. You can then parallelize your code if necessary.</li>
</ul>
<p>In server applications:</p>
<ul>
<li>Use the thread pool to process requests. At this point, we haven't had any tasks that required userspace context switching.</li>
</ul>
<p>Fork is not used for parallelization.</p>
<p><strong>8.</strong> Synchronizing threads.</p>
<p>Often it is possible to make different threads use different memory cells (even better: different cache lines,) and to not use any thread synchronization (except joinAll).</p>
<p>If synchronization is required, in most cases, it is sufficient to use mutex under lock_guard.</p>
<p>In other cases use system synchronization primitives. Do not use busy wait.</p>
<p>Atomic operations should be used only in the simplest cases.</p>
<p>Do not try to implement lock-free data structures unless it is your primary area of expertise.</p>
<p><strong>9.</strong> Pointers vs references.</p>
<p>In most cases, prefer references.</p>
<p><strong>10.</strong> const.</p>
<p>Use constant references, pointers to constants, <code>const_iterator</code>, <code>const</code> methods.</p>
<p>Consider <code>const</code> to be default and use non-const only when necessary.</p>
<p>When passing variable by value, using <code>const</code> usually does not make sense.</p>
<p><strong>11.</strong> unsigned.</p>
<p>Use <code>unsigned</code>, if needed.</p>
<p><strong>12.</strong> Numeric types</p>
<p>Use <code>UInt8</code>, <code>UInt16</code>, <code>UInt32</code>, <code>UInt64</code>, <code>Int8</code>, <code>Int16</code>, <code>Int32</code>, <code>Int64</code>, and <code>size_t</code>, <code>ssize_t</code>, <code>ptrdiff_t</code>.</p>
<p>Don't use <code>signed/unsigned long</code>, <code>long long</code>, <code>short</code>, <code>signed char</code>, <code>unsigned char</code>, or <code>char</code> types for numbers.</p>
<p><strong>13.</strong> Passing arguments.</p>
<p>Pass complex values by reference (including <code>std::string</code>).</p>
<p>If a function captures ownership of an objected created in the heap, make the argument type <code>shared_ptr</code> or <code>unique_ptr</code>.</p>
<p><strong>14.</strong> Returning values.</p>
<p>In most cases, just use return. Do not write <code>[return std::move(res)]{.strike}</code>.</p>
<p>If the function allocates an object on heap and returns it, use <code>shared_ptr</code> or <code>unique_ptr</code>.</p>
<p>In rare cases you might need to return the value via an argument. In this case, the argument should be a reference.</p>
<div class="codehilite"><pre><span></span><span class="nx">using</span> <span class="nx">AggregateFunctionPtr</span> <span class="o">=</span> <span class="nx">std</span><span class="o">::</span><span class="nx">shared_ptr</span><span class="o">&lt;</span><span class="nx">IAggregateFunction</span><span class="o">&gt;</span><span class="p">;</span>

<span class="cm">/** Creates an aggregate function by name.</span>
<span class="cm"> */</span>
<span class="kr">class</span> <span class="nx">AggregateFunctionFactory</span>
<span class="p">{</span>
<span class="kr">public</span><span class="o">:</span>
   <span class="nx">AggregateFunctionFactory</span><span class="p">();</span>
   <span class="nx">AggregateFunctionPtr</span> <span class="nx">get</span><span class="p">(</span><span class="kr">const</span> <span class="nb">String</span> <span class="o">&amp;</span> <span class="nx">name</span><span class="p">,</span> <span class="kr">const</span> <span class="nx">DataTypes</span> <span class="o">&amp;</span> <span class="nx">argument_types</span><span class="p">)</span> <span class="kr">const</span><span class="p">;</span>
</pre></div>


<p><strong>15.</strong> namespace.</p>
<p>There is no need to use a separate namespace for application code or small libraries.</p>
<p>or small libraries.</p>
<p>For medium to large libraries, put everything in the namespace.</p>
<p>You can use the additional detail namespace in a library's <code>.h</code> file to hide implementation details.</p>
<p>In a <code>.cpp</code> file, you can use the static or anonymous namespace to hide symbols.</p>
<p>You can also use namespace for enums to prevent its names from polluting the outer namespace, but it’s better to use the enum class.</p>
<p><strong>16.</strong> Delayed initialization.</p>
<p>If arguments are required for initialization then do not write a default constructor.</p>
<p>If later you’ll need to delay initialization, you can add a default constructor that will create an invalid object. Or, for a small number of objects, you can use <code>shared_ptr/unique_ptr</code>.</p>
<div class="codehilite"><pre><span></span><span class="n">Loader</span><span class="p">(</span><span class="n">DB</span><span class="o">::</span><span class="n">Connection</span> <span class="o">*</span> <span class="n">connection_</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span> <span class="n">query</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">max_block_size_</span><span class="p">);</span>

<span class="c1">/// For delayed initialization</span>
<span class="n">Loader</span><span class="p">()</span> <span class="p">{}</span>
</pre></div>


<p><strong>17.</strong> Virtual functions.</p>
<p>If the class is not intended for polymorphic use, you do not need to make functions virtual. This also applies to the destructor.</p>
<p><strong>18.</strong> Encodings.</p>
<p>Use UTF-8 everywhere. Use <code>std::string</code>and<code>char *</code>. Do not use <code>std::wstring</code>and<code>wchar_t</code>.</p>
<p><strong>19.</strong> Logging.</p>
<p>See the examples everywhere in the code.</p>
<p>Before committing, delete all meaningless and debug logging, and any other types of debug output.</p>
<p>Logging in cycles should be avoided, even on the Trace level.</p>
<p>Logs must be readable at any logging level.</p>
<p>Logging should only be used in application code, for the most part.</p>
<p>Log messages must be written in English.</p>
<p>The log should preferably be understandable for the system administrator.</p>
<p>Do not use profanity in the log.</p>
<p>Use UTF-8 encoding in the log. In rare cases you can use non-ASCII characters in the log.</p>
<p><strong>20.</strong> I/O.</p>
<p>Don't use iostreams in internal cycles that are critical for application performance (and never use stringstream).</p>
<p>Use the DB/IO library instead.</p>
<p><strong>21.</strong> Date and time.</p>
<p>See the <code>DateLUT</code> library.</p>
<p><strong>22.</strong> include.</p>
<p>Always use <code>#pragma once</code> instead of include guards.</p>
<p><strong>23.</strong> using.</p>
<p>The <code>using namespace</code> is not used.</p>
<p>It's fine if you are 'using' something specific, but make it local inside a class or function.</p>
<p><strong>24.</strong> Do not use trailing return type for functions unless necessary.</p>
<div class="codehilite"><pre><span></span>[auto f() -&amp;gt; void;]{.strike}
</pre></div>


<p><strong>25.</strong> Do not declare and init variables like this:</p>
<div class="codehilite"><pre><span></span><span class="k">auto</span> <span class="n">s</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">{</span><span class="s">&quot;Hello&quot;</span><span class="p">};</span>
</pre></div>


<p>Do it like this:</p>
<div class="codehilite"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Hello&quot;</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">s</span><span class="p">{</span><span class="s">&quot;Hello&quot;</span><span class="p">};</span>
</pre></div>


<p><strong>26.</strong> For virtual functions, write <code>virtual</code> in the base class, but write <code>override</code> in descendent classes.</p>
<h3 id="unused-features-of-c">Unused features of C++</h3>
<p><strong>1.</strong> Virtual inheritance is not used.</p>
<p><strong>2.</strong> Exception specifiers from C++03 are not used.</p>
<p><strong>3.</strong> Function try block is not used, except for the main function in tests.</p>
<h3 id="platform">Platform</h3>
<p><strong>1.</strong> We write code for a specific platform.</p>
<p>But other things being equal, cross-platform or portable code is preferred.</p>
<p><strong>2.</strong> The language is C++17.</p>
<p><strong>3.</strong> The compiler is <code>gcc</code>. At this time (December 2017), the code is compiled using version 7.2. (It can also be compiled using clang 5.)</p>
<p>The standard library is used (implementation of <code>libstdc++</code> or <code>libc++</code>).</p>
<p><strong>4.</strong> OS: Linux Ubuntu, not older than Precise.</p>
<p><strong>5.</strong> Code is written for x86_64 CPU architecture.</p>
<p>The CPU instruction set is the minimum supported set among our servers. Currently, it is SSE 4.2.</p>
<p><strong>6.</strong> Use <code>-Wall -Wextra -Werror</code> compilation flags.</p>
<p><strong>7.</strong> Use static linking with all libraries except those that are difficult to connect to statically (see the output of the <code>ldd</code> command).</p>
<p><strong>8.</strong> Code is developed and debugged with release settings.</p>
<h3 id="tools">Tools</h3>
<p><strong>1.</strong> <code>KDevelop</code> is a good IDE.</p>
<p><strong>2.</strong> For debugging, use <code>gdb</code>, <code>valgrind</code> (<code>memcheck</code>), <code>strace</code>, <code>-fsanitize=</code>, ..., <code>tcmalloc_minimal_debug</code>.</p>
<p><strong>3.</strong> For profiling, use Linux Perf <code>valgrind</code> (<code>callgrind</code>), <code>strace-cf</code>.</p>
<p><strong>4.</strong> Sources are in Git.</p>
<p><strong>5.</strong> Compilation is managed by <code>CMake</code>.</p>
<p><strong>6.</strong> Releases are in <code>deb</code> packages.</p>
<p><strong>7.</strong> Commits to master must not break the build.</p>
<p>Though only selected revisions are considered workable.</p>
<p><strong>8.</strong> Make commits as often as possible, even if the code is only partially ready.</p>
<p>Use branches for this purpose.</p>
<p>If your code is not buildable yet, exclude it from the build before pushing to master. You'll need to finish it or remove it from master within a few days.</p>
<p><strong>9.</strong> For non-trivial changes, used branches and publish them on the server.</p>
<p><strong>10.</strong> Unused code is removed from the repository.</p>
<h3 id="libraries">Libraries</h3>
<p><strong>1.</strong> The C++14 standard library is used (experimental extensions are fine), as well as boost and Poco frameworks.</p>
<p><strong>2.</strong> If necessary, you can use any well-known libraries available in the OS package.</p>
<p>If there is a good solution already available, then use it, even if it means you have to install another library.</p>
<p>(But be prepared to remove bad libraries from code.)</p>
<p><strong>3.</strong> You can install a library that isn't in the packages, if the packages don't have what you need or have an outdated version or the wrong type of compilation.</p>
<p><strong>4.</strong> If the library is small and doesn't have its own complex build system, put the source files in the contrib folder.</p>
<p><strong>5.</strong> Preference is always given to libraries that are  already used.</p>
<h3 id="general-recommendations_1">General recommendations</h3>
<p><strong>1.</strong> Write as little code as possible.</p>
<p><strong>2.</strong> Try the simplest solution.</p>
<p><strong>3.</strong> Don't write code until you know how it's going to work and how the inner loop will function.</p>
<p><strong>4.</strong> In the simplest cases, use 'using' instead of classes or structs.</p>
<p><strong>5.</strong> If possible, do not write copy constructors, assignment operators, destructors (other than a virtual one, if the class contains at least one virtual function), mpve-constructors and move assignment operators. In other words, the compiler-generated functions must work correctly. You can use 'default'.</p>
<p><strong>6.</strong> Code simplification is encouraged. Reduce the size of your code where possible.</p>
<h3 id="additional-recommendations">Additional recommendations</h3>
<p><strong>1.</strong> Explicit <code>std::</code> for types from <code>stddef.h</code> is not recommended.</p>
<p>We recommend writing <code>size_t</code> instead <code>std::size_t</code> because it's shorter.</p>
<p>But if you prefer, <code>std::</code> is acceptable.</p>
<p><strong>2.</strong> Explicit <code>std::</code> for functions from the standard C library is not recommended.</p>
<p>Write <code>memcpy</code> instead of <code>std::memcpy</code>.</p>
<p>The reason is that there are similar non-standard functions, such as <code>memmem</code>. We do use these functions on occasion. These functions do not exist in namespace <code>std</code>.</p>
<p>If you write <code>std::memcpy</code> instead of <code>memcpy</code> everywhere, then <code>memmem</code> without <code>std::</code> will look awkward.</p>
<p>Nevertheless, <code>std::</code> is allowed if you prefer it.</p>
<p><strong>3.</strong> Using functions from C when the ones are available in the standard C++ library.</p>
<p>This is acceptable if it is more efficient.</p>
<p>For example, use <code>memcpy</code> instead of <code>std::copy</code> for copying large chunks of memory.</p>
<p><strong>4.</strong> Multiline function arguments.</p>
<p>Any of the following wrapping styles are allowed:</p>
<div class="codehilite"><pre><span></span><span class="n">function</span><span class="p">(</span>
    <span class="n">T1</span> <span class="n">x1</span><span class="p">,</span>
    <span class="n">T2</span> <span class="n">x2</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">function</span><span class="p">(</span>
    <span class="kt">size_t</span> <span class="n">left</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">right</span><span class="p">,</span>
    <span class="k">const</span> <span class="o">&amp;</span> <span class="n">RangesInDataParts</span> <span class="n">ranges</span><span class="p">,</span>
    <span class="kt">size_t</span> <span class="n">limit</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">function</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">left</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">right</span><span class="p">,</span>
    <span class="k">const</span> <span class="o">&amp;</span> <span class="n">RangesInDataParts</span> <span class="n">ranges</span><span class="p">,</span>
    <span class="kt">size_t</span> <span class="n">limit</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">function</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">left</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">right</span><span class="p">,</span>
        <span class="k">const</span> <span class="o">&amp;</span> <span class="n">RangesInDataParts</span> <span class="n">ranges</span><span class="p">,</span>
        <span class="kt">size_t</span> <span class="n">limit</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">function</span><span class="p">(</span>
        <span class="kt">size_t</span> <span class="n">left</span><span class="p">,</span>
        <span class="kt">size_t</span> <span class="n">right</span><span class="p">,</span>
        <span class="k">const</span> <span class="o">&amp;</span> <span class="n">RangesInDataParts</span> <span class="n">ranges</span><span class="p">,</span>
        <span class="kt">size_t</span> <span class="n">limit</span><span class="p">)</span>
</pre></div>


<h2 id="how-to-run-clickhouse-tests">How to run ClickHouse tests</h2>
<p>The <code>clickhouse-test</code> utility that is used for functional testing is written using Python 2.x.It also requires you to have some third-party packages:</p>
<div class="codehilite"><pre><span></span>$ pip install lxml termcolor
</pre></div>


<p>In a nutshell:</p>
<ul>
<li>Put the <code>clickhouse</code> program to <code>/usr/bin</code> (or <code>PATH</code>)</li>
<li>Create a <code>clickhouse-client</code> symlink in <code>/usr/bin</code> pointing to <code>clickhouse</code></li>
<li>Start the <code>clickhouse</code> server</li>
<li><code>cd dbms/tests/</code></li>
<li>Run <code>./clickhouse-test</code></li>
</ul>
<h3 id="example-usage">Example usage</h3>
<p>Run <code>./clickhouse-test --help</code> to see available options.</p>
<p>To run tests without having to create a symlink or mess with <code>PATH</code>:</p>
<div class="codehilite"><pre><span></span>./clickhouse-test -c <span class="s2">&quot;../../build/dbms/src/Server/clickhouse --client&quot;</span>
</pre></div>


<p>To run a single test, i.e. <code>00395_nullable</code>:</p>
<div class="codehilite"><pre><span></span>./clickhouse-test <span class="m">00395</span>
</pre></div>


<h2 id="roadmap">Roadmap</h2>
<h3 id="q1-2018">Q1 2018</h3>
<h4 id="new-fuctionality">New fuctionality</h4>
<ul>
<li>
<p>Support for <code>UPDATE</code> and <code>DELETE</code>.</p>
</li>
<li>
<p>Multidimensional and nested arrays.</p>
</li>
</ul>
<p>It can look something like this:</p>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">t</span>
<span class="p">(</span>
    <span class="n">x</span> <span class="nb">Array</span><span class="p">(</span><span class="nb">Array</span><span class="p">(</span><span class="n">String</span><span class="p">)),</span>
    <span class="n">z</span> <span class="n">Nested</span><span class="p">(</span>
        <span class="n">x</span> <span class="nb">Array</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
        <span class="n">y</span> <span class="n">Nested</span><span class="p">(...))</span>
<span class="p">)</span>
<span class="n">ENGINE</span> <span class="o">=</span> <span class="n">MergeTree</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">x</span>
</pre></div>


<ul>
<li>External MySQL and ODBC tables.</li>
</ul>
<p>External tables can be integrated into ClickHouse using external dictionaries. This new functionality is a convenient alternative to connecting external tables.</p>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="p">...</span>
<span class="k">FROM</span> <span class="n">mysql</span><span class="p">(</span><span class="s1">&#39;host:port&#39;</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span><span class="o">`</span>
</pre></div>


<h4 id="improvements">Improvements</h4>
<ul>
<li>Effective data copying between ClickHouse clusters.</li>
</ul>
<p>Now you can copy data with the remote() function. For example: <code>INSERT INTO t SELECT * FROM remote(...)</code>.</p>
<p>This operation will have improved performance.</p>
<ul>
<li>O_DIRECT for merges.</li>
</ul>
<p>This will improve the performance of the OS cache and "hot" queries.</p>
<h3 id="q2-2018">Q2 2018</h3>
<h4 id="new-functionality">New functionality</h4>
<ul>
<li>
<p>UPDATE/DELETE conform to the EU GDPR.</p>
</li>
<li>
<p>Protobuf and Parquet input and output formats.</p>
</li>
<li>
<p>Creating dictionaries using DDL queries.</p>
</li>
</ul>
<p>Currently, dictionaries that are part of the database schema are defined in external XML files. This is inconvenient and counter-intuitive. The new approach should fix it.</p>
<ul>
<li>
<p>Integration with LDAP.</p>
</li>
<li>
<p>WITH ROLLUP and WITH CUBE for GROUP BY.</p>
</li>
<li>
<p>Custom encoding and compression for each column individually.</p>
</li>
</ul>
<p>As of now, ClickHouse supports LZ4 and ZSTD compression of columns, and compression settings are global (see the article <a href="https://www.altinity.com/blog/2017/11/21/compression-in-clickhouse">Compression in ClickHouse</a>). Per-column compression and encoding will provide more efficient data storage, which in turn will speed up queries.</p>
<ul>
<li>Storing data on multiple disks on the same server.</li>
</ul>
<p>This functionality will make it easier to extend the disk space, since different disk systems can be used for different databases or tables. Currently, users are forced to use symbolic links if the databases and tables must be stored on a different disk.</p>
<h4 id="improvements_1">Improvements</h4>
<p>Many improvements and fixes are planned for the query execution system. For example:</p>
<ul>
<li>Using an index for <code>in (subquery)</code>.</li>
</ul>
<p>The index is not used right now, which reduces performance.</p>
<ul>
<li>Passing predicates from <code>where</code> to subqueries, and passing predicates to views.</li>
</ul>
<p>The predicates must be passed, since the view is changed by the subquery. Performance is still low for view filters, and views can't use the primary key of the original table, which makes views useless for large tables.</p>
<ul>
<li>Optimizing branching operations (ternary operator, if, multiIf).</li>
</ul>
<p>ClickHouse currently performs all branches, even if they aren't necessary.</p>
<ul>
<li>Using a primary key for GROUP BY and ORDER BY.</li>
</ul>
<p>This will speed up certain types of queries with partially sorted data.</p>
<h3 id="q3-q4-2018">Q3-Q4 2018</h3>
<p>We don't have any set plans yet, but the main projects will be:</p>
<ul>
<li>Resource pools for executing queries.</li>
</ul>
<p>This will make load management more efficient.</p>
<ul>
<li>ANSI SQL JOIN syntax.</li>
</ul>
<p>Improve ClickHouse compatibility with many SQL tools.</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            ©2016–2018 Yandex LLC
          </div>
        
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="./assets/javascripts/application.5165553b.js"></script>
      
      <script>app.initialize({version:"0.17.3",url:{base:"."}})</script>
      
    
    
      
    
  </body>
</html>