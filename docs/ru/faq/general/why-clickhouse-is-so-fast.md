---
title: Why ClickHouse is so fast?
toc_hidden: true
toc_priority: 8
---

#  Почему ClickHouse так быстро работает? {#why-clickhouse-is-so-fast}

Изначально его разрабатывали именно так, чтобы была высокая скорость работы. Производительность выполнения запросов всегда была самой важной в процессе разработки, но и другие важные характеристики, например: комфорт пользователя, масштабируемость и защищенность, — также принимались во внимание. Для того, чтобы ClickHouse стал системой с очень серьезной производительностью. 

Сначала ClickHouse создали как прототип, который выполняет отлично одну вещь: фильтрует и агрегирует данные так быстро, насколько это возможно. Именно это необходимо, чтобы создать типичный аналитический отчет и получить то, что приходит по стандартном запросу [GROUP BY](../../sql-reference/statements/select/group-by.md). Команда ClickHouse приняла несколько высокоуровневых решений, которые вместе сделали достижимой следующую цель: 

Колоночое хранилище
:   Исходные данные часто содержат сотни или даже тысячи столбцов, в то время как для отчета нужно только несколько из них. Система не должна читать ненужные столбцы, иначе самые дорогостоящие операции чтения данных с диска будут производиться зря. 

Индексы
:   ClickHouse хранит в памяти структуры данных, а это позволяет читать не только используемые столбцы, но только необходимые диапазоны строк для этих столбцов.

Сжатие данных
:   Хранение различных значений одной и той же колонки вместе часто ведет к лучшим пропорциям сжатия (по сравнению со стандартными ориентированными на строки системами). Причина тому — в реальности столбец данных часто имеет такие же или не слишком различные значения для соседних строк. А в дополнение к универсальному сжатию ClickHouse поддерживает [специализированные кодеки](../../sql-reference/statements/create/table.md#create-query-specialized-codecs), которые могут ужать данные еще больше. 

Выполнение векторизованного запроса
:   ClickHouse не только хранит, но и обрабатывает данные в столбцах. Это приводит к лучшей утилизации кеша процессора и позволяет использовать инструкции [SIMD](https://en.wikipedia.org/wiki/SIMD).

Масштабируемость
:   ClickHouse может использовать все доступные ядра процессоров, а также диски, чтобы выполнить даже одиночный запрос. Не только на отдельном сервере, но на всех процессорных ядрах и дисках целого кластера.

Похожие техники используют и многие другие СУБД. **Внимание к низкоуровневым деталям** — вот, что делает ClickHouse по-настоящему особенным. Большинство языков программирования предоставляют реализации для большинства распространенных алгоритмов и структур данных, но в целом они слишком общие (поверхностные), чтобы быть эффективными. Каждую задачу можно рассмотреть как пейзаж с различными характеристиками вместо того, чтобы просто взять случайную реализацию. К примеру, если вам нужна таблица хешей, вот несколько ключевых вопросов к размышлению:

-   Какую функцию следует выбрать?
-   Алгоритм разрешения противоречий: [открытая адресация](https://en.wikipedia.org/wiki/Open_addressing) или [связывание](https://en.wikipedia.org/wiki/Hash_table#Separate_chaining)?
-   Схема памяти: один массив или отдельные массивы для ключей и значений? Будут ли хранится маленькие или большие значения?
-   Фактор заполнения: когда и как менять размер? Как перемещать значения при изменении размера?
-   Будут ли значения перемещаться и какой алгоритм сработает лучше при этом?
-   Понадобится ли нам быстрое зондирование с растровыми изображениями, вхождение строчных ключей, поддержка неперемещаемых значений, предварительная выборка и пакетирование?

Хеш-таблица — ключевая структура данных для реализации `GROUP BY` и ClickHouse автоматически выбирает одну из [более, чем 30-ти вариаций](https://github.com/ClickHouse/ClickHouse/blob/master/src/Interpreters/Aggregator.h) для каждого специфического запроса.

Аналогично происходит для алгоритмов, например, при сортировке вы можете подумать о:

-   Что будет сортироваться: массив чисел, кортежи, строки или структуры?
-   Все ли данные полностью доступны в RAM?
-   Нужна ли стабильная сортировка?
-   Нужна ли нам полная сортировка? Будет ли достаточно частичной сортировки некоторого количества элементов?
-   Как реализовать сравнения?
-   Сортируем ли мы данные, которые уже частично сортировали?

Алгоритмы, которые основываются на характеристиках данных, с которыми они работают, справляются лучше, чем их более общие аналоги. Если заранее неизвестно, система может попробовать различные реализации и выбрать ту, которая лучше всего показала себя во время работы. К примеру, загляните в [статью о том, как распаковка LZ4 реализуется в ClickHouse](https://habr.com/en/company/yandex/blog/457612/). 

Ну и самое последнее, но тем не менее важное: команда ClickHouse всегда мониторит сообщения пользователей Интернета о том, что еще стоит попробовать, чтобы улучшить имплементацию, алгоритм, или структуру данных. Иногда в этом потоке можно найти очень ценные идеи.

!!! info "Советы о том, как создать собственное высокопроизводительное ПО"


    -   Думайте о низкоуровневых деталях уже на этапе проектирования системы.
    -   Учитывайте возможности аппаратного обеспечения.
    -   Выбирайте структуры данных и абстракции согласно требованиям задачи.
    -   Для особых случаев разрабатывайте специализированные решения.
    -   Пробуйте новые алгоритмы, которые будут лучше. Современные — о которых вы услышали только вчераы.
    -   Выбирайте алгоритм по статистике, собранной во время работы.
    -   Ориентируйтесь на реальные датасеты.
    -   Проводите тестирование на снижение производительности в CI.
    -   Измеряйте и наблюдайте все, что только возможно.