# LDAP {#external-authenticators-ldap}

Пользователи ClickHouse могут использовать сервер LDAP для аутентификации. Есть два варианта, как это можно осуществлять:

- использовать LDAP как внешний аутентификатор для уже существующих пользователей, определённых в `users.xml` или через SQL-воркфлоу.
- использовать LDAP как внешний каталог пользователей и разрешать аутентификацию для пользователей, не определённых локально в ClickHouse, но существующих на LDAP-сервере.

Для любого из этих подходов необходимо прописать в конфигурационных файлах ClickHouse сервер LDAP.

## Определение LDAP-сервера {#ldap-server-definition}

Для определения LDAP-сервера необходимо добавить секцию `ldap_servers` в конфигурационный файл `config.xml`, например:

```xml
<yandex>
    <!- ... -->
    <ldap_servers>
        <my_ldap_server>
            <host>localhost</host>
            <port>636</port>
            <bind_dn>uid={user_name},ou=users,dc=example,dc=com</bind_dn>
            <verification_cooldown>300</verification_cooldown>
            <enable_tls>yes</enable_tls>
            <tls_minimum_protocol_version>tls1.2</tls_minimum_protocol_version>
            <tls_require_cert>demand</tls_require_cert>
            <tls_cert_file>/path/to/tls_cert_file</tls_cert_file>
            <tls_key_file>/path/to/tls_key_file</tls_key_file>
            <tls_ca_cert_file>/path/to/tls_ca_cert_file</tls_ca_cert_file>
            <tls_ca_cert_dir>/path/to/tls_ca_cert_dir</tls_ca_cert_dir>
            <tls_cipher_suite>ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:AES256-GCM-SHA384</tls_cipher_suite>
        </my_ldap_server>
    </ldap_servers>
</yandex>
```

Используя различные имена, можно определить несколько LDAP-серверов внутри секции `ldap_servers`.

Параметры:

- `host` - IP или имя хоста LDAP-сервера; этот параметр указывать обязательно, и он не может быть пустым.
- `port` - порт LDAP-сервера. Если `enable_tls` имеет значение `true`, то по умолчанию этот параметр равен `636`, а в противном случае - `389`.
- `bind_dn` - шаблон для построения DN (Distinguished Name, или Уникальное Имя).
    - Конечное DN получается заменой всех подстрок шаблона вида `{user_name}` актуальным именем пользователя во время каждой попытки аутентификации.
- `verification_cooldown` - временной интервал (в секундах) после успешной попытки подключения, в течение которого пользователь будет считаться аутентифицированным для всех последующих запросов, в это время повторное соединение с LDAP-сервером соверщаться не будет.
    - Укажите `0` (значение по умолчанию), чтобы отключить кэширование и принудить связываться с LDAP-сервером при каждой попытке аутентификации.
- `enable_tls` - флаг для указания необходимости использования защищённого соедниения с LDAP-сервером.
    - Укажите `no` для использования незашифрованного текстового протокола `ldap://` (не рекомендуется).
    - Укажите `yes` для использования LDAP через протокол SSL/TLS `ldaps://` (значение по умолчанию, рекомендуется).
    - Укажите `starttls` для использования устаревшего протокола StartTLS (незашифрованный `ldap://` с добавлением TLS).
- `tls_minimum_protocol_version` - требование к минимальной версии SSL/TLS.
    - Возможные значения: `ssl2`, `ssl3`, `tls1.0`, `tls1.1`, `tls1.2` (по умолчанию).
- `tls_require_cert` - проверка сертификата SSL/TLS.
    - Возможные значения: `never`, `allow`, `try`, `demand` (по умолчанию).
- `tls_cert_file` - путь к файлу сертификата.
- `tls_key_file` - путь к файлу ключа сертификата.
- `tls_ca_cert_file` - путь к файлу корневого сертификата (CA).
- `tls_ca_cert_dir` - путь к директории, содержащей корневые (CA) сертификаты.
- `tls_cipher_suite` - разрешённый набор шифров (в обозначении OpenSSL).

## LDAP как внешний аутентификатор {#ldap-external-authenticator}

Удалённый LDAP-сервер можно использовать для проверки паролей пользователей, определённых локально, в ClickHouse (в конфигурационных файлах или через SQL-воркфлоу). Для этого при определении пользователя укажите имя предварительно описанного LDAP-сервера вместо секции `password` или ей аналогичной.

При каждой попытке логина ClickHouse будет пытаться авторизоваться как DN, указанный в параметре `bind_dn` в [Определении сервера LDAP](#ldap-server-definition) с использованием указанных учётных данных. Если попытка увенчается успехом, то пользователь будет аутентифицирован. Инода это также называют простым подсоединением (simple bind).

Пример конфигурации:

```xml
<yandex>
    <!- ... -->
    <users>
        <!- ... -->
        <my_user>
            <!- ... -->
            <ldap>
                <server>my_ldap_server</server>
            </ldap>
        </my_user>
    </users>
</yandex>
```

Отметим, что пользователь `my_user` относится к `my_ldap_server`. Этот сервер нужно предварительно определить в главном конфигурационном файле `config.xml`, как описывалось ранее.

Если [управление доступом через SQL-воркфлоу](../access-rights.md#access-control) включено в ClickHouse, то с его помощью также можно создавать пользователей для аутентификации через LDAP, используя выражение [CREATE USER](../../sql-reference/statements/create/user.md#create-user-statement)

```sql
CREATE USER my_user IDENTIFIED WITH ldap_server BY 'my_ldap_server'
```

## Внешний каталог пользователей LDAP {#ldap-external-user-directory}

Кроме описанного выше использования LDAP в качестве внешнего аутентификатора, ClickHouse также предоставляет возможность использования LDAP как внешний пользовательские каталог. Для этого необходимо указать предварительно описанное (см. [определение LDAP-сервера](#ldap-server-definition)) имя LDAP-сервера в секции `ldap` внутри `users_directories` в конфигурационном файле `config.xml`

При каждой попытке авторизации ClickHouse сначала пытается найти пользователя среди определённых локально (посредством конфигурационных файлов или SQL-воркфлоу). Если там пользователь не найден, то полагается, что он существует во внешнем каталоге, и ClickHouse попытается выполнить "привязку" к уникальному имени (DN) на LDAP-сервере, используя предоставленные ему данные. Если попытка увенчается успехом, то пользователь будет сочтён существующим и прошедшим аутентификацию.

Пользователю будут присвоены роли из списка, приведённого в секции `roles`. Кроме того, может быть выполнен "поиск" в LDAP, результаты которого могут быть использованы как имена ролей и в дальнейшем присвоены пользователю, если также определена секция `role_mapping`. При этом полагается, что включен SQL-воркфлоу (см. [Управление доступом](../access-rights.md#access-control)) и роли уже созданы командой [CREATE ROLE](../../sql-reference/statements/create/role.md#create-role-statement).

Пример, как это выглядит в `config.xml`:

```xml
<yandex>
    <!- ... -->
    <user_directories>
        <!- ... -->
        <ldap>
            <server>my_ldap_server</server>
            <roles>
                <my_local_role1 />
                <my_local_role2 />
            </roles>
            <role_mapping>
                <base_dn>ou=groups,dc=example,dc=com</base_dn>
                <scope>subtree</scope>
                <search_filter>(&amp;(objectClass=groupOfNames)(member={bind_dn}))</search_filter>
                <attribute>cn</attribute>
                <prefix>clickhouse_</prefix>
            </role_mapping>
        </ldap>
    </user_directories>
</yandex>
```

!!! info "Note"
    LDAP-сервер `my_ldap_server`, упоминаемый в секции `ldap` внутри секции `user_directories`, должен быть предварительно определён в конфигурационном файле `config.xml` (см. [Определение LDAP-сервера](#ldap-server-definition)).

Параметры:

- `server` -  один из LDAP-серверов, определённых в секции `ldap_servers`/
  Этот параметр является обязательным к указанию и не может быть пустым.

- `roles` - секция, содержащая список локально определённых ролей, присваеваемых каждому пользователю, авторизованному посредством обращения к LDAP-серверу.
    - Если ни одна роль здесь не указана или не присвоена пользователю (см. ниже), пользователь не будет иметь возможности совершать никакие действия после аутентификации.
- `role_mapping` - секция, содержащая параметры поиска LDAP и сопоставления ролей.
    - При аутентификации пользователя выполняется LDAP-поиск по `search_filter` и имени авторизованного пользователя. Для каждой найденной записи извлекается значение указанного атрибута. Специальный префикс атрибутов ударяется, и полученное значение становится именем роли, определённой в ClickHouse. Ожидается, что эта роль уже создана командой [CREATE ROLE](../../sql-reference/statements/create/role.md#create-role-statement).
    - Допускается наличие более одной секции `role_mapping` внутри секции `ldap`. Каждая из них будет принята к сведению.
        - `base_dn` - шаблон, используемый для построения основного DN для LDAP-поиска.
           - DN получается из шаблона заменой всех подстрок `{user_name}` и `{bind_dn}` на реальное имя пользователя и bind DN (см. [определение LDAP-сервера](#ldap-server-definition)) во время каждого поиска LDAP.
        - `scope` - область поиска.
            - Возможные значения: `base`, `one_level`, `children`, `subtree` (по умолчанию).
        - `search_filter` - шаблон для построения поискового фильтра.
            - Фильтр получается заменой всех подстрок `{user_name}`, `{bind_dn}` и `{base_dn}` на реальные значения этих параметров.
            - Не забудьте, что все специальные символы (если они есть) должны быть экранированы при их использовании в XML.
        - `attribute` - имя атрибут, значения которого будут возвращены после поиска.
        - `prefix` - префикс, который ожидается в начале каждой строки исходного списка строк, полученного LDAP-поиском. В дальнейшем префикс будет удалён их строк и полученные строки будут трактованы как имена ролей.
            - По умолчанию, этот параметр пустой.
