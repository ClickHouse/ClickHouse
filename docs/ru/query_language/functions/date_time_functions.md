# Функции для работы с датами и временем

Поддержка часовых поясов

Все функции по работе с датой и временем, для которых это имеет смысл, могут принимать второй, необязательный аргумент - имя часового пояса. Пример: Asia/Yekaterinburg. В этом случае, они используют не локальный часовой пояс (по умолчанию), а указанный.

```sql
SELECT
    toDateTime('2016-06-15 23:00:00') AS time,
    toDate(time) AS date_local,
    toDate(time, 'Asia/Yekaterinburg') AS date_yekat,
    toString(time, 'US/Samoa') AS time_samoa
```

```text
┌────────────────time─┬─date_local─┬─date_yekat─┬─time_samoa──────────┐
│ 2016-06-15 23:00:00 │ 2016-06-15 │ 2016-06-16 │ 2016-06-15 09:00:00 │
└─────────────────────┴────────────┴────────────┴─────────────────────┘
```

Поддерживаются только часовые пояса, отличающиеся от UTC на целое число часов.

## toTimeZone
Переводит дату или дату-с-временем в указанный часовой пояс. Часовой пояс (таймзона) это атрибут типов Date/DateTime, внутреннее значение (количество секунд/дней) поля таблицы или колонки результата не изменяется, изменяется тип поля и автоматически его текстовое отображение.

```sql
SELECT
    toDateTime('2019-01-01 00:00:00', 'UTC') AS time_utc,
    toTypeName(time_utc) AS type_utc,
    toInt32(time_utc) AS int32utc,
    toTimeZone(time_utc, 'Asia/Yekaterinburg') AS time_yekat,
    toTypeName(time_yekat) AS type_yekat,
    toInt32(time_yekat) AS int32yekat,
    toTimeZone(time_utc, 'US/Samoa') AS time_samoa,
    toTypeName(time_samoa) AS type_samoa,
    toInt32(time_samoa) AS int32samoa
FORMAT Vertical;
```

```text
Row 1:
──────
time_utc:   2019-01-01 00:00:00
type_utc:   DateTime('UTC')
int32utc:   1546300800
time_yekat: 2019-01-01 05:00:00
type_yekat: DateTime('Asia/Yekaterinburg')
int32yekat: 1546300800
time_samoa: 2018-12-31 13:00:00
type_samoa: DateTime('US/Samoa')
int32samoa: 1546300800
```

`toTimeZone(time_utc, 'Asia/Yekaterinburg')` изменяет тип `DateTime('UTC')` в `DateTime('Asia/Yekaterinburg')`. Значение (unix-время) 1546300800 остается неизменным, но текстовое отображение (результат функции toString()) меняется `time_utc:   2019-01-01 00:00:00` в `time_yekat: 2019-01-01 05:00:00`.

## toYear
Переводит дату или дату-с-временем в число типа UInt16, содержащее номер года (AD).

## toQuarter
Переводит дату или дату-с-временем в число типа UInt8, содержащее номер квартала.

## toMonth
Переводит дату или дату-с-временем в число типа UInt8, содержащее номер месяца (1-12).

## toDayOfYear
Переводит дату или дату-с-временем в число типа UInt16, содержащее номер дня года (1-366).

## toDayOfMonth
Переводит дату или дату-с-временем в число типа UInt8, содержащее номер дня в месяце (1-31).

## toDayOfWeek
Переводит дату или дату-с-временем в число типа UInt8, содержащее номер дня в неделе (понедельник - 1, воскресенье - 7).

## toHour
Переводит дату-с-временем в число типа UInt8, содержащее номер часа в сутках (0-23).
Функция исходит из допущения, что перевод стрелок вперёд, если осуществляется, то на час, в два часа ночи, а перевод стрелок назад, если осуществляется, то на час, в три часа ночи (что, в общем, не верно - даже в Москве два раза перевод стрелок был осуществлён в другое время).

## toMinute
Переводит дату-с-временем в число типа UInt8, содержащее номер минуты в часе (0-59).

## toSecond
Переводит дату-с-временем в число типа UInt8, содержащее номер секунды в минуте (0-59).
Секунды координации не учитываются.

## toUnixTimestamp
Переводит дату или дату-с-временем в число типа UInt32 в Unix-дату или Unix-время соответственно. 
Фактически никакого преобразования значения не происходит, потому что Date это Unix-дата (число дней с 1970-01-01) хранящееся как UInt16. А DateTime это Unix-время (число секунд после 1970-01-01 00:00:00) хранящееся как UInt32.

Пример c типом Date:
```sql
SELECT
    toDate('2019-01-01') AS date,
    toUnixTimestamp(date) AS UnixTimestamp,
    toUInt32(date) AS UInt32,
    toUInt16(date) AS UInt16;
```
```text
┌───────date─┬─UnixTimestamp─┬─UInt32─┬─UInt16─┐
│ 2019-01-01 │         17897 │  17897 │  17897 │
└────────────┴───────────────┴────────┴────────┘
```

Пример c типом DateTime:
```sql
SELECT
    toDateTime('2019-01-01 00:00:00') AS dateTime,
    toUnixTimestamp(dateTime) AS UnixTimestamp,
    toUInt32(dateTime) AS UInt32
```
```text
┌────────────dateTime─┬─UnixTimestamp─┬─────UInt32─┐
│ 2019-01-01 00:00:00 │    1546300800 │ 1546300800 │
└─────────────────────┴───────────────┴────────────┘
```

## toStartOfYear
Округляет дату или дату-с-временем вниз до первого дня года.
Возвращается дата.

## toStartOfISOYear
Округляет дату или дату-с-временем вниз до первого дня ISO года. Возвращается дата.
Начало ISO года отличается от начала обычного года, потому что в соответствии с [ISO 8601:1988](https://en.wikipedia.org/wiki/ISO_8601) первая неделя года это неделя с 4-мя или более днями в этом году.

1 Января 2017 г. - воскресение, т.е. первая ISO неделя 2017 года началась в понедельник 2 января, поэтому 1 января 2017 это 2016 ISO-год, который начался 2016-01-04.

```sql
SELECT toStartOfISOYear(toDate('2017-01-01')) AS ISOYear20170101;
```
```text
┌─ISOYear20170101─┐
│      2016-01-04 │
└─────────────────┘
```

## toStartOfQuarter
Округляет дату или дату-с-временем вниз до первого дня квартала.
Первый день квартала - это одно из 1 января, 1 апреля, 1 июля, 1 октября.
Возвращается дата.

## toStartOfMonth
Округляет дату или дату-с-временем вниз до первого дня месяца.
Возвращается дата.

!!! attention
    Возвращаемое значение для некорректных дат зависит от реализации. ClickHouse может вернуть нулевую дату, выбросить исключение, или выполнить "естественное" перетекание дат между месяцами.

## toMonday
Округляет дату или дату-с-временем вниз до ближайшего понедельника.
Возвращается дата.

## toStartOfWeek(t[,mode])
Округляет дату или дату со временем до ближайшего воскресенья или понедельника в соответствии с mode.
Возвращается дата.
Аргумент mode работает точно так же, как аргумент mode [toWeek()](#date_time_functions-toweek). Если аргумент mode опущен, то используется режим 0.

## toStartOfDay
Округляет дату-с-временем вниз до начала дня. Возвращается дата-с-временем.

## toStartOfHour
Округляет дату-с-временем вниз до начала часа.

## toStartOfMinute
Округляет дату-с-временем вниз до начала минуты.

## toStartOfFiveMinute
Округляет дату-с-временем вниз до начала пятиминутного интервала.

## toStartOfTenMinutes
Округляет дату-с-временем вниз до начала десятиминутного интервала.

## toStartOfFifteenMinutes
Округляет дату-с-временем вниз до начала пятнадцатиминутного интервала.

## toStartOfInterval(time_or_data, INTERVAL x unit [, time_zone])
Обобщение остальных функций `toStartOf*`. Например,  
`toStartOfInterval(t, INTERVAL 1 year)` возвращает то же самое, что и `toStartOfYear(t)`,  
`toStartOfInterval(t, INTERVAL 1 month)` возвращает то же самое, что и `toStartOfMonth(t)`,  
`toStartOfInterval(t, INTERVAL 1 day)` возвращает то же самое, что и `toStartOfDay(t)`,  
`toStartOfInterval(t, INTERVAL 15 minute)` возвращает то же самое, что и `toStartOfFifteenMinutes(t)`, и т.п.

## toTime
Переводит дату-с-временем на некоторую фиксированную дату, сохраняя при этом время.

## toRelativeYearNum
Переводит дату-с-временем или дату в номер года, начиная с некоторого фиксированного момента в прошлом.

## toRelativeQuarterNum
Переводит дату-с-временем или дату в номер квартала, начиная с некоторого фиксированного момента в прошлом.

## toRelativeMonthNum
Переводит дату-с-временем или дату в номер месяца, начиная с некоторого фиксированного момента в прошлом.

## toRelativeWeekNum
Переводит дату-с-временем или дату в номер недели, начиная с некоторого фиксированного момента в прошлом.

## toRelativeDayNum
Переводит дату-с-временем или дату в номер дня, начиная с некоторого фиксированного момента в прошлом.

## toRelativeHourNum
Переводит дату-с-временем в номер часа, начиная с некоторого фиксированного момента в прошлом.

## toRelativeMinuteNum
Переводит дату-с-временем в номер минуты, начиная с некоторого фиксированного момента в прошлом.

## toRelativeSecondNum
Переводит дату-с-временем в номер секунды, начиная с некоторого фиксированного момента в прошлом.

## toISOYear
Переводит дату-с-временем или дату в число типа UInt16, содержащее номер ISO года.

## toISOWeek
Переводит дату-с-временем или дату в число типа UInt8, содержащее номер ISO недели.
Начало ISO года отличается от начала обычного года, потому что в соответствии с [ISO 8601:1988](https://en.wikipedia.org/wiki/ISO_8601) первая неделя года это неделя с 4-мя или более днями в этом году.

1 Января 2017 г. - воскресение, т.е. первая ISO неделя 2017 года началась в понедельник 2 января, поэтому 1 января 2017 это последняя неделя 2016 года.

```sql
SELECT
    toISOWeek(toDate('2017-01-01')) AS ISOWeek20170101,
    toISOWeek(toDate('2017-01-02')) AS ISOWeek20170102
```

```text
┌─ISOWeek20170101─┬─ISOWeek20170102─┐
│              52 │               1 │
└─────────────────┴─────────────────┘
```

## toWeek(date\[, mode\]\[, timezone\]) {#date_time_functions-toweek}
Переводит дату-с-временем или дату в число UInt8, содержащее номер недели. Второй аргументам mode задает режим, начинается ли неделя с воскресенья или с понедельника и должно ли возвращаемое значение находиться в диапазоне от 0 до 53 или от 1 до 53. Если аргумент mode опущен, то используется режим 0.

`toISOWeek() ` эквивалентно `toWeek(date,3)`.

Описание режимов (mode):

| Mode | Первый день недели | Диапазон |  Неделя 1 это первая неделя … |
| ----------- | -------- | -------- | ------------------ |
|0|Воскресенье|0-53|с Воскресеньем в этом году
|1|Понедельник|0-53|с 4-мя или более днями в этом году
|2|Воскресенье|1-53|с Воскресеньем в этом году
|3|Понедельник|1-53|с 4-мя или более днями в этом году
|4|Воскресенье|0-53|с 4-мя или более днями в этом году
|5|Понедельник|0-53|с Понедельником в этом году
|6|Воскресенье|1-53|с 4-мя или более днями в этом году
|7|Понедельник|1-53|с Понедельником в этом году
|8|Воскресенье|1-53|содержащая 1 Января
|9|Понедельник|1-53|содержащая 1 Января

Для режимов со значением «с 4 или более днями в этом году» недели нумеруются в соответствии с ISO 8601:1988:

- Если неделя, содержащая 1 января, имеет 4 или более дней в новом году, это неделя 1.

- В противном случае это последняя неделя предыдущего года, а следующая неделя - неделя 1.

Для режимов со значением «содержит 1 января», неделя 1 – это неделя содержащая 1 января. Не имеет значения, сколько дней в новом году содержала неделя, даже если она содержала только один день.

**Пример**

```sql
SELECT toDate('2016-12-27') AS date, toWeek(date) AS week0, toWeek(date,1) AS week1, toWeek(date,9) AS week9;
```

```text
┌───────date─┬─week0─┬─week1─┬─week9─┐
│ 2016-12-27 │    52 │    52 │     1 │
└────────────┴───────┴───────┴───────┘
```

## toYearWeek(date[,mode])
Возвращает год и неделю для даты. Год в результате может отличаться от года в аргументе даты для первой и последней недели года.

Аргумент mode работает точно так же, как аргумент mode [toWeek()](#date_time_functions-toweek). Если mode не задан, используется режим 0.

`toISOYear() ` эквивалентно `intDiv(toYearWeek(date,3),100)`.

**Пример**

```sql
SELECT toDate('2016-12-27') AS date, toYearWeek(date) AS yearWeek0, toYearWeek(date,1) AS yearWeek1, toYearWeek(date,9) AS yearWeek9;
```

```text
┌───────date─┬─yearWeek0─┬─yearWeek1─┬─yearWeek9─┐
│ 2016-12-27 │    201652 │    201652 │    201701 │
└────────────┴───────────┴───────────┴───────────┘
```

## now

Принимает ноль аргументов и возвращает текущее время на один из моментов выполнения запроса.
Функция возвращает константу, даже если запрос выполнялся долго.

## today
Принимает ноль аргументов и возвращает текущую дату на один из моментов выполнения запроса.
То же самое, что toDate(now())

## yesterday
Принимает ноль аргументов и возвращает вчерашнюю дату на один из моментов выполнения запроса.
Делает то же самое, что today() - 1.

## timeSlot
Округляет время до получаса.
Эта функция является специфичной для Яндекс.Метрики, так как пол часа - минимальное время, для которого, если соседние по времени хиты одного посетителя на одном счётчике отстоят друг от друга строго более, чем на это время, визит может быть разбит на два визита. То есть, кортежи (номер счётчика, идентификатор посетителя, тайм-слот) могут использоваться для поиска хитов, входящий в соответствующий визит.

## toYYYYMM
Переводит дату или дату со временем в число типа UInt32, содержащее номер года и месяца (YYYY * 100 + MM).

## toYYYYMMDD
Переводит дату или дату со временем в число типа UInt32, содержащее номер года, месяца и дня (YYYY * 10000 + MM * 100 + DD).

## toYYYYMMDDhhmmss
Переводит дату или дату со временем в число типа UInt64 содержащее номер года, месяца, дня и время (YYYY * 10000000000 + MM * 100000000 + DD * 1000000 + hh * 10000 + mm * 100 + ss).

## addYears, addMonths, addWeeks, addDays, addHours, addMinutes, addSeconds, addQuarters
Добавляет интервал Date/DateTime к Date/DateTime, а затем возвращает Date/DateTime. 
Если в результате получается несуществующая дата (например 30 февраля), возвращяется ближайшая дата снизу (28 или 29 фервраля).

**Пример**

```sql
WITH
    toDate('2018-01-01') AS date,
    toDateTime('2018-01-01 00:00:00') AS date_time
SELECT
    addYears(date, 1) AS add_years_with_date,
    addYears(date_time, 1) AS add_years_with_date_time
```

```text
┌─add_years_with_date─┬─add_years_with_date_time─┐
│          2019-01-01 │      2019-01-01 00:00:00 │
└─────────────────────┴──────────────────────────┘
```

**Пример с несуществующей датой**

```sql
SELECT addYears(toDate('2016-02-29'), 1)
```

```text
┌─addYears(toDate('2016-02-29'), 1)─┐
│                        2017-02-28 │
└───────────────────────────────────┘
```


## subtractYears, subtractMonths, subtractWeeks, subtractDays, subtractHours, subtractMinutes, subtractSeconds, subtractQuarters
Вычитает интервал Date/DateTime из Date/DateTime, а затем возвращает Date/DateTime. 

**Пример**

```sql
WITH
    toDate('2019-01-01') AS date,
    toDateTime('2019-01-01 00:00:00') AS date_time
SELECT
    subtractYears(date, 1) AS subtract_years_with_date,
    subtractYears(date_time, 1) AS subtract_years_with_date_time
```

```text
┌─subtract_years_with_date─┬─subtract_years_with_date_time─┐
│               2018-01-01 │           2018-01-01 00:00:00 │
└──────────────────────────┴───────────────────────────────┘
```

## dateDiff('unit', t1, t2, \[timezone\])
Возвращает разницу между двумя значениями времени, в «единицах», например в часах (`'hours'`). 't1' и 't2' могут быть Date или DateTime. Если указан часовой пояс, он применяется к обоим аргументам. Если нет, то используются часовые пояса типов данных «t1» и «t2». Если эти часовые пояса не совпадают, результат не определен.

Поддерживаемые единицы:

| unit   |
| ------ |
|second  |
|minute  |
|hour    |
|day     |
|week    |
|month   |
|quarter |
|year    |

## timeSlots(StartTime, Duration,\[, Size\])
Для интервала времени, начинающегося в 'StartTime' и продолжающегося 'Duration' секунд, возвращает массив моментов времени, состоящий из округлений вниз до 'Size' точек в секундах из этого интервала. 'Size' - необязательный параметр, константный UInt32, по умолчанию равен 1800.

Например, `timeSlots(toDateTime('2012-01-01 12:20:00'), toUInt32(600)) = [toDateTime('2012-01-01 12:00:00'), toDateTime('2012-01-01 12:30:00')]`.
Это нужно для поиска хитов, входящих в соответствующий визит.

## formatDateTime(Time, Format\[, Timezone\])
Функция преобразования даты-с-временем в String согласно заданному шаблону. Важно - шаблон является константным выражением, т.е. невозможно использование разных шаблонов в одной колонке.

Поддерживаемые модификаторы в шаблоне Format:
(колонка "Пример" показана для времени `2018-01-02 22:33:44`)

| Модификатор | Описание | Пример |
| ----------- | -------- | --------------- |
|%C|номер года, поделённый на 100 (00-99)|20
|%d|день месяца, с ведущим нулём (01-31)|02
|%D|короткая запись %m/%d/%y|01/02/2018|
|%e|день месяца, с ведущим пробелом ( 1-31)|  2|
|%F|короткая запись %Y-%m-%d|2018-01-02
|%H|час в 24-часовом формате (00-23)|22|
|%I|час в 12-часовом формате (01-12)|10|
|%j|номер дня в году, с ведущими нулями (001-366)|002|
|%m|месяц, с ведущим нулём (01-12)|01|
|%M|минуты, с ведущим нулём (00-59)|33|
|%n|символ переноса строки ('\n')||
|%p|обозначения AM или PM|PM|
|%R|короткая запись %H:%M|22:33|
|%S|секунды, с ведущими нулями (00-59)|44|
|%t|символ табуляции ('\t')||
|%T|формат времени ISO 8601, одинаковый с %H:%M:%S|22:33:44|
|%u|номер дня недели согласно ISO 8601, понедельник - 1, воскресенье - 7|2|
|%V|номер недели согласно ISO 8601 (01-53)|01|
|%w|номер дня недели, начиная с воскресенья (0-6)|2|
|%y|год, последние 2 цифры (00-99)|18|
|%Y|год, 4 цифры|2018|
|%%|символ %|%|

[Оригинальная статья](https://clickhouse.yandex/docs/ru/query_language/functions/date_time_functions/) <!--hide-->
