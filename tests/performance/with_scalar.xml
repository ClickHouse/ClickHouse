<?xml version="1.0" encoding="utf-8"?>

<test>
    <create_query>create table hits (date Date, row_type Enum8('A' = 1, 'B' = 2, 'C' = 3), user UInt32) engine MergeTree partition by toYYYYMM(date) order by date</create_query>
    <create_query>create table users_list (date Date, user UInt32) engine MergeTree partition by toYYYYMM(date) order by date</create_query>

    <query>WITH (SELECT count(*) AS users_cnt FROM  (SELECT distinct user FROM users_list WHERE (1 = 1) AND (date >= '2020-06-01') AND (date &lt;= '2020-06-03'))) AS with1, (SELECT count(*) AS users_cnt FROM  (SELECT distinct user FROM users_list WHERE (1 = 1) AND (date >= '2020-06-01') AND (date &lt;= '2020-06-03'))) AS with2 SELECT main.date, averages.users AS average_daily_users, main.users AS users FROM (SELECT date, uniqExact(filtered.user) AS users FROM ( SELECT date, user FROM hits WHERE (1 = 1) AND (date >= '2020-06-01') AND (date &lt;= '2020-06-03') AND (row_type = 'A') ) AS filtered GROUP BY date) AS main LEFT JOIN (SELECT date, uniqExact(filtered.user) AS users FROM ( SELECT date, user FROM hits WHERE (1 = 1) AND (date >= '2020-06-01') AND (date &lt;= '2020-06-03') AND (row_type = 'A') ) AS filtered GROUP BY date) AS join1 ON main.date = join1.date LEFT JOIN (SELECT date, uniqExact(filtered.user) AS users FROM ( SELECT date, user FROM hits WHERE (1 = 1) AND (date >= '2020-06-01') AND (date &lt;= '2020-06-03') AND (row_type = 'A') ) AS filtered GROUP BY date) AS join2 ON main.date = join2.date LEFT JOIN (SELECT date, uniqExact(filtered.user) AS users FROM ( SELECT date, user FROM hits WHERE (1 = 1) AND (date >= '2020-06-01') AND (date &lt;= '2020-06-03') AND (row_type = 'A') ) AS filtered GROUP BY date) AS join3 ON main.date = join3.date LEFT JOIN (SELECT inner.date as date, avg(users) AS users FROM (WITH (SELECT count(*) AS users_cnt FROM  (SELECT distinct user FROM users_list WHERE (1 = 1) AND (date >= '2020-06-01') AND (date &lt;= '2020-06-03'))) AS with1, (SELECT count(*) AS users_cnt FROM  (SELECT distinct user FROM users_list WHERE (1 = 1) AND (date >= '2020-06-01') AND (date &lt;= '2020-06-03'))) AS with2 SELECT main.date as date, main.users AS users FROM (SELECT date, uniqExact(filtered.user) AS users FROM ( SELECT date, user FROM hits WHERE (1 = 1) AND (date >= '2020-06-01') AND (date &lt;= '2020-06-03') AND (row_type = 'A') ) AS filtered GROUP BY date) AS main LEFT JOIN (SELECT date, uniqExact(filtered.user) AS users FROM ( SELECT date, user FROM hits WHERE (1 = 1) AND (date >= '2020-06-01') AND (date &lt;= '2020-06-03') AND (row_type = 'A') ) AS filtered GROUP BY date) AS join1 ON main.date = join1.date LEFT JOIN (SELECT date, uniqExact(filtered.user) AS users FROM ( SELECT date, user FROM hits WHERE (1 = 1) AND (date >= '2020-06-01') AND (date &lt;= '2020-06-03') AND (row_type = 'A') ) AS filtered GROUP BY date) AS join2 ON main.date = join2.date LEFT JOIN (SELECT date, uniqExact(filtered.user) AS users FROM ( SELECT date, user FROM hits WHERE (1 = 1) AND (date >= '2020-06-01') AND (date &lt;= '2020-06-03') AND (row_type = 'A') ) AS filtered GROUP BY date) AS join3 ON main.date = join3.date) AS inner WHERE inner.date != '1970-01-01' GROUP BY date) AS averages ON main.date = averages.date</query>

    <drop_query>drop table if exists hits</drop_query>
    <drop_query>drop table if exists users_list</drop_query>
</test>
