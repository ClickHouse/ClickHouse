<?xml version="1.0"?>
<test>
    <settings>
        <max_threads>1</max_threads>
        <max_insert_threads>1</max_insert_threads>
        <allow_suspicious_fixed_string_types>1</allow_suspicious_fixed_string_types>
    </settings>

    <substitutions>
        <substitution>
            <name>x</name>
            <values>
                <value>1</value>
            </values>
        </substitution>
        <substitution>
            <name>y</name>
            <values>
                <value>1000</value>
            </values>
        </substitution>
    </substitutions>

    <create_query>
        CREATE DATABASE IF NOT EXISTS test
    </create_query>

    <create_query>
        DROP TABLE IF EXISTS test.vectors
    </create_query>

    <create_query>

        CREATE TABLE test.vectors
        (
            id UInt64,
            vector Array(Float32)
        )
        ENGINE = MergeTree
        ORDER BY id
        SETTINGS index_granularity = 128;

    </create_query>

    <!-- Generate random vectors and their quantized versions -->
    <fill_query>      

    INSERT INTO test.vectors
    SELECT 
    number AS id,
    (
            SELECT groupArray(randCanonical())
            FROM numbers(1024)
        ) AS vector
    FROM numbers(28000000)

    </fill_query>

    <fill_query>      

    ALTER TABLE test.vectors
    ADD COLUMN vector_quantized FixedString(1024);

    </fill_query>

    <fill_query>      

    ALTER TABLE test.vectors
    UPDATE vector_quantized = quantize8Bit(vector)
    WHERE 1;

    </fill_query>

    <!-- Benchmark Query 1: L2Distance -->
    <query>
        SELECT
            L2Distance(
                (SELECT vector FROM test.vectors LIMIT 1 OFFSET 0),
                vector
            ) as distance
        FROM test.vectors
        ORDER BY distance ASC
        LIMIT 10
    </query>

    <!-- Benchmark Query 2: quantized8BitL2Distance -->
    <query>
        SELECT
            quantized8BitL2Distance(
                (SELECT vector_quantized FROM test.vectors LIMIT 1 OFFSET 0),
                vector_quantized
            ) as distance
        FROM test.vectors
        ORDER BY distance ASC
        LIMIT 10
    </query>

    <drop_query>
        DROP TABLE test.vectors
    </drop_query>
</test>