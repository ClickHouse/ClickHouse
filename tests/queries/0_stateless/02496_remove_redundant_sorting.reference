-- Disabled query_plan_remove_redundant_sorting
-- ORDER BY clauses in subqueries are untouched
Expression (Projection)
Header: number UInt64
  Sorting (Sorting for ORDER BY)
  Header: number UInt64
    Expression ((Before ORDER BY + Projection))
    Header: number UInt64
      Sorting (Sorting for ORDER BY)
      Header: number UInt64
        Expression ((Before ORDER BY + Projection))
        Header: number UInt64
          Sorting (Sorting for ORDER BY)
          Header: number UInt64
            Expression (Before ORDER BY)
            Header: number UInt64
              ReadFromStorage (SystemNumbers)
              Header: number UInt64
-- Enabled query_plan_remove_redundant_sorting
-- ORDER BY removes ORDER BY clauses in subqueries
-- query
SELECT *
FROM
(
    SELECT *
    FROM
    (
        SELECT *
        FROM numbers(3)
        ORDER BY number ASC
    )
    ORDER BY number DESC
)
ORDER BY number ASC
-- explain
Expression (Projection)
Header: number UInt64
  Sorting (Sorting for ORDER BY)
  Header: number UInt64
    Expression ((Before ORDER BY + (Projection + (Before ORDER BY + (Projection + Before ORDER BY)))))
    Header: number UInt64
      ReadFromStorage (SystemNumbers)
      Header: number UInt64
-- execute
0
1
2
-- ORDER BY cannot remove ORDER BY in subquery WITH FILL
-- query
SELECT *
FROM
(
    SELECT *
    FROM
    (
        SELECT *
        FROM numbers(3)
        ORDER BY number DESC
    )
    ORDER BY number ASC WITH FILL STEP 1
)
ORDER BY number ASC
-- explain
Expression (Projection)
Header: number UInt64
  Sorting (Sorting for ORDER BY)
  Header: number UInt64
    Expression ((Before ORDER BY + Projection))
    Header: number UInt64
      Filling
      Header: number UInt64
        Sorting (Sorting for ORDER BY)
        Header: number UInt64
          Expression ((Before ORDER BY + (Projection + Before ORDER BY)))
          Header: number UInt64
            ReadFromStorage (SystemNumbers)
            Header: number UInt64
-- execute
0
1
2
-- ORDER BY cannot remove ORDER BY in subquery with LIMIT BY
-- query
SELECT *
FROM
(
    SELECT *
    FROM
    (
        SELECT *
        FROM numbers(3)
        ORDER BY number DESC
    )
    ORDER BY number ASC
    LIMIT 1 BY number
)
ORDER BY number ASC
-- explain
Expression (Projection)
Header: number UInt64
  Sorting (Sorting for ORDER BY)
  Header: number UInt64
    Expression ((Before ORDER BY + Projection))
    Header: number UInt64
      LimitBy
      Header: number UInt64
        Expression (Before LIMIT BY)
        Header: number UInt64
          Sorting (Sorting for ORDER BY)
          Header: number UInt64
            Expression ((Before ORDER BY + (Projection + Before ORDER BY)))
            Header: number UInt64
              ReadFromStorage (SystemNumbers)
              Header: number UInt64
-- execute
0
1
2
-- CROSS JOIN with subqueries, nor ORDER BY nor GROUP BY in main query -> only ORDER BY clauses in most inner subqueries will be removed
-- query
SELECT *
FROM
(
    SELECT number
    FROM
    (
        SELECT number
        FROM numbers(3)
        ORDER BY number DESC
    )
    ORDER BY number ASC
) AS t1,
(
    SELECT number
    FROM
    (
        SELECT number
        FROM numbers(3)
        ORDER BY number ASC
    )
    ORDER BY number DESC
) AS t2
-- explain
Expression ((Projection + Before ORDER BY))
Header: number UInt64
        t2.number UInt64
  Join (JOIN FillRightFirst)
  Header: number UInt64
          t2.number UInt64
    Expression ((Before JOIN + Projection))
    Header: number UInt64
      Sorting (Sorting for ORDER BY)
      Header: number UInt64
        Expression ((Before ORDER BY + (Projection + Before ORDER BY)))
        Header: number UInt64
          ReadFromStorage (SystemNumbers)
          Header: number UInt64
    Expression ((Joined actions + (Rename joined columns + Projection)))
    Header: t2.number UInt64
      Sorting (Sorting for ORDER BY)
      Header: number UInt64
        Expression ((Before ORDER BY + (Projection + Before ORDER BY)))
        Header: number UInt64
          ReadFromStorage (SystemNumbers)
          Header: number UInt64
-- execute
0	2
0	1
0	0
1	2
1	1
1	0
2	2
2	1
2	0
-- GROUP BY in most inner query makes execution parallelized, and removing inner sorting steps will keep it that way. But need to correctly update data streams sorting properties after removing sorting steps
-- query
SELECT *
FROM
(
    SELECT *
    FROM
    (
        SELECT *
        FROM numbers(3)
        GROUP BY number
        ORDER BY number ASC
    )
    ORDER BY number ASC
)
ORDER BY number ASC
-- explain
Expression (Projection)
Header: number UInt64
  Sorting (Sorting for ORDER BY)
  Header: number UInt64
    Expression ((Before ORDER BY + (Projection + (Before ORDER BY + (Projection + Before ORDER BY)))))
    Header: number UInt64
      Aggregating
      Header: number UInt64
        Expression (Before GROUP BY)
        Header: number UInt64
          ReadFromStorage (SystemNumbers)
          Header: number UInt64
-- execute
0
1
2
