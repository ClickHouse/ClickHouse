-- { echo }
-- Tests for check_referential_table_dependencies with Alias table engine

SET allow_experimental_alias_table_engine = 1;
-- Test: check_referential_table_dependencies prevents dropping target
SELECT 'Test check_referential_table_dependencies';
Test check_referential_table_dependencies
DROP TABLE IF EXISTS ref_dep_alias;
DROP TABLE IF EXISTS ref_dep_target;
CREATE TABLE ref_dep_target (id UInt32, value String) ENGINE = MergeTree ORDER BY id;
CREATE TABLE ref_dep_alias ENGINE = Alias('ref_dep_target');
-- This should fail with check_referential_table_dependencies = 1
SET check_referential_table_dependencies = 1;
DROP TABLE ref_dep_target; -- { serverError HAVE_DEPENDENT_OBJECTS }
-- Dropping the alias first, then the target should work
DROP TABLE ref_dep_alias;
DROP TABLE ref_dep_target;
SET check_referential_table_dependencies = 0;
-- Test: check_referential_table_dependencies with non-qualified target name
-- when alias is created from a different current database
SELECT 'Test check_referential_table_dependencies cross-database';
Test check_referential_table_dependencies cross-database
DROP DATABASE IF EXISTS {CLICKHOUSE_DATABASE_1:Identifier};
CREATE DATABASE {CLICKHOUSE_DATABASE_1:Identifier};
CREATE TABLE {CLICKHOUSE_DATABASE_1:Identifier}.cross_db_target (id UInt32) ENGINE = MergeTree ORDER BY id;
-- Create alias in CLICKHOUSE_DATABASE_1 while current database is CLICKHOUSE_DATABASE
-- The non-qualified 'cross_db_target' should resolve to CLICKHOUSE_DATABASE_1, not current db
CREATE TABLE {CLICKHOUSE_DATABASE_1:Identifier}.cross_db_alias ENGINE = Alias('cross_db_target');
SET check_referential_table_dependencies = 1;
DROP TABLE {CLICKHOUSE_DATABASE_1:Identifier}.cross_db_target; -- { serverError HAVE_DEPENDENT_OBJECTS }
-- Clean up
DROP TABLE {CLICKHOUSE_DATABASE_1:Identifier}.cross_db_alias;
DROP TABLE {CLICKHOUSE_DATABASE_1:Identifier}.cross_db_target;
DROP DATABASE {CLICKHOUSE_DATABASE_1:Identifier};
SET check_referential_table_dependencies = 0;
