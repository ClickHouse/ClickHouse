{% set join_kinds = ['INNER', 'LEFT', 'RIGHT', 'FULL', 'CROSS'] %}
-- Do we actually need it?
{% set join_strictness = ['ALL'] %}
{% set scenarios = ['left_empty', 'right_empty'] %}

{% set sources = [
    {'name': 'Memory',   'type': 'table'},
    {'name': 'MergeTree','type': 'table'},
    {'name': 'Log',      'type': 'table'},
    {'name': 'numbers',  'type': 'numbers'}
] %}

DROP TABLE IF EXISTS join_opt_results;

CREATE TABLE join_opt_results
(
    engine             String,
    join_kind          String,
    strictness         String,
    scenario           String,
    count_without_opt  UInt64,
    count_with_opt     UInt64,
    results_match      Bool,
    plan_has_join      Bool
)
ENGINE = Memory;

{% macro join_query(src, idx, kind, strict, scenario, optimize_flag) %}

SELECT *
FROM
    {% if src.type == 'table' %}
        (SELECT * FROM
            {% if scenario == 'left_empty' %}
                l_empty_{{ idx }}
            {% else %}
                l_nonempty_{{ idx }}
            {% endif %}
        ) AS l
    {% else %}
        (SELECT number AS k, number * 10 AS v
         FROM numbers({% if scenario == 'left_empty' %}0{% else %}3{% endif %})
        ) AS l
    {% endif %}
    {% if kind == 'CROSS' %}
        CROSS JOIN
    {% else %}
        {{ strict }} {{ kind }} JOIN
    {% endif %}
    {% if src.type == 'table' %}
        (SELECT * FROM
            {% if scenario == 'right_empty' %}
                r_empty_{{ idx }}
            {% else %}
                r_nonempty_{{ idx }}
            {% endif %}
        ) AS r
    {% else %}
        (SELECT number AS k, number * 100 AS v
         FROM numbers({% if scenario == 'right_empty' %}0{% else %}3{% endif %})
        ) AS r
    {% endif %}
    {% if kind != 'CROSS' %} USING (k) {% endif %}
SETTINGS allow_statistics_optimize = {{ optimize_flag }}

{% endmacro %}

{% for src in sources %}
{% set idx = loop.index0 %}

{% if src.type == 'table' %}

DROP TABLE IF EXISTS l_empty_{{ idx }};
DROP TABLE IF EXISTS r_empty_{{ idx }};
DROP TABLE IF EXISTS l_nonempty_{{ idx }};
DROP TABLE IF EXISTS r_nonempty_{{ idx }};

CREATE TABLE l_empty_{{ idx }} (k Int32, v Int32)
ENGINE = {{ src.name }}
{% if src.name == 'MergeTree' %} ORDER BY k {% endif %};

CREATE TABLE r_empty_{{ idx }} (k Int32, v Int32)
ENGINE = {{ src.name }}
{% if src.name == 'MergeTree' %} ORDER BY k {% endif %};

CREATE TABLE l_nonempty_{{ idx }} (k Int32, v Int32)
ENGINE = {{ src.name }}
{% if src.name == 'MergeTree' %} ORDER BY k {% endif %};

CREATE TABLE r_nonempty_{{ idx }} (k Int32, v Int32)
ENGINE = {{ src.name }}
{% if src.name == 'MergeTree' %} ORDER BY k {% endif %};

INSERT INTO l_nonempty_{{ idx }} VALUES (1,10),(2,20),(3,30);
INSERT INTO r_nonempty_{{ idx }} VALUES (2,200),(3,300),(4,400);

{% endif %}

{% for kind in join_kinds %}
{% for strict in join_strictness %}
{% for scenario in scenarios %}

WITH
(
    SELECT count()
    FROM ( {{ join_query(src, idx, kind, strict, scenario, 0) }} )
) AS rows_without_opt,
(
    SELECT count()
    FROM ( {{ join_query(src, idx, kind, strict, scenario, 1) }} )
) AS rows_with_opt,
(
    SELECT count()
    FROM
    (
        EXPLAIN PLAN
        {{ join_query(src, idx, kind, strict, scenario, 1) }}
    )
    WHERE position(explain, 'Join') > 0
) AS plan_hit

INSERT INTO join_opt_results
SELECT
    '{{ src.name }}'              AS engine,
    '{{ kind }}'                  AS join_kind,
    '{{ strict }}'                AS strictness,
    '{{ scenario }}'              AS scenario,
    rows_without_opt              AS count_without_opt,
    rows_with_opt                 AS count_with_opt,
    (rows_without_opt = rows_with_opt) AS results_match,
    (plan_hit > 0)                AS plan_has_join;

{% endfor %}
{% endfor %}
{% endfor %}

{% endfor %}

SELECT
    engine,
    join_kind,
    strictness,
    scenario,
    count_without_opt,
    count_with_opt,
    results_match,
    plan_has_join
FROM join_opt_results
ORDER BY
    engine,
    join_kind,
    strictness,
    scenario
FORMAT PrettyCompact;
