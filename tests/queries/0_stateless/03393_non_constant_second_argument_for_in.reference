0
1
6
7
-- IN --
0
1
6
7
-- MORE CASES --
-- { echoOn }

SELECT (1, 2) in [number % 3, number % 5] FROM numbers(2); -- { serverError NO_COMMON_TYPE }
SELECT (1, 2) in (SELECT [0, 0] UNION ALL SELECT [1, 1]); -- { serverError TYPE_MISMATCH }
SELECT (1, 2) in [(number % 3, number % 5)] FROM numbers(2);
0
0
SELECT (1, 2) in (SELECT (0, 0)), (1, 2) in (SELECT (1, 1));
0	0
SELECT (1, 1) in [(number % 3, number % 5)] FROM numbers(2);
0
1
SELECT (1, 1) in (SELECT (0, 0)), (1, 1) in (SELECT (1, 1));
0	1
SELECT (1, null) in [(number % 3, number % 5)] FROM numbers(2);
0
0
SELECT (1, null) in (SELECT (0, 0::Nullable(Int))), (1, null) in (SELECT (1, 1::Nullable(Int)));
0	0
SELECT (1, null) in [(number % 3, number % 5), (1, null)] FROM numbers(2);
1
1
SELECT (1, null) in (SELECT (0, 0::Nullable(Int)) UNION ALL SELECT (1, null)), (1, null) in (SELECT (1, 1::Nullable(Int)) UNION ALL SELECT (1, null));
1	1
SELECT 'ANOTHER SETTING';
ANOTHER SETTING
set transform_null_in = 1;
SELECT (1, 2) in [number % 3, number % 5] FROM numbers(2); -- { serverError NO_COMMON_TYPE }
SELECT (1, 2) in (SELECT [0, 0] UNION ALL SELECT [1, 1]); -- { serverError TYPE_MISMATCH }
SELECT (1, 2) in [(number % 3, number % 5)] FROM numbers(2);
0
0
SELECT (1, 2) in (SELECT (0, 0)), (1, 2) in (SELECT (1, 1));
0	0
SELECT (1, 1) in [(number % 3, number % 5)] FROM numbers(2);
0
1
SELECT (1, 1) in (SELECT (0, 0)), (1, 1) in (SELECT (1, 1));
0	1
SELECT (1, null) in [(number % 3, number % 5)] FROM numbers(2);
0
0
SELECT (1, null) in (SELECT (0, 0::Nullable(Int))), (1, null) in (SELECT (1, 1::Nullable(Int)));
0	0
SELECT (1, null) in [(number % 3, number % 5), (1, null)] FROM numbers(2);
1
1
SELECT (1, null) in (SELECT (0, 0::Nullable(Int)) UNION ALL SELECT (1, null)), (1, null) in (SELECT (1, 1::Nullable(Int)) UNION ALL SELECT (1, null));
1	1
--- with tuple rewritten into array
SELECT *
FROM numbers(1000)
WHERE number IN (123, 10 - number, 456);
5
123
456
-- Consistency of transform_null_in to non-const arguments
SELECT  
    NULL IN (1, number),  
    NULL IN (1, number, NULL),  
    NULL IN (1, 2),  
    NULL IN (1, NULL)  
FROM numbers(1)  
SETTINGS transform_null_in = 1;
0	1	1	1
SELECT  
    NULL IN (1, number),  
    NULL IN (1, number, NULL),  
    NULL IN (1, 2),  
    NULL IN (1, NULL)  
FROM numbers(1)  
SETTINGS transform_null_in = 0;
\N	\N	\N	\N
-- Consistency for arrays/tuples
SELECT toNullable(1) IN [1, number]  
FROM numbers(2);
1
1
SELECT toNullable(1) IN (1, number)  
FROM numbers(2);
1
1
-- Common type consistency
SELECT 'a' IN (5, number, 'a')  
FROM numbers(2);
1
1
SELECT
    NULL IN (
      258,
      CAST('string' AS Nullable(String)),
      CAST(number   AS Nullable(UInt64))
    )
FROM numbers(1)
SETTINGS transform_null_in = 1;
0
SELECT
    NULL IN (
      258,
      CAST('string' AS Nullable(String)),
      CAST(number   AS Nullable(UInt64))
    )
FROM numbers(1)
SETTINGS transform_null_in = 0;
\N
SELECT
    NULL IN (
      258,
      CAST('string' AS Nullable(String)),
      CAST(number   AS Nullable(UInt64)),
      NULL
    )
FROM numbers(1)
SETTINGS transform_null_in = 1;
1
SELECT
    NULL IN (
      258,
      CAST('string' AS Nullable(String)),
      CAST(number   AS Nullable(UInt64)),
      NULL
    )
FROM numbers(1)
SETTINGS transform_null_in = 0;
\N
SELECT NULL IN [1, number]
FROM numbers(1)
SETTINGS transform_null_in = 1;
0
SELECT NULL IN [1, number]
FROM numbers(1)
SETTINGS transform_null_in = 0;
\N
SELECT 1 IN [1, toNullable(number)]
FROM numbers(2)
SETTINGS transform_null_in = 1;
1
1
SELECT 1 IN [1, toNullable(number)]
FROM numbers(2)
SETTINGS transform_null_in = 0;
1
1
SELECT
    0 AS x,
    [if(number > 1, NULL, number)] AS arr,
    tuple(arr[1]) AS t,
    x IN (t),
    x IN (arr)
FROM numbers(3)
SETTINGS transform_null_in = 0;
0	[0]	(0)	1	1
0	[1]	(1)	0	0
0	[NULL]	(NULL)	0	0
SELECT
    arrayJoin([0, 1, NULL]) AS x,
    [if(number > 1, NULL, number)] AS arr,
    tuple(arr[1]) AS t,
    x IN (t),
    x IN (arr)
FROM numbers(3)
SETTINGS transform_null_in = 0;
0	[0]	(0)	1	1
1	[0]	(0)	0	0
\N	[0]	(0)	\N	\N
0	[1]	(1)	0	0
1	[1]	(1)	1	1
\N	[1]	(1)	\N	\N
0	[NULL]	(NULL)	0	0
1	[NULL]	(NULL)	0	0
\N	[NULL]	(NULL)	\N	\N
SELECT
    NULL AS x,
    [if(number > 1, NULL, number)] AS arr,
    tuple(arr[1]) AS t,
    x IN (t),
    x IN (arr)
FROM numbers(3)
SETTINGS transform_null_in = 0;
\N	[0]	(0)	\N	\N
\N	[1]	(1)	\N	\N
\N	[NULL]	(NULL)	\N	\N
SELECT '-- Scalar-returning functions (rewritten to equals/notEquals) --';
-- Scalar-returning functions (rewritten to equals/notEquals) --
SELECT 1 IN if(1 > 0, 1, 2);
1
SELECT 1 IN if(1 > 0, 2, 1);
0
SELECT 2 IN if(0 > 1, 1, 2);
1
SELECT number, number IN if(number > 2, 5, 1) FROM numbers(6);
0	0
1	1
2	0
3	0
4	0
5	1
SELECT number, number IN if(number % 2 = 0, number, number + 10) FROM numbers(5);
0	1
1	0
2	1
3	0
4	1
SELECT 1 NOT IN if(1 > 0, 1, 2);
0
SELECT 1 NOT IN if(1 > 0, 2, 1);
1
SELECT number, number NOT IN if(number > 2, 5, 1) FROM numbers(6);
0	1
1	0
2	1
3	1
4	1
5	0
SELECT 1 IN if(1 > 0, if(2 > 1, 1, 3), 2);
1
SELECT 2 IN if(1 > 0, if(2 > 1, 1, 3), 2);
0
SELECT 1 IN multiIf(1 > 2, 10, 2 > 3, 20, 1);
1
SELECT 10 IN multiIf(1 > 0, 10, 2 > 3, 20, 1);
1
SELECT 1 IN coalesce(NULL, 1);
1
SELECT 1 IN coalesce(NULL, 2);
0
SELECT 1 IN coalesce(1, 2);
1
SELECT 1 IN nullIf(1, 2);
1
SELECT 1 IN nullIf(2, 2);
0
SELECT 5 IN (2 + 3);
1
SELECT 5 IN (2 * 3);
0
SELECT 'hello' IN if(1 > 0, 'hello', 'world');
1
SELECT 'world' IN if(1 > 0, 'hello', 'world');
0
SELECT * FROM (SELECT number, number IN if(number > 2, 5, number) as result FROM numbers(6)) WHERE result = 1;
0	1
1	1
2	1
5	1
SELECT number, number IN if(number > 2, 5, 1), number IN if(number < 2, 0, 10) FROM numbers(6);
0	0	1
1	1	0
2	0	0
3	0	0
4	0	0
5	1	0
SELECT 1 GLOBAL IN if(1 > 0, 1, 2);
1
SELECT 1 GLOBAL NOT IN if(1 > 0, 1, 2);
0
SELECT * FROM (SELECT * FROM VALUES('cab_type String, dropoff UInt16', ('yellow', 138), ('green', 132))) AS t WHERE dropoff IN if(cab_type = 'yellow', 138, 132);
yellow	138
green	132
SELECT '-- Scalar NULL handling (preserves IN non-nullable behavior) --';
-- Scalar NULL handling (preserves IN non-nullable behavior) --
SELECT 1 IN nullIf(1, 1) AS r, toTypeName(1 IN nullIf(1, 1)) AS t;
0	UInt8
SELECT 1 NOT IN nullIf(1, 1) AS r, toTypeName(1 NOT IN nullIf(1, 1)) AS t;
1	UInt8
SELECT number, number IN nullIf(number, 1) FROM numbers(3);
0	1
1	0
2	1
SELECT number, number NOT IN nullIf(number, 1) FROM numbers(3);
0	0
1	1
2	0
