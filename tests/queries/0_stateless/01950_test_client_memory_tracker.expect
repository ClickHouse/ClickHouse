#!/usr/bin/expect -f

# This is a test for system.warnings. Testing in interactive mode is necessary,
# as we want to see certain warnings from client

log_user 0
set timeout 60
match_max 100000

# A default timeout action is to do nothing, change it to fail
expect_after {
    timeout {
        exit 1
    }
}

set basedir [file dirname $argv0]
spawn bash -c "source $basedir/../shell_config.sh ; \$CLICKHOUSE_CLIENT_BINARY \$CLICKHOUSE_CLIENT_OPT --disable_suggestion"
expect "Cannot load data for command line suggestions: Code: 241"
expect ":) "

# Finish test
send -- "\4"
expect eof

spawn bash -c "source $basedir/../shell_config.sh ; \$CLICKHOUSE_CLIENT_BINARY \$CLICKHOUSE_CLIENT_OPT --disable_suggestion"
expect {
    "Cannot load data for command line suggestions: Code: 241" {
         puts "Error"
         expect ":) "
         }
     ":) "
}
send -- "SET max_memory_usage = 1;\r"
expect ":) "
send -- "SELECT * FROM system.settings WHERE name='max_memory_usage'\r"
expect "Exception on client:"
expect "Code: 241."
expect ":) "

# Finish test
send -- "\4"
expect eof

