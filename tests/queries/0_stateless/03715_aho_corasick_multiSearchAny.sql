-- Tags: no-fasttest
-- Test Aho-Corasick multi-pattern search: automatic fallback for >255 patterns

SET send_logs_level = 'fatal';

SET param_pattern_1 = [
  'pattern_0',
  'pattern_1',
  'pattern_2',
  'pattern_3',
  'pattern_4',
  'pattern_5',
  'pattern_6',
  'pattern_7',
  'pattern_8',
  'pattern_9',
  'pattern_10',
  'pattern_11',
  'pattern_12',
  'pattern_13',
  'pattern_14',
  'pattern_15',
  'pattern_16',
  'pattern_17',
  'pattern_18',
  'pattern_19',
  'pattern_20',
  'pattern_21',
  'pattern_22',
  'pattern_23',
  'pattern_24',
  'pattern_25',
  'pattern_26',
  'pattern_27',
  'pattern_28',
  'pattern_29',
  'pattern_30',
  'pattern_31',
  'pattern_32',
  'pattern_33',
  'pattern_34',
  'pattern_35',
  'pattern_36',
  'pattern_37',
  'pattern_38',
  'pattern_39',
  'pattern_40',
  'pattern_41',
  'pattern_42',
  'pattern_43',
  'pattern_44',
  'pattern_45',
  'pattern_46',
  'pattern_47',
  'pattern_48',
  'pattern_49',
  'pattern_50',
  'pattern_51',
  'pattern_52',
  'pattern_53',
  'pattern_54',
  'pattern_55',
  'pattern_56',
  'pattern_57',
  'pattern_58',
  'pattern_59',
  'pattern_60',
  'pattern_61',
  'pattern_62',
  'pattern_63',
  'pattern_64',
  'pattern_65',
  'pattern_66',
  'pattern_67',
  'pattern_68',
  'pattern_69',
  'pattern_70',
  'pattern_71',
  'pattern_72',
  'pattern_73',
  'pattern_74',
  'pattern_75',
  'pattern_76',
  'pattern_77',
  'pattern_78',
  'pattern_79',
  'pattern_80',
  'pattern_81',
  'pattern_82',
  'pattern_83',
  'pattern_84',
  'pattern_85',
  'pattern_86',
  'pattern_87',
  'pattern_88',
  'pattern_89',
  'pattern_90',
  'pattern_91',
  'pattern_92',
  'pattern_93',
  'pattern_94',
  'pattern_95',
  'pattern_96',
  'pattern_97',
  'pattern_98',
  'pattern_99',
  'pattern_100',
  'pattern_101',
  'pattern_102',
  'pattern_103',
  'pattern_104',
  'pattern_105',
  'pattern_106',
  'pattern_107',
  'pattern_108',
  'pattern_109',
  'pattern_110',
  'pattern_111',
  'pattern_112',
  'pattern_113',
  'pattern_114',
  'pattern_115',
  'pattern_116',
  'pattern_117',
  'pattern_118',
  'pattern_119',
  'pattern_120',
  'pattern_121',
  'pattern_122',
  'pattern_123',
  'pattern_124',
  'pattern_125',
  'pattern_126',
  'pattern_127',
  'pattern_128',
  'pattern_129',
  'pattern_130',
  'pattern_131',
  'pattern_132',
  'pattern_133',
  'pattern_134',
  'pattern_135',
  'pattern_136',
  'pattern_137',
  'pattern_138',
  'pattern_139',
  'pattern_140',
  'pattern_141',
  'pattern_142',
  'pattern_143',
  'pattern_144',
  'pattern_145',
  'pattern_146',
  'pattern_147',
  'pattern_148',
  'pattern_149',
  'pattern_150',
  'pattern_151',
  'pattern_152',
  'pattern_153',
  'pattern_154',
  'pattern_155',
  'pattern_156',
  'pattern_157',
  'pattern_158',
  'pattern_159',
  'pattern_160',
  'pattern_161',
  'pattern_162',
  'pattern_163',
  'pattern_164',
  'pattern_165',
  'pattern_166',
  'pattern_167',
  'pattern_168',
  'pattern_169',
  'pattern_170',
  'pattern_171',
  'pattern_172',
  'pattern_173',
  'pattern_174',
  'pattern_175',
  'pattern_176',
  'pattern_177',
  'pattern_178',
  'pattern_179',
  'pattern_180',
  'pattern_181',
  'pattern_182',
  'pattern_183',
  'pattern_184',
  'pattern_185',
  'pattern_186',
  'pattern_187',
  'pattern_188',
  'pattern_189',
  'pattern_190',
  'pattern_191',
  'pattern_192',
  'pattern_193',
  'pattern_194',
  'pattern_195',
  'pattern_196',
  'pattern_197',
  'pattern_198',
  'pattern_199',
  'pattern_200',
  'pattern_201',
  'pattern_202',
  'pattern_203',
  'pattern_204',
  'pattern_205',
  'pattern_206',
  'pattern_207',
  'pattern_208',
  'pattern_209',
  'pattern_210',
  'pattern_211',
  'pattern_212',
  'pattern_213',
  'pattern_214',
  'pattern_215',
  'pattern_216',
  'pattern_217',
  'pattern_218',
  'pattern_219',
  'pattern_220',
  'pattern_221',
  'pattern_222',
  'pattern_223',
  'pattern_224',
  'pattern_225',
  'pattern_226',
  'pattern_227',
  'pattern_228',
  'pattern_229',
  'pattern_230',
  'pattern_231',
  'pattern_232',
  'pattern_233',
  'pattern_234',
  'pattern_235',
  'pattern_236',
  'pattern_237',
  'pattern_238',
  'pattern_239',
  'pattern_240',
  'pattern_241',
  'pattern_242',
  'pattern_243',
  'pattern_244',
  'pattern_245',
  'pattern_246',
  'pattern_247',
  'pattern_248',
  'pattern_249',
  'pattern_250',
  'pattern_251',
  'pattern_252',
  'pattern_253',
  'pattern_254',
  'pattern_255',
  'pattern_256',
  'pattern_257',
  'pattern_258',
  'pattern_259',
  'pattern_260',
  'pattern_261',
  'pattern_262',
  'pattern_263',
  'pattern_264',
  'pattern_265',
  'pattern_266',
  'pattern_267',
  'pattern_268',
  'pattern_269',
  'pattern_270',
  'pattern_271',
  'pattern_272',
  'pattern_273',
  'pattern_274',
  'pattern_275',
  'pattern_276',
  'pattern_277',
  'pattern_278',
  'pattern_279',
  'pattern_280',
  'pattern_281',
  'pattern_282',
  'pattern_283',
  'pattern_284',
  'pattern_285',
  'pattern_286',
  'pattern_287',
  'pattern_288',
  'pattern_289',
  'pattern_290',
  'pattern_291',
  'pattern_292',
  'pattern_293',
  'pattern_294',
  'pattern_295',
  'pattern_296',
  'pattern_297',
  'pattern_298',
  'pattern_299'
];

set param_pattern_min_aho_boundary = [
  'pattern_0',
  'pattern_1',
  'pattern_2',
  'pattern_3',
  'pattern_4',
  'pattern_5',
  'pattern_6',
  'pattern_7',
  'pattern_8',
  'pattern_9',
  'pattern_10',
  'pattern_11',
  'pattern_12',
  'pattern_13',
  'pattern_14',
  'pattern_15',
  'pattern_16',
  'pattern_17',
  'pattern_18',
  'pattern_19',
  'pattern_20',
  'pattern_21',
  'pattern_22',
  'pattern_23',
  'pattern_24',
  'pattern_25',
  'pattern_26',
  'pattern_27',
  'pattern_28',
  'pattern_29',
  'pattern_30',
  'pattern_31',
  'pattern_32',
  'pattern_33',
  'pattern_34',
  'pattern_35',
  'pattern_36',
  'pattern_37',
  'pattern_38',
  'pattern_39',
  'pattern_40',
  'pattern_41',
  'pattern_42',
  'pattern_43',
  'pattern_44',
  'pattern_45',
  'pattern_46',
  'pattern_47',
  'pattern_48',
  'pattern_49',
  'pattern_50',
  'pattern_51',
  'pattern_52',
  'pattern_53',
  'pattern_54',
  'pattern_55',
  'pattern_56',
  'pattern_57',
  'pattern_58',
  'pattern_59',
  'pattern_60',
  'pattern_61',
  'pattern_62',
  'pattern_63',
  'pattern_64',
  'pattern_65',
  'pattern_66',
  'pattern_67',
  'pattern_68',
  'pattern_69',
  'pattern_70',
  'pattern_71',
  'pattern_72',
  'pattern_73',
  'pattern_74',
  'pattern_75',
  'pattern_76',
  'pattern_77',
  'pattern_78',
  'pattern_79',
  'pattern_80',
  'pattern_81',
  'pattern_82',
  'pattern_83',
  'pattern_84',
  'pattern_85',
  'pattern_86',
  'pattern_87',
  'pattern_88',
  'pattern_89',
  'pattern_90',
  'pattern_91',
  'pattern_92',
  'pattern_93',
  'pattern_94',
  'pattern_95',
  'pattern_96',
  'pattern_97',
  'pattern_98',
  'pattern_99',
  'pattern_100',
  'pattern_101',
  'pattern_102',
  'pattern_103',
  'pattern_104',
  'pattern_105',
  'pattern_106',
  'pattern_107',
  'pattern_108',
  'pattern_109',
  'pattern_110',
  'pattern_111',
  'pattern_112',
  'pattern_113',
  'pattern_114',
  'pattern_115',
  'pattern_116',
  'pattern_117',
  'pattern_118',
  'pattern_119',
  'pattern_120',
  'pattern_121',
  'pattern_122',
  'pattern_123',
  'pattern_124',
  'pattern_125',
  'pattern_126',
  'pattern_127',
  'pattern_128',
  'pattern_129',
  'pattern_130',
  'pattern_131',
  'pattern_132',
  'pattern_133',
  'pattern_134',
  'pattern_135',
  'pattern_136',
  'pattern_137',
  'pattern_138',
  'pattern_139',
  'pattern_140',
  'pattern_141',
  'pattern_142',
  'pattern_143',
  'pattern_144',
  'pattern_145',
  'pattern_146',
  'pattern_147',
  'pattern_148',
  'pattern_149',
  'pattern_150',
  'pattern_151',
  'pattern_152',
  'pattern_153',
  'pattern_154',
  'pattern_155',
  'pattern_156',
  'pattern_157',
  'pattern_158',
  'pattern_159',
  'pattern_160',
  'pattern_161',
  'pattern_162',
  'pattern_163',
  'pattern_164',
  'pattern_165',
  'pattern_166',
  'pattern_167',
  'pattern_168',
  'pattern_169',
  'pattern_170',
  'pattern_171',
  'pattern_172',
  'pattern_173',
  'pattern_174',
  'pattern_175',
  'pattern_176',
  'pattern_177',
  'pattern_178',
  'pattern_179',
  'pattern_180',
  'pattern_181',
  'pattern_182',
  'pattern_183',
  'pattern_184',
  'pattern_185',
  'pattern_186',
  'pattern_187',
  'pattern_188',
  'pattern_189',
  'pattern_190',
  'pattern_191',
  'pattern_192',
  'pattern_193',
  'pattern_194',
  'pattern_195',
  'pattern_196',
  'pattern_197',
  'pattern_198',
  'pattern_199',
  'pattern_200',
  'pattern_201',
  'pattern_202',
  'pattern_203',
  'pattern_204',
  'pattern_205',
  'pattern_206',
  'pattern_207',
  'pattern_208',
  'pattern_209',
  'pattern_210',
  'pattern_211',
  'pattern_212',
  'pattern_213',
  'pattern_214',
  'pattern_215',
  'pattern_216',
  'pattern_217',
  'pattern_218',
  'pattern_219',
  'pattern_220',
  'pattern_221',
  'pattern_222',
  'pattern_223',
  'pattern_224',
  'pattern_225',
  'pattern_226',
  'pattern_227',
  'pattern_228',
  'pattern_229',
  'pattern_230',
  'pattern_231',
  'pattern_232',
  'pattern_233',
  'pattern_234',
  'pattern_235',
  'pattern_236',
  'pattern_237',
  'pattern_238',
  'pattern_239',
  'pattern_240',
  'pattern_241',
  'pattern_242',
  'pattern_243',
  'pattern_244',
  'pattern_245',
  'pattern_246',
  'pattern_247',
  'pattern_248',
  'pattern_249',
  'pattern_250',
  'pattern_251',
  'pattern_252',
  'pattern_253',
  'pattern_254',
  'pattern_255'
];

-- ============================================================================
-- AUTOMATIC FALLBACK TESTS (triggers Aho-Corasick for >255 patterns)
-- ============================================================================

-- Generate 300 patterns and test matching
-- Pattern format: 'pattern_N' where N is 0-299
SELECT multiSearchAny('this string contains pattern_150 somewhere', {pattern_1: Array(String)});

-- Test case-insensitive variant with >255 patterns
SELECT multiSearchAnyCaseInsensitive('THIS STRING CONTAINS PATTERN_200 SOMEWHERE', {pattern_1: Array(String)});

-- Test UTF8 variant
-- TODO: this is a lie. It's not testing unicode at all
SELECT multiSearchAnyUTF8('unicode text with pattern_50 and emojis', {pattern_1: Array(String)});

-- Test case-insensitive UTF8 variant
SELECT
    multiSearchAnyCaseInsensitiveUTF8('I Cøntain ∆∆', ['AIN ∆∆', 'not here', 'something else'])
    SETTINGS force_daachorse_for_multi_search = 1;

-- Test no match case
SELECT multiSearchAny('no matches here', {pattern_1: Array(String)}) AS no_match;

-- Test with exactly 256 patterns (boundary)
SELECT multiSearchAny('found pattern_100 here', {pattern_min_aho_boundary: Array(String)});

-- test with multiple patterns in one query
SELECT
  multiSearchAny('contains word_50', {pattern_1: Array(String)}),
  multiSearchAny('contains pattern_20', {pattern_min_aho_boundary: Array(String)}),
  multiSearchAny('thing', ['thing1', 'thing2']),
  multiSearchAny('a zerp in here', ['zerp in here', 'zarp']),
  multiSearchAnyCaseInsensitive('nothing to SEE', ['something', 'else', 'see']),
  multiSearchAnyCaseInsensitiveUTF8('I Cøntain ∆∆', ['AIN ∆∆', 'not here', 'something else'])
SETTINGS force_daachorse_for_multi_search = 1;


