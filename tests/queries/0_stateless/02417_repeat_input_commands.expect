#!/usr/bin/expect -f

set basedir [file dirname $argv0]
set basename [file tail $argv0]
exp_internal -f $env(CLICKHOUSE_TMP)/$basename.debuglog 0

log_user 0
set timeout 10
match_max 100000

expect_after {
    # Do not ignore eof from expect
    eof { exp_continue }
    # A default timeout action is to do nothing, change it to fail
    timeout { exit 1 }
}

spawn bash -c "source $basedir/../shell_config.sh ; \$CLICKHOUSE_CLIENT_BINARY \$CLICKHOUSE_CLIENT_OPT --disable_suggestion"
expect ":) "

# -----------------------------------------
# test . and / commands prior to the first query

send -- ".\r"
expect "Empty query"
expect ":) "

send -- "/\r"
expect "Empty query"
expect ":) "

# -----------------------------------------
# test . and / commands after first query

send -- "SELECT 123\r"
expect "│ 123 │"
expect "1 row in set."
expect ":) "

send -- ".\r"
expect "│ 123 │"
expect "1 row in set."
expect ":) "

# test input of . more than once in a row
send -- ".\r"
expect "│ 123 │"
expect "1 row in set."
expect ":) "

send -- "/\r"
expect "│ 123 │"
expect "1 row in set."
expect ":) "

# test input of / more than once in a row
send -- "/\r"
expect "│ 123 │"
expect "1 row in set."
expect ":) "

# -----------------------------------------
# test . and / commands after another query

send -- "SELECT 321\r"
expect "│ 321 │"
expect "1 row in set."
expect ":) "

send -- ".\r"
expect "│ 321 │"
expect "1 row in set."
expect ":) "

send -- "/\r"
expect "│ 321 │"
expect "1 row in set."
expect ":) "

send -- "quit\r"
expect eof
