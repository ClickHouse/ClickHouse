-- disable optimize_distinct_in_order
-- distinct all primary key columns -> ordinary distinct
DistinctTransform
DistinctTransform
-- enable optimize_distinct_in_order
-- distinct with all primary key columns -> pre-distinct optimization only
DistinctTransform
DistinctSortedStreamTransform
-- distinct with primary key prefix -> pre-distinct optimization only
DistinctTransform
DistinctSortedStreamTransform
-- distinct with primary key prefix and order by column in distinct -> pre-distinct and final distinct optimization
DistinctSortedTransform
DistinctSortedStreamTransform
-- distinct with primary key prefix and order by the same columns -> pre-distinct and final distinct optimization
DistinctSortedStreamTransform
DistinctSortedStreamTransform
-- distinct with primary key prefix and order by columns are prefix of distinct columns -> pre-distinct and final distinct optimization
DistinctSortedTransform
DistinctSortedStreamTransform
-- distinct with primary key prefix and order by column in distinct but non-primary key prefix -> pre-distinct and final distinct optimization
DistinctSortedTransform
DistinctSortedStreamTransform
-- distinct with primary key prefix and order by column _not_ in distinct -> pre-distinct optimization only
DistinctTransform
DistinctSortedStreamTransform
-- distinct with non-primary key prefix -> ordinary distinct
DistinctTransform
DistinctTransform
-- distinct with non-primary key prefix and order by column in distinct -> final distinct optimization only
DistinctSortedTransform
DistinctTransform
-- distinct with non-primary key prefix and order by column _not_ in distinct -> ordinary distinct
DistinctTransform
DistinctTransform
-- distinct with non-primary key prefix and order by _const_ column in distinct -> ordinary distinct
DistinctTransform
DistinctTransform
-- Check reading in order for distinct
-- disabled, distinct columns match sorting key
algorithm: Thread
-- enabled, distinct columns match sorting key
algorithm: InOrder
-- enabled, distinct columns form prefix of sorting key
algorithm: InOrder
-- enabled, distinct columns DON't form prefix of sorting key
algorithm: Thread
-- enabled, distinct columns contains constant columns, non-const columns form prefix of sorting key
algorithm: InOrder
-- enabled, distinct columns contains constant columns, non-const columns match prefix of sorting key
algorithm: InOrder
-- enabled, only part of distinct columns form prefix of sorting key
algorithm: InOrder
=== disable new analyzer ===
-- enabled, check that sorting properties are propagated from ReadFromMergeTree till preliminary distinct
Sorting: a ASC, b ASC
Sorting: a ASC, b ASC
-- check that reading in order optimization for ORDER BY and DISTINCT applied correctly in the same query
-- disabled, check that sorting description for ReadFromMergeTree match ORDER BY columns
Sorting: a ASC
Sorting: a ASC
-- enabled, check that ReadFromMergeTree sorting description is overwritten by DISTINCT optimization i.e. it contains columns from DISTINCT clause
Sorting: a ASC
Sorting: a ASC
Sorting: a ASC, b ASC
Sorting: a ASC, b ASC
-- enabled, check that ReadFromMergeTree sorting description is overwritten by DISTINCT optimization, but direction used from ORDER BY clause
Sorting: a DESC
Sorting: a DESC
Sorting: a DESC, b DESC
Sorting: a DESC, b DESC
-- enabled, check that ReadFromMergeTree sorting description is NOT overwritten by DISTINCT optimization (1), - it contains columns from ORDER BY clause
Sorting: a ASC
Sorting: a ASC, b ASC
Sorting: a ASC
Sorting: a ASC, b ASC
-- enabled, check that ReadFromMergeTree sorting description is NOT overwritten by DISTINCT optimization (2), - direction used from ORDER BY clause
Sorting: a DESC, b DESC
Sorting: a DESC, b DESC
Sorting: a DESC, b DESC
Sorting: a DESC, b DESC
-- enabled, check that disabling other 'read in order' optimizations do not disable distinct in order optimization
Sorting: a ASC, b ASC
Sorting: a ASC, b ASC
=== enable new analyzer ===
-- enabled, check that sorting properties are propagated from ReadFromMergeTree till preliminary distinct
Sorting: __table1.a ASC, __table1.b ASC
Sorting: a ASC, b ASC
-- disabled, check that sorting description for ReadFromMergeTree match ORDER BY columns
Sorting: __table1.a ASC
Sorting: a ASC
-- enabled, check that ReadFromMergeTree sorting description is overwritten by DISTINCT optimization i.e. it contains columns from DISTINCT clause
Sorting: __table1.a ASC
Sorting: __table1.a ASC
Sorting: __table1.a ASC, __table1.b ASC
Sorting: a ASC, b ASC
-- enabled, check that ReadFromMergeTree sorting description is overwritten by DISTINCT optimization, but direction used from ORDER BY clause
Sorting: __table1.a DESC
Sorting: __table1.a DESC
Sorting: __table1.a DESC, __table1.b DESC
Sorting: a DESC, b DESC
-- enabled, check that ReadFromMergeTree sorting description is NOT overwritten by DISTINCT optimization (1), - it contains columns from ORDER BY clause
Sorting: __table1.a ASC
Sorting: __table1.a ASC, __table1.b ASC
Sorting: __table1.a ASC
Sorting: a ASC, b ASC
-- enabled, check that ReadFromMergeTree sorting description is NOT overwritten by DISTINCT optimization (2), - direction used from ORDER BY clause
Sorting: __table1.a DESC, __table1.b DESC
Sorting: __table1.a DESC, __table1.b DESC
Sorting: __table1.a DESC, __table1.b DESC
Sorting: a DESC, b DESC
-- enabled, check that disabling other 'read in order' optimizations do not disable distinct in order optimization
Sorting: __table1.a ASC, __table1.b ASC
Sorting: a ASC, b ASC
