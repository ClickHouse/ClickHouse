-- { echoOn }

DROP TABLE IF EXISTS events;
CREATE TABLE events
(
    uuid UUID,
    person_id UUID,
    event String,
    timestamp DateTime64(6, 'UTC'),
    team_id Int64
)
ENGINE = MergeTree()
PARTITION BY toYYYYMM(timestamp)
ORDER BY (team_id, toDate(timestamp), event, cityHash64(person_id), cityHash64(uuid));
INSERT INTO events (uuid, person_id, event, timestamp, team_id)
VALUES (
    generateUUIDv4(),
    generateUUIDv4(),
    'page_view',
    now64(6, 'UTC'),
    1
);
EXPLAIN indexes = 1
SELECT  uuid, timestamp
FROM events e
WHERE person_id = '017adbc0-98b5-0000-3f74-619a368fe65d';
Expression ((Project names + Projection))
  Expression ((WHERE + Change column names to column identifiers))
    ReadFromMergeTree (default.events)
    Indexes:
      MinMax
        Condition: true
        Parts: 1/1
        Granules: 1/1
      Partition
        Condition: true
        Parts: 1/1
        Granules: 1/1
      PrimaryKey
        Keys:
          cityHash64(person_id)
        Condition: (cityHash64(person_id) in [7031655170867313797, 7031655170867313797])
        Parts: 0/1
        Granules: 0/1
        Search Algorithm: generic exclusion search
      Ranges: 0
EXPLAIN indexes = 1
SELECT  uuid, timestamp
FROM events e
WHERE person_id > '017adbc0-98b5-0000-3f74-619a368fe65d';
Expression ((Project names + Projection))
  Expression ((WHERE + Change column names to column identifiers))
    ReadFromMergeTree (default.events)
    Indexes:
      MinMax
        Condition: true
        Parts: 1/1
        Granules: 1/1
      Partition
        Condition: true
        Parts: 1/1
        Granules: 1/1
      PrimaryKey
        Keys:
          cityHash64(person_id)
        Condition: (cityHash64(person_id) in [7031655170867313797, +Inf))
        Parts: 0/1
        Granules: 0/1
        Search Algorithm: generic exclusion search
      Ranges: 0
EXPLAIN indexes = 1
SELECT  uuid, timestamp
FROM events e
WHERE person_id != '017adbc0-98b5-0000-3f74-619a368fe65d';
Expression ((Project names + Projection))
  Expression ((WHERE + Change column names to column identifiers))
    ReadFromMergeTree (default.events)
    Indexes:
      MinMax
        Condition: true
        Parts: 1/1
        Granules: 1/1
      Partition
        Condition: true
        Parts: 1/1
        Granules: 1/1
      PrimaryKey
        Keys:
          cityHash64(person_id)
        Condition: (cityHash64(person_id) not in [7031655170867313797, 7031655170867313797])
        Parts: 1/1
        Granules: 1/1
        Search Algorithm: generic exclusion search
      Ranges: 1
DROP TABLE IF EXISTS test;
CREATE TABLE test (
    pod String
)
ENGINE = MergeTree()
ORDER BY (left(pod, length(pod) - length(substringIndex(pod, '-', -1)) - 1))
SETTINGS index_granularity = 1000;
INSERT INTO test
SELECT
    arrayElement(
            ['vector-abc-001', 'vector-abc-002', 'metrics-def-003', 'metrics-def-004', 'logs-ghi-005', 'logs-ghi-006', 'traces-jkl-007', 'traces-jkl-008', 'events-mno-009', 'events-mno-010'],
            (number % 10) + 1
    )
FROM numbers(100000);
EXPLAIN indexes=1
SELECT count()
FROM test
WHERE pod = 'vector-abc-001';
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test)
        Indexes:
          PrimaryKey
            Keys:
              left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1))
            Condition: (left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1)) in [\'vector-abc\', \'vector-abc\'])
            Parts: 1/1
            Granules: 21/100
            Search Algorithm: binary search
          Ranges: 1
SELECT count()
FROM test
WHERE pod = 'vector-abc-001';
10000
EXPLAIN indexes=1
SELECT count()
FROM test
WHERE not pod = 'vector-abc-001';
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test)
        Indexes:
          PrimaryKey
            Keys:
              left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1))
            Condition: (left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1)) not in [\'vector-abc\', \'vector-abc\'])
            Parts: 1/1
            Granules: 100/100
            Search Algorithm: generic exclusion search
          Ranges: 1
SELECT count()
FROM test
WHERE not pod = 'vector-abc-001';
90000
DROP TABLE IF EXISTS test_expr;
CREATE TABLE test_expr (
    pod String
)
ENGINE = MergeTree()
ORDER BY (left(lower(pod), length(lower(pod)) - length(substringIndex(lower(pod), '-', -1)) - 1))
SETTINGS index_granularity = 1000;
INSERT INTO test_expr
SELECT
    arrayElement(
            ['vector-abC-001', 'vector-abC-002', 'metrics-deF-003', 'metrics-deF-004', 'logs-ghI-005', 'logs-ghI-006', 'traces-jkL-007', 'traces-jkL-008', 'events-mnO-009', 'events-mnO-010'],
            (number % 10) + 1
    )
FROM numbers(100000);
EXPLAIN indexes=1
SELECT count()
FROM test_expr
WHERE lower(pod) = 'vector-abc-001';
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test_expr)
        Indexes:
          PrimaryKey
            Keys:
              left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1))
            Condition: (left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1)) in [\'vector-abc\', \'vector-abc\'])
            Parts: 1/1
            Granules: 21/100
            Search Algorithm: binary search
          Ranges: 1
SELECT count()
FROM test_expr
WHERE lower(pod) = 'vector-abc-001';
10000
EXPLAIN indexes=1
SELECT count()
FROM test_expr
WHERE not lower(pod) = 'vector-abc-001';
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test_expr)
        Indexes:
          PrimaryKey
            Keys:
              left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1))
            Condition: (left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1)) not in [\'vector-abc\', \'vector-abc\'])
            Parts: 1/1
            Granules: 100/100
            Search Algorithm: generic exclusion search
          Ranges: 1
SELECT count()
FROM test_expr
WHERE not lower(pod) = 'vector-abc-001';
90000
