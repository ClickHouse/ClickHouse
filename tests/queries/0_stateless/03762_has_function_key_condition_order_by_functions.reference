-- { echoOn }

DROP TABLE IF EXISTS table_basic;
CREATE TABLE table_basic
(
    d DateTime('America/New_York')
)
ENGINE = MergeTree
ORDER BY d::String
SETTINGS index_granularity = 1;
INSERT INTO table_basic VALUES
    (toDateTime(1730611800, 'America/New_York')),
    (toDateTime(1730615400, 'America/New_York'));
SELECT
    toUnixTimestamp(d),
FROM table_basic
WHERE has([toDateTime(1730611800, 'America/New_York')], d);
1730611800
WITH ( SELECT groupArray((rowNumberInAllBlocks(), explain)) FROM (
    EXPLAIN indexes = 1
    SELECT
        toUnixTimestamp(d),
    FROM table_basic
    WHERE has([toDateTime(1730611800, 'America/New_York')], d)
)) AS plan SELECT arrayJoin(explain_index(plan, 'PrimaryKey')) AS explain;
Condition: (CAST(d, \'String\') in 1-element set)
Granules: read >= total_granules
SELECT
    toUnixTimestamp(d),
FROM table_basic
WHERE not has([toDateTime(1730611800, 'America/New_York')], d);
1730615400
WITH ( SELECT groupArray((rowNumberInAllBlocks(), explain)) FROM (
    EXPLAIN indexes = 1
    SELECT
        toUnixTimestamp(d),
    FROM table_basic
    WHERE not has([toDateTime(1730611800, 'America/New_York')], d)
)) AS plan SELECT arrayJoin(explain_index(plan, 'PrimaryKey')) AS explain;
Condition: not((CAST(d, \'String\') in 1-element set))
Granules: read >= total_granules
DROP TABLE IF EXISTS table_intdiv_string;
CREATE TABLE table_intdiv_string
(
    x Int32
)
ENGINE = MergeTree
ORDER BY toString(intDiv(x, 10))
SETTINGS index_granularity = 1;
INSERT INTO table_intdiv_string VALUES
    (2), (5), (9), (10), (12), (15), (19), (20), (29), (33), (39), (40), (55), (59), (90), (95), (99);
WITH ( SELECT groupArray((rowNumberInAllBlocks(), explain)) FROM (
    EXPLAIN indexes = 1
    SELECT arraySort(groupArray(x))
    FROM table_intdiv_string
    WHERE has(CAST([12,95,2,33,100] AS Array(Int32)), x)
)) AS plan SELECT arrayJoin(explain_index(plan, 'PrimaryKey')) AS explain;
Condition: (toString(intDiv(x, 10)) in 5-element set)
Granules: read < total_granules
SELECT arraySort(groupArray(x))
FROM table_intdiv_string
WHERE has(CAST([12,95,2,33,100] AS Array(Int32)), x);
[2,12,33,95]
WITH ( SELECT groupArray((rowNumberInAllBlocks(), explain)) FROM (
    EXPLAIN indexes = 1
    SELECT arraySort(groupArray(x))
    FROM table_intdiv_string
    WHERE NOT has(CAST([12,95,2,33,100] AS Array(Int32)), x)
)) AS plan SELECT arrayJoin(explain_index(plan, 'PrimaryKey')) AS explain;
Condition: not((toString(intDiv(x, 10)) in 5-element set))
Granules: read >= total_granules
SELECT arraySort(groupArray(x))
FROM table_intdiv_string
WHERE NOT has(CAST([12,95,2,33,100] AS Array(Int32)), x);
[5,9,10,15,19,20,29,39,40,55,59,90,99]
DROP TABLE IF EXISTS table_str_chain;
CREATE TABLE table_str_chain
(
    s String
)
ENGINE = MergeTree
ORDER BY reverse(lowerUTF8(s))
SETTINGS index_granularity = 1;
INSERT INTO table_str_chain VALUES
    ('Abc'), ('abc'),
    ('XYZ'), ('xYz'),
    ('Bar'), ('bar'),
    ('Hello'), ('hello'),
    ('World'), ('world'),
    ('AA'), ('aa'),
    ('A'), ('a'),
    ('baz'), ('Qux'), ('qux');
WITH ( SELECT groupArray((rowNumberInAllBlocks(), explain)) FROM (
    EXPLAIN indexes = 1
    SELECT arraySort(groupArray(s))
    FROM table_str_chain
    WHERE has(['Abc', 'Bar', 'XYZ', 'Hello', 'AA'], s)
)) AS plan SELECT arrayJoin(explain_index(plan, 'PrimaryKey')) AS explain;
Condition: (reverse(lowerUTF8(s)) in 5-element set)
Granules: read < total_granules
SELECT arraySort(groupArray(s))
FROM table_str_chain
WHERE has(['Abc', 'Bar', 'XYZ', 'Hello', 'AA'], s);
['AA','Abc','Bar','Hello','XYZ']
WITH ( SELECT groupArray((rowNumberInAllBlocks(), explain)) FROM (
    EXPLAIN indexes = 1
    SELECT arraySort(groupArray(s))
    FROM table_str_chain
    WHERE NOT has(['Abc', 'Bar', 'XYZ', 'Hello', 'AA'], s)
)) AS plan SELECT arrayJoin(explain_index(plan, 'PrimaryKey')) AS explain;
Condition: not((reverse(lowerUTF8(s)) in 5-element set))
Granules: read >= total_granules
SELECT arraySort(groupArray(s))
FROM table_str_chain
WHERE NOT has(['Abc', 'Bar', 'XYZ', 'Hello', 'AA'], s);
['A','Qux','World','a','aa','abc','bar','baz','hello','qux','world','xYz']
SET use_variant_as_common_type=1;
DROP TABLE IF EXISTS table_json;
CREATE TABLE table_json (id UInt64, json JSON(a UInt32)) ENGINE = MergeTree ORDER BY (json.a, json.b::String) SETTINGS index_granularity = 1;
INSERT INTO table_json SELECT number, toJSONString(map('a', number % 2, 'b', 'str_' || number % 3, 'c', range(number % 10))) FROM numbers(4);
INSERT INTO table_json SELECT number, toJSONString(map('a', number % 2 + 4, 'b', 'str_' || number % 3 + 4, 'c', range(number % 10))) FROM numbers(4, 4);
SELECT * FROM table_json WHERE json.a = 0 AND has(['str_0', 'str_1'], json.b) ORDER BY id;
0	{"a":0,"b":"str_0","c":[]}
WITH ( SELECT groupArray((rowNumberInAllBlocks(), explain)) FROM (
    EXPLAIN indexes = 1 SELECT * FROM table_json WHERE json.a = 0 AND has(['str_0', 'str_1'], json.b) ORDER BY id
)) AS plan SELECT arrayJoin(explain_index(plan, 'PrimaryKey')) AS explain;
Condition: and((CAST(json.b, \'String\') in 2-element set), (json.a in [0, 0]))
Granules: read < total_granules
SELECT * FROM table_json WHERE json.a = 0 AND NOT has(['str_0', 'str_1'], json.b) ORDER BY id;
2	{"a":0,"b":"str_2","c":[0,1]}
WITH ( SELECT groupArray((rowNumberInAllBlocks(), explain)) FROM (
    EXPLAIN indexes = 1 SELECT * FROM table_json WHERE json.a = 0 AND NOT has(['str_0', 'str_1'], json.b) ORDER BY id
)) AS plan SELECT arrayJoin(explain_index(plan, 'PrimaryKey')) AS explain;
Condition: and(not((CAST(json.b, \'String\') in 2-element set)), (json.a in [0, 0]))
Granules: read < total_granules
