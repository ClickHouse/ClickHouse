#!/usr/bin/env bash

function merges_count {
    local table=$1
    local database=${2:-$CLICKHOUSE_DATABASE}
    $CLICKHOUSE_CLIENT --query "SELECT count() FROM system.merges WHERE table='$table' AND database='$database'"
}

function wait_for_merges_done {
    local table=$1
    local database=${2:-$CLICKHOUSE_DATABASE}
    local timeout=${3:-20}

    while [[ timeout -gt 0 ]]
    do
        res=$(merges_count "$table" "$database")
        [[ $res -eq 0 ]] && return 0

        sleep 2
        timeout=$((timeout - 2))
    done

    echo "Timed out while waiting for merges done!" >&2
    return 2
}
