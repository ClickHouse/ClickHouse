-- { echoOn }

SET enable_analyzer = 1;
DROP TABLE IF EXISTS events;
CREATE TABLE events
(
    uuid UUID,
    person_id UUID,
    event String,
    timestamp DateTime64(6, 'UTC'),
    team_id Int64
)
ENGINE = MergeTree()
PARTITION BY toYYYYMM(timestamp)
ORDER BY (team_id, toDate(timestamp), event, cityHash64(person_id), cityHash64(uuid));
INSERT INTO events (uuid, person_id, event, timestamp, team_id)
VALUES (
    '017adbc0-98b5-0000-3f74-619a368fe65d',
    '017adbc0-98b5-0000-3f74-619a368fe65d',
    'page_view',
    toDateTime64('2026-01-01 00:00:00', 6, 'UTC'),
    1
);
INSERT INTO events (uuid, person_id, event, timestamp, team_id)
VALUES (
    '017adbc0-98b5-0000-3f74-619a368fe65g',
    '017adbc0-98b5-0000-3f74-619a368fe65a',
    'page_view',
    toDateTime64('2026-01-01 00:00:01', 6, 'UTC'),
    3
);
EXPLAIN indexes = 1
SELECT count()
FROM events e
WHERE person_id = '017adbc0-98b5-0000-3f74-619a368fe65e';
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.events)
        Indexes:
          MinMax
            Condition: true
            Parts: 2/2
            Granules: 2/2
          Partition
            Condition: true
            Parts: 2/2
            Granules: 2/2
          PrimaryKey
            Keys:
              cityHash64(person_id)
            Condition: (cityHash64(person_id) in [4512983270581420426, 4512983270581420426])
            Parts: 0/2
            Granules: 0/2
            Search Algorithm: generic exclusion search
          Ranges: 0
EXPLAIN indexes = 1
SELECT count()
FROM events e
WHERE person_id < '017adbc0-98b5-0000-3f74-619a368fe65e';
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.events)
        Indexes:
          MinMax
            Condition: true
            Parts: 2/2
            Granules: 2/2
          Partition
            Condition: true
            Parts: 2/2
            Granules: 2/2
          PrimaryKey
            Condition: true
            Parts: 2/2
            Granules: 2/2
          Ranges: 2
EXPLAIN indexes = 1
SELECT count()
FROM events e
WHERE person_id != '017adbc0-98b5-0000-3f74-619a368fe65e';
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.events)
        Indexes:
          MinMax
            Condition: true
            Parts: 2/2
            Granules: 2/2
          Partition
            Condition: true
            Parts: 2/2
            Granules: 2/2
          PrimaryKey
            Keys:
              cityHash64(person_id)
            Condition: (cityHash64(person_id) not in [4512983270581420426, 4512983270581420426])
            Parts: 2/2
            Granules: 2/2
            Search Algorithm: generic exclusion search
          Ranges: 2
EXPLAIN indexes = 1
SELECT count()
FROM events e
WHERE person_id IN (toUUID('017adbc0-98b5-0000-3f74-619a368fe65d'), toUUID('017adbc0-98b5-0000-3f74-619a368fe65e'));
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.events)
        Indexes:
          MinMax
            Condition: true
            Parts: 2/2
            Granules: 2/2
          Partition
            Condition: true
            Parts: 2/2
            Granules: 2/2
          PrimaryKey
            Keys:
              cityHash64(person_id)
            Condition: (cityHash64(person_id) in 2-element set)
            Parts: 1/2
            Granules: 1/2
            Search Algorithm: generic exclusion search
          Ranges: 1
EXPLAIN indexes = 1
SELECT count()
FROM events e
WHERE has([toUUID('017adbc0-98b5-0000-3f74-619a368fe65d'), toUUID('017adbc0-98b5-0000-3f74-619a368fe65e')], person_id);
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.events)
        Indexes:
          MinMax
            Condition: true
            Parts: 2/2
            Granules: 2/2
          Partition
            Condition: true
            Parts: 2/2
            Granules: 2/2
          PrimaryKey
            Keys:
              cityHash64(person_id)
            Condition: (cityHash64(person_id) in 2-element set)
            Parts: 1/2
            Granules: 1/2
            Search Algorithm: generic exclusion search
          Ranges: 1
EXPLAIN indexes = 1
SELECT count()
FROM events e
WHERE person_id NOT IN (toUUID('017adbc0-98b5-0000-3f74-619a368fe65d'), toUUID('017adbc0-98b5-0000-3f74-619a368fe65e'));
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.events)
        Indexes:
          MinMax
            Condition: true
            Parts: 2/2
            Granules: 2/2
          Partition
            Condition: true
            Parts: 2/2
            Granules: 2/2
          PrimaryKey
            Keys:
              cityHash64(person_id)
            Condition: (cityHash64(person_id) notIn 2-element set)
            Parts: 2/2
            Granules: 2/2
            Search Algorithm: generic exclusion search
          Ranges: 2
EXPLAIN indexes = 1
SELECT count()
FROM events e
WHERE NOT has([toUUID('017adbc0-98b5-0000-3f74-619a368fe65d'), toUUID('017adbc0-98b5-0000-3f74-619a368fe65e')], person_id);
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.events)
        Indexes:
          MinMax
            Condition: true
            Parts: 2/2
            Granules: 2/2
          Partition
            Condition: true
            Parts: 2/2
            Granules: 2/2
          PrimaryKey
            Keys:
              cityHash64(person_id)
            Condition: not((cityHash64(person_id) in 2-element set))
            Parts: 2/2
            Granules: 2/2
            Search Algorithm: generic exclusion search
          Ranges: 2
DROP TABLE IF EXISTS test;
CREATE TABLE test (
    pod String
)
ENGINE = MergeTree()
ORDER BY (left(pod, length(pod) - length(substringIndex(pod, '-', -1)) - 1))
SETTINGS index_granularity = 1000;
INSERT INTO test
SELECT
    arrayElement(
            ['vector-abc-001', 'vector-abc-002', 'metrics-def-003', 'metrics-def-004', 'logs-ghi-005', 'logs-ghi-006', 'traces-jkl-007', 'traces-jkl-008', 'events-mno-009', 'events-mno-010'],
            (number % 10) + 1
    )
FROM numbers(100000);
EXPLAIN indexes=1
SELECT count()
FROM test
WHERE pod = 'vector-abc-001';
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test)
        Indexes:
          PrimaryKey
            Keys:
              left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1))
            Condition: (left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1)) in [\'vector-abc\', \'vector-abc\'])
            Parts: 1/1
            Granules: 21/100
            Search Algorithm: binary search
          Ranges: 1
EXPLAIN indexes=1
SELECT count()
FROM test
WHERE NOT pod = 'vector-abc-001';
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test)
        Indexes:
          PrimaryKey
            Keys:
              left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1))
            Condition: (left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1)) not in [\'vector-abc\', \'vector-abc\'])
            Parts: 1/1
            Granules: 100/100
            Search Algorithm: generic exclusion search
          Ranges: 1
EXPLAIN indexes=1
SELECT count()
FROM test
WHERE pod IN ('vector-abc-001', 'metrics-def-003');
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test)
        Indexes:
          PrimaryKey
            Keys:
              left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1))
            Condition: (left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1)) in 2-element set)
            Parts: 1/1
            Granules: 42/100
            Search Algorithm: generic exclusion search
          Ranges: 2
EXPLAIN indexes=1
SELECT count()
FROM test
WHERE has(['vector-abc-001', 'metrics-def-003'], pod);
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test)
        Indexes:
          PrimaryKey
            Keys:
              left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1))
            Condition: (left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1)) in 2-element set)
            Parts: 1/1
            Granules: 42/100
            Search Algorithm: generic exclusion search
          Ranges: 2
EXPLAIN indexes=1
SELECT count()
FROM test
WHERE pod NOT IN ('vector-abc-001', 'metrics-def-003');
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test)
        Indexes:
          PrimaryKey
            Keys:
              left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1))
            Condition: (left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1)) notIn 2-element set)
            Parts: 1/1
            Granules: 100/100
            Search Algorithm: generic exclusion search
          Ranges: 1
EXPLAIN indexes=1
SELECT count()
FROM test
WHERE NOT has(['vector-abc-001', 'metrics-def-003'], pod);
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test)
        Indexes:
          PrimaryKey
            Keys:
              left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1))
            Condition: not((left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1)) in 2-element set))
            Parts: 1/1
            Granules: 100/100
            Search Algorithm: generic exclusion search
          Ranges: 1
DROP TABLE IF EXISTS test_expr;
CREATE TABLE test_expr (
    pod String
)
ENGINE = MergeTree()
ORDER BY (left(lower(pod), length(lower(pod)) - length(substringIndex(lower(pod), '-', -1)) - 1))
SETTINGS index_granularity = 1000;
INSERT INTO test_expr
SELECT
    arrayElement(
            ['vector-abC-001', 'vector-abC-002', 'metrics-deF-003', 'metrics-deF-004', 'logs-ghI-005', 'logs-ghI-006', 'traces-jkL-007', 'traces-jkL-008', 'events-mnO-009', 'events-mnO-010'],
            (number % 10) + 1
    )
FROM numbers(100000);
EXPLAIN indexes=1
SELECT count()
FROM test_expr
WHERE lower(pod) = 'vector-abc-001';
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test_expr)
        Indexes:
          PrimaryKey
            Keys:
              left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1))
            Condition: (left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1)) in [\'vector-abc\', \'vector-abc\'])
            Parts: 1/1
            Granules: 21/100
            Search Algorithm: binary search
          Ranges: 1
EXPLAIN indexes=1
SELECT count()
FROM test_expr
WHERE NOT lower(pod) = 'vector-abc-001';
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test_expr)
        Indexes:
          PrimaryKey
            Keys:
              left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1))
            Condition: (left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1)) not in [\'vector-abc\', \'vector-abc\'])
            Parts: 1/1
            Granules: 100/100
            Search Algorithm: generic exclusion search
          Ranges: 1
EXPLAIN indexes=1
SELECT count()
FROM test_expr
WHERE lower(pod) IN ('vector-abc-001', 'metrics-def-003');
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test_expr)
        Indexes:
          PrimaryKey
            Keys:
              left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1))
            Condition: (left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1)) in 2-element set)
            Parts: 1/1
            Granules: 42/100
            Search Algorithm: generic exclusion search
          Ranges: 2
EXPLAIN indexes=1
SELECT count()
FROM test_expr
WHERE has(['vector-abc-001', 'metrics-def-003'], lower(pod));
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test_expr)
        Indexes:
          PrimaryKey
            Keys:
              left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1))
            Condition: (left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1)) in 2-element set)
            Parts: 1/1
            Granules: 42/100
            Search Algorithm: generic exclusion search
          Ranges: 2
EXPLAIN indexes=1
SELECT count()
FROM test_expr
WHERE lower(pod) NOT IN ('vector-abc-001', 'metrics-def-003');
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test_expr)
        Indexes:
          PrimaryKey
            Keys:
              left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1))
            Condition: (left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1)) notIn 2-element set)
            Parts: 1/1
            Granules: 100/100
            Search Algorithm: generic exclusion search
          Ranges: 1
EXPLAIN indexes=1
SELECT count()
FROM test_expr
WHERE NOT has(['vector-abc-001', 'metrics-def-003'], lower(pod));
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test_expr)
        Indexes:
          PrimaryKey
            Keys:
              left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1))
            Condition: not((left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1)) in 2-element set))
            Parts: 1/1
            Granules: 100/100
            Search Algorithm: generic exclusion search
          Ranges: 1
DROP TABLE IF EXISTS test_dag_execution;
CREATE TABLE test_dag_execution
(
    p String
)
ENGINE = MergeTree
ORDER BY toUUID(p);
INSERT INTO test_dag_execution VALUES ('017adbc0-98b5-0000-3f74-619a368fe65d');
INSERT INTO test_dag_execution VALUES ('017adbc0-98b5-0000-3f74-619a368fe65a');
EXPLAIN indexes = 1
SELECT count() FROM test_dag_execution WHERE p = 'NOT-a-uuid';
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test_dag_execution)
        Indexes:
          PrimaryKey
            Condition: true
            Parts: 2/2
            Granules: 2/2
          Ranges: 2
EXPLAIN indexes = 1
SELECT count() FROM test_dag_execution WHERE p IN ('017adbc0-98b5-0000-3f74-619a368fe65d');
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test_dag_execution)
        Indexes:
          PrimaryKey
            Keys:
              toUUID(p)
            Condition: (toUUID(p) in 1-element set)
            Parts: 1/2
            Granules: 1/2
            Search Algorithm: binary search
          Ranges: 1
EXPLAIN indexes = 1
SELECT count() FROM test_dag_execution WHERE has(['017adbc0-98b5-0000-3f74-619a368fe65d'], p);
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test_dag_execution)
        Indexes:
          PrimaryKey
            Keys:
              toUUID(p)
            Condition: (toUUID(p) in 1-element set)
            Parts: 1/2
            Granules: 1/2
            Search Algorithm: binary search
          Ranges: 1
EXPLAIN indexes = 1
SELECT count() FROM test_dag_execution WHERE p NOT IN ('017adbc0-98b5-0000-3f74-619a368fe65d');
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test_dag_execution)
        Indexes:
          PrimaryKey
            Keys:
              toUUID(p)
            Condition: (toUUID(p) notIn 1-element set)
            Parts: 2/2
            Granules: 2/2
            Search Algorithm: generic exclusion search
          Ranges: 2
EXPLAIN indexes = 1
SELECT count() FROM test_dag_execution WHERE NOT has(['017adbc0-98b5-0000-3f74-619a368fe65d'], p);
Expression ((Project names + Projection))
  Aggregating
    Expression (Before GROUP BY)
      Filter ((WHERE + Change column names to column identifiers))
        ReadFromMergeTree (default.test_dag_execution)
        Indexes:
          PrimaryKey
            Keys:
              toUUID(p)
            Condition: not((toUUID(p) in 1-element set))
            Parts: 2/2
            Granules: 2/2
            Search Algorithm: generic exclusion search
          Ranges: 2
SET enable_analyzer = 0;
DROP TABLE IF EXISTS events;
CREATE TABLE events
(
    uuid UUID,
    person_id UUID,
    event String,
    timestamp DateTime64(6, 'UTC'),
    team_id Int64
)
ENGINE = MergeTree()
PARTITION BY toYYYYMM(timestamp)
ORDER BY (team_id, toDate(timestamp), event, cityHash64(person_id), cityHash64(uuid));
INSERT INTO events (uuid, person_id, event, timestamp, team_id)
VALUES (
    '017adbc0-98b5-0000-3f74-619a368fe65d',
    '017adbc0-98b5-0000-3f74-619a368fe65d',
    'page_view',
    toDateTime64('2026-01-01 00:00:00', 6, 'UTC'),
    1
);
INSERT INTO events (uuid, person_id, event, timestamp, team_id)
VALUES (
    '017adbc0-98b5-0000-3f74-619a368fe65g',
    '017adbc0-98b5-0000-3f74-619a368fe65a',
    'page_view',
    toDateTime64('2026-01-01 00:00:01', 6, 'UTC'),
    3
);
EXPLAIN indexes = 1
SELECT count()
FROM events e
WHERE person_id = '017adbc0-98b5-0000-3f74-619a368fe65e';
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.events)
        Indexes:
          MinMax
            Condition: true
            Parts: 2/2
            Granules: 2/2
          Partition
            Condition: true
            Parts: 2/2
            Granules: 2/2
          PrimaryKey
            Keys:
              cityHash64(person_id)
            Condition: (cityHash64(person_id) in [4512983270581420426, 4512983270581420426])
            Parts: 0/2
            Granules: 0/2
            Search Algorithm: generic exclusion search
          Ranges: 0
EXPLAIN indexes = 1
SELECT count()
FROM events e
WHERE person_id < '017adbc0-98b5-0000-3f74-619a368fe65e';
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.events)
        Indexes:
          MinMax
            Condition: true
            Parts: 2/2
            Granules: 2/2
          Partition
            Condition: true
            Parts: 2/2
            Granules: 2/2
          PrimaryKey
            Condition: true
            Parts: 2/2
            Granules: 2/2
          Ranges: 2
EXPLAIN indexes = 1
SELECT count()
FROM events e
WHERE person_id != '017adbc0-98b5-0000-3f74-619a368fe65e';
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.events)
        Indexes:
          MinMax
            Condition: true
            Parts: 2/2
            Granules: 2/2
          Partition
            Condition: true
            Parts: 2/2
            Granules: 2/2
          PrimaryKey
            Keys:
              cityHash64(person_id)
            Condition: (cityHash64(person_id) not in [4512983270581420426, 4512983270581420426])
            Parts: 2/2
            Granules: 2/2
            Search Algorithm: generic exclusion search
          Ranges: 2
EXPLAIN indexes = 1
SELECT count()
FROM events e
WHERE person_id IN (toUUID('017adbc0-98b5-0000-3f74-619a368fe65d'), toUUID('017adbc0-98b5-0000-3f74-619a368fe65e'));
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.events)
        Indexes:
          MinMax
            Condition: true
            Parts: 2/2
            Granules: 2/2
          Partition
            Condition: true
            Parts: 2/2
            Granules: 2/2
          PrimaryKey
            Keys:
              cityHash64(person_id)
            Condition: (cityHash64(person_id) in 2-element set)
            Parts: 1/2
            Granules: 1/2
            Search Algorithm: generic exclusion search
          Ranges: 1
EXPLAIN indexes = 1
SELECT count()
FROM events e
WHERE has([toUUID('017adbc0-98b5-0000-3f74-619a368fe65d'), toUUID('017adbc0-98b5-0000-3f74-619a368fe65e')], person_id);
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.events)
        Indexes:
          MinMax
            Condition: true
            Parts: 2/2
            Granules: 2/2
          Partition
            Condition: true
            Parts: 2/2
            Granules: 2/2
          PrimaryKey
            Keys:
              cityHash64(person_id)
            Condition: (cityHash64(person_id) in 2-element set)
            Parts: 1/2
            Granules: 1/2
            Search Algorithm: generic exclusion search
          Ranges: 1
EXPLAIN indexes = 1
SELECT count()
FROM events e
WHERE person_id NOT IN (toUUID('017adbc0-98b5-0000-3f74-619a368fe65d'), toUUID('017adbc0-98b5-0000-3f74-619a368fe65e'));
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.events)
        Indexes:
          MinMax
            Condition: true
            Parts: 2/2
            Granules: 2/2
          Partition
            Condition: true
            Parts: 2/2
            Granules: 2/2
          PrimaryKey
            Keys:
              cityHash64(person_id)
            Condition: (cityHash64(person_id) notIn 2-element set)
            Parts: 2/2
            Granules: 2/2
            Search Algorithm: generic exclusion search
          Ranges: 2
EXPLAIN indexes = 1
SELECT count()
FROM events e
WHERE NOT has([toUUID('017adbc0-98b5-0000-3f74-619a368fe65d'), toUUID('017adbc0-98b5-0000-3f74-619a368fe65e')], person_id);
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.events)
        Indexes:
          MinMax
            Condition: true
            Parts: 2/2
            Granules: 2/2
          Partition
            Condition: true
            Parts: 2/2
            Granules: 2/2
          PrimaryKey
            Keys:
              cityHash64(person_id)
            Condition: not((cityHash64(person_id) in 2-element set))
            Parts: 2/2
            Granules: 2/2
            Search Algorithm: generic exclusion search
          Ranges: 2
DROP TABLE IF EXISTS test;
CREATE TABLE test (
    pod String
)
ENGINE = MergeTree()
ORDER BY (left(pod, length(pod) - length(substringIndex(pod, '-', -1)) - 1))
SETTINGS index_granularity = 1000;
INSERT INTO test
SELECT
    arrayElement(
            ['vector-abc-001', 'vector-abc-002', 'metrics-def-003', 'metrics-def-004', 'logs-ghi-005', 'logs-ghi-006', 'traces-jkl-007', 'traces-jkl-008', 'events-mno-009', 'events-mno-010'],
            (number % 10) + 1
    )
FROM numbers(100000);
EXPLAIN indexes=1
SELECT count()
FROM test
WHERE pod = 'vector-abc-001';
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.test)
        Indexes:
          PrimaryKey
            Keys:
              left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1))
            Condition: (left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1)) in [\'vector-abc\', \'vector-abc\'])
            Parts: 1/1
            Granules: 21/100
            Search Algorithm: binary search
          Ranges: 1
EXPLAIN indexes=1
SELECT count()
FROM test
WHERE NOT pod = 'vector-abc-001';
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.test)
        Indexes:
          PrimaryKey
            Keys:
              left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1))
            Condition: (left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1)) not in [\'vector-abc\', \'vector-abc\'])
            Parts: 1/1
            Granules: 100/100
            Search Algorithm: generic exclusion search
          Ranges: 1
EXPLAIN indexes=1
SELECT count()
FROM test
WHERE pod IN ('vector-abc-001', 'metrics-def-003');
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.test)
        Indexes:
          PrimaryKey
            Keys:
              left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1))
            Condition: (left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1)) in 2-element set)
            Parts: 1/1
            Granules: 42/100
            Search Algorithm: generic exclusion search
          Ranges: 2
EXPLAIN indexes=1
SELECT count()
FROM test
WHERE has(['vector-abc-001', 'metrics-def-003'], pod);
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.test)
        Indexes:
          PrimaryKey
            Keys:
              left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1))
            Condition: (left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1)) in 2-element set)
            Parts: 1/1
            Granules: 42/100
            Search Algorithm: generic exclusion search
          Ranges: 2
EXPLAIN indexes=1
SELECT count()
FROM test
WHERE pod NOT IN ('vector-abc-001', 'metrics-def-003');
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.test)
        Indexes:
          PrimaryKey
            Keys:
              left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1))
            Condition: (left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1)) notIn 2-element set)
            Parts: 1/1
            Granules: 100/100
            Search Algorithm: generic exclusion search
          Ranges: 1
EXPLAIN indexes=1
SELECT count()
FROM test
WHERE NOT has(['vector-abc-001', 'metrics-def-003'], pod);
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.test)
        Indexes:
          PrimaryKey
            Keys:
              left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1))
            Condition: not((left(pod, minus(minus(length(pod), length(substringIndex(pod, \'-\', -1))), 1)) in 2-element set))
            Parts: 1/1
            Granules: 100/100
            Search Algorithm: generic exclusion search
          Ranges: 1
DROP TABLE IF EXISTS test_expr;
CREATE TABLE test_expr (
    pod String
)
ENGINE = MergeTree()
ORDER BY (left(lower(pod), length(lower(pod)) - length(substringIndex(lower(pod), '-', -1)) - 1))
SETTINGS index_granularity = 1000;
INSERT INTO test_expr
SELECT
    arrayElement(
            ['vector-abC-001', 'vector-abC-002', 'metrics-deF-003', 'metrics-deF-004', 'logs-ghI-005', 'logs-ghI-006', 'traces-jkL-007', 'traces-jkL-008', 'events-mnO-009', 'events-mnO-010'],
            (number % 10) + 1
    )
FROM numbers(100000);
EXPLAIN indexes=1
SELECT count()
FROM test_expr
WHERE lower(pod) = 'vector-abc-001';
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.test_expr)
        Indexes:
          PrimaryKey
            Keys:
              left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1))
            Condition: (left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1)) in [\'vector-abc\', \'vector-abc\'])
            Parts: 1/1
            Granules: 21/100
            Search Algorithm: binary search
          Ranges: 1
EXPLAIN indexes=1
SELECT count()
FROM test_expr
WHERE NOT lower(pod) = 'vector-abc-001';
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.test_expr)
        Indexes:
          PrimaryKey
            Keys:
              left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1))
            Condition: (left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1)) not in [\'vector-abc\', \'vector-abc\'])
            Parts: 1/1
            Granules: 100/100
            Search Algorithm: generic exclusion search
          Ranges: 1
EXPLAIN indexes=1
SELECT count()
FROM test_expr
WHERE lower(pod) IN ('vector-abc-001', 'metrics-def-003');
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.test_expr)
        Indexes:
          PrimaryKey
            Keys:
              left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1))
            Condition: (left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1)) in 2-element set)
            Parts: 1/1
            Granules: 42/100
            Search Algorithm: generic exclusion search
          Ranges: 2
EXPLAIN indexes=1
SELECT count()
FROM test_expr
WHERE has(['vector-abc-001', 'metrics-def-003'], lower(pod));
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.test_expr)
        Indexes:
          PrimaryKey
            Keys:
              left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1))
            Condition: (left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1)) in 2-element set)
            Parts: 1/1
            Granules: 42/100
            Search Algorithm: generic exclusion search
          Ranges: 2
EXPLAIN indexes=1
SELECT count()
FROM test_expr
WHERE lower(pod) NOT IN ('vector-abc-001', 'metrics-def-003');
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.test_expr)
        Indexes:
          PrimaryKey
            Keys:
              left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1))
            Condition: (left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1)) notIn 2-element set)
            Parts: 1/1
            Granules: 100/100
            Search Algorithm: generic exclusion search
          Ranges: 1
EXPLAIN indexes=1
SELECT count()
FROM test_expr
WHERE NOT has(['vector-abc-001', 'metrics-def-003'], lower(pod));
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.test_expr)
        Indexes:
          PrimaryKey
            Keys:
              left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1))
            Condition: not((left(lower(pod), minus(minus(length(lower(pod)), length(substringIndex(lower(pod), \'-\', -1))), 1)) in 2-element set))
            Parts: 1/1
            Granules: 100/100
            Search Algorithm: generic exclusion search
          Ranges: 1
DROP TABLE IF EXISTS test_dag_execution;
CREATE TABLE test_dag_execution
(
    p String
)
ENGINE = MergeTree
ORDER BY toUUID(p);
INSERT INTO test_dag_execution VALUES ('017adbc0-98b5-0000-3f74-619a368fe65d');
INSERT INTO test_dag_execution VALUES ('017adbc0-98b5-0000-3f74-619a368fe65a');
EXPLAIN indexes = 1
SELECT count() FROM test_dag_execution WHERE p = 'NOT-a-uuid';
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.test_dag_execution)
        Indexes:
          PrimaryKey
            Condition: true
            Parts: 2/2
            Granules: 2/2
          Ranges: 2
EXPLAIN indexes = 1
SELECT count() FROM test_dag_execution WHERE p IN ('017adbc0-98b5-0000-3f74-619a368fe65d');
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.test_dag_execution)
        Indexes:
          PrimaryKey
            Keys:
              toUUID(p)
            Condition: (toUUID(p) in 1-element set)
            Parts: 1/2
            Granules: 1/2
            Search Algorithm: binary search
          Ranges: 1
EXPLAIN indexes = 1
SELECT count() FROM test_dag_execution WHERE has(['017adbc0-98b5-0000-3f74-619a368fe65d'], p);
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.test_dag_execution)
        Indexes:
          PrimaryKey
            Keys:
              toUUID(p)
            Condition: (toUUID(p) in 1-element set)
            Parts: 1/2
            Granules: 1/2
            Search Algorithm: binary search
          Ranges: 1
EXPLAIN indexes = 1
SELECT count() FROM test_dag_execution WHERE p NOT IN ('017adbc0-98b5-0000-3f74-619a368fe65d');
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.test_dag_execution)
        Indexes:
          PrimaryKey
            Keys:
              toUUID(p)
            Condition: (toUUID(p) notIn 1-element set)
            Parts: 2/2
            Granules: 2/2
            Search Algorithm: generic exclusion search
          Ranges: 2
EXPLAIN indexes = 1
SELECT count() FROM test_dag_execution WHERE NOT has(['017adbc0-98b5-0000-3f74-619a368fe65d'], p);
Expression ((Projection + Before ORDER BY))
  Aggregating
    Expression (Before GROUP BY)
      Filter (WHERE)
        ReadFromMergeTree (default.test_dag_execution)
        Indexes:
          PrimaryKey
            Keys:
              toUUID(p)
            Condition: not((toUUID(p) in 1-element set))
            Parts: 2/2
            Granules: 2/2
            Search Algorithm: generic exclusion search
          Ranges: 2
