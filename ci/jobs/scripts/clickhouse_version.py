from pathlib import Path

from praktika.utils import Shell


class CHVersion:
    FILE_WITH_VERSION_PATH = "./cmake/autogenerated_versions.txt"

    @classmethod
    def get_version(cls):
        versions = {}
        for line in (
            Path(cls.FILE_WITH_VERSION_PATH).read_text(encoding="utf-8").splitlines()
        ):
            line = line.strip()
            if not line.startswith("SET("):
                continue

            name, value = line[4:-1].split(maxsplit=1)
            name = name.removeprefix("VERSION_").lower()
            try:
                value = int(value)
            except ValueError:
                pass
            versions[name] = value

        version_sha = versions["githash"]
        tweak = int(
            Shell.get_output(f"git rev-list --count {version_sha}..HEAD", verbose=True)
        )
        return f"{versions['major']}.{versions['minor']}.{versions['patch']}.{tweak}"

    @classmethod
    def get_latest_release_major_minor_sha(cls):
        versions = {}
        for line in (
            Path(cls.FILE_WITH_VERSION_PATH).read_text(encoding="utf-8").splitlines()
        ):
            line = line.strip()
            if not line.startswith("SET("):
                continue

            name, value = line[4:-1].split(maxsplit=1)
            name = name.removeprefix("VERSION_").lower()
            try:
                value = int(value)
            except ValueError:
                pass
            versions[name] = value
        assert versions["githash"]
        assert versions["minor"]
        assert versions["major"]
        return versions["major"], versions["minor"], versions["githash"]
