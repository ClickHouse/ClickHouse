#!/bin/bash

set -e

echo "Merging LLVM coverage files..."

# Debug: List available llvm tools
echo "Available LLVM tools:"
command -v llvm-profdata-21 || echo "llvm-profdata-21: not found"
command -v llvm-cov-21 || echo "llvm-cov-21: not found"
command -v llvm-profdata || echo "llvm-profdata: not found"
command -v llvm-cov || echo "llvm-cov: not found"

# Auto-detect available LLVM tools
if [ -z "$LLVM_PROFDATA" ]; then
  for ver in 21 20 18 19 17 16 ""; do
    if command -v "llvm-profdata${ver:+-$ver}" &> /dev/null; then
      LLVM_PROFDATA="llvm-profdata${ver:+-$ver}"
      break
    fi
  done
fi

if [ -z "$LLVM_COV" ]; then
  for ver in 21 20 18 19 17 16 ""; do
    if command -v "llvm-cov${ver:+-$ver}" &> /dev/null; then
      LLVM_COV="llvm-cov${ver:+-$ver}"
      break
    fi
  done
fi

echo "Using LLVM tools: LLVM_PROFDATA=$LLVM_PROFDATA, LLVM_COV=$LLVM_COV"

# Check if tools were found
if [ -z "$LLVM_PROFDATA" ]; then
  echo "ERROR: llvm-profdata not found in PATH"
  exit 1
fi

if [ -z "$LLVM_COV" ]; then
  echo "ERROR: llvm-cov not found in PATH"
  exit 1
fi

# Merge profdata files from all jobs (skip corrupted files with -failure-mode=warn)
echo "Merging profdata files..."

# Artifacts are downloaded to ci/tmp by the CI framework
cd ci/tmp || { echo "ERROR: ci/tmp directory not found"; exit 1; }

# List available profdata files for debugging
echo "Available profdata files:"
ls -lh *.profdata 2>/dev/null || echo "No profdata files found"

echo "Checking for binaries..."
ls -lh clickhouse unit_tests_dbms 2>/dev/null || echo "Warning: Some binaries not found"

# Extract self-extracting binary to get the actual instrumented ELF
if [ -f clickhouse ] && file clickhouse | grep -q "executable"; then
    echo "Extracting self-extracting binary..."
    chmod +x clickhouse
    # Extract to a known location
    ./clickhouse extract --recursive clickhouse_extracted || {
        echo "Warning: extract command failed, trying to run and extract from /tmp"
        # Alternative: let it auto-extract to /tmp by running help
        timeout 5 ./clickhouse --help > /dev/null 2>&1 || true
        # Find the extracted binary in /tmp
        EXTRACTED=$(find /tmp -name "clickhouse" -path "*/clickhouse_extracted_*" -type f 2>/dev/null | head -1)
        if [ -n "$EXTRACTED" ]; then
            echo "Found extracted binary: $EXTRACTED"
            cp "$EXTRACTED" ./clickhouse_plain
            mv ./clickhouse_plain ./clickhouse
        fi
    }
fi

MERGE_OUTPUT=$("$LLVM_PROFDATA" merge -sparse -failure-mode=warn *.profdata -o merged.profdata 2>&1)
MERGE_EXIT_CODE=$?

# Log corrupted files
CORRUPTED_COUNT=$(echo "$MERGE_OUTPUT" | grep -c "invalid instrumentation profile\|file header is corrupt" || true)
if [ "$CORRUPTED_COUNT" -gt 0 ]; then
    echo "WARNING: Found $CORRUPTED_COUNT corrupted profdata files:"
    echo "$MERGE_OUTPUT" | grep "invalid instrumentation profile\|file header is corrupt" || true
fi

if [ $MERGE_EXIT_CODE -eq 0 ] && [ -f merged.profdata ]; then
    echo "Successfully merged coverage data to merged.profdata"
    
    # Debug: Check what's in the profdata file
    echo "Inspecting profdata file for binary references..."
    "$LLVM_COV" show -instr-profile=merged.profdata -show-line-counts-or-regions ./clickhouse 2>&1 | head -20 || true
else
    echo "ERROR: Failed to merge coverage files"
    exit 1
fi

# Generate HTML coverage report
echo "Generating coverage report..."
# The coverage data was generated by binaries at their build/runtime locations
# Map build paths to actual source paths using --path-equivalence
"$LLVM_COV" show \
  ./clickhouse \
  ./unit_tests_dbms \
  -instr-profile=merged.profdata \
  -format=html \
  -output-dir=clickhouse_coverage \
  -path-equivalence=ci/tmp/build,../..

# Create tar.gz archive
tar -czf clickhouse_coverage.tar.gz clickhouse_coverage

# Keep results in ci/tmp (artifacts are uploaded from here)
echo "Results stored in ci/tmp: merged.profdata, clickhouse_coverage.tar.gz"

# Create result.json for the CI framework
RESULT_FILE="./result.json"
cat > "$RESULT_FILE" << EOF
{
  "name": "LLVM Coverage Merge",
  "status": "success",
  "start_time": null,
  "duration": null,
  "results": [],
  "files": ["clickhouse_coverage.tar.gz", "merged.profdata"],
  "info": "Coverage report generated successfully"
}
EOF

echo "Result file created: $RESULT_FILE"