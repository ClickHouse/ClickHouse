option (SANITIZE "Enable sanitizer: address, memory, thread, undefined" "")

set (SAN_FLAGS "${SAN_FLAGS} -g -fno-omit-frame-pointer -DSANITIZER")

if (SANITIZE)
    if (SANITIZE STREQUAL "address")
        set (CMAKE_CXX_FLAGS_${CMAKE_BUILD_TYPE_UC} "${CMAKE_CXX_FLAGS_${CMAKE_BUILD_TYPE_UC}} ${SAN_FLAGS} -fsanitize=address -fsanitize-address-use-after-scope")
        set (CMAKE_C_FLAGS_${CMAKE_BUILD_TYPE_UC} "${CMAKE_C_FLAGS_${CMAKE_BUILD_TYPE_UC}} ${SAN_FLAGS} -fsanitize=address -fsanitize-address-use-after-scope")
        set (CMAKE_EXE_LINKER_FLAGS_${CMAKE_BUILD_TYPE_UC} "${CMAKE_EXE_LINKER_FLAGS_${CMAKE_BUILD_TYPE_UC}} -fsanitize=address -fsanitize-address-use-after-scope")
        if (MAKE_STATIC_LIBRARIES AND CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
            set (CMAKE_EXE_LINKER_FLAGS_${CMAKE_BUILD_TYPE_UC} "${CMAKE_EXE_LINKER_FLAGS_${CMAKE_BUILD_TYPE_UC}} -static-libasan")
        endif ()
    elseif (SANITIZE STREQUAL "memory")
        set (CMAKE_CXX_FLAGS_${CMAKE_BUILD_TYPE_UC} "${CMAKE_CXX_FLAGS_${CMAKE_BUILD_TYPE_UC}} ${SAN_FLAGS} -fsanitize=memory")
        set (CMAKE_C_FLAGS_${CMAKE_BUILD_TYPE_UC} "${CMAKE_C_FLAGS_${CMAKE_BUILD_TYPE_UC}} ${SAN_FLAGS} -fsanitize=memory")
        set (CMAKE_EXE_LINKER_FLAGS_${CMAKE_BUILD_TYPE_UC} "${CMAKE_EXE_LINKER_FLAGS_${CMAKE_BUILD_TYPE_UC}} -fsanitize=memory")
        if (MAKE_STATIC_LIBRARIES AND CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
            set (CMAKE_EXE_LINKER_FLAGS_${CMAKE_BUILD_TYPE_UC} "${CMAKE_EXE_LINKER_FLAGS_${CMAKE_BUILD_TYPE_UC}} -static-libmsan")
        endif ()
    elseif (SANITIZE STREQUAL "thread")
        set (CMAKE_CXX_FLAGS_${CMAKE_BUILD_TYPE_UC} "${CMAKE_CXX_FLAGS_${CMAKE_BUILD_TYPE_UC}} ${SAN_FLAGS} -fsanitize=thread")
        set (CMAKE_C_FLAGS_${CMAKE_BUILD_TYPE_UC} "${CMAKE_C_FLAGS_${CMAKE_BUILD_TYPE_UC}} ${SAN_FLAGS} -fsanitize=thread")
        set (CMAKE_EXE_LINKER_FLAGS_${CMAKE_BUILD_TYPE_UC} "${CMAKE_EXE_LINKER_FLAGS_${CMAKE_BUILD_TYPE_UC}} -fsanitize=thread")
        if (MAKE_STATIC_LIBRARIES AND CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
            set (CMAKE_EXE_LINKER_FLAGS_${CMAKE_BUILD_TYPE_UC} "${CMAKE_EXE_LINKER_FLAGS_${CMAKE_BUILD_TYPE_UC}} -static-libtsan")
        endif ()
    elseif (SANITIZE STREQUAL "undefined")
        set (CMAKE_CXX_FLAGS_${CMAKE_BUILD_TYPE_UC} "${CMAKE_CXX_FLAGS_${CMAKE_BUILD_TYPE_UC}} ${SAN_FLAGS} -fsanitize=undefined")
        set (CMAKE_C_FLAGS_${CMAKE_BUILD_TYPE_UC} "${CMAKE_C_FLAGS_${CMAKE_BUILD_TYPE_UC}} ${SAN_FLAGS} -fsanitize=undefined")
        set (CMAKE_EXE_LINKER_FLAGS_${CMAKE_BUILD_TYPE_UC} "${CMAKE_EXE_LINKER_FLAGS_${CMAKE_BUILD_TYPE_UC}} -fsanitize=undefined")
        if (MAKE_STATIC_LIBRARIES AND CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
            set (CMAKE_EXE_LINKER_FLAGS_${CMAKE_BUILD_TYPE_UC} "${CMAKE_EXE_LINKER_FLAGS_${CMAKE_BUILD_TYPE_UC}} -static-libubsan")
        endif ()
    else ()
        message (FATAL_ERROR "Unknown sanitizer type: ${SANITIZE}")
    endif ()
endif()
