<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uplot@1.6.21/dist/uPlot.min.css"> <!-- TODO: Add SRI -->
    <script src="https://cdn.jsdelivr.net/npm/uplot@1.6.21/dist/uPlot.iife.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            margin: 0;
        }
        body {
            font-family: Liberation Sans, DejaVu Sans, sans-serif, Noto Color Emoji, Apple Color Emoji, Segoe UI Emoji;
            padding: 1rem;
            overflow-x: hidden;
            background: linear-gradient(to bottom, #00CCFF, #00D0D0);
            display: grid;
            grid-template-columns: auto;
            grid-template-rows: fit-content(10%) auto;
        }
        #charts
        {
            height: 100%;
            display: flex;
            flex-flow: row wrap;
            gap: 1rem;
        }
        .chart {
            flex: 1 40%;
            min-width: 20rem;
            min-height: 16rem;
            background: white;
            box-shadow: 0 0 1rem rgba(0, 0, 0, 0.25);
            overflow: hidden;
            position: relative;
        }

        .chart div { position: absolute; }

        .inputs { font-size: 14pt; }

        .inputs input {
            box-shadow: 0 0 1rem rgba(0, 0, 0, 0.25);
            padding: 0.25rem;
            margin-right: 0.25rem;
        }

        input {
            font-family: Liberation Sans, DejaVu Sans, sans-serif, Noto Color Emoji, Apple Color Emoji, Segoe UI Emoji;
            outline: none;
            border: none;
            font-size: 14pt;
        }

        .u-legend th { display: none; }

        .themes {
            float: right;
            font-size: 20pt;
            margin-bottom: 1rem;
        }

        #toggle-dark, #toggle-light {
            padding-right: 0.5rem;
            cursor: pointer;
        }

        #toggle-dark:hover, #toggle-light:hover {
            display: inline-block;
            transform: translate(1px, 1px);
            filter: brightness(125%);
        }

        #run {
            background: #FFCB80;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 1rem;
        }

        #run:hover {
            filter: contrast(125%);
        }

        #add {
            font-weight: bold;
            cursor: pointer;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
            background: #EEE;
            float: right;
            margin-right: 0;
            margin-left: 1rem;
            margin-bottom: 1rem;
        }

        #add:hover {
            background: white
        }

        form {
            display: inline;
        }

        form .param_name {
            font-size: 14pt;
            padding: 0.25rem;
            background: #EEE;
            display: inline-block;
            box-shadow: 0 0 1rem rgba(0, 0, 0, 0.25);
            margin-bottom: 1rem;
        }

        input:focus {
            box-shadow: 0 0 1rem rgba(0, 255, 0, 1);
        }

        .title {
            position: relative;
            left: 50%;
            top: 0.25em;
            transform: translate(-50%, 0);
            font-size: 20pt;
            font-weight: bold;
            color: #888;
            z-index: 10;
        }

        .chart-buttons {
            cursor: pointer;
            display: none;
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            font-size: 200%;
            color: #888;
            z-index: 10;
        }
        .chart-buttons a {
            margin-right: 0.25rem;
        }
        .chart-buttons a:hover {
            color: red;
        }

        .query-editor {
            display: none;
            grid-template-columns: auto fit-content(10%);
            grid-template-rows: auto fit-content(10%);
            z-index: 11;
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .query-editor textarea {
            grid-row: 1;
            grid-column: 1 / span 2;
            z-index: 11;
            padding: 0.5rem;
            outline: none;
            border: none;
            font-size: 12pt;
            border-bottom: 1px solid #F88;
        }

        .query-editor input {
            grid-row: 2;
            padding: 0.5rem;
        }

        .edit-title {
            background: #FEE;
        }

        .edit-confirm {
            background: #FFCB80;
            font-weight: bold;
            cursor: pointer;
        }
        .edit-confirm:hover {
            filter: contrast(125%);
        }

        .nowrap {
            white-space: pre;
        }
    </style>
</head>
<body>
<div class="inputs">
    <input id="add" type="button" value="Add chart">
    <span class="nowrap themes"><span id="toggle-dark">ðŸŒš</span><span id="toggle-light">ðŸŒž</span></span>
    <form id="params"></form>
</div>
<div id="charts">
</div>
</body>
<script>
    const user = '';
    const password = '';
    const url = 'https://play.clickhouse.com/?user=play';
    const theme = 'light';

    const queries = [
        { title: "ClickHouse", query:
        `SELECT toStartOfDay(time, 'Europe/Amsterdam')::INT AS t, sum(hits)::INT AS v
            FROM wikistat WHERE path = 'ClickHouse' AND time >= {start:Date}
            GROUP BY t ORDER BY t
            FORMAT JSONCompactColumns`},

        { title: "{word2} Stats", query:
        `SELECT toStartOfDay(time, 'Europe/Amsterdam')::INT AS t, sum(hits)::INT AS v
            FROM wikistat WHERE path = {word2:String} AND time >= {start:Date}
            GROUP BY t ORDER BY t
            FORMAT JSONCompactColumns`},

        { title: "Blockchain", query:
        `SELECT toStartOfDay(time, 'Europe/Amsterdam')::INT AS t, sum(hits)::INT AS v
            FROM wikistat WHERE path = 'Blockchain' AND time >= {start:Date}
            GROUP BY t ORDER BY t
            FORMAT JSONCompactColumns`},

        { title: "Big_Data", query:
        `SELECT toStartOfDay(time, 'Europe/Amsterdam')::INT AS t, sum(hits)::INT AS v
            FROM wikistat WHERE path = 'Big_Data' AND time >= {start:Date}
            GROUP BY t ORDER BY t
            FORMAT JSONCompactColumns`},

        { title: "Hadoop", query:
        `SELECT toStartOfDay(time, 'Europe/Amsterdam')::INT AS t, sum(hits)::INT AS v
            FROM wikistat WHERE path = 'Hadoop' AND time >= {start:Date}
            GROUP BY t ORDER BY t
            FORMAT JSONCompactColumns`}
    ];

    /// Query parameters with predefined default values.
    /// All other parameters will be automatically found in the queries.
    let params = {
        start: '2015-01-01',
        //word2: 'Coronavirus',
    };

    /// uPlot objects will go here.
    let plots = queries.map(e => null);

    /// This is not quite correct (we cannot really parse SQL with regexp) but tolerable.
    const query_param_regexp = /\{(\w+):[^}]+\}/g;

    /// Automatically parse more parameters from queires.
    function findParamsInQuery(query) {
        for (let match of query.matchAll(query_param_regexp)) {
            const name = match[1];
            if (!params[name]) {
                params[name] = '';
            };
        }
    }

    function findParamsInQueries() {
        queries.forEach(q => findParamsInQuery(q.query));
    }

    function insertParam(name, value) {
        let param_wrapper = document.createElement('span');
        param_wrapper.className = 'nowrap';

        let param_name = document.createElement('span');
        param_name.className = 'param_name';
        let param_name_text = document.createTextNode(`${name}: `);
        param_name.appendChild(param_name_text);

        let param_value = document.createElement('input');
        param_value.className = 'param';
        param_value.name = `${name}`;
        param_value.type = 'text';
        param_value.value = value;

        param_wrapper.appendChild(param_name);
        param_wrapper.appendChild(param_value);
        document.getElementById('params').appendChild(param_wrapper);
    }

    function buildParams() {
        let params_elem = document.getElementById('params');
        while (params_elem.firstChild) {
            params_elem.removeChild(params_elem.lastChild);
        }

        for (let [name, value] of Object.entries(params)) {
            insertParam(name, value);
        }

        let run = document.createElement('input');
        run.id = 'run';
        run.type = 'submit';
        run.value = 'Ok';

        document.getElementById('params').appendChild(run);
    }

    function updateParams() {
        [...document.getElementsByClassName('param')].forEach(e => { params[e.name] = e.value });
    }

    findParamsInQueries();
    buildParams();

    function getParamsForURL() {
        let url = '';
        for (let [name, value] of Object.entries(params)) {
            url += `&param_${name}=${value}`;
        };
        return url;
    }

    let charts = document.getElementById('charts');

    function insertChart(i) {
        let q = queries[i];
        let chart = document.createElement('div');
        chart.className = 'chart';

        let chart_title = document.createElement('div');
        let title_text = document.createTextNode('');
        chart_title.appendChild(title_text);
        chart_title.className = 'title';
        chart.appendChild(chart_title);

        let query_editor = document.createElement('div');
        query_editor.className = 'query-editor';

        let query_editor_textarea = document.createElement('textarea');
        query_editor_textarea.spellcheck = false;
        query_editor_textarea.value = q.query;
        query_editor_textarea.placeholder = 'Query';
        query_editor.appendChild(query_editor_textarea);

        let query_editor_title = document.createElement('input');
        query_editor_title.type = 'text';
        query_editor_title.value = q.title;
        query_editor_title.placeholder = 'Chart title';
        query_editor_title.className = 'edit-title';
        query_editor.appendChild(query_editor_title);

        let query_editor_confirm = document.createElement('input');
        query_editor_confirm.type = 'submit';
        query_editor_confirm.value = 'Ok';
        query_editor_confirm.className = 'edit-confirm';

        function editConfirm() {
            query_editor.style.display = 'none';
            q.title = query_editor_title.value;
            q.query = query_editor_textarea.value;
            title_text.data = '';
            findParamsInQuery(q.query);
            buildParams();
            draw(i, chart, getParamsForURL(), q.query);
        }

        query_editor_confirm.addEventListener('click', editConfirm);
        query_editor.addEventListener('keydown', e => {
            if ((event.metaKey || event.ctrlKey) && (event.keyCode == 13 || event.keyCode == 10)) {
                editConfirm();
            }
        });

        query_editor.addEventListener('keyup', e => {
            if (e.key == 'Escape') {
                query_editor.style.display = 'none';
            }
        });

        query_editor.appendChild(query_editor_confirm);

        chart.appendChild(query_editor);

        let edit_buttons = document.createElement('div');
        edit_buttons.className = 'chart-buttons';

        let edit = document.createElement('a');
        let edit_text = document.createTextNode('âœŽ');
        edit.appendChild(edit_text);
        edit.addEventListener('click', e => {
            query_editor.style.display = 'grid';
            query_editor_textarea.focus();
        });

        let trash = document.createElement('a');
        let trash_text = document.createTextNode('âœ•');
        trash.appendChild(trash_text);
        trash.addEventListener('click', e => {
            chart.style.display = 'none';
            queries.splice(i, 1);
            plots.splice(i, 1);
            resize();
        });

        edit_buttons.appendChild(edit);
        edit_buttons.appendChild(trash);

        chart.appendChild(edit_buttons);

        chart.addEventListener('mouseenter', e => { edit_buttons.style.display = 'block'; });
        chart.addEventListener('mouseleave', e => { edit_buttons.style.display = 'none'; });

        charts.appendChild(chart);
    };

    for (let i = 0; i < queries.length; ++i) {
        insertChart(i);
    }

    document.getElementById('add').addEventListener('click', e => {
        queries.push({ title: '', query: '' });
        insertChart(plots.length);
        plots.push(null);
        resize();
    });

    function legendAsTooltipPlugin({ className, style = { background: "rgba(255, 255, 255, 0.75)" } } = {}) {
        let legendEl;

        function init(u, opts) {
            legendEl = u.root.querySelector(".u-legend");

            legendEl.classList.remove("u-inline");
            className && legendEl.classList.add(className);

            uPlot.assign(legendEl.style, {
                textAlign: "left",
                pointerEvents: "none",
                display: "none",
                position: "absolute",
                left: 0,
                top: 0,
                zIndex: 100,
                boxShadow: "2px 2px 10px rgba(0,0,0,0.1)",
                ...style
            });

            // hide series color markers
            const idents = legendEl.querySelectorAll(".u-marker");

            for (let i = 0; i < idents.length; i++)
                idents[i].style.display = "none";

            const overEl = u.over;

            overEl.appendChild(legendEl);

            overEl.addEventListener("mouseenter", () => {legendEl.style.display = null;});
            overEl.addEventListener("mouseleave", () => {legendEl.style.display = "none";});
        }

        function update(u) {
            let { left, top } = u.cursor;
            left -= legendEl.clientWidth / 2;
            top -= legendEl.clientHeight / 2;
            legendEl.style.transform = "translate(" + left + "px, " + top + "px)";
        }

        return {
            hooks: {
                init: init,
                setCursor: update,
            }
        };
    }

    async function draw(idx, chart, url_params, query) {
        if (plots[idx]) {
            plots[idx].destroy();
            plots[idx] = null;
        }

        let headers = {};
        if (user || password) {
            headers['Authorization'] = 'Basic ' + btoa(`${user ? user : 'default'}${password ? ':' + password : ''}`);
        }

        const response = await fetch(url + url_params, { method: "POST", body: query, headers: headers });
        let data, error;
        try {
            data = await response.json();
        } catch (e) {
            console.log(e);
        }

        if (error) {
            chart.querySelector('.title').firstChild.data = error;
            return;
        }

        if (!(Array.isArray(data) && data.length == 2 && Array.isArray(data[0]) && Array.isArray(data[1]) && data[0].length == data[1].length)) {
            return;
        }

        const [line_color, fill_color, grid_color, axes_color] = theme != 'dark'
            ? ["#F88", "#FEE", "#EED", "#2c3235"]
            : ["#888", "#045", "#2c3235", "#c7d0d9"];

        const opts = {
            width: chart.clientWidth,
            height: chart.clientHeight,
            axes: [ { stroke: axes_color,
                      grid: { width: 1 / devicePixelRatio, stroke: grid_color },
                      ticks: { width: 1 / devicePixelRatio, stroke: grid_color } },
                    { stroke: axes_color,
                      grid: { width: 1 / devicePixelRatio, stroke: grid_color },
                      ticks: { width: 1 / devicePixelRatio, stroke: grid_color } } ],
            series: [ { label: "x" },
                      { label: "y", stroke: line_color, fill: fill_color } ],
            padding: [ null, null, null, (Math.floor(Math.log10(Math.max(...data[1]))) + Math.floor(Math.log10(Math.max(...data[1])) / 3)) * 6 - 10 ],
            plugins: [ legendAsTooltipPlugin() ]
        };

        plots[idx] = new uPlot(opts, data, chart);

        /// Set title
        const title = queries[idx].title.replaceAll(/\{(\w+)\}/g, (_, name) => params[name] );
        console.log(title);
        chart.querySelector('.title').firstChild.data = title;
    }

    async function drawAll() {
        let params = getParamsForURL();
        const charts = document.getElementsByClassName('chart');
        for (let i = 0; i < queries.length; ++i) {
            draw(i, charts[i], params, queries[i].query);
        }
    }

    function resize() {
        plots.forEach(plot => {
            if (plot) {
                let chart = plot.over.closest('.chart');
                plot.setSize({ width: chart.clientWidth, height: chart.clientHeight });
            }
        });
    }

    new ResizeObserver(resize).observe(document.body);

    document.getElementById('run').onclick = function(event) {
        updateParams();
        drawAll();
        event.preventDefault();
    }

    drawAll();
</script>
</html>
