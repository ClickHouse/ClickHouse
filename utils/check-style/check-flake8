#!/usr/bin/env bash

set -e

# We check only our code, that's why we skip contrib
GIT_ROOT=$(git rev-parse --show-cdup)
GIT_ROOT=${GIT_ROOT:-./}

# Find all *.py, *.python files and executable files without extension
# that are determined as python scripts by 'file' util
# in the repo except the contrib directory.
find_cmd=(
  find "$GIT_ROOT" -type f -not -path "${GIT_ROOT}contrib/*"
    \(
      \(
        -name '*.py' -or -name "*.python" -or
          \(
            -executable -not -name "*.*" -exec sh -c 'file {} | grep -q "Python script"' \;
          \)
      \)
      # We skip modules generated by the protocol buffer compiler from *.proto files.
      -and -not -name '*_pb2.py' -and -not -name '*_pb2_grpc.py'
    \) -print0
)

"${find_cmd[@]}" | xargs -0 flake8 --ignore E501,W503,F841,F401,E722,F541,W291,E712,E741,E266,F811,F405,E713,W605,E711,F522,E401,E402,E203,W293,F403,E731,W191,E101,E714
