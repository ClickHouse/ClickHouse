# generated by praktika

name: PR

on:
  pull_request:
    branches: ['master']

# Cancel the previous wf run in PRs.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Force the stdout and stderr streams to be unbuffered
  PYTHONUNBUFFERED: 1
  GH_TOKEN: ${{ github.token }}

# Allow updating GH commit statuses and PR comments to post an actual job reports link
permissions: write-all

jobs:

  config_workflow:
    runs-on: [ci_services]
    needs: []
    name: "Config Workflow"
    outputs:
      data: ${{ steps.run.outputs.DATA }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare env script
        run: |
          export PYTHONPATH=.:$PYTHONPATH
          cat > /tmp/praktika_setup_env.sh << 'ENV_SETUP_SCRIPT_EOF'

          cat > /tmp/praktika/workflow_config_pr.json << 'EOF'
          ${{ needs.config_workflow.outputs.data }}
          EOF
          cat > /tmp/praktika/workflow_status.json << 'EOF'
          ${{ toJson(needs) }}
          EOF
          ENV_SETUP_SCRIPT_EOF

          rm -rf /tmp/praktika/input /tmp/praktika/output /tmp/praktika
          mkdir -p /tmp/praktika /tmp/praktika/input /tmp/praktika/output

      - name: Run
        id: run
        run: |
          set -o pipefail
          python3 -m praktika run --job '''Config Workflow''' --workflow "PR" --ci |& tee /tmp/praktika/praktika_run.log

  docker_builds:
    runs-on: [ci_services_ebs]
    needs: [config_workflow]
    if: ${{ !failure() && !cancelled() && !contains(fromJson(needs.config_workflow.outputs.data).cache_success_base64, 'RG9ja2VyIEJ1aWxkcw==') }}
    name: "Docker Builds"
    outputs:
      data: ${{ steps.run.outputs.DATA }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare env script
        run: |
          export PYTHONPATH=.:$PYTHONPATH
          cat > /tmp/praktika_setup_env.sh << 'ENV_SETUP_SCRIPT_EOF'

          cat > /tmp/praktika/workflow_config_pr.json << 'EOF'
          ${{ needs.config_workflow.outputs.data }}
          EOF
          cat > /tmp/praktika/workflow_status.json << 'EOF'
          ${{ toJson(needs) }}
          EOF
          ENV_SETUP_SCRIPT_EOF

          rm -rf /tmp/praktika/input /tmp/praktika/output /tmp/praktika
          mkdir -p /tmp/praktika /tmp/praktika/input /tmp/praktika/output

      - name: Run
        id: run
        run: |
          set -o pipefail
          python3 -m praktika run --job '''Docker Builds''' --workflow "PR" --ci |& tee /tmp/praktika/praktika_run.log

  style_check:
    runs-on: [ci_services]
    needs: [config_workflow, docker_builds]
    if: ${{ !failure() && !cancelled() && !contains(fromJson(needs.config_workflow.outputs.data).cache_success_base64, 'U3R5bGUgQ2hlY2s=') }}
    name: "Style Check"
    outputs:
      data: ${{ steps.run.outputs.DATA }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare env script
        run: |
          export PYTHONPATH=.:$PYTHONPATH
          cat > /tmp/praktika_setup_env.sh << 'ENV_SETUP_SCRIPT_EOF'

          cat > /tmp/praktika/workflow_config_pr.json << 'EOF'
          ${{ needs.config_workflow.outputs.data }}
          EOF
          cat > /tmp/praktika/workflow_status.json << 'EOF'
          ${{ toJson(needs) }}
          EOF
          ENV_SETUP_SCRIPT_EOF

          rm -rf /tmp/praktika/input /tmp/praktika/output /tmp/praktika
          mkdir -p /tmp/praktika /tmp/praktika/input /tmp/praktika/output

      - name: Run
        id: run
        run: |
          set -o pipefail
          python3 -m praktika run --job '''Style Check''' --workflow "PR" --ci |& tee /tmp/praktika/praktika_run.log

  fast_test:
    runs-on: [builder]
    needs: [config_workflow, docker_builds]
    if: ${{ !failure() && !cancelled() && !contains(fromJson(needs.config_workflow.outputs.data).cache_success_base64, 'RmFzdCB0ZXN0') }}
    name: "Fast test"
    outputs:
      data: ${{ steps.run.outputs.DATA }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare env script
        run: |
          export PYTHONPATH=.:$PYTHONPATH
          cat > /tmp/praktika_setup_env.sh << 'ENV_SETUP_SCRIPT_EOF'

          cat > /tmp/praktika/workflow_config_pr.json << 'EOF'
          ${{ needs.config_workflow.outputs.data }}
          EOF
          cat > /tmp/praktika/workflow_status.json << 'EOF'
          ${{ toJson(needs) }}
          EOF
          ENV_SETUP_SCRIPT_EOF

          rm -rf /tmp/praktika/input /tmp/praktika/output /tmp/praktika
          mkdir -p /tmp/praktika /tmp/praktika/input /tmp/praktika/output

      - name: Run
        id: run
        run: |
          set -o pipefail
          python3 -m praktika run --job '''Fast test''' --workflow "PR" --ci |& tee /tmp/praktika/praktika_run.log

  finish_workflow:
    runs-on: [ci_services]
    needs: [config_workflow, docker_builds, style_check, fast_test]
    if: ${{ !cancelled() }}
    name: "Finish Workflow"
    outputs:
      data: ${{ steps.run.outputs.DATA }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare env script
        run: |
          export PYTHONPATH=.:$PYTHONPATH
          cat > /tmp/praktika_setup_env.sh << 'ENV_SETUP_SCRIPT_EOF'

          cat > /tmp/praktika/workflow_config_pr.json << 'EOF'
          ${{ needs.config_workflow.outputs.data }}
          EOF
          cat > /tmp/praktika/workflow_status.json << 'EOF'
          ${{ toJson(needs) }}
          EOF
          ENV_SETUP_SCRIPT_EOF

          rm -rf /tmp/praktika/input /tmp/praktika/output /tmp/praktika
          mkdir -p /tmp/praktika /tmp/praktika/input /tmp/praktika/output

      - name: Run
        id: run
        run: |
          set -o pipefail
          python3 -m praktika run --job '''Finish Workflow''' --workflow "PR" --ci |& tee /tmp/praktika/praktika_run.log
