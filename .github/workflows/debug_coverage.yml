name: Debug Build with Coverage

on:
  workflow_dispatch:
    inputs:
      runner_type:
        description: 'Runner type for build and tests'
        required: false
        default: 'ubuntu-latest'
        type: choice
        options:
          - ubuntu-latest
          - self-hosted

env:
  # Force the stdout and stderr streams to be unbuffered
  PYTHONUNBUFFERED: 1

jobs:
  build_debug_coverage:
    runs-on: ${{ inputs.runner_type || 'ubuntu-latest' }}
    name: "Build Debug with Coverage"
    outputs:
      build_status: ${{ steps.build.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Prepare build directory
        run: |
          mkdir -p build
          mkdir -p artifacts

      - name: Configure CMake with Coverage
        id: cmake
        run: |
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Debug \
            -DWITH_COVERAGE=On \
            -DENABLE_TESTS=1 \
            -DENABLE_CLICKHOUSE_SELF_EXTRACTING=1 \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_CXX_COMPILER=clang++-18

      - name: Build ClickHouse
        id: build
        run: |
          cd build
          cmake --build . -j $(nproc)
        continue-on-error: false

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: clickhouse-debug-coverage-binaries
          path: |
            build/programs/clickhouse
            build/programs/clickhouse-*
          retention-days: 7

  run_unit_tests:
    runs-on: ${{ inputs.runner_type || 'ubuntu-latest' }}
    name: "Run Unit Tests"
    needs: build_debug_coverage
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: clickhouse-debug-coverage-binaries
          path: build/programs/

      - name: Set executable permissions
        run: |
          chmod +x build/programs/clickhouse*

      - name: Run unit tests
        id: unit_tests
        run: |
          cd build
          ctest --output-on-failure --test-dir . || true
          # Save test results
          ctest --output-on-failure --test-dir . > ../artifacts/unit_test_results.txt 2>&1 || true
        continue-on-error: true

      - name: Collect coverage data
        if: always()
        run: |
          mkdir -p artifacts/coverage
          # If coverage files exist, copy them
          if [ -d "build" ]; then
            find build -name "*.gcda" -o -name "*.gcno" | tar czf artifacts/coverage/coverage_data.tar.gz -T - || true
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            artifacts/unit_test_results.txt
            artifacts/coverage/
          retention-days: 14

      - name: Generate test summary
        if: always()
        run: |
          echo "## Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "artifacts/unit_test_results.txt" ]; then
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -n 50 artifacts/unit_test_results.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "No test results found" >> $GITHUB_STEP_SUMMARY
          fi

  workflow_summary:
    runs-on: ubuntu-latest
    name: "Workflow Summary"
    needs: [build_debug_coverage, run_unit_tests]
    if: always()
    steps:
      - name: Generate workflow summary
        run: |
          echo "# Debug Coverage Build Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: ${{ needs.build_debug_coverage.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Unit Tests**: ${{ needs.run_unit_tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Binary artifacts: clickhouse-debug-coverage-binaries" >> $GITHUB_STEP_SUMMARY
          echo "- Test results: unit-test-results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Triggered by: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
